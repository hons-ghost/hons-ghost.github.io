/*! For license information please see bundle.js.LICENSE.txt */
(()=>{var t,e,i,n,s={146:function(t){t.exports=function(){"use strict";function t(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function e(e){for(var i=1;i<arguments.length;i++){var n=null!=arguments[i]?arguments[i]:{};i%2?t(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):t(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(t){return i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},i(t)}function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function s(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,m(n.key),n)}}function r(t,e,i){return e&&s(t.prototype,e),i&&s(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}function a(t,e,i){return(e=m(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function o(t){return h(t)||l(t)||c(t)||d()}function h(t){if(Array.isArray(t))return u(t)}function l(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}function c(t,e){if(t){if("string"==typeof t)return u(t,e);var i=Object.prototype.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?u(t,e):void 0}}function u(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=new Array(e);i<e;i++)n[i]=t[i];return n}function d(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function p(t,e){if("object"!=typeof t||null===t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}function m(t){var e=p(t,"string");return"symbol"==typeof e?e:String(e)}var f="undefined"!=typeof window&&void 0!==window.document,g=f?window:{},v=!(!f||!g.document.documentElement)&&"ontouchstart"in g.document.documentElement,y=!!f&&"PointerEvent"in g,x="cropper",b="all",_="crop",w="move",M="zoom",S="e",E="w",T="s",A="n",C="ne",I="nw",R="se",k="sw",P="".concat(x,"-crop"),D="".concat(x,"-disabled"),L="".concat(x,"-hidden"),O="".concat(x,"-hide"),N="".concat(x,"-invisible"),B="".concat(x,"-modal"),z="".concat(x,"-move"),U="".concat(x,"Action"),F="".concat(x,"Preview"),G="crop",V="move",H="none",j="crop",W="cropend",X="cropmove",q="cropstart",Y="dblclick",J=v?"touchstart":"mousedown",$=v?"touchmove":"mousemove",K=v?"touchend touchcancel":"mouseup",Z=y?"pointerdown":J,Q=y?"pointermove":$,tt=y?"pointerup pointercancel":K,et="ready",it="resize",nt="wheel",st="zoom",rt="image/jpeg",at=/^e|w|s|n|se|sw|ne|nw|all|crop|move|zoom$/,ot=/^data:/,ht=/^data:image\/jpeg;base64,/,lt=/^img|canvas$/i,ct=200,ut=100,dt={viewMode:0,dragMode:G,initialAspectRatio:NaN,aspectRatio:NaN,data:null,preview:"",responsive:!0,restore:!0,checkCrossOrigin:!0,checkOrientation:!0,modal:!0,guides:!0,center:!0,highlight:!0,background:!0,autoCrop:!0,autoCropArea:.8,movable:!0,rotatable:!0,scalable:!0,zoomable:!0,zoomOnTouch:!0,zoomOnWheel:!0,wheelZoomRatio:.1,cropBoxMovable:!0,cropBoxResizable:!0,toggleDragModeOnDblclick:!0,minCanvasWidth:0,minCanvasHeight:0,minCropBoxWidth:0,minCropBoxHeight:0,minContainerWidth:ct,minContainerHeight:ut,ready:null,cropstart:null,cropmove:null,cropend:null,crop:null,zoom:null},pt='<div class="cropper-container" touch-action="none"><div class="cropper-wrap-box"><div class="cropper-canvas"></div></div><div class="cropper-drag-box"></div><div class="cropper-crop-box"><span class="cropper-view-box"></span><span class="cropper-dashed dashed-h"></span><span class="cropper-dashed dashed-v"></span><span class="cropper-center"></span><span class="cropper-face"></span><span class="cropper-line line-e" data-cropper-action="e"></span><span class="cropper-line line-n" data-cropper-action="n"></span><span class="cropper-line line-w" data-cropper-action="w"></span><span class="cropper-line line-s" data-cropper-action="s"></span><span class="cropper-point point-e" data-cropper-action="e"></span><span class="cropper-point point-n" data-cropper-action="n"></span><span class="cropper-point point-w" data-cropper-action="w"></span><span class="cropper-point point-s" data-cropper-action="s"></span><span class="cropper-point point-ne" data-cropper-action="ne"></span><span class="cropper-point point-nw" data-cropper-action="nw"></span><span class="cropper-point point-sw" data-cropper-action="sw"></span><span class="cropper-point point-se" data-cropper-action="se"></span></div></div>',mt=Number.isNaN||g.isNaN;function ft(t){return"number"==typeof t&&!mt(t)}var gt=function(t){return t>0&&t<1/0};function vt(t){return void 0===t}function yt(t){return"object"===i(t)&&null!==t}var xt=Object.prototype.hasOwnProperty;function bt(t){if(!yt(t))return!1;try{var e=t.constructor,i=e.prototype;return e&&i&&xt.call(i,"isPrototypeOf")}catch(t){return!1}}function _t(t){return"function"==typeof t}var wt=Array.prototype.slice;function Mt(t){return Array.from?Array.from(t):wt.call(t)}function St(t,e){return t&&_t(e)&&(Array.isArray(t)||ft(t.length)?Mt(t).forEach((function(i,n){e.call(t,i,n,t)})):yt(t)&&Object.keys(t).forEach((function(i){e.call(t,t[i],i,t)}))),t}var Et=Object.assign||function(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];return yt(t)&&i.length>0&&i.forEach((function(e){yt(e)&&Object.keys(e).forEach((function(i){t[i]=e[i]}))})),t},Tt=/\.\d*(?:0|9){12}\d*$/;function At(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e11;return Tt.test(t)?Math.round(t*e)/e:t}var Ct=/^width|height|left|top|marginLeft|marginTop$/;function It(t,e){var i=t.style;St(e,(function(t,e){Ct.test(e)&&ft(t)&&(t="".concat(t,"px")),i[e]=t}))}function Rt(t,e){return t.classList?t.classList.contains(e):t.className.indexOf(e)>-1}function kt(t,e){if(e)if(ft(t.length))St(t,(function(t){kt(t,e)}));else if(t.classList)t.classList.add(e);else{var i=t.className.trim();i?i.indexOf(e)<0&&(t.className="".concat(i," ").concat(e)):t.className=e}}function Pt(t,e){e&&(ft(t.length)?St(t,(function(t){Pt(t,e)})):t.classList?t.classList.remove(e):t.className.indexOf(e)>=0&&(t.className=t.className.replace(e,"")))}function Dt(t,e,i){e&&(ft(t.length)?St(t,(function(t){Dt(t,e,i)})):i?kt(t,e):Pt(t,e))}var Lt=/([a-z\d])([A-Z])/g;function Ot(t){return t.replace(Lt,"$1-$2").toLowerCase()}function Nt(t,e){return yt(t[e])?t[e]:t.dataset?t.dataset[e]:t.getAttribute("data-".concat(Ot(e)))}function Bt(t,e,i){yt(i)?t[e]=i:t.dataset?t.dataset[e]=i:t.setAttribute("data-".concat(Ot(e)),i)}function zt(t,e){if(yt(t[e]))try{delete t[e]}catch(i){t[e]=void 0}else if(t.dataset)try{delete t.dataset[e]}catch(i){t.dataset[e]=void 0}else t.removeAttribute("data-".concat(Ot(e)))}var Ut=/\s\s*/,Ft=function(){var t=!1;if(f){var e=!1,i=function(){},n=Object.defineProperty({},"once",{get:function(){return t=!0,e},set:function(t){e=t}});g.addEventListener("test",i,n),g.removeEventListener("test",i,n)}return t}();function Gt(t,e,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},s=i;e.trim().split(Ut).forEach((function(e){if(!Ft){var r=t.listeners;r&&r[e]&&r[e][i]&&(s=r[e][i],delete r[e][i],0===Object.keys(r[e]).length&&delete r[e],0===Object.keys(r).length&&delete t.listeners)}t.removeEventListener(e,s,n)}))}function Vt(t,e,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},s=i;e.trim().split(Ut).forEach((function(e){if(n.once&&!Ft){var r=t.listeners,a=void 0===r?{}:r;s=function(){delete a[e][i],t.removeEventListener(e,s,n);for(var r=arguments.length,o=new Array(r),h=0;h<r;h++)o[h]=arguments[h];i.apply(t,o)},a[e]||(a[e]={}),a[e][i]&&t.removeEventListener(e,a[e][i],n),a[e][i]=s,t.listeners=a}t.addEventListener(e,s,n)}))}function Ht(t,e,i){var n;return _t(Event)&&_t(CustomEvent)?n=new CustomEvent(e,{detail:i,bubbles:!0,cancelable:!0}):(n=document.createEvent("CustomEvent")).initCustomEvent(e,!0,!0,i),t.dispatchEvent(n)}function jt(t){var e=t.getBoundingClientRect();return{left:e.left+(window.pageXOffset-document.documentElement.clientLeft),top:e.top+(window.pageYOffset-document.documentElement.clientTop)}}var Wt=g.location,Xt=/^(\w+:)\/\/([^:/?#]*):?(\d*)/i;function qt(t){var e=t.match(Xt);return null!==e&&(e[1]!==Wt.protocol||e[2]!==Wt.hostname||e[3]!==Wt.port)}function Yt(t){var e="timestamp=".concat((new Date).getTime());return t+(-1===t.indexOf("?")?"?":"&")+e}function Jt(t){var e=t.rotate,i=t.scaleX,n=t.scaleY,s=t.translateX,r=t.translateY,a=[];ft(s)&&0!==s&&a.push("translateX(".concat(s,"px)")),ft(r)&&0!==r&&a.push("translateY(".concat(r,"px)")),ft(e)&&0!==e&&a.push("rotate(".concat(e,"deg)")),ft(i)&&1!==i&&a.push("scaleX(".concat(i,")")),ft(n)&&1!==n&&a.push("scaleY(".concat(n,")"));var o=a.length?a.join(" "):"none";return{WebkitTransform:o,msTransform:o,transform:o}}function $t(t){var i=e({},t),n=0;return St(t,(function(t,e){delete i[e],St(i,(function(e){var i=Math.abs(t.startX-e.startX),s=Math.abs(t.startY-e.startY),r=Math.abs(t.endX-e.endX),a=Math.abs(t.endY-e.endY),o=Math.sqrt(i*i+s*s),h=(Math.sqrt(r*r+a*a)-o)/o;Math.abs(h)>Math.abs(n)&&(n=h)}))})),n}function Kt(t,i){var n=t.pageX,s=t.pageY,r={endX:n,endY:s};return i?r:e({startX:n,startY:s},r)}function Zt(t){var e=0,i=0,n=0;return St(t,(function(t){var s=t.startX,r=t.startY;e+=s,i+=r,n+=1})),{pageX:e/=n,pageY:i/=n}}function Qt(t){var e=t.aspectRatio,i=t.height,n=t.width,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"contain",r=gt(n),a=gt(i);if(r&&a){var o=i*e;"contain"===s&&o>n||"cover"===s&&o<n?i=n/e:n=i*e}else r?i=n/e:a&&(n=i*e);return{width:n,height:i}}function te(t){var e=t.width,i=t.height,n=t.degree;if(90==(n=Math.abs(n)%180))return{width:i,height:e};var s=n%90*Math.PI/180,r=Math.sin(s),a=Math.cos(s),o=e*a+i*r,h=e*r+i*a;return n>90?{width:h,height:o}:{width:o,height:h}}function ee(t,e,i,n){var s=e.aspectRatio,r=e.naturalWidth,a=e.naturalHeight,h=e.rotate,l=void 0===h?0:h,c=e.scaleX,u=void 0===c?1:c,d=e.scaleY,p=void 0===d?1:d,m=i.aspectRatio,f=i.naturalWidth,g=i.naturalHeight,v=n.fillColor,y=void 0===v?"transparent":v,x=n.imageSmoothingEnabled,b=void 0===x||x,_=n.imageSmoothingQuality,w=void 0===_?"low":_,M=n.maxWidth,S=void 0===M?1/0:M,E=n.maxHeight,T=void 0===E?1/0:E,A=n.minWidth,C=void 0===A?0:A,I=n.minHeight,R=void 0===I?0:I,k=document.createElement("canvas"),P=k.getContext("2d"),D=Qt({aspectRatio:m,width:S,height:T}),L=Qt({aspectRatio:m,width:C,height:R},"cover"),O=Math.min(D.width,Math.max(L.width,f)),N=Math.min(D.height,Math.max(L.height,g)),B=Qt({aspectRatio:s,width:S,height:T}),z=Qt({aspectRatio:s,width:C,height:R},"cover"),U=Math.min(B.width,Math.max(z.width,r)),F=Math.min(B.height,Math.max(z.height,a)),G=[-U/2,-F/2,U,F];return k.width=At(O),k.height=At(N),P.fillStyle=y,P.fillRect(0,0,O,N),P.save(),P.translate(O/2,N/2),P.rotate(l*Math.PI/180),P.scale(u,p),P.imageSmoothingEnabled=b,P.imageSmoothingQuality=w,P.drawImage.apply(P,[t].concat(o(G.map((function(t){return Math.floor(At(t))}))))),P.restore(),k}var ie=String.fromCharCode;function ne(t,e,i){var n="";i+=e;for(var s=e;s<i;s+=1)n+=ie(t.getUint8(s));return n}var se=/^data:.*,/;function re(t){var e=t.replace(se,""),i=atob(e),n=new ArrayBuffer(i.length),s=new Uint8Array(n);return St(s,(function(t,e){s[e]=i.charCodeAt(e)})),n}function ae(t,e){for(var i=[],n=8192,s=new Uint8Array(t);s.length>0;)i.push(ie.apply(null,Mt(s.subarray(0,n)))),s=s.subarray(n);return"data:".concat(e,";base64,").concat(btoa(i.join("")))}function oe(t){var e,i=new DataView(t);try{var n,s,r;if(255===i.getUint8(0)&&216===i.getUint8(1))for(var a=i.byteLength,o=2;o+1<a;){if(255===i.getUint8(o)&&225===i.getUint8(o+1)){s=o;break}o+=1}if(s){var h=s+10;if("Exif"===ne(i,s+4,4)){var l=i.getUint16(h);if(((n=18761===l)||19789===l)&&42===i.getUint16(h+2,n)){var c=i.getUint32(h+4,n);c>=8&&(r=h+c)}}}if(r){var u,d,p=i.getUint16(r,n);for(d=0;d<p;d+=1)if(u=r+12*d+2,274===i.getUint16(u,n)){u+=8,e=i.getUint16(u,n),i.setUint16(u,1,n);break}}}catch(t){e=1}return e}function he(t){var e=0,i=1,n=1;switch(t){case 2:i=-1;break;case 3:e=-180;break;case 4:n=-1;break;case 5:e=90,n=-1;break;case 6:e=90;break;case 7:e=90,i=-1;break;case 8:e=-90}return{rotate:e,scaleX:i,scaleY:n}}var le={render:function(){this.initContainer(),this.initCanvas(),this.initCropBox(),this.renderCanvas(),this.cropped&&this.renderCropBox()},initContainer:function(){var t=this.element,e=this.options,i=this.container,n=this.cropper,s=Number(e.minContainerWidth),r=Number(e.minContainerHeight);kt(n,L),Pt(t,L);var a={width:Math.max(i.offsetWidth,s>=0?s:ct),height:Math.max(i.offsetHeight,r>=0?r:ut)};this.containerData=a,It(n,{width:a.width,height:a.height}),kt(t,L),Pt(n,L)},initCanvas:function(){var t=this.containerData,e=this.imageData,i=this.options.viewMode,n=Math.abs(e.rotate)%180==90,s=n?e.naturalHeight:e.naturalWidth,r=n?e.naturalWidth:e.naturalHeight,a=s/r,o=t.width,h=t.height;t.height*a>t.width?3===i?o=t.height*a:h=t.width/a:3===i?h=t.width/a:o=t.height*a;var l={aspectRatio:a,naturalWidth:s,naturalHeight:r,width:o,height:h};this.canvasData=l,this.limited=1===i||2===i,this.limitCanvas(!0,!0),l.width=Math.min(Math.max(l.width,l.minWidth),l.maxWidth),l.height=Math.min(Math.max(l.height,l.minHeight),l.maxHeight),l.left=(t.width-l.width)/2,l.top=(t.height-l.height)/2,l.oldLeft=l.left,l.oldTop=l.top,this.initialCanvasData=Et({},l)},limitCanvas:function(t,e){var i=this.options,n=this.containerData,s=this.canvasData,r=this.cropBoxData,a=i.viewMode,o=s.aspectRatio,h=this.cropped&&r;if(t){var l=Number(i.minCanvasWidth)||0,c=Number(i.minCanvasHeight)||0;a>1?(l=Math.max(l,n.width),c=Math.max(c,n.height),3===a&&(c*o>l?l=c*o:c=l/o)):a>0&&(l?l=Math.max(l,h?r.width:0):c?c=Math.max(c,h?r.height:0):h&&(l=r.width,(c=r.height)*o>l?l=c*o:c=l/o));var u=Qt({aspectRatio:o,width:l,height:c});l=u.width,c=u.height,s.minWidth=l,s.minHeight=c,s.maxWidth=1/0,s.maxHeight=1/0}if(e)if(a>(h?0:1)){var d=n.width-s.width,p=n.height-s.height;s.minLeft=Math.min(0,d),s.minTop=Math.min(0,p),s.maxLeft=Math.max(0,d),s.maxTop=Math.max(0,p),h&&this.limited&&(s.minLeft=Math.min(r.left,r.left+(r.width-s.width)),s.minTop=Math.min(r.top,r.top+(r.height-s.height)),s.maxLeft=r.left,s.maxTop=r.top,2===a&&(s.width>=n.width&&(s.minLeft=Math.min(0,d),s.maxLeft=Math.max(0,d)),s.height>=n.height&&(s.minTop=Math.min(0,p),s.maxTop=Math.max(0,p))))}else s.minLeft=-s.width,s.minTop=-s.height,s.maxLeft=n.width,s.maxTop=n.height},renderCanvas:function(t,e){var i=this.canvasData,n=this.imageData;if(e){var s=te({width:n.naturalWidth*Math.abs(n.scaleX||1),height:n.naturalHeight*Math.abs(n.scaleY||1),degree:n.rotate||0}),r=s.width,a=s.height,o=i.width*(r/i.naturalWidth),h=i.height*(a/i.naturalHeight);i.left-=(o-i.width)/2,i.top-=(h-i.height)/2,i.width=o,i.height=h,i.aspectRatio=r/a,i.naturalWidth=r,i.naturalHeight=a,this.limitCanvas(!0,!1)}(i.width>i.maxWidth||i.width<i.minWidth)&&(i.left=i.oldLeft),(i.height>i.maxHeight||i.height<i.minHeight)&&(i.top=i.oldTop),i.width=Math.min(Math.max(i.width,i.minWidth),i.maxWidth),i.height=Math.min(Math.max(i.height,i.minHeight),i.maxHeight),this.limitCanvas(!1,!0),i.left=Math.min(Math.max(i.left,i.minLeft),i.maxLeft),i.top=Math.min(Math.max(i.top,i.minTop),i.maxTop),i.oldLeft=i.left,i.oldTop=i.top,It(this.canvas,Et({width:i.width,height:i.height},Jt({translateX:i.left,translateY:i.top}))),this.renderImage(t),this.cropped&&this.limited&&this.limitCropBox(!0,!0)},renderImage:function(t){var e=this.canvasData,i=this.imageData,n=i.naturalWidth*(e.width/e.naturalWidth),s=i.naturalHeight*(e.height/e.naturalHeight);Et(i,{width:n,height:s,left:(e.width-n)/2,top:(e.height-s)/2}),It(this.image,Et({width:i.width,height:i.height},Jt(Et({translateX:i.left,translateY:i.top},i)))),t&&this.output()},initCropBox:function(){var t=this.options,e=this.canvasData,i=t.aspectRatio||t.initialAspectRatio,n=Number(t.autoCropArea)||.8,s={width:e.width,height:e.height};i&&(e.height*i>e.width?s.height=s.width/i:s.width=s.height*i),this.cropBoxData=s,this.limitCropBox(!0,!0),s.width=Math.min(Math.max(s.width,s.minWidth),s.maxWidth),s.height=Math.min(Math.max(s.height,s.minHeight),s.maxHeight),s.width=Math.max(s.minWidth,s.width*n),s.height=Math.max(s.minHeight,s.height*n),s.left=e.left+(e.width-s.width)/2,s.top=e.top+(e.height-s.height)/2,s.oldLeft=s.left,s.oldTop=s.top,this.initialCropBoxData=Et({},s)},limitCropBox:function(t,e){var i=this.options,n=this.containerData,s=this.canvasData,r=this.cropBoxData,a=this.limited,o=i.aspectRatio;if(t){var h=Number(i.minCropBoxWidth)||0,l=Number(i.minCropBoxHeight)||0,c=a?Math.min(n.width,s.width,s.width+s.left,n.width-s.left):n.width,u=a?Math.min(n.height,s.height,s.height+s.top,n.height-s.top):n.height;h=Math.min(h,n.width),l=Math.min(l,n.height),o&&(h&&l?l*o>h?l=h/o:h=l*o:h?l=h/o:l&&(h=l*o),u*o>c?u=c/o:c=u*o),r.minWidth=Math.min(h,c),r.minHeight=Math.min(l,u),r.maxWidth=c,r.maxHeight=u}e&&(a?(r.minLeft=Math.max(0,s.left),r.minTop=Math.max(0,s.top),r.maxLeft=Math.min(n.width,s.left+s.width)-r.width,r.maxTop=Math.min(n.height,s.top+s.height)-r.height):(r.minLeft=0,r.minTop=0,r.maxLeft=n.width-r.width,r.maxTop=n.height-r.height))},renderCropBox:function(){var t=this.options,e=this.containerData,i=this.cropBoxData;(i.width>i.maxWidth||i.width<i.minWidth)&&(i.left=i.oldLeft),(i.height>i.maxHeight||i.height<i.minHeight)&&(i.top=i.oldTop),i.width=Math.min(Math.max(i.width,i.minWidth),i.maxWidth),i.height=Math.min(Math.max(i.height,i.minHeight),i.maxHeight),this.limitCropBox(!1,!0),i.left=Math.min(Math.max(i.left,i.minLeft),i.maxLeft),i.top=Math.min(Math.max(i.top,i.minTop),i.maxTop),i.oldLeft=i.left,i.oldTop=i.top,t.movable&&t.cropBoxMovable&&Bt(this.face,U,i.width>=e.width&&i.height>=e.height?w:b),It(this.cropBox,Et({width:i.width,height:i.height},Jt({translateX:i.left,translateY:i.top}))),this.cropped&&this.limited&&this.limitCanvas(!0,!0),this.disabled||this.output()},output:function(){this.preview(),Ht(this.element,j,this.getData())}},ce={initPreview:function(){var t=this.element,e=this.crossOrigin,i=this.options.preview,n=e?this.crossOriginUrl:this.url,s=t.alt||"The image to preview",r=document.createElement("img");if(e&&(r.crossOrigin=e),r.src=n,r.alt=s,this.viewBox.appendChild(r),this.viewBoxImage=r,i){var a=i;"string"==typeof i?a=t.ownerDocument.querySelectorAll(i):i.querySelector&&(a=[i]),this.previews=a,St(a,(function(t){var i=document.createElement("img");Bt(t,F,{width:t.offsetWidth,height:t.offsetHeight,html:t.innerHTML}),e&&(i.crossOrigin=e),i.src=n,i.alt=s,i.style.cssText='display:block;width:100%;height:auto;min-width:0!important;min-height:0!important;max-width:none!important;max-height:none!important;image-orientation:0deg!important;"',t.innerHTML="",t.appendChild(i)}))}},resetPreview:function(){St(this.previews,(function(t){var e=Nt(t,F);It(t,{width:e.width,height:e.height}),t.innerHTML=e.html,zt(t,F)}))},preview:function(){var t=this.imageData,e=this.canvasData,i=this.cropBoxData,n=i.width,s=i.height,r=t.width,a=t.height,o=i.left-e.left-t.left,h=i.top-e.top-t.top;this.cropped&&!this.disabled&&(It(this.viewBoxImage,Et({width:r,height:a},Jt(Et({translateX:-o,translateY:-h},t)))),St(this.previews,(function(e){var i=Nt(e,F),l=i.width,c=i.height,u=l,d=c,p=1;n&&(d=s*(p=l/n)),s&&d>c&&(u=n*(p=c/s),d=c),It(e,{width:u,height:d}),It(e.getElementsByTagName("img")[0],Et({width:r*p,height:a*p},Jt(Et({translateX:-o*p,translateY:-h*p},t))))})))}},ue={bind:function(){var t=this.element,e=this.options,i=this.cropper;_t(e.cropstart)&&Vt(t,q,e.cropstart),_t(e.cropmove)&&Vt(t,X,e.cropmove),_t(e.cropend)&&Vt(t,W,e.cropend),_t(e.crop)&&Vt(t,j,e.crop),_t(e.zoom)&&Vt(t,st,e.zoom),Vt(i,Z,this.onCropStart=this.cropStart.bind(this)),e.zoomable&&e.zoomOnWheel&&Vt(i,nt,this.onWheel=this.wheel.bind(this),{passive:!1,capture:!0}),e.toggleDragModeOnDblclick&&Vt(i,Y,this.onDblclick=this.dblclick.bind(this)),Vt(t.ownerDocument,Q,this.onCropMove=this.cropMove.bind(this)),Vt(t.ownerDocument,tt,this.onCropEnd=this.cropEnd.bind(this)),e.responsive&&Vt(window,it,this.onResize=this.resize.bind(this))},unbind:function(){var t=this.element,e=this.options,i=this.cropper;_t(e.cropstart)&&Gt(t,q,e.cropstart),_t(e.cropmove)&&Gt(t,X,e.cropmove),_t(e.cropend)&&Gt(t,W,e.cropend),_t(e.crop)&&Gt(t,j,e.crop),_t(e.zoom)&&Gt(t,st,e.zoom),Gt(i,Z,this.onCropStart),e.zoomable&&e.zoomOnWheel&&Gt(i,nt,this.onWheel,{passive:!1,capture:!0}),e.toggleDragModeOnDblclick&&Gt(i,Y,this.onDblclick),Gt(t.ownerDocument,Q,this.onCropMove),Gt(t.ownerDocument,tt,this.onCropEnd),e.responsive&&Gt(window,it,this.onResize)}},de={resize:function(){if(!this.disabled){var t,e,i=this.options,n=this.container,s=this.containerData,r=n.offsetWidth/s.width,a=n.offsetHeight/s.height,o=Math.abs(r-1)>Math.abs(a-1)?r:a;1!==o&&(i.restore&&(t=this.getCanvasData(),e=this.getCropBoxData()),this.render(),i.restore&&(this.setCanvasData(St(t,(function(e,i){t[i]=e*o}))),this.setCropBoxData(St(e,(function(t,i){e[i]=t*o})))))}},dblclick:function(){this.disabled||this.options.dragMode===H||this.setDragMode(Rt(this.dragBox,P)?V:G)},wheel:function(t){var e=this,i=Number(this.options.wheelZoomRatio)||.1,n=1;this.disabled||(t.preventDefault(),this.wheeling||(this.wheeling=!0,setTimeout((function(){e.wheeling=!1}),50),t.deltaY?n=t.deltaY>0?1:-1:t.wheelDelta?n=-t.wheelDelta/120:t.detail&&(n=t.detail>0?1:-1),this.zoom(-n*i,t)))},cropStart:function(t){var e=t.buttons,i=t.button;if(!(this.disabled||("mousedown"===t.type||"pointerdown"===t.type&&"mouse"===t.pointerType)&&(ft(e)&&1!==e||ft(i)&&0!==i||t.ctrlKey))){var n,s=this.options,r=this.pointers;t.changedTouches?St(t.changedTouches,(function(t){r[t.identifier]=Kt(t)})):r[t.pointerId||0]=Kt(t),n=Object.keys(r).length>1&&s.zoomable&&s.zoomOnTouch?M:Nt(t.target,U),at.test(n)&&!1!==Ht(this.element,q,{originalEvent:t,action:n})&&(t.preventDefault(),this.action=n,this.cropping=!1,n===_&&(this.cropping=!0,kt(this.dragBox,B)))}},cropMove:function(t){var e=this.action;if(!this.disabled&&e){var i=this.pointers;t.preventDefault(),!1!==Ht(this.element,X,{originalEvent:t,action:e})&&(t.changedTouches?St(t.changedTouches,(function(t){Et(i[t.identifier]||{},Kt(t,!0))})):Et(i[t.pointerId||0]||{},Kt(t,!0)),this.change(t))}},cropEnd:function(t){if(!this.disabled){var e=this.action,i=this.pointers;t.changedTouches?St(t.changedTouches,(function(t){delete i[t.identifier]})):delete i[t.pointerId||0],e&&(t.preventDefault(),Object.keys(i).length||(this.action=""),this.cropping&&(this.cropping=!1,Dt(this.dragBox,B,this.cropped&&this.options.modal)),Ht(this.element,W,{originalEvent:t,action:e}))}}},pe={change:function(t){var e,i=this.options,n=this.canvasData,s=this.containerData,r=this.cropBoxData,a=this.pointers,o=this.action,h=i.aspectRatio,l=r.left,c=r.top,u=r.width,d=r.height,p=l+u,m=c+d,f=0,g=0,v=s.width,y=s.height,x=!0;!h&&t.shiftKey&&(h=u&&d?u/d:1),this.limited&&(f=r.minLeft,g=r.minTop,v=f+Math.min(s.width,n.width,n.left+n.width),y=g+Math.min(s.height,n.height,n.top+n.height));var P=a[Object.keys(a)[0]],D={x:P.endX-P.startX,y:P.endY-P.startY},O=function(t){switch(t){case S:p+D.x>v&&(D.x=v-p);break;case E:l+D.x<f&&(D.x=f-l);break;case A:c+D.y<g&&(D.y=g-c);break;case T:m+D.y>y&&(D.y=y-m)}};switch(o){case b:l+=D.x,c+=D.y;break;case S:if(D.x>=0&&(p>=v||h&&(c<=g||m>=y))){x=!1;break}O(S),(u+=D.x)<0&&(o=E,l-=u=-u),h&&(d=u/h,c+=(r.height-d)/2);break;case A:if(D.y<=0&&(c<=g||h&&(l<=f||p>=v))){x=!1;break}O(A),d-=D.y,c+=D.y,d<0&&(o=T,c-=d=-d),h&&(u=d*h,l+=(r.width-u)/2);break;case E:if(D.x<=0&&(l<=f||h&&(c<=g||m>=y))){x=!1;break}O(E),u-=D.x,l+=D.x,u<0&&(o=S,l-=u=-u),h&&(d=u/h,c+=(r.height-d)/2);break;case T:if(D.y>=0&&(m>=y||h&&(l<=f||p>=v))){x=!1;break}O(T),(d+=D.y)<0&&(o=A,c-=d=-d),h&&(u=d*h,l+=(r.width-u)/2);break;case C:if(h){if(D.y<=0&&(c<=g||p>=v)){x=!1;break}O(A),d-=D.y,c+=D.y,u=d*h}else O(A),O(S),D.x>=0?p<v?u+=D.x:D.y<=0&&c<=g&&(x=!1):u+=D.x,D.y<=0?c>g&&(d-=D.y,c+=D.y):(d-=D.y,c+=D.y);u<0&&d<0?(o=k,c-=d=-d,l-=u=-u):u<0?(o=I,l-=u=-u):d<0&&(o=R,c-=d=-d);break;case I:if(h){if(D.y<=0&&(c<=g||l<=f)){x=!1;break}O(A),d-=D.y,c+=D.y,u=d*h,l+=r.width-u}else O(A),O(E),D.x<=0?l>f?(u-=D.x,l+=D.x):D.y<=0&&c<=g&&(x=!1):(u-=D.x,l+=D.x),D.y<=0?c>g&&(d-=D.y,c+=D.y):(d-=D.y,c+=D.y);u<0&&d<0?(o=R,c-=d=-d,l-=u=-u):u<0?(o=C,l-=u=-u):d<0&&(o=k,c-=d=-d);break;case k:if(h){if(D.x<=0&&(l<=f||m>=y)){x=!1;break}O(E),u-=D.x,l+=D.x,d=u/h}else O(T),O(E),D.x<=0?l>f?(u-=D.x,l+=D.x):D.y>=0&&m>=y&&(x=!1):(u-=D.x,l+=D.x),D.y>=0?m<y&&(d+=D.y):d+=D.y;u<0&&d<0?(o=C,c-=d=-d,l-=u=-u):u<0?(o=R,l-=u=-u):d<0&&(o=I,c-=d=-d);break;case R:if(h){if(D.x>=0&&(p>=v||m>=y)){x=!1;break}O(S),d=(u+=D.x)/h}else O(T),O(S),D.x>=0?p<v?u+=D.x:D.y>=0&&m>=y&&(x=!1):u+=D.x,D.y>=0?m<y&&(d+=D.y):d+=D.y;u<0&&d<0?(o=I,c-=d=-d,l-=u=-u):u<0?(o=k,l-=u=-u):d<0&&(o=C,c-=d=-d);break;case w:this.move(D.x,D.y),x=!1;break;case M:this.zoom($t(a),t),x=!1;break;case _:if(!D.x||!D.y){x=!1;break}e=jt(this.cropper),l=P.startX-e.left,c=P.startY-e.top,u=r.minWidth,d=r.minHeight,D.x>0?o=D.y>0?R:C:D.x<0&&(l-=u,o=D.y>0?k:I),D.y<0&&(c-=d),this.cropped||(Pt(this.cropBox,L),this.cropped=!0,this.limited&&this.limitCropBox(!0,!0))}x&&(r.width=u,r.height=d,r.left=l,r.top=c,this.action=o,this.renderCropBox()),St(a,(function(t){t.startX=t.endX,t.startY=t.endY}))}},me={crop:function(){return!this.ready||this.cropped||this.disabled||(this.cropped=!0,this.limitCropBox(!0,!0),this.options.modal&&kt(this.dragBox,B),Pt(this.cropBox,L),this.setCropBoxData(this.initialCropBoxData)),this},reset:function(){return this.ready&&!this.disabled&&(this.imageData=Et({},this.initialImageData),this.canvasData=Et({},this.initialCanvasData),this.cropBoxData=Et({},this.initialCropBoxData),this.renderCanvas(),this.cropped&&this.renderCropBox()),this},clear:function(){return this.cropped&&!this.disabled&&(Et(this.cropBoxData,{left:0,top:0,width:0,height:0}),this.cropped=!1,this.renderCropBox(),this.limitCanvas(!0,!0),this.renderCanvas(),Pt(this.dragBox,B),kt(this.cropBox,L)),this},replace:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return!this.disabled&&t&&(this.isImg&&(this.element.src=t),e?(this.url=t,this.image.src=t,this.ready&&(this.viewBoxImage.src=t,St(this.previews,(function(e){e.getElementsByTagName("img")[0].src=t})))):(this.isImg&&(this.replaced=!0),this.options.data=null,this.uncreate(),this.load(t))),this},enable:function(){return this.ready&&this.disabled&&(this.disabled=!1,Pt(this.cropper,D)),this},disable:function(){return this.ready&&!this.disabled&&(this.disabled=!0,kt(this.cropper,D)),this},destroy:function(){var t=this.element;return t[x]?(t[x]=void 0,this.isImg&&this.replaced&&(t.src=this.originalUrl),this.uncreate(),this):this},move:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t,i=this.canvasData,n=i.left,s=i.top;return this.moveTo(vt(t)?t:n+Number(t),vt(e)?e:s+Number(e))},moveTo:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t,i=this.canvasData,n=!1;return t=Number(t),e=Number(e),this.ready&&!this.disabled&&this.options.movable&&(ft(t)&&(i.left=t,n=!0),ft(e)&&(i.top=e,n=!0),n&&this.renderCanvas(!0)),this},zoom:function(t,e){var i=this.canvasData;return t=(t=Number(t))<0?1/(1-t):1+t,this.zoomTo(i.width*t/i.naturalWidth,null,e)},zoomTo:function(t,e,i){var n=this.options,s=this.canvasData,r=s.width,a=s.height,o=s.naturalWidth,h=s.naturalHeight;if((t=Number(t))>=0&&this.ready&&!this.disabled&&n.zoomable){var l=o*t,c=h*t;if(!1===Ht(this.element,st,{ratio:t,oldRatio:r/o,originalEvent:i}))return this;if(i){var u=this.pointers,d=jt(this.cropper),p=u&&Object.keys(u).length?Zt(u):{pageX:i.pageX,pageY:i.pageY};s.left-=(l-r)*((p.pageX-d.left-s.left)/r),s.top-=(c-a)*((p.pageY-d.top-s.top)/a)}else bt(e)&&ft(e.x)&&ft(e.y)?(s.left-=(l-r)*((e.x-s.left)/r),s.top-=(c-a)*((e.y-s.top)/a)):(s.left-=(l-r)/2,s.top-=(c-a)/2);s.width=l,s.height=c,this.renderCanvas(!0)}return this},rotate:function(t){return this.rotateTo((this.imageData.rotate||0)+Number(t))},rotateTo:function(t){return ft(t=Number(t))&&this.ready&&!this.disabled&&this.options.rotatable&&(this.imageData.rotate=t%360,this.renderCanvas(!0,!0)),this},scaleX:function(t){var e=this.imageData.scaleY;return this.scale(t,ft(e)?e:1)},scaleY:function(t){var e=this.imageData.scaleX;return this.scale(ft(e)?e:1,t)},scale:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t,i=this.imageData,n=!1;return t=Number(t),e=Number(e),this.ready&&!this.disabled&&this.options.scalable&&(ft(t)&&(i.scaleX=t,n=!0),ft(e)&&(i.scaleY=e,n=!0),n&&this.renderCanvas(!0,!0)),this},getData:function(){var t,e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],i=this.options,n=this.imageData,s=this.canvasData,r=this.cropBoxData;if(this.ready&&this.cropped){t={x:r.left-s.left,y:r.top-s.top,width:r.width,height:r.height};var a=n.width/n.naturalWidth;if(St(t,(function(e,i){t[i]=e/a})),e){var o=Math.round(t.y+t.height),h=Math.round(t.x+t.width);t.x=Math.round(t.x),t.y=Math.round(t.y),t.width=h-t.x,t.height=o-t.y}}else t={x:0,y:0,width:0,height:0};return i.rotatable&&(t.rotate=n.rotate||0),i.scalable&&(t.scaleX=n.scaleX||1,t.scaleY=n.scaleY||1),t},setData:function(t){var e=this.options,i=this.imageData,n=this.canvasData,s={};if(this.ready&&!this.disabled&&bt(t)){var r=!1;e.rotatable&&ft(t.rotate)&&t.rotate!==i.rotate&&(i.rotate=t.rotate,r=!0),e.scalable&&(ft(t.scaleX)&&t.scaleX!==i.scaleX&&(i.scaleX=t.scaleX,r=!0),ft(t.scaleY)&&t.scaleY!==i.scaleY&&(i.scaleY=t.scaleY,r=!0)),r&&this.renderCanvas(!0,!0);var a=i.width/i.naturalWidth;ft(t.x)&&(s.left=t.x*a+n.left),ft(t.y)&&(s.top=t.y*a+n.top),ft(t.width)&&(s.width=t.width*a),ft(t.height)&&(s.height=t.height*a),this.setCropBoxData(s)}return this},getContainerData:function(){return this.ready?Et({},this.containerData):{}},getImageData:function(){return this.sized?Et({},this.imageData):{}},getCanvasData:function(){var t=this.canvasData,e={};return this.ready&&St(["left","top","width","height","naturalWidth","naturalHeight"],(function(i){e[i]=t[i]})),e},setCanvasData:function(t){var e=this.canvasData,i=e.aspectRatio;return this.ready&&!this.disabled&&bt(t)&&(ft(t.left)&&(e.left=t.left),ft(t.top)&&(e.top=t.top),ft(t.width)?(e.width=t.width,e.height=t.width/i):ft(t.height)&&(e.height=t.height,e.width=t.height*i),this.renderCanvas(!0)),this},getCropBoxData:function(){var t,e=this.cropBoxData;return this.ready&&this.cropped&&(t={left:e.left,top:e.top,width:e.width,height:e.height}),t||{}},setCropBoxData:function(t){var e,i,n=this.cropBoxData,s=this.options.aspectRatio;return this.ready&&this.cropped&&!this.disabled&&bt(t)&&(ft(t.left)&&(n.left=t.left),ft(t.top)&&(n.top=t.top),ft(t.width)&&t.width!==n.width&&(e=!0,n.width=t.width),ft(t.height)&&t.height!==n.height&&(i=!0,n.height=t.height),s&&(e?n.height=n.width/s:i&&(n.width=n.height*s)),this.renderCropBox()),this},getCroppedCanvas:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!this.ready||!window.HTMLCanvasElement)return null;var e=this.canvasData,i=ee(this.image,this.imageData,e,t);if(!this.cropped)return i;var n=this.getData(t.rounded),s=n.x,r=n.y,a=n.width,h=n.height,l=i.width/Math.floor(e.naturalWidth);1!==l&&(s*=l,r*=l,a*=l,h*=l);var c=a/h,u=Qt({aspectRatio:c,width:t.maxWidth||1/0,height:t.maxHeight||1/0}),d=Qt({aspectRatio:c,width:t.minWidth||0,height:t.minHeight||0},"cover"),p=Qt({aspectRatio:c,width:t.width||(1!==l?i.width:a),height:t.height||(1!==l?i.height:h)}),m=p.width,f=p.height;m=Math.min(u.width,Math.max(d.width,m)),f=Math.min(u.height,Math.max(d.height,f));var g=document.createElement("canvas"),v=g.getContext("2d");g.width=At(m),g.height=At(f),v.fillStyle=t.fillColor||"transparent",v.fillRect(0,0,m,f);var y=t.imageSmoothingEnabled,x=void 0===y||y,b=t.imageSmoothingQuality;v.imageSmoothingEnabled=x,b&&(v.imageSmoothingQuality=b);var _,w,M,S,E,T,A=i.width,C=i.height,I=s,R=r;I<=-a||I>A?(I=0,_=0,M=0,E=0):I<=0?(M=-I,I=0,E=_=Math.min(A,a+I)):I<=A&&(M=0,E=_=Math.min(a,A-I)),_<=0||R<=-h||R>C?(R=0,w=0,S=0,T=0):R<=0?(S=-R,R=0,T=w=Math.min(C,h+R)):R<=C&&(S=0,T=w=Math.min(h,C-R));var k=[I,R,_,w];if(E>0&&T>0){var P=m/a;k.push(M*P,S*P,E*P,T*P)}return v.drawImage.apply(v,[i].concat(o(k.map((function(t){return Math.floor(At(t))}))))),g},setAspectRatio:function(t){var e=this.options;return this.disabled||vt(t)||(e.aspectRatio=Math.max(0,t)||NaN,this.ready&&(this.initCropBox(),this.cropped&&this.renderCropBox())),this},setDragMode:function(t){var e=this.options,i=this.dragBox,n=this.face;if(this.ready&&!this.disabled){var s=t===G,r=e.movable&&t===V;t=s||r?t:H,e.dragMode=t,Bt(i,U,t),Dt(i,P,s),Dt(i,z,r),e.cropBoxMovable||(Bt(n,U,t),Dt(n,P,s),Dt(n,z,r))}return this}},fe=g.Cropper,ge=function(){function t(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(n(this,t),!e||!lt.test(e.tagName))throw new Error("The first argument is required and must be an <img> or <canvas> element.");this.element=e,this.options=Et({},dt,bt(i)&&i),this.cropped=!1,this.disabled=!1,this.pointers={},this.ready=!1,this.reloading=!1,this.replaced=!1,this.sized=!1,this.sizing=!1,this.init()}return r(t,[{key:"init",value:function(){var t,e=this.element,i=e.tagName.toLowerCase();if(!e[x]){if(e[x]=this,"img"===i){if(this.isImg=!0,t=e.getAttribute("src")||"",this.originalUrl=t,!t)return;t=e.src}else"canvas"===i&&window.HTMLCanvasElement&&(t=e.toDataURL());this.load(t)}}},{key:"load",value:function(t){var e=this;if(t){this.url=t,this.imageData={};var i=this.element,n=this.options;if(n.rotatable||n.scalable||(n.checkOrientation=!1),n.checkOrientation&&window.ArrayBuffer)if(ot.test(t))ht.test(t)?this.read(re(t)):this.clone();else{var s=new XMLHttpRequest,r=this.clone.bind(this);this.reloading=!0,this.xhr=s,s.onabort=r,s.onerror=r,s.ontimeout=r,s.onprogress=function(){s.getResponseHeader("content-type")!==rt&&s.abort()},s.onload=function(){e.read(s.response)},s.onloadend=function(){e.reloading=!1,e.xhr=null},n.checkCrossOrigin&&qt(t)&&i.crossOrigin&&(t=Yt(t)),s.open("GET",t,!0),s.responseType="arraybuffer",s.withCredentials="use-credentials"===i.crossOrigin,s.send()}else this.clone()}}},{key:"read",value:function(t){var e=this.options,i=this.imageData,n=oe(t),s=0,r=1,a=1;if(n>1){this.url=ae(t,rt);var o=he(n);s=o.rotate,r=o.scaleX,a=o.scaleY}e.rotatable&&(i.rotate=s),e.scalable&&(i.scaleX=r,i.scaleY=a),this.clone()}},{key:"clone",value:function(){var t=this.element,e=this.url,i=t.crossOrigin,n=e;this.options.checkCrossOrigin&&qt(e)&&(i||(i="anonymous"),n=Yt(e)),this.crossOrigin=i,this.crossOriginUrl=n;var s=document.createElement("img");i&&(s.crossOrigin=i),s.src=n||e,s.alt=t.alt||"The image to crop",this.image=s,s.onload=this.start.bind(this),s.onerror=this.stop.bind(this),kt(s,O),t.parentNode.insertBefore(s,t.nextSibling)}},{key:"start",value:function(){var t=this,e=this.image;e.onload=null,e.onerror=null,this.sizing=!0;var i=g.navigator&&/(?:iPad|iPhone|iPod).*?AppleWebKit/i.test(g.navigator.userAgent),n=function(e,i){Et(t.imageData,{naturalWidth:e,naturalHeight:i,aspectRatio:e/i}),t.initialImageData=Et({},t.imageData),t.sizing=!1,t.sized=!0,t.build()};if(!e.naturalWidth||i){var s=document.createElement("img"),r=document.body||document.documentElement;this.sizingImage=s,s.onload=function(){n(s.width,s.height),i||r.removeChild(s)},s.src=e.src,i||(s.style.cssText="left:0;max-height:none!important;max-width:none!important;min-height:0!important;min-width:0!important;opacity:0;position:absolute;top:0;z-index:-1;",r.appendChild(s))}else n(e.naturalWidth,e.naturalHeight)}},{key:"stop",value:function(){var t=this.image;t.onload=null,t.onerror=null,t.parentNode.removeChild(t),this.image=null}},{key:"build",value:function(){if(this.sized&&!this.ready){var t=this.element,e=this.options,i=this.image,n=t.parentNode,s=document.createElement("div");s.innerHTML=pt;var r=s.querySelector(".".concat(x,"-container")),a=r.querySelector(".".concat(x,"-canvas")),o=r.querySelector(".".concat(x,"-drag-box")),h=r.querySelector(".".concat(x,"-crop-box")),l=h.querySelector(".".concat(x,"-face"));this.container=n,this.cropper=r,this.canvas=a,this.dragBox=o,this.cropBox=h,this.viewBox=r.querySelector(".".concat(x,"-view-box")),this.face=l,a.appendChild(i),kt(t,L),n.insertBefore(r,t.nextSibling),Pt(i,O),this.initPreview(),this.bind(),e.initialAspectRatio=Math.max(0,e.initialAspectRatio)||NaN,e.aspectRatio=Math.max(0,e.aspectRatio)||NaN,e.viewMode=Math.max(0,Math.min(3,Math.round(e.viewMode)))||0,kt(h,L),e.guides||kt(h.getElementsByClassName("".concat(x,"-dashed")),L),e.center||kt(h.getElementsByClassName("".concat(x,"-center")),L),e.background&&kt(r,"".concat(x,"-bg")),e.highlight||kt(l,N),e.cropBoxMovable&&(kt(l,z),Bt(l,U,b)),e.cropBoxResizable||(kt(h.getElementsByClassName("".concat(x,"-line")),L),kt(h.getElementsByClassName("".concat(x,"-point")),L)),this.render(),this.ready=!0,this.setDragMode(e.dragMode),e.autoCrop&&this.crop(),this.setData(e.data),_t(e.ready)&&Vt(t,et,e.ready,{once:!0}),Ht(t,et)}}},{key:"unbuild",value:function(){if(this.ready){this.ready=!1,this.unbind(),this.resetPreview();var t=this.cropper.parentNode;t&&t.removeChild(this.cropper),Pt(this.element,L)}}},{key:"uncreate",value:function(){this.ready?(this.unbuild(),this.ready=!1,this.cropped=!1):this.sizing?(this.sizingImage.onload=null,this.sizing=!1,this.sized=!1):this.reloading?(this.xhr.onabort=null,this.xhr.abort()):this.image&&this.stop()}}],[{key:"noConflict",value:function(){return window.Cropper=fe,t}},{key:"setDefaults",value:function(t){Et(dt,bt(t)&&t)}}]),t}();return Et(ge.prototype,le,ce,ue,de,pe,me),ge}()},166:(t,e,i)=>{"use strict";var n=i(826);function s(){this.argTypes=[],this.shimArgs=[],this.arrayArgs=[],this.arrayBlockIndices=[],this.scalarArgs=[],this.offsetArgs=[],this.offsetArgIndex=[],this.indexArgs=[],this.shapeArgs=[],this.funcName="",this.pre=null,this.body=null,this.post=null,this.debug=!1}t.exports=function(t){var e=new s;e.pre=t.pre,e.body=t.body,e.post=t.post;var i=t.args.slice(0);e.argTypes=i;for(var r=0;r<i.length;++r){var a=i[r];if("array"===a||"object"==typeof a&&a.blockIndices){if(e.argTypes[r]="array",e.arrayArgs.push(r),e.arrayBlockIndices.push(a.blockIndices?a.blockIndices:0),e.shimArgs.push("array"+r),r<e.pre.args.length&&e.pre.args[r].count>0)throw new Error("cwise: pre() block may not reference array args");if(r<e.post.args.length&&e.post.args[r].count>0)throw new Error("cwise: post() block may not reference array args")}else if("scalar"===a)e.scalarArgs.push(r),e.shimArgs.push("scalar"+r);else if("index"===a){if(e.indexArgs.push(r),r<e.pre.args.length&&e.pre.args[r].count>0)throw new Error("cwise: pre() block may not reference array index");if(r<e.body.args.length&&e.body.args[r].lvalue)throw new Error("cwise: body() block may not write to array index");if(r<e.post.args.length&&e.post.args[r].count>0)throw new Error("cwise: post() block may not reference array index")}else if("shape"===a){if(e.shapeArgs.push(r),r<e.pre.args.length&&e.pre.args[r].lvalue)throw new Error("cwise: pre() block may not write to array shape");if(r<e.body.args.length&&e.body.args[r].lvalue)throw new Error("cwise: body() block may not write to array shape");if(r<e.post.args.length&&e.post.args[r].lvalue)throw new Error("cwise: post() block may not write to array shape")}else{if("object"!=typeof a||!a.offset)throw new Error("cwise: Unknown argument type "+i[r]);e.argTypes[r]="offset",e.offsetArgs.push({array:a.array,offset:a.offset}),e.offsetArgIndex.push(r)}}if(e.arrayArgs.length<=0)throw new Error("cwise: No array arguments specified");if(e.pre.args.length>i.length)throw new Error("cwise: Too many arguments in pre() block");if(e.body.args.length>i.length)throw new Error("cwise: Too many arguments in body() block");if(e.post.args.length>i.length)throw new Error("cwise: Too many arguments in post() block");return e.debug=!!t.printCode||!!t.debug,e.funcName=t.funcName||"cwise",e.blockSize=t.blockSize||64,n(e)}},347:(t,e,i)=>{"use strict";var n=i(584);function s(t,e,i){var n,s,r=t.length,a=e.arrayArgs.length,o=e.indexArgs.length>0,h=[],l=[],c=0,u=0;for(n=0;n<r;++n)l.push(["i",n,"=0"].join(""));for(s=0;s<a;++s)for(n=0;n<r;++n)u=c,c=t[n],0===n?l.push(["d",s,"s",n,"=t",s,"p",c].join("")):l.push(["d",s,"s",n,"=(t",s,"p",c,"-s",u,"*t",s,"p",u,")"].join(""));for(l.length>0&&h.push("var "+l.join(",")),n=r-1;n>=0;--n)c=t[n],h.push(["for(i",n,"=0;i",n,"<s",c,";++i",n,"){"].join(""));for(h.push(i),n=0;n<r;++n){for(u=c,c=t[n],s=0;s<a;++s)h.push(["p",s,"+=d",s,"s",n].join(""));o&&(n>0&&h.push(["index[",u,"]-=s",u].join("")),h.push(["++index[",c,"]"].join(""))),h.push("}")}return h.join("\n")}function r(t,e,i){for(var n=t.body,s=[],r=[],a=0;a<t.args.length;++a){var o=t.args[a];if(!(o.count<=0)){var h=new RegExp(o.name,"g"),l="",c=e.arrayArgs.indexOf(a);switch(e.argTypes[a]){case"offset":var u=e.offsetArgIndex.indexOf(a);c=e.offsetArgs[u].array,l="+q"+u;case"array":l="p"+c+l;var d="l"+a,p="a"+c;if(0===e.arrayBlockIndices[c])1===o.count?"generic"===i[c]?o.lvalue?(s.push(["var ",d,"=",p,".get(",l,")"].join("")),n=n.replace(h,d),r.push([p,".set(",l,",",d,")"].join(""))):n=n.replace(h,[p,".get(",l,")"].join("")):n=n.replace(h,[p,"[",l,"]"].join("")):"generic"===i[c]?(s.push(["var ",d,"=",p,".get(",l,")"].join("")),n=n.replace(h,d),o.lvalue&&r.push([p,".set(",l,",",d,")"].join(""))):(s.push(["var ",d,"=",p,"[",l,"]"].join("")),n=n.replace(h,d),o.lvalue&&r.push([p,"[",l,"]=",d].join("")));else{for(var m=[o.name],f=[l],g=0;g<Math.abs(e.arrayBlockIndices[c]);g++)m.push("\\s*\\[([^\\]]+)\\]"),f.push("$"+(g+1)+"*t"+c+"b"+g);if(h=new RegExp(m.join(""),"g"),l=f.join("+"),"generic"===i[c])throw new Error("cwise: Generic arrays not supported in combination with blocks!");n=n.replace(h,[p,"[",l,"]"].join(""))}break;case"scalar":n=n.replace(h,"Y"+e.scalarArgs.indexOf(a));break;case"index":n=n.replace(h,"index");break;case"shape":n=n.replace(h,"shape")}}}return[s.join("\n"),n,r.join("\n")].join("\n").trim()}function a(t){for(var e=new Array(t.length),i=!0,n=0;n<t.length;++n){var s=t[n],r=s.match(/\d+/);r=r?r[0]:"",0===s.charAt(0)?e[n]="u"+s.charAt(1)+r:e[n]=s.charAt(0)+r,n>0&&(i=i&&e[n]===e[n-1])}return i?e[0]:e.join("")}t.exports=function(t,e){for(var i=e[1].length-Math.abs(t.arrayBlockIndices[0])|0,o=new Array(t.arrayArgs.length),h=new Array(t.arrayArgs.length),l=0;l<t.arrayArgs.length;++l)h[l]=e[2*l],o[l]=e[2*l+1];var c=[],u=[],d=[],p=[],m=[];for(l=0;l<t.arrayArgs.length;++l){t.arrayBlockIndices[l]<0?(d.push(0),p.push(i),c.push(i),u.push(i+t.arrayBlockIndices[l])):(d.push(t.arrayBlockIndices[l]),p.push(t.arrayBlockIndices[l]+i),c.push(0),u.push(t.arrayBlockIndices[l]));for(var f=[],g=0;g<o[l].length;g++)d[l]<=o[l][g]&&o[l][g]<p[l]&&f.push(o[l][g]-d[l]);m.push(f)}var v=["SS"],y=["'use strict'"],x=[];for(g=0;g<i;++g)x.push(["s",g,"=SS[",g,"]"].join(""));for(l=0;l<t.arrayArgs.length;++l){v.push("a"+l),v.push("t"+l),v.push("p"+l);for(g=0;g<i;++g)x.push(["t",l,"p",g,"=t",l,"[",d[l]+g,"]"].join(""));for(g=0;g<Math.abs(t.arrayBlockIndices[l]);++g)x.push(["t",l,"b",g,"=t",l,"[",c[l]+g,"]"].join(""))}for(l=0;l<t.scalarArgs.length;++l)v.push("Y"+l);if(t.shapeArgs.length>0&&x.push("shape=SS.slice(0)"),t.indexArgs.length>0){var b=new Array(i);for(l=0;l<i;++l)b[l]="0";x.push(["index=[",b.join(","),"]"].join(""))}for(l=0;l<t.offsetArgs.length;++l){var _=t.offsetArgs[l],w=[];for(g=0;g<_.offset.length;++g)0!==_.offset[g]&&(1===_.offset[g]?w.push(["t",_.array,"p",g].join("")):w.push([_.offset[g],"*t",_.array,"p",g].join("")));0===w.length?x.push("q"+l+"=0"):x.push(["q",l,"=",w.join("+")].join(""))}var M=n([].concat(t.pre.thisVars).concat(t.body.thisVars).concat(t.post.thisVars));for((x=x.concat(M)).length>0&&y.push("var "+x.join(",")),l=0;l<t.arrayArgs.length;++l)y.push("p"+l+"|=0");t.pre.body.length>3&&y.push(r(t.pre,t,h));var S=r(t.body,t,h),E=function(t){for(var e=0,i=t[0].length;e<i;){for(var n=1;n<t.length;++n)if(t[n][e]!==t[0][e])return e;++e}return e}(m);E<i?y.push(function(t,e,i,n){for(var r=e.length,a=i.arrayArgs.length,o=i.blockSize,h=i.indexArgs.length>0,l=[],c=0;c<a;++c)l.push(["var offset",c,"=p",c].join(""));for(c=t;c<r;++c)l.push(["for(var j"+c+"=SS[",e[c],"]|0;j",c,">0;){"].join("")),l.push(["if(j",c,"<",o,"){"].join("")),l.push(["s",e[c],"=j",c].join("")),l.push(["j",c,"=0"].join("")),l.push(["}else{s",e[c],"=",o].join("")),l.push(["j",c,"-=",o,"}"].join("")),h&&l.push(["index[",e[c],"]=j",c].join(""));for(c=0;c<a;++c){for(var u=["offset"+c],d=t;d<r;++d)u.push(["j",d,"*t",c,"p",e[d]].join(""));l.push(["p",c,"=(",u.join("+"),")"].join(""))}for(l.push(s(e,i,n)),c=t;c<r;++c)l.push("}");return l.join("\n")}(E,m[0],t,S)):y.push(s(m[0],t,S)),t.post.body.length>3&&y.push(r(t.post,t,h)),t.debug;var T=[t.funcName||"unnamed","_cwise_loop_",o[0].join("s"),"m",E,a(h)].join("");return new Function(["function ",T,"(",v.join(","),"){",y.join("\n"),"} return ",T].join(""))()}},826:(t,e,i)=>{"use strict";var n=i(347);t.exports=function(t){var e=["'use strict'","var CACHED={}"],i=[],s=t.funcName+"_cwise_thunk";e.push(["return function ",s,"(",t.shimArgs.join(","),"){"].join(""));for(var r=[],a=[],o=[["array",t.arrayArgs[0],".shape.slice(",Math.max(0,t.arrayBlockIndices[0]),t.arrayBlockIndices[0]<0?","+t.arrayBlockIndices[0]+")":")"].join("")],h=[],l=[],c=0;c<t.arrayArgs.length;++c){var u=t.arrayArgs[c];i.push(["t",u,"=array",u,".dtype,","r",u,"=array",u,".order"].join("")),r.push("t"+u),r.push("r"+u),a.push("t"+u),a.push("r"+u+".join()"),o.push("array"+u+".data"),o.push("array"+u+".stride"),o.push("array"+u+".offset|0"),c>0&&(h.push("array"+t.arrayArgs[0]+".shape.length===array"+u+".shape.length+"+(Math.abs(t.arrayBlockIndices[0])-Math.abs(t.arrayBlockIndices[c]))),l.push("array"+t.arrayArgs[0]+".shape[shapeIndex+"+Math.max(0,t.arrayBlockIndices[0])+"]===array"+u+".shape[shapeIndex+"+Math.max(0,t.arrayBlockIndices[c])+"]"))}for(t.arrayArgs.length>1&&(e.push("if (!("+h.join(" && ")+")) throw new Error('cwise: Arrays do not all have the same dimensionality!')"),e.push("for(var shapeIndex=array"+t.arrayArgs[0]+".shape.length-"+Math.abs(t.arrayBlockIndices[0])+"; shapeIndex--\x3e0;) {"),e.push("if (!("+l.join(" && ")+")) throw new Error('cwise: Arrays do not all have the same shape!')"),e.push("}")),c=0;c<t.scalarArgs.length;++c)o.push("scalar"+t.scalarArgs[c]);return i.push(["type=[",a.join(","),"].join()"].join("")),i.push("proc=CACHED[type]"),e.push("var "+i.join(",")),e.push(["if(!proc){","CACHED[type]=proc=compile([",r.join(","),"])}","return proc(",o.join(","),")}"].join("")),t.debug,new Function("compile",e.join("\n"))(n.bind(void 0,t))}},990:t=>{"use strict";var e=Object.prototype.hasOwnProperty,i="~";function n(){}function s(t,e,i){this.fn=t,this.context=e,this.once=i||!1}function r(t,e,n,r,a){if("function"!=typeof n)throw new TypeError("The listener must be a function");var o=new s(n,r||t,a),h=i?i+e:e;return t._events[h]?t._events[h].fn?t._events[h]=[t._events[h],o]:t._events[h].push(o):(t._events[h]=o,t._eventsCount++),t}function a(t,e){0==--t._eventsCount?t._events=new n:delete t._events[e]}function o(){this._events=new n,this._eventsCount=0}Object.create&&(n.prototype=Object.create(null),(new n).__proto__||(i=!1)),o.prototype.eventNames=function(){var t,n,s=[];if(0===this._eventsCount)return s;for(n in t=this._events)e.call(t,n)&&s.push(i?n.slice(1):n);return Object.getOwnPropertySymbols?s.concat(Object.getOwnPropertySymbols(t)):s},o.prototype.listeners=function(t){var e=i?i+t:t,n=this._events[e];if(!n)return[];if(n.fn)return[n.fn];for(var s=0,r=n.length,a=new Array(r);s<r;s++)a[s]=n[s].fn;return a},o.prototype.listenerCount=function(t){var e=i?i+t:t,n=this._events[e];return n?n.fn?1:n.length:0},o.prototype.emit=function(t,e,n,s,r,a){var o=i?i+t:t;if(!this._events[o])return!1;var h,l,c=this._events[o],u=arguments.length;if(c.fn){switch(c.once&&this.removeListener(t,c.fn,void 0,!0),u){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,e),!0;case 3:return c.fn.call(c.context,e,n),!0;case 4:return c.fn.call(c.context,e,n,s),!0;case 5:return c.fn.call(c.context,e,n,s,r),!0;case 6:return c.fn.call(c.context,e,n,s,r,a),!0}for(l=1,h=new Array(u-1);l<u;l++)h[l-1]=arguments[l];c.fn.apply(c.context,h)}else{var d,p=c.length;for(l=0;l<p;l++)switch(c[l].once&&this.removeListener(t,c[l].fn,void 0,!0),u){case 1:c[l].fn.call(c[l].context);break;case 2:c[l].fn.call(c[l].context,e);break;case 3:c[l].fn.call(c[l].context,e,n);break;case 4:c[l].fn.call(c[l].context,e,n,s);break;default:if(!h)for(d=1,h=new Array(u-1);d<u;d++)h[d-1]=arguments[d];c[l].fn.apply(c[l].context,h)}}return!0},o.prototype.on=function(t,e,i){return r(this,t,e,i,!1)},o.prototype.once=function(t,e,i){return r(this,t,e,i,!0)},o.prototype.removeListener=function(t,e,n,s){var r=i?i+t:t;if(!this._events[r])return this;if(!e)return a(this,r),this;var o=this._events[r];if(o.fn)o.fn!==e||s&&!o.once||n&&o.context!==n||a(this,r);else{for(var h=0,l=[],c=o.length;h<c;h++)(o[h].fn!==e||s&&!o[h].once||n&&o[h].context!==n)&&l.push(o[h]);l.length?this._events[r]=1===l.length?l[0]:l:a(this,r)}return this},o.prototype.removeAllListeners=function(t){var e;return t?(e=i?i+t:t,this._events[e]&&a(this,e)):(this._events=new n,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=i,o.EventEmitter=o,t.exports=o},772:t=>{"use strict";t.exports=function(t){for(var e=new Array(t),i=0;i<t;++i)e[i]=i;return e}},460:t=>{function e(t){return!!t.constructor&&"function"==typeof t.constructor.isBuffer&&t.constructor.isBuffer(t)}t.exports=function(t){return null!=t&&(e(t)||function(t){return"function"==typeof t.readFloatLE&&"function"==typeof t.slice&&e(t.slice(0,0))}(t)||!!t._isBuffer)}},367:(t,e,i)=>{"use strict";var n=i(166),s={body:"",args:[],thisVars:[],localVars:[]};function r(t){if(!t)return s;for(var e=0;e<t.args.length;++e){var i=t.args[e];t.args[e]=0===e?{name:i,lvalue:!0,rvalue:!!t.rvalue,count:t.count||1}:{name:i,lvalue:!1,rvalue:!0,count:1}}return t.thisVars||(t.thisVars=[]),t.localVars||(t.localVars=[]),t}function a(t){for(var e=[],i=0;i<t.args.length;++i)e.push("a"+i);return new Function("P",["return function ",t.funcName,"_ndarrayops(",e.join(","),") {P(",e.join(","),");return a0}"].join(""))(function(t){return n({args:t.args,pre:r(t.pre),body:r(t.body),post:r(t.proc),funcName:t.funcName})}(t))}var o={add:"+",sub:"-",mul:"*",div:"/",mod:"%",band:"&",bor:"|",bxor:"^",lshift:"<<",rshift:">>",rrshift:">>>"};!function(){for(var t in o){var i=o[t];e[t]=a({args:["array","array","array"],body:{args:["a","b","c"],body:"a=b"+i+"c"},funcName:t}),e[t+"eq"]=a({args:["array","array"],body:{args:["a","b"],body:"a"+i+"=b"},rvalue:!0,funcName:t+"eq"}),e[t+"s"]=a({args:["array","array","scalar"],body:{args:["a","b","s"],body:"a=b"+i+"s"},funcName:t+"s"}),e[t+"seq"]=a({args:["array","scalar"],body:{args:["a","s"],body:"a"+i+"=s"},rvalue:!0,funcName:t+"seq"})}}();var h={not:"!",bnot:"~",neg:"-",recip:"1.0/"};!function(){for(var t in h){var i=h[t];e[t]=a({args:["array","array"],body:{args:["a","b"],body:"a="+i+"b"},funcName:t}),e[t+"eq"]=a({args:["array"],body:{args:["a"],body:"a="+i+"a"},rvalue:!0,count:2,funcName:t+"eq"})}}();var l={and:"&&",or:"||",eq:"===",neq:"!==",lt:"<",gt:">",leq:"<=",geq:">="};!function(){for(var t in l){var i=l[t];e[t]=a({args:["array","array","array"],body:{args:["a","b","c"],body:"a=b"+i+"c"},funcName:t}),e[t+"s"]=a({args:["array","array","scalar"],body:{args:["a","b","s"],body:"a=b"+i+"s"},funcName:t+"s"}),e[t+"eq"]=a({args:["array","array"],body:{args:["a","b"],body:"a=a"+i+"b"},rvalue:!0,count:2,funcName:t+"eq"}),e[t+"seq"]=a({args:["array","scalar"],body:{args:["a","s"],body:"a=a"+i+"s"},rvalue:!0,count:2,funcName:t+"seq"})}}();var c=["abs","acos","asin","atan","ceil","cos","exp","floor","log","round","sin","sqrt","tan"];!function(){for(var t=0;t<c.length;++t){var i=c[t];e[i]=a({args:["array","array"],pre:{args:[],body:"this_f=Math."+i,thisVars:["this_f"]},body:{args:["a","b"],body:"a=this_f(b)",thisVars:["this_f"]},funcName:i}),e[i+"eq"]=a({args:["array"],pre:{args:[],body:"this_f=Math."+i,thisVars:["this_f"]},body:{args:["a"],body:"a=this_f(a)",thisVars:["this_f"]},rvalue:!0,count:2,funcName:i+"eq"})}}();var u=["max","min","atan2","pow"];!function(){for(var t=0;t<u.length;++t){var i=u[t];e[i]=a({args:["array","array","array"],pre:{args:[],body:"this_f=Math."+i,thisVars:["this_f"]},body:{args:["a","b","c"],body:"a=this_f(b,c)",thisVars:["this_f"]},funcName:i}),e[i+"s"]=a({args:["array","array","scalar"],pre:{args:[],body:"this_f=Math."+i,thisVars:["this_f"]},body:{args:["a","b","c"],body:"a=this_f(b,c)",thisVars:["this_f"]},funcName:i+"s"}),e[i+"eq"]=a({args:["array","array"],pre:{args:[],body:"this_f=Math."+i,thisVars:["this_f"]},body:{args:["a","b"],body:"a=this_f(a,b)",thisVars:["this_f"]},rvalue:!0,count:2,funcName:i+"eq"}),e[i+"seq"]=a({args:["array","scalar"],pre:{args:[],body:"this_f=Math."+i,thisVars:["this_f"]},body:{args:["a","b"],body:"a=this_f(a,b)",thisVars:["this_f"]},rvalue:!0,count:2,funcName:i+"seq"})}}();var d=["atan2","pow"];!function(){for(var t=0;t<d.length;++t){var i=d[t];e[i+"op"]=a({args:["array","array","array"],pre:{args:[],body:"this_f=Math."+i,thisVars:["this_f"]},body:{args:["a","b","c"],body:"a=this_f(c,b)",thisVars:["this_f"]},funcName:i+"op"}),e[i+"ops"]=a({args:["array","array","scalar"],pre:{args:[],body:"this_f=Math."+i,thisVars:["this_f"]},body:{args:["a","b","c"],body:"a=this_f(c,b)",thisVars:["this_f"]},funcName:i+"ops"}),e[i+"opeq"]=a({args:["array","array"],pre:{args:[],body:"this_f=Math."+i,thisVars:["this_f"]},body:{args:["a","b"],body:"a=this_f(b,a)",thisVars:["this_f"]},rvalue:!0,count:2,funcName:i+"opeq"}),e[i+"opseq"]=a({args:["array","scalar"],pre:{args:[],body:"this_f=Math."+i,thisVars:["this_f"]},body:{args:["a","b"],body:"a=this_f(b,a)",thisVars:["this_f"]},rvalue:!0,count:2,funcName:i+"opseq"})}}(),e.any=n({args:["array"],pre:s,body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:1}],body:"if(a){return true}",localVars:[],thisVars:[]},post:{args:[],localVars:[],thisVars:[],body:"return false"},funcName:"any"}),e.all=n({args:["array"],pre:s,body:{args:[{name:"x",lvalue:!1,rvalue:!0,count:1}],body:"if(!x){return false}",localVars:[],thisVars:[]},post:{args:[],localVars:[],thisVars:[],body:"return true"},funcName:"all"}),e.sum=n({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=0"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:1}],body:"this_s+=a",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return this_s"},funcName:"sum"}),e.prod=n({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=1"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:1}],body:"this_s*=a",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return this_s"},funcName:"prod"}),e.norm2squared=n({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=0"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:2}],body:"this_s+=a*a",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return this_s"},funcName:"norm2squared"}),e.norm2=n({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=0"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:2}],body:"this_s+=a*a",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return Math.sqrt(this_s)"},funcName:"norm2"}),e.norminf=n({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=0"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:4}],body:"if(-a>this_s){this_s=-a}else if(a>this_s){this_s=a}",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return this_s"},funcName:"norminf"}),e.norm1=n({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=0"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:3}],body:"this_s+=a<0?-a:a",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return this_s"},funcName:"norm1"}),e.sup=n({args:["array"],pre:{body:"this_h=-Infinity",args:[],thisVars:["this_h"],localVars:[]},body:{body:"if(_inline_1_arg0_>this_h)this_h=_inline_1_arg0_",args:[{name:"_inline_1_arg0_",lvalue:!1,rvalue:!0,count:2}],thisVars:["this_h"],localVars:[]},post:{body:"return this_h",args:[],thisVars:["this_h"],localVars:[]}}),e.inf=n({args:["array"],pre:{body:"this_h=Infinity",args:[],thisVars:["this_h"],localVars:[]},body:{body:"if(_inline_1_arg0_<this_h)this_h=_inline_1_arg0_",args:[{name:"_inline_1_arg0_",lvalue:!1,rvalue:!0,count:2}],thisVars:["this_h"],localVars:[]},post:{body:"return this_h",args:[],thisVars:["this_h"],localVars:[]}}),e.argmin=n({args:["index","array","shape"],pre:{body:"{this_v=Infinity;this_i=_inline_0_arg2_.slice(0)}",args:[{name:"_inline_0_arg0_",lvalue:!1,rvalue:!1,count:0},{name:"_inline_0_arg1_",lvalue:!1,rvalue:!1,count:0},{name:"_inline_0_arg2_",lvalue:!1,rvalue:!0,count:1}],thisVars:["this_i","this_v"],localVars:[]},body:{body:"{if(_inline_1_arg1_<this_v){this_v=_inline_1_arg1_;for(var _inline_1_k=0;_inline_1_k<_inline_1_arg0_.length;++_inline_1_k){this_i[_inline_1_k]=_inline_1_arg0_[_inline_1_k]}}}",args:[{name:"_inline_1_arg0_",lvalue:!1,rvalue:!0,count:2},{name:"_inline_1_arg1_",lvalue:!1,rvalue:!0,count:2}],thisVars:["this_i","this_v"],localVars:["_inline_1_k"]},post:{body:"{return this_i}",args:[],thisVars:["this_i"],localVars:[]}}),e.argmax=n({args:["index","array","shape"],pre:{body:"{this_v=-Infinity;this_i=_inline_0_arg2_.slice(0)}",args:[{name:"_inline_0_arg0_",lvalue:!1,rvalue:!1,count:0},{name:"_inline_0_arg1_",lvalue:!1,rvalue:!1,count:0},{name:"_inline_0_arg2_",lvalue:!1,rvalue:!0,count:1}],thisVars:["this_i","this_v"],localVars:[]},body:{body:"{if(_inline_1_arg1_>this_v){this_v=_inline_1_arg1_;for(var _inline_1_k=0;_inline_1_k<_inline_1_arg0_.length;++_inline_1_k){this_i[_inline_1_k]=_inline_1_arg0_[_inline_1_k]}}}",args:[{name:"_inline_1_arg0_",lvalue:!1,rvalue:!0,count:2},{name:"_inline_1_arg1_",lvalue:!1,rvalue:!0,count:2}],thisVars:["this_i","this_v"],localVars:["_inline_1_k"]},post:{body:"{return this_i}",args:[],thisVars:["this_i"],localVars:[]}}),e.random=a({args:["array"],pre:{args:[],body:"this_f=Math.random",thisVars:["this_f"]},body:{args:["a"],body:"a=this_f()",thisVars:["this_f"]},funcName:"random"}),e.assign=a({args:["array","array"],body:{args:["a","b"],body:"a=b"},funcName:"assign"}),e.assigns=a({args:["array","scalar"],body:{args:["a","b"],body:"a=b"},funcName:"assigns"}),e.equals=n({args:["array","array"],pre:s,body:{args:[{name:"x",lvalue:!1,rvalue:!0,count:1},{name:"y",lvalue:!1,rvalue:!0,count:1}],body:"if(x!==y){return false}",localVars:[],thisVars:[]},post:{args:[],localVars:[],thisVars:[],body:"return true"},funcName:"equals"})},448:(t,e,i)=>{var n=i(772),s=i(460),r="undefined"!=typeof Float64Array;function a(t,e){return t[0]-e[0]}function o(){var t,e=this.stride,i=new Array(e.length);for(t=0;t<i.length;++t)i[t]=[Math.abs(e[t]),t];i.sort(a);var n=new Array(i.length);for(t=0;t<n.length;++t)n[t]=i[t][1];return n}function h(t,e){var i=["View",e,"d",t].join("");e<0&&(i="View_Nil"+t);var s="generic"===t;if(-1===e){var r="function "+i+"(a){this.data=a;};var proto="+i+".prototype;proto.dtype='"+t+"';proto.index=function(){return -1};proto.size=0;proto.dimension=-1;proto.shape=proto.stride=proto.order=[];proto.lo=proto.hi=proto.transpose=proto.step=function(){return new "+i+"(this.data);};proto.get=proto.set=function(){};proto.pick=function(){return null};return function construct_"+i+"(a){return new "+i+"(a);}";return new Function(r)()}if(0===e){r="function "+i+"(a,d) {this.data = a;this.offset = d};var proto="+i+".prototype;proto.dtype='"+t+"';proto.index=function(){return this.offset};proto.dimension=0;proto.size=1;proto.shape=proto.stride=proto.order=[];proto.lo=proto.hi=proto.transpose=proto.step=function "+i+"_copy() {return new "+i+"(this.data,this.offset)};proto.pick=function "+i+"_pick(){return TrivialArray(this.data);};proto.valueOf=proto.get=function "+i+"_get(){return "+(s?"this.data.get(this.offset)":"this.data[this.offset]")+"};proto.set=function "+i+"_set(v){return "+(s?"this.data.set(this.offset,v)":"this.data[this.offset]=v")+"};return function construct_"+i+"(a,b,c,d){return new "+i+"(a,d)}";return new Function("TrivialArray",r)(l[t][0])}r=["'use strict'"];var a=n(e),h=a.map((function(t){return"i"+t})),c="this.offset+"+a.map((function(t){return"this.stride["+t+"]*i"+t})).join("+"),u=a.map((function(t){return"b"+t})).join(","),d=a.map((function(t){return"c"+t})).join(",");r.push("function "+i+"(a,"+u+","+d+",d){this.data=a","this.shape=["+u+"]","this.stride=["+d+"]","this.offset=d|0}","var proto="+i+".prototype","proto.dtype='"+t+"'","proto.dimension="+e),r.push("Object.defineProperty(proto,'size',{get:function "+i+"_size(){return "+a.map((function(t){return"this.shape["+t+"]"})).join("*"),"}})"),1===e?r.push("proto.order=[0]"):(r.push("Object.defineProperty(proto,'order',{get:"),e<4?(r.push("function "+i+"_order(){"),2===e?r.push("return (Math.abs(this.stride[0])>Math.abs(this.stride[1]))?[1,0]:[0,1]}})"):3===e&&r.push("var s0=Math.abs(this.stride[0]),s1=Math.abs(this.stride[1]),s2=Math.abs(this.stride[2]);if(s0>s1){if(s1>s2){return [2,1,0];}else if(s0>s2){return [1,2,0];}else{return [1,0,2];}}else if(s0>s2){return [2,0,1];}else if(s2>s1){return [0,1,2];}else{return [0,2,1];}}})")):r.push("ORDER})")),r.push("proto.set=function "+i+"_set("+h.join(",")+",v){"),s?r.push("return this.data.set("+c+",v)}"):r.push("return this.data["+c+"]=v}"),r.push("proto.get=function "+i+"_get("+h.join(",")+"){"),s?r.push("return this.data.get("+c+")}"):r.push("return this.data["+c+"]}"),r.push("proto.index=function "+i+"_index(",h.join(),"){return "+c+"}"),r.push("proto.hi=function "+i+"_hi("+h.join(",")+"){return new "+i+"(this.data,"+a.map((function(t){return["(typeof i",t,"!=='number'||i",t,"<0)?this.shape[",t,"]:i",t,"|0"].join("")})).join(",")+","+a.map((function(t){return"this.stride["+t+"]"})).join(",")+",this.offset)}");var p=a.map((function(t){return"a"+t+"=this.shape["+t+"]"})),m=a.map((function(t){return"c"+t+"=this.stride["+t+"]"}));r.push("proto.lo=function "+i+"_lo("+h.join(",")+"){var b=this.offset,d=0,"+p.join(",")+","+m.join(","));for(var f=0;f<e;++f)r.push("if(typeof i"+f+"==='number'&&i"+f+">=0){d=i"+f+"|0;b+=c"+f+"*d;a"+f+"-=d}");r.push("return new "+i+"(this.data,"+a.map((function(t){return"a"+t})).join(",")+","+a.map((function(t){return"c"+t})).join(",")+",b)}"),r.push("proto.step=function "+i+"_step("+h.join(",")+"){var "+a.map((function(t){return"a"+t+"=this.shape["+t+"]"})).join(",")+","+a.map((function(t){return"b"+t+"=this.stride["+t+"]"})).join(",")+",c=this.offset,d=0,ceil=Math.ceil");for(f=0;f<e;++f)r.push("if(typeof i"+f+"==='number'){d=i"+f+"|0;if(d<0){c+=b"+f+"*(a"+f+"-1);a"+f+"=ceil(-a"+f+"/d)}else{a"+f+"=ceil(a"+f+"/d)}b"+f+"*=d}");r.push("return new "+i+"(this.data,"+a.map((function(t){return"a"+t})).join(",")+","+a.map((function(t){return"b"+t})).join(",")+",c)}");var g=new Array(e),v=new Array(e);for(f=0;f<e;++f)g[f]="a[i"+f+"]",v[f]="b[i"+f+"]";r.push("proto.transpose=function "+i+"_transpose("+h+"){"+h.map((function(t,e){return t+"=("+t+"===undefined?"+e+":"+t+"|0)"})).join(";"),"var a=this.shape,b=this.stride;return new "+i+"(this.data,"+g.join(",")+","+v.join(",")+",this.offset)}"),r.push("proto.pick=function "+i+"_pick("+h+"){var a=[],b=[],c=this.offset");for(f=0;f<e;++f)r.push("if(typeof i"+f+"==='number'&&i"+f+">=0){c=(c+this.stride["+f+"]*i"+f+")|0}else{a.push(this.shape["+f+"]);b.push(this.stride["+f+"])}");return r.push("var ctor=CTOR_LIST[a.length+1];return ctor(this.data,a,b,c)}"),r.push("return function construct_"+i+"(data,shape,stride,offset){return new "+i+"(data,"+a.map((function(t){return"shape["+t+"]"})).join(",")+","+a.map((function(t){return"stride["+t+"]"})).join(",")+",offset)}"),new Function("CTOR_LIST","ORDER",r.join("\n"))(l[t],o)}var l={float32:[],float64:[],int8:[],int16:[],int32:[],uint8:[],uint16:[],uint32:[],array:[],uint8_clamped:[],bigint64:[],biguint64:[],buffer:[],generic:[]};t.exports=function(t,e,i,n){if(void 0===t)return(0,l.array[0])([]);"number"==typeof t&&(t=[t]),void 0===e&&(e=[t.length]);var a=e.length;if(void 0===i){i=new Array(a);for(var o=a-1,c=1;o>=0;--o)i[o]=c,c*=e[o]}if(void 0===n){n=0;for(o=0;o<a;++o)i[o]<0&&(n-=(e[o]-1)*i[o])}for(var u=function(t){if(s(t))return"buffer";if(r)switch(Object.prototype.toString.call(t)){case"[object Float64Array]":return"float64";case"[object Float32Array]":return"float32";case"[object Int8Array]":return"int8";case"[object Int16Array]":return"int16";case"[object Int32Array]":return"int32";case"[object Uint8Array]":return"uint8";case"[object Uint16Array]":return"uint16";case"[object Uint32Array]":return"uint32";case"[object Uint8ClampedArray]":return"uint8_clamped";case"[object BigInt64Array]":return"bigint64";case"[object BigUint64Array]":return"biguint64"}return Array.isArray(t)?"array":"generic"}(t),d=l[u];d.length<=a+1;)d.push(h(u,d.length-1));return(0,d[a+1])(t,e,i,n)}},49:function(t){t.exports=function(){var t=function(){function e(t){return s.appendChild(t.dom),t}function i(t){for(var e=0;e<s.children.length;e++)s.children[e].style.display=e===t?"block":"none";n=t}var n=0,s=document.createElement("div");s.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",s.addEventListener("click",(function(t){t.preventDefault(),i(++n%s.children.length)}),!1);var r=(performance||Date).now(),a=r,o=0,h=e(new t.Panel("FPS","#0ff","#002")),l=e(new t.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var c=e(new t.Panel("MB","#f08","#201"));return i(0),{REVISION:16,dom:s,addPanel:e,showPanel:i,begin:function(){r=(performance||Date).now()},end:function(){o++;var t=(performance||Date).now();if(l.update(t-r,200),t>a+1e3&&(h.update(1e3*o/(t-a),100),a=t,o=0,c)){var e=performance.memory;c.update(e.usedJSHeapSize/1048576,e.jsHeapSizeLimit/1048576)}return t},update:function(){r=this.end()},domElement:s,setMode:i}};return t.Panel=function(t,e,i){var n=1/0,s=0,r=Math.round,a=r(window.devicePixelRatio||1),o=80*a,h=48*a,l=3*a,c=2*a,u=3*a,d=15*a,p=74*a,m=30*a,f=document.createElement("canvas");f.width=o,f.height=h,f.style.cssText="width:80px;height:48px";var g=f.getContext("2d");return g.font="bold "+9*a+"px Helvetica,Arial,sans-serif",g.textBaseline="top",g.fillStyle=i,g.fillRect(0,0,o,h),g.fillStyle=e,g.fillText(t,l,c),g.fillRect(u,d,p,m),g.fillStyle=i,g.globalAlpha=.9,g.fillRect(u,d,p,m),{dom:f,update:function(h,v){n=Math.min(n,h),s=Math.max(s,h),g.fillStyle=i,g.globalAlpha=1,g.fillRect(0,0,o,d),g.fillStyle=e,g.fillText(r(h)+" "+t+" ("+r(n)+"-"+r(s)+")",l,c),g.drawImage(f,u+a,d,p-a,m,u,d,p-a,m),g.fillRect(u+p-a,d,a,m),g.fillStyle=i,g.globalAlpha=.9,g.fillRect(u+p-a,d,a,r((1-h/v)*m))}}},t}()},584:t=>{"use strict";t.exports=function(t,e,i){return 0===t.length?t:e?(i||t.sort(e),function(t,e){for(var i=1,n=t.length,s=t[0],r=t[0],a=1;a<n;++a)if(r=s,e(s=t[a],r)){if(a===i){i++;continue}t[i++]=s}return t.length=i,t}(t,e)):(i||t.sort(),function(t){for(var e=1,i=t.length,n=t[0],s=t[0],r=1;r<i;++r,s=n)if(s=n,(n=t[r])!==s){if(r===e){e++;continue}t[e++]=n}return t.length=e,t}(t))}}},r={};function a(t){var e=r[t];if(void 0!==e)return e.exports;var i=r[t]={exports:{}};return s[t].call(i.exports,i,i.exports,a),i.exports}a.m=s,a.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return a.d(e,{a:e}),e},e=Object.getPrototypeOf?t=>Object.getPrototypeOf(t):t=>t.__proto__,a.t=function(i,n){if(1&n&&(i=this(i)),8&n)return i;if("object"==typeof i&&i){if(4&n&&i.__esModule)return i;if(16&n&&"function"==typeof i.then)return i}var s=Object.create(null);a.r(s);var r={};t=t||[null,e({}),e([]),e(e)];for(var o=2&n&&i;"object"==typeof o&&!~t.indexOf(o);o=e(o))Object.getOwnPropertyNames(o).forEach((t=>r[t]=()=>i[t]));return r.default=()=>i,a.d(s,r),s},a.d=(t,e)=>{for(var i in e)a.o(e,i)&&!a.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},a.f={},a.e=t=>Promise.all(Object.keys(a.f).reduce(((e,i)=>(a.f[i](t,e),e)),[])),a.u=t=>t+".bundle.js",a.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),a.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),i={},n="hons:",a.l=(t,e,s,r)=>{if(i[t])i[t].push(e);else{var o,h;if(void 0!==s)for(var l=document.getElementsByTagName("script"),c=0;c<l.length;c++){var u=l[c];if(u.getAttribute("src")==t||u.getAttribute("data-webpack")==n+s){o=u;break}}o||(h=!0,(o=document.createElement("script")).charset="utf-8",o.timeout=120,a.nc&&o.setAttribute("nonce",a.nc),o.setAttribute("data-webpack",n+s),o.src=t),i[t]=[e];var d=(e,n)=>{o.onerror=o.onload=null,clearTimeout(p);var s=i[t];if(delete i[t],o.parentNode&&o.parentNode.removeChild(o),s&&s.forEach((t=>t(n))),e)return e(n)},p=setTimeout(d.bind(null,void 0,{type:"timeout",target:o}),12e4);o.onerror=d.bind(null,o.onerror),o.onload=d.bind(null,o.onload),h&&document.head.appendChild(o)}},a.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},(()=>{var t;a.g.importScripts&&(t=a.g.location+"");var e=a.g.document;if(!t&&e&&(e.currentScript&&(t=e.currentScript.src),!t)){var i=e.getElementsByTagName("script");if(i.length)for(var n=i.length-1;n>-1&&!t;)t=i[n--].src}if(!t)throw new Error("Automatic publicPath is not supported in this browser");t=t.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),a.p=t})(),(()=>{var t={179:0};a.f.j=(e,i)=>{var n=a.o(t,e)?t[e]:void 0;if(0!==n)if(n)i.push(n[2]);else{var s=new Promise(((i,s)=>n=t[e]=[i,s]));i.push(n[2]=s);var r=a.p+a.u(e),o=new Error;a.l(r,(i=>{if(a.o(t,e)&&(0!==(n=t[e])&&(t[e]=void 0),n)){var s=i&&("load"===i.type?"missing":i.type),r=i&&i.target&&i.target.src;o.message="Loading chunk "+e+" failed.\n("+s+": "+r+")",o.name="ChunkLoadError",o.type=s,o.request=r,n[1](o)}}),"chunk-"+e,e)}};var e=(e,i)=>{var n,s,[r,o,h]=i,l=0;if(r.some((e=>0!==t[e]))){for(n in o)a.o(o,n)&&(a.m[n]=o[n]);if(h)h(a)}for(e&&e(i);l<r.length;l++)s=r[l],a.o(t,s)&&t[s]&&t[s][0](),t[s]=0},i=self.webpackChunkhons=self.webpackChunkhons||[];i.forEach(e.bind(null,0)),i.push=e.bind(null,i.push.bind(i))})(),(()=>{"use strict";const t="8Dia+AvRXD44FD7tbWIqesVIiQKZ7f11+vQUXG5FH48=",e="r2e4a6XJ50SaoZcqZf4iXK9t5AqPvlUHynDONQUOkLY=",i="GInp96yk5yW/RSY8c0dVH1+uaA/e8YlL4/WJXpTFWBQ=",n="bzMGsbUxMD5yg5V3Z7FFLTUm/jHnAgOkNMA7kje/jQo=",s=i,r=n,o=r,h="ztY04MiyZPHrhKract3zXWv3xjIQ69X+F75gDqlRxAU=",l=h,c="ruxUKmdYSA1fcf0/MtjjjvfcC2kXGSSyodhln57wKWQ=";var u=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class d{constructor(){this.hons=new Map,this.citizeninfo=new Map,this.cityinfo=new Map,this.profiles=new Map,this.models=new Map,this.honviews=new Map,this.invens=new Map}SaveHonView(t,e){this.honviews.set(t,e)}LoadHonView(t){return this.honviews.get(t)}FetchInventory(t,e){const i=this.invens.get(e);if(null!=i)return Promise.resolve(i);const s=t+"/glambda?txid="+encodeURIComponent(n)+"&table=inventory&key="+e;return fetch(s).then((t=>t.json())).then((t=>{if("data"in t){return JSON.parse(t.data)}}))}UpdateInventory(t,e){this.invens.set(e,t)}GetInventory(t){return this.invens.get(t)}UpdateModels(t,e){this.models.set(e,t)}GetModel(t){return this.models.get(t)}FetchModels(t){const e=t+"/glambda?txid="+encodeURIComponent(i)+"&table=meta&start=0&count=20",n=new Map;return fetch(e).then((t=>t.json())).then((t=>{if("json"in t){return JSON.parse(t.json)}throw""})).then((e=>u(this,void 0,void 0,(function*(){const i=e.map((e=>u(this,void 0,void 0,(function*(){yield this.FetchModel(t,atob(e)).then((t=>{n.set(t.id,t.models)}))}))));return Promise.all(i)})))).then((()=>n)).catch((()=>n))}FetchModel(t,e){const i=this.models.get(e);if(null!=i)return Promise.resolve(i);const s=t+"/glambda?txid="+encodeURIComponent(n)+"&table=meta&key="+e;return fetch(s).then((t=>t.json())).then((t=>(this.models.set(e,t),t)))}FetchCitizenList(t,e){const n=t+"/glambda?txid="+encodeURIComponent(i)+"&table=citizen_"+e+"&start=0&count=20",s=[];return fetch(n).then((t=>t.json())).then((t=>{if("json"in t){return JSON.parse(t.json)}throw""})).then((e=>u(this,void 0,void 0,(function*(){const i=e.map((e=>{const i=atob(e);this.FetchModel(t,i),s.push(i)}));return Promise.all(i)})))).then((()=>s)).catch((()=>s))}FetchCitizen(t,e,i){const s=this.citizeninfo.get(i);if(null!=s)return Promise.resolve(s);const r=t+"/glambda?txid="+encodeURIComponent(n)+"&table=citizen_"+e+"&key="+i;return fetch(r).then((t=>t.json())).then((t=>(this.citizeninfo.set(i,t),t)))}FetchCity(t,e){const i=this.cityinfo.get(e);if(null!=i)return Promise.resolve(i);const s=t+"/glambda?txid="+encodeURIComponent(n)+"&table=city&key="+e;return fetch(s).then((t=>t.json())).then((t=>(this.cityinfo.set(e,t),t)))}FetchHon(t,e){const i=this.hons.get(e);if(null!=i)return Promise.resolve(i);const n=t+"/glambda?txid="+encodeURIComponent(r)+"&table=feeds&key="+e;return fetch(n).then((t=>t.json())).then((t=>(this.hons.set(e,t),t)))}FetchProfile(t,e){const i=this.profiles.get(e);if(null!=i)return Promise.resolve(i);const n=t+"/glambda?txid="+encodeURIComponent(r)+"&table=profile&key="+e;return fetch(n).then((t=>t.json())).then((t=>(this.profiles.set(e,t),t)))}}class p{constructor(){this.m_opend=!1,this.m_handler={}}OpenChannel(t){const e=new WebSocket(t);e.onopen=()=>{this.m_opend=!0,e.onmessage=t=>{const e=JSON.parse(t.data);e.types,this.m_handler[e.types](e.params)}},e.onclose=()=>{this.m_opend=!1,this.m_handler.close()},this.m_ws=e}IsOpen(){return this.m_opend}RegisterMsgHandler(t,e){this.m_handler[t]=t=>{e(t)}}SendMsg(t,...e){var i;const n={types:t,params:[...e]};null===(i=this.m_ws)||void 0===i||i.send(JSON.stringify(n))}}var m=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};const f=(t,e,i)=>m(void 0,void 0,void 0,(function*(){let n="";yield t.FetchProfile(window.MasterAddr,e.email).then((t=>m(void 0,void 0,void 0,(function*(){""!=t.file&&"file"in t?yield fetch("data:image/jpg;base64,"+t.file).then((t=>t.blob())).then((t=>{n=URL.createObjectURL(t)})):n="static/img/ghost_background_black.png"}))));let s="";void 0!==e.file&&""!=e.file&&(yield fetch("data:image/jpg;base64,"+e.file).then((t=>t.blob())).then((t=>{s=URL.createObjectURL(t),s='<span class="m-1"> <img src="'+s+'" class="rounded img-fluid w-100"> </span> '})));const r=yield g(i),a=e.tag;try{e.tag=decodeURIComponent(atob(e.tag))}catch(t){e.tag=""}const o=null==e.tag||""==e.tag?"":`\n        <div class="row">\n        <div class="col">\n            <span class='badge bg-primary' onclick="ClickLoadPage('hons', false, '&tag=${a}')">${e.tag}</span>\n        </div>\n        </div>`;return`\n<div class="container p-2 border-bottom container-honview">\n    <div class="row p-0 handcursor">\n        <div class="col-auto text-center pe-0">\n                    <a href="javascript:void(0)" onclick="ClickLoadPage('hondetail', false, '&email=${e.email}')">\n                    <span class="m-1">\n                    <img class="profile-sm" src="${n}"></span>\n                    </a>\n        </div>\n        <div class="col m-0 p-0">\n            <div class="container ps-1">\n                <div class="row">\n                <div class="col-auto pe-0">\n                    <a href="javascript:void(0)" onclick="ClickLoadPage('hondetail', false, '&email=${e.email}')">\n                    <strong class="me-auto">${e.id}</strong>\n                    </a>\n                    </div>\n                <div class="col ps-1" onclick="ClickLoadPage('hon', false, '&key=${i}')">\n                    <small>@${e.email}  ${function(t){const e=new Date(t),i=((new Date).getTime()-e.getTime())/1e3;if(isNaN(i))return"";const n=[{name:"years",milliSeconds:31536e3},{name:"months",milliSeconds:2592e3},{name:"days",milliSeconds:86400},{name:"hrs",milliSeconds:3600},{name:"mins",milliSeconds:60}];for(const t of n){const e=Math.floor(i/t.milliSeconds);if(e>0)return`${e} ${t.name} ago`}return"now"}(Number(e.time))}</small>\n                    </div>\n                </div>\n                <div class="row" onclick="ClickLoadPage('hon', false, '&key=${i}')">\n                    <pre class="hon-contents m-0" style="font-size:medium;">${e.content}</pre>\n                </div>\n                <div class="row" onclick="ClickLoadPage('hon', false, '&key=${i}')">\n                    ${s}\n                </div>\n                ${o}\n                <div class="row" onclick="ClickLoadPage('hon', false, '&key=${i}')">\n                    <div class="col-auto pe-0">\n                    <span class="material-symbols-outlined" style="font-size:14px;">\n                        chat_bubble\n                    </span>\n                    </div>\n                    <div class="col ps-1">\n                    <small>${r}</small>\n                    </div>\n                </div>\n            </div>\n        </div>\n    </div>\n</div>\n        `})),g=t=>{const e=`\n        ${window.MasterAddr}/glambda?txid=${encodeURIComponent(h)}&table=replylink&key=${t}`;return fetch(e).then((t=>t.json())).then((t=>t.result.constructor==Array?t.result.length:""))};var v=a(990);const y="160",x=0,b=1,_=2,w=0,M=1,S=2,E=3,T=1,A=2,C=3,I=0,R=1,k=100,P=0,D=1,L=2,O=0,N=1,B=2,z=3,U=4,F=5,G=6,V="attached",H=301,j=302,W=303,X=304,q=306,Y=1e3,J=1001,$=1002,K=1003,Z=1004,Q=1005,tt=1006,et=1007,it=1008,nt=1009,st=1012,rt=1013,at=1014,ot=1015,ht=1016,lt=1020,ct=1023,ut=1026,dt=1027,pt=33776,mt=33777,ft=33778,gt=33779,vt=36492,yt=2200,xt=2201,bt=2300,_t=2301,wt=2302,Mt=2400,St=2401,Et=2402,Tt=2500,At=3001,Ct="",It="srgb",Rt="srgb-linear",kt="display-p3",Pt="display-p3-linear",Dt="linear",Lt="srgb",Ot="rec709",Nt="p3",Bt=7680,zt=35044,Ut=35048,Ft="300 es",Gt=1035,Vt=2e3,Ht=2001;class jt{addEventListener(t,e){void 0===this._listeners&&(this._listeners={});const i=this._listeners;void 0===i[t]&&(i[t]=[]),-1===i[t].indexOf(e)&&i[t].push(e)}hasEventListener(t,e){if(void 0===this._listeners)return!1;const i=this._listeners;return void 0!==i[t]&&-1!==i[t].indexOf(e)}removeEventListener(t,e){if(void 0===this._listeners)return;const i=this._listeners[t];if(void 0!==i){const t=i.indexOf(e);-1!==t&&i.splice(t,1)}}dispatchEvent(t){if(void 0===this._listeners)return;const e=this._listeners[t.type];if(void 0!==e){t.target=this;const i=e.slice(0);for(let e=0,n=i.length;e<n;e++)i[e].call(this,t);t.target=null}}}const Wt=["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"];let Xt=1234567;const qt=Math.PI/180,Yt=180/Math.PI;function Jt(){const t=4294967295*Math.random()|0,e=4294967295*Math.random()|0,i=4294967295*Math.random()|0,n=4294967295*Math.random()|0;return(Wt[255&t]+Wt[t>>8&255]+Wt[t>>16&255]+Wt[t>>24&255]+"-"+Wt[255&e]+Wt[e>>8&255]+"-"+Wt[e>>16&15|64]+Wt[e>>24&255]+"-"+Wt[63&i|128]+Wt[i>>8&255]+"-"+Wt[i>>16&255]+Wt[i>>24&255]+Wt[255&n]+Wt[n>>8&255]+Wt[n>>16&255]+Wt[n>>24&255]).toLowerCase()}function $t(t,e,i){return Math.max(e,Math.min(i,t))}function Kt(t,e){return(t%e+e)%e}function Zt(t,e,i){return(1-i)*t+i*e}function Qt(t){return 0==(t&t-1)&&0!==t}function te(t){return Math.pow(2,Math.floor(Math.log(t)/Math.LN2))}function ee(t,e){switch(e.constructor){case Float32Array:return t;case Uint32Array:return t/4294967295;case Uint16Array:return t/65535;case Uint8Array:return t/255;case Int32Array:return Math.max(t/2147483647,-1);case Int16Array:return Math.max(t/32767,-1);case Int8Array:return Math.max(t/127,-1);default:throw new Error("Invalid component type.")}}function ie(t,e){switch(e.constructor){case Float32Array:return t;case Uint32Array:return Math.round(4294967295*t);case Uint16Array:return Math.round(65535*t);case Uint8Array:return Math.round(255*t);case Int32Array:return Math.round(2147483647*t);case Int16Array:return Math.round(32767*t);case Int8Array:return Math.round(127*t);default:throw new Error("Invalid component type.")}}const ne={DEG2RAD:qt,RAD2DEG:Yt,generateUUID:Jt,clamp:$t,euclideanModulo:Kt,mapLinear:function(t,e,i,n,s){return n+(t-e)*(s-n)/(i-e)},inverseLerp:function(t,e,i){return t!==e?(i-t)/(e-t):0},lerp:Zt,damp:function(t,e,i,n){return Zt(t,e,1-Math.exp(-i*n))},pingpong:function(t,e=1){return e-Math.abs(Kt(t,2*e)-e)},smoothstep:function(t,e,i){return t<=e?0:t>=i?1:(t=(t-e)/(i-e))*t*(3-2*t)},smootherstep:function(t,e,i){return t<=e?0:t>=i?1:(t=(t-e)/(i-e))*t*t*(t*(6*t-15)+10)},randInt:function(t,e){return t+Math.floor(Math.random()*(e-t+1))},randFloat:function(t,e){return t+Math.random()*(e-t)},randFloatSpread:function(t){return t*(.5-Math.random())},seededRandom:function(t){void 0!==t&&(Xt=t);let e=Xt+=1831565813;return e=Math.imul(e^e>>>15,1|e),e^=e+Math.imul(e^e>>>7,61|e),((e^e>>>14)>>>0)/4294967296},degToRad:function(t){return t*qt},radToDeg:function(t){return t*Yt},isPowerOfTwo:Qt,ceilPowerOfTwo:function(t){return Math.pow(2,Math.ceil(Math.log(t)/Math.LN2))},floorPowerOfTwo:te,setQuaternionFromProperEuler:function(t,e,i,n,s){const r=Math.cos,a=Math.sin,o=r(i/2),h=a(i/2),l=r((e+n)/2),c=a((e+n)/2),u=r((e-n)/2),d=a((e-n)/2),p=r((n-e)/2),m=a((n-e)/2);switch(s){case"XYX":t.set(o*c,h*u,h*d,o*l);break;case"YZY":t.set(h*d,o*c,h*u,o*l);break;case"ZXZ":t.set(h*u,h*d,o*c,o*l);break;case"XZX":t.set(o*c,h*m,h*p,o*l);break;case"YXY":t.set(h*p,o*c,h*m,o*l);break;case"ZYZ":t.set(h*m,h*p,o*c,o*l)}},normalize:ie,denormalize:ee};class se{constructor(t=0,e=0){se.prototype.isVector2=!0,this.x=t,this.y=e}get width(){return this.x}set width(t){this.x=t}get height(){return this.y}set height(t){this.y=t}set(t,e){return this.x=t,this.y=e,this}setScalar(t){return this.x=t,this.y=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y)}copy(t){return this.x=t.x,this.y=t.y,this}add(t){return this.x+=t.x,this.y+=t.y,this}addScalar(t){return this.x+=t,this.y+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this}subScalar(t){return this.x-=t,this.y-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this}multiply(t){return this.x*=t.x,this.y*=t.y,this}multiplyScalar(t){return this.x*=t,this.y*=t,this}divide(t){return this.x/=t.x,this.y/=t.y,this}divideScalar(t){return this.multiplyScalar(1/t)}applyMatrix3(t){const e=this.x,i=this.y,n=t.elements;return this.x=n[0]*e+n[3]*i+n[6],this.y=n[1]*e+n[4]*i+n[7],this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this}clampScalar(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this}clampLength(t,e){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(t,Math.min(e,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}angleTo(t){const e=Math.sqrt(this.lengthSq()*t.lengthSq());if(0===e)return Math.PI/2;const i=this.dot(t)/e;return Math.acos($t(i,-1,1))}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,i=this.y-t.y;return e*e+i*i}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this}lerpVectors(t,e,i){return this.x=t.x+(e.x-t.x)*i,this.y=t.y+(e.y-t.y)*i,this}equals(t){return t.x===this.x&&t.y===this.y}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t}fromBufferAttribute(t,e){return this.x=t.getX(e),this.y=t.getY(e),this}rotateAround(t,e){const i=Math.cos(e),n=Math.sin(e),s=this.x-t.x,r=this.y-t.y;return this.x=s*i-r*n+t.x,this.y=s*n+r*i+t.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}}class re{constructor(t,e,i,n,s,r,a,o,h){re.prototype.isMatrix3=!0,this.elements=[1,0,0,0,1,0,0,0,1],void 0!==t&&this.set(t,e,i,n,s,r,a,o,h)}set(t,e,i,n,s,r,a,o,h){const l=this.elements;return l[0]=t,l[1]=n,l[2]=a,l[3]=e,l[4]=s,l[5]=o,l[6]=i,l[7]=r,l[8]=h,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(t){const e=this.elements,i=t.elements;return e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5],e[6]=i[6],e[7]=i[7],e[8]=i[8],this}extractBasis(t,e,i){return t.setFromMatrix3Column(this,0),e.setFromMatrix3Column(this,1),i.setFromMatrix3Column(this,2),this}setFromMatrix4(t){const e=t.elements;return this.set(e[0],e[4],e[8],e[1],e[5],e[9],e[2],e[6],e[10]),this}multiply(t){return this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const i=t.elements,n=e.elements,s=this.elements,r=i[0],a=i[3],o=i[6],h=i[1],l=i[4],c=i[7],u=i[2],d=i[5],p=i[8],m=n[0],f=n[3],g=n[6],v=n[1],y=n[4],x=n[7],b=n[2],_=n[5],w=n[8];return s[0]=r*m+a*v+o*b,s[3]=r*f+a*y+o*_,s[6]=r*g+a*x+o*w,s[1]=h*m+l*v+c*b,s[4]=h*f+l*y+c*_,s[7]=h*g+l*x+c*w,s[2]=u*m+d*v+p*b,s[5]=u*f+d*y+p*_,s[8]=u*g+d*x+p*w,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[3]*=t,e[6]*=t,e[1]*=t,e[4]*=t,e[7]*=t,e[2]*=t,e[5]*=t,e[8]*=t,this}determinant(){const t=this.elements,e=t[0],i=t[1],n=t[2],s=t[3],r=t[4],a=t[5],o=t[6],h=t[7],l=t[8];return e*r*l-e*a*h-i*s*l+i*a*o+n*s*h-n*r*o}invert(){const t=this.elements,e=t[0],i=t[1],n=t[2],s=t[3],r=t[4],a=t[5],o=t[6],h=t[7],l=t[8],c=l*r-a*h,u=a*o-l*s,d=h*s-r*o,p=e*c+i*u+n*d;if(0===p)return this.set(0,0,0,0,0,0,0,0,0);const m=1/p;return t[0]=c*m,t[1]=(n*h-l*i)*m,t[2]=(a*i-n*r)*m,t[3]=u*m,t[4]=(l*e-n*o)*m,t[5]=(n*s-a*e)*m,t[6]=d*m,t[7]=(i*o-h*e)*m,t[8]=(r*e-i*s)*m,this}transpose(){let t;const e=this.elements;return t=e[1],e[1]=e[3],e[3]=t,t=e[2],e[2]=e[6],e[6]=t,t=e[5],e[5]=e[7],e[7]=t,this}getNormalMatrix(t){return this.setFromMatrix4(t).invert().transpose()}transposeIntoArray(t){const e=this.elements;return t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8],this}setUvTransform(t,e,i,n,s,r,a){const o=Math.cos(s),h=Math.sin(s);return this.set(i*o,i*h,-i*(o*r+h*a)+r+t,-n*h,n*o,-n*(-h*r+o*a)+a+e,0,0,1),this}scale(t,e){return this.premultiply(ae.makeScale(t,e)),this}rotate(t){return this.premultiply(ae.makeRotation(-t)),this}translate(t,e){return this.premultiply(ae.makeTranslation(t,e)),this}makeTranslation(t,e){return t.isVector2?this.set(1,0,t.x,0,1,t.y,0,0,1):this.set(1,0,t,0,1,e,0,0,1),this}makeRotation(t){const e=Math.cos(t),i=Math.sin(t);return this.set(e,-i,0,i,e,0,0,0,1),this}makeScale(t,e){return this.set(t,0,0,0,e,0,0,0,1),this}equals(t){const e=this.elements,i=t.elements;for(let t=0;t<9;t++)if(e[t]!==i[t])return!1;return!0}fromArray(t,e=0){for(let i=0;i<9;i++)this.elements[i]=t[i+e];return this}toArray(t=[],e=0){const i=this.elements;return t[e]=i[0],t[e+1]=i[1],t[e+2]=i[2],t[e+3]=i[3],t[e+4]=i[4],t[e+5]=i[5],t[e+6]=i[6],t[e+7]=i[7],t[e+8]=i[8],t}clone(){return(new this.constructor).fromArray(this.elements)}}const ae=new re;function oe(t){for(let e=t.length-1;e>=0;--e)if(t[e]>=65535)return!0;return!1}const he={Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array};function le(t,e){return new he[t](e)}function ce(t){return document.createElementNS("http://www.w3.org/1999/xhtml",t)}function ue(){const t=ce("canvas");return t.style.display="block",t}const de={};function pe(t){t in de||(de[t]=!0)}const me=(new re).set(.8224621,.177538,0,.0331941,.9668058,0,.0170827,.0723974,.9105199),fe=(new re).set(1.2249401,-.2249404,0,-.0420569,1.0420571,0,-.0196376,-.0786361,1.0982735),ge={[Rt]:{transfer:Dt,primaries:Ot,toReference:t=>t,fromReference:t=>t},[It]:{transfer:Lt,primaries:Ot,toReference:t=>t.convertSRGBToLinear(),fromReference:t=>t.convertLinearToSRGB()},[Pt]:{transfer:Dt,primaries:Nt,toReference:t=>t.applyMatrix3(fe),fromReference:t=>t.applyMatrix3(me)},[kt]:{transfer:Lt,primaries:Nt,toReference:t=>t.convertSRGBToLinear().applyMatrix3(fe),fromReference:t=>t.applyMatrix3(me).convertLinearToSRGB()}},ve=new Set([Rt,Pt]),ye={enabled:!0,_workingColorSpace:Rt,get workingColorSpace(){return this._workingColorSpace},set workingColorSpace(t){if(!ve.has(t))throw new Error(`Unsupported working color space, "${t}".`);this._workingColorSpace=t},convert:function(t,e,i){if(!1===this.enabled||e===i||!e||!i)return t;const n=ge[e].toReference;return(0,ge[i].fromReference)(n(t))},fromWorkingColorSpace:function(t,e){return this.convert(t,this._workingColorSpace,e)},toWorkingColorSpace:function(t,e){return this.convert(t,e,this._workingColorSpace)},getPrimaries:function(t){return ge[t].primaries},getTransfer:function(t){return t===Ct?Dt:ge[t].transfer}};function xe(t){return t<.04045?.0773993808*t:Math.pow(.9478672986*t+.0521327014,2.4)}function be(t){return t<.0031308?12.92*t:1.055*Math.pow(t,.41666)-.055}let _e;class we{static getDataURL(t){if(/^data:/i.test(t.src))return t.src;if("undefined"==typeof HTMLCanvasElement)return t.src;let e;if(t instanceof HTMLCanvasElement)e=t;else{void 0===_e&&(_e=ce("canvas")),_e.width=t.width,_e.height=t.height;const i=_e.getContext("2d");t instanceof ImageData?i.putImageData(t,0,0):i.drawImage(t,0,0,t.width,t.height),e=_e}return e.width>2048||e.height>2048?e.toDataURL("image/jpeg",.6):e.toDataURL("image/png")}static sRGBToLinear(t){if("undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap){const e=ce("canvas");e.width=t.width,e.height=t.height;const i=e.getContext("2d");i.drawImage(t,0,0,t.width,t.height);const n=i.getImageData(0,0,t.width,t.height),s=n.data;for(let t=0;t<s.length;t++)s[t]=255*xe(s[t]/255);return i.putImageData(n,0,0),e}if(t.data){const e=t.data.slice(0);for(let t=0;t<e.length;t++)e instanceof Uint8Array||e instanceof Uint8ClampedArray?e[t]=Math.floor(255*xe(e[t]/255)):e[t]=xe(e[t]);return{data:e,width:t.width,height:t.height}}return t}}let Me=0;class Se{constructor(t=null){this.isSource=!0,Object.defineProperty(this,"id",{value:Me++}),this.uuid=Jt(),this.data=t,this.version=0}set needsUpdate(t){!0===t&&this.version++}toJSON(t){const e=void 0===t||"string"==typeof t;if(!e&&void 0!==t.images[this.uuid])return t.images[this.uuid];const i={uuid:this.uuid,url:""},n=this.data;if(null!==n){let t;if(Array.isArray(n)){t=[];for(let e=0,i=n.length;e<i;e++)n[e].isDataTexture?t.push(Ee(n[e].image)):t.push(Ee(n[e]))}else t=Ee(n);i.url=t}return e||(t.images[this.uuid]=i),i}}function Ee(t){return"undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap?we.getDataURL(t):t.data?{data:Array.from(t.data),width:t.width,height:t.height,type:t.data.constructor.name}:{}}let Te=0;class Ae extends jt{constructor(t=Ae.DEFAULT_IMAGE,e=Ae.DEFAULT_MAPPING,i=1001,n=1001,s=1006,r=1008,a=1023,o=1009,h=Ae.DEFAULT_ANISOTROPY,l=""){super(),this.isTexture=!0,Object.defineProperty(this,"id",{value:Te++}),this.uuid=Jt(),this.name="",this.source=new Se(t),this.mipmaps=[],this.mapping=e,this.channel=0,this.wrapS=i,this.wrapT=n,this.magFilter=s,this.minFilter=r,this.anisotropy=h,this.format=a,this.internalFormat=null,this.type=o,this.offset=new se(0,0),this.repeat=new se(1,1),this.center=new se(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new re,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,"string"==typeof l?this.colorSpace=l:(pe("THREE.Texture: Property .encoding has been replaced by .colorSpace."),this.colorSpace=l===At?It:Ct),this.userData={},this.version=0,this.onUpdate=null,this.isRenderTargetTexture=!1,this.needsPMREMUpdate=!1}get image(){return this.source.data}set image(t=null){this.source.data=t}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}clone(){return(new this.constructor).copy(this)}copy(t){return this.name=t.name,this.source=t.source,this.mipmaps=t.mipmaps.slice(0),this.mapping=t.mapping,this.channel=t.channel,this.wrapS=t.wrapS,this.wrapT=t.wrapT,this.magFilter=t.magFilter,this.minFilter=t.minFilter,this.anisotropy=t.anisotropy,this.format=t.format,this.internalFormat=t.internalFormat,this.type=t.type,this.offset.copy(t.offset),this.repeat.copy(t.repeat),this.center.copy(t.center),this.rotation=t.rotation,this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrix.copy(t.matrix),this.generateMipmaps=t.generateMipmaps,this.premultiplyAlpha=t.premultiplyAlpha,this.flipY=t.flipY,this.unpackAlignment=t.unpackAlignment,this.colorSpace=t.colorSpace,this.userData=JSON.parse(JSON.stringify(t.userData)),this.needsUpdate=!0,this}toJSON(t){const e=void 0===t||"string"==typeof t;if(!e&&void 0!==t.textures[this.uuid])return t.textures[this.uuid];const i={metadata:{version:4.6,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,image:this.source.toJSON(t).uuid,mapping:this.mapping,channel:this.channel,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,internalFormat:this.internalFormat,type:this.type,colorSpace:this.colorSpace,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,generateMipmaps:this.generateMipmaps,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};return Object.keys(this.userData).length>0&&(i.userData=this.userData),e||(t.textures[this.uuid]=i),i}dispose(){this.dispatchEvent({type:"dispose"})}transformUv(t){if(300!==this.mapping)return t;if(t.applyMatrix3(this.matrix),t.x<0||t.x>1)switch(this.wrapS){case Y:t.x=t.x-Math.floor(t.x);break;case J:t.x=t.x<0?0:1;break;case $:1===Math.abs(Math.floor(t.x)%2)?t.x=Math.ceil(t.x)-t.x:t.x=t.x-Math.floor(t.x)}if(t.y<0||t.y>1)switch(this.wrapT){case Y:t.y=t.y-Math.floor(t.y);break;case J:t.y=t.y<0?0:1;break;case $:1===Math.abs(Math.floor(t.y)%2)?t.y=Math.ceil(t.y)-t.y:t.y=t.y-Math.floor(t.y)}return this.flipY&&(t.y=1-t.y),t}set needsUpdate(t){!0===t&&(this.version++,this.source.needsUpdate=!0)}get encoding(){return pe("THREE.Texture: Property .encoding has been replaced by .colorSpace."),this.colorSpace===It?At:3e3}set encoding(t){pe("THREE.Texture: Property .encoding has been replaced by .colorSpace."),this.colorSpace=t===At?It:Ct}}Ae.DEFAULT_IMAGE=null,Ae.DEFAULT_MAPPING=300,Ae.DEFAULT_ANISOTROPY=1;class Ce{constructor(t=0,e=0,i=0,n=1){Ce.prototype.isVector4=!0,this.x=t,this.y=e,this.z=i,this.w=n}get width(){return this.z}set width(t){this.z=t}get height(){return this.w}set height(t){this.w=t}set(t,e,i,n){return this.x=t,this.y=e,this.z=i,this.w=n,this}setScalar(t){return this.x=t,this.y=t,this.z=t,this.w=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}setW(t){return this.w=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;case 3:this.w=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=void 0!==t.w?t.w:1,this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this.w+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this.w=t.w+e.w,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this.w+=t.w*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this.w-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this.w=t.w-e.w,this}multiply(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this}applyMatrix4(t){const e=this.x,i=this.y,n=this.z,s=this.w,r=t.elements;return this.x=r[0]*e+r[4]*i+r[8]*n+r[12]*s,this.y=r[1]*e+r[5]*i+r[9]*n+r[13]*s,this.z=r[2]*e+r[6]*i+r[10]*n+r[14]*s,this.w=r[3]*e+r[7]*i+r[11]*n+r[15]*s,this}divideScalar(t){return this.multiplyScalar(1/t)}setAxisAngleFromQuaternion(t){this.w=2*Math.acos(t.w);const e=Math.sqrt(1-t.w*t.w);return e<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=t.x/e,this.y=t.y/e,this.z=t.z/e),this}setAxisAngleFromRotationMatrix(t){let e,i,n,s;const r=.01,a=.1,o=t.elements,h=o[0],l=o[4],c=o[8],u=o[1],d=o[5],p=o[9],m=o[2],f=o[6],g=o[10];if(Math.abs(l-u)<r&&Math.abs(c-m)<r&&Math.abs(p-f)<r){if(Math.abs(l+u)<a&&Math.abs(c+m)<a&&Math.abs(p+f)<a&&Math.abs(h+d+g-3)<a)return this.set(1,0,0,0),this;e=Math.PI;const t=(h+1)/2,o=(d+1)/2,v=(g+1)/2,y=(l+u)/4,x=(c+m)/4,b=(p+f)/4;return t>o&&t>v?t<r?(i=0,n=.707106781,s=.707106781):(i=Math.sqrt(t),n=y/i,s=x/i):o>v?o<r?(i=.707106781,n=0,s=.707106781):(n=Math.sqrt(o),i=y/n,s=b/n):v<r?(i=.707106781,n=.707106781,s=0):(s=Math.sqrt(v),i=x/s,n=b/s),this.set(i,n,s,e),this}let v=Math.sqrt((f-p)*(f-p)+(c-m)*(c-m)+(u-l)*(u-l));return Math.abs(v)<.001&&(v=1),this.x=(f-p)/v,this.y=(c-m)/v,this.z=(u-l)/v,this.w=Math.acos((h+d+g-1)/2),this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this.w=Math.min(this.w,t.w),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this.w=Math.max(this.w,t.w),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this.w=Math.max(t.w,Math.min(e.w,this.w)),this}clampScalar(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this.z=Math.max(t,Math.min(e,this.z)),this.w=Math.max(t,Math.min(e,this.w)),this}clampLength(t,e){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(t,Math.min(e,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this.w=Math.trunc(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this.w+=(t.w-this.w)*e,this}lerpVectors(t,e,i){return this.x=t.x+(e.x-t.x)*i,this.y=t.y+(e.y-t.y)*i,this.z=t.z+(e.z-t.z)*i,this.w=t.w+(e.w-t.w)*i,this}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z&&t.w===this.w}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this.w=t[e+3],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t[e+3]=this.w,t}fromBufferAttribute(t,e){return this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this.w=t.getW(e),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z,yield this.w}}class Ie extends jt{constructor(t=1,e=1,i={}){super(),this.isRenderTarget=!0,this.width=t,this.height=e,this.depth=1,this.scissor=new Ce(0,0,t,e),this.scissorTest=!1,this.viewport=new Ce(0,0,t,e);const n={width:t,height:e,depth:1};void 0!==i.encoding&&(pe("THREE.WebGLRenderTarget: option.encoding has been replaced by option.colorSpace."),i.colorSpace=i.encoding===At?It:Ct),i=Object.assign({generateMipmaps:!1,internalFormat:null,minFilter:tt,depthBuffer:!0,stencilBuffer:!1,depthTexture:null,samples:0},i),this.texture=new Ae(n,i.mapping,i.wrapS,i.wrapT,i.magFilter,i.minFilter,i.format,i.type,i.anisotropy,i.colorSpace),this.texture.isRenderTargetTexture=!0,this.texture.flipY=!1,this.texture.generateMipmaps=i.generateMipmaps,this.texture.internalFormat=i.internalFormat,this.depthBuffer=i.depthBuffer,this.stencilBuffer=i.stencilBuffer,this.depthTexture=i.depthTexture,this.samples=i.samples}setSize(t,e,i=1){this.width===t&&this.height===e&&this.depth===i||(this.width=t,this.height=e,this.depth=i,this.texture.image.width=t,this.texture.image.height=e,this.texture.image.depth=i,this.dispose()),this.viewport.set(0,0,t,e),this.scissor.set(0,0,t,e)}clone(){return(new this.constructor).copy(this)}copy(t){this.width=t.width,this.height=t.height,this.depth=t.depth,this.scissor.copy(t.scissor),this.scissorTest=t.scissorTest,this.viewport.copy(t.viewport),this.texture=t.texture.clone(),this.texture.isRenderTargetTexture=!0;const e=Object.assign({},t.texture.image);return this.texture.source=new Se(e),this.depthBuffer=t.depthBuffer,this.stencilBuffer=t.stencilBuffer,null!==t.depthTexture&&(this.depthTexture=t.depthTexture.clone()),this.samples=t.samples,this}dispose(){this.dispatchEvent({type:"dispose"})}}class Re extends Ie{constructor(t=1,e=1,i={}){super(t,e,i),this.isWebGLRenderTarget=!0}}class ke extends Ae{constructor(t=null,e=1,i=1,n=1){super(null),this.isDataArrayTexture=!0,this.image={data:t,width:e,height:i,depth:n},this.magFilter=K,this.minFilter=K,this.wrapR=J,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}class Pe extends Ae{constructor(t=null,e=1,i=1,n=1){super(null),this.isData3DTexture=!0,this.image={data:t,width:e,height:i,depth:n},this.magFilter=K,this.minFilter=K,this.wrapR=J,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}class De{constructor(t=0,e=0,i=0,n=1){this.isQuaternion=!0,this._x=t,this._y=e,this._z=i,this._w=n}static slerpFlat(t,e,i,n,s,r,a){let o=i[n+0],h=i[n+1],l=i[n+2],c=i[n+3];const u=s[r+0],d=s[r+1],p=s[r+2],m=s[r+3];if(0===a)return t[e+0]=o,t[e+1]=h,t[e+2]=l,void(t[e+3]=c);if(1===a)return t[e+0]=u,t[e+1]=d,t[e+2]=p,void(t[e+3]=m);if(c!==m||o!==u||h!==d||l!==p){let t=1-a;const e=o*u+h*d+l*p+c*m,i=e>=0?1:-1,n=1-e*e;if(n>Number.EPSILON){const s=Math.sqrt(n),r=Math.atan2(s,e*i);t=Math.sin(t*r)/s,a=Math.sin(a*r)/s}const s=a*i;if(o=o*t+u*s,h=h*t+d*s,l=l*t+p*s,c=c*t+m*s,t===1-a){const t=1/Math.sqrt(o*o+h*h+l*l+c*c);o*=t,h*=t,l*=t,c*=t}}t[e]=o,t[e+1]=h,t[e+2]=l,t[e+3]=c}static multiplyQuaternionsFlat(t,e,i,n,s,r){const a=i[n],o=i[n+1],h=i[n+2],l=i[n+3],c=s[r],u=s[r+1],d=s[r+2],p=s[r+3];return t[e]=a*p+l*c+o*d-h*u,t[e+1]=o*p+l*u+h*c-a*d,t[e+2]=h*p+l*d+a*u-o*c,t[e+3]=l*p-a*c-o*u-h*d,t}get x(){return this._x}set x(t){this._x=t,this._onChangeCallback()}get y(){return this._y}set y(t){this._y=t,this._onChangeCallback()}get z(){return this._z}set z(t){this._z=t,this._onChangeCallback()}get w(){return this._w}set w(t){this._w=t,this._onChangeCallback()}set(t,e,i,n){return this._x=t,this._y=e,this._z=i,this._w=n,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w,this._onChangeCallback(),this}setFromEuler(t,e=!0){const i=t._x,n=t._y,s=t._z,r=t._order,a=Math.cos,o=Math.sin,h=a(i/2),l=a(n/2),c=a(s/2),u=o(i/2),d=o(n/2),p=o(s/2);switch(r){case"XYZ":this._x=u*l*c+h*d*p,this._y=h*d*c-u*l*p,this._z=h*l*p+u*d*c,this._w=h*l*c-u*d*p;break;case"YXZ":this._x=u*l*c+h*d*p,this._y=h*d*c-u*l*p,this._z=h*l*p-u*d*c,this._w=h*l*c+u*d*p;break;case"ZXY":this._x=u*l*c-h*d*p,this._y=h*d*c+u*l*p,this._z=h*l*p+u*d*c,this._w=h*l*c-u*d*p;break;case"ZYX":this._x=u*l*c-h*d*p,this._y=h*d*c+u*l*p,this._z=h*l*p-u*d*c,this._w=h*l*c+u*d*p;break;case"YZX":this._x=u*l*c+h*d*p,this._y=h*d*c+u*l*p,this._z=h*l*p-u*d*c,this._w=h*l*c-u*d*p;break;case"XZY":this._x=u*l*c-h*d*p,this._y=h*d*c-u*l*p,this._z=h*l*p+u*d*c,this._w=h*l*c+u*d*p}return!0===e&&this._onChangeCallback(),this}setFromAxisAngle(t,e){const i=e/2,n=Math.sin(i);return this._x=t.x*n,this._y=t.y*n,this._z=t.z*n,this._w=Math.cos(i),this._onChangeCallback(),this}setFromRotationMatrix(t){const e=t.elements,i=e[0],n=e[4],s=e[8],r=e[1],a=e[5],o=e[9],h=e[2],l=e[6],c=e[10],u=i+a+c;if(u>0){const t=.5/Math.sqrt(u+1);this._w=.25/t,this._x=(l-o)*t,this._y=(s-h)*t,this._z=(r-n)*t}else if(i>a&&i>c){const t=2*Math.sqrt(1+i-a-c);this._w=(l-o)/t,this._x=.25*t,this._y=(n+r)/t,this._z=(s+h)/t}else if(a>c){const t=2*Math.sqrt(1+a-i-c);this._w=(s-h)/t,this._x=(n+r)/t,this._y=.25*t,this._z=(o+l)/t}else{const t=2*Math.sqrt(1+c-i-a);this._w=(r-n)/t,this._x=(s+h)/t,this._y=(o+l)/t,this._z=.25*t}return this._onChangeCallback(),this}setFromUnitVectors(t,e){let i=t.dot(e)+1;return i<Number.EPSILON?(i=0,Math.abs(t.x)>Math.abs(t.z)?(this._x=-t.y,this._y=t.x,this._z=0,this._w=i):(this._x=0,this._y=-t.z,this._z=t.y,this._w=i)):(this._x=t.y*e.z-t.z*e.y,this._y=t.z*e.x-t.x*e.z,this._z=t.x*e.y-t.y*e.x,this._w=i),this.normalize()}angleTo(t){return 2*Math.acos(Math.abs($t(this.dot(t),-1,1)))}rotateTowards(t,e){const i=this.angleTo(t);if(0===i)return this;const n=Math.min(1,e/i);return this.slerp(t,n),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(t){return this._x*t._x+this._y*t._y+this._z*t._z+this._w*t._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let t=this.length();return 0===t?(this._x=0,this._y=0,this._z=0,this._w=1):(t=1/t,this._x=this._x*t,this._y=this._y*t,this._z=this._z*t,this._w=this._w*t),this._onChangeCallback(),this}multiply(t){return this.multiplyQuaternions(this,t)}premultiply(t){return this.multiplyQuaternions(t,this)}multiplyQuaternions(t,e){const i=t._x,n=t._y,s=t._z,r=t._w,a=e._x,o=e._y,h=e._z,l=e._w;return this._x=i*l+r*a+n*h-s*o,this._y=n*l+r*o+s*a-i*h,this._z=s*l+r*h+i*o-n*a,this._w=r*l-i*a-n*o-s*h,this._onChangeCallback(),this}slerp(t,e){if(0===e)return this;if(1===e)return this.copy(t);const i=this._x,n=this._y,s=this._z,r=this._w;let a=r*t._w+i*t._x+n*t._y+s*t._z;if(a<0?(this._w=-t._w,this._x=-t._x,this._y=-t._y,this._z=-t._z,a=-a):this.copy(t),a>=1)return this._w=r,this._x=i,this._y=n,this._z=s,this;const o=1-a*a;if(o<=Number.EPSILON){const t=1-e;return this._w=t*r+e*this._w,this._x=t*i+e*this._x,this._y=t*n+e*this._y,this._z=t*s+e*this._z,this.normalize(),this}const h=Math.sqrt(o),l=Math.atan2(h,a),c=Math.sin((1-e)*l)/h,u=Math.sin(e*l)/h;return this._w=r*c+this._w*u,this._x=i*c+this._x*u,this._y=n*c+this._y*u,this._z=s*c+this._z*u,this._onChangeCallback(),this}slerpQuaternions(t,e,i){return this.copy(t).slerp(e,i)}random(){const t=Math.random(),e=Math.sqrt(1-t),i=Math.sqrt(t),n=2*Math.PI*Math.random(),s=2*Math.PI*Math.random();return this.set(e*Math.cos(n),i*Math.sin(s),i*Math.cos(s),e*Math.sin(n))}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._w===this._w}fromArray(t,e=0){return this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this._onChangeCallback(),this}toArray(t=[],e=0){return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w,t}fromBufferAttribute(t,e){return this._x=t.getX(e),this._y=t.getY(e),this._z=t.getZ(e),this._w=t.getW(e),this._onChangeCallback(),this}toJSON(){return this.toArray()}_onChange(t){return this._onChangeCallback=t,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._w}}class Le{constructor(t=0,e=0,i=0){Le.prototype.isVector3=!0,this.x=t,this.y=e,this.z=i}set(t,e,i){return void 0===i&&(i=this.z),this.x=t,this.y=e,this.z=i,this}setScalar(t){return this.x=t,this.y=t,this.z=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}multiply(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this}multiplyVectors(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this}applyEuler(t){return this.applyQuaternion(Ne.setFromEuler(t))}applyAxisAngle(t,e){return this.applyQuaternion(Ne.setFromAxisAngle(t,e))}applyMatrix3(t){const e=this.x,i=this.y,n=this.z,s=t.elements;return this.x=s[0]*e+s[3]*i+s[6]*n,this.y=s[1]*e+s[4]*i+s[7]*n,this.z=s[2]*e+s[5]*i+s[8]*n,this}applyNormalMatrix(t){return this.applyMatrix3(t).normalize()}applyMatrix4(t){const e=this.x,i=this.y,n=this.z,s=t.elements,r=1/(s[3]*e+s[7]*i+s[11]*n+s[15]);return this.x=(s[0]*e+s[4]*i+s[8]*n+s[12])*r,this.y=(s[1]*e+s[5]*i+s[9]*n+s[13])*r,this.z=(s[2]*e+s[6]*i+s[10]*n+s[14])*r,this}applyQuaternion(t){const e=this.x,i=this.y,n=this.z,s=t.x,r=t.y,a=t.z,o=t.w,h=2*(r*n-a*i),l=2*(a*e-s*n),c=2*(s*i-r*e);return this.x=e+o*h+r*c-a*l,this.y=i+o*l+a*h-s*c,this.z=n+o*c+s*l-r*h,this}project(t){return this.applyMatrix4(t.matrixWorldInverse).applyMatrix4(t.projectionMatrix)}unproject(t){return this.applyMatrix4(t.projectionMatrixInverse).applyMatrix4(t.matrixWorld)}transformDirection(t){const e=this.x,i=this.y,n=this.z,s=t.elements;return this.x=s[0]*e+s[4]*i+s[8]*n,this.y=s[1]*e+s[5]*i+s[9]*n,this.z=s[2]*e+s[6]*i+s[10]*n,this.normalize()}divide(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}divideScalar(t){return this.multiplyScalar(1/t)}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this}clampScalar(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this.z=Math.max(t,Math.min(e,this.z)),this}clampLength(t,e){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(t,Math.min(e,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this}lerpVectors(t,e,i){return this.x=t.x+(e.x-t.x)*i,this.y=t.y+(e.y-t.y)*i,this.z=t.z+(e.z-t.z)*i,this}cross(t){return this.crossVectors(this,t)}crossVectors(t,e){const i=t.x,n=t.y,s=t.z,r=e.x,a=e.y,o=e.z;return this.x=n*o-s*a,this.y=s*r-i*o,this.z=i*a-n*r,this}projectOnVector(t){const e=t.lengthSq();if(0===e)return this.set(0,0,0);const i=t.dot(this)/e;return this.copy(t).multiplyScalar(i)}projectOnPlane(t){return Oe.copy(this).projectOnVector(t),this.sub(Oe)}reflect(t){return this.sub(Oe.copy(t).multiplyScalar(2*this.dot(t)))}angleTo(t){const e=Math.sqrt(this.lengthSq()*t.lengthSq());if(0===e)return Math.PI/2;const i=this.dot(t)/e;return Math.acos($t(i,-1,1))}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,i=this.y-t.y,n=this.z-t.z;return e*e+i*i+n*n}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)+Math.abs(this.z-t.z)}setFromSpherical(t){return this.setFromSphericalCoords(t.radius,t.phi,t.theta)}setFromSphericalCoords(t,e,i){const n=Math.sin(e)*t;return this.x=n*Math.sin(i),this.y=Math.cos(e)*t,this.z=n*Math.cos(i),this}setFromCylindrical(t){return this.setFromCylindricalCoords(t.radius,t.theta,t.y)}setFromCylindricalCoords(t,e,i){return this.x=t*Math.sin(e),this.y=i,this.z=t*Math.cos(e),this}setFromMatrixPosition(t){const e=t.elements;return this.x=e[12],this.y=e[13],this.z=e[14],this}setFromMatrixScale(t){const e=this.setFromMatrixColumn(t,0).length(),i=this.setFromMatrixColumn(t,1).length(),n=this.setFromMatrixColumn(t,2).length();return this.x=e,this.y=i,this.z=n,this}setFromMatrixColumn(t,e){return this.fromArray(t.elements,4*e)}setFromMatrix3Column(t,e){return this.fromArray(t.elements,3*e)}setFromEuler(t){return this.x=t._x,this.y=t._y,this.z=t._z,this}setFromColor(t){return this.x=t.r,this.y=t.g,this.z=t.b,this}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t}fromBufferAttribute(t,e){return this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}randomDirection(){const t=2*(Math.random()-.5),e=Math.random()*Math.PI*2,i=Math.sqrt(1-t**2);return this.x=i*Math.cos(e),this.y=i*Math.sin(e),this.z=t,this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}}const Oe=new Le,Ne=new De;class Be{constructor(t=new Le(1/0,1/0,1/0),e=new Le(-1/0,-1/0,-1/0)){this.isBox3=!0,this.min=t,this.max=e}set(t,e){return this.min.copy(t),this.max.copy(e),this}setFromArray(t){this.makeEmpty();for(let e=0,i=t.length;e<i;e+=3)this.expandByPoint(Ue.fromArray(t,e));return this}setFromBufferAttribute(t){this.makeEmpty();for(let e=0,i=t.count;e<i;e++)this.expandByPoint(Ue.fromBufferAttribute(t,e));return this}setFromPoints(t){this.makeEmpty();for(let e=0,i=t.length;e<i;e++)this.expandByPoint(t[e]);return this}setFromCenterAndSize(t,e){const i=Ue.copy(e).multiplyScalar(.5);return this.min.copy(t).sub(i),this.max.copy(t).add(i),this}setFromObject(t,e=!1){return this.makeEmpty(),this.expandByObject(t,e)}clone(){return(new this.constructor).copy(this)}copy(t){return this.min.copy(t.min),this.max.copy(t.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(t){return this.isEmpty()?t.set(0,0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(t){return this.isEmpty()?t.set(0,0,0):t.subVectors(this.max,this.min)}expandByPoint(t){return this.min.min(t),this.max.max(t),this}expandByVector(t){return this.min.sub(t),this.max.add(t),this}expandByScalar(t){return this.min.addScalar(-t),this.max.addScalar(t),this}expandByObject(t,e=!1){t.updateWorldMatrix(!1,!1);const i=t.geometry;if(void 0!==i){const n=i.getAttribute("position");if(!0===e&&void 0!==n&&!0!==t.isInstancedMesh)for(let e=0,i=n.count;e<i;e++)!0===t.isMesh?t.getVertexPosition(e,Ue):Ue.fromBufferAttribute(n,e),Ue.applyMatrix4(t.matrixWorld),this.expandByPoint(Ue);else void 0!==t.boundingBox?(null===t.boundingBox&&t.computeBoundingBox(),Fe.copy(t.boundingBox)):(null===i.boundingBox&&i.computeBoundingBox(),Fe.copy(i.boundingBox)),Fe.applyMatrix4(t.matrixWorld),this.union(Fe)}const n=t.children;for(let t=0,i=n.length;t<i;t++)this.expandByObject(n[t],e);return this}containsPoint(t){return!(t.x<this.min.x||t.x>this.max.x||t.y<this.min.y||t.y>this.max.y||t.z<this.min.z||t.z>this.max.z)}containsBox(t){return this.min.x<=t.min.x&&t.max.x<=this.max.x&&this.min.y<=t.min.y&&t.max.y<=this.max.y&&this.min.z<=t.min.z&&t.max.z<=this.max.z}getParameter(t,e){return e.set((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y),(t.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(t){return!(t.max.x<this.min.x||t.min.x>this.max.x||t.max.y<this.min.y||t.min.y>this.max.y||t.max.z<this.min.z||t.min.z>this.max.z)}intersectsSphere(t){return this.clampPoint(t.center,Ue),Ue.distanceToSquared(t.center)<=t.radius*t.radius}intersectsPlane(t){let e,i;return t.normal.x>0?(e=t.normal.x*this.min.x,i=t.normal.x*this.max.x):(e=t.normal.x*this.max.x,i=t.normal.x*this.min.x),t.normal.y>0?(e+=t.normal.y*this.min.y,i+=t.normal.y*this.max.y):(e+=t.normal.y*this.max.y,i+=t.normal.y*this.min.y),t.normal.z>0?(e+=t.normal.z*this.min.z,i+=t.normal.z*this.max.z):(e+=t.normal.z*this.max.z,i+=t.normal.z*this.min.z),e<=-t.constant&&i>=-t.constant}intersectsTriangle(t){if(this.isEmpty())return!1;this.getCenter(qe),Ye.subVectors(this.max,qe),Ge.subVectors(t.a,qe),Ve.subVectors(t.b,qe),He.subVectors(t.c,qe),je.subVectors(Ve,Ge),We.subVectors(He,Ve),Xe.subVectors(Ge,He);let e=[0,-je.z,je.y,0,-We.z,We.y,0,-Xe.z,Xe.y,je.z,0,-je.x,We.z,0,-We.x,Xe.z,0,-Xe.x,-je.y,je.x,0,-We.y,We.x,0,-Xe.y,Xe.x,0];return!!Ke(e,Ge,Ve,He,Ye)&&(e=[1,0,0,0,1,0,0,0,1],!!Ke(e,Ge,Ve,He,Ye)&&(Je.crossVectors(je,We),e=[Je.x,Je.y,Je.z],Ke(e,Ge,Ve,He,Ye)))}clampPoint(t,e){return e.copy(t).clamp(this.min,this.max)}distanceToPoint(t){return this.clampPoint(t,Ue).distanceTo(t)}getBoundingSphere(t){return this.isEmpty()?t.makeEmpty():(this.getCenter(t.center),t.radius=.5*this.getSize(Ue).length()),t}intersect(t){return this.min.max(t.min),this.max.min(t.max),this.isEmpty()&&this.makeEmpty(),this}union(t){return this.min.min(t.min),this.max.max(t.max),this}applyMatrix4(t){return this.isEmpty()||(ze[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(t),ze[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(t),ze[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(t),ze[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(t),ze[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(t),ze[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(t),ze[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(t),ze[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(t),this.setFromPoints(ze)),this}translate(t){return this.min.add(t),this.max.add(t),this}equals(t){return t.min.equals(this.min)&&t.max.equals(this.max)}}const ze=[new Le,new Le,new Le,new Le,new Le,new Le,new Le,new Le],Ue=new Le,Fe=new Be,Ge=new Le,Ve=new Le,He=new Le,je=new Le,We=new Le,Xe=new Le,qe=new Le,Ye=new Le,Je=new Le,$e=new Le;function Ke(t,e,i,n,s){for(let r=0,a=t.length-3;r<=a;r+=3){$e.fromArray(t,r);const a=s.x*Math.abs($e.x)+s.y*Math.abs($e.y)+s.z*Math.abs($e.z),o=e.dot($e),h=i.dot($e),l=n.dot($e);if(Math.max(-Math.max(o,h,l),Math.min(o,h,l))>a)return!1}return!0}const Ze=new Be,Qe=new Le,ti=new Le;class ei{constructor(t=new Le,e=-1){this.isSphere=!0,this.center=t,this.radius=e}set(t,e){return this.center.copy(t),this.radius=e,this}setFromPoints(t,e){const i=this.center;void 0!==e?i.copy(e):Ze.setFromPoints(t).getCenter(i);let n=0;for(let e=0,s=t.length;e<s;e++)n=Math.max(n,i.distanceToSquared(t[e]));return this.radius=Math.sqrt(n),this}copy(t){return this.center.copy(t.center),this.radius=t.radius,this}isEmpty(){return this.radius<0}makeEmpty(){return this.center.set(0,0,0),this.radius=-1,this}containsPoint(t){return t.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(t){return t.distanceTo(this.center)-this.radius}intersectsSphere(t){const e=this.radius+t.radius;return t.center.distanceToSquared(this.center)<=e*e}intersectsBox(t){return t.intersectsSphere(this)}intersectsPlane(t){return Math.abs(t.distanceToPoint(this.center))<=this.radius}clampPoint(t,e){const i=this.center.distanceToSquared(t);return e.copy(t),i>this.radius*this.radius&&(e.sub(this.center).normalize(),e.multiplyScalar(this.radius).add(this.center)),e}getBoundingBox(t){return this.isEmpty()?(t.makeEmpty(),t):(t.set(this.center,this.center),t.expandByScalar(this.radius),t)}applyMatrix4(t){return this.center.applyMatrix4(t),this.radius=this.radius*t.getMaxScaleOnAxis(),this}translate(t){return this.center.add(t),this}expandByPoint(t){if(this.isEmpty())return this.center.copy(t),this.radius=0,this;Qe.subVectors(t,this.center);const e=Qe.lengthSq();if(e>this.radius*this.radius){const t=Math.sqrt(e),i=.5*(t-this.radius);this.center.addScaledVector(Qe,i/t),this.radius+=i}return this}union(t){return t.isEmpty()?this:this.isEmpty()?(this.copy(t),this):(!0===this.center.equals(t.center)?this.radius=Math.max(this.radius,t.radius):(ti.subVectors(t.center,this.center).setLength(t.radius),this.expandByPoint(Qe.copy(t.center).add(ti)),this.expandByPoint(Qe.copy(t.center).sub(ti))),this)}equals(t){return t.center.equals(this.center)&&t.radius===this.radius}clone(){return(new this.constructor).copy(this)}}const ii=new Le,ni=new Le,si=new Le,ri=new Le,ai=new Le,oi=new Le,hi=new Le;class li{constructor(t=new Le,e=new Le(0,0,-1)){this.origin=t,this.direction=e}set(t,e){return this.origin.copy(t),this.direction.copy(e),this}copy(t){return this.origin.copy(t.origin),this.direction.copy(t.direction),this}at(t,e){return e.copy(this.origin).addScaledVector(this.direction,t)}lookAt(t){return this.direction.copy(t).sub(this.origin).normalize(),this}recast(t){return this.origin.copy(this.at(t,ii)),this}closestPointToPoint(t,e){e.subVectors(t,this.origin);const i=e.dot(this.direction);return i<0?e.copy(this.origin):e.copy(this.origin).addScaledVector(this.direction,i)}distanceToPoint(t){return Math.sqrt(this.distanceSqToPoint(t))}distanceSqToPoint(t){const e=ii.subVectors(t,this.origin).dot(this.direction);return e<0?this.origin.distanceToSquared(t):(ii.copy(this.origin).addScaledVector(this.direction,e),ii.distanceToSquared(t))}distanceSqToSegment(t,e,i,n){ni.copy(t).add(e).multiplyScalar(.5),si.copy(e).sub(t).normalize(),ri.copy(this.origin).sub(ni);const s=.5*t.distanceTo(e),r=-this.direction.dot(si),a=ri.dot(this.direction),o=-ri.dot(si),h=ri.lengthSq(),l=Math.abs(1-r*r);let c,u,d,p;if(l>0)if(c=r*o-a,u=r*a-o,p=s*l,c>=0)if(u>=-p)if(u<=p){const t=1/l;c*=t,u*=t,d=c*(c+r*u+2*a)+u*(r*c+u+2*o)+h}else u=s,c=Math.max(0,-(r*u+a)),d=-c*c+u*(u+2*o)+h;else u=-s,c=Math.max(0,-(r*u+a)),d=-c*c+u*(u+2*o)+h;else u<=-p?(c=Math.max(0,-(-r*s+a)),u=c>0?-s:Math.min(Math.max(-s,-o),s),d=-c*c+u*(u+2*o)+h):u<=p?(c=0,u=Math.min(Math.max(-s,-o),s),d=u*(u+2*o)+h):(c=Math.max(0,-(r*s+a)),u=c>0?s:Math.min(Math.max(-s,-o),s),d=-c*c+u*(u+2*o)+h);else u=r>0?-s:s,c=Math.max(0,-(r*u+a)),d=-c*c+u*(u+2*o)+h;return i&&i.copy(this.origin).addScaledVector(this.direction,c),n&&n.copy(ni).addScaledVector(si,u),d}intersectSphere(t,e){ii.subVectors(t.center,this.origin);const i=ii.dot(this.direction),n=ii.dot(ii)-i*i,s=t.radius*t.radius;if(n>s)return null;const r=Math.sqrt(s-n),a=i-r,o=i+r;return o<0?null:a<0?this.at(o,e):this.at(a,e)}intersectsSphere(t){return this.distanceSqToPoint(t.center)<=t.radius*t.radius}distanceToPlane(t){const e=t.normal.dot(this.direction);if(0===e)return 0===t.distanceToPoint(this.origin)?0:null;const i=-(this.origin.dot(t.normal)+t.constant)/e;return i>=0?i:null}intersectPlane(t,e){const i=this.distanceToPlane(t);return null===i?null:this.at(i,e)}intersectsPlane(t){const e=t.distanceToPoint(this.origin);if(0===e)return!0;return t.normal.dot(this.direction)*e<0}intersectBox(t,e){let i,n,s,r,a,o;const h=1/this.direction.x,l=1/this.direction.y,c=1/this.direction.z,u=this.origin;return h>=0?(i=(t.min.x-u.x)*h,n=(t.max.x-u.x)*h):(i=(t.max.x-u.x)*h,n=(t.min.x-u.x)*h),l>=0?(s=(t.min.y-u.y)*l,r=(t.max.y-u.y)*l):(s=(t.max.y-u.y)*l,r=(t.min.y-u.y)*l),i>r||s>n?null:((s>i||isNaN(i))&&(i=s),(r<n||isNaN(n))&&(n=r),c>=0?(a=(t.min.z-u.z)*c,o=(t.max.z-u.z)*c):(a=(t.max.z-u.z)*c,o=(t.min.z-u.z)*c),i>o||a>n?null:((a>i||i!=i)&&(i=a),(o<n||n!=n)&&(n=o),n<0?null:this.at(i>=0?i:n,e)))}intersectsBox(t){return null!==this.intersectBox(t,ii)}intersectTriangle(t,e,i,n,s){ai.subVectors(e,t),oi.subVectors(i,t),hi.crossVectors(ai,oi);let r,a=this.direction.dot(hi);if(a>0){if(n)return null;r=1}else{if(!(a<0))return null;r=-1,a=-a}ri.subVectors(this.origin,t);const o=r*this.direction.dot(oi.crossVectors(ri,oi));if(o<0)return null;const h=r*this.direction.dot(ai.cross(ri));if(h<0)return null;if(o+h>a)return null;const l=-r*ri.dot(hi);return l<0?null:this.at(l/a,s)}applyMatrix4(t){return this.origin.applyMatrix4(t),this.direction.transformDirection(t),this}equals(t){return t.origin.equals(this.origin)&&t.direction.equals(this.direction)}clone(){return(new this.constructor).copy(this)}}class ci{constructor(t,e,i,n,s,r,a,o,h,l,c,u,d,p,m,f){ci.prototype.isMatrix4=!0,this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],void 0!==t&&this.set(t,e,i,n,s,r,a,o,h,l,c,u,d,p,m,f)}set(t,e,i,n,s,r,a,o,h,l,c,u,d,p,m,f){const g=this.elements;return g[0]=t,g[4]=e,g[8]=i,g[12]=n,g[1]=s,g[5]=r,g[9]=a,g[13]=o,g[2]=h,g[6]=l,g[10]=c,g[14]=u,g[3]=d,g[7]=p,g[11]=m,g[15]=f,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return(new ci).fromArray(this.elements)}copy(t){const e=this.elements,i=t.elements;return e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5],e[6]=i[6],e[7]=i[7],e[8]=i[8],e[9]=i[9],e[10]=i[10],e[11]=i[11],e[12]=i[12],e[13]=i[13],e[14]=i[14],e[15]=i[15],this}copyPosition(t){const e=this.elements,i=t.elements;return e[12]=i[12],e[13]=i[13],e[14]=i[14],this}setFromMatrix3(t){const e=t.elements;return this.set(e[0],e[3],e[6],0,e[1],e[4],e[7],0,e[2],e[5],e[8],0,0,0,0,1),this}extractBasis(t,e,i){return t.setFromMatrixColumn(this,0),e.setFromMatrixColumn(this,1),i.setFromMatrixColumn(this,2),this}makeBasis(t,e,i){return this.set(t.x,e.x,i.x,0,t.y,e.y,i.y,0,t.z,e.z,i.z,0,0,0,0,1),this}extractRotation(t){const e=this.elements,i=t.elements,n=1/ui.setFromMatrixColumn(t,0).length(),s=1/ui.setFromMatrixColumn(t,1).length(),r=1/ui.setFromMatrixColumn(t,2).length();return e[0]=i[0]*n,e[1]=i[1]*n,e[2]=i[2]*n,e[3]=0,e[4]=i[4]*s,e[5]=i[5]*s,e[6]=i[6]*s,e[7]=0,e[8]=i[8]*r,e[9]=i[9]*r,e[10]=i[10]*r,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeRotationFromEuler(t){const e=this.elements,i=t.x,n=t.y,s=t.z,r=Math.cos(i),a=Math.sin(i),o=Math.cos(n),h=Math.sin(n),l=Math.cos(s),c=Math.sin(s);if("XYZ"===t.order){const t=r*l,i=r*c,n=a*l,s=a*c;e[0]=o*l,e[4]=-o*c,e[8]=h,e[1]=i+n*h,e[5]=t-s*h,e[9]=-a*o,e[2]=s-t*h,e[6]=n+i*h,e[10]=r*o}else if("YXZ"===t.order){const t=o*l,i=o*c,n=h*l,s=h*c;e[0]=t+s*a,e[4]=n*a-i,e[8]=r*h,e[1]=r*c,e[5]=r*l,e[9]=-a,e[2]=i*a-n,e[6]=s+t*a,e[10]=r*o}else if("ZXY"===t.order){const t=o*l,i=o*c,n=h*l,s=h*c;e[0]=t-s*a,e[4]=-r*c,e[8]=n+i*a,e[1]=i+n*a,e[5]=r*l,e[9]=s-t*a,e[2]=-r*h,e[6]=a,e[10]=r*o}else if("ZYX"===t.order){const t=r*l,i=r*c,n=a*l,s=a*c;e[0]=o*l,e[4]=n*h-i,e[8]=t*h+s,e[1]=o*c,e[5]=s*h+t,e[9]=i*h-n,e[2]=-h,e[6]=a*o,e[10]=r*o}else if("YZX"===t.order){const t=r*o,i=r*h,n=a*o,s=a*h;e[0]=o*l,e[4]=s-t*c,e[8]=n*c+i,e[1]=c,e[5]=r*l,e[9]=-a*l,e[2]=-h*l,e[6]=i*c+n,e[10]=t-s*c}else if("XZY"===t.order){const t=r*o,i=r*h,n=a*o,s=a*h;e[0]=o*l,e[4]=-c,e[8]=h*l,e[1]=t*c+s,e[5]=r*l,e[9]=i*c-n,e[2]=n*c-i,e[6]=a*l,e[10]=s*c+t}return e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeRotationFromQuaternion(t){return this.compose(pi,t,mi)}lookAt(t,e,i){const n=this.elements;return vi.subVectors(t,e),0===vi.lengthSq()&&(vi.z=1),vi.normalize(),fi.crossVectors(i,vi),0===fi.lengthSq()&&(1===Math.abs(i.z)?vi.x+=1e-4:vi.z+=1e-4,vi.normalize(),fi.crossVectors(i,vi)),fi.normalize(),gi.crossVectors(vi,fi),n[0]=fi.x,n[4]=gi.x,n[8]=vi.x,n[1]=fi.y,n[5]=gi.y,n[9]=vi.y,n[2]=fi.z,n[6]=gi.z,n[10]=vi.z,this}multiply(t){return this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const i=t.elements,n=e.elements,s=this.elements,r=i[0],a=i[4],o=i[8],h=i[12],l=i[1],c=i[5],u=i[9],d=i[13],p=i[2],m=i[6],f=i[10],g=i[14],v=i[3],y=i[7],x=i[11],b=i[15],_=n[0],w=n[4],M=n[8],S=n[12],E=n[1],T=n[5],A=n[9],C=n[13],I=n[2],R=n[6],k=n[10],P=n[14],D=n[3],L=n[7],O=n[11],N=n[15];return s[0]=r*_+a*E+o*I+h*D,s[4]=r*w+a*T+o*R+h*L,s[8]=r*M+a*A+o*k+h*O,s[12]=r*S+a*C+o*P+h*N,s[1]=l*_+c*E+u*I+d*D,s[5]=l*w+c*T+u*R+d*L,s[9]=l*M+c*A+u*k+d*O,s[13]=l*S+c*C+u*P+d*N,s[2]=p*_+m*E+f*I+g*D,s[6]=p*w+m*T+f*R+g*L,s[10]=p*M+m*A+f*k+g*O,s[14]=p*S+m*C+f*P+g*N,s[3]=v*_+y*E+x*I+b*D,s[7]=v*w+y*T+x*R+b*L,s[11]=v*M+y*A+x*k+b*O,s[15]=v*S+y*C+x*P+b*N,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[4]*=t,e[8]*=t,e[12]*=t,e[1]*=t,e[5]*=t,e[9]*=t,e[13]*=t,e[2]*=t,e[6]*=t,e[10]*=t,e[14]*=t,e[3]*=t,e[7]*=t,e[11]*=t,e[15]*=t,this}determinant(){const t=this.elements,e=t[0],i=t[4],n=t[8],s=t[12],r=t[1],a=t[5],o=t[9],h=t[13],l=t[2],c=t[6],u=t[10],d=t[14];return t[3]*(+s*o*c-n*h*c-s*a*u+i*h*u+n*a*d-i*o*d)+t[7]*(+e*o*d-e*h*u+s*r*u-n*r*d+n*h*l-s*o*l)+t[11]*(+e*h*c-e*a*d-s*r*c+i*r*d+s*a*l-i*h*l)+t[15]*(-n*a*l-e*o*c+e*a*u+n*r*c-i*r*u+i*o*l)}transpose(){const t=this.elements;let e;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this}setPosition(t,e,i){const n=this.elements;return t.isVector3?(n[12]=t.x,n[13]=t.y,n[14]=t.z):(n[12]=t,n[13]=e,n[14]=i),this}invert(){const t=this.elements,e=t[0],i=t[1],n=t[2],s=t[3],r=t[4],a=t[5],o=t[6],h=t[7],l=t[8],c=t[9],u=t[10],d=t[11],p=t[12],m=t[13],f=t[14],g=t[15],v=c*f*h-m*u*h+m*o*d-a*f*d-c*o*g+a*u*g,y=p*u*h-l*f*h-p*o*d+r*f*d+l*o*g-r*u*g,x=l*m*h-p*c*h+p*a*d-r*m*d-l*a*g+r*c*g,b=p*c*o-l*m*o-p*a*u+r*m*u+l*a*f-r*c*f,_=e*v+i*y+n*x+s*b;if(0===_)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const w=1/_;return t[0]=v*w,t[1]=(m*u*s-c*f*s-m*n*d+i*f*d+c*n*g-i*u*g)*w,t[2]=(a*f*s-m*o*s+m*n*h-i*f*h-a*n*g+i*o*g)*w,t[3]=(c*o*s-a*u*s-c*n*h+i*u*h+a*n*d-i*o*d)*w,t[4]=y*w,t[5]=(l*f*s-p*u*s+p*n*d-e*f*d-l*n*g+e*u*g)*w,t[6]=(p*o*s-r*f*s-p*n*h+e*f*h+r*n*g-e*o*g)*w,t[7]=(r*u*s-l*o*s+l*n*h-e*u*h-r*n*d+e*o*d)*w,t[8]=x*w,t[9]=(p*c*s-l*m*s-p*i*d+e*m*d+l*i*g-e*c*g)*w,t[10]=(r*m*s-p*a*s+p*i*h-e*m*h-r*i*g+e*a*g)*w,t[11]=(l*a*s-r*c*s-l*i*h+e*c*h+r*i*d-e*a*d)*w,t[12]=b*w,t[13]=(l*m*n-p*c*n+p*i*u-e*m*u-l*i*f+e*c*f)*w,t[14]=(p*a*n-r*m*n-p*i*o+e*m*o+r*i*f-e*a*f)*w,t[15]=(r*c*n-l*a*n+l*i*o-e*c*o-r*i*u+e*a*u)*w,this}scale(t){const e=this.elements,i=t.x,n=t.y,s=t.z;return e[0]*=i,e[4]*=n,e[8]*=s,e[1]*=i,e[5]*=n,e[9]*=s,e[2]*=i,e[6]*=n,e[10]*=s,e[3]*=i,e[7]*=n,e[11]*=s,this}getMaxScaleOnAxis(){const t=this.elements,e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],i=t[4]*t[4]+t[5]*t[5]+t[6]*t[6],n=t[8]*t[8]+t[9]*t[9]+t[10]*t[10];return Math.sqrt(Math.max(e,i,n))}makeTranslation(t,e,i){return t.isVector3?this.set(1,0,0,t.x,0,1,0,t.y,0,0,1,t.z,0,0,0,1):this.set(1,0,0,t,0,1,0,e,0,0,1,i,0,0,0,1),this}makeRotationX(t){const e=Math.cos(t),i=Math.sin(t);return this.set(1,0,0,0,0,e,-i,0,0,i,e,0,0,0,0,1),this}makeRotationY(t){const e=Math.cos(t),i=Math.sin(t);return this.set(e,0,i,0,0,1,0,0,-i,0,e,0,0,0,0,1),this}makeRotationZ(t){const e=Math.cos(t),i=Math.sin(t);return this.set(e,-i,0,0,i,e,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(t,e){const i=Math.cos(e),n=Math.sin(e),s=1-i,r=t.x,a=t.y,o=t.z,h=s*r,l=s*a;return this.set(h*r+i,h*a-n*o,h*o+n*a,0,h*a+n*o,l*a+i,l*o-n*r,0,h*o-n*a,l*o+n*r,s*o*o+i,0,0,0,0,1),this}makeScale(t,e,i){return this.set(t,0,0,0,0,e,0,0,0,0,i,0,0,0,0,1),this}makeShear(t,e,i,n,s,r){return this.set(1,i,s,0,t,1,r,0,e,n,1,0,0,0,0,1),this}compose(t,e,i){const n=this.elements,s=e._x,r=e._y,a=e._z,o=e._w,h=s+s,l=r+r,c=a+a,u=s*h,d=s*l,p=s*c,m=r*l,f=r*c,g=a*c,v=o*h,y=o*l,x=o*c,b=i.x,_=i.y,w=i.z;return n[0]=(1-(m+g))*b,n[1]=(d+x)*b,n[2]=(p-y)*b,n[3]=0,n[4]=(d-x)*_,n[5]=(1-(u+g))*_,n[6]=(f+v)*_,n[7]=0,n[8]=(p+y)*w,n[9]=(f-v)*w,n[10]=(1-(u+m))*w,n[11]=0,n[12]=t.x,n[13]=t.y,n[14]=t.z,n[15]=1,this}decompose(t,e,i){const n=this.elements;let s=ui.set(n[0],n[1],n[2]).length();const r=ui.set(n[4],n[5],n[6]).length(),a=ui.set(n[8],n[9],n[10]).length();this.determinant()<0&&(s=-s),t.x=n[12],t.y=n[13],t.z=n[14],di.copy(this);const o=1/s,h=1/r,l=1/a;return di.elements[0]*=o,di.elements[1]*=o,di.elements[2]*=o,di.elements[4]*=h,di.elements[5]*=h,di.elements[6]*=h,di.elements[8]*=l,di.elements[9]*=l,di.elements[10]*=l,e.setFromRotationMatrix(di),i.x=s,i.y=r,i.z=a,this}makePerspective(t,e,i,n,s,r,a=2e3){const o=this.elements,h=2*s/(e-t),l=2*s/(i-n),c=(e+t)/(e-t),u=(i+n)/(i-n);let d,p;if(a===Vt)d=-(r+s)/(r-s),p=-2*r*s/(r-s);else{if(a!==Ht)throw new Error("THREE.Matrix4.makePerspective(): Invalid coordinate system: "+a);d=-r/(r-s),p=-r*s/(r-s)}return o[0]=h,o[4]=0,o[8]=c,o[12]=0,o[1]=0,o[5]=l,o[9]=u,o[13]=0,o[2]=0,o[6]=0,o[10]=d,o[14]=p,o[3]=0,o[7]=0,o[11]=-1,o[15]=0,this}makeOrthographic(t,e,i,n,s,r,a=2e3){const o=this.elements,h=1/(e-t),l=1/(i-n),c=1/(r-s),u=(e+t)*h,d=(i+n)*l;let p,m;if(a===Vt)p=(r+s)*c,m=-2*c;else{if(a!==Ht)throw new Error("THREE.Matrix4.makeOrthographic(): Invalid coordinate system: "+a);p=s*c,m=-1*c}return o[0]=2*h,o[4]=0,o[8]=0,o[12]=-u,o[1]=0,o[5]=2*l,o[9]=0,o[13]=-d,o[2]=0,o[6]=0,o[10]=m,o[14]=-p,o[3]=0,o[7]=0,o[11]=0,o[15]=1,this}equals(t){const e=this.elements,i=t.elements;for(let t=0;t<16;t++)if(e[t]!==i[t])return!1;return!0}fromArray(t,e=0){for(let i=0;i<16;i++)this.elements[i]=t[i+e];return this}toArray(t=[],e=0){const i=this.elements;return t[e]=i[0],t[e+1]=i[1],t[e+2]=i[2],t[e+3]=i[3],t[e+4]=i[4],t[e+5]=i[5],t[e+6]=i[6],t[e+7]=i[7],t[e+8]=i[8],t[e+9]=i[9],t[e+10]=i[10],t[e+11]=i[11],t[e+12]=i[12],t[e+13]=i[13],t[e+14]=i[14],t[e+15]=i[15],t}}const ui=new Le,di=new ci,pi=new Le(0,0,0),mi=new Le(1,1,1),fi=new Le,gi=new Le,vi=new Le,yi=new ci,xi=new De;class bi{constructor(t=0,e=0,i=0,n=bi.DEFAULT_ORDER){this.isEuler=!0,this._x=t,this._y=e,this._z=i,this._order=n}get x(){return this._x}set x(t){this._x=t,this._onChangeCallback()}get y(){return this._y}set y(t){this._y=t,this._onChangeCallback()}get z(){return this._z}set z(t){this._z=t,this._onChangeCallback()}get order(){return this._order}set order(t){this._order=t,this._onChangeCallback()}set(t,e,i,n=this._order){return this._x=t,this._y=e,this._z=i,this._order=n,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(t){return this._x=t._x,this._y=t._y,this._z=t._z,this._order=t._order,this._onChangeCallback(),this}setFromRotationMatrix(t,e=this._order,i=!0){const n=t.elements,s=n[0],r=n[4],a=n[8],o=n[1],h=n[5],l=n[9],c=n[2],u=n[6],d=n[10];switch(e){case"XYZ":this._y=Math.asin($t(a,-1,1)),Math.abs(a)<.9999999?(this._x=Math.atan2(-l,d),this._z=Math.atan2(-r,s)):(this._x=Math.atan2(u,h),this._z=0);break;case"YXZ":this._x=Math.asin(-$t(l,-1,1)),Math.abs(l)<.9999999?(this._y=Math.atan2(a,d),this._z=Math.atan2(o,h)):(this._y=Math.atan2(-c,s),this._z=0);break;case"ZXY":this._x=Math.asin($t(u,-1,1)),Math.abs(u)<.9999999?(this._y=Math.atan2(-c,d),this._z=Math.atan2(-r,h)):(this._y=0,this._z=Math.atan2(o,s));break;case"ZYX":this._y=Math.asin(-$t(c,-1,1)),Math.abs(c)<.9999999?(this._x=Math.atan2(u,d),this._z=Math.atan2(o,s)):(this._x=0,this._z=Math.atan2(-r,h));break;case"YZX":this._z=Math.asin($t(o,-1,1)),Math.abs(o)<.9999999?(this._x=Math.atan2(-l,h),this._y=Math.atan2(-c,s)):(this._x=0,this._y=Math.atan2(a,d));break;case"XZY":this._z=Math.asin(-$t(r,-1,1)),Math.abs(r)<.9999999?(this._x=Math.atan2(u,h),this._y=Math.atan2(a,s)):(this._x=Math.atan2(-l,d),this._y=0)}return this._order=e,!0===i&&this._onChangeCallback(),this}setFromQuaternion(t,e,i){return yi.makeRotationFromQuaternion(t),this.setFromRotationMatrix(yi,e,i)}setFromVector3(t,e=this._order){return this.set(t.x,t.y,t.z,e)}reorder(t){return xi.setFromEuler(this),this.setFromQuaternion(xi,t)}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._order===this._order}fromArray(t){return this._x=t[0],this._y=t[1],this._z=t[2],void 0!==t[3]&&(this._order=t[3]),this._onChangeCallback(),this}toArray(t=[],e=0){return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._order,t}_onChange(t){return this._onChangeCallback=t,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._order}}bi.DEFAULT_ORDER="XYZ";class _i{constructor(){this.mask=1}set(t){this.mask=(1<<t|0)>>>0}enable(t){this.mask|=1<<t|0}enableAll(){this.mask=-1}toggle(t){this.mask^=1<<t|0}disable(t){this.mask&=~(1<<t|0)}disableAll(){this.mask=0}test(t){return 0!=(this.mask&t.mask)}isEnabled(t){return 0!=(this.mask&(1<<t|0))}}let wi=0;const Mi=new Le,Si=new De,Ei=new ci,Ti=new Le,Ai=new Le,Ci=new Le,Ii=new De,Ri=new Le(1,0,0),ki=new Le(0,1,0),Pi=new Le(0,0,1),Di={type:"added"},Li={type:"removed"};class Oi extends jt{constructor(){super(),this.isObject3D=!0,Object.defineProperty(this,"id",{value:wi++}),this.uuid=Jt(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=Oi.DEFAULT_UP.clone();const t=new Le,e=new bi,i=new De,n=new Le(1,1,1);e._onChange((function(){i.setFromEuler(e,!1)})),i._onChange((function(){e.setFromQuaternion(i,void 0,!1)})),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:t},rotation:{configurable:!0,enumerable:!0,value:e},quaternion:{configurable:!0,enumerable:!0,value:i},scale:{configurable:!0,enumerable:!0,value:n},modelViewMatrix:{value:new ci},normalMatrix:{value:new re}}),this.matrix=new ci,this.matrixWorld=new ci,this.matrixAutoUpdate=Oi.DEFAULT_MATRIX_AUTO_UPDATE,this.matrixWorldAutoUpdate=Oi.DEFAULT_MATRIX_WORLD_AUTO_UPDATE,this.matrixWorldNeedsUpdate=!1,this.layers=new _i,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.userData={}}onBeforeShadow(){}onAfterShadow(){}onBeforeRender(){}onAfterRender(){}applyMatrix4(t){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(t),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(t){return this.quaternion.premultiply(t),this}setRotationFromAxisAngle(t,e){this.quaternion.setFromAxisAngle(t,e)}setRotationFromEuler(t){this.quaternion.setFromEuler(t,!0)}setRotationFromMatrix(t){this.quaternion.setFromRotationMatrix(t)}setRotationFromQuaternion(t){this.quaternion.copy(t)}rotateOnAxis(t,e){return Si.setFromAxisAngle(t,e),this.quaternion.multiply(Si),this}rotateOnWorldAxis(t,e){return Si.setFromAxisAngle(t,e),this.quaternion.premultiply(Si),this}rotateX(t){return this.rotateOnAxis(Ri,t)}rotateY(t){return this.rotateOnAxis(ki,t)}rotateZ(t){return this.rotateOnAxis(Pi,t)}translateOnAxis(t,e){return Mi.copy(t).applyQuaternion(this.quaternion),this.position.add(Mi.multiplyScalar(e)),this}translateX(t){return this.translateOnAxis(Ri,t)}translateY(t){return this.translateOnAxis(ki,t)}translateZ(t){return this.translateOnAxis(Pi,t)}localToWorld(t){return this.updateWorldMatrix(!0,!1),t.applyMatrix4(this.matrixWorld)}worldToLocal(t){return this.updateWorldMatrix(!0,!1),t.applyMatrix4(Ei.copy(this.matrixWorld).invert())}lookAt(t,e,i){t.isVector3?Ti.copy(t):Ti.set(t,e,i);const n=this.parent;this.updateWorldMatrix(!0,!1),Ai.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?Ei.lookAt(Ai,Ti,this.up):Ei.lookAt(Ti,Ai,this.up),this.quaternion.setFromRotationMatrix(Ei),n&&(Ei.extractRotation(n.matrixWorld),Si.setFromRotationMatrix(Ei),this.quaternion.premultiply(Si.invert()))}add(t){if(arguments.length>1){for(let t=0;t<arguments.length;t++)this.add(arguments[t]);return this}return t===this||t&&t.isObject3D&&(null!==t.parent&&t.parent.remove(t),t.parent=this,this.children.push(t),t.dispatchEvent(Di)),this}remove(t){if(arguments.length>1){for(let t=0;t<arguments.length;t++)this.remove(arguments[t]);return this}const e=this.children.indexOf(t);return-1!==e&&(t.parent=null,this.children.splice(e,1),t.dispatchEvent(Li)),this}removeFromParent(){const t=this.parent;return null!==t&&t.remove(this),this}clear(){return this.remove(...this.children)}attach(t){return this.updateWorldMatrix(!0,!1),Ei.copy(this.matrixWorld).invert(),null!==t.parent&&(t.parent.updateWorldMatrix(!0,!1),Ei.multiply(t.parent.matrixWorld)),t.applyMatrix4(Ei),this.add(t),t.updateWorldMatrix(!1,!0),this}getObjectById(t){return this.getObjectByProperty("id",t)}getObjectByName(t){return this.getObjectByProperty("name",t)}getObjectByProperty(t,e){if(this[t]===e)return this;for(let i=0,n=this.children.length;i<n;i++){const n=this.children[i].getObjectByProperty(t,e);if(void 0!==n)return n}}getObjectsByProperty(t,e,i=[]){this[t]===e&&i.push(this);const n=this.children;for(let s=0,r=n.length;s<r;s++)n[s].getObjectsByProperty(t,e,i);return i}getWorldPosition(t){return this.updateWorldMatrix(!0,!1),t.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(t){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(Ai,t,Ci),t}getWorldScale(t){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(Ai,Ii,t),t}getWorldDirection(t){this.updateWorldMatrix(!0,!1);const e=this.matrixWorld.elements;return t.set(e[8],e[9],e[10]).normalize()}raycast(){}traverse(t){t(this);const e=this.children;for(let i=0,n=e.length;i<n;i++)e[i].traverse(t)}traverseVisible(t){if(!1===this.visible)return;t(this);const e=this.children;for(let i=0,n=e.length;i<n;i++)e[i].traverseVisible(t)}traverseAncestors(t){const e=this.parent;null!==e&&(t(e),e.traverseAncestors(t))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(t){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||t)&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,t=!0);const e=this.children;for(let i=0,n=e.length;i<n;i++){const n=e[i];!0!==n.matrixWorldAutoUpdate&&!0!==t||n.updateMatrixWorld(t)}}updateWorldMatrix(t,e){const i=this.parent;if(!0===t&&null!==i&&!0===i.matrixWorldAutoUpdate&&i.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),!0===e){const t=this.children;for(let e=0,i=t.length;e<i;e++){const i=t[e];!0===i.matrixWorldAutoUpdate&&i.updateWorldMatrix(!1,!0)}}}toJSON(t){const e=void 0===t||"string"==typeof t,i={};e&&(t={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},i.metadata={version:4.6,type:"Object",generator:"Object3D.toJSON"});const n={};function s(e,i){return void 0===e[i.uuid]&&(e[i.uuid]=i.toJSON(t)),i.uuid}if(n.uuid=this.uuid,n.type=this.type,""!==this.name&&(n.name=this.name),!0===this.castShadow&&(n.castShadow=!0),!0===this.receiveShadow&&(n.receiveShadow=!0),!1===this.visible&&(n.visible=!1),!1===this.frustumCulled&&(n.frustumCulled=!1),0!==this.renderOrder&&(n.renderOrder=this.renderOrder),Object.keys(this.userData).length>0&&(n.userData=this.userData),n.layers=this.layers.mask,n.matrix=this.matrix.toArray(),n.up=this.up.toArray(),!1===this.matrixAutoUpdate&&(n.matrixAutoUpdate=!1),this.isInstancedMesh&&(n.type="InstancedMesh",n.count=this.count,n.instanceMatrix=this.instanceMatrix.toJSON(),null!==this.instanceColor&&(n.instanceColor=this.instanceColor.toJSON())),this.isBatchedMesh&&(n.type="BatchedMesh",n.perObjectFrustumCulled=this.perObjectFrustumCulled,n.sortObjects=this.sortObjects,n.drawRanges=this._drawRanges,n.reservedRanges=this._reservedRanges,n.visibility=this._visibility,n.active=this._active,n.bounds=this._bounds.map((t=>({boxInitialized:t.boxInitialized,boxMin:t.box.min.toArray(),boxMax:t.box.max.toArray(),sphereInitialized:t.sphereInitialized,sphereRadius:t.sphere.radius,sphereCenter:t.sphere.center.toArray()}))),n.maxGeometryCount=this._maxGeometryCount,n.maxVertexCount=this._maxVertexCount,n.maxIndexCount=this._maxIndexCount,n.geometryInitialized=this._geometryInitialized,n.geometryCount=this._geometryCount,n.matricesTexture=this._matricesTexture.toJSON(t),null!==this.boundingSphere&&(n.boundingSphere={center:n.boundingSphere.center.toArray(),radius:n.boundingSphere.radius}),null!==this.boundingBox&&(n.boundingBox={min:n.boundingBox.min.toArray(),max:n.boundingBox.max.toArray()})),this.isScene)this.background&&(this.background.isColor?n.background=this.background.toJSON():this.background.isTexture&&(n.background=this.background.toJSON(t).uuid)),this.environment&&this.environment.isTexture&&!0!==this.environment.isRenderTargetTexture&&(n.environment=this.environment.toJSON(t).uuid);else if(this.isMesh||this.isLine||this.isPoints){n.geometry=s(t.geometries,this.geometry);const e=this.geometry.parameters;if(void 0!==e&&void 0!==e.shapes){const i=e.shapes;if(Array.isArray(i))for(let e=0,n=i.length;e<n;e++){const n=i[e];s(t.shapes,n)}else s(t.shapes,i)}}if(this.isSkinnedMesh&&(n.bindMode=this.bindMode,n.bindMatrix=this.bindMatrix.toArray(),void 0!==this.skeleton&&(s(t.skeletons,this.skeleton),n.skeleton=this.skeleton.uuid)),void 0!==this.material)if(Array.isArray(this.material)){const e=[];for(let i=0,n=this.material.length;i<n;i++)e.push(s(t.materials,this.material[i]));n.material=e}else n.material=s(t.materials,this.material);if(this.children.length>0){n.children=[];for(let e=0;e<this.children.length;e++)n.children.push(this.children[e].toJSON(t).object)}if(this.animations.length>0){n.animations=[];for(let e=0;e<this.animations.length;e++){const i=this.animations[e];n.animations.push(s(t.animations,i))}}if(e){const e=r(t.geometries),n=r(t.materials),s=r(t.textures),a=r(t.images),o=r(t.shapes),h=r(t.skeletons),l=r(t.animations),c=r(t.nodes);e.length>0&&(i.geometries=e),n.length>0&&(i.materials=n),s.length>0&&(i.textures=s),a.length>0&&(i.images=a),o.length>0&&(i.shapes=o),h.length>0&&(i.skeletons=h),l.length>0&&(i.animations=l),c.length>0&&(i.nodes=c)}return i.object=n,i;function r(t){const e=[];for(const i in t){const n=t[i];delete n.metadata,e.push(n)}return e}}clone(t){return(new this.constructor).copy(this,t)}copy(t,e=!0){if(this.name=t.name,this.up.copy(t.up),this.position.copy(t.position),this.rotation.order=t.rotation.order,this.quaternion.copy(t.quaternion),this.scale.copy(t.scale),this.matrix.copy(t.matrix),this.matrixWorld.copy(t.matrixWorld),this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrixWorldAutoUpdate=t.matrixWorldAutoUpdate,this.matrixWorldNeedsUpdate=t.matrixWorldNeedsUpdate,this.layers.mask=t.layers.mask,this.visible=t.visible,this.castShadow=t.castShadow,this.receiveShadow=t.receiveShadow,this.frustumCulled=t.frustumCulled,this.renderOrder=t.renderOrder,this.animations=t.animations.slice(),this.userData=JSON.parse(JSON.stringify(t.userData)),!0===e)for(let e=0;e<t.children.length;e++){const i=t.children[e];this.add(i.clone())}return this}}Oi.DEFAULT_UP=new Le(0,1,0),Oi.DEFAULT_MATRIX_AUTO_UPDATE=!0,Oi.DEFAULT_MATRIX_WORLD_AUTO_UPDATE=!0;const Ni=new Le,Bi=new Le,zi=new Le,Ui=new Le,Fi=new Le,Gi=new Le,Vi=new Le,Hi=new Le,ji=new Le,Wi=new Le;let Xi=!1;class qi{constructor(t=new Le,e=new Le,i=new Le){this.a=t,this.b=e,this.c=i}static getNormal(t,e,i,n){n.subVectors(i,e),Ni.subVectors(t,e),n.cross(Ni);const s=n.lengthSq();return s>0?n.multiplyScalar(1/Math.sqrt(s)):n.set(0,0,0)}static getBarycoord(t,e,i,n,s){Ni.subVectors(n,e),Bi.subVectors(i,e),zi.subVectors(t,e);const r=Ni.dot(Ni),a=Ni.dot(Bi),o=Ni.dot(zi),h=Bi.dot(Bi),l=Bi.dot(zi),c=r*h-a*a;if(0===c)return s.set(0,0,0),null;const u=1/c,d=(h*o-a*l)*u,p=(r*l-a*o)*u;return s.set(1-d-p,p,d)}static containsPoint(t,e,i,n){return null!==this.getBarycoord(t,e,i,n,Ui)&&(Ui.x>=0&&Ui.y>=0&&Ui.x+Ui.y<=1)}static getUV(t,e,i,n,s,r,a,o){return!1===Xi&&(Xi=!0),this.getInterpolation(t,e,i,n,s,r,a,o)}static getInterpolation(t,e,i,n,s,r,a,o){return null===this.getBarycoord(t,e,i,n,Ui)?(o.x=0,o.y=0,"z"in o&&(o.z=0),"w"in o&&(o.w=0),null):(o.setScalar(0),o.addScaledVector(s,Ui.x),o.addScaledVector(r,Ui.y),o.addScaledVector(a,Ui.z),o)}static isFrontFacing(t,e,i,n){return Ni.subVectors(i,e),Bi.subVectors(t,e),Ni.cross(Bi).dot(n)<0}set(t,e,i){return this.a.copy(t),this.b.copy(e),this.c.copy(i),this}setFromPointsAndIndices(t,e,i,n){return this.a.copy(t[e]),this.b.copy(t[i]),this.c.copy(t[n]),this}setFromAttributeAndIndices(t,e,i,n){return this.a.fromBufferAttribute(t,e),this.b.fromBufferAttribute(t,i),this.c.fromBufferAttribute(t,n),this}clone(){return(new this.constructor).copy(this)}copy(t){return this.a.copy(t.a),this.b.copy(t.b),this.c.copy(t.c),this}getArea(){return Ni.subVectors(this.c,this.b),Bi.subVectors(this.a,this.b),.5*Ni.cross(Bi).length()}getMidpoint(t){return t.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(t){return qi.getNormal(this.a,this.b,this.c,t)}getPlane(t){return t.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(t,e){return qi.getBarycoord(t,this.a,this.b,this.c,e)}getUV(t,e,i,n,s){return!1===Xi&&(Xi=!0),qi.getInterpolation(t,this.a,this.b,this.c,e,i,n,s)}getInterpolation(t,e,i,n,s){return qi.getInterpolation(t,this.a,this.b,this.c,e,i,n,s)}containsPoint(t){return qi.containsPoint(t,this.a,this.b,this.c)}isFrontFacing(t){return qi.isFrontFacing(this.a,this.b,this.c,t)}intersectsBox(t){return t.intersectsTriangle(this)}closestPointToPoint(t,e){const i=this.a,n=this.b,s=this.c;let r,a;Fi.subVectors(n,i),Gi.subVectors(s,i),Hi.subVectors(t,i);const o=Fi.dot(Hi),h=Gi.dot(Hi);if(o<=0&&h<=0)return e.copy(i);ji.subVectors(t,n);const l=Fi.dot(ji),c=Gi.dot(ji);if(l>=0&&c<=l)return e.copy(n);const u=o*c-l*h;if(u<=0&&o>=0&&l<=0)return r=o/(o-l),e.copy(i).addScaledVector(Fi,r);Wi.subVectors(t,s);const d=Fi.dot(Wi),p=Gi.dot(Wi);if(p>=0&&d<=p)return e.copy(s);const m=d*h-o*p;if(m<=0&&h>=0&&p<=0)return a=h/(h-p),e.copy(i).addScaledVector(Gi,a);const f=l*p-d*c;if(f<=0&&c-l>=0&&d-p>=0)return Vi.subVectors(s,n),a=(c-l)/(c-l+(d-p)),e.copy(n).addScaledVector(Vi,a);const g=1/(f+m+u);return r=m*g,a=u*g,e.copy(i).addScaledVector(Fi,r).addScaledVector(Gi,a)}equals(t){return t.a.equals(this.a)&&t.b.equals(this.b)&&t.c.equals(this.c)}}const Yi={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},Ji={h:0,s:0,l:0},$i={h:0,s:0,l:0};function Ki(t,e,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?t+6*(e-t)*i:i<.5?e:i<2/3?t+6*(e-t)*(2/3-i):t}class Zi{constructor(t,e,i){return this.isColor=!0,this.r=1,this.g=1,this.b=1,this.set(t,e,i)}set(t,e,i){if(void 0===e&&void 0===i){const e=t;e&&e.isColor?this.copy(e):"number"==typeof e?this.setHex(e):"string"==typeof e&&this.setStyle(e)}else this.setRGB(t,e,i);return this}setScalar(t){return this.r=t,this.g=t,this.b=t,this}setHex(t,e=It){return t=Math.floor(t),this.r=(t>>16&255)/255,this.g=(t>>8&255)/255,this.b=(255&t)/255,ye.toWorkingColorSpace(this,e),this}setRGB(t,e,i,n=ye.workingColorSpace){return this.r=t,this.g=e,this.b=i,ye.toWorkingColorSpace(this,n),this}setHSL(t,e,i,n=ye.workingColorSpace){if(t=Kt(t,1),e=$t(e,0,1),i=$t(i,0,1),0===e)this.r=this.g=this.b=i;else{const n=i<=.5?i*(1+e):i+e-i*e,s=2*i-n;this.r=Ki(s,n,t+1/3),this.g=Ki(s,n,t),this.b=Ki(s,n,t-1/3)}return ye.toWorkingColorSpace(this,n),this}setStyle(t,e=It){function i(t){void 0!==t&&parseFloat(t)}let n;if(n=/^(\w+)\(([^\)]*)\)/.exec(t)){let t;const s=n[1],r=n[2];switch(s){case"rgb":case"rgba":if(t=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(r))return i(t[4]),this.setRGB(Math.min(255,parseInt(t[1],10))/255,Math.min(255,parseInt(t[2],10))/255,Math.min(255,parseInt(t[3],10))/255,e);if(t=/^\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(r))return i(t[4]),this.setRGB(Math.min(100,parseInt(t[1],10))/100,Math.min(100,parseInt(t[2],10))/100,Math.min(100,parseInt(t[3],10))/100,e);break;case"hsl":case"hsla":if(t=/^\s*(\d*\.?\d+)\s*,\s*(\d*\.?\d+)\%\s*,\s*(\d*\.?\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(r))return i(t[4]),this.setHSL(parseFloat(t[1])/360,parseFloat(t[2])/100,parseFloat(t[3])/100,e)}}else if(n=/^\#([A-Fa-f\d]+)$/.exec(t)){const t=n[1],i=t.length;if(3===i)return this.setRGB(parseInt(t.charAt(0),16)/15,parseInt(t.charAt(1),16)/15,parseInt(t.charAt(2),16)/15,e);if(6===i)return this.setHex(parseInt(t,16),e)}else if(t&&t.length>0)return this.setColorName(t,e);return this}setColorName(t,e=It){const i=Yi[t.toLowerCase()];return void 0!==i&&this.setHex(i,e),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(t){return this.r=t.r,this.g=t.g,this.b=t.b,this}copySRGBToLinear(t){return this.r=xe(t.r),this.g=xe(t.g),this.b=xe(t.b),this}copyLinearToSRGB(t){return this.r=be(t.r),this.g=be(t.g),this.b=be(t.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(t=It){return ye.fromWorkingColorSpace(Qi.copy(this),t),65536*Math.round($t(255*Qi.r,0,255))+256*Math.round($t(255*Qi.g,0,255))+Math.round($t(255*Qi.b,0,255))}getHexString(t=It){return("000000"+this.getHex(t).toString(16)).slice(-6)}getHSL(t,e=ye.workingColorSpace){ye.fromWorkingColorSpace(Qi.copy(this),e);const i=Qi.r,n=Qi.g,s=Qi.b,r=Math.max(i,n,s),a=Math.min(i,n,s);let o,h;const l=(a+r)/2;if(a===r)o=0,h=0;else{const t=r-a;switch(h=l<=.5?t/(r+a):t/(2-r-a),r){case i:o=(n-s)/t+(n<s?6:0);break;case n:o=(s-i)/t+2;break;case s:o=(i-n)/t+4}o/=6}return t.h=o,t.s=h,t.l=l,t}getRGB(t,e=ye.workingColorSpace){return ye.fromWorkingColorSpace(Qi.copy(this),e),t.r=Qi.r,t.g=Qi.g,t.b=Qi.b,t}getStyle(t=It){ye.fromWorkingColorSpace(Qi.copy(this),t);const e=Qi.r,i=Qi.g,n=Qi.b;return t!==It?`color(${t} ${e.toFixed(3)} ${i.toFixed(3)} ${n.toFixed(3)})`:`rgb(${Math.round(255*e)},${Math.round(255*i)},${Math.round(255*n)})`}offsetHSL(t,e,i){return this.getHSL(Ji),this.setHSL(Ji.h+t,Ji.s+e,Ji.l+i)}add(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this}addColors(t,e){return this.r=t.r+e.r,this.g=t.g+e.g,this.b=t.b+e.b,this}addScalar(t){return this.r+=t,this.g+=t,this.b+=t,this}sub(t){return this.r=Math.max(0,this.r-t.r),this.g=Math.max(0,this.g-t.g),this.b=Math.max(0,this.b-t.b),this}multiply(t){return this.r*=t.r,this.g*=t.g,this.b*=t.b,this}multiplyScalar(t){return this.r*=t,this.g*=t,this.b*=t,this}lerp(t,e){return this.r+=(t.r-this.r)*e,this.g+=(t.g-this.g)*e,this.b+=(t.b-this.b)*e,this}lerpColors(t,e,i){return this.r=t.r+(e.r-t.r)*i,this.g=t.g+(e.g-t.g)*i,this.b=t.b+(e.b-t.b)*i,this}lerpHSL(t,e){this.getHSL(Ji),t.getHSL($i);const i=Zt(Ji.h,$i.h,e),n=Zt(Ji.s,$i.s,e),s=Zt(Ji.l,$i.l,e);return this.setHSL(i,n,s),this}setFromVector3(t){return this.r=t.x,this.g=t.y,this.b=t.z,this}applyMatrix3(t){const e=this.r,i=this.g,n=this.b,s=t.elements;return this.r=s[0]*e+s[3]*i+s[6]*n,this.g=s[1]*e+s[4]*i+s[7]*n,this.b=s[2]*e+s[5]*i+s[8]*n,this}equals(t){return t.r===this.r&&t.g===this.g&&t.b===this.b}fromArray(t,e=0){return this.r=t[e],this.g=t[e+1],this.b=t[e+2],this}toArray(t=[],e=0){return t[e]=this.r,t[e+1]=this.g,t[e+2]=this.b,t}fromBufferAttribute(t,e){return this.r=t.getX(e),this.g=t.getY(e),this.b=t.getZ(e),this}toJSON(){return this.getHex()}*[Symbol.iterator](){yield this.r,yield this.g,yield this.b}}const Qi=new Zi;Zi.NAMES=Yi;let tn=0;class en extends jt{constructor(){super(),this.isMaterial=!0,Object.defineProperty(this,"id",{value:tn++}),this.uuid=Jt(),this.name="",this.type="Material",this.blending=1,this.side=I,this.vertexColors=!1,this.opacity=1,this.transparent=!1,this.alphaHash=!1,this.blendSrc=204,this.blendDst=205,this.blendEquation=k,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.blendColor=new Zi(0,0,0),this.blendAlpha=0,this.depthFunc=3,this.depthTest=!0,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilFunc=519,this.stencilRef=0,this.stencilFuncMask=255,this.stencilFail=Bt,this.stencilZFail=Bt,this.stencilZPass=Bt,this.stencilWrite=!1,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaToCoverage=!1,this.premultipliedAlpha=!1,this.forceSinglePass=!1,this.visible=!0,this.toneMapped=!0,this.userData={},this.version=0,this._alphaTest=0}get alphaTest(){return this._alphaTest}set alphaTest(t){this._alphaTest>0!=t>0&&this.version++,this._alphaTest=t}onBuild(){}onBeforeRender(){}onBeforeCompile(){}customProgramCacheKey(){return this.onBeforeCompile.toString()}setValues(t){if(void 0!==t)for(const e in t){const i=t[e];if(void 0===i)continue;const n=this[e];void 0!==n&&(n&&n.isColor?n.set(i):n&&n.isVector3&&i&&i.isVector3?n.copy(i):this[e]=i)}}toJSON(t){const e=void 0===t||"string"==typeof t;e&&(t={textures:{},images:{}});const i={metadata:{version:4.6,type:"Material",generator:"Material.toJSON"}};function n(t){const e=[];for(const i in t){const n=t[i];delete n.metadata,e.push(n)}return e}if(i.uuid=this.uuid,i.type=this.type,""!==this.name&&(i.name=this.name),this.color&&this.color.isColor&&(i.color=this.color.getHex()),void 0!==this.roughness&&(i.roughness=this.roughness),void 0!==this.metalness&&(i.metalness=this.metalness),void 0!==this.sheen&&(i.sheen=this.sheen),this.sheenColor&&this.sheenColor.isColor&&(i.sheenColor=this.sheenColor.getHex()),void 0!==this.sheenRoughness&&(i.sheenRoughness=this.sheenRoughness),this.emissive&&this.emissive.isColor&&(i.emissive=this.emissive.getHex()),this.emissiveIntensity&&1!==this.emissiveIntensity&&(i.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(i.specular=this.specular.getHex()),void 0!==this.specularIntensity&&(i.specularIntensity=this.specularIntensity),this.specularColor&&this.specularColor.isColor&&(i.specularColor=this.specularColor.getHex()),void 0!==this.shininess&&(i.shininess=this.shininess),void 0!==this.clearcoat&&(i.clearcoat=this.clearcoat),void 0!==this.clearcoatRoughness&&(i.clearcoatRoughness=this.clearcoatRoughness),this.clearcoatMap&&this.clearcoatMap.isTexture&&(i.clearcoatMap=this.clearcoatMap.toJSON(t).uuid),this.clearcoatRoughnessMap&&this.clearcoatRoughnessMap.isTexture&&(i.clearcoatRoughnessMap=this.clearcoatRoughnessMap.toJSON(t).uuid),this.clearcoatNormalMap&&this.clearcoatNormalMap.isTexture&&(i.clearcoatNormalMap=this.clearcoatNormalMap.toJSON(t).uuid,i.clearcoatNormalScale=this.clearcoatNormalScale.toArray()),void 0!==this.iridescence&&(i.iridescence=this.iridescence),void 0!==this.iridescenceIOR&&(i.iridescenceIOR=this.iridescenceIOR),void 0!==this.iridescenceThicknessRange&&(i.iridescenceThicknessRange=this.iridescenceThicknessRange),this.iridescenceMap&&this.iridescenceMap.isTexture&&(i.iridescenceMap=this.iridescenceMap.toJSON(t).uuid),this.iridescenceThicknessMap&&this.iridescenceThicknessMap.isTexture&&(i.iridescenceThicknessMap=this.iridescenceThicknessMap.toJSON(t).uuid),void 0!==this.anisotropy&&(i.anisotropy=this.anisotropy),void 0!==this.anisotropyRotation&&(i.anisotropyRotation=this.anisotropyRotation),this.anisotropyMap&&this.anisotropyMap.isTexture&&(i.anisotropyMap=this.anisotropyMap.toJSON(t).uuid),this.map&&this.map.isTexture&&(i.map=this.map.toJSON(t).uuid),this.matcap&&this.matcap.isTexture&&(i.matcap=this.matcap.toJSON(t).uuid),this.alphaMap&&this.alphaMap.isTexture&&(i.alphaMap=this.alphaMap.toJSON(t).uuid),this.lightMap&&this.lightMap.isTexture&&(i.lightMap=this.lightMap.toJSON(t).uuid,i.lightMapIntensity=this.lightMapIntensity),this.aoMap&&this.aoMap.isTexture&&(i.aoMap=this.aoMap.toJSON(t).uuid,i.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(i.bumpMap=this.bumpMap.toJSON(t).uuid,i.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(i.normalMap=this.normalMap.toJSON(t).uuid,i.normalMapType=this.normalMapType,i.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(i.displacementMap=this.displacementMap.toJSON(t).uuid,i.displacementScale=this.displacementScale,i.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(i.roughnessMap=this.roughnessMap.toJSON(t).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(i.metalnessMap=this.metalnessMap.toJSON(t).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(i.emissiveMap=this.emissiveMap.toJSON(t).uuid),this.specularMap&&this.specularMap.isTexture&&(i.specularMap=this.specularMap.toJSON(t).uuid),this.specularIntensityMap&&this.specularIntensityMap.isTexture&&(i.specularIntensityMap=this.specularIntensityMap.toJSON(t).uuid),this.specularColorMap&&this.specularColorMap.isTexture&&(i.specularColorMap=this.specularColorMap.toJSON(t).uuid),this.envMap&&this.envMap.isTexture&&(i.envMap=this.envMap.toJSON(t).uuid,void 0!==this.combine&&(i.combine=this.combine)),void 0!==this.envMapIntensity&&(i.envMapIntensity=this.envMapIntensity),void 0!==this.reflectivity&&(i.reflectivity=this.reflectivity),void 0!==this.refractionRatio&&(i.refractionRatio=this.refractionRatio),this.gradientMap&&this.gradientMap.isTexture&&(i.gradientMap=this.gradientMap.toJSON(t).uuid),void 0!==this.transmission&&(i.transmission=this.transmission),this.transmissionMap&&this.transmissionMap.isTexture&&(i.transmissionMap=this.transmissionMap.toJSON(t).uuid),void 0!==this.thickness&&(i.thickness=this.thickness),this.thicknessMap&&this.thicknessMap.isTexture&&(i.thicknessMap=this.thicknessMap.toJSON(t).uuid),void 0!==this.attenuationDistance&&this.attenuationDistance!==1/0&&(i.attenuationDistance=this.attenuationDistance),void 0!==this.attenuationColor&&(i.attenuationColor=this.attenuationColor.getHex()),void 0!==this.size&&(i.size=this.size),null!==this.shadowSide&&(i.shadowSide=this.shadowSide),void 0!==this.sizeAttenuation&&(i.sizeAttenuation=this.sizeAttenuation),1!==this.blending&&(i.blending=this.blending),this.side!==I&&(i.side=this.side),!0===this.vertexColors&&(i.vertexColors=!0),this.opacity<1&&(i.opacity=this.opacity),!0===this.transparent&&(i.transparent=!0),204!==this.blendSrc&&(i.blendSrc=this.blendSrc),205!==this.blendDst&&(i.blendDst=this.blendDst),this.blendEquation!==k&&(i.blendEquation=this.blendEquation),null!==this.blendSrcAlpha&&(i.blendSrcAlpha=this.blendSrcAlpha),null!==this.blendDstAlpha&&(i.blendDstAlpha=this.blendDstAlpha),null!==this.blendEquationAlpha&&(i.blendEquationAlpha=this.blendEquationAlpha),this.blendColor&&this.blendColor.isColor&&(i.blendColor=this.blendColor.getHex()),0!==this.blendAlpha&&(i.blendAlpha=this.blendAlpha),3!==this.depthFunc&&(i.depthFunc=this.depthFunc),!1===this.depthTest&&(i.depthTest=this.depthTest),!1===this.depthWrite&&(i.depthWrite=this.depthWrite),!1===this.colorWrite&&(i.colorWrite=this.colorWrite),255!==this.stencilWriteMask&&(i.stencilWriteMask=this.stencilWriteMask),519!==this.stencilFunc&&(i.stencilFunc=this.stencilFunc),0!==this.stencilRef&&(i.stencilRef=this.stencilRef),255!==this.stencilFuncMask&&(i.stencilFuncMask=this.stencilFuncMask),this.stencilFail!==Bt&&(i.stencilFail=this.stencilFail),this.stencilZFail!==Bt&&(i.stencilZFail=this.stencilZFail),this.stencilZPass!==Bt&&(i.stencilZPass=this.stencilZPass),!0===this.stencilWrite&&(i.stencilWrite=this.stencilWrite),void 0!==this.rotation&&0!==this.rotation&&(i.rotation=this.rotation),!0===this.polygonOffset&&(i.polygonOffset=!0),0!==this.polygonOffsetFactor&&(i.polygonOffsetFactor=this.polygonOffsetFactor),0!==this.polygonOffsetUnits&&(i.polygonOffsetUnits=this.polygonOffsetUnits),void 0!==this.linewidth&&1!==this.linewidth&&(i.linewidth=this.linewidth),void 0!==this.dashSize&&(i.dashSize=this.dashSize),void 0!==this.gapSize&&(i.gapSize=this.gapSize),void 0!==this.scale&&(i.scale=this.scale),!0===this.dithering&&(i.dithering=!0),this.alphaTest>0&&(i.alphaTest=this.alphaTest),!0===this.alphaHash&&(i.alphaHash=!0),!0===this.alphaToCoverage&&(i.alphaToCoverage=!0),!0===this.premultipliedAlpha&&(i.premultipliedAlpha=!0),!0===this.forceSinglePass&&(i.forceSinglePass=!0),!0===this.wireframe&&(i.wireframe=!0),this.wireframeLinewidth>1&&(i.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(i.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(i.wireframeLinejoin=this.wireframeLinejoin),!0===this.flatShading&&(i.flatShading=!0),!1===this.visible&&(i.visible=!1),!1===this.toneMapped&&(i.toneMapped=!1),!1===this.fog&&(i.fog=!1),Object.keys(this.userData).length>0&&(i.userData=this.userData),e){const e=n(t.textures),s=n(t.images);e.length>0&&(i.textures=e),s.length>0&&(i.images=s)}return i}clone(){return(new this.constructor).copy(this)}copy(t){this.name=t.name,this.blending=t.blending,this.side=t.side,this.vertexColors=t.vertexColors,this.opacity=t.opacity,this.transparent=t.transparent,this.blendSrc=t.blendSrc,this.blendDst=t.blendDst,this.blendEquation=t.blendEquation,this.blendSrcAlpha=t.blendSrcAlpha,this.blendDstAlpha=t.blendDstAlpha,this.blendEquationAlpha=t.blendEquationAlpha,this.blendColor.copy(t.blendColor),this.blendAlpha=t.blendAlpha,this.depthFunc=t.depthFunc,this.depthTest=t.depthTest,this.depthWrite=t.depthWrite,this.stencilWriteMask=t.stencilWriteMask,this.stencilFunc=t.stencilFunc,this.stencilRef=t.stencilRef,this.stencilFuncMask=t.stencilFuncMask,this.stencilFail=t.stencilFail,this.stencilZFail=t.stencilZFail,this.stencilZPass=t.stencilZPass,this.stencilWrite=t.stencilWrite;const e=t.clippingPlanes;let i=null;if(null!==e){const t=e.length;i=new Array(t);for(let n=0;n!==t;++n)i[n]=e[n].clone()}return this.clippingPlanes=i,this.clipIntersection=t.clipIntersection,this.clipShadows=t.clipShadows,this.shadowSide=t.shadowSide,this.colorWrite=t.colorWrite,this.precision=t.precision,this.polygonOffset=t.polygonOffset,this.polygonOffsetFactor=t.polygonOffsetFactor,this.polygonOffsetUnits=t.polygonOffsetUnits,this.dithering=t.dithering,this.alphaTest=t.alphaTest,this.alphaHash=t.alphaHash,this.alphaToCoverage=t.alphaToCoverage,this.premultipliedAlpha=t.premultipliedAlpha,this.forceSinglePass=t.forceSinglePass,this.visible=t.visible,this.toneMapped=t.toneMapped,this.userData=JSON.parse(JSON.stringify(t.userData)),this}dispose(){this.dispatchEvent({type:"dispose"})}set needsUpdate(t){!0===t&&this.version++}}class nn extends en{constructor(t){super(),this.isMeshBasicMaterial=!0,this.type="MeshBasicMaterial",this.color=new Zi(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=P,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.color.copy(t.color),this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.specularMap=t.specularMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.combine=t.combine,this.reflectivity=t.reflectivity,this.refractionRatio=t.refractionRatio,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.fog=t.fog,this}}const sn=new Le,rn=new se;class an{constructor(t,e,i=!1){if(Array.isArray(t))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.isBufferAttribute=!0,this.name="",this.array=t,this.itemSize=e,this.count=void 0!==t?t.length/e:0,this.normalized=i,this.usage=zt,this._updateRange={offset:0,count:-1},this.updateRanges=[],this.gpuType=ot,this.version=0}onUploadCallback(){}set needsUpdate(t){!0===t&&this.version++}get updateRange(){return this._updateRange}setUsage(t){return this.usage=t,this}addUpdateRange(t,e){this.updateRanges.push({start:t,count:e})}clearUpdateRanges(){this.updateRanges.length=0}copy(t){return this.name=t.name,this.array=new t.array.constructor(t.array),this.itemSize=t.itemSize,this.count=t.count,this.normalized=t.normalized,this.usage=t.usage,this.gpuType=t.gpuType,this}copyAt(t,e,i){t*=this.itemSize,i*=e.itemSize;for(let n=0,s=this.itemSize;n<s;n++)this.array[t+n]=e.array[i+n];return this}copyArray(t){return this.array.set(t),this}applyMatrix3(t){if(2===this.itemSize)for(let e=0,i=this.count;e<i;e++)rn.fromBufferAttribute(this,e),rn.applyMatrix3(t),this.setXY(e,rn.x,rn.y);else if(3===this.itemSize)for(let e=0,i=this.count;e<i;e++)sn.fromBufferAttribute(this,e),sn.applyMatrix3(t),this.setXYZ(e,sn.x,sn.y,sn.z);return this}applyMatrix4(t){for(let e=0,i=this.count;e<i;e++)sn.fromBufferAttribute(this,e),sn.applyMatrix4(t),this.setXYZ(e,sn.x,sn.y,sn.z);return this}applyNormalMatrix(t){for(let e=0,i=this.count;e<i;e++)sn.fromBufferAttribute(this,e),sn.applyNormalMatrix(t),this.setXYZ(e,sn.x,sn.y,sn.z);return this}transformDirection(t){for(let e=0,i=this.count;e<i;e++)sn.fromBufferAttribute(this,e),sn.transformDirection(t),this.setXYZ(e,sn.x,sn.y,sn.z);return this}set(t,e=0){return this.array.set(t,e),this}getComponent(t,e){let i=this.array[t*this.itemSize+e];return this.normalized&&(i=ee(i,this.array)),i}setComponent(t,e,i){return this.normalized&&(i=ie(i,this.array)),this.array[t*this.itemSize+e]=i,this}getX(t){let e=this.array[t*this.itemSize];return this.normalized&&(e=ee(e,this.array)),e}setX(t,e){return this.normalized&&(e=ie(e,this.array)),this.array[t*this.itemSize]=e,this}getY(t){let e=this.array[t*this.itemSize+1];return this.normalized&&(e=ee(e,this.array)),e}setY(t,e){return this.normalized&&(e=ie(e,this.array)),this.array[t*this.itemSize+1]=e,this}getZ(t){let e=this.array[t*this.itemSize+2];return this.normalized&&(e=ee(e,this.array)),e}setZ(t,e){return this.normalized&&(e=ie(e,this.array)),this.array[t*this.itemSize+2]=e,this}getW(t){let e=this.array[t*this.itemSize+3];return this.normalized&&(e=ee(e,this.array)),e}setW(t,e){return this.normalized&&(e=ie(e,this.array)),this.array[t*this.itemSize+3]=e,this}setXY(t,e,i){return t*=this.itemSize,this.normalized&&(e=ie(e,this.array),i=ie(i,this.array)),this.array[t+0]=e,this.array[t+1]=i,this}setXYZ(t,e,i,n){return t*=this.itemSize,this.normalized&&(e=ie(e,this.array),i=ie(i,this.array),n=ie(n,this.array)),this.array[t+0]=e,this.array[t+1]=i,this.array[t+2]=n,this}setXYZW(t,e,i,n,s){return t*=this.itemSize,this.normalized&&(e=ie(e,this.array),i=ie(i,this.array),n=ie(n,this.array),s=ie(s,this.array)),this.array[t+0]=e,this.array[t+1]=i,this.array[t+2]=n,this.array[t+3]=s,this}onUpload(t){return this.onUploadCallback=t,this}clone(){return new this.constructor(this.array,this.itemSize).copy(this)}toJSON(){const t={itemSize:this.itemSize,type:this.array.constructor.name,array:Array.from(this.array),normalized:this.normalized};return""!==this.name&&(t.name=this.name),this.usage!==zt&&(t.usage=this.usage),t}}class on extends an{constructor(t,e,i){super(new Uint16Array(t),e,i)}}class hn extends an{constructor(t,e,i){super(new Uint32Array(t),e,i)}}class ln extends an{constructor(t,e,i){super(new Float32Array(t),e,i)}}let cn=0;const un=new ci,dn=new Oi,pn=new Le,mn=new Be,fn=new Be,gn=new Le;class vn extends jt{constructor(){super(),this.isBufferGeometry=!0,Object.defineProperty(this,"id",{value:cn++}),this.uuid=Jt(),this.name="",this.type="BufferGeometry",this.index=null,this.attributes={},this.morphAttributes={},this.morphTargetsRelative=!1,this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}getIndex(){return this.index}setIndex(t){return Array.isArray(t)?this.index=new(oe(t)?hn:on)(t,1):this.index=t,this}getAttribute(t){return this.attributes[t]}setAttribute(t,e){return this.attributes[t]=e,this}deleteAttribute(t){return delete this.attributes[t],this}hasAttribute(t){return void 0!==this.attributes[t]}addGroup(t,e,i=0){this.groups.push({start:t,count:e,materialIndex:i})}clearGroups(){this.groups=[]}setDrawRange(t,e){this.drawRange.start=t,this.drawRange.count=e}applyMatrix4(t){const e=this.attributes.position;void 0!==e&&(e.applyMatrix4(t),e.needsUpdate=!0);const i=this.attributes.normal;if(void 0!==i){const e=(new re).getNormalMatrix(t);i.applyNormalMatrix(e),i.needsUpdate=!0}const n=this.attributes.tangent;return void 0!==n&&(n.transformDirection(t),n.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this}applyQuaternion(t){return un.makeRotationFromQuaternion(t),this.applyMatrix4(un),this}rotateX(t){return un.makeRotationX(t),this.applyMatrix4(un),this}rotateY(t){return un.makeRotationY(t),this.applyMatrix4(un),this}rotateZ(t){return un.makeRotationZ(t),this.applyMatrix4(un),this}translate(t,e,i){return un.makeTranslation(t,e,i),this.applyMatrix4(un),this}scale(t,e,i){return un.makeScale(t,e,i),this.applyMatrix4(un),this}lookAt(t){return dn.lookAt(t),dn.updateMatrix(),this.applyMatrix4(dn.matrix),this}center(){return this.computeBoundingBox(),this.boundingBox.getCenter(pn).negate(),this.translate(pn.x,pn.y,pn.z),this}setFromPoints(t){const e=[];for(let i=0,n=t.length;i<n;i++){const n=t[i];e.push(n.x,n.y,n.z||0)}return this.setAttribute("position",new ln(e,3)),this}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new Be);const t=this.attributes.position,e=this.morphAttributes.position;if(t&&t.isGLBufferAttribute)this.boundingBox.set(new Le(-1/0,-1/0,-1/0),new Le(1/0,1/0,1/0));else{if(void 0!==t){if(this.boundingBox.setFromBufferAttribute(t),e)for(let t=0,i=e.length;t<i;t++){const i=e[t];mn.setFromBufferAttribute(i),this.morphTargetsRelative?(gn.addVectors(this.boundingBox.min,mn.min),this.boundingBox.expandByPoint(gn),gn.addVectors(this.boundingBox.max,mn.max),this.boundingBox.expandByPoint(gn)):(this.boundingBox.expandByPoint(mn.min),this.boundingBox.expandByPoint(mn.max))}}else this.boundingBox.makeEmpty();isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z)}}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new ei);const t=this.attributes.position,e=this.morphAttributes.position;if(t&&t.isGLBufferAttribute)this.boundingSphere.set(new Le,1/0);else if(t){const i=this.boundingSphere.center;if(mn.setFromBufferAttribute(t),e)for(let t=0,i=e.length;t<i;t++){const i=e[t];fn.setFromBufferAttribute(i),this.morphTargetsRelative?(gn.addVectors(mn.min,fn.min),mn.expandByPoint(gn),gn.addVectors(mn.max,fn.max),mn.expandByPoint(gn)):(mn.expandByPoint(fn.min),mn.expandByPoint(fn.max))}mn.getCenter(i);let n=0;for(let e=0,s=t.count;e<s;e++)gn.fromBufferAttribute(t,e),n=Math.max(n,i.distanceToSquared(gn));if(e)for(let s=0,r=e.length;s<r;s++){const r=e[s],a=this.morphTargetsRelative;for(let e=0,s=r.count;e<s;e++)gn.fromBufferAttribute(r,e),a&&(pn.fromBufferAttribute(t,e),gn.add(pn)),n=Math.max(n,i.distanceToSquared(gn))}this.boundingSphere.radius=Math.sqrt(n),isNaN(this.boundingSphere.radius)}}computeTangents(){const t=this.index,e=this.attributes;if(null===t||void 0===e.position||void 0===e.normal||void 0===e.uv)return;const i=t.array,n=e.position.array,s=e.normal.array,r=e.uv.array,a=n.length/3;!1===this.hasAttribute("tangent")&&this.setAttribute("tangent",new an(new Float32Array(4*a),4));const o=this.getAttribute("tangent").array,h=[],l=[];for(let t=0;t<a;t++)h[t]=new Le,l[t]=new Le;const c=new Le,u=new Le,d=new Le,p=new se,m=new se,f=new se,g=new Le,v=new Le;function y(t,e,i){c.fromArray(n,3*t),u.fromArray(n,3*e),d.fromArray(n,3*i),p.fromArray(r,2*t),m.fromArray(r,2*e),f.fromArray(r,2*i),u.sub(c),d.sub(c),m.sub(p),f.sub(p);const s=1/(m.x*f.y-f.x*m.y);isFinite(s)&&(g.copy(u).multiplyScalar(f.y).addScaledVector(d,-m.y).multiplyScalar(s),v.copy(d).multiplyScalar(m.x).addScaledVector(u,-f.x).multiplyScalar(s),h[t].add(g),h[e].add(g),h[i].add(g),l[t].add(v),l[e].add(v),l[i].add(v))}let x=this.groups;0===x.length&&(x=[{start:0,count:i.length}]);for(let t=0,e=x.length;t<e;++t){const e=x[t],n=e.start;for(let t=n,s=n+e.count;t<s;t+=3)y(i[t+0],i[t+1],i[t+2])}const b=new Le,_=new Le,w=new Le,M=new Le;function S(t){w.fromArray(s,3*t),M.copy(w);const e=h[t];b.copy(e),b.sub(w.multiplyScalar(w.dot(e))).normalize(),_.crossVectors(M,e);const i=_.dot(l[t])<0?-1:1;o[4*t]=b.x,o[4*t+1]=b.y,o[4*t+2]=b.z,o[4*t+3]=i}for(let t=0,e=x.length;t<e;++t){const e=x[t],n=e.start;for(let t=n,s=n+e.count;t<s;t+=3)S(i[t+0]),S(i[t+1]),S(i[t+2])}}computeVertexNormals(){const t=this.index,e=this.getAttribute("position");if(void 0!==e){let i=this.getAttribute("normal");if(void 0===i)i=new an(new Float32Array(3*e.count),3),this.setAttribute("normal",i);else for(let t=0,e=i.count;t<e;t++)i.setXYZ(t,0,0,0);const n=new Le,s=new Le,r=new Le,a=new Le,o=new Le,h=new Le,l=new Le,c=new Le;if(t)for(let u=0,d=t.count;u<d;u+=3){const d=t.getX(u+0),p=t.getX(u+1),m=t.getX(u+2);n.fromBufferAttribute(e,d),s.fromBufferAttribute(e,p),r.fromBufferAttribute(e,m),l.subVectors(r,s),c.subVectors(n,s),l.cross(c),a.fromBufferAttribute(i,d),o.fromBufferAttribute(i,p),h.fromBufferAttribute(i,m),a.add(l),o.add(l),h.add(l),i.setXYZ(d,a.x,a.y,a.z),i.setXYZ(p,o.x,o.y,o.z),i.setXYZ(m,h.x,h.y,h.z)}else for(let t=0,a=e.count;t<a;t+=3)n.fromBufferAttribute(e,t+0),s.fromBufferAttribute(e,t+1),r.fromBufferAttribute(e,t+2),l.subVectors(r,s),c.subVectors(n,s),l.cross(c),i.setXYZ(t+0,l.x,l.y,l.z),i.setXYZ(t+1,l.x,l.y,l.z),i.setXYZ(t+2,l.x,l.y,l.z);this.normalizeNormals(),i.needsUpdate=!0}}normalizeNormals(){const t=this.attributes.normal;for(let e=0,i=t.count;e<i;e++)gn.fromBufferAttribute(t,e),gn.normalize(),t.setXYZ(e,gn.x,gn.y,gn.z)}toNonIndexed(){function t(t,e){const i=t.array,n=t.itemSize,s=t.normalized,r=new i.constructor(e.length*n);let a=0,o=0;for(let s=0,h=e.length;s<h;s++){a=t.isInterleavedBufferAttribute?e[s]*t.data.stride+t.offset:e[s]*n;for(let t=0;t<n;t++)r[o++]=i[a++]}return new an(r,n,s)}if(null===this.index)return this;const e=new vn,i=this.index.array,n=this.attributes;for(const s in n){const r=t(n[s],i);e.setAttribute(s,r)}const s=this.morphAttributes;for(const n in s){const r=[],a=s[n];for(let e=0,n=a.length;e<n;e++){const n=t(a[e],i);r.push(n)}e.morphAttributes[n]=r}e.morphTargetsRelative=this.morphTargetsRelative;const r=this.groups;for(let t=0,i=r.length;t<i;t++){const i=r[t];e.addGroup(i.start,i.count,i.materialIndex)}return e}toJSON(){const t={metadata:{version:4.6,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(t.uuid=this.uuid,t.type=this.type,""!==this.name&&(t.name=this.name),Object.keys(this.userData).length>0&&(t.userData=this.userData),void 0!==this.parameters){const e=this.parameters;for(const i in e)void 0!==e[i]&&(t[i]=e[i]);return t}t.data={attributes:{}};const e=this.index;null!==e&&(t.data.index={type:e.array.constructor.name,array:Array.prototype.slice.call(e.array)});const i=this.attributes;for(const e in i){const n=i[e];t.data.attributes[e]=n.toJSON(t.data)}const n={};let s=!1;for(const e in this.morphAttributes){const i=this.morphAttributes[e],r=[];for(let e=0,n=i.length;e<n;e++){const n=i[e];r.push(n.toJSON(t.data))}r.length>0&&(n[e]=r,s=!0)}s&&(t.data.morphAttributes=n,t.data.morphTargetsRelative=this.morphTargetsRelative);const r=this.groups;r.length>0&&(t.data.groups=JSON.parse(JSON.stringify(r)));const a=this.boundingSphere;return null!==a&&(t.data.boundingSphere={center:a.center.toArray(),radius:a.radius}),t}clone(){return(new this.constructor).copy(this)}copy(t){this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;const e={};this.name=t.name;const i=t.index;null!==i&&this.setIndex(i.clone(e));const n=t.attributes;for(const t in n){const i=n[t];this.setAttribute(t,i.clone(e))}const s=t.morphAttributes;for(const t in s){const i=[],n=s[t];for(let t=0,s=n.length;t<s;t++)i.push(n[t].clone(e));this.morphAttributes[t]=i}this.morphTargetsRelative=t.morphTargetsRelative;const r=t.groups;for(let t=0,e=r.length;t<e;t++){const e=r[t];this.addGroup(e.start,e.count,e.materialIndex)}const a=t.boundingBox;null!==a&&(this.boundingBox=a.clone());const o=t.boundingSphere;return null!==o&&(this.boundingSphere=o.clone()),this.drawRange.start=t.drawRange.start,this.drawRange.count=t.drawRange.count,this.userData=t.userData,this}dispose(){this.dispatchEvent({type:"dispose"})}}const yn=new ci,xn=new li,bn=new ei,_n=new Le,wn=new Le,Mn=new Le,Sn=new Le,En=new Le,Tn=new Le,An=new se,Cn=new se,In=new se,Rn=new Le,kn=new Le,Pn=new Le,Dn=new Le,Ln=new Le;class On extends Oi{constructor(t=new vn,e=new nn){super(),this.isMesh=!0,this.type="Mesh",this.geometry=t,this.material=e,this.updateMorphTargets()}copy(t,e){return super.copy(t,e),void 0!==t.morphTargetInfluences&&(this.morphTargetInfluences=t.morphTargetInfluences.slice()),void 0!==t.morphTargetDictionary&&(this.morphTargetDictionary=Object.assign({},t.morphTargetDictionary)),this.material=Array.isArray(t.material)?t.material.slice():t.material,this.geometry=t.geometry,this}updateMorphTargets(){const t=this.geometry.morphAttributes,e=Object.keys(t);if(e.length>0){const i=t[e[0]];if(void 0!==i){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let t=0,e=i.length;t<e;t++){const e=i[t].name||String(t);this.morphTargetInfluences.push(0),this.morphTargetDictionary[e]=t}}}}getVertexPosition(t,e){const i=this.geometry,n=i.attributes.position,s=i.morphAttributes.position,r=i.morphTargetsRelative;e.fromBufferAttribute(n,t);const a=this.morphTargetInfluences;if(s&&a){Tn.set(0,0,0);for(let i=0,n=s.length;i<n;i++){const n=a[i],o=s[i];0!==n&&(En.fromBufferAttribute(o,t),r?Tn.addScaledVector(En,n):Tn.addScaledVector(En.sub(e),n))}e.add(Tn)}return e}raycast(t,e){const i=this.geometry,n=this.material,s=this.matrixWorld;if(void 0!==n){if(null===i.boundingSphere&&i.computeBoundingSphere(),bn.copy(i.boundingSphere),bn.applyMatrix4(s),xn.copy(t.ray).recast(t.near),!1===bn.containsPoint(xn.origin)){if(null===xn.intersectSphere(bn,_n))return;if(xn.origin.distanceToSquared(_n)>(t.far-t.near)**2)return}yn.copy(s).invert(),xn.copy(t.ray).applyMatrix4(yn),null!==i.boundingBox&&!1===xn.intersectsBox(i.boundingBox)||this._computeIntersections(t,e,xn)}}_computeIntersections(t,e,i){let n;const s=this.geometry,r=this.material,a=s.index,o=s.attributes.position,h=s.attributes.uv,l=s.attributes.uv1,c=s.attributes.normal,u=s.groups,d=s.drawRange;if(null!==a)if(Array.isArray(r))for(let s=0,o=u.length;s<o;s++){const o=u[s],p=r[o.materialIndex];for(let s=Math.max(o.start,d.start),r=Math.min(a.count,Math.min(o.start+o.count,d.start+d.count));s<r;s+=3){n=Nn(this,p,t,i,h,l,c,a.getX(s),a.getX(s+1),a.getX(s+2)),n&&(n.faceIndex=Math.floor(s/3),n.face.materialIndex=o.materialIndex,e.push(n))}}else{for(let s=Math.max(0,d.start),o=Math.min(a.count,d.start+d.count);s<o;s+=3){n=Nn(this,r,t,i,h,l,c,a.getX(s),a.getX(s+1),a.getX(s+2)),n&&(n.faceIndex=Math.floor(s/3),e.push(n))}}else if(void 0!==o)if(Array.isArray(r))for(let s=0,a=u.length;s<a;s++){const a=u[s],p=r[a.materialIndex];for(let s=Math.max(a.start,d.start),r=Math.min(o.count,Math.min(a.start+a.count,d.start+d.count));s<r;s+=3){n=Nn(this,p,t,i,h,l,c,s,s+1,s+2),n&&(n.faceIndex=Math.floor(s/3),n.face.materialIndex=a.materialIndex,e.push(n))}}else{for(let s=Math.max(0,d.start),a=Math.min(o.count,d.start+d.count);s<a;s+=3){n=Nn(this,r,t,i,h,l,c,s,s+1,s+2),n&&(n.faceIndex=Math.floor(s/3),e.push(n))}}}}function Nn(t,e,i,n,s,r,a,o,h,l){t.getVertexPosition(o,wn),t.getVertexPosition(h,Mn),t.getVertexPosition(l,Sn);const c=function(t,e,i,n,s,r,a,o){let h;if(h=e.side===R?n.intersectTriangle(a,r,s,!0,o):n.intersectTriangle(s,r,a,e.side===I,o),null===h)return null;Ln.copy(o),Ln.applyMatrix4(t.matrixWorld);const l=i.ray.origin.distanceTo(Ln);return l<i.near||l>i.far?null:{distance:l,point:Ln.clone(),object:t}}(t,e,i,n,wn,Mn,Sn,Dn);if(c){s&&(An.fromBufferAttribute(s,o),Cn.fromBufferAttribute(s,h),In.fromBufferAttribute(s,l),c.uv=qi.getInterpolation(Dn,wn,Mn,Sn,An,Cn,In,new se)),r&&(An.fromBufferAttribute(r,o),Cn.fromBufferAttribute(r,h),In.fromBufferAttribute(r,l),c.uv1=qi.getInterpolation(Dn,wn,Mn,Sn,An,Cn,In,new se),c.uv2=c.uv1),a&&(Rn.fromBufferAttribute(a,o),kn.fromBufferAttribute(a,h),Pn.fromBufferAttribute(a,l),c.normal=qi.getInterpolation(Dn,wn,Mn,Sn,Rn,kn,Pn,new Le),c.normal.dot(n.direction)>0&&c.normal.multiplyScalar(-1));const t={a:o,b:h,c:l,normal:new Le,materialIndex:0};qi.getNormal(wn,Mn,Sn,t.normal),c.face=t}return c}class Bn extends vn{constructor(t=1,e=1,i=1,n=1,s=1,r=1){super(),this.type="BoxGeometry",this.parameters={width:t,height:e,depth:i,widthSegments:n,heightSegments:s,depthSegments:r};const a=this;n=Math.floor(n),s=Math.floor(s),r=Math.floor(r);const o=[],h=[],l=[],c=[];let u=0,d=0;function p(t,e,i,n,s,r,p,m,f,g,v){const y=r/f,x=p/g,b=r/2,_=p/2,w=m/2,M=f+1,S=g+1;let E=0,T=0;const A=new Le;for(let r=0;r<S;r++){const a=r*x-_;for(let o=0;o<M;o++){const u=o*y-b;A[t]=u*n,A[e]=a*s,A[i]=w,h.push(A.x,A.y,A.z),A[t]=0,A[e]=0,A[i]=m>0?1:-1,l.push(A.x,A.y,A.z),c.push(o/f),c.push(1-r/g),E+=1}}for(let t=0;t<g;t++)for(let e=0;e<f;e++){const i=u+e+M*t,n=u+e+M*(t+1),s=u+(e+1)+M*(t+1),r=u+(e+1)+M*t;o.push(i,n,r),o.push(n,s,r),T+=6}a.addGroup(d,T,v),d+=T,u+=E}p("z","y","x",-1,-1,i,e,t,r,s,0),p("z","y","x",1,-1,i,e,-t,r,s,1),p("x","z","y",1,1,t,i,e,n,r,2),p("x","z","y",1,-1,t,i,-e,n,r,3),p("x","y","z",1,-1,t,e,i,n,s,4),p("x","y","z",-1,-1,t,e,-i,n,s,5),this.setIndex(o),this.setAttribute("position",new ln(h,3)),this.setAttribute("normal",new ln(l,3)),this.setAttribute("uv",new ln(c,2))}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}static fromJSON(t){return new Bn(t.width,t.height,t.depth,t.widthSegments,t.heightSegments,t.depthSegments)}}function zn(t){const e={};for(const i in t){e[i]={};for(const n in t[i]){const s=t[i][n];s&&(s.isColor||s.isMatrix3||s.isMatrix4||s.isVector2||s.isVector3||s.isVector4||s.isTexture||s.isQuaternion)?s.isRenderTargetTexture?e[i][n]=null:e[i][n]=s.clone():Array.isArray(s)?e[i][n]=s.slice():e[i][n]=s}}return e}function Un(t){const e={};for(let i=0;i<t.length;i++){const n=zn(t[i]);for(const t in n)e[t]=n[t]}return e}function Fn(t){return null===t.getRenderTarget()?t.outputColorSpace:ye.workingColorSpace}const Gn={clone:zn,merge:Un};class Vn extends en{constructor(t){super(),this.isShaderMaterial=!0,this.type="ShaderMaterial",this.defines={},this.uniforms={},this.uniformsGroups=[],this.vertexShader="void main() {\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",this.fragmentShader="void main() {\n\tgl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );\n}",this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.forceSinglePass=!0,this.extensions={derivatives:!1,fragDepth:!1,drawBuffers:!1,shaderTextureLOD:!1,clipCullDistance:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv1:[0,0]},this.index0AttributeName=void 0,this.uniformsNeedUpdate=!1,this.glslVersion=null,void 0!==t&&this.setValues(t)}copy(t){return super.copy(t),this.fragmentShader=t.fragmentShader,this.vertexShader=t.vertexShader,this.uniforms=zn(t.uniforms),this.uniformsGroups=function(t){const e=[];for(let i=0;i<t.length;i++)e.push(t[i].clone());return e}(t.uniformsGroups),this.defines=Object.assign({},t.defines),this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.fog=t.fog,this.lights=t.lights,this.clipping=t.clipping,this.extensions=Object.assign({},t.extensions),this.glslVersion=t.glslVersion,this}toJSON(t){const e=super.toJSON(t);e.glslVersion=this.glslVersion,e.uniforms={};for(const i in this.uniforms){const n=this.uniforms[i].value;n&&n.isTexture?e.uniforms[i]={type:"t",value:n.toJSON(t).uuid}:n&&n.isColor?e.uniforms[i]={type:"c",value:n.getHex()}:n&&n.isVector2?e.uniforms[i]={type:"v2",value:n.toArray()}:n&&n.isVector3?e.uniforms[i]={type:"v3",value:n.toArray()}:n&&n.isVector4?e.uniforms[i]={type:"v4",value:n.toArray()}:n&&n.isMatrix3?e.uniforms[i]={type:"m3",value:n.toArray()}:n&&n.isMatrix4?e.uniforms[i]={type:"m4",value:n.toArray()}:e.uniforms[i]={value:n}}Object.keys(this.defines).length>0&&(e.defines=this.defines),e.vertexShader=this.vertexShader,e.fragmentShader=this.fragmentShader,e.lights=this.lights,e.clipping=this.clipping;const i={};for(const t in this.extensions)!0===this.extensions[t]&&(i[t]=!0);return Object.keys(i).length>0&&(e.extensions=i),e}}class Hn extends Oi{constructor(){super(),this.isCamera=!0,this.type="Camera",this.matrixWorldInverse=new ci,this.projectionMatrix=new ci,this.projectionMatrixInverse=new ci,this.coordinateSystem=Vt}copy(t,e){return super.copy(t,e),this.matrixWorldInverse.copy(t.matrixWorldInverse),this.projectionMatrix.copy(t.projectionMatrix),this.projectionMatrixInverse.copy(t.projectionMatrixInverse),this.coordinateSystem=t.coordinateSystem,this}getWorldDirection(t){return super.getWorldDirection(t).negate()}updateMatrixWorld(t){super.updateMatrixWorld(t),this.matrixWorldInverse.copy(this.matrixWorld).invert()}updateWorldMatrix(t,e){super.updateWorldMatrix(t,e),this.matrixWorldInverse.copy(this.matrixWorld).invert()}clone(){return(new this.constructor).copy(this)}}class jn extends Hn{constructor(t=50,e=1,i=.1,n=2e3){super(),this.isPerspectiveCamera=!0,this.type="PerspectiveCamera",this.fov=t,this.zoom=1,this.near=i,this.far=n,this.focus=10,this.aspect=e,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}copy(t,e){return super.copy(t,e),this.fov=t.fov,this.zoom=t.zoom,this.near=t.near,this.far=t.far,this.focus=t.focus,this.aspect=t.aspect,this.view=null===t.view?null:Object.assign({},t.view),this.filmGauge=t.filmGauge,this.filmOffset=t.filmOffset,this}setFocalLength(t){const e=.5*this.getFilmHeight()/t;this.fov=2*Yt*Math.atan(e),this.updateProjectionMatrix()}getFocalLength(){const t=Math.tan(.5*qt*this.fov);return.5*this.getFilmHeight()/t}getEffectiveFOV(){return 2*Yt*Math.atan(Math.tan(.5*qt*this.fov)/this.zoom)}getFilmWidth(){return this.filmGauge*Math.min(this.aspect,1)}getFilmHeight(){return this.filmGauge/Math.max(this.aspect,1)}setViewOffset(t,e,i,n,s,r){this.aspect=t/e,null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=t,this.view.fullHeight=e,this.view.offsetX=i,this.view.offsetY=n,this.view.width=s,this.view.height=r,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const t=this.near;let e=t*Math.tan(.5*qt*this.fov)/this.zoom,i=2*e,n=this.aspect*i,s=-.5*n;const r=this.view;if(null!==this.view&&this.view.enabled){const t=r.fullWidth,a=r.fullHeight;s+=r.offsetX*n/t,e-=r.offsetY*i/a,n*=r.width/t,i*=r.height/a}const a=this.filmOffset;0!==a&&(s+=t*a/this.getFilmWidth()),this.projectionMatrix.makePerspective(s,s+n,e,e-i,t,this.far,this.coordinateSystem),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(t){const e=super.toJSON(t);return e.object.fov=this.fov,e.object.zoom=this.zoom,e.object.near=this.near,e.object.far=this.far,e.object.focus=this.focus,e.object.aspect=this.aspect,null!==this.view&&(e.object.view=Object.assign({},this.view)),e.object.filmGauge=this.filmGauge,e.object.filmOffset=this.filmOffset,e}}const Wn=-90;class Xn extends Oi{constructor(t,e,i){super(),this.type="CubeCamera",this.renderTarget=i,this.coordinateSystem=null,this.activeMipmapLevel=0;const n=new jn(Wn,1,t,e);n.layers=this.layers,this.add(n);const s=new jn(Wn,1,t,e);s.layers=this.layers,this.add(s);const r=new jn(Wn,1,t,e);r.layers=this.layers,this.add(r);const a=new jn(Wn,1,t,e);a.layers=this.layers,this.add(a);const o=new jn(Wn,1,t,e);o.layers=this.layers,this.add(o);const h=new jn(Wn,1,t,e);h.layers=this.layers,this.add(h)}updateCoordinateSystem(){const t=this.coordinateSystem,e=this.children.concat(),[i,n,s,r,a,o]=e;for(const t of e)this.remove(t);if(t===Vt)i.up.set(0,1,0),i.lookAt(1,0,0),n.up.set(0,1,0),n.lookAt(-1,0,0),s.up.set(0,0,-1),s.lookAt(0,1,0),r.up.set(0,0,1),r.lookAt(0,-1,0),a.up.set(0,1,0),a.lookAt(0,0,1),o.up.set(0,1,0),o.lookAt(0,0,-1);else{if(t!==Ht)throw new Error("THREE.CubeCamera.updateCoordinateSystem(): Invalid coordinate system: "+t);i.up.set(0,-1,0),i.lookAt(-1,0,0),n.up.set(0,-1,0),n.lookAt(1,0,0),s.up.set(0,0,1),s.lookAt(0,1,0),r.up.set(0,0,-1),r.lookAt(0,-1,0),a.up.set(0,-1,0),a.lookAt(0,0,1),o.up.set(0,-1,0),o.lookAt(0,0,-1)}for(const t of e)this.add(t),t.updateMatrixWorld()}update(t,e){null===this.parent&&this.updateMatrixWorld();const{renderTarget:i,activeMipmapLevel:n}=this;this.coordinateSystem!==t.coordinateSystem&&(this.coordinateSystem=t.coordinateSystem,this.updateCoordinateSystem());const[s,r,a,o,h,l]=this.children,c=t.getRenderTarget(),u=t.getActiveCubeFace(),d=t.getActiveMipmapLevel(),p=t.xr.enabled;t.xr.enabled=!1;const m=i.texture.generateMipmaps;i.texture.generateMipmaps=!1,t.setRenderTarget(i,0,n),t.render(e,s),t.setRenderTarget(i,1,n),t.render(e,r),t.setRenderTarget(i,2,n),t.render(e,a),t.setRenderTarget(i,3,n),t.render(e,o),t.setRenderTarget(i,4,n),t.render(e,h),i.texture.generateMipmaps=m,t.setRenderTarget(i,5,n),t.render(e,l),t.setRenderTarget(c,u,d),t.xr.enabled=p,i.texture.needsPMREMUpdate=!0}}class qn extends Ae{constructor(t,e,i,n,s,r,a,o,h,l){super(t=void 0!==t?t:[],e=void 0!==e?e:H,i,n,s,r,a,o,h,l),this.isCubeTexture=!0,this.flipY=!1}get images(){return this.image}set images(t){this.image=t}}class Yn extends Re{constructor(t=1,e={}){super(t,t,e),this.isWebGLCubeRenderTarget=!0;const i={width:t,height:t,depth:1},n=[i,i,i,i,i,i];void 0!==e.encoding&&(pe("THREE.WebGLCubeRenderTarget: option.encoding has been replaced by option.colorSpace."),e.colorSpace=e.encoding===At?It:Ct),this.texture=new qn(n,e.mapping,e.wrapS,e.wrapT,e.magFilter,e.minFilter,e.format,e.type,e.anisotropy,e.colorSpace),this.texture.isRenderTargetTexture=!0,this.texture.generateMipmaps=void 0!==e.generateMipmaps&&e.generateMipmaps,this.texture.minFilter=void 0!==e.minFilter?e.minFilter:tt}fromEquirectangularTexture(t,e){this.texture.type=e.type,this.texture.colorSpace=e.colorSpace,this.texture.generateMipmaps=e.generateMipmaps,this.texture.minFilter=e.minFilter,this.texture.magFilter=e.magFilter;const i={uniforms:{tEquirect:{value:null}},vertexShader:"\n\n\t\t\t\tvarying vec3 vWorldDirection;\n\n\t\t\t\tvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\n\t\t\t\t\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n\n\t\t\t\t}\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tvWorldDirection = transformDirection( position, modelMatrix );\n\n\t\t\t\t\t#include <begin_vertex>\n\t\t\t\t\t#include <project_vertex>\n\n\t\t\t\t}\n\t\t\t",fragmentShader:"\n\n\t\t\t\tuniform sampler2D tEquirect;\n\n\t\t\t\tvarying vec3 vWorldDirection;\n\n\t\t\t\t#include <common>\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tvec3 direction = normalize( vWorldDirection );\n\n\t\t\t\t\tvec2 sampleUV = equirectUv( direction );\n\n\t\t\t\t\tgl_FragColor = texture2D( tEquirect, sampleUV );\n\n\t\t\t\t}\n\t\t\t"},n=new Bn(5,5,5),s=new Vn({name:"CubemapFromEquirect",uniforms:zn(i.uniforms),vertexShader:i.vertexShader,fragmentShader:i.fragmentShader,side:R,blending:0});s.uniforms.tEquirect.value=e;const r=new On(n,s),a=e.minFilter;e.minFilter===it&&(e.minFilter=tt);return new Xn(1,10,this).update(t,r),e.minFilter=a,r.geometry.dispose(),r.material.dispose(),this}clear(t,e,i,n){const s=t.getRenderTarget();for(let s=0;s<6;s++)t.setRenderTarget(this,s),t.clear(e,i,n);t.setRenderTarget(s)}}const Jn=new Le,$n=new Le,Kn=new re;class Zn{constructor(t=new Le(1,0,0),e=0){this.isPlane=!0,this.normal=t,this.constant=e}set(t,e){return this.normal.copy(t),this.constant=e,this}setComponents(t,e,i,n){return this.normal.set(t,e,i),this.constant=n,this}setFromNormalAndCoplanarPoint(t,e){return this.normal.copy(t),this.constant=-e.dot(this.normal),this}setFromCoplanarPoints(t,e,i){const n=Jn.subVectors(i,e).cross($n.subVectors(t,e)).normalize();return this.setFromNormalAndCoplanarPoint(n,t),this}copy(t){return this.normal.copy(t.normal),this.constant=t.constant,this}normalize(){const t=1/this.normal.length();return this.normal.multiplyScalar(t),this.constant*=t,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(t){return this.normal.dot(t)+this.constant}distanceToSphere(t){return this.distanceToPoint(t.center)-t.radius}projectPoint(t,e){return e.copy(t).addScaledVector(this.normal,-this.distanceToPoint(t))}intersectLine(t,e){const i=t.delta(Jn),n=this.normal.dot(i);if(0===n)return 0===this.distanceToPoint(t.start)?e.copy(t.start):null;const s=-(t.start.dot(this.normal)+this.constant)/n;return s<0||s>1?null:e.copy(t.start).addScaledVector(i,s)}intersectsLine(t){const e=this.distanceToPoint(t.start),i=this.distanceToPoint(t.end);return e<0&&i>0||i<0&&e>0}intersectsBox(t){return t.intersectsPlane(this)}intersectsSphere(t){return t.intersectsPlane(this)}coplanarPoint(t){return t.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(t,e){const i=e||Kn.getNormalMatrix(t),n=this.coplanarPoint(Jn).applyMatrix4(t),s=this.normal.applyMatrix3(i).normalize();return this.constant=-n.dot(s),this}translate(t){return this.constant-=t.dot(this.normal),this}equals(t){return t.normal.equals(this.normal)&&t.constant===this.constant}clone(){return(new this.constructor).copy(this)}}const Qn=new ei,ts=new Le;class es{constructor(t=new Zn,e=new Zn,i=new Zn,n=new Zn,s=new Zn,r=new Zn){this.planes=[t,e,i,n,s,r]}set(t,e,i,n,s,r){const a=this.planes;return a[0].copy(t),a[1].copy(e),a[2].copy(i),a[3].copy(n),a[4].copy(s),a[5].copy(r),this}copy(t){const e=this.planes;for(let i=0;i<6;i++)e[i].copy(t.planes[i]);return this}setFromProjectionMatrix(t,e=2e3){const i=this.planes,n=t.elements,s=n[0],r=n[1],a=n[2],o=n[3],h=n[4],l=n[5],c=n[6],u=n[7],d=n[8],p=n[9],m=n[10],f=n[11],g=n[12],v=n[13],y=n[14],x=n[15];if(i[0].setComponents(o-s,u-h,f-d,x-g).normalize(),i[1].setComponents(o+s,u+h,f+d,x+g).normalize(),i[2].setComponents(o+r,u+l,f+p,x+v).normalize(),i[3].setComponents(o-r,u-l,f-p,x-v).normalize(),i[4].setComponents(o-a,u-c,f-m,x-y).normalize(),e===Vt)i[5].setComponents(o+a,u+c,f+m,x+y).normalize();else{if(e!==Ht)throw new Error("THREE.Frustum.setFromProjectionMatrix(): Invalid coordinate system: "+e);i[5].setComponents(a,c,m,y).normalize()}return this}intersectsObject(t){if(void 0!==t.boundingSphere)null===t.boundingSphere&&t.computeBoundingSphere(),Qn.copy(t.boundingSphere).applyMatrix4(t.matrixWorld);else{const e=t.geometry;null===e.boundingSphere&&e.computeBoundingSphere(),Qn.copy(e.boundingSphere).applyMatrix4(t.matrixWorld)}return this.intersectsSphere(Qn)}intersectsSprite(t){return Qn.center.set(0,0,0),Qn.radius=.7071067811865476,Qn.applyMatrix4(t.matrixWorld),this.intersectsSphere(Qn)}intersectsSphere(t){const e=this.planes,i=t.center,n=-t.radius;for(let t=0;t<6;t++){if(e[t].distanceToPoint(i)<n)return!1}return!0}intersectsBox(t){const e=this.planes;for(let i=0;i<6;i++){const n=e[i];if(ts.x=n.normal.x>0?t.max.x:t.min.x,ts.y=n.normal.y>0?t.max.y:t.min.y,ts.z=n.normal.z>0?t.max.z:t.min.z,n.distanceToPoint(ts)<0)return!1}return!0}containsPoint(t){const e=this.planes;for(let i=0;i<6;i++)if(e[i].distanceToPoint(t)<0)return!1;return!0}clone(){return(new this.constructor).copy(this)}}function is(){let t=null,e=!1,i=null,n=null;function s(e,r){i(e,r),n=t.requestAnimationFrame(s)}return{start:function(){!0!==e&&null!==i&&(n=t.requestAnimationFrame(s),e=!0)},stop:function(){t.cancelAnimationFrame(n),e=!1},setAnimationLoop:function(t){i=t},setContext:function(e){t=e}}}function ns(t,e){const i=e.isWebGL2,n=new WeakMap;return{get:function(t){return t.isInterleavedBufferAttribute&&(t=t.data),n.get(t)},remove:function(e){e.isInterleavedBufferAttribute&&(e=e.data);const i=n.get(e);i&&(t.deleteBuffer(i.buffer),n.delete(e))},update:function(e,s){if(e.isGLBufferAttribute){const t=n.get(e);return void((!t||t.version<e.version)&&n.set(e,{buffer:e.buffer,type:e.type,bytesPerElement:e.elementSize,version:e.version}))}e.isInterleavedBufferAttribute&&(e=e.data);const r=n.get(e);if(void 0===r)n.set(e,function(e,n){const s=e.array,r=e.usage,a=s.byteLength,o=t.createBuffer();let h;if(t.bindBuffer(n,o),t.bufferData(n,s,r),e.onUploadCallback(),s instanceof Float32Array)h=t.FLOAT;else if(s instanceof Uint16Array)if(e.isFloat16BufferAttribute){if(!i)throw new Error("THREE.WebGLAttributes: Usage of Float16BufferAttribute requires WebGL2.");h=t.HALF_FLOAT}else h=t.UNSIGNED_SHORT;else if(s instanceof Int16Array)h=t.SHORT;else if(s instanceof Uint32Array)h=t.UNSIGNED_INT;else if(s instanceof Int32Array)h=t.INT;else if(s instanceof Int8Array)h=t.BYTE;else if(s instanceof Uint8Array)h=t.UNSIGNED_BYTE;else{if(!(s instanceof Uint8ClampedArray))throw new Error("THREE.WebGLAttributes: Unsupported buffer data format: "+s);h=t.UNSIGNED_BYTE}return{buffer:o,type:h,bytesPerElement:s.BYTES_PER_ELEMENT,version:e.version,size:a}}(e,s));else if(r.version<e.version){if(r.size!==e.array.byteLength)throw new Error("THREE.WebGLAttributes: The size of the buffer attribute's array buffer does not match the original size. Resizing buffer attributes is not supported.");!function(e,n,s){const r=n.array,a=n._updateRange,o=n.updateRanges;if(t.bindBuffer(s,e),-1===a.count&&0===o.length&&t.bufferSubData(s,0,r),0!==o.length){for(let e=0,n=o.length;e<n;e++){const n=o[e];i?t.bufferSubData(s,n.start*r.BYTES_PER_ELEMENT,r,n.start,n.count):t.bufferSubData(s,n.start*r.BYTES_PER_ELEMENT,r.subarray(n.start,n.start+n.count))}n.clearUpdateRanges()}-1!==a.count&&(i?t.bufferSubData(s,a.offset*r.BYTES_PER_ELEMENT,r,a.offset,a.count):t.bufferSubData(s,a.offset*r.BYTES_PER_ELEMENT,r.subarray(a.offset,a.offset+a.count)),a.count=-1),n.onUploadCallback()}(r.buffer,e,s),r.version=e.version}}}}class ss extends vn{constructor(t=1,e=1,i=1,n=1){super(),this.type="PlaneGeometry",this.parameters={width:t,height:e,widthSegments:i,heightSegments:n};const s=t/2,r=e/2,a=Math.floor(i),o=Math.floor(n),h=a+1,l=o+1,c=t/a,u=e/o,d=[],p=[],m=[],f=[];for(let t=0;t<l;t++){const e=t*u-r;for(let i=0;i<h;i++){const n=i*c-s;p.push(n,-e,0),m.push(0,0,1),f.push(i/a),f.push(1-t/o)}}for(let t=0;t<o;t++)for(let e=0;e<a;e++){const i=e+h*t,n=e+h*(t+1),s=e+1+h*(t+1),r=e+1+h*t;d.push(i,n,r),d.push(n,s,r)}this.setIndex(d),this.setAttribute("position",new ln(p,3)),this.setAttribute("normal",new ln(m,3)),this.setAttribute("uv",new ln(f,2))}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}static fromJSON(t){return new ss(t.width,t.height,t.widthSegments,t.heightSegments)}}const rs={alphahash_fragment:"#ifdef USE_ALPHAHASH\n\tif ( diffuseColor.a < getAlphaHashThreshold( vPosition ) ) discard;\n#endif",alphahash_pars_fragment:"#ifdef USE_ALPHAHASH\n\tconst float ALPHA_HASH_SCALE = 0.05;\n\tfloat hash2D( vec2 value ) {\n\t\treturn fract( 1.0e4 * sin( 17.0 * value.x + 0.1 * value.y ) * ( 0.1 + abs( sin( 13.0 * value.y + value.x ) ) ) );\n\t}\n\tfloat hash3D( vec3 value ) {\n\t\treturn hash2D( vec2( hash2D( value.xy ), value.z ) );\n\t}\n\tfloat getAlphaHashThreshold( vec3 position ) {\n\t\tfloat maxDeriv = max(\n\t\t\tlength( dFdx( position.xyz ) ),\n\t\t\tlength( dFdy( position.xyz ) )\n\t\t);\n\t\tfloat pixScale = 1.0 / ( ALPHA_HASH_SCALE * maxDeriv );\n\t\tvec2 pixScales = vec2(\n\t\t\texp2( floor( log2( pixScale ) ) ),\n\t\t\texp2( ceil( log2( pixScale ) ) )\n\t\t);\n\t\tvec2 alpha = vec2(\n\t\t\thash3D( floor( pixScales.x * position.xyz ) ),\n\t\t\thash3D( floor( pixScales.y * position.xyz ) )\n\t\t);\n\t\tfloat lerpFactor = fract( log2( pixScale ) );\n\t\tfloat x = ( 1.0 - lerpFactor ) * alpha.x + lerpFactor * alpha.y;\n\t\tfloat a = min( lerpFactor, 1.0 - lerpFactor );\n\t\tvec3 cases = vec3(\n\t\t\tx * x / ( 2.0 * a * ( 1.0 - a ) ),\n\t\t\t( x - 0.5 * a ) / ( 1.0 - a ),\n\t\t\t1.0 - ( ( 1.0 - x ) * ( 1.0 - x ) / ( 2.0 * a * ( 1.0 - a ) ) )\n\t\t);\n\t\tfloat threshold = ( x < ( 1.0 - a ) )\n\t\t\t? ( ( x < a ) ? cases.x : cases.y )\n\t\t\t: cases.z;\n\t\treturn clamp( threshold , 1.0e-6, 1.0 );\n\t}\n#endif",alphamap_fragment:"#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, vAlphaMapUv ).g;\n#endif",alphamap_pars_fragment:"#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif",alphatest_fragment:"#ifdef USE_ALPHATEST\n\tif ( diffuseColor.a < alphaTest ) discard;\n#endif",alphatest_pars_fragment:"#ifdef USE_ALPHATEST\n\tuniform float alphaTest;\n#endif",aomap_fragment:"#ifdef USE_AOMAP\n\tfloat ambientOcclusion = ( texture2D( aoMap, vAoMapUv ).r - 1.0 ) * aoMapIntensity + 1.0;\n\treflectedLight.indirectDiffuse *= ambientOcclusion;\n\t#if defined( USE_CLEARCOAT ) \n\t\tclearcoatSpecularIndirect *= ambientOcclusion;\n\t#endif\n\t#if defined( USE_SHEEN ) \n\t\tsheenSpecularIndirect *= ambientOcclusion;\n\t#endif\n\t#if defined( USE_ENVMAP ) && defined( STANDARD )\n\t\tfloat dotNV = saturate( dot( geometryNormal, geometryViewDir ) );\n\t\treflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.roughness );\n\t#endif\n#endif",aomap_pars_fragment:"#ifdef USE_AOMAP\n\tuniform sampler2D aoMap;\n\tuniform float aoMapIntensity;\n#endif",batching_pars_vertex:"#ifdef USE_BATCHING\n\tattribute float batchId;\n\tuniform highp sampler2D batchingTexture;\n\tmat4 getBatchingMatrix( const in float i ) {\n\t\tint size = textureSize( batchingTexture, 0 ).x;\n\t\tint j = int( i ) * 4;\n\t\tint x = j % size;\n\t\tint y = j / size;\n\t\tvec4 v1 = texelFetch( batchingTexture, ivec2( x, y ), 0 );\n\t\tvec4 v2 = texelFetch( batchingTexture, ivec2( x + 1, y ), 0 );\n\t\tvec4 v3 = texelFetch( batchingTexture, ivec2( x + 2, y ), 0 );\n\t\tvec4 v4 = texelFetch( batchingTexture, ivec2( x + 3, y ), 0 );\n\t\treturn mat4( v1, v2, v3, v4 );\n\t}\n#endif",batching_vertex:"#ifdef USE_BATCHING\n\tmat4 batchingMatrix = getBatchingMatrix( batchId );\n#endif",begin_vertex:"vec3 transformed = vec3( position );\n#ifdef USE_ALPHAHASH\n\tvPosition = vec3( position );\n#endif",beginnormal_vertex:"vec3 objectNormal = vec3( normal );\n#ifdef USE_TANGENT\n\tvec3 objectTangent = vec3( tangent.xyz );\n#endif",bsdfs:"float G_BlinnPhong_Implicit( ) {\n\treturn 0.25;\n}\nfloat D_BlinnPhong( const in float shininess, const in float dotNH ) {\n\treturn RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );\n}\nvec3 BRDF_BlinnPhong( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in vec3 specularColor, const in float shininess ) {\n\tvec3 halfDir = normalize( lightDir + viewDir );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat dotVH = saturate( dot( viewDir, halfDir ) );\n\tvec3 F = F_Schlick( specularColor, 1.0, dotVH );\n\tfloat G = G_BlinnPhong_Implicit( );\n\tfloat D = D_BlinnPhong( shininess, dotNH );\n\treturn F * ( G * D );\n} // validated",iridescence_fragment:"#ifdef USE_IRIDESCENCE\n\tconst mat3 XYZ_TO_REC709 = mat3(\n\t\t 3.2404542, -0.9692660,  0.0556434,\n\t\t-1.5371385,  1.8760108, -0.2040259,\n\t\t-0.4985314,  0.0415560,  1.0572252\n\t);\n\tvec3 Fresnel0ToIor( vec3 fresnel0 ) {\n\t\tvec3 sqrtF0 = sqrt( fresnel0 );\n\t\treturn ( vec3( 1.0 ) + sqrtF0 ) / ( vec3( 1.0 ) - sqrtF0 );\n\t}\n\tvec3 IorToFresnel0( vec3 transmittedIor, float incidentIor ) {\n\t\treturn pow2( ( transmittedIor - vec3( incidentIor ) ) / ( transmittedIor + vec3( incidentIor ) ) );\n\t}\n\tfloat IorToFresnel0( float transmittedIor, float incidentIor ) {\n\t\treturn pow2( ( transmittedIor - incidentIor ) / ( transmittedIor + incidentIor ));\n\t}\n\tvec3 evalSensitivity( float OPD, vec3 shift ) {\n\t\tfloat phase = 2.0 * PI * OPD * 1.0e-9;\n\t\tvec3 val = vec3( 5.4856e-13, 4.4201e-13, 5.2481e-13 );\n\t\tvec3 pos = vec3( 1.6810e+06, 1.7953e+06, 2.2084e+06 );\n\t\tvec3 var = vec3( 4.3278e+09, 9.3046e+09, 6.6121e+09 );\n\t\tvec3 xyz = val * sqrt( 2.0 * PI * var ) * cos( pos * phase + shift ) * exp( - pow2( phase ) * var );\n\t\txyz.x += 9.7470e-14 * sqrt( 2.0 * PI * 4.5282e+09 ) * cos( 2.2399e+06 * phase + shift[ 0 ] ) * exp( - 4.5282e+09 * pow2( phase ) );\n\t\txyz /= 1.0685e-7;\n\t\tvec3 rgb = XYZ_TO_REC709 * xyz;\n\t\treturn rgb;\n\t}\n\tvec3 evalIridescence( float outsideIOR, float eta2, float cosTheta1, float thinFilmThickness, vec3 baseF0 ) {\n\t\tvec3 I;\n\t\tfloat iridescenceIOR = mix( outsideIOR, eta2, smoothstep( 0.0, 0.03, thinFilmThickness ) );\n\t\tfloat sinTheta2Sq = pow2( outsideIOR / iridescenceIOR ) * ( 1.0 - pow2( cosTheta1 ) );\n\t\tfloat cosTheta2Sq = 1.0 - sinTheta2Sq;\n\t\tif ( cosTheta2Sq < 0.0 ) {\n\t\t\treturn vec3( 1.0 );\n\t\t}\n\t\tfloat cosTheta2 = sqrt( cosTheta2Sq );\n\t\tfloat R0 = IorToFresnel0( iridescenceIOR, outsideIOR );\n\t\tfloat R12 = F_Schlick( R0, 1.0, cosTheta1 );\n\t\tfloat T121 = 1.0 - R12;\n\t\tfloat phi12 = 0.0;\n\t\tif ( iridescenceIOR < outsideIOR ) phi12 = PI;\n\t\tfloat phi21 = PI - phi12;\n\t\tvec3 baseIOR = Fresnel0ToIor( clamp( baseF0, 0.0, 0.9999 ) );\t\tvec3 R1 = IorToFresnel0( baseIOR, iridescenceIOR );\n\t\tvec3 R23 = F_Schlick( R1, 1.0, cosTheta2 );\n\t\tvec3 phi23 = vec3( 0.0 );\n\t\tif ( baseIOR[ 0 ] < iridescenceIOR ) phi23[ 0 ] = PI;\n\t\tif ( baseIOR[ 1 ] < iridescenceIOR ) phi23[ 1 ] = PI;\n\t\tif ( baseIOR[ 2 ] < iridescenceIOR ) phi23[ 2 ] = PI;\n\t\tfloat OPD = 2.0 * iridescenceIOR * thinFilmThickness * cosTheta2;\n\t\tvec3 phi = vec3( phi21 ) + phi23;\n\t\tvec3 R123 = clamp( R12 * R23, 1e-5, 0.9999 );\n\t\tvec3 r123 = sqrt( R123 );\n\t\tvec3 Rs = pow2( T121 ) * R23 / ( vec3( 1.0 ) - R123 );\n\t\tvec3 C0 = R12 + Rs;\n\t\tI = C0;\n\t\tvec3 Cm = Rs - T121;\n\t\tfor ( int m = 1; m <= 2; ++ m ) {\n\t\t\tCm *= r123;\n\t\t\tvec3 Sm = 2.0 * evalSensitivity( float( m ) * OPD, float( m ) * phi );\n\t\t\tI += Cm * Sm;\n\t\t}\n\t\treturn max( I, vec3( 0.0 ) );\n\t}\n#endif",bumpmap_pars_fragment:"#ifdef USE_BUMPMAP\n\tuniform sampler2D bumpMap;\n\tuniform float bumpScale;\n\tvec2 dHdxy_fwd() {\n\t\tvec2 dSTdx = dFdx( vBumpMapUv );\n\t\tvec2 dSTdy = dFdy( vBumpMapUv );\n\t\tfloat Hll = bumpScale * texture2D( bumpMap, vBumpMapUv ).x;\n\t\tfloat dBx = bumpScale * texture2D( bumpMap, vBumpMapUv + dSTdx ).x - Hll;\n\t\tfloat dBy = bumpScale * texture2D( bumpMap, vBumpMapUv + dSTdy ).x - Hll;\n\t\treturn vec2( dBx, dBy );\n\t}\n\tvec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy, float faceDirection ) {\n\t\tvec3 vSigmaX = normalize( dFdx( surf_pos.xyz ) );\n\t\tvec3 vSigmaY = normalize( dFdy( surf_pos.xyz ) );\n\t\tvec3 vN = surf_norm;\n\t\tvec3 R1 = cross( vSigmaY, vN );\n\t\tvec3 R2 = cross( vN, vSigmaX );\n\t\tfloat fDet = dot( vSigmaX, R1 ) * faceDirection;\n\t\tvec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );\n\t\treturn normalize( abs( fDet ) * surf_norm - vGrad );\n\t}\n#endif",clipping_planes_fragment:"#if NUM_CLIPPING_PLANES > 0\n\tvec4 plane;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {\n\t\tplane = clippingPlanes[ i ];\n\t\tif ( dot( vClipPosition, plane.xyz ) > plane.w ) discard;\n\t}\n\t#pragma unroll_loop_end\n\t#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n\t\tbool clipped = true;\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {\n\t\t\tplane = clippingPlanes[ i ];\n\t\t\tclipped = ( dot( vClipPosition, plane.xyz ) > plane.w ) && clipped;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t\tif ( clipped ) discard;\n\t#endif\n#endif",clipping_planes_pars_fragment:"#if NUM_CLIPPING_PLANES > 0\n\tvarying vec3 vClipPosition;\n\tuniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];\n#endif",clipping_planes_pars_vertex:"#if NUM_CLIPPING_PLANES > 0\n\tvarying vec3 vClipPosition;\n#endif",clipping_planes_vertex:"#if NUM_CLIPPING_PLANES > 0\n\tvClipPosition = - mvPosition.xyz;\n#endif",color_fragment:"#if defined( USE_COLOR_ALPHA )\n\tdiffuseColor *= vColor;\n#elif defined( USE_COLOR )\n\tdiffuseColor.rgb *= vColor;\n#endif",color_pars_fragment:"#if defined( USE_COLOR_ALPHA )\n\tvarying vec4 vColor;\n#elif defined( USE_COLOR )\n\tvarying vec3 vColor;\n#endif",color_pars_vertex:"#if defined( USE_COLOR_ALPHA )\n\tvarying vec4 vColor;\n#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR )\n\tvarying vec3 vColor;\n#endif",color_vertex:"#if defined( USE_COLOR_ALPHA )\n\tvColor = vec4( 1.0 );\n#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR )\n\tvColor = vec3( 1.0 );\n#endif\n#ifdef USE_COLOR\n\tvColor *= color;\n#endif\n#ifdef USE_INSTANCING_COLOR\n\tvColor.xyz *= instanceColor.xyz;\n#endif",common:"#define PI 3.141592653589793\n#define PI2 6.283185307179586\n#define PI_HALF 1.5707963267948966\n#define RECIPROCAL_PI 0.3183098861837907\n#define RECIPROCAL_PI2 0.15915494309189535\n#define EPSILON 1e-6\n#ifndef saturate\n#define saturate( a ) clamp( a, 0.0, 1.0 )\n#endif\n#define whiteComplement( a ) ( 1.0 - saturate( a ) )\nfloat pow2( const in float x ) { return x*x; }\nvec3 pow2( const in vec3 x ) { return x*x; }\nfloat pow3( const in float x ) { return x*x*x; }\nfloat pow4( const in float x ) { float x2 = x*x; return x2*x2; }\nfloat max3( const in vec3 v ) { return max( max( v.x, v.y ), v.z ); }\nfloat average( const in vec3 v ) { return dot( v, vec3( 0.3333333 ) ); }\nhighp float rand( const in vec2 uv ) {\n\tconst highp float a = 12.9898, b = 78.233, c = 43758.5453;\n\thighp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );\n\treturn fract( sin( sn ) * c );\n}\n#ifdef HIGH_PRECISION\n\tfloat precisionSafeLength( vec3 v ) { return length( v ); }\n#else\n\tfloat precisionSafeLength( vec3 v ) {\n\t\tfloat maxComponent = max3( abs( v ) );\n\t\treturn length( v / maxComponent ) * maxComponent;\n\t}\n#endif\nstruct IncidentLight {\n\tvec3 color;\n\tvec3 direction;\n\tbool visible;\n};\nstruct ReflectedLight {\n\tvec3 directDiffuse;\n\tvec3 directSpecular;\n\tvec3 indirectDiffuse;\n\tvec3 indirectSpecular;\n};\n#ifdef USE_ALPHAHASH\n\tvarying vec3 vPosition;\n#endif\nvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n}\nvec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );\n}\nmat3 transposeMat3( const in mat3 m ) {\n\tmat3 tmp;\n\ttmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );\n\ttmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );\n\ttmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );\n\treturn tmp;\n}\nfloat luminance( const in vec3 rgb ) {\n\tconst vec3 weights = vec3( 0.2126729, 0.7151522, 0.0721750 );\n\treturn dot( weights, rgb );\n}\nbool isPerspectiveMatrix( mat4 m ) {\n\treturn m[ 2 ][ 3 ] == - 1.0;\n}\nvec2 equirectUv( in vec3 dir ) {\n\tfloat u = atan( dir.z, dir.x ) * RECIPROCAL_PI2 + 0.5;\n\tfloat v = asin( clamp( dir.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;\n\treturn vec2( u, v );\n}\nvec3 BRDF_Lambert( const in vec3 diffuseColor ) {\n\treturn RECIPROCAL_PI * diffuseColor;\n}\nvec3 F_Schlick( const in vec3 f0, const in float f90, const in float dotVH ) {\n\tfloat fresnel = exp2( ( - 5.55473 * dotVH - 6.98316 ) * dotVH );\n\treturn f0 * ( 1.0 - fresnel ) + ( f90 * fresnel );\n}\nfloat F_Schlick( const in float f0, const in float f90, const in float dotVH ) {\n\tfloat fresnel = exp2( ( - 5.55473 * dotVH - 6.98316 ) * dotVH );\n\treturn f0 * ( 1.0 - fresnel ) + ( f90 * fresnel );\n} // validated",cube_uv_reflection_fragment:"#ifdef ENVMAP_TYPE_CUBE_UV\n\t#define cubeUV_minMipLevel 4.0\n\t#define cubeUV_minTileSize 16.0\n\tfloat getFace( vec3 direction ) {\n\t\tvec3 absDirection = abs( direction );\n\t\tfloat face = - 1.0;\n\t\tif ( absDirection.x > absDirection.z ) {\n\t\t\tif ( absDirection.x > absDirection.y )\n\t\t\t\tface = direction.x > 0.0 ? 0.0 : 3.0;\n\t\t\telse\n\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\t\t} else {\n\t\t\tif ( absDirection.z > absDirection.y )\n\t\t\t\tface = direction.z > 0.0 ? 2.0 : 5.0;\n\t\t\telse\n\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\t\t}\n\t\treturn face;\n\t}\n\tvec2 getUV( vec3 direction, float face ) {\n\t\tvec2 uv;\n\t\tif ( face == 0.0 ) {\n\t\t\tuv = vec2( direction.z, direction.y ) / abs( direction.x );\n\t\t} else if ( face == 1.0 ) {\n\t\t\tuv = vec2( - direction.x, - direction.z ) / abs( direction.y );\n\t\t} else if ( face == 2.0 ) {\n\t\t\tuv = vec2( - direction.x, direction.y ) / abs( direction.z );\n\t\t} else if ( face == 3.0 ) {\n\t\t\tuv = vec2( - direction.z, direction.y ) / abs( direction.x );\n\t\t} else if ( face == 4.0 ) {\n\t\t\tuv = vec2( - direction.x, direction.z ) / abs( direction.y );\n\t\t} else {\n\t\t\tuv = vec2( direction.x, direction.y ) / abs( direction.z );\n\t\t}\n\t\treturn 0.5 * ( uv + 1.0 );\n\t}\n\tvec3 bilinearCubeUV( sampler2D envMap, vec3 direction, float mipInt ) {\n\t\tfloat face = getFace( direction );\n\t\tfloat filterInt = max( cubeUV_minMipLevel - mipInt, 0.0 );\n\t\tmipInt = max( mipInt, cubeUV_minMipLevel );\n\t\tfloat faceSize = exp2( mipInt );\n\t\thighp vec2 uv = getUV( direction, face ) * ( faceSize - 2.0 ) + 1.0;\n\t\tif ( face > 2.0 ) {\n\t\t\tuv.y += faceSize;\n\t\t\tface -= 3.0;\n\t\t}\n\t\tuv.x += face * faceSize;\n\t\tuv.x += filterInt * 3.0 * cubeUV_minTileSize;\n\t\tuv.y += 4.0 * ( exp2( CUBEUV_MAX_MIP ) - faceSize );\n\t\tuv.x *= CUBEUV_TEXEL_WIDTH;\n\t\tuv.y *= CUBEUV_TEXEL_HEIGHT;\n\t\t#ifdef texture2DGradEXT\n\t\t\treturn texture2DGradEXT( envMap, uv, vec2( 0.0 ), vec2( 0.0 ) ).rgb;\n\t\t#else\n\t\t\treturn texture2D( envMap, uv ).rgb;\n\t\t#endif\n\t}\n\t#define cubeUV_r0 1.0\n\t#define cubeUV_m0 - 2.0\n\t#define cubeUV_r1 0.8\n\t#define cubeUV_m1 - 1.0\n\t#define cubeUV_r4 0.4\n\t#define cubeUV_m4 2.0\n\t#define cubeUV_r5 0.305\n\t#define cubeUV_m5 3.0\n\t#define cubeUV_r6 0.21\n\t#define cubeUV_m6 4.0\n\tfloat roughnessToMip( float roughness ) {\n\t\tfloat mip = 0.0;\n\t\tif ( roughness >= cubeUV_r1 ) {\n\t\t\tmip = ( cubeUV_r0 - roughness ) * ( cubeUV_m1 - cubeUV_m0 ) / ( cubeUV_r0 - cubeUV_r1 ) + cubeUV_m0;\n\t\t} else if ( roughness >= cubeUV_r4 ) {\n\t\t\tmip = ( cubeUV_r1 - roughness ) * ( cubeUV_m4 - cubeUV_m1 ) / ( cubeUV_r1 - cubeUV_r4 ) + cubeUV_m1;\n\t\t} else if ( roughness >= cubeUV_r5 ) {\n\t\t\tmip = ( cubeUV_r4 - roughness ) * ( cubeUV_m5 - cubeUV_m4 ) / ( cubeUV_r4 - cubeUV_r5 ) + cubeUV_m4;\n\t\t} else if ( roughness >= cubeUV_r6 ) {\n\t\t\tmip = ( cubeUV_r5 - roughness ) * ( cubeUV_m6 - cubeUV_m5 ) / ( cubeUV_r5 - cubeUV_r6 ) + cubeUV_m5;\n\t\t} else {\n\t\t\tmip = - 2.0 * log2( 1.16 * roughness );\t\t}\n\t\treturn mip;\n\t}\n\tvec4 textureCubeUV( sampler2D envMap, vec3 sampleDir, float roughness ) {\n\t\tfloat mip = clamp( roughnessToMip( roughness ), cubeUV_m0, CUBEUV_MAX_MIP );\n\t\tfloat mipF = fract( mip );\n\t\tfloat mipInt = floor( mip );\n\t\tvec3 color0 = bilinearCubeUV( envMap, sampleDir, mipInt );\n\t\tif ( mipF == 0.0 ) {\n\t\t\treturn vec4( color0, 1.0 );\n\t\t} else {\n\t\t\tvec3 color1 = bilinearCubeUV( envMap, sampleDir, mipInt + 1.0 );\n\t\t\treturn vec4( mix( color0, color1, mipF ), 1.0 );\n\t\t}\n\t}\n#endif",defaultnormal_vertex:"vec3 transformedNormal = objectNormal;\n#ifdef USE_TANGENT\n\tvec3 transformedTangent = objectTangent;\n#endif\n#ifdef USE_BATCHING\n\tmat3 bm = mat3( batchingMatrix );\n\ttransformedNormal /= vec3( dot( bm[ 0 ], bm[ 0 ] ), dot( bm[ 1 ], bm[ 1 ] ), dot( bm[ 2 ], bm[ 2 ] ) );\n\ttransformedNormal = bm * transformedNormal;\n\t#ifdef USE_TANGENT\n\t\ttransformedTangent = bm * transformedTangent;\n\t#endif\n#endif\n#ifdef USE_INSTANCING\n\tmat3 im = mat3( instanceMatrix );\n\ttransformedNormal /= vec3( dot( im[ 0 ], im[ 0 ] ), dot( im[ 1 ], im[ 1 ] ), dot( im[ 2 ], im[ 2 ] ) );\n\ttransformedNormal = im * transformedNormal;\n\t#ifdef USE_TANGENT\n\t\ttransformedTangent = im * transformedTangent;\n\t#endif\n#endif\ntransformedNormal = normalMatrix * transformedNormal;\n#ifdef FLIP_SIDED\n\ttransformedNormal = - transformedNormal;\n#endif\n#ifdef USE_TANGENT\n\ttransformedTangent = ( modelViewMatrix * vec4( transformedTangent, 0.0 ) ).xyz;\n\t#ifdef FLIP_SIDED\n\t\ttransformedTangent = - transformedTangent;\n\t#endif\n#endif",displacementmap_pars_vertex:"#ifdef USE_DISPLACEMENTMAP\n\tuniform sampler2D displacementMap;\n\tuniform float displacementScale;\n\tuniform float displacementBias;\n#endif",displacementmap_vertex:"#ifdef USE_DISPLACEMENTMAP\n\ttransformed += normalize( objectNormal ) * ( texture2D( displacementMap, vDisplacementMapUv ).x * displacementScale + displacementBias );\n#endif",emissivemap_fragment:"#ifdef USE_EMISSIVEMAP\n\tvec4 emissiveColor = texture2D( emissiveMap, vEmissiveMapUv );\n\ttotalEmissiveRadiance *= emissiveColor.rgb;\n#endif",emissivemap_pars_fragment:"#ifdef USE_EMISSIVEMAP\n\tuniform sampler2D emissiveMap;\n#endif",colorspace_fragment:"gl_FragColor = linearToOutputTexel( gl_FragColor );",colorspace_pars_fragment:"\nconst mat3 LINEAR_SRGB_TO_LINEAR_DISPLAY_P3 = mat3(\n\tvec3( 0.8224621, 0.177538, 0.0 ),\n\tvec3( 0.0331941, 0.9668058, 0.0 ),\n\tvec3( 0.0170827, 0.0723974, 0.9105199 )\n);\nconst mat3 LINEAR_DISPLAY_P3_TO_LINEAR_SRGB = mat3(\n\tvec3( 1.2249401, - 0.2249404, 0.0 ),\n\tvec3( - 0.0420569, 1.0420571, 0.0 ),\n\tvec3( - 0.0196376, - 0.0786361, 1.0982735 )\n);\nvec4 LinearSRGBToLinearDisplayP3( in vec4 value ) {\n\treturn vec4( value.rgb * LINEAR_SRGB_TO_LINEAR_DISPLAY_P3, value.a );\n}\nvec4 LinearDisplayP3ToLinearSRGB( in vec4 value ) {\n\treturn vec4( value.rgb * LINEAR_DISPLAY_P3_TO_LINEAR_SRGB, value.a );\n}\nvec4 LinearTransferOETF( in vec4 value ) {\n\treturn value;\n}\nvec4 sRGBTransferOETF( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.a );\n}\nvec4 LinearToLinear( in vec4 value ) {\n\treturn value;\n}\nvec4 LinearTosRGB( in vec4 value ) {\n\treturn sRGBTransferOETF( value );\n}",envmap_fragment:"#ifdef USE_ENVMAP\n\t#ifdef ENV_WORLDPOS\n\t\tvec3 cameraToFrag;\n\t\tif ( isOrthographic ) {\n\t\t\tcameraToFrag = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );\n\t\t} else {\n\t\t\tcameraToFrag = normalize( vWorldPosition - cameraPosition );\n\t\t}\n\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvec3 reflectVec = reflect( cameraToFrag, worldNormal );\n\t\t#else\n\t\t\tvec3 reflectVec = refract( cameraToFrag, worldNormal, refractionRatio );\n\t\t#endif\n\t#else\n\t\tvec3 reflectVec = vReflect;\n\t#endif\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tvec4 envColor = textureCube( envMap, vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );\n\t#else\n\t\tvec4 envColor = vec4( 0.0 );\n\t#endif\n\t#ifdef ENVMAP_BLENDING_MULTIPLY\n\t\toutgoingLight = mix( outgoingLight, outgoingLight * envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_MIX )\n\t\toutgoingLight = mix( outgoingLight, envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_ADD )\n\t\toutgoingLight += envColor.xyz * specularStrength * reflectivity;\n\t#endif\n#endif",envmap_common_pars_fragment:"#ifdef USE_ENVMAP\n\tuniform float envMapIntensity;\n\tuniform float flipEnvMap;\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tuniform samplerCube envMap;\n\t#else\n\t\tuniform sampler2D envMap;\n\t#endif\n\t\n#endif",envmap_pars_fragment:"#ifdef USE_ENVMAP\n\tuniform float reflectivity;\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( LAMBERT )\n\t\t#define ENV_WORLDPOS\n\t#endif\n\t#ifdef ENV_WORLDPOS\n\t\tvarying vec3 vWorldPosition;\n\t\tuniform float refractionRatio;\n\t#else\n\t\tvarying vec3 vReflect;\n\t#endif\n#endif",envmap_pars_vertex:"#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( LAMBERT )\n\t\t#define ENV_WORLDPOS\n\t#endif\n\t#ifdef ENV_WORLDPOS\n\t\t\n\t\tvarying vec3 vWorldPosition;\n\t#else\n\t\tvarying vec3 vReflect;\n\t\tuniform float refractionRatio;\n\t#endif\n#endif",envmap_physical_pars_fragment:"#ifdef USE_ENVMAP\n\tvec3 getIBLIrradiance( const in vec3 normal ) {\n\t\t#ifdef ENVMAP_TYPE_CUBE_UV\n\t\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, worldNormal, 1.0 );\n\t\t\treturn PI * envMapColor.rgb * envMapIntensity;\n\t\t#else\n\t\t\treturn vec3( 0.0 );\n\t\t#endif\n\t}\n\tvec3 getIBLRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness ) {\n\t\t#ifdef ENVMAP_TYPE_CUBE_UV\n\t\t\tvec3 reflectVec = reflect( - viewDir, normal );\n\t\t\treflectVec = normalize( mix( reflectVec, normal, roughness * roughness) );\n\t\t\treflectVec = inverseTransformDirection( reflectVec, viewMatrix );\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, reflectVec, roughness );\n\t\t\treturn envMapColor.rgb * envMapIntensity;\n\t\t#else\n\t\t\treturn vec3( 0.0 );\n\t\t#endif\n\t}\n\t#ifdef USE_ANISOTROPY\n\t\tvec3 getIBLAnisotropyRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness, const in vec3 bitangent, const in float anisotropy ) {\n\t\t\t#ifdef ENVMAP_TYPE_CUBE_UV\n\t\t\t\tvec3 bentNormal = cross( bitangent, viewDir );\n\t\t\t\tbentNormal = normalize( cross( bentNormal, bitangent ) );\n\t\t\t\tbentNormal = normalize( mix( bentNormal, normal, pow2( pow2( 1.0 - anisotropy * ( 1.0 - roughness ) ) ) ) );\n\t\t\t\treturn getIBLRadiance( viewDir, bentNormal, roughness );\n\t\t\t#else\n\t\t\t\treturn vec3( 0.0 );\n\t\t\t#endif\n\t\t}\n\t#endif\n#endif",envmap_vertex:"#ifdef USE_ENVMAP\n\t#ifdef ENV_WORLDPOS\n\t\tvWorldPosition = worldPosition.xyz;\n\t#else\n\t\tvec3 cameraToVertex;\n\t\tif ( isOrthographic ) {\n\t\t\tcameraToVertex = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );\n\t\t} else {\n\t\t\tcameraToVertex = normalize( worldPosition.xyz - cameraPosition );\n\t\t}\n\t\tvec3 worldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvReflect = reflect( cameraToVertex, worldNormal );\n\t\t#else\n\t\t\tvReflect = refract( cameraToVertex, worldNormal, refractionRatio );\n\t\t#endif\n\t#endif\n#endif",fog_vertex:"#ifdef USE_FOG\n\tvFogDepth = - mvPosition.z;\n#endif",fog_pars_vertex:"#ifdef USE_FOG\n\tvarying float vFogDepth;\n#endif",fog_fragment:"#ifdef USE_FOG\n\t#ifdef FOG_EXP2\n\t\tfloat fogFactor = 1.0 - exp( - fogDensity * fogDensity * vFogDepth * vFogDepth );\n\t#else\n\t\tfloat fogFactor = smoothstep( fogNear, fogFar, vFogDepth );\n\t#endif\n\tgl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n#endif",fog_pars_fragment:"#ifdef USE_FOG\n\tuniform vec3 fogColor;\n\tvarying float vFogDepth;\n\t#ifdef FOG_EXP2\n\t\tuniform float fogDensity;\n\t#else\n\t\tuniform float fogNear;\n\t\tuniform float fogFar;\n\t#endif\n#endif",gradientmap_pars_fragment:"#ifdef USE_GRADIENTMAP\n\tuniform sampler2D gradientMap;\n#endif\nvec3 getGradientIrradiance( vec3 normal, vec3 lightDirection ) {\n\tfloat dotNL = dot( normal, lightDirection );\n\tvec2 coord = vec2( dotNL * 0.5 + 0.5, 0.0 );\n\t#ifdef USE_GRADIENTMAP\n\t\treturn vec3( texture2D( gradientMap, coord ).r );\n\t#else\n\t\tvec2 fw = fwidth( coord ) * 0.5;\n\t\treturn mix( vec3( 0.7 ), vec3( 1.0 ), smoothstep( 0.7 - fw.x, 0.7 + fw.x, coord.x ) );\n\t#endif\n}",lightmap_fragment:"#ifdef USE_LIGHTMAP\n\tvec4 lightMapTexel = texture2D( lightMap, vLightMapUv );\n\tvec3 lightMapIrradiance = lightMapTexel.rgb * lightMapIntensity;\n\treflectedLight.indirectDiffuse += lightMapIrradiance;\n#endif",lightmap_pars_fragment:"#ifdef USE_LIGHTMAP\n\tuniform sampler2D lightMap;\n\tuniform float lightMapIntensity;\n#endif",lights_lambert_fragment:"LambertMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.specularStrength = specularStrength;",lights_lambert_pars_fragment:"varying vec3 vViewPosition;\nstruct LambertMaterial {\n\tvec3 diffuseColor;\n\tfloat specularStrength;\n};\nvoid RE_Direct_Lambert( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in LambertMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometryNormal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Lambert( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in LambertMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_Lambert\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Lambert",lights_pars_begin:"uniform bool receiveShadow;\nuniform vec3 ambientLightColor;\n#if defined( USE_LIGHT_PROBES )\n\tuniform vec3 lightProbe[ 9 ];\n#endif\nvec3 shGetIrradianceAt( in vec3 normal, in vec3 shCoefficients[ 9 ] ) {\n\tfloat x = normal.x, y = normal.y, z = normal.z;\n\tvec3 result = shCoefficients[ 0 ] * 0.886227;\n\tresult += shCoefficients[ 1 ] * 2.0 * 0.511664 * y;\n\tresult += shCoefficients[ 2 ] * 2.0 * 0.511664 * z;\n\tresult += shCoefficients[ 3 ] * 2.0 * 0.511664 * x;\n\tresult += shCoefficients[ 4 ] * 2.0 * 0.429043 * x * y;\n\tresult += shCoefficients[ 5 ] * 2.0 * 0.429043 * y * z;\n\tresult += shCoefficients[ 6 ] * ( 0.743125 * z * z - 0.247708 );\n\tresult += shCoefficients[ 7 ] * 2.0 * 0.429043 * x * z;\n\tresult += shCoefficients[ 8 ] * 0.429043 * ( x * x - y * y );\n\treturn result;\n}\nvec3 getLightProbeIrradiance( const in vec3 lightProbe[ 9 ], const in vec3 normal ) {\n\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\tvec3 irradiance = shGetIrradianceAt( worldNormal, lightProbe );\n\treturn irradiance;\n}\nvec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {\n\tvec3 irradiance = ambientLightColor;\n\treturn irradiance;\n}\nfloat getDistanceAttenuation( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {\n\t#if defined ( LEGACY_LIGHTS )\n\t\tif ( cutoffDistance > 0.0 && decayExponent > 0.0 ) {\n\t\t\treturn pow( saturate( - lightDistance / cutoffDistance + 1.0 ), decayExponent );\n\t\t}\n\t\treturn 1.0;\n\t#else\n\t\tfloat distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );\n\t\tif ( cutoffDistance > 0.0 ) {\n\t\t\tdistanceFalloff *= pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );\n\t\t}\n\t\treturn distanceFalloff;\n\t#endif\n}\nfloat getSpotAttenuation( const in float coneCosine, const in float penumbraCosine, const in float angleCosine ) {\n\treturn smoothstep( coneCosine, penumbraCosine, angleCosine );\n}\n#if NUM_DIR_LIGHTS > 0\n\tstruct DirectionalLight {\n\t\tvec3 direction;\n\t\tvec3 color;\n\t};\n\tuniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];\n\tvoid getDirectionalLightInfo( const in DirectionalLight directionalLight, out IncidentLight light ) {\n\t\tlight.color = directionalLight.color;\n\t\tlight.direction = directionalLight.direction;\n\t\tlight.visible = true;\n\t}\n#endif\n#if NUM_POINT_LIGHTS > 0\n\tstruct PointLight {\n\t\tvec3 position;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t};\n\tuniform PointLight pointLights[ NUM_POINT_LIGHTS ];\n\tvoid getPointLightInfo( const in PointLight pointLight, const in vec3 geometryPosition, out IncidentLight light ) {\n\t\tvec3 lVector = pointLight.position - geometryPosition;\n\t\tlight.direction = normalize( lVector );\n\t\tfloat lightDistance = length( lVector );\n\t\tlight.color = pointLight.color;\n\t\tlight.color *= getDistanceAttenuation( lightDistance, pointLight.distance, pointLight.decay );\n\t\tlight.visible = ( light.color != vec3( 0.0 ) );\n\t}\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\tstruct SpotLight {\n\t\tvec3 position;\n\t\tvec3 direction;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t\tfloat coneCos;\n\t\tfloat penumbraCos;\n\t};\n\tuniform SpotLight spotLights[ NUM_SPOT_LIGHTS ];\n\tvoid getSpotLightInfo( const in SpotLight spotLight, const in vec3 geometryPosition, out IncidentLight light ) {\n\t\tvec3 lVector = spotLight.position - geometryPosition;\n\t\tlight.direction = normalize( lVector );\n\t\tfloat angleCos = dot( light.direction, spotLight.direction );\n\t\tfloat spotAttenuation = getSpotAttenuation( spotLight.coneCos, spotLight.penumbraCos, angleCos );\n\t\tif ( spotAttenuation > 0.0 ) {\n\t\t\tfloat lightDistance = length( lVector );\n\t\t\tlight.color = spotLight.color * spotAttenuation;\n\t\t\tlight.color *= getDistanceAttenuation( lightDistance, spotLight.distance, spotLight.decay );\n\t\t\tlight.visible = ( light.color != vec3( 0.0 ) );\n\t\t} else {\n\t\t\tlight.color = vec3( 0.0 );\n\t\t\tlight.visible = false;\n\t\t}\n\t}\n#endif\n#if NUM_RECT_AREA_LIGHTS > 0\n\tstruct RectAreaLight {\n\t\tvec3 color;\n\t\tvec3 position;\n\t\tvec3 halfWidth;\n\t\tvec3 halfHeight;\n\t};\n\tuniform sampler2D ltc_1;\tuniform sampler2D ltc_2;\n\tuniform RectAreaLight rectAreaLights[ NUM_RECT_AREA_LIGHTS ];\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\tstruct HemisphereLight {\n\t\tvec3 direction;\n\t\tvec3 skyColor;\n\t\tvec3 groundColor;\n\t};\n\tuniform HemisphereLight hemisphereLights[ NUM_HEMI_LIGHTS ];\n\tvec3 getHemisphereLightIrradiance( const in HemisphereLight hemiLight, const in vec3 normal ) {\n\t\tfloat dotNL = dot( normal, hemiLight.direction );\n\t\tfloat hemiDiffuseWeight = 0.5 * dotNL + 0.5;\n\t\tvec3 irradiance = mix( hemiLight.groundColor, hemiLight.skyColor, hemiDiffuseWeight );\n\t\treturn irradiance;\n\t}\n#endif",lights_toon_fragment:"ToonMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;",lights_toon_pars_fragment:"varying vec3 vViewPosition;\nstruct ToonMaterial {\n\tvec3 diffuseColor;\n};\nvoid RE_Direct_Toon( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {\n\tvec3 irradiance = getGradientIrradiance( geometryNormal, directLight.direction ) * directLight.color;\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Toon( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_Toon\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Toon",lights_phong_fragment:"BlinnPhongMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.specularColor = specular;\nmaterial.specularShininess = shininess;\nmaterial.specularStrength = specularStrength;",lights_phong_pars_fragment:"varying vec3 vViewPosition;\nstruct BlinnPhongMaterial {\n\tvec3 diffuseColor;\n\tvec3 specularColor;\n\tfloat specularShininess;\n\tfloat specularStrength;\n};\nvoid RE_Direct_BlinnPhong( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometryNormal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n\treflectedLight.directSpecular += irradiance * BRDF_BlinnPhong( directLight.direction, geometryViewDir, geometryNormal, material.specularColor, material.specularShininess ) * material.specularStrength;\n}\nvoid RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_BlinnPhong\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_BlinnPhong",lights_physical_fragment:"PhysicalMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb * ( 1.0 - metalnessFactor );\nvec3 dxy = max( abs( dFdx( nonPerturbedNormal ) ), abs( dFdy( nonPerturbedNormal ) ) );\nfloat geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );\nmaterial.roughness = max( roughnessFactor, 0.0525 );material.roughness += geometryRoughness;\nmaterial.roughness = min( material.roughness, 1.0 );\n#ifdef IOR\n\tmaterial.ior = ior;\n\t#ifdef USE_SPECULAR\n\t\tfloat specularIntensityFactor = specularIntensity;\n\t\tvec3 specularColorFactor = specularColor;\n\t\t#ifdef USE_SPECULAR_COLORMAP\n\t\t\tspecularColorFactor *= texture2D( specularColorMap, vSpecularColorMapUv ).rgb;\n\t\t#endif\n\t\t#ifdef USE_SPECULAR_INTENSITYMAP\n\t\t\tspecularIntensityFactor *= texture2D( specularIntensityMap, vSpecularIntensityMapUv ).a;\n\t\t#endif\n\t\tmaterial.specularF90 = mix( specularIntensityFactor, 1.0, metalnessFactor );\n\t#else\n\t\tfloat specularIntensityFactor = 1.0;\n\t\tvec3 specularColorFactor = vec3( 1.0 );\n\t\tmaterial.specularF90 = 1.0;\n\t#endif\n\tmaterial.specularColor = mix( min( pow2( ( material.ior - 1.0 ) / ( material.ior + 1.0 ) ) * specularColorFactor, vec3( 1.0 ) ) * specularIntensityFactor, diffuseColor.rgb, metalnessFactor );\n#else\n\tmaterial.specularColor = mix( vec3( 0.04 ), diffuseColor.rgb, metalnessFactor );\n\tmaterial.specularF90 = 1.0;\n#endif\n#ifdef USE_CLEARCOAT\n\tmaterial.clearcoat = clearcoat;\n\tmaterial.clearcoatRoughness = clearcoatRoughness;\n\tmaterial.clearcoatF0 = vec3( 0.04 );\n\tmaterial.clearcoatF90 = 1.0;\n\t#ifdef USE_CLEARCOATMAP\n\t\tmaterial.clearcoat *= texture2D( clearcoatMap, vClearcoatMapUv ).x;\n\t#endif\n\t#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\t\tmaterial.clearcoatRoughness *= texture2D( clearcoatRoughnessMap, vClearcoatRoughnessMapUv ).y;\n\t#endif\n\tmaterial.clearcoat = saturate( material.clearcoat );\tmaterial.clearcoatRoughness = max( material.clearcoatRoughness, 0.0525 );\n\tmaterial.clearcoatRoughness += geometryRoughness;\n\tmaterial.clearcoatRoughness = min( material.clearcoatRoughness, 1.0 );\n#endif\n#ifdef USE_IRIDESCENCE\n\tmaterial.iridescence = iridescence;\n\tmaterial.iridescenceIOR = iridescenceIOR;\n\t#ifdef USE_IRIDESCENCEMAP\n\t\tmaterial.iridescence *= texture2D( iridescenceMap, vIridescenceMapUv ).r;\n\t#endif\n\t#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\t\tmaterial.iridescenceThickness = (iridescenceThicknessMaximum - iridescenceThicknessMinimum) * texture2D( iridescenceThicknessMap, vIridescenceThicknessMapUv ).g + iridescenceThicknessMinimum;\n\t#else\n\t\tmaterial.iridescenceThickness = iridescenceThicknessMaximum;\n\t#endif\n#endif\n#ifdef USE_SHEEN\n\tmaterial.sheenColor = sheenColor;\n\t#ifdef USE_SHEEN_COLORMAP\n\t\tmaterial.sheenColor *= texture2D( sheenColorMap, vSheenColorMapUv ).rgb;\n\t#endif\n\tmaterial.sheenRoughness = clamp( sheenRoughness, 0.07, 1.0 );\n\t#ifdef USE_SHEEN_ROUGHNESSMAP\n\t\tmaterial.sheenRoughness *= texture2D( sheenRoughnessMap, vSheenRoughnessMapUv ).a;\n\t#endif\n#endif\n#ifdef USE_ANISOTROPY\n\t#ifdef USE_ANISOTROPYMAP\n\t\tmat2 anisotropyMat = mat2( anisotropyVector.x, anisotropyVector.y, - anisotropyVector.y, anisotropyVector.x );\n\t\tvec3 anisotropyPolar = texture2D( anisotropyMap, vAnisotropyMapUv ).rgb;\n\t\tvec2 anisotropyV = anisotropyMat * normalize( 2.0 * anisotropyPolar.rg - vec2( 1.0 ) ) * anisotropyPolar.b;\n\t#else\n\t\tvec2 anisotropyV = anisotropyVector;\n\t#endif\n\tmaterial.anisotropy = length( anisotropyV );\n\tif( material.anisotropy == 0.0 ) {\n\t\tanisotropyV = vec2( 1.0, 0.0 );\n\t} else {\n\t\tanisotropyV /= material.anisotropy;\n\t\tmaterial.anisotropy = saturate( material.anisotropy );\n\t}\n\tmaterial.alphaT = mix( pow2( material.roughness ), 1.0, pow2( material.anisotropy ) );\n\tmaterial.anisotropyT = tbn[ 0 ] * anisotropyV.x + tbn[ 1 ] * anisotropyV.y;\n\tmaterial.anisotropyB = tbn[ 1 ] * anisotropyV.x - tbn[ 0 ] * anisotropyV.y;\n#endif",lights_physical_pars_fragment:"struct PhysicalMaterial {\n\tvec3 diffuseColor;\n\tfloat roughness;\n\tvec3 specularColor;\n\tfloat specularF90;\n\t#ifdef USE_CLEARCOAT\n\t\tfloat clearcoat;\n\t\tfloat clearcoatRoughness;\n\t\tvec3 clearcoatF0;\n\t\tfloat clearcoatF90;\n\t#endif\n\t#ifdef USE_IRIDESCENCE\n\t\tfloat iridescence;\n\t\tfloat iridescenceIOR;\n\t\tfloat iridescenceThickness;\n\t\tvec3 iridescenceFresnel;\n\t\tvec3 iridescenceF0;\n\t#endif\n\t#ifdef USE_SHEEN\n\t\tvec3 sheenColor;\n\t\tfloat sheenRoughness;\n\t#endif\n\t#ifdef IOR\n\t\tfloat ior;\n\t#endif\n\t#ifdef USE_TRANSMISSION\n\t\tfloat transmission;\n\t\tfloat transmissionAlpha;\n\t\tfloat thickness;\n\t\tfloat attenuationDistance;\n\t\tvec3 attenuationColor;\n\t#endif\n\t#ifdef USE_ANISOTROPY\n\t\tfloat anisotropy;\n\t\tfloat alphaT;\n\t\tvec3 anisotropyT;\n\t\tvec3 anisotropyB;\n\t#endif\n};\nvec3 clearcoatSpecularDirect = vec3( 0.0 );\nvec3 clearcoatSpecularIndirect = vec3( 0.0 );\nvec3 sheenSpecularDirect = vec3( 0.0 );\nvec3 sheenSpecularIndirect = vec3(0.0 );\nvec3 Schlick_to_F0( const in vec3 f, const in float f90, const in float dotVH ) {\n    float x = clamp( 1.0 - dotVH, 0.0, 1.0 );\n    float x2 = x * x;\n    float x5 = clamp( x * x2 * x2, 0.0, 0.9999 );\n    return ( f - vec3( f90 ) * x5 ) / ( 1.0 - x5 );\n}\nfloat V_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\tfloat gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\treturn 0.5 / max( gv + gl, EPSILON );\n}\nfloat D_GGX( const in float alpha, const in float dotNH ) {\n\tfloat a2 = pow2( alpha );\n\tfloat denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0;\n\treturn RECIPROCAL_PI * a2 / pow2( denom );\n}\n#ifdef USE_ANISOTROPY\n\tfloat V_GGX_SmithCorrelated_Anisotropic( const in float alphaT, const in float alphaB, const in float dotTV, const in float dotBV, const in float dotTL, const in float dotBL, const in float dotNV, const in float dotNL ) {\n\t\tfloat gv = dotNL * length( vec3( alphaT * dotTV, alphaB * dotBV, dotNV ) );\n\t\tfloat gl = dotNV * length( vec3( alphaT * dotTL, alphaB * dotBL, dotNL ) );\n\t\tfloat v = 0.5 / ( gv + gl );\n\t\treturn saturate(v);\n\t}\n\tfloat D_GGX_Anisotropic( const in float alphaT, const in float alphaB, const in float dotNH, const in float dotTH, const in float dotBH ) {\n\t\tfloat a2 = alphaT * alphaB;\n\t\thighp vec3 v = vec3( alphaB * dotTH, alphaT * dotBH, a2 * dotNH );\n\t\thighp float v2 = dot( v, v );\n\t\tfloat w2 = a2 / v2;\n\t\treturn RECIPROCAL_PI * a2 * pow2 ( w2 );\n\t}\n#endif\n#ifdef USE_CLEARCOAT\n\tvec3 BRDF_GGX_Clearcoat( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in PhysicalMaterial material) {\n\t\tvec3 f0 = material.clearcoatF0;\n\t\tfloat f90 = material.clearcoatF90;\n\t\tfloat roughness = material.clearcoatRoughness;\n\t\tfloat alpha = pow2( roughness );\n\t\tvec3 halfDir = normalize( lightDir + viewDir );\n\t\tfloat dotNL = saturate( dot( normal, lightDir ) );\n\t\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\t\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\t\tfloat dotVH = saturate( dot( viewDir, halfDir ) );\n\t\tvec3 F = F_Schlick( f0, f90, dotVH );\n\t\tfloat V = V_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\t\tfloat D = D_GGX( alpha, dotNH );\n\t\treturn F * ( V * D );\n\t}\n#endif\nvec3 BRDF_GGX( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in PhysicalMaterial material ) {\n\tvec3 f0 = material.specularColor;\n\tfloat f90 = material.specularF90;\n\tfloat roughness = material.roughness;\n\tfloat alpha = pow2( roughness );\n\tvec3 halfDir = normalize( lightDir + viewDir );\n\tfloat dotNL = saturate( dot( normal, lightDir ) );\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat dotVH = saturate( dot( viewDir, halfDir ) );\n\tvec3 F = F_Schlick( f0, f90, dotVH );\n\t#ifdef USE_IRIDESCENCE\n\t\tF = mix( F, material.iridescenceFresnel, material.iridescence );\n\t#endif\n\t#ifdef USE_ANISOTROPY\n\t\tfloat dotTL = dot( material.anisotropyT, lightDir );\n\t\tfloat dotTV = dot( material.anisotropyT, viewDir );\n\t\tfloat dotTH = dot( material.anisotropyT, halfDir );\n\t\tfloat dotBL = dot( material.anisotropyB, lightDir );\n\t\tfloat dotBV = dot( material.anisotropyB, viewDir );\n\t\tfloat dotBH = dot( material.anisotropyB, halfDir );\n\t\tfloat V = V_GGX_SmithCorrelated_Anisotropic( material.alphaT, alpha, dotTV, dotBV, dotTL, dotBL, dotNV, dotNL );\n\t\tfloat D = D_GGX_Anisotropic( material.alphaT, alpha, dotNH, dotTH, dotBH );\n\t#else\n\t\tfloat V = V_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\t\tfloat D = D_GGX( alpha, dotNH );\n\t#endif\n\treturn F * ( V * D );\n}\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tfloat dotNV = saturate( dot( N, V ) );\n\tvec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );\n\tuv = uv * LUT_SCALE + LUT_BIAS;\n\treturn uv;\n}\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n\tfloat l = length( f );\n\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n\tfloat x = dot( v1, v2 );\n\tfloat y = abs( x );\n\tfloat a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;\n\tfloat b = 3.4175940 + ( 4.1616724 + y ) * y;\n\tfloat v = a / b;\n\tfloat theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;\n\treturn cross( v1, v2 ) * theta_sintheta;\n}\nvec3 LTC_Evaluate( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in vec3 rectCoords[ 4 ] ) {\n\tvec3 v1 = rectCoords[ 1 ] - rectCoords[ 0 ];\n\tvec3 v2 = rectCoords[ 3 ] - rectCoords[ 0 ];\n\tvec3 lightNormal = cross( v1, v2 );\n\tif( dot( lightNormal, P - rectCoords[ 0 ] ) < 0.0 ) return vec3( 0.0 );\n\tvec3 T1, T2;\n\tT1 = normalize( V - N * dot( V, N ) );\n\tT2 = - cross( N, T1 );\n\tmat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );\n\tvec3 coords[ 4 ];\n\tcoords[ 0 ] = mat * ( rectCoords[ 0 ] - P );\n\tcoords[ 1 ] = mat * ( rectCoords[ 1 ] - P );\n\tcoords[ 2 ] = mat * ( rectCoords[ 2 ] - P );\n\tcoords[ 3 ] = mat * ( rectCoords[ 3 ] - P );\n\tcoords[ 0 ] = normalize( coords[ 0 ] );\n\tcoords[ 1 ] = normalize( coords[ 1 ] );\n\tcoords[ 2 ] = normalize( coords[ 2 ] );\n\tcoords[ 3 ] = normalize( coords[ 3 ] );\n\tvec3 vectorFormFactor = vec3( 0.0 );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n\tfloat result = LTC_ClippedSphereFormFactor( vectorFormFactor );\n\treturn vec3( result );\n}\n#if defined( USE_SHEEN )\nfloat D_Charlie( float roughness, float dotNH ) {\n\tfloat alpha = pow2( roughness );\n\tfloat invAlpha = 1.0 / alpha;\n\tfloat cos2h = dotNH * dotNH;\n\tfloat sin2h = max( 1.0 - cos2h, 0.0078125 );\n\treturn ( 2.0 + invAlpha ) * pow( sin2h, invAlpha * 0.5 ) / ( 2.0 * PI );\n}\nfloat V_Neubelt( float dotNV, float dotNL ) {\n\treturn saturate( 1.0 / ( 4.0 * ( dotNL + dotNV - dotNL * dotNV ) ) );\n}\nvec3 BRDF_Sheen( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, vec3 sheenColor, const in float sheenRoughness ) {\n\tvec3 halfDir = normalize( lightDir + viewDir );\n\tfloat dotNL = saturate( dot( normal, lightDir ) );\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat D = D_Charlie( sheenRoughness, dotNH );\n\tfloat V = V_Neubelt( dotNV, dotNL );\n\treturn sheenColor * ( D * V );\n}\n#endif\nfloat IBLSheenBRDF( const in vec3 normal, const in vec3 viewDir, const in float roughness ) {\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat r2 = roughness * roughness;\n\tfloat a = roughness < 0.25 ? -339.2 * r2 + 161.4 * roughness - 25.9 : -8.48 * r2 + 14.3 * roughness - 9.95;\n\tfloat b = roughness < 0.25 ? 44.0 * r2 - 23.7 * roughness + 3.26 : 1.97 * r2 - 3.27 * roughness + 0.72;\n\tfloat DG = exp( a * dotNV + b ) + ( roughness < 0.25 ? 0.0 : 0.1 * ( roughness - 0.25 ) );\n\treturn saturate( DG * RECIPROCAL_PI );\n}\nvec2 DFGApprox( const in vec3 normal, const in vec3 viewDir, const in float roughness ) {\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tconst vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );\n\tconst vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );\n\tvec4 r = roughness * c0 + c1;\n\tfloat a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;\n\tvec2 fab = vec2( - 1.04, 1.04 ) * a004 + r.zw;\n\treturn fab;\n}\nvec3 EnvironmentBRDF( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness ) {\n\tvec2 fab = DFGApprox( normal, viewDir, roughness );\n\treturn specularColor * fab.x + specularF90 * fab.y;\n}\n#ifdef USE_IRIDESCENCE\nvoid computeMultiscatteringIridescence( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float iridescence, const in vec3 iridescenceF0, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {\n#else\nvoid computeMultiscattering( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {\n#endif\n\tvec2 fab = DFGApprox( normal, viewDir, roughness );\n\t#ifdef USE_IRIDESCENCE\n\t\tvec3 Fr = mix( specularColor, iridescenceF0, iridescence );\n\t#else\n\t\tvec3 Fr = specularColor;\n\t#endif\n\tvec3 FssEss = Fr * fab.x + specularF90 * fab.y;\n\tfloat Ess = fab.x + fab.y;\n\tfloat Ems = 1.0 - Ess;\n\tvec3 Favg = Fr + ( 1.0 - Fr ) * 0.047619;\tvec3 Fms = FssEss * Favg / ( 1.0 - Ems * Favg );\n\tsingleScatter += FssEss;\n\tmultiScatter += Fms * Ems;\n}\n#if NUM_RECT_AREA_LIGHTS > 0\n\tvoid RE_Direct_RectArea_Physical( const in RectAreaLight rectAreaLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\t\tvec3 normal = geometryNormal;\n\t\tvec3 viewDir = geometryViewDir;\n\t\tvec3 position = geometryPosition;\n\t\tvec3 lightPos = rectAreaLight.position;\n\t\tvec3 halfWidth = rectAreaLight.halfWidth;\n\t\tvec3 halfHeight = rectAreaLight.halfHeight;\n\t\tvec3 lightColor = rectAreaLight.color;\n\t\tfloat roughness = material.roughness;\n\t\tvec3 rectCoords[ 4 ];\n\t\trectCoords[ 0 ] = lightPos + halfWidth - halfHeight;\t\trectCoords[ 1 ] = lightPos - halfWidth - halfHeight;\n\t\trectCoords[ 2 ] = lightPos - halfWidth + halfHeight;\n\t\trectCoords[ 3 ] = lightPos + halfWidth + halfHeight;\n\t\tvec2 uv = LTC_Uv( normal, viewDir, roughness );\n\t\tvec4 t1 = texture2D( ltc_1, uv );\n\t\tvec4 t2 = texture2D( ltc_2, uv );\n\t\tmat3 mInv = mat3(\n\t\t\tvec3( t1.x, 0, t1.y ),\n\t\t\tvec3(    0, 1,    0 ),\n\t\t\tvec3( t1.z, 0, t1.w )\n\t\t);\n\t\tvec3 fresnel = ( material.specularColor * t2.x + ( vec3( 1.0 ) - material.specularColor ) * t2.y );\n\t\treflectedLight.directSpecular += lightColor * fresnel * LTC_Evaluate( normal, viewDir, position, mInv, rectCoords );\n\t\treflectedLight.directDiffuse += lightColor * material.diffuseColor * LTC_Evaluate( normal, viewDir, position, mat3( 1.0 ), rectCoords );\n\t}\n#endif\nvoid RE_Direct_Physical( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometryNormal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\t#ifdef USE_CLEARCOAT\n\t\tfloat dotNLcc = saturate( dot( geometryClearcoatNormal, directLight.direction ) );\n\t\tvec3 ccIrradiance = dotNLcc * directLight.color;\n\t\tclearcoatSpecularDirect += ccIrradiance * BRDF_GGX_Clearcoat( directLight.direction, geometryViewDir, geometryClearcoatNormal, material );\n\t#endif\n\t#ifdef USE_SHEEN\n\t\tsheenSpecularDirect += irradiance * BRDF_Sheen( directLight.direction, geometryViewDir, geometryNormal, material.sheenColor, material.sheenRoughness );\n\t#endif\n\treflectedLight.directSpecular += irradiance * BRDF_GGX( directLight.direction, geometryViewDir, geometryNormal, material );\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 irradiance, const in vec3 clearcoatRadiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight) {\n\t#ifdef USE_CLEARCOAT\n\t\tclearcoatSpecularIndirect += clearcoatRadiance * EnvironmentBRDF( geometryClearcoatNormal, geometryViewDir, material.clearcoatF0, material.clearcoatF90, material.clearcoatRoughness );\n\t#endif\n\t#ifdef USE_SHEEN\n\t\tsheenSpecularIndirect += irradiance * material.sheenColor * IBLSheenBRDF( geometryNormal, geometryViewDir, material.sheenRoughness );\n\t#endif\n\tvec3 singleScattering = vec3( 0.0 );\n\tvec3 multiScattering = vec3( 0.0 );\n\tvec3 cosineWeightedIrradiance = irradiance * RECIPROCAL_PI;\n\t#ifdef USE_IRIDESCENCE\n\t\tcomputeMultiscatteringIridescence( geometryNormal, geometryViewDir, material.specularColor, material.specularF90, material.iridescence, material.iridescenceFresnel, material.roughness, singleScattering, multiScattering );\n\t#else\n\t\tcomputeMultiscattering( geometryNormal, geometryViewDir, material.specularColor, material.specularF90, material.roughness, singleScattering, multiScattering );\n\t#endif\n\tvec3 totalScattering = singleScattering + multiScattering;\n\tvec3 diffuse = material.diffuseColor * ( 1.0 - max( max( totalScattering.r, totalScattering.g ), totalScattering.b ) );\n\treflectedLight.indirectSpecular += radiance * singleScattering;\n\treflectedLight.indirectSpecular += multiScattering * cosineWeightedIrradiance;\n\treflectedLight.indirectDiffuse += diffuse * cosineWeightedIrradiance;\n}\n#define RE_Direct\t\t\t\tRE_Direct_Physical\n#define RE_Direct_RectArea\t\tRE_Direct_RectArea_Physical\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Physical\n#define RE_IndirectSpecular\t\tRE_IndirectSpecular_Physical\nfloat computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {\n\treturn saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );\n}",lights_fragment_begin:"\nvec3 geometryPosition = - vViewPosition;\nvec3 geometryNormal = normal;\nvec3 geometryViewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( vViewPosition );\nvec3 geometryClearcoatNormal = vec3( 0.0 );\n#ifdef USE_CLEARCOAT\n\tgeometryClearcoatNormal = clearcoatNormal;\n#endif\n#ifdef USE_IRIDESCENCE\n\tfloat dotNVi = saturate( dot( normal, geometryViewDir ) );\n\tif ( material.iridescenceThickness == 0.0 ) {\n\t\tmaterial.iridescence = 0.0;\n\t} else {\n\t\tmaterial.iridescence = saturate( material.iridescence );\n\t}\n\tif ( material.iridescence > 0.0 ) {\n\t\tmaterial.iridescenceFresnel = evalIridescence( 1.0, material.iridescenceIOR, dotNVi, material.iridescenceThickness, material.specularColor );\n\t\tmaterial.iridescenceF0 = Schlick_to_F0( material.iridescenceFresnel, 1.0, dotNVi );\n\t}\n#endif\nIncidentLight directLight;\n#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )\n\tPointLight pointLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tpointLight = pointLights[ i ];\n\t\tgetPointLightInfo( pointLight, geometryPosition, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS )\n\t\tpointLightShadow = pointLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ], pointLightShadow.shadowCameraNear, pointLightShadow.shadowCameraFar ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )\n\tSpotLight spotLight;\n\tvec4 spotColor;\n\tvec3 spotLightCoord;\n\tbool inSpotLightMap;\n\t#if defined( USE_SHADOWMAP ) && NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tspotLight = spotLights[ i ];\n\t\tgetSpotLightInfo( spotLight, geometryPosition, directLight );\n\t\t#if ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )\n\t\t#define SPOT_LIGHT_MAP_INDEX UNROLLED_LOOP_INDEX\n\t\t#elif ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\t#define SPOT_LIGHT_MAP_INDEX NUM_SPOT_LIGHT_MAPS\n\t\t#else\n\t\t#define SPOT_LIGHT_MAP_INDEX ( UNROLLED_LOOP_INDEX - NUM_SPOT_LIGHT_SHADOWS + NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )\n\t\t#endif\n\t\t#if ( SPOT_LIGHT_MAP_INDEX < NUM_SPOT_LIGHT_MAPS )\n\t\t\tspotLightCoord = vSpotLightCoord[ i ].xyz / vSpotLightCoord[ i ].w;\n\t\t\tinSpotLightMap = all( lessThan( abs( spotLightCoord * 2. - 1. ), vec3( 1.0 ) ) );\n\t\t\tspotColor = texture2D( spotLightMap[ SPOT_LIGHT_MAP_INDEX ], spotLightCoord.xy );\n\t\t\tdirectLight.color = inSpotLightMap ? directLight.color * spotColor.rgb : directLight.color;\n\t\t#endif\n\t\t#undef SPOT_LIGHT_MAP_INDEX\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\tspotLightShadow = spotLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )\n\tDirectionalLight directionalLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tdirectionalLight = directionalLights[ i ];\n\t\tgetDirectionalLightInfo( directionalLight, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n\t\tdirectionalLightShadow = directionalLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )\n\tRectAreaLight rectAreaLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {\n\t\trectAreaLight = rectAreaLights[ i ];\n\t\tRE_Direct_RectArea( rectAreaLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if defined( RE_IndirectDiffuse )\n\tvec3 iblIrradiance = vec3( 0.0 );\n\tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );\n\t#if defined( USE_LIGHT_PROBES )\n\t\tirradiance += getLightProbeIrradiance( lightProbe, geometryNormal );\n\t#endif\n\t#if ( NUM_HEMI_LIGHTS > 0 )\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometryNormal );\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n#endif\n#if defined( RE_IndirectSpecular )\n\tvec3 radiance = vec3( 0.0 );\n\tvec3 clearcoatRadiance = vec3( 0.0 );\n#endif",lights_fragment_maps:"#if defined( RE_IndirectDiffuse )\n\t#ifdef USE_LIGHTMAP\n\t\tvec4 lightMapTexel = texture2D( lightMap, vLightMapUv );\n\t\tvec3 lightMapIrradiance = lightMapTexel.rgb * lightMapIntensity;\n\t\tirradiance += lightMapIrradiance;\n\t#endif\n\t#if defined( USE_ENVMAP ) && defined( STANDARD ) && defined( ENVMAP_TYPE_CUBE_UV )\n\t\tiblIrradiance += getIBLIrradiance( geometryNormal );\n\t#endif\n#endif\n#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )\n\t#ifdef USE_ANISOTROPY\n\t\tradiance += getIBLAnisotropyRadiance( geometryViewDir, geometryNormal, material.roughness, material.anisotropyB, material.anisotropy );\n\t#else\n\t\tradiance += getIBLRadiance( geometryViewDir, geometryNormal, material.roughness );\n\t#endif\n\t#ifdef USE_CLEARCOAT\n\t\tclearcoatRadiance += getIBLRadiance( geometryViewDir, geometryClearcoatNormal, material.clearcoatRoughness );\n\t#endif\n#endif",lights_fragment_end:"#if defined( RE_IndirectDiffuse )\n\tRE_IndirectDiffuse( irradiance, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n#endif\n#if defined( RE_IndirectSpecular )\n\tRE_IndirectSpecular( radiance, iblIrradiance, clearcoatRadiance, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n#endif",logdepthbuf_fragment:"#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n\tgl_FragDepthEXT = vIsPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;\n#endif",logdepthbuf_pars_fragment:"#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n\tuniform float logDepthBufFC;\n\tvarying float vFragDepth;\n\tvarying float vIsPerspective;\n#endif",logdepthbuf_pars_vertex:"#ifdef USE_LOGDEPTHBUF\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvarying float vFragDepth;\n\t\tvarying float vIsPerspective;\n\t#else\n\t\tuniform float logDepthBufFC;\n\t#endif\n#endif",logdepthbuf_vertex:"#ifdef USE_LOGDEPTHBUF\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvFragDepth = 1.0 + gl_Position.w;\n\t\tvIsPerspective = float( isPerspectiveMatrix( projectionMatrix ) );\n\t#else\n\t\tif ( isPerspectiveMatrix( projectionMatrix ) ) {\n\t\t\tgl_Position.z = log2( max( EPSILON, gl_Position.w + 1.0 ) ) * logDepthBufFC - 1.0;\n\t\t\tgl_Position.z *= gl_Position.w;\n\t\t}\n\t#endif\n#endif",map_fragment:"#ifdef USE_MAP\n\tvec4 sampledDiffuseColor = texture2D( map, vMapUv );\n\t#ifdef DECODE_VIDEO_TEXTURE\n\t\tsampledDiffuseColor = vec4( mix( pow( sampledDiffuseColor.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), sampledDiffuseColor.rgb * 0.0773993808, vec3( lessThanEqual( sampledDiffuseColor.rgb, vec3( 0.04045 ) ) ) ), sampledDiffuseColor.w );\n\t\n\t#endif\n\tdiffuseColor *= sampledDiffuseColor;\n#endif",map_pars_fragment:"#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif",map_particle_fragment:"#if defined( USE_MAP ) || defined( USE_ALPHAMAP )\n\t#if defined( USE_POINTS_UV )\n\t\tvec2 uv = vUv;\n\t#else\n\t\tvec2 uv = ( uvTransform * vec3( gl_PointCoord.x, 1.0 - gl_PointCoord.y, 1 ) ).xy;\n\t#endif\n#endif\n#ifdef USE_MAP\n\tdiffuseColor *= texture2D( map, uv );\n#endif\n#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, uv ).g;\n#endif",map_particle_pars_fragment:"#if defined( USE_POINTS_UV )\n\tvarying vec2 vUv;\n#else\n\t#if defined( USE_MAP ) || defined( USE_ALPHAMAP )\n\t\tuniform mat3 uvTransform;\n\t#endif\n#endif\n#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif\n#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif",metalnessmap_fragment:"float metalnessFactor = metalness;\n#ifdef USE_METALNESSMAP\n\tvec4 texelMetalness = texture2D( metalnessMap, vMetalnessMapUv );\n\tmetalnessFactor *= texelMetalness.b;\n#endif",metalnessmap_pars_fragment:"#ifdef USE_METALNESSMAP\n\tuniform sampler2D metalnessMap;\n#endif",morphcolor_vertex:"#if defined( USE_MORPHCOLORS ) && defined( MORPHTARGETS_TEXTURE )\n\tvColor *= morphTargetBaseInfluence;\n\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\t#if defined( USE_COLOR_ALPHA )\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) vColor += getMorph( gl_VertexID, i, 2 ) * morphTargetInfluences[ i ];\n\t\t#elif defined( USE_COLOR )\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) vColor += getMorph( gl_VertexID, i, 2 ).rgb * morphTargetInfluences[ i ];\n\t\t#endif\n\t}\n#endif",morphnormal_vertex:"#ifdef USE_MORPHNORMALS\n\tobjectNormal *= morphTargetBaseInfluence;\n\t#ifdef MORPHTARGETS_TEXTURE\n\t\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) objectNormal += getMorph( gl_VertexID, i, 1 ).xyz * morphTargetInfluences[ i ];\n\t\t}\n\t#else\n\t\tobjectNormal += morphNormal0 * morphTargetInfluences[ 0 ];\n\t\tobjectNormal += morphNormal1 * morphTargetInfluences[ 1 ];\n\t\tobjectNormal += morphNormal2 * morphTargetInfluences[ 2 ];\n\t\tobjectNormal += morphNormal3 * morphTargetInfluences[ 3 ];\n\t#endif\n#endif",morphtarget_pars_vertex:"#ifdef USE_MORPHTARGETS\n\tuniform float morphTargetBaseInfluence;\n\t#ifdef MORPHTARGETS_TEXTURE\n\t\tuniform float morphTargetInfluences[ MORPHTARGETS_COUNT ];\n\t\tuniform sampler2DArray morphTargetsTexture;\n\t\tuniform ivec2 morphTargetsTextureSize;\n\t\tvec4 getMorph( const in int vertexIndex, const in int morphTargetIndex, const in int offset ) {\n\t\t\tint texelIndex = vertexIndex * MORPHTARGETS_TEXTURE_STRIDE + offset;\n\t\t\tint y = texelIndex / morphTargetsTextureSize.x;\n\t\t\tint x = texelIndex - y * morphTargetsTextureSize.x;\n\t\t\tivec3 morphUV = ivec3( x, y, morphTargetIndex );\n\t\t\treturn texelFetch( morphTargetsTexture, morphUV, 0 );\n\t\t}\n\t#else\n\t\t#ifndef USE_MORPHNORMALS\n\t\t\tuniform float morphTargetInfluences[ 8 ];\n\t\t#else\n\t\t\tuniform float morphTargetInfluences[ 4 ];\n\t\t#endif\n\t#endif\n#endif",morphtarget_vertex:"#ifdef USE_MORPHTARGETS\n\ttransformed *= morphTargetBaseInfluence;\n\t#ifdef MORPHTARGETS_TEXTURE\n\t\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) transformed += getMorph( gl_VertexID, i, 0 ).xyz * morphTargetInfluences[ i ];\n\t\t}\n\t#else\n\t\ttransformed += morphTarget0 * morphTargetInfluences[ 0 ];\n\t\ttransformed += morphTarget1 * morphTargetInfluences[ 1 ];\n\t\ttransformed += morphTarget2 * morphTargetInfluences[ 2 ];\n\t\ttransformed += morphTarget3 * morphTargetInfluences[ 3 ];\n\t\t#ifndef USE_MORPHNORMALS\n\t\t\ttransformed += morphTarget4 * morphTargetInfluences[ 4 ];\n\t\t\ttransformed += morphTarget5 * morphTargetInfluences[ 5 ];\n\t\t\ttransformed += morphTarget6 * morphTargetInfluences[ 6 ];\n\t\t\ttransformed += morphTarget7 * morphTargetInfluences[ 7 ];\n\t\t#endif\n\t#endif\n#endif",normal_fragment_begin:"float faceDirection = gl_FrontFacing ? 1.0 : - 1.0;\n#ifdef FLAT_SHADED\n\tvec3 fdx = dFdx( vViewPosition );\n\tvec3 fdy = dFdy( vViewPosition );\n\tvec3 normal = normalize( cross( fdx, fdy ) );\n#else\n\tvec3 normal = normalize( vNormal );\n\t#ifdef DOUBLE_SIDED\n\t\tnormal *= faceDirection;\n\t#endif\n#endif\n#if defined( USE_NORMALMAP_TANGENTSPACE ) || defined( USE_CLEARCOAT_NORMALMAP ) || defined( USE_ANISOTROPY )\n\t#ifdef USE_TANGENT\n\t\tmat3 tbn = mat3( normalize( vTangent ), normalize( vBitangent ), normal );\n\t#else\n\t\tmat3 tbn = getTangentFrame( - vViewPosition, normal,\n\t\t#if defined( USE_NORMALMAP )\n\t\t\tvNormalMapUv\n\t\t#elif defined( USE_CLEARCOAT_NORMALMAP )\n\t\t\tvClearcoatNormalMapUv\n\t\t#else\n\t\t\tvUv\n\t\t#endif\n\t\t);\n\t#endif\n\t#if defined( DOUBLE_SIDED ) && ! defined( FLAT_SHADED )\n\t\ttbn[0] *= faceDirection;\n\t\ttbn[1] *= faceDirection;\n\t#endif\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\t#ifdef USE_TANGENT\n\t\tmat3 tbn2 = mat3( normalize( vTangent ), normalize( vBitangent ), normal );\n\t#else\n\t\tmat3 tbn2 = getTangentFrame( - vViewPosition, normal, vClearcoatNormalMapUv );\n\t#endif\n\t#if defined( DOUBLE_SIDED ) && ! defined( FLAT_SHADED )\n\t\ttbn2[0] *= faceDirection;\n\t\ttbn2[1] *= faceDirection;\n\t#endif\n#endif\nvec3 nonPerturbedNormal = normal;",normal_fragment_maps:"#ifdef USE_NORMALMAP_OBJECTSPACE\n\tnormal = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;\n\t#ifdef FLIP_SIDED\n\t\tnormal = - normal;\n\t#endif\n\t#ifdef DOUBLE_SIDED\n\t\tnormal = normal * faceDirection;\n\t#endif\n\tnormal = normalize( normalMatrix * normal );\n#elif defined( USE_NORMALMAP_TANGENTSPACE )\n\tvec3 mapN = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;\n\tmapN.xy *= normalScale;\n\tnormal = normalize( tbn * mapN );\n#elif defined( USE_BUMPMAP )\n\tnormal = perturbNormalArb( - vViewPosition, normal, dHdxy_fwd(), faceDirection );\n#endif",normal_pars_fragment:"#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif",normal_pars_vertex:"#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif",normal_vertex:"#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n\t#ifdef USE_TANGENT\n\t\tvTangent = normalize( transformedTangent );\n\t\tvBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );\n\t#endif\n#endif",normalmap_pars_fragment:"#ifdef USE_NORMALMAP\n\tuniform sampler2D normalMap;\n\tuniform vec2 normalScale;\n#endif\n#ifdef USE_NORMALMAP_OBJECTSPACE\n\tuniform mat3 normalMatrix;\n#endif\n#if ! defined ( USE_TANGENT ) && ( defined ( USE_NORMALMAP_TANGENTSPACE ) || defined ( USE_CLEARCOAT_NORMALMAP ) || defined( USE_ANISOTROPY ) )\n\tmat3 getTangentFrame( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {\n\t\tvec3 q0 = dFdx( eye_pos.xyz );\n\t\tvec3 q1 = dFdy( eye_pos.xyz );\n\t\tvec2 st0 = dFdx( uv.st );\n\t\tvec2 st1 = dFdy( uv.st );\n\t\tvec3 N = surf_norm;\n\t\tvec3 q1perp = cross( q1, N );\n\t\tvec3 q0perp = cross( N, q0 );\n\t\tvec3 T = q1perp * st0.x + q0perp * st1.x;\n\t\tvec3 B = q1perp * st0.y + q0perp * st1.y;\n\t\tfloat det = max( dot( T, T ), dot( B, B ) );\n\t\tfloat scale = ( det == 0.0 ) ? 0.0 : inversesqrt( det );\n\t\treturn mat3( T * scale, B * scale, N );\n\t}\n#endif",clearcoat_normal_fragment_begin:"#ifdef USE_CLEARCOAT\n\tvec3 clearcoatNormal = nonPerturbedNormal;\n#endif",clearcoat_normal_fragment_maps:"#ifdef USE_CLEARCOAT_NORMALMAP\n\tvec3 clearcoatMapN = texture2D( clearcoatNormalMap, vClearcoatNormalMapUv ).xyz * 2.0 - 1.0;\n\tclearcoatMapN.xy *= clearcoatNormalScale;\n\tclearcoatNormal = normalize( tbn2 * clearcoatMapN );\n#endif",clearcoat_pars_fragment:"#ifdef USE_CLEARCOATMAP\n\tuniform sampler2D clearcoatMap;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tuniform sampler2D clearcoatNormalMap;\n\tuniform vec2 clearcoatNormalScale;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tuniform sampler2D clearcoatRoughnessMap;\n#endif",iridescence_pars_fragment:"#ifdef USE_IRIDESCENCEMAP\n\tuniform sampler2D iridescenceMap;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tuniform sampler2D iridescenceThicknessMap;\n#endif",opaque_fragment:"#ifdef OPAQUE\ndiffuseColor.a = 1.0;\n#endif\n#ifdef USE_TRANSMISSION\ndiffuseColor.a *= material.transmissionAlpha;\n#endif\ngl_FragColor = vec4( outgoingLight, diffuseColor.a );",packing:"vec3 packNormalToRGB( const in vec3 normal ) {\n\treturn normalize( normal ) * 0.5 + 0.5;\n}\nvec3 unpackRGBToNormal( const in vec3 rgb ) {\n\treturn 2.0 * rgb.xyz - 1.0;\n}\nconst float PackUpscale = 256. / 255.;const float UnpackDownscale = 255. / 256.;\nconst vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256., 256. );\nconst vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\nconst float ShiftRight8 = 1. / 256.;\nvec4 packDepthToRGBA( const in float v ) {\n\tvec4 r = vec4( fract( v * PackFactors ), v );\n\tr.yzw -= r.xyz * ShiftRight8;\treturn r * PackUpscale;\n}\nfloat unpackRGBAToDepth( const in vec4 v ) {\n\treturn dot( v, UnpackFactors );\n}\nvec2 packDepthToRG( in highp float v ) {\n\treturn packDepthToRGBA( v ).yx;\n}\nfloat unpackRGToDepth( const in highp vec2 v ) {\n\treturn unpackRGBAToDepth( vec4( v.xy, 0.0, 0.0 ) );\n}\nvec4 pack2HalfToRGBA( vec2 v ) {\n\tvec4 r = vec4( v.x, fract( v.x * 255.0 ), v.y, fract( v.y * 255.0 ) );\n\treturn vec4( r.x - r.y / 255.0, r.y, r.z - r.w / 255.0, r.w );\n}\nvec2 unpackRGBATo2Half( vec4 v ) {\n\treturn vec2( v.x + ( v.y / 255.0 ), v.z + ( v.w / 255.0 ) );\n}\nfloat viewZToOrthographicDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn ( viewZ + near ) / ( near - far );\n}\nfloat orthographicDepthToViewZ( const in float depth, const in float near, const in float far ) {\n\treturn depth * ( near - far ) - near;\n}\nfloat viewZToPerspectiveDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn ( ( near + viewZ ) * far ) / ( ( far - near ) * viewZ );\n}\nfloat perspectiveDepthToViewZ( const in float depth, const in float near, const in float far ) {\n\treturn ( near * far ) / ( ( far - near ) * depth - far );\n}",premultiplied_alpha_fragment:"#ifdef PREMULTIPLIED_ALPHA\n\tgl_FragColor.rgb *= gl_FragColor.a;\n#endif",project_vertex:"vec4 mvPosition = vec4( transformed, 1.0 );\n#ifdef USE_BATCHING\n\tmvPosition = batchingMatrix * mvPosition;\n#endif\n#ifdef USE_INSTANCING\n\tmvPosition = instanceMatrix * mvPosition;\n#endif\nmvPosition = modelViewMatrix * mvPosition;\ngl_Position = projectionMatrix * mvPosition;",dithering_fragment:"#ifdef DITHERING\n\tgl_FragColor.rgb = dithering( gl_FragColor.rgb );\n#endif",dithering_pars_fragment:"#ifdef DITHERING\n\tvec3 dithering( vec3 color ) {\n\t\tfloat grid_position = rand( gl_FragCoord.xy );\n\t\tvec3 dither_shift_RGB = vec3( 0.25 / 255.0, -0.25 / 255.0, 0.25 / 255.0 );\n\t\tdither_shift_RGB = mix( 2.0 * dither_shift_RGB, -2.0 * dither_shift_RGB, grid_position );\n\t\treturn color + dither_shift_RGB;\n\t}\n#endif",roughnessmap_fragment:"float roughnessFactor = roughness;\n#ifdef USE_ROUGHNESSMAP\n\tvec4 texelRoughness = texture2D( roughnessMap, vRoughnessMapUv );\n\troughnessFactor *= texelRoughness.g;\n#endif",roughnessmap_pars_fragment:"#ifdef USE_ROUGHNESSMAP\n\tuniform sampler2D roughnessMap;\n#endif",shadowmap_pars_fragment:"#if NUM_SPOT_LIGHT_COORDS > 0\n\tvarying vec4 vSpotLightCoord[ NUM_SPOT_LIGHT_COORDS ];\n#endif\n#if NUM_SPOT_LIGHT_MAPS > 0\n\tuniform sampler2D spotLightMap[ NUM_SPOT_LIGHT_MAPS ];\n#endif\n#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D directionalShadowMap[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tstruct DirectionalLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D spotShadowMap[ NUM_SPOT_LIGHT_SHADOWS ];\n\t\tstruct SpotLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D pointShadowMap[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tstruct PointLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\t\tuniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];\n\t#endif\n\tfloat texture2DCompare( sampler2D depths, vec2 uv, float compare ) {\n\t\treturn step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );\n\t}\n\tvec2 texture2DDistribution( sampler2D shadow, vec2 uv ) {\n\t\treturn unpackRGBATo2Half( texture2D( shadow, uv ) );\n\t}\n\tfloat VSMShadow (sampler2D shadow, vec2 uv, float compare ){\n\t\tfloat occlusion = 1.0;\n\t\tvec2 distribution = texture2DDistribution( shadow, uv );\n\t\tfloat hard_shadow = step( compare , distribution.x );\n\t\tif (hard_shadow != 1.0 ) {\n\t\t\tfloat distance = compare - distribution.x ;\n\t\t\tfloat variance = max( 0.00000, distribution.y * distribution.y );\n\t\t\tfloat softness_probability = variance / (variance + distance * distance );\t\t\tsoftness_probability = clamp( ( softness_probability - 0.3 ) / ( 0.95 - 0.3 ), 0.0, 1.0 );\t\t\tocclusion = clamp( max( hard_shadow, softness_probability ), 0.0, 1.0 );\n\t\t}\n\t\treturn occlusion;\n\t}\n\tfloat getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {\n\t\tfloat shadow = 1.0;\n\t\tshadowCoord.xyz /= shadowCoord.w;\n\t\tshadowCoord.z += shadowBias;\n\t\tbool inFrustum = shadowCoord.x >= 0.0 && shadowCoord.x <= 1.0 && shadowCoord.y >= 0.0 && shadowCoord.y <= 1.0;\n\t\tbool frustumTest = inFrustum && shadowCoord.z <= 1.0;\n\t\tif ( frustumTest ) {\n\t\t#if defined( SHADOWMAP_TYPE_PCF )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\t\t\tfloat dx2 = dx0 / 2.0;\n\t\t\tfloat dy2 = dy0 / 2.0;\n\t\t\tfloat dx3 = dx1 / 2.0;\n\t\t\tfloat dy3 = dy1 / 2.0;\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t) * ( 1.0 / 17.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_PCF_SOFT )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx = texelSize.x;\n\t\t\tfloat dy = texelSize.y;\n\t\t\tvec2 uv = shadowCoord.xy;\n\t\t\tvec2 f = fract( uv * shadowMapSize + 0.5 );\n\t\t\tuv -= f * texelSize;\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, uv, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + vec2( dx, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + vec2( 0.0, dy ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + texelSize, shadowCoord.z ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( -dx, 0.0 ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 0.0 ), shadowCoord.z ),\n\t\t\t\t\t f.x ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( -dx, dy ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, dy ), shadowCoord.z ),\n\t\t\t\t\t f.x ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( 0.0, -dy ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 0.0, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t f.y ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t f.y ) +\n\t\t\t\tmix( mix( texture2DCompare( shadowMap, uv + vec2( -dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t\t  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t\t  f.x ),\n\t\t\t\t\t mix( texture2DCompare( shadowMap, uv + vec2( -dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t\t  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t\t  f.x ),\n\t\t\t\t\t f.y )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_VSM )\n\t\t\tshadow = VSMShadow( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#else\n\t\t\tshadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#endif\n\t\t}\n\t\treturn shadow;\n\t}\n\tvec2 cubeToUV( vec3 v, float texelSizeY ) {\n\t\tvec3 absV = abs( v );\n\t\tfloat scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );\n\t\tabsV *= scaleToCube;\n\t\tv *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );\n\t\tvec2 planar = v.xy;\n\t\tfloat almostATexel = 1.5 * texelSizeY;\n\t\tfloat almostOne = 1.0 - almostATexel;\n\t\tif ( absV.z >= almostOne ) {\n\t\t\tif ( v.z > 0.0 )\n\t\t\t\tplanar.x = 4.0 - v.x;\n\t\t} else if ( absV.x >= almostOne ) {\n\t\t\tfloat signX = sign( v.x );\n\t\t\tplanar.x = v.z * signX + 2.0 * signX;\n\t\t} else if ( absV.y >= almostOne ) {\n\t\t\tfloat signY = sign( v.y );\n\t\t\tplanar.x = v.x + 2.0 * signY + 2.0;\n\t\t\tplanar.y = v.z * signY - 2.0;\n\t\t}\n\t\treturn vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );\n\t}\n\tfloat getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord, float shadowCameraNear, float shadowCameraFar ) {\n\t\tvec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );\n\t\tvec3 lightToPosition = shadowCoord.xyz;\n\t\tfloat dp = ( length( lightToPosition ) - shadowCameraNear ) / ( shadowCameraFar - shadowCameraNear );\t\tdp += shadowBias;\n\t\tvec3 bd3D = normalize( lightToPosition );\n\t\t#if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT ) || defined( SHADOWMAP_TYPE_VSM )\n\t\t\tvec2 offset = vec2( - 1, 1 ) * shadowRadius * texelSize.y;\n\t\t\treturn (\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxx, texelSize.y ), dp )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#else\n\t\t\treturn texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp );\n\t\t#endif\n\t}\n#endif",shadowmap_pars_vertex:"#if NUM_SPOT_LIGHT_COORDS > 0\n\tuniform mat4 spotLightMatrix[ NUM_SPOT_LIGHT_COORDS ];\n\tvarying vec4 vSpotLightCoord[ NUM_SPOT_LIGHT_COORDS ];\n#endif\n#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\tuniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tstruct DirectionalLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t\tstruct SpotLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\tuniform mat4 pointShadowMatrix[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tstruct PointLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\t\tuniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];\n\t#endif\n#endif",shadowmap_vertex:"#if ( defined( USE_SHADOWMAP ) && ( NUM_DIR_LIGHT_SHADOWS > 0 || NUM_POINT_LIGHT_SHADOWS > 0 ) ) || ( NUM_SPOT_LIGHT_COORDS > 0 )\n\tvec3 shadowWorldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\tvec4 shadowWorldPosition;\n#endif\n#if defined( USE_SHADOWMAP )\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {\n\t\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * directionalLightShadows[ i ].shadowNormalBias, 0 );\n\t\t\tvDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * shadowWorldPosition;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {\n\t\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * pointLightShadows[ i ].shadowNormalBias, 0 );\n\t\t\tvPointShadowCoord[ i ] = pointShadowMatrix[ i ] * shadowWorldPosition;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n#endif\n#if NUM_SPOT_LIGHT_COORDS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHT_COORDS; i ++ ) {\n\t\tshadowWorldPosition = worldPosition;\n\t\t#if ( defined( USE_SHADOWMAP ) && UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\t\tshadowWorldPosition.xyz += shadowWorldNormal * spotLightShadows[ i ].shadowNormalBias;\n\t\t#endif\n\t\tvSpotLightCoord[ i ] = spotLightMatrix[ i ] * shadowWorldPosition;\n\t}\n\t#pragma unroll_loop_end\n#endif",shadowmask_pars_fragment:"float getShadowMask() {\n\tfloat shadow = 1.0;\n\t#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {\n\t\tdirectionalLight = directionalLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHT_SHADOWS; i ++ ) {\n\t\tspotLight = spotLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {\n\t\tpointLight = pointLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ], pointLight.shadowCameraNear, pointLight.shadowCameraFar ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#endif\n\treturn shadow;\n}",skinbase_vertex:"#ifdef USE_SKINNING\n\tmat4 boneMatX = getBoneMatrix( skinIndex.x );\n\tmat4 boneMatY = getBoneMatrix( skinIndex.y );\n\tmat4 boneMatZ = getBoneMatrix( skinIndex.z );\n\tmat4 boneMatW = getBoneMatrix( skinIndex.w );\n#endif",skinning_pars_vertex:"#ifdef USE_SKINNING\n\tuniform mat4 bindMatrix;\n\tuniform mat4 bindMatrixInverse;\n\tuniform highp sampler2D boneTexture;\n\tmat4 getBoneMatrix( const in float i ) {\n\t\tint size = textureSize( boneTexture, 0 ).x;\n\t\tint j = int( i ) * 4;\n\t\tint x = j % size;\n\t\tint y = j / size;\n\t\tvec4 v1 = texelFetch( boneTexture, ivec2( x, y ), 0 );\n\t\tvec4 v2 = texelFetch( boneTexture, ivec2( x + 1, y ), 0 );\n\t\tvec4 v3 = texelFetch( boneTexture, ivec2( x + 2, y ), 0 );\n\t\tvec4 v4 = texelFetch( boneTexture, ivec2( x + 3, y ), 0 );\n\t\treturn mat4( v1, v2, v3, v4 );\n\t}\n#endif",skinning_vertex:"#ifdef USE_SKINNING\n\tvec4 skinVertex = bindMatrix * vec4( transformed, 1.0 );\n\tvec4 skinned = vec4( 0.0 );\n\tskinned += boneMatX * skinVertex * skinWeight.x;\n\tskinned += boneMatY * skinVertex * skinWeight.y;\n\tskinned += boneMatZ * skinVertex * skinWeight.z;\n\tskinned += boneMatW * skinVertex * skinWeight.w;\n\ttransformed = ( bindMatrixInverse * skinned ).xyz;\n#endif",skinnormal_vertex:"#ifdef USE_SKINNING\n\tmat4 skinMatrix = mat4( 0.0 );\n\tskinMatrix += skinWeight.x * boneMatX;\n\tskinMatrix += skinWeight.y * boneMatY;\n\tskinMatrix += skinWeight.z * boneMatZ;\n\tskinMatrix += skinWeight.w * boneMatW;\n\tskinMatrix = bindMatrixInverse * skinMatrix * bindMatrix;\n\tobjectNormal = vec4( skinMatrix * vec4( objectNormal, 0.0 ) ).xyz;\n\t#ifdef USE_TANGENT\n\t\tobjectTangent = vec4( skinMatrix * vec4( objectTangent, 0.0 ) ).xyz;\n\t#endif\n#endif",specularmap_fragment:"float specularStrength;\n#ifdef USE_SPECULARMAP\n\tvec4 texelSpecular = texture2D( specularMap, vSpecularMapUv );\n\tspecularStrength = texelSpecular.r;\n#else\n\tspecularStrength = 1.0;\n#endif",specularmap_pars_fragment:"#ifdef USE_SPECULARMAP\n\tuniform sampler2D specularMap;\n#endif",tonemapping_fragment:"#if defined( TONE_MAPPING )\n\tgl_FragColor.rgb = toneMapping( gl_FragColor.rgb );\n#endif",tonemapping_pars_fragment:"#ifndef saturate\n#define saturate( a ) clamp( a, 0.0, 1.0 )\n#endif\nuniform float toneMappingExposure;\nvec3 LinearToneMapping( vec3 color ) {\n\treturn saturate( toneMappingExposure * color );\n}\nvec3 ReinhardToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\treturn saturate( color / ( vec3( 1.0 ) + color ) );\n}\nvec3 OptimizedCineonToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\tcolor = max( vec3( 0.0 ), color - 0.004 );\n\treturn pow( ( color * ( 6.2 * color + 0.5 ) ) / ( color * ( 6.2 * color + 1.7 ) + 0.06 ), vec3( 2.2 ) );\n}\nvec3 RRTAndODTFit( vec3 v ) {\n\tvec3 a = v * ( v + 0.0245786 ) - 0.000090537;\n\tvec3 b = v * ( 0.983729 * v + 0.4329510 ) + 0.238081;\n\treturn a / b;\n}\nvec3 ACESFilmicToneMapping( vec3 color ) {\n\tconst mat3 ACESInputMat = mat3(\n\t\tvec3( 0.59719, 0.07600, 0.02840 ),\t\tvec3( 0.35458, 0.90834, 0.13383 ),\n\t\tvec3( 0.04823, 0.01566, 0.83777 )\n\t);\n\tconst mat3 ACESOutputMat = mat3(\n\t\tvec3(  1.60475, -0.10208, -0.00327 ),\t\tvec3( -0.53108,  1.10813, -0.07276 ),\n\t\tvec3( -0.07367, -0.00605,  1.07602 )\n\t);\n\tcolor *= toneMappingExposure / 0.6;\n\tcolor = ACESInputMat * color;\n\tcolor = RRTAndODTFit( color );\n\tcolor = ACESOutputMat * color;\n\treturn saturate( color );\n}\nconst mat3 LINEAR_REC2020_TO_LINEAR_SRGB = mat3(\n\tvec3( 1.6605, - 0.1246, - 0.0182 ),\n\tvec3( - 0.5876, 1.1329, - 0.1006 ),\n\tvec3( - 0.0728, - 0.0083, 1.1187 )\n);\nconst mat3 LINEAR_SRGB_TO_LINEAR_REC2020 = mat3(\n\tvec3( 0.6274, 0.0691, 0.0164 ),\n\tvec3( 0.3293, 0.9195, 0.0880 ),\n\tvec3( 0.0433, 0.0113, 0.8956 )\n);\nvec3 agxDefaultContrastApprox( vec3 x ) {\n\tvec3 x2 = x * x;\n\tvec3 x4 = x2 * x2;\n\treturn + 15.5 * x4 * x2\n\t\t- 40.14 * x4 * x\n\t\t+ 31.96 * x4\n\t\t- 6.868 * x2 * x\n\t\t+ 0.4298 * x2\n\t\t+ 0.1191 * x\n\t\t- 0.00232;\n}\nvec3 AgXToneMapping( vec3 color ) {\n\tconst mat3 AgXInsetMatrix = mat3(\n\t\tvec3( 0.856627153315983, 0.137318972929847, 0.11189821299995 ),\n\t\tvec3( 0.0951212405381588, 0.761241990602591, 0.0767994186031903 ),\n\t\tvec3( 0.0482516061458583, 0.101439036467562, 0.811302368396859 )\n\t);\n\tconst mat3 AgXOutsetMatrix = mat3(\n\t\tvec3( 1.1271005818144368, - 0.1413297634984383, - 0.14132976349843826 ),\n\t\tvec3( - 0.11060664309660323, 1.157823702216272, - 0.11060664309660294 ),\n\t\tvec3( - 0.016493938717834573, - 0.016493938717834257, 1.2519364065950405 )\n\t);\n\tconst float AgxMinEv = - 12.47393;\tconst float AgxMaxEv = 4.026069;\n\tcolor = LINEAR_SRGB_TO_LINEAR_REC2020 * color;\n\tcolor *= toneMappingExposure;\n\tcolor = AgXInsetMatrix * color;\n\tcolor = max( color, 1e-10 );\tcolor = log2( color );\n\tcolor = ( color - AgxMinEv ) / ( AgxMaxEv - AgxMinEv );\n\tcolor = clamp( color, 0.0, 1.0 );\n\tcolor = agxDefaultContrastApprox( color );\n\tcolor = AgXOutsetMatrix * color;\n\tcolor = pow( max( vec3( 0.0 ), color ), vec3( 2.2 ) );\n\tcolor = LINEAR_REC2020_TO_LINEAR_SRGB * color;\n\treturn color;\n}\nvec3 CustomToneMapping( vec3 color ) { return color; }",transmission_fragment:"#ifdef USE_TRANSMISSION\n\tmaterial.transmission = transmission;\n\tmaterial.transmissionAlpha = 1.0;\n\tmaterial.thickness = thickness;\n\tmaterial.attenuationDistance = attenuationDistance;\n\tmaterial.attenuationColor = attenuationColor;\n\t#ifdef USE_TRANSMISSIONMAP\n\t\tmaterial.transmission *= texture2D( transmissionMap, vTransmissionMapUv ).r;\n\t#endif\n\t#ifdef USE_THICKNESSMAP\n\t\tmaterial.thickness *= texture2D( thicknessMap, vThicknessMapUv ).g;\n\t#endif\n\tvec3 pos = vWorldPosition;\n\tvec3 v = normalize( cameraPosition - pos );\n\tvec3 n = inverseTransformDirection( normal, viewMatrix );\n\tvec4 transmitted = getIBLVolumeRefraction(\n\t\tn, v, material.roughness, material.diffuseColor, material.specularColor, material.specularF90,\n\t\tpos, modelMatrix, viewMatrix, projectionMatrix, material.ior, material.thickness,\n\t\tmaterial.attenuationColor, material.attenuationDistance );\n\tmaterial.transmissionAlpha = mix( material.transmissionAlpha, transmitted.a, material.transmission );\n\ttotalDiffuse = mix( totalDiffuse, transmitted.rgb, material.transmission );\n#endif",transmission_pars_fragment:"#ifdef USE_TRANSMISSION\n\tuniform float transmission;\n\tuniform float thickness;\n\tuniform float attenuationDistance;\n\tuniform vec3 attenuationColor;\n\t#ifdef USE_TRANSMISSIONMAP\n\t\tuniform sampler2D transmissionMap;\n\t#endif\n\t#ifdef USE_THICKNESSMAP\n\t\tuniform sampler2D thicknessMap;\n\t#endif\n\tuniform vec2 transmissionSamplerSize;\n\tuniform sampler2D transmissionSamplerMap;\n\tuniform mat4 modelMatrix;\n\tuniform mat4 projectionMatrix;\n\tvarying vec3 vWorldPosition;\n\tfloat w0( float a ) {\n\t\treturn ( 1.0 / 6.0 ) * ( a * ( a * ( - a + 3.0 ) - 3.0 ) + 1.0 );\n\t}\n\tfloat w1( float a ) {\n\t\treturn ( 1.0 / 6.0 ) * ( a *  a * ( 3.0 * a - 6.0 ) + 4.0 );\n\t}\n\tfloat w2( float a ){\n\t\treturn ( 1.0 / 6.0 ) * ( a * ( a * ( - 3.0 * a + 3.0 ) + 3.0 ) + 1.0 );\n\t}\n\tfloat w3( float a ) {\n\t\treturn ( 1.0 / 6.0 ) * ( a * a * a );\n\t}\n\tfloat g0( float a ) {\n\t\treturn w0( a ) + w1( a );\n\t}\n\tfloat g1( float a ) {\n\t\treturn w2( a ) + w3( a );\n\t}\n\tfloat h0( float a ) {\n\t\treturn - 1.0 + w1( a ) / ( w0( a ) + w1( a ) );\n\t}\n\tfloat h1( float a ) {\n\t\treturn 1.0 + w3( a ) / ( w2( a ) + w3( a ) );\n\t}\n\tvec4 bicubic( sampler2D tex, vec2 uv, vec4 texelSize, float lod ) {\n\t\tuv = uv * texelSize.zw + 0.5;\n\t\tvec2 iuv = floor( uv );\n\t\tvec2 fuv = fract( uv );\n\t\tfloat g0x = g0( fuv.x );\n\t\tfloat g1x = g1( fuv.x );\n\t\tfloat h0x = h0( fuv.x );\n\t\tfloat h1x = h1( fuv.x );\n\t\tfloat h0y = h0( fuv.y );\n\t\tfloat h1y = h1( fuv.y );\n\t\tvec2 p0 = ( vec2( iuv.x + h0x, iuv.y + h0y ) - 0.5 ) * texelSize.xy;\n\t\tvec2 p1 = ( vec2( iuv.x + h1x, iuv.y + h0y ) - 0.5 ) * texelSize.xy;\n\t\tvec2 p2 = ( vec2( iuv.x + h0x, iuv.y + h1y ) - 0.5 ) * texelSize.xy;\n\t\tvec2 p3 = ( vec2( iuv.x + h1x, iuv.y + h1y ) - 0.5 ) * texelSize.xy;\n\t\treturn g0( fuv.y ) * ( g0x * textureLod( tex, p0, lod ) + g1x * textureLod( tex, p1, lod ) ) +\n\t\t\tg1( fuv.y ) * ( g0x * textureLod( tex, p2, lod ) + g1x * textureLod( tex, p3, lod ) );\n\t}\n\tvec4 textureBicubic( sampler2D sampler, vec2 uv, float lod ) {\n\t\tvec2 fLodSize = vec2( textureSize( sampler, int( lod ) ) );\n\t\tvec2 cLodSize = vec2( textureSize( sampler, int( lod + 1.0 ) ) );\n\t\tvec2 fLodSizeInv = 1.0 / fLodSize;\n\t\tvec2 cLodSizeInv = 1.0 / cLodSize;\n\t\tvec4 fSample = bicubic( sampler, uv, vec4( fLodSizeInv, fLodSize ), floor( lod ) );\n\t\tvec4 cSample = bicubic( sampler, uv, vec4( cLodSizeInv, cLodSize ), ceil( lod ) );\n\t\treturn mix( fSample, cSample, fract( lod ) );\n\t}\n\tvec3 getVolumeTransmissionRay( const in vec3 n, const in vec3 v, const in float thickness, const in float ior, const in mat4 modelMatrix ) {\n\t\tvec3 refractionVector = refract( - v, normalize( n ), 1.0 / ior );\n\t\tvec3 modelScale;\n\t\tmodelScale.x = length( vec3( modelMatrix[ 0 ].xyz ) );\n\t\tmodelScale.y = length( vec3( modelMatrix[ 1 ].xyz ) );\n\t\tmodelScale.z = length( vec3( modelMatrix[ 2 ].xyz ) );\n\t\treturn normalize( refractionVector ) * thickness * modelScale;\n\t}\n\tfloat applyIorToRoughness( const in float roughness, const in float ior ) {\n\t\treturn roughness * clamp( ior * 2.0 - 2.0, 0.0, 1.0 );\n\t}\n\tvec4 getTransmissionSample( const in vec2 fragCoord, const in float roughness, const in float ior ) {\n\t\tfloat lod = log2( transmissionSamplerSize.x ) * applyIorToRoughness( roughness, ior );\n\t\treturn textureBicubic( transmissionSamplerMap, fragCoord.xy, lod );\n\t}\n\tvec3 volumeAttenuation( const in float transmissionDistance, const in vec3 attenuationColor, const in float attenuationDistance ) {\n\t\tif ( isinf( attenuationDistance ) ) {\n\t\t\treturn vec3( 1.0 );\n\t\t} else {\n\t\t\tvec3 attenuationCoefficient = -log( attenuationColor ) / attenuationDistance;\n\t\t\tvec3 transmittance = exp( - attenuationCoefficient * transmissionDistance );\t\t\treturn transmittance;\n\t\t}\n\t}\n\tvec4 getIBLVolumeRefraction( const in vec3 n, const in vec3 v, const in float roughness, const in vec3 diffuseColor,\n\t\tconst in vec3 specularColor, const in float specularF90, const in vec3 position, const in mat4 modelMatrix,\n\t\tconst in mat4 viewMatrix, const in mat4 projMatrix, const in float ior, const in float thickness,\n\t\tconst in vec3 attenuationColor, const in float attenuationDistance ) {\n\t\tvec3 transmissionRay = getVolumeTransmissionRay( n, v, thickness, ior, modelMatrix );\n\t\tvec3 refractedRayExit = position + transmissionRay;\n\t\tvec4 ndcPos = projMatrix * viewMatrix * vec4( refractedRayExit, 1.0 );\n\t\tvec2 refractionCoords = ndcPos.xy / ndcPos.w;\n\t\trefractionCoords += 1.0;\n\t\trefractionCoords /= 2.0;\n\t\tvec4 transmittedLight = getTransmissionSample( refractionCoords, roughness, ior );\n\t\tvec3 transmittance = diffuseColor * volumeAttenuation( length( transmissionRay ), attenuationColor, attenuationDistance );\n\t\tvec3 attenuatedColor = transmittance * transmittedLight.rgb;\n\t\tvec3 F = EnvironmentBRDF( n, v, specularColor, specularF90, roughness );\n\t\tfloat transmittanceFactor = ( transmittance.r + transmittance.g + transmittance.b ) / 3.0;\n\t\treturn vec4( ( 1.0 - F ) * attenuatedColor, 1.0 - ( 1.0 - transmittedLight.a ) * transmittanceFactor );\n\t}\n#endif",uv_pars_fragment:"#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\tvarying vec2 vUv;\n#endif\n#ifdef USE_MAP\n\tvarying vec2 vMapUv;\n#endif\n#ifdef USE_ALPHAMAP\n\tvarying vec2 vAlphaMapUv;\n#endif\n#ifdef USE_LIGHTMAP\n\tvarying vec2 vLightMapUv;\n#endif\n#ifdef USE_AOMAP\n\tvarying vec2 vAoMapUv;\n#endif\n#ifdef USE_BUMPMAP\n\tvarying vec2 vBumpMapUv;\n#endif\n#ifdef USE_NORMALMAP\n\tvarying vec2 vNormalMapUv;\n#endif\n#ifdef USE_EMISSIVEMAP\n\tvarying vec2 vEmissiveMapUv;\n#endif\n#ifdef USE_METALNESSMAP\n\tvarying vec2 vMetalnessMapUv;\n#endif\n#ifdef USE_ROUGHNESSMAP\n\tvarying vec2 vRoughnessMapUv;\n#endif\n#ifdef USE_ANISOTROPYMAP\n\tvarying vec2 vAnisotropyMapUv;\n#endif\n#ifdef USE_CLEARCOATMAP\n\tvarying vec2 vClearcoatMapUv;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tvarying vec2 vClearcoatNormalMapUv;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tvarying vec2 vClearcoatRoughnessMapUv;\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\tvarying vec2 vIridescenceMapUv;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tvarying vec2 vIridescenceThicknessMapUv;\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\tvarying vec2 vSheenColorMapUv;\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\tvarying vec2 vSheenRoughnessMapUv;\n#endif\n#ifdef USE_SPECULARMAP\n\tvarying vec2 vSpecularMapUv;\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\tvarying vec2 vSpecularColorMapUv;\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\tvarying vec2 vSpecularIntensityMapUv;\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\tuniform mat3 transmissionMapTransform;\n\tvarying vec2 vTransmissionMapUv;\n#endif\n#ifdef USE_THICKNESSMAP\n\tuniform mat3 thicknessMapTransform;\n\tvarying vec2 vThicknessMapUv;\n#endif",uv_pars_vertex:"#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\tvarying vec2 vUv;\n#endif\n#ifdef USE_MAP\n\tuniform mat3 mapTransform;\n\tvarying vec2 vMapUv;\n#endif\n#ifdef USE_ALPHAMAP\n\tuniform mat3 alphaMapTransform;\n\tvarying vec2 vAlphaMapUv;\n#endif\n#ifdef USE_LIGHTMAP\n\tuniform mat3 lightMapTransform;\n\tvarying vec2 vLightMapUv;\n#endif\n#ifdef USE_AOMAP\n\tuniform mat3 aoMapTransform;\n\tvarying vec2 vAoMapUv;\n#endif\n#ifdef USE_BUMPMAP\n\tuniform mat3 bumpMapTransform;\n\tvarying vec2 vBumpMapUv;\n#endif\n#ifdef USE_NORMALMAP\n\tuniform mat3 normalMapTransform;\n\tvarying vec2 vNormalMapUv;\n#endif\n#ifdef USE_DISPLACEMENTMAP\n\tuniform mat3 displacementMapTransform;\n\tvarying vec2 vDisplacementMapUv;\n#endif\n#ifdef USE_EMISSIVEMAP\n\tuniform mat3 emissiveMapTransform;\n\tvarying vec2 vEmissiveMapUv;\n#endif\n#ifdef USE_METALNESSMAP\n\tuniform mat3 metalnessMapTransform;\n\tvarying vec2 vMetalnessMapUv;\n#endif\n#ifdef USE_ROUGHNESSMAP\n\tuniform mat3 roughnessMapTransform;\n\tvarying vec2 vRoughnessMapUv;\n#endif\n#ifdef USE_ANISOTROPYMAP\n\tuniform mat3 anisotropyMapTransform;\n\tvarying vec2 vAnisotropyMapUv;\n#endif\n#ifdef USE_CLEARCOATMAP\n\tuniform mat3 clearcoatMapTransform;\n\tvarying vec2 vClearcoatMapUv;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tuniform mat3 clearcoatNormalMapTransform;\n\tvarying vec2 vClearcoatNormalMapUv;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tuniform mat3 clearcoatRoughnessMapTransform;\n\tvarying vec2 vClearcoatRoughnessMapUv;\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\tuniform mat3 sheenColorMapTransform;\n\tvarying vec2 vSheenColorMapUv;\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\tuniform mat3 sheenRoughnessMapTransform;\n\tvarying vec2 vSheenRoughnessMapUv;\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\tuniform mat3 iridescenceMapTransform;\n\tvarying vec2 vIridescenceMapUv;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tuniform mat3 iridescenceThicknessMapTransform;\n\tvarying vec2 vIridescenceThicknessMapUv;\n#endif\n#ifdef USE_SPECULARMAP\n\tuniform mat3 specularMapTransform;\n\tvarying vec2 vSpecularMapUv;\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\tuniform mat3 specularColorMapTransform;\n\tvarying vec2 vSpecularColorMapUv;\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\tuniform mat3 specularIntensityMapTransform;\n\tvarying vec2 vSpecularIntensityMapUv;\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\tuniform mat3 transmissionMapTransform;\n\tvarying vec2 vTransmissionMapUv;\n#endif\n#ifdef USE_THICKNESSMAP\n\tuniform mat3 thicknessMapTransform;\n\tvarying vec2 vThicknessMapUv;\n#endif",uv_vertex:"#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\tvUv = vec3( uv, 1 ).xy;\n#endif\n#ifdef USE_MAP\n\tvMapUv = ( mapTransform * vec3( MAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_ALPHAMAP\n\tvAlphaMapUv = ( alphaMapTransform * vec3( ALPHAMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_LIGHTMAP\n\tvLightMapUv = ( lightMapTransform * vec3( LIGHTMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_AOMAP\n\tvAoMapUv = ( aoMapTransform * vec3( AOMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_BUMPMAP\n\tvBumpMapUv = ( bumpMapTransform * vec3( BUMPMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_NORMALMAP\n\tvNormalMapUv = ( normalMapTransform * vec3( NORMALMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_DISPLACEMENTMAP\n\tvDisplacementMapUv = ( displacementMapTransform * vec3( DISPLACEMENTMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_EMISSIVEMAP\n\tvEmissiveMapUv = ( emissiveMapTransform * vec3( EMISSIVEMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_METALNESSMAP\n\tvMetalnessMapUv = ( metalnessMapTransform * vec3( METALNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_ROUGHNESSMAP\n\tvRoughnessMapUv = ( roughnessMapTransform * vec3( ROUGHNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_ANISOTROPYMAP\n\tvAnisotropyMapUv = ( anisotropyMapTransform * vec3( ANISOTROPYMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_CLEARCOATMAP\n\tvClearcoatMapUv = ( clearcoatMapTransform * vec3( CLEARCOATMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tvClearcoatNormalMapUv = ( clearcoatNormalMapTransform * vec3( CLEARCOAT_NORMALMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tvClearcoatRoughnessMapUv = ( clearcoatRoughnessMapTransform * vec3( CLEARCOAT_ROUGHNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\tvIridescenceMapUv = ( iridescenceMapTransform * vec3( IRIDESCENCEMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tvIridescenceThicknessMapUv = ( iridescenceThicknessMapTransform * vec3( IRIDESCENCE_THICKNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\tvSheenColorMapUv = ( sheenColorMapTransform * vec3( SHEEN_COLORMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\tvSheenRoughnessMapUv = ( sheenRoughnessMapTransform * vec3( SHEEN_ROUGHNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SPECULARMAP\n\tvSpecularMapUv = ( specularMapTransform * vec3( SPECULARMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\tvSpecularColorMapUv = ( specularColorMapTransform * vec3( SPECULAR_COLORMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\tvSpecularIntensityMapUv = ( specularIntensityMapTransform * vec3( SPECULAR_INTENSITYMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\tvTransmissionMapUv = ( transmissionMapTransform * vec3( TRANSMISSIONMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_THICKNESSMAP\n\tvThicknessMapUv = ( thicknessMapTransform * vec3( THICKNESSMAP_UV, 1 ) ).xy;\n#endif",worldpos_vertex:"#if defined( USE_ENVMAP ) || defined( DISTANCE ) || defined ( USE_SHADOWMAP ) || defined ( USE_TRANSMISSION ) || NUM_SPOT_LIGHT_COORDS > 0\n\tvec4 worldPosition = vec4( transformed, 1.0 );\n\t#ifdef USE_BATCHING\n\t\tworldPosition = batchingMatrix * worldPosition;\n\t#endif\n\t#ifdef USE_INSTANCING\n\t\tworldPosition = instanceMatrix * worldPosition;\n\t#endif\n\tworldPosition = modelMatrix * worldPosition;\n#endif",background_vert:"varying vec2 vUv;\nuniform mat3 uvTransform;\nvoid main() {\n\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n\tgl_Position = vec4( position.xy, 1.0, 1.0 );\n}",background_frag:"uniform sampler2D t2D;\nuniform float backgroundIntensity;\nvarying vec2 vUv;\nvoid main() {\n\tvec4 texColor = texture2D( t2D, vUv );\n\t#ifdef DECODE_VIDEO_TEXTURE\n\t\ttexColor = vec4( mix( pow( texColor.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), texColor.rgb * 0.0773993808, vec3( lessThanEqual( texColor.rgb, vec3( 0.04045 ) ) ) ), texColor.w );\n\t#endif\n\ttexColor.rgb *= backgroundIntensity;\n\tgl_FragColor = texColor;\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",backgroundCube_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\tgl_Position.z = gl_Position.w;\n}",backgroundCube_frag:"#ifdef ENVMAP_TYPE_CUBE\n\tuniform samplerCube envMap;\n#elif defined( ENVMAP_TYPE_CUBE_UV )\n\tuniform sampler2D envMap;\n#endif\nuniform float flipEnvMap;\nuniform float backgroundBlurriness;\nuniform float backgroundIntensity;\nvarying vec3 vWorldDirection;\n#include <cube_uv_reflection_fragment>\nvoid main() {\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tvec4 texColor = textureCube( envMap, vec3( flipEnvMap * vWorldDirection.x, vWorldDirection.yz ) );\n\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\tvec4 texColor = textureCubeUV( envMap, vWorldDirection, backgroundBlurriness );\n\t#else\n\t\tvec4 texColor = vec4( 0.0, 0.0, 0.0, 1.0 );\n\t#endif\n\ttexColor.rgb *= backgroundIntensity;\n\tgl_FragColor = texColor;\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",cube_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\tgl_Position.z = gl_Position.w;\n}",cube_frag:"uniform samplerCube tCube;\nuniform float tFlip;\nuniform float opacity;\nvarying vec3 vWorldDirection;\nvoid main() {\n\tvec4 texColor = textureCube( tCube, vec3( tFlip * vWorldDirection.x, vWorldDirection.yz ) );\n\tgl_FragColor = texColor;\n\tgl_FragColor.a *= opacity;\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",depth_vert:"#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvarying vec2 vHighPrecisionZW;\nvoid main() {\n\t#include <uv_vertex>\n\t#include <batching_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvHighPrecisionZW = gl_Position.zw;\n}",depth_frag:"#if DEPTH_PACKING == 3200\n\tuniform float opacity;\n#endif\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvarying vec2 vHighPrecisionZW;\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#if DEPTH_PACKING == 3200\n\t\tdiffuseColor.a = opacity;\n\t#endif\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <logdepthbuf_fragment>\n\tfloat fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;\n\t#if DEPTH_PACKING == 3200\n\t\tgl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );\n\t#elif DEPTH_PACKING == 3201\n\t\tgl_FragColor = packDepthToRGBA( fragCoordZ );\n\t#endif\n}",distanceRGBA_vert:"#define DISTANCE\nvarying vec3 vWorldPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <batching_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\tvWorldPosition = worldPosition.xyz;\n}",distanceRGBA_frag:"#define DISTANCE\nuniform vec3 referencePosition;\nuniform float nearDistance;\nuniform float farDistance;\nvarying vec3 vWorldPosition;\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main () {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\tfloat dist = length( vWorldPosition - referencePosition );\n\tdist = ( dist - nearDistance ) / ( farDistance - nearDistance );\n\tdist = saturate( dist );\n\tgl_FragColor = packDepthToRGBA( dist );\n}",equirect_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n}",equirect_frag:"uniform sampler2D tEquirect;\nvarying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvec3 direction = normalize( vWorldDirection );\n\tvec2 sampleUV = equirectUv( direction );\n\tgl_FragColor = texture2D( tEquirect, sampleUV );\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",linedashed_vert:"uniform float scale;\nattribute float lineDistance;\nvarying float vLineDistance;\n#include <common>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\tvLineDistance = scale * lineDistance;\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}",linedashed_frag:"uniform vec3 diffuse;\nuniform float opacity;\nuniform float dashSize;\nuniform float totalSize;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tif ( mod( vLineDistance, totalSize ) > dashSize ) {\n\t\tdiscard;\n\t}\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n}",meshbasic_vert:"#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#if defined ( USE_ENVMAP ) || defined ( USE_SKINNING )\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinbase_vertex>\n\t\t#include <skinnormal_vertex>\n\t\t#include <defaultnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <fog_vertex>\n}",meshbasic_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <specularmap_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\t#ifdef USE_LIGHTMAP\n\t\tvec4 lightMapTexel = texture2D( lightMap, vLightMapUv );\n\t\treflectedLight.indirectDiffuse += lightMapTexel.rgb * lightMapIntensity * RECIPROCAL_PI;\n\t#else\n\t\treflectedLight.indirectDiffuse += vec3( 1.0 );\n\t#endif\n\t#include <aomap_fragment>\n\treflectedLight.indirectDiffuse *= diffuseColor.rgb;\n\tvec3 outgoingLight = reflectedLight.indirectDiffuse;\n\t#include <envmap_fragment>\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshlambert_vert:"#define LAMBERT\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshlambert_frag:"#define LAMBERT\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_lambert_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_lambert_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshmatcap_vert:"#define MATCAP\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n\tvViewPosition = - mvPosition.xyz;\n}",meshmatcap_frag:"#define MATCAP\nuniform vec3 diffuse;\nuniform float opacity;\nuniform sampler2D matcap;\nvarying vec3 vViewPosition;\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <normal_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\tvec3 viewDir = normalize( vViewPosition );\n\tvec3 x = normalize( vec3( viewDir.z, 0.0, - viewDir.x ) );\n\tvec3 y = cross( viewDir, x );\n\tvec2 uv = vec2( dot( x, normal ), dot( y, normal ) ) * 0.495 + 0.5;\n\t#ifdef USE_MATCAP\n\t\tvec4 matcapColor = texture2D( matcap, uv );\n\t#else\n\t\tvec4 matcapColor = vec4( vec3( mix( 0.2, 0.8, uv.y ) ), 1.0 );\n\t#endif\n\tvec3 outgoingLight = diffuseColor.rgb * matcapColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshnormal_vert:"#define NORMAL\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )\n\tvarying vec3 vViewPosition;\n#endif\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )\n\tvViewPosition = - mvPosition.xyz;\n#endif\n}",meshnormal_frag:"#define NORMAL\nuniform float opacity;\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )\n\tvarying vec3 vViewPosition;\n#endif\n#include <packing>\n#include <uv_pars_fragment>\n#include <normal_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\tgl_FragColor = vec4( packNormalToRGB( normal ), opacity );\n\t#ifdef OPAQUE\n\t\tgl_FragColor.a = 1.0;\n\t#endif\n}",meshphong_vert:"#define PHONG\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshphong_frag:"#define PHONG\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 specular;\nuniform float shininess;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_phong_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshphysical_vert:"#define STANDARD\nvarying vec3 vViewPosition;\n#ifdef USE_TRANSMISSION\n\tvarying vec3 vWorldPosition;\n#endif\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n#ifdef USE_TRANSMISSION\n\tvWorldPosition = worldPosition.xyz;\n#endif\n}",meshphysical_frag:"#define STANDARD\n#ifdef PHYSICAL\n\t#define IOR\n\t#define USE_SPECULAR\n#endif\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\n#ifdef IOR\n\tuniform float ior;\n#endif\n#ifdef USE_SPECULAR\n\tuniform float specularIntensity;\n\tuniform vec3 specularColor;\n\t#ifdef USE_SPECULAR_COLORMAP\n\t\tuniform sampler2D specularColorMap;\n\t#endif\n\t#ifdef USE_SPECULAR_INTENSITYMAP\n\t\tuniform sampler2D specularIntensityMap;\n\t#endif\n#endif\n#ifdef USE_CLEARCOAT\n\tuniform float clearcoat;\n\tuniform float clearcoatRoughness;\n#endif\n#ifdef USE_IRIDESCENCE\n\tuniform float iridescence;\n\tuniform float iridescenceIOR;\n\tuniform float iridescenceThicknessMinimum;\n\tuniform float iridescenceThicknessMaximum;\n#endif\n#ifdef USE_SHEEN\n\tuniform vec3 sheenColor;\n\tuniform float sheenRoughness;\n\t#ifdef USE_SHEEN_COLORMAP\n\t\tuniform sampler2D sheenColorMap;\n\t#endif\n\t#ifdef USE_SHEEN_ROUGHNESSMAP\n\t\tuniform sampler2D sheenRoughnessMap;\n\t#endif\n#endif\n#ifdef USE_ANISOTROPY\n\tuniform vec2 anisotropyVector;\n\t#ifdef USE_ANISOTROPYMAP\n\t\tuniform sampler2D anisotropyMap;\n\t#endif\n#endif\nvarying vec3 vViewPosition;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <iridescence_fragment>\n#include <cube_uv_reflection_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_physical_pars_fragment>\n#include <fog_pars_fragment>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_physical_pars_fragment>\n#include <transmission_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <clearcoat_pars_fragment>\n#include <iridescence_pars_fragment>\n#include <roughnessmap_pars_fragment>\n#include <metalnessmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <roughnessmap_fragment>\n\t#include <metalnessmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <clearcoat_normal_fragment_begin>\n\t#include <clearcoat_normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_physical_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 totalDiffuse = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse;\n\tvec3 totalSpecular = reflectedLight.directSpecular + reflectedLight.indirectSpecular;\n\t#include <transmission_fragment>\n\tvec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;\n\t#ifdef USE_SHEEN\n\t\tfloat sheenEnergyComp = 1.0 - 0.157 * max3( material.sheenColor );\n\t\toutgoingLight = outgoingLight * sheenEnergyComp + sheenSpecularDirect + sheenSpecularIndirect;\n\t#endif\n\t#ifdef USE_CLEARCOAT\n\t\tfloat dotNVcc = saturate( dot( geometryClearcoatNormal, geometryViewDir ) );\n\t\tvec3 Fcc = F_Schlick( material.clearcoatF0, material.clearcoatF90, dotNVcc );\n\t\toutgoingLight = outgoingLight * ( 1.0 - material.clearcoat * Fcc ) + ( clearcoatSpecularDirect + clearcoatSpecularIndirect ) * material.clearcoat;\n\t#endif\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshtoon_vert:"#define TOON\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshtoon_frag:"#define TOON\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <gradientmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_toon_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_toon_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",points_vert:"uniform float size;\nuniform float scale;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n#ifdef USE_POINTS_UV\n\tvarying vec2 vUv;\n\tuniform mat3 uvTransform;\n#endif\nvoid main() {\n\t#ifdef USE_POINTS_UV\n\t\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n\t#endif\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\tgl_PointSize = size;\n\t#ifdef USE_SIZEATTENUATION\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\t\tif ( isPerspective ) gl_PointSize *= ( scale / - mvPosition.z );\n\t#endif\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <fog_vertex>\n}",points_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <color_pars_fragment>\n#include <map_particle_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_particle_fragment>\n\t#include <color_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n}",shadow_vert:"#include <common>\n#include <batching_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <shadowmap_pars_vertex>\nvoid main() {\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",shadow_frag:"uniform vec3 color;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <logdepthbuf_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\nvoid main() {\n\t#include <logdepthbuf_fragment>\n\tgl_FragColor = vec4( color, opacity * ( 1.0 - getShadowMask() ) );\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n}",sprite_vert:"uniform float rotation;\nuniform vec2 center;\n#include <common>\n#include <uv_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\tvec4 mvPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );\n\tvec2 scale;\n\tscale.x = length( vec3( modelMatrix[ 0 ].x, modelMatrix[ 0 ].y, modelMatrix[ 0 ].z ) );\n\tscale.y = length( vec3( modelMatrix[ 1 ].x, modelMatrix[ 1 ].y, modelMatrix[ 1 ].z ) );\n\t#ifndef USE_SIZEATTENUATION\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\t\tif ( isPerspective ) scale *= - mvPosition.z;\n\t#endif\n\tvec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale;\n\tvec2 rotatedPosition;\n\trotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;\n\trotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;\n\tmvPosition.xy += rotatedPosition;\n\tgl_Position = projectionMatrix * mvPosition;\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}",sprite_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n}"},as={common:{diffuse:{value:new Zi(16777215)},opacity:{value:1},map:{value:null},mapTransform:{value:new re},alphaMap:{value:null},alphaMapTransform:{value:new re},alphaTest:{value:0}},specularmap:{specularMap:{value:null},specularMapTransform:{value:new re}},envmap:{envMap:{value:null},flipEnvMap:{value:-1},reflectivity:{value:1},ior:{value:1.5},refractionRatio:{value:.98}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1},aoMapTransform:{value:new re}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1},lightMapTransform:{value:new re}},bumpmap:{bumpMap:{value:null},bumpMapTransform:{value:new re},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalMapTransform:{value:new re},normalScale:{value:new se(1,1)}},displacementmap:{displacementMap:{value:null},displacementMapTransform:{value:new re},displacementScale:{value:1},displacementBias:{value:0}},emissivemap:{emissiveMap:{value:null},emissiveMapTransform:{value:new re}},metalnessmap:{metalnessMap:{value:null},metalnessMapTransform:{value:new re}},roughnessmap:{roughnessMap:{value:null},roughnessMapTransform:{value:new re}},gradientmap:{gradientMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new Zi(16777215)}},lights:{ambientLightColor:{value:[]},lightProbe:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{}}},directionalLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{}}},spotLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},spotLightMap:{value:[]},spotShadowMap:{value:[]},spotLightMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{}}},pointLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{},shadowCameraNear:{},shadowCameraFar:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}},rectAreaLights:{value:[],properties:{color:{},position:{},width:{},height:{}}},ltc_1:{value:null},ltc_2:{value:null}},points:{diffuse:{value:new Zi(16777215)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},alphaMap:{value:null},alphaMapTransform:{value:new re},alphaTest:{value:0},uvTransform:{value:new re}},sprite:{diffuse:{value:new Zi(16777215)},opacity:{value:1},center:{value:new se(.5,.5)},rotation:{value:0},map:{value:null},mapTransform:{value:new re},alphaMap:{value:null},alphaMapTransform:{value:new re},alphaTest:{value:0}}},os={basic:{uniforms:Un([as.common,as.specularmap,as.envmap,as.aomap,as.lightmap,as.fog]),vertexShader:rs.meshbasic_vert,fragmentShader:rs.meshbasic_frag},lambert:{uniforms:Un([as.common,as.specularmap,as.envmap,as.aomap,as.lightmap,as.emissivemap,as.bumpmap,as.normalmap,as.displacementmap,as.fog,as.lights,{emissive:{value:new Zi(0)}}]),vertexShader:rs.meshlambert_vert,fragmentShader:rs.meshlambert_frag},phong:{uniforms:Un([as.common,as.specularmap,as.envmap,as.aomap,as.lightmap,as.emissivemap,as.bumpmap,as.normalmap,as.displacementmap,as.fog,as.lights,{emissive:{value:new Zi(0)},specular:{value:new Zi(1118481)},shininess:{value:30}}]),vertexShader:rs.meshphong_vert,fragmentShader:rs.meshphong_frag},standard:{uniforms:Un([as.common,as.envmap,as.aomap,as.lightmap,as.emissivemap,as.bumpmap,as.normalmap,as.displacementmap,as.roughnessmap,as.metalnessmap,as.fog,as.lights,{emissive:{value:new Zi(0)},roughness:{value:1},metalness:{value:0},envMapIntensity:{value:1}}]),vertexShader:rs.meshphysical_vert,fragmentShader:rs.meshphysical_frag},toon:{uniforms:Un([as.common,as.aomap,as.lightmap,as.emissivemap,as.bumpmap,as.normalmap,as.displacementmap,as.gradientmap,as.fog,as.lights,{emissive:{value:new Zi(0)}}]),vertexShader:rs.meshtoon_vert,fragmentShader:rs.meshtoon_frag},matcap:{uniforms:Un([as.common,as.bumpmap,as.normalmap,as.displacementmap,as.fog,{matcap:{value:null}}]),vertexShader:rs.meshmatcap_vert,fragmentShader:rs.meshmatcap_frag},points:{uniforms:Un([as.points,as.fog]),vertexShader:rs.points_vert,fragmentShader:rs.points_frag},dashed:{uniforms:Un([as.common,as.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:rs.linedashed_vert,fragmentShader:rs.linedashed_frag},depth:{uniforms:Un([as.common,as.displacementmap]),vertexShader:rs.depth_vert,fragmentShader:rs.depth_frag},normal:{uniforms:Un([as.common,as.bumpmap,as.normalmap,as.displacementmap,{opacity:{value:1}}]),vertexShader:rs.meshnormal_vert,fragmentShader:rs.meshnormal_frag},sprite:{uniforms:Un([as.sprite,as.fog]),vertexShader:rs.sprite_vert,fragmentShader:rs.sprite_frag},background:{uniforms:{uvTransform:{value:new re},t2D:{value:null},backgroundIntensity:{value:1}},vertexShader:rs.background_vert,fragmentShader:rs.background_frag},backgroundCube:{uniforms:{envMap:{value:null},flipEnvMap:{value:-1},backgroundBlurriness:{value:0},backgroundIntensity:{value:1}},vertexShader:rs.backgroundCube_vert,fragmentShader:rs.backgroundCube_frag},cube:{uniforms:{tCube:{value:null},tFlip:{value:-1},opacity:{value:1}},vertexShader:rs.cube_vert,fragmentShader:rs.cube_frag},equirect:{uniforms:{tEquirect:{value:null}},vertexShader:rs.equirect_vert,fragmentShader:rs.equirect_frag},distanceRGBA:{uniforms:Un([as.common,as.displacementmap,{referencePosition:{value:new Le},nearDistance:{value:1},farDistance:{value:1e3}}]),vertexShader:rs.distanceRGBA_vert,fragmentShader:rs.distanceRGBA_frag},shadow:{uniforms:Un([as.lights,as.fog,{color:{value:new Zi(0)},opacity:{value:1}}]),vertexShader:rs.shadow_vert,fragmentShader:rs.shadow_frag}};os.physical={uniforms:Un([os.standard.uniforms,{clearcoat:{value:0},clearcoatMap:{value:null},clearcoatMapTransform:{value:new re},clearcoatNormalMap:{value:null},clearcoatNormalMapTransform:{value:new re},clearcoatNormalScale:{value:new se(1,1)},clearcoatRoughness:{value:0},clearcoatRoughnessMap:{value:null},clearcoatRoughnessMapTransform:{value:new re},iridescence:{value:0},iridescenceMap:{value:null},iridescenceMapTransform:{value:new re},iridescenceIOR:{value:1.3},iridescenceThicknessMinimum:{value:100},iridescenceThicknessMaximum:{value:400},iridescenceThicknessMap:{value:null},iridescenceThicknessMapTransform:{value:new re},sheen:{value:0},sheenColor:{value:new Zi(0)},sheenColorMap:{value:null},sheenColorMapTransform:{value:new re},sheenRoughness:{value:1},sheenRoughnessMap:{value:null},sheenRoughnessMapTransform:{value:new re},transmission:{value:0},transmissionMap:{value:null},transmissionMapTransform:{value:new re},transmissionSamplerSize:{value:new se},transmissionSamplerMap:{value:null},thickness:{value:0},thicknessMap:{value:null},thicknessMapTransform:{value:new re},attenuationDistance:{value:0},attenuationColor:{value:new Zi(0)},specularColor:{value:new Zi(1,1,1)},specularColorMap:{value:null},specularColorMapTransform:{value:new re},specularIntensity:{value:1},specularIntensityMap:{value:null},specularIntensityMapTransform:{value:new re},anisotropyVector:{value:new se},anisotropyMap:{value:null},anisotropyMapTransform:{value:new re}}]),vertexShader:rs.meshphysical_vert,fragmentShader:rs.meshphysical_frag};const hs={r:0,b:0,g:0};function ls(t,e,i,n,s,r,a){const o=new Zi(0);let h,l,c=!0===r?0:1,u=null,d=0,p=null;function m(e,i){e.getRGB(hs,Fn(t)),n.buffers.color.setClear(hs.r,hs.g,hs.b,i,a)}return{getClearColor:function(){return o},setClearColor:function(t,e=1){o.set(t),c=e,m(o,c)},getClearAlpha:function(){return c},setClearAlpha:function(t){c=t,m(o,c)},render:function(r,f){let g=!1,v=!0===f.isScene?f.background:null;if(v&&v.isTexture){v=(f.backgroundBlurriness>0?i:e).get(v)}null===v?m(o,c):v&&v.isColor&&(m(v,1),g=!0);const y=t.xr.getEnvironmentBlendMode();"additive"===y?n.buffers.color.setClear(0,0,0,1,a):"alpha-blend"===y&&n.buffers.color.setClear(0,0,0,0,a),(t.autoClear||g)&&t.clear(t.autoClearColor,t.autoClearDepth,t.autoClearStencil),v&&(v.isCubeTexture||v.mapping===q)?(void 0===l&&(l=new On(new Bn(1,1,1),new Vn({name:"BackgroundCubeMaterial",uniforms:zn(os.backgroundCube.uniforms),vertexShader:os.backgroundCube.vertexShader,fragmentShader:os.backgroundCube.fragmentShader,side:R,depthTest:!1,depthWrite:!1,fog:!1})),l.geometry.deleteAttribute("normal"),l.geometry.deleteAttribute("uv"),l.onBeforeRender=function(t,e,i){this.matrixWorld.copyPosition(i.matrixWorld)},Object.defineProperty(l.material,"envMap",{get:function(){return this.uniforms.envMap.value}}),s.update(l)),l.material.uniforms.envMap.value=v,l.material.uniforms.flipEnvMap.value=v.isCubeTexture&&!1===v.isRenderTargetTexture?-1:1,l.material.uniforms.backgroundBlurriness.value=f.backgroundBlurriness,l.material.uniforms.backgroundIntensity.value=f.backgroundIntensity,l.material.toneMapped=ye.getTransfer(v.colorSpace)!==Lt,u===v&&d===v.version&&p===t.toneMapping||(l.material.needsUpdate=!0,u=v,d=v.version,p=t.toneMapping),l.layers.enableAll(),r.unshift(l,l.geometry,l.material,0,0,null)):v&&v.isTexture&&(void 0===h&&(h=new On(new ss(2,2),new Vn({name:"BackgroundMaterial",uniforms:zn(os.background.uniforms),vertexShader:os.background.vertexShader,fragmentShader:os.background.fragmentShader,side:I,depthTest:!1,depthWrite:!1,fog:!1})),h.geometry.deleteAttribute("normal"),Object.defineProperty(h.material,"map",{get:function(){return this.uniforms.t2D.value}}),s.update(h)),h.material.uniforms.t2D.value=v,h.material.uniforms.backgroundIntensity.value=f.backgroundIntensity,h.material.toneMapped=ye.getTransfer(v.colorSpace)!==Lt,!0===v.matrixAutoUpdate&&v.updateMatrix(),h.material.uniforms.uvTransform.value.copy(v.matrix),u===v&&d===v.version&&p===t.toneMapping||(h.material.needsUpdate=!0,u=v,d=v.version,p=t.toneMapping),h.layers.enableAll(),r.unshift(h,h.geometry,h.material,0,0,null))}}}function cs(t,e,i,n){const s=t.getParameter(t.MAX_VERTEX_ATTRIBS),r=n.isWebGL2?null:e.get("OES_vertex_array_object"),a=n.isWebGL2||null!==r,o={},h=p(null);let l=h,c=!1;function u(e){return n.isWebGL2?t.bindVertexArray(e):r.bindVertexArrayOES(e)}function d(e){return n.isWebGL2?t.deleteVertexArray(e):r.deleteVertexArrayOES(e)}function p(t){const e=[],i=[],n=[];for(let t=0;t<s;t++)e[t]=0,i[t]=0,n[t]=0;return{geometry:null,program:null,wireframe:!1,newAttributes:e,enabledAttributes:i,attributeDivisors:n,object:t,attributes:{},index:null}}function m(){const t=l.newAttributes;for(let e=0,i=t.length;e<i;e++)t[e]=0}function f(t){g(t,0)}function g(i,s){const r=l.newAttributes,a=l.enabledAttributes,o=l.attributeDivisors;if(r[i]=1,0===a[i]&&(t.enableVertexAttribArray(i),a[i]=1),o[i]!==s){(n.isWebGL2?t:e.get("ANGLE_instanced_arrays"))[n.isWebGL2?"vertexAttribDivisor":"vertexAttribDivisorANGLE"](i,s),o[i]=s}}function v(){const e=l.newAttributes,i=l.enabledAttributes;for(let n=0,s=i.length;n<s;n++)i[n]!==e[n]&&(t.disableVertexAttribArray(n),i[n]=0)}function y(e,i,n,s,r,a,o){!0===o?t.vertexAttribIPointer(e,i,n,r,a):t.vertexAttribPointer(e,i,n,s,r,a)}function x(){b(),c=!0,l!==h&&(l=h,u(l.object))}function b(){h.geometry=null,h.program=null,h.wireframe=!1}return{setup:function(s,h,d,x,b){let _=!1;if(a){const e=function(e,i,s){const a=!0===s.wireframe;let h=o[e.id];void 0===h&&(h={},o[e.id]=h);let l=h[i.id];void 0===l&&(l={},h[i.id]=l);let c=l[a];void 0===c&&(c=p(n.isWebGL2?t.createVertexArray():r.createVertexArrayOES()),l[a]=c);return c}(x,d,h);l!==e&&(l=e,u(l.object)),_=function(t,e,i,n){const s=l.attributes,r=e.attributes;let a=0;const o=i.getAttributes();for(const e in o){if(o[e].location>=0){const i=s[e];let n=r[e];if(void 0===n&&("instanceMatrix"===e&&t.instanceMatrix&&(n=t.instanceMatrix),"instanceColor"===e&&t.instanceColor&&(n=t.instanceColor)),void 0===i)return!0;if(i.attribute!==n)return!0;if(n&&i.data!==n.data)return!0;a++}}return l.attributesNum!==a||l.index!==n}(s,x,d,b),_&&function(t,e,i,n){const s={},r=e.attributes;let a=0;const o=i.getAttributes();for(const e in o){if(o[e].location>=0){let i=r[e];void 0===i&&("instanceMatrix"===e&&t.instanceMatrix&&(i=t.instanceMatrix),"instanceColor"===e&&t.instanceColor&&(i=t.instanceColor));const n={};n.attribute=i,i&&i.data&&(n.data=i.data),s[e]=n,a++}}l.attributes=s,l.attributesNum=a,l.index=n}(s,x,d,b)}else{const t=!0===h.wireframe;l.geometry===x.id&&l.program===d.id&&l.wireframe===t||(l.geometry=x.id,l.program=d.id,l.wireframe=t,_=!0)}null!==b&&i.update(b,t.ELEMENT_ARRAY_BUFFER),(_||c)&&(c=!1,function(s,r,a,o){if(!1===n.isWebGL2&&(s.isInstancedMesh||o.isInstancedBufferGeometry)&&null===e.get("ANGLE_instanced_arrays"))return;m();const h=o.attributes,l=a.getAttributes(),c=r.defaultAttributeValues;for(const e in l){const r=l[e];if(r.location>=0){let a=h[e];if(void 0===a&&("instanceMatrix"===e&&s.instanceMatrix&&(a=s.instanceMatrix),"instanceColor"===e&&s.instanceColor&&(a=s.instanceColor)),void 0!==a){const e=a.normalized,h=a.itemSize,l=i.get(a);if(void 0===l)continue;const c=l.buffer,u=l.type,d=l.bytesPerElement,p=!0===n.isWebGL2&&(u===t.INT||u===t.UNSIGNED_INT||a.gpuType===rt);if(a.isInterleavedBufferAttribute){const i=a.data,n=i.stride,l=a.offset;if(i.isInstancedInterleavedBuffer){for(let t=0;t<r.locationSize;t++)g(r.location+t,i.meshPerAttribute);!0!==s.isInstancedMesh&&void 0===o._maxInstanceCount&&(o._maxInstanceCount=i.meshPerAttribute*i.count)}else for(let t=0;t<r.locationSize;t++)f(r.location+t);t.bindBuffer(t.ARRAY_BUFFER,c);for(let t=0;t<r.locationSize;t++)y(r.location+t,h/r.locationSize,u,e,n*d,(l+h/r.locationSize*t)*d,p)}else{if(a.isInstancedBufferAttribute){for(let t=0;t<r.locationSize;t++)g(r.location+t,a.meshPerAttribute);!0!==s.isInstancedMesh&&void 0===o._maxInstanceCount&&(o._maxInstanceCount=a.meshPerAttribute*a.count)}else for(let t=0;t<r.locationSize;t++)f(r.location+t);t.bindBuffer(t.ARRAY_BUFFER,c);for(let t=0;t<r.locationSize;t++)y(r.location+t,h/r.locationSize,u,e,h*d,h/r.locationSize*t*d,p)}}else if(void 0!==c){const i=c[e];if(void 0!==i)switch(i.length){case 2:t.vertexAttrib2fv(r.location,i);break;case 3:t.vertexAttrib3fv(r.location,i);break;case 4:t.vertexAttrib4fv(r.location,i);break;default:t.vertexAttrib1fv(r.location,i)}}}}v()}(s,h,d,x),null!==b&&t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,i.get(b).buffer))},reset:x,resetDefaultState:b,dispose:function(){x();for(const t in o){const e=o[t];for(const t in e){const i=e[t];for(const t in i)d(i[t].object),delete i[t];delete e[t]}delete o[t]}},releaseStatesOfGeometry:function(t){if(void 0===o[t.id])return;const e=o[t.id];for(const t in e){const i=e[t];for(const t in i)d(i[t].object),delete i[t];delete e[t]}delete o[t.id]},releaseStatesOfProgram:function(t){for(const e in o){const i=o[e];if(void 0===i[t.id])continue;const n=i[t.id];for(const t in n)d(n[t].object),delete n[t];delete i[t.id]}},initAttributes:m,enableAttribute:f,disableUnusedAttributes:v}}function us(t,e,i,n){const s=n.isWebGL2;let r;this.setMode=function(t){r=t},this.render=function(e,n){t.drawArrays(r,e,n),i.update(n,r,1)},this.renderInstances=function(n,a,o){if(0===o)return;let h,l;if(s)h=t,l="drawArraysInstanced";else if(h=e.get("ANGLE_instanced_arrays"),l="drawArraysInstancedANGLE",null===h)return;h[l](r,n,a,o),i.update(a,r,o)},this.renderMultiDraw=function(t,n,s){if(0===s)return;const a=e.get("WEBGL_multi_draw");if(null===a)for(let e=0;e<s;e++)this.render(t[e],n[e]);else{a.multiDrawArraysWEBGL(r,t,0,n,0,s);let e=0;for(let t=0;t<s;t++)e+=n[t];i.update(e,r,1)}}}function ds(t,e,i){let n;function s(e){if("highp"===e){if(t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.HIGH_FLOAT).precision>0&&t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT).precision>0)return"highp";e="mediump"}return"mediump"===e&&t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.MEDIUM_FLOAT).precision>0&&t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.MEDIUM_FLOAT).precision>0?"mediump":"lowp"}const r="undefined"!=typeof WebGL2RenderingContext&&"WebGL2RenderingContext"===t.constructor.name;let a=void 0!==i.precision?i.precision:"highp";const o=s(a);o!==a&&(a=o);const h=r||e.has("WEBGL_draw_buffers"),l=!0===i.logarithmicDepthBuffer,c=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),u=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),d=t.getParameter(t.MAX_TEXTURE_SIZE),p=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),m=t.getParameter(t.MAX_VERTEX_ATTRIBS),f=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),g=t.getParameter(t.MAX_VARYING_VECTORS),v=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),y=u>0,x=r||e.has("OES_texture_float");return{isWebGL2:r,drawBuffers:h,getMaxAnisotropy:function(){if(void 0!==n)return n;if(!0===e.has("EXT_texture_filter_anisotropic")){const i=e.get("EXT_texture_filter_anisotropic");n=t.getParameter(i.MAX_TEXTURE_MAX_ANISOTROPY_EXT)}else n=0;return n},getMaxPrecision:s,precision:a,logarithmicDepthBuffer:l,maxTextures:c,maxVertexTextures:u,maxTextureSize:d,maxCubemapSize:p,maxAttributes:m,maxVertexUniforms:f,maxVaryings:g,maxFragmentUniforms:v,vertexTextures:y,floatFragmentTextures:x,floatVertexTextures:y&&x,maxSamples:r?t.getParameter(t.MAX_SAMPLES):0}}function ps(t){const e=this;let i=null,n=0,s=!1,r=!1;const a=new Zn,o=new re,h={value:null,needsUpdate:!1};function l(t,i,n,s){const r=null!==t?t.length:0;let l=null;if(0!==r){if(l=h.value,!0!==s||null===l){const e=n+4*r,s=i.matrixWorldInverse;o.getNormalMatrix(s),(null===l||l.length<e)&&(l=new Float32Array(e));for(let e=0,i=n;e!==r;++e,i+=4)a.copy(t[e]).applyMatrix4(s,o),a.normal.toArray(l,i),l[i+3]=a.constant}h.value=l,h.needsUpdate=!0}return e.numPlanes=r,e.numIntersection=0,l}this.uniform=h,this.numPlanes=0,this.numIntersection=0,this.init=function(t,e){const i=0!==t.length||e||0!==n||s;return s=e,n=t.length,i},this.beginShadows=function(){r=!0,l(null)},this.endShadows=function(){r=!1},this.setGlobalState=function(t,e){i=l(t,e,0)},this.setState=function(a,o,c){const u=a.clippingPlanes,d=a.clipIntersection,p=a.clipShadows,m=t.get(a);if(!s||null===u||0===u.length||r&&!p)r?l(null):function(){h.value!==i&&(h.value=i,h.needsUpdate=n>0);e.numPlanes=n,e.numIntersection=0}();else{const t=r?0:n,e=4*t;let s=m.clippingState||null;h.value=s,s=l(u,o,e,c);for(let t=0;t!==e;++t)s[t]=i[t];m.clippingState=s,this.numIntersection=d?this.numPlanes:0,this.numPlanes+=t}}}function ms(t){let e=new WeakMap;function i(t,e){return e===W?t.mapping=H:e===X&&(t.mapping=j),t}function n(t){const i=t.target;i.removeEventListener("dispose",n);const s=e.get(i);void 0!==s&&(e.delete(i),s.dispose())}return{get:function(s){if(s&&s.isTexture){const r=s.mapping;if(r===W||r===X){if(e.has(s)){return i(e.get(s).texture,s.mapping)}{const r=s.image;if(r&&r.height>0){const a=new Yn(r.height/2);return a.fromEquirectangularTexture(t,s),e.set(s,a),s.addEventListener("dispose",n),i(a.texture,s.mapping)}return null}}}return s},dispose:function(){e=new WeakMap}}}class fs extends Hn{constructor(t=-1,e=1,i=1,n=-1,s=.1,r=2e3){super(),this.isOrthographicCamera=!0,this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=t,this.right=e,this.top=i,this.bottom=n,this.near=s,this.far=r,this.updateProjectionMatrix()}copy(t,e){return super.copy(t,e),this.left=t.left,this.right=t.right,this.top=t.top,this.bottom=t.bottom,this.near=t.near,this.far=t.far,this.zoom=t.zoom,this.view=null===t.view?null:Object.assign({},t.view),this}setViewOffset(t,e,i,n,s,r){null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=t,this.view.fullHeight=e,this.view.offsetX=i,this.view.offsetY=n,this.view.width=s,this.view.height=r,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const t=(this.right-this.left)/(2*this.zoom),e=(this.top-this.bottom)/(2*this.zoom),i=(this.right+this.left)/2,n=(this.top+this.bottom)/2;let s=i-t,r=i+t,a=n+e,o=n-e;if(null!==this.view&&this.view.enabled){const t=(this.right-this.left)/this.view.fullWidth/this.zoom,e=(this.top-this.bottom)/this.view.fullHeight/this.zoom;s+=t*this.view.offsetX,r=s+t*this.view.width,a-=e*this.view.offsetY,o=a-e*this.view.height}this.projectionMatrix.makeOrthographic(s,r,a,o,this.near,this.far,this.coordinateSystem),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(t){const e=super.toJSON(t);return e.object.zoom=this.zoom,e.object.left=this.left,e.object.right=this.right,e.object.top=this.top,e.object.bottom=this.bottom,e.object.near=this.near,e.object.far=this.far,null!==this.view&&(e.object.view=Object.assign({},this.view)),e}}const gs=[.125,.215,.35,.446,.526,.582],vs=20,ys=new fs,xs=new Zi;let bs=null,_s=0,ws=0;const Ms=(1+Math.sqrt(5))/2,Ss=1/Ms,Es=[new Le(1,1,1),new Le(-1,1,1),new Le(1,1,-1),new Le(-1,1,-1),new Le(0,Ms,Ss),new Le(0,Ms,-Ss),new Le(Ss,0,Ms),new Le(-Ss,0,Ms),new Le(Ms,Ss,0),new Le(-Ms,Ss,0)];class Ts{constructor(t){this._renderer=t,this._pingPongRenderTarget=null,this._lodMax=0,this._cubeSize=0,this._lodPlanes=[],this._sizeLods=[],this._sigmas=[],this._blurMaterial=null,this._cubemapMaterial=null,this._equirectMaterial=null,this._compileMaterial(this._blurMaterial)}fromScene(t,e=0,i=.1,n=100){bs=this._renderer.getRenderTarget(),_s=this._renderer.getActiveCubeFace(),ws=this._renderer.getActiveMipmapLevel(),this._setSize(256);const s=this._allocateTargets();return s.depthBuffer=!0,this._sceneToCubeUV(t,i,n,s),e>0&&this._blur(s,0,0,e),this._applyPMREM(s),this._cleanup(s),s}fromEquirectangular(t,e=null){return this._fromTexture(t,e)}fromCubemap(t,e=null){return this._fromTexture(t,e)}compileCubemapShader(){null===this._cubemapMaterial&&(this._cubemapMaterial=Rs(),this._compileMaterial(this._cubemapMaterial))}compileEquirectangularShader(){null===this._equirectMaterial&&(this._equirectMaterial=Is(),this._compileMaterial(this._equirectMaterial))}dispose(){this._dispose(),null!==this._cubemapMaterial&&this._cubemapMaterial.dispose(),null!==this._equirectMaterial&&this._equirectMaterial.dispose()}_setSize(t){this._lodMax=Math.floor(Math.log2(t)),this._cubeSize=Math.pow(2,this._lodMax)}_dispose(){null!==this._blurMaterial&&this._blurMaterial.dispose(),null!==this._pingPongRenderTarget&&this._pingPongRenderTarget.dispose();for(let t=0;t<this._lodPlanes.length;t++)this._lodPlanes[t].dispose()}_cleanup(t){this._renderer.setRenderTarget(bs,_s,ws),t.scissorTest=!1,Cs(t,0,0,t.width,t.height)}_fromTexture(t,e){t.mapping===H||t.mapping===j?this._setSize(0===t.image.length?16:t.image[0].width||t.image[0].image.width):this._setSize(t.image.width/4),bs=this._renderer.getRenderTarget(),_s=this._renderer.getActiveCubeFace(),ws=this._renderer.getActiveMipmapLevel();const i=e||this._allocateTargets();return this._textureToCubeUV(t,i),this._applyPMREM(i),this._cleanup(i),i}_allocateTargets(){const t=3*Math.max(this._cubeSize,112),e=4*this._cubeSize,i={magFilter:tt,minFilter:tt,generateMipmaps:!1,type:ht,format:ct,colorSpace:Rt,depthBuffer:!1},n=As(t,e,i);if(null===this._pingPongRenderTarget||this._pingPongRenderTarget.width!==t||this._pingPongRenderTarget.height!==e){null!==this._pingPongRenderTarget&&this._dispose(),this._pingPongRenderTarget=As(t,e,i);const{_lodMax:n}=this;({sizeLods:this._sizeLods,lodPlanes:this._lodPlanes,sigmas:this._sigmas}=function(t){const e=[],i=[],n=[];let s=t;const r=t-4+1+gs.length;for(let a=0;a<r;a++){const r=Math.pow(2,s);i.push(r);let o=1/r;a>t-4?o=gs[a-t+4-1]:0===a&&(o=0),n.push(o);const h=1/(r-2),l=-h,c=1+h,u=[l,l,c,l,c,c,l,l,c,c,l,c],d=6,p=6,m=3,f=2,g=1,v=new Float32Array(m*p*d),y=new Float32Array(f*p*d),x=new Float32Array(g*p*d);for(let t=0;t<d;t++){const e=t%3*2/3-1,i=t>2?0:-1,n=[e,i,0,e+2/3,i,0,e+2/3,i+1,0,e,i,0,e+2/3,i+1,0,e,i+1,0];v.set(n,m*p*t),y.set(u,f*p*t);const s=[t,t,t,t,t,t];x.set(s,g*p*t)}const b=new vn;b.setAttribute("position",new an(v,m)),b.setAttribute("uv",new an(y,f)),b.setAttribute("faceIndex",new an(x,g)),e.push(b),s>4&&s--}return{lodPlanes:e,sizeLods:i,sigmas:n}}(n)),this._blurMaterial=function(t,e,i){const n=new Float32Array(vs),s=new Le(0,1,0),r=new Vn({name:"SphericalGaussianBlur",defines:{n:vs,CUBEUV_TEXEL_WIDTH:1/e,CUBEUV_TEXEL_HEIGHT:1/i,CUBEUV_MAX_MIP:`${t}.0`},uniforms:{envMap:{value:null},samples:{value:1},weights:{value:n},latitudinal:{value:!1},dTheta:{value:0},mipInt:{value:0},poleAxis:{value:s}},vertexShader:ks(),fragmentShader:"\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform sampler2D envMap;\n\t\t\tuniform int samples;\n\t\t\tuniform float weights[ n ];\n\t\t\tuniform bool latitudinal;\n\t\t\tuniform float dTheta;\n\t\t\tuniform float mipInt;\n\t\t\tuniform vec3 poleAxis;\n\n\t\t\t#define ENVMAP_TYPE_CUBE_UV\n\t\t\t#include <cube_uv_reflection_fragment>\n\n\t\t\tvec3 getSample( float theta, vec3 axis ) {\n\n\t\t\t\tfloat cosTheta = cos( theta );\n\t\t\t\t// Rodrigues' axis-angle rotation\n\t\t\t\tvec3 sampleDirection = vOutputDirection * cosTheta\n\t\t\t\t\t+ cross( axis, vOutputDirection ) * sin( theta )\n\t\t\t\t\t+ axis * dot( axis, vOutputDirection ) * ( 1.0 - cosTheta );\n\n\t\t\t\treturn bilinearCubeUV( envMap, sampleDirection, mipInt );\n\n\t\t\t}\n\n\t\t\tvoid main() {\n\n\t\t\t\tvec3 axis = latitudinal ? poleAxis : cross( poleAxis, vOutputDirection );\n\n\t\t\t\tif ( all( equal( axis, vec3( 0.0 ) ) ) ) {\n\n\t\t\t\t\taxis = vec3( vOutputDirection.z, 0.0, - vOutputDirection.x );\n\n\t\t\t\t}\n\n\t\t\t\taxis = normalize( axis );\n\n\t\t\t\tgl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );\n\t\t\t\tgl_FragColor.rgb += weights[ 0 ] * getSample( 0.0, axis );\n\n\t\t\t\tfor ( int i = 1; i < n; i++ ) {\n\n\t\t\t\t\tif ( i >= samples ) {\n\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t}\n\n\t\t\t\t\tfloat theta = dTheta * float( i );\n\t\t\t\t\tgl_FragColor.rgb += weights[ i ] * getSample( -1.0 * theta, axis );\n\t\t\t\t\tgl_FragColor.rgb += weights[ i ] * getSample( theta, axis );\n\n\t\t\t\t}\n\n\t\t\t}\n\t\t",blending:0,depthTest:!1,depthWrite:!1});return r}(n,t,e)}return n}_compileMaterial(t){const e=new On(this._lodPlanes[0],t);this._renderer.compile(e,ys)}_sceneToCubeUV(t,e,i,n){const s=new jn(90,1,e,i),r=[1,-1,1,1,1,1],a=[1,1,1,-1,-1,-1],o=this._renderer,h=o.autoClear,l=o.toneMapping;o.getClearColor(xs),o.toneMapping=O,o.autoClear=!1;const c=new nn({name:"PMREM.Background",side:R,depthWrite:!1,depthTest:!1}),u=new On(new Bn,c);let d=!1;const p=t.background;p?p.isColor&&(c.color.copy(p),t.background=null,d=!0):(c.color.copy(xs),d=!0);for(let e=0;e<6;e++){const i=e%3;0===i?(s.up.set(0,r[e],0),s.lookAt(a[e],0,0)):1===i?(s.up.set(0,0,r[e]),s.lookAt(0,a[e],0)):(s.up.set(0,r[e],0),s.lookAt(0,0,a[e]));const h=this._cubeSize;Cs(n,i*h,e>2?h:0,h,h),o.setRenderTarget(n),d&&o.render(u,s),o.render(t,s)}u.geometry.dispose(),u.material.dispose(),o.toneMapping=l,o.autoClear=h,t.background=p}_textureToCubeUV(t,e){const i=this._renderer,n=t.mapping===H||t.mapping===j;n?(null===this._cubemapMaterial&&(this._cubemapMaterial=Rs()),this._cubemapMaterial.uniforms.flipEnvMap.value=!1===t.isRenderTargetTexture?-1:1):null===this._equirectMaterial&&(this._equirectMaterial=Is());const s=n?this._cubemapMaterial:this._equirectMaterial,r=new On(this._lodPlanes[0],s);s.uniforms.envMap.value=t;const a=this._cubeSize;Cs(e,0,0,3*a,2*a),i.setRenderTarget(e),i.render(r,ys)}_applyPMREM(t){const e=this._renderer,i=e.autoClear;e.autoClear=!1;for(let e=1;e<this._lodPlanes.length;e++){const i=Math.sqrt(this._sigmas[e]*this._sigmas[e]-this._sigmas[e-1]*this._sigmas[e-1]),n=Es[(e-1)%Es.length];this._blur(t,e-1,e,i,n)}e.autoClear=i}_blur(t,e,i,n,s){const r=this._pingPongRenderTarget;this._halfBlur(t,r,e,i,n,"latitudinal",s),this._halfBlur(r,t,i,i,n,"longitudinal",s)}_halfBlur(t,e,i,n,s,r,a){const o=this._renderer,h=this._blurMaterial,l=new On(this._lodPlanes[n],h),c=h.uniforms,u=this._sizeLods[i]-1,d=isFinite(s)?Math.PI/(2*u):2*Math.PI/39,p=s/d,m=isFinite(s)?1+Math.floor(3*p):vs,f=[];let g=0;for(let t=0;t<vs;++t){const e=t/p,i=Math.exp(-e*e/2);f.push(i),0===t?g+=i:t<m&&(g+=2*i)}for(let t=0;t<f.length;t++)f[t]=f[t]/g;c.envMap.value=t.texture,c.samples.value=m,c.weights.value=f,c.latitudinal.value="latitudinal"===r,a&&(c.poleAxis.value=a);const{_lodMax:v}=this;c.dTheta.value=d,c.mipInt.value=v-i;const y=this._sizeLods[n];Cs(e,3*y*(n>v-4?n-v+4:0),4*(this._cubeSize-y),3*y,2*y),o.setRenderTarget(e),o.render(l,ys)}}function As(t,e,i){const n=new Re(t,e,i);return n.texture.mapping=q,n.texture.name="PMREM.cubeUv",n.scissorTest=!0,n}function Cs(t,e,i,n,s){t.viewport.set(e,i,n,s),t.scissor.set(e,i,n,s)}function Is(){return new Vn({name:"EquirectangularToCubeUV",uniforms:{envMap:{value:null}},vertexShader:ks(),fragmentShader:"\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform sampler2D envMap;\n\n\t\t\t#include <common>\n\n\t\t\tvoid main() {\n\n\t\t\t\tvec3 outputDirection = normalize( vOutputDirection );\n\t\t\t\tvec2 uv = equirectUv( outputDirection );\n\n\t\t\t\tgl_FragColor = vec4( texture2D ( envMap, uv ).rgb, 1.0 );\n\n\t\t\t}\n\t\t",blending:0,depthTest:!1,depthWrite:!1})}function Rs(){return new Vn({name:"CubemapToCubeUV",uniforms:{envMap:{value:null},flipEnvMap:{value:-1}},vertexShader:ks(),fragmentShader:"\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tuniform float flipEnvMap;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform samplerCube envMap;\n\n\t\t\tvoid main() {\n\n\t\t\t\tgl_FragColor = textureCube( envMap, vec3( flipEnvMap * vOutputDirection.x, vOutputDirection.yz ) );\n\n\t\t\t}\n\t\t",blending:0,depthTest:!1,depthWrite:!1})}function ks(){return"\n\n\t\tprecision mediump float;\n\t\tprecision mediump int;\n\n\t\tattribute float faceIndex;\n\n\t\tvarying vec3 vOutputDirection;\n\n\t\t// RH coordinate system; PMREM face-indexing convention\n\t\tvec3 getDirection( vec2 uv, float face ) {\n\n\t\t\tuv = 2.0 * uv - 1.0;\n\n\t\t\tvec3 direction = vec3( uv, 1.0 );\n\n\t\t\tif ( face == 0.0 ) {\n\n\t\t\t\tdirection = direction.zyx; // ( 1, v, u ) pos x\n\n\t\t\t} else if ( face == 1.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xz *= -1.0; // ( -u, 1, -v ) pos y\n\n\t\t\t} else if ( face == 2.0 ) {\n\n\t\t\t\tdirection.x *= -1.0; // ( -u, v, 1 ) pos z\n\n\t\t\t} else if ( face == 3.0 ) {\n\n\t\t\t\tdirection = direction.zyx;\n\t\t\t\tdirection.xz *= -1.0; // ( -1, v, -u ) neg x\n\n\t\t\t} else if ( face == 4.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xy *= -1.0; // ( -u, -1, v ) neg y\n\n\t\t\t} else if ( face == 5.0 ) {\n\n\t\t\t\tdirection.z *= -1.0; // ( u, v, -1 ) neg z\n\n\t\t\t}\n\n\t\t\treturn direction;\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tvOutputDirection = getDirection( uv, faceIndex );\n\t\t\tgl_Position = vec4( position, 1.0 );\n\n\t\t}\n\t"}function Ps(t){let e=new WeakMap,i=null;function n(t){const i=t.target;i.removeEventListener("dispose",n);const s=e.get(i);void 0!==s&&(e.delete(i),s.dispose())}return{get:function(s){if(s&&s.isTexture){const r=s.mapping,a=r===W||r===X,o=r===H||r===j;if(a||o){if(s.isRenderTargetTexture&&!0===s.needsPMREMUpdate){s.needsPMREMUpdate=!1;let n=e.get(s);return null===i&&(i=new Ts(t)),n=a?i.fromEquirectangular(s,n):i.fromCubemap(s,n),e.set(s,n),n.texture}if(e.has(s))return e.get(s).texture;{const r=s.image;if(a&&r&&r.height>0||o&&r&&function(t){let e=0;const i=6;for(let n=0;n<i;n++)void 0!==t[n]&&e++;return e===i}(r)){null===i&&(i=new Ts(t));const r=a?i.fromEquirectangular(s):i.fromCubemap(s);return e.set(s,r),s.addEventListener("dispose",n),r.texture}return null}}}return s},dispose:function(){e=new WeakMap,null!==i&&(i.dispose(),i=null)}}}function Ds(t){const e={};function i(i){if(void 0!==e[i])return e[i];let n;switch(i){case"WEBGL_depth_texture":n=t.getExtension("WEBGL_depth_texture")||t.getExtension("MOZ_WEBGL_depth_texture")||t.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":n=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":n=t.getExtension("WEBGL_compressed_texture_s3tc")||t.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||t.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":n=t.getExtension("WEBGL_compressed_texture_pvrtc")||t.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:n=t.getExtension(i)}return e[i]=n,n}return{has:function(t){return null!==i(t)},init:function(t){t.isWebGL2?(i("EXT_color_buffer_float"),i("WEBGL_clip_cull_distance")):(i("WEBGL_depth_texture"),i("OES_texture_float"),i("OES_texture_half_float"),i("OES_texture_half_float_linear"),i("OES_standard_derivatives"),i("OES_element_index_uint"),i("OES_vertex_array_object"),i("ANGLE_instanced_arrays")),i("OES_texture_float_linear"),i("EXT_color_buffer_half_float"),i("WEBGL_multisampled_render_to_texture")},get:function(t){const e=i(t);return e}}}function Ls(t,e,i,n){const s={},r=new WeakMap;function a(t){const o=t.target;null!==o.index&&e.remove(o.index);for(const t in o.attributes)e.remove(o.attributes[t]);for(const t in o.morphAttributes){const i=o.morphAttributes[t];for(let t=0,n=i.length;t<n;t++)e.remove(i[t])}o.removeEventListener("dispose",a),delete s[o.id];const h=r.get(o);h&&(e.remove(h),r.delete(o)),n.releaseStatesOfGeometry(o),!0===o.isInstancedBufferGeometry&&delete o._maxInstanceCount,i.memory.geometries--}function o(t){const i=[],n=t.index,s=t.attributes.position;let a=0;if(null!==n){const t=n.array;a=n.version;for(let e=0,n=t.length;e<n;e+=3){const n=t[e+0],s=t[e+1],r=t[e+2];i.push(n,s,s,r,r,n)}}else{if(void 0===s)return;{const t=s.array;a=s.version;for(let e=0,n=t.length/3-1;e<n;e+=3){const t=e+0,n=e+1,s=e+2;i.push(t,n,n,s,s,t)}}}const o=new(oe(i)?hn:on)(i,1);o.version=a;const h=r.get(t);h&&e.remove(h),r.set(t,o)}return{get:function(t,e){return!0===s[e.id]||(e.addEventListener("dispose",a),s[e.id]=!0,i.memory.geometries++),e},update:function(i){const n=i.attributes;for(const i in n)e.update(n[i],t.ARRAY_BUFFER);const s=i.morphAttributes;for(const i in s){const n=s[i];for(let i=0,s=n.length;i<s;i++)e.update(n[i],t.ARRAY_BUFFER)}},getWireframeAttribute:function(t){const e=r.get(t);if(e){const i=t.index;null!==i&&e.version<i.version&&o(t)}else o(t);return r.get(t)}}}function Os(t,e,i,n){const s=n.isWebGL2;let r,a,o;this.setMode=function(t){r=t},this.setIndex=function(t){a=t.type,o=t.bytesPerElement},this.render=function(e,n){t.drawElements(r,n,a,e*o),i.update(n,r,1)},this.renderInstances=function(n,h,l){if(0===l)return;let c,u;if(s)c=t,u="drawElementsInstanced";else if(c=e.get("ANGLE_instanced_arrays"),u="drawElementsInstancedANGLE",null===c)return;c[u](r,h,a,n*o,l),i.update(h,r,l)},this.renderMultiDraw=function(t,n,s){if(0===s)return;const h=e.get("WEBGL_multi_draw");if(null===h)for(let e=0;e<s;e++)this.render(t[e]/o,n[e]);else{h.multiDrawElementsWEBGL(r,n,0,a,t,0,s);let e=0;for(let t=0;t<s;t++)e+=n[t];i.update(e,r,1)}}}function Ns(t){const e={frame:0,calls:0,triangles:0,points:0,lines:0};return{memory:{geometries:0,textures:0},render:e,programs:null,autoReset:!0,reset:function(){e.calls=0,e.triangles=0,e.points=0,e.lines=0},update:function(i,n,s){switch(e.calls++,n){case t.TRIANGLES:e.triangles+=s*(i/3);break;case t.LINES:e.lines+=s*(i/2);break;case t.LINE_STRIP:e.lines+=s*(i-1);break;case t.LINE_LOOP:e.lines+=s*i;break;case t.POINTS:e.points+=s*i}}}}function Bs(t,e){return t[0]-e[0]}function zs(t,e){return Math.abs(e[1])-Math.abs(t[1])}function Us(t,e,i){const n={},s=new Float32Array(8),r=new WeakMap,a=new Ce,o=[];for(let t=0;t<8;t++)o[t]=[t,0];return{update:function(h,l,c){const u=h.morphTargetInfluences;if(!0===e.isWebGL2){const d=l.morphAttributes.position||l.morphAttributes.normal||l.morphAttributes.color,p=void 0!==d?d.length:0;let m=r.get(l);if(void 0===m||m.count!==p){void 0!==m&&m.texture.dispose();const v=void 0!==l.morphAttributes.position,y=void 0!==l.morphAttributes.normal,x=void 0!==l.morphAttributes.color,b=l.morphAttributes.position||[],_=l.morphAttributes.normal||[],w=l.morphAttributes.color||[];let M=0;!0===v&&(M=1),!0===y&&(M=2),!0===x&&(M=3);let S=l.attributes.position.count*M,E=1;S>e.maxTextureSize&&(E=Math.ceil(S/e.maxTextureSize),S=e.maxTextureSize);const T=new Float32Array(S*E*4*p),A=new ke(T,S,E,p);A.type=ot,A.needsUpdate=!0;const C=4*M;for(let R=0;R<p;R++){const k=b[R],P=_[R],D=w[R],L=S*E*4*R;for(let O=0;O<k.count;O++){const N=O*C;!0===v&&(a.fromBufferAttribute(k,O),T[L+N+0]=a.x,T[L+N+1]=a.y,T[L+N+2]=a.z,T[L+N+3]=0),!0===y&&(a.fromBufferAttribute(P,O),T[L+N+4]=a.x,T[L+N+5]=a.y,T[L+N+6]=a.z,T[L+N+7]=0),!0===x&&(a.fromBufferAttribute(D,O),T[L+N+8]=a.x,T[L+N+9]=a.y,T[L+N+10]=a.z,T[L+N+11]=4===D.itemSize?a.w:1)}}function I(){A.dispose(),r.delete(l),l.removeEventListener("dispose",I)}m={count:p,texture:A,size:new se(S,E)},r.set(l,m),l.addEventListener("dispose",I)}let f=0;for(let B=0;B<u.length;B++)f+=u[B];const g=l.morphTargetsRelative?1:1-f;c.getUniforms().setValue(t,"morphTargetBaseInfluence",g),c.getUniforms().setValue(t,"morphTargetInfluences",u),c.getUniforms().setValue(t,"morphTargetsTexture",m.texture,i),c.getUniforms().setValue(t,"morphTargetsTextureSize",m.size)}else{const z=void 0===u?0:u.length;let U=n[l.id];if(void 0===U||U.length!==z){U=[];for(let j=0;j<z;j++)U[j]=[j,0];n[l.id]=U}for(let W=0;W<z;W++){const X=U[W];X[0]=W,X[1]=u[W]}U.sort(zs);for(let q=0;q<8;q++)q<z&&U[q][1]?(o[q][0]=U[q][0],o[q][1]=U[q][1]):(o[q][0]=Number.MAX_SAFE_INTEGER,o[q][1]=0);o.sort(Bs);const F=l.morphAttributes.position,G=l.morphAttributes.normal;let V=0;for(let Y=0;Y<8;Y++){const J=o[Y],$=J[0],K=J[1];$!==Number.MAX_SAFE_INTEGER&&K?(F&&l.getAttribute("morphTarget"+Y)!==F[$]&&l.setAttribute("morphTarget"+Y,F[$]),G&&l.getAttribute("morphNormal"+Y)!==G[$]&&l.setAttribute("morphNormal"+Y,G[$]),s[Y]=K,V+=K):(F&&!0===l.hasAttribute("morphTarget"+Y)&&l.deleteAttribute("morphTarget"+Y),G&&!0===l.hasAttribute("morphNormal"+Y)&&l.deleteAttribute("morphNormal"+Y),s[Y]=0)}const H=l.morphTargetsRelative?1:1-V;c.getUniforms().setValue(t,"morphTargetBaseInfluence",H),c.getUniforms().setValue(t,"morphTargetInfluences",s)}}}}function Fs(t,e,i,n){let s=new WeakMap;function r(t){const e=t.target;e.removeEventListener("dispose",r),i.remove(e.instanceMatrix),null!==e.instanceColor&&i.remove(e.instanceColor)}return{update:function(a){const o=n.render.frame,h=a.geometry,l=e.get(a,h);if(s.get(l)!==o&&(e.update(l),s.set(l,o)),a.isInstancedMesh&&(!1===a.hasEventListener("dispose",r)&&a.addEventListener("dispose",r),s.get(a)!==o&&(i.update(a.instanceMatrix,t.ARRAY_BUFFER),null!==a.instanceColor&&i.update(a.instanceColor,t.ARRAY_BUFFER),s.set(a,o))),a.isSkinnedMesh){const t=a.skeleton;s.get(t)!==o&&(t.update(),s.set(t,o))}return l},dispose:function(){s=new WeakMap}}}class Gs extends Ae{constructor(t,e,i,n,s,r,a,o,h,l){if((l=void 0!==l?l:ut)!==ut&&l!==dt)throw new Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");void 0===i&&l===ut&&(i=at),void 0===i&&l===dt&&(i=lt),super(null,n,s,r,a,o,l,i,h),this.isDepthTexture=!0,this.image={width:t,height:e},this.magFilter=void 0!==a?a:K,this.minFilter=void 0!==o?o:K,this.flipY=!1,this.generateMipmaps=!1,this.compareFunction=null}copy(t){return super.copy(t),this.compareFunction=t.compareFunction,this}toJSON(t){const e=super.toJSON(t);return null!==this.compareFunction&&(e.compareFunction=this.compareFunction),e}}const Vs=new Ae,Hs=new Gs(1,1);Hs.compareFunction=515;const js=new ke,Ws=new Pe,Xs=new qn,qs=[],Ys=[],Js=new Float32Array(16),$s=new Float32Array(9),Ks=new Float32Array(4);function Zs(t,e,i){const n=t[0];if(n<=0||n>0)return t;const s=e*i;let r=qs[s];if(void 0===r&&(r=new Float32Array(s),qs[s]=r),0!==e){n.toArray(r,0);for(let n=1,s=0;n!==e;++n)s+=i,t[n].toArray(r,s)}return r}function Qs(t,e){if(t.length!==e.length)return!1;for(let i=0,n=t.length;i<n;i++)if(t[i]!==e[i])return!1;return!0}function tr(t,e){for(let i=0,n=e.length;i<n;i++)t[i]=e[i]}function er(t,e){let i=Ys[e];void 0===i&&(i=new Int32Array(e),Ys[e]=i);for(let n=0;n!==e;++n)i[n]=t.allocateTextureUnit();return i}function ir(t,e){const i=this.cache;i[0]!==e&&(t.uniform1f(this.addr,e),i[0]=e)}function nr(t,e){const i=this.cache;if(void 0!==e.x)i[0]===e.x&&i[1]===e.y||(t.uniform2f(this.addr,e.x,e.y),i[0]=e.x,i[1]=e.y);else{if(Qs(i,e))return;t.uniform2fv(this.addr,e),tr(i,e)}}function sr(t,e){const i=this.cache;if(void 0!==e.x)i[0]===e.x&&i[1]===e.y&&i[2]===e.z||(t.uniform3f(this.addr,e.x,e.y,e.z),i[0]=e.x,i[1]=e.y,i[2]=e.z);else if(void 0!==e.r)i[0]===e.r&&i[1]===e.g&&i[2]===e.b||(t.uniform3f(this.addr,e.r,e.g,e.b),i[0]=e.r,i[1]=e.g,i[2]=e.b);else{if(Qs(i,e))return;t.uniform3fv(this.addr,e),tr(i,e)}}function rr(t,e){const i=this.cache;if(void 0!==e.x)i[0]===e.x&&i[1]===e.y&&i[2]===e.z&&i[3]===e.w||(t.uniform4f(this.addr,e.x,e.y,e.z,e.w),i[0]=e.x,i[1]=e.y,i[2]=e.z,i[3]=e.w);else{if(Qs(i,e))return;t.uniform4fv(this.addr,e),tr(i,e)}}function ar(t,e){const i=this.cache,n=e.elements;if(void 0===n){if(Qs(i,e))return;t.uniformMatrix2fv(this.addr,!1,e),tr(i,e)}else{if(Qs(i,n))return;Ks.set(n),t.uniformMatrix2fv(this.addr,!1,Ks),tr(i,n)}}function or(t,e){const i=this.cache,n=e.elements;if(void 0===n){if(Qs(i,e))return;t.uniformMatrix3fv(this.addr,!1,e),tr(i,e)}else{if(Qs(i,n))return;$s.set(n),t.uniformMatrix3fv(this.addr,!1,$s),tr(i,n)}}function hr(t,e){const i=this.cache,n=e.elements;if(void 0===n){if(Qs(i,e))return;t.uniformMatrix4fv(this.addr,!1,e),tr(i,e)}else{if(Qs(i,n))return;Js.set(n),t.uniformMatrix4fv(this.addr,!1,Js),tr(i,n)}}function lr(t,e){const i=this.cache;i[0]!==e&&(t.uniform1i(this.addr,e),i[0]=e)}function cr(t,e){const i=this.cache;if(void 0!==e.x)i[0]===e.x&&i[1]===e.y||(t.uniform2i(this.addr,e.x,e.y),i[0]=e.x,i[1]=e.y);else{if(Qs(i,e))return;t.uniform2iv(this.addr,e),tr(i,e)}}function ur(t,e){const i=this.cache;if(void 0!==e.x)i[0]===e.x&&i[1]===e.y&&i[2]===e.z||(t.uniform3i(this.addr,e.x,e.y,e.z),i[0]=e.x,i[1]=e.y,i[2]=e.z);else{if(Qs(i,e))return;t.uniform3iv(this.addr,e),tr(i,e)}}function dr(t,e){const i=this.cache;if(void 0!==e.x)i[0]===e.x&&i[1]===e.y&&i[2]===e.z&&i[3]===e.w||(t.uniform4i(this.addr,e.x,e.y,e.z,e.w),i[0]=e.x,i[1]=e.y,i[2]=e.z,i[3]=e.w);else{if(Qs(i,e))return;t.uniform4iv(this.addr,e),tr(i,e)}}function pr(t,e){const i=this.cache;i[0]!==e&&(t.uniform1ui(this.addr,e),i[0]=e)}function mr(t,e){const i=this.cache;if(void 0!==e.x)i[0]===e.x&&i[1]===e.y||(t.uniform2ui(this.addr,e.x,e.y),i[0]=e.x,i[1]=e.y);else{if(Qs(i,e))return;t.uniform2uiv(this.addr,e),tr(i,e)}}function fr(t,e){const i=this.cache;if(void 0!==e.x)i[0]===e.x&&i[1]===e.y&&i[2]===e.z||(t.uniform3ui(this.addr,e.x,e.y,e.z),i[0]=e.x,i[1]=e.y,i[2]=e.z);else{if(Qs(i,e))return;t.uniform3uiv(this.addr,e),tr(i,e)}}function gr(t,e){const i=this.cache;if(void 0!==e.x)i[0]===e.x&&i[1]===e.y&&i[2]===e.z&&i[3]===e.w||(t.uniform4ui(this.addr,e.x,e.y,e.z,e.w),i[0]=e.x,i[1]=e.y,i[2]=e.z,i[3]=e.w);else{if(Qs(i,e))return;t.uniform4uiv(this.addr,e),tr(i,e)}}function vr(t,e,i){const n=this.cache,s=i.allocateTextureUnit();n[0]!==s&&(t.uniform1i(this.addr,s),n[0]=s);const r=this.type===t.SAMPLER_2D_SHADOW?Hs:Vs;i.setTexture2D(e||r,s)}function yr(t,e,i){const n=this.cache,s=i.allocateTextureUnit();n[0]!==s&&(t.uniform1i(this.addr,s),n[0]=s),i.setTexture3D(e||Ws,s)}function xr(t,e,i){const n=this.cache,s=i.allocateTextureUnit();n[0]!==s&&(t.uniform1i(this.addr,s),n[0]=s),i.setTextureCube(e||Xs,s)}function br(t,e,i){const n=this.cache,s=i.allocateTextureUnit();n[0]!==s&&(t.uniform1i(this.addr,s),n[0]=s),i.setTexture2DArray(e||js,s)}function _r(t,e){t.uniform1fv(this.addr,e)}function wr(t,e){const i=Zs(e,this.size,2);t.uniform2fv(this.addr,i)}function Mr(t,e){const i=Zs(e,this.size,3);t.uniform3fv(this.addr,i)}function Sr(t,e){const i=Zs(e,this.size,4);t.uniform4fv(this.addr,i)}function Er(t,e){const i=Zs(e,this.size,4);t.uniformMatrix2fv(this.addr,!1,i)}function Tr(t,e){const i=Zs(e,this.size,9);t.uniformMatrix3fv(this.addr,!1,i)}function Ar(t,e){const i=Zs(e,this.size,16);t.uniformMatrix4fv(this.addr,!1,i)}function Cr(t,e){t.uniform1iv(this.addr,e)}function Ir(t,e){t.uniform2iv(this.addr,e)}function Rr(t,e){t.uniform3iv(this.addr,e)}function kr(t,e){t.uniform4iv(this.addr,e)}function Pr(t,e){t.uniform1uiv(this.addr,e)}function Dr(t,e){t.uniform2uiv(this.addr,e)}function Lr(t,e){t.uniform3uiv(this.addr,e)}function Or(t,e){t.uniform4uiv(this.addr,e)}function Nr(t,e,i){const n=this.cache,s=e.length,r=er(i,s);Qs(n,r)||(t.uniform1iv(this.addr,r),tr(n,r));for(let t=0;t!==s;++t)i.setTexture2D(e[t]||Vs,r[t])}function Br(t,e,i){const n=this.cache,s=e.length,r=er(i,s);Qs(n,r)||(t.uniform1iv(this.addr,r),tr(n,r));for(let t=0;t!==s;++t)i.setTexture3D(e[t]||Ws,r[t])}function zr(t,e,i){const n=this.cache,s=e.length,r=er(i,s);Qs(n,r)||(t.uniform1iv(this.addr,r),tr(n,r));for(let t=0;t!==s;++t)i.setTextureCube(e[t]||Xs,r[t])}function Ur(t,e,i){const n=this.cache,s=e.length,r=er(i,s);Qs(n,r)||(t.uniform1iv(this.addr,r),tr(n,r));for(let t=0;t!==s;++t)i.setTexture2DArray(e[t]||js,r[t])}class Fr{constructor(t,e,i){this.id=t,this.addr=i,this.cache=[],this.type=e.type,this.setValue=function(t){switch(t){case 5126:return ir;case 35664:return nr;case 35665:return sr;case 35666:return rr;case 35674:return ar;case 35675:return or;case 35676:return hr;case 5124:case 35670:return lr;case 35667:case 35671:return cr;case 35668:case 35672:return ur;case 35669:case 35673:return dr;case 5125:return pr;case 36294:return mr;case 36295:return fr;case 36296:return gr;case 35678:case 36198:case 36298:case 36306:case 35682:return vr;case 35679:case 36299:case 36307:return yr;case 35680:case 36300:case 36308:case 36293:return xr;case 36289:case 36303:case 36311:case 36292:return br}}(e.type)}}class Gr{constructor(t,e,i){this.id=t,this.addr=i,this.cache=[],this.type=e.type,this.size=e.size,this.setValue=function(t){switch(t){case 5126:return _r;case 35664:return wr;case 35665:return Mr;case 35666:return Sr;case 35674:return Er;case 35675:return Tr;case 35676:return Ar;case 5124:case 35670:return Cr;case 35667:case 35671:return Ir;case 35668:case 35672:return Rr;case 35669:case 35673:return kr;case 5125:return Pr;case 36294:return Dr;case 36295:return Lr;case 36296:return Or;case 35678:case 36198:case 36298:case 36306:case 35682:return Nr;case 35679:case 36299:case 36307:return Br;case 35680:case 36300:case 36308:case 36293:return zr;case 36289:case 36303:case 36311:case 36292:return Ur}}(e.type)}}class Vr{constructor(t){this.id=t,this.seq=[],this.map={}}setValue(t,e,i){const n=this.seq;for(let s=0,r=n.length;s!==r;++s){const r=n[s];r.setValue(t,e[r.id],i)}}}const Hr=/(\w+)(\])?(\[|\.)?/g;function jr(t,e){t.seq.push(e),t.map[e.id]=e}function Wr(t,e,i){const n=t.name,s=n.length;for(Hr.lastIndex=0;;){const r=Hr.exec(n),a=Hr.lastIndex;let o=r[1];const h="]"===r[2],l=r[3];if(h&&(o|=0),void 0===l||"["===l&&a+2===s){jr(i,void 0===l?new Fr(o,t,e):new Gr(o,t,e));break}{let t=i.map[o];void 0===t&&(t=new Vr(o),jr(i,t)),i=t}}}class Xr{constructor(t,e){this.seq=[],this.map={};const i=t.getProgramParameter(e,t.ACTIVE_UNIFORMS);for(let n=0;n<i;++n){const i=t.getActiveUniform(e,n);Wr(i,t.getUniformLocation(e,i.name),this)}}setValue(t,e,i,n){const s=this.map[e];void 0!==s&&s.setValue(t,i,n)}setOptional(t,e,i){const n=e[i];void 0!==n&&this.setValue(t,i,n)}static upload(t,e,i,n){for(let s=0,r=e.length;s!==r;++s){const r=e[s],a=i[r.id];!1!==a.needsUpdate&&r.setValue(t,a.value,n)}}static seqWithValue(t,e){const i=[];for(let n=0,s=t.length;n!==s;++n){const s=t[n];s.id in e&&i.push(s)}return i}}function qr(t,e,i){const n=t.createShader(e);return t.shaderSource(n,i),t.compileShader(n),n}const Yr=37297;let Jr=0;function $r(t,e,i){const n=t.getShaderParameter(e,t.COMPILE_STATUS),s=t.getShaderInfoLog(e).trim();if(n&&""===s)return"";const r=/ERROR: 0:(\d+)/.exec(s);if(r){const n=parseInt(r[1]);return i.toUpperCase()+"\n\n"+s+"\n\n"+function(t,e){const i=t.split("\n"),n=[],s=Math.max(e-6,0),r=Math.min(e+6,i.length);for(let t=s;t<r;t++){const s=t+1;n.push(`${s===e?">":" "} ${s}: ${i[t]}`)}return n.join("\n")}(t.getShaderSource(e),n)}return s}function Kr(t,e){const i=function(t){const e=ye.getPrimaries(ye.workingColorSpace),i=ye.getPrimaries(t);let n;switch(e===i?n="":e===Nt&&i===Ot?n="LinearDisplayP3ToLinearSRGB":e===Ot&&i===Nt&&(n="LinearSRGBToLinearDisplayP3"),t){case Rt:case Pt:return[n,"LinearTransferOETF"];case It:case kt:return[n,"sRGBTransferOETF"];default:return[n,"LinearTransferOETF"]}}(e);return`vec4 ${t}( vec4 value ) { return ${i[0]}( ${i[1]}( value ) ); }`}function Zr(t,e){let i;switch(e){case N:i="Linear";break;case B:i="Reinhard";break;case z:i="OptimizedCineon";break;case U:i="ACESFilmic";break;case G:i="AgX";break;case F:i="Custom";break;default:i="Linear"}return"vec3 "+t+"( vec3 color ) { return "+i+"ToneMapping( color ); }"}function Qr(t){return""!==t}function ta(t,e){const i=e.numSpotLightShadows+e.numSpotLightMaps-e.numSpotLightShadowsWithMaps;return t.replace(/NUM_DIR_LIGHTS/g,e.numDirLights).replace(/NUM_SPOT_LIGHTS/g,e.numSpotLights).replace(/NUM_SPOT_LIGHT_MAPS/g,e.numSpotLightMaps).replace(/NUM_SPOT_LIGHT_COORDS/g,i).replace(/NUM_RECT_AREA_LIGHTS/g,e.numRectAreaLights).replace(/NUM_POINT_LIGHTS/g,e.numPointLights).replace(/NUM_HEMI_LIGHTS/g,e.numHemiLights).replace(/NUM_DIR_LIGHT_SHADOWS/g,e.numDirLightShadows).replace(/NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS/g,e.numSpotLightShadowsWithMaps).replace(/NUM_SPOT_LIGHT_SHADOWS/g,e.numSpotLightShadows).replace(/NUM_POINT_LIGHT_SHADOWS/g,e.numPointLightShadows)}function ea(t,e){return t.replace(/NUM_CLIPPING_PLANES/g,e.numClippingPlanes).replace(/UNION_CLIPPING_PLANES/g,e.numClippingPlanes-e.numClipIntersection)}const ia=/^[ \t]*#include +<([\w\d./]+)>/gm;function na(t){return t.replace(ia,ra)}const sa=new Map([["encodings_fragment","colorspace_fragment"],["encodings_pars_fragment","colorspace_pars_fragment"],["output_fragment","opaque_fragment"]]);function ra(t,e){let i=rs[e];if(void 0===i){const t=sa.get(e);if(void 0===t)throw new Error("Can not resolve #include <"+e+">");i=rs[t]}return na(i)}const aa=/#pragma unroll_loop_start\s+for\s*\(\s*int\s+i\s*=\s*(\d+)\s*;\s*i\s*<\s*(\d+)\s*;\s*i\s*\+\+\s*\)\s*{([\s\S]+?)}\s+#pragma unroll_loop_end/g;function oa(t){return t.replace(aa,ha)}function ha(t,e,i,n){let s="";for(let t=parseInt(e);t<parseInt(i);t++)s+=n.replace(/\[\s*i\s*\]/g,"[ "+t+" ]").replace(/UNROLLED_LOOP_INDEX/g,t);return s}function la(t){let e="precision "+t.precision+" float;\nprecision "+t.precision+" int;";return"highp"===t.precision?e+="\n#define HIGH_PRECISION":"mediump"===t.precision?e+="\n#define MEDIUM_PRECISION":"lowp"===t.precision&&(e+="\n#define LOW_PRECISION"),e}function ca(t,e,i,n){const s=t.getContext(),r=i.defines;let a=i.vertexShader,o=i.fragmentShader;const h=function(t){let e="SHADOWMAP_TYPE_BASIC";return t.shadowMapType===T?e="SHADOWMAP_TYPE_PCF":t.shadowMapType===A?e="SHADOWMAP_TYPE_PCF_SOFT":t.shadowMapType===C&&(e="SHADOWMAP_TYPE_VSM"),e}(i),l=function(t){let e="ENVMAP_TYPE_CUBE";if(t.envMap)switch(t.envMapMode){case H:case j:e="ENVMAP_TYPE_CUBE";break;case q:e="ENVMAP_TYPE_CUBE_UV"}return e}(i),c=function(t){let e="ENVMAP_MODE_REFLECTION";t.envMap&&t.envMapMode===j&&(e="ENVMAP_MODE_REFRACTION");return e}(i),u=function(t){let e="ENVMAP_BLENDING_NONE";if(t.envMap)switch(t.combine){case P:e="ENVMAP_BLENDING_MULTIPLY";break;case D:e="ENVMAP_BLENDING_MIX";break;case L:e="ENVMAP_BLENDING_ADD"}return e}(i),d=function(t){const e=t.envMapCubeUVHeight;if(null===e)return null;const i=Math.log2(e)-2,n=1/e;return{texelWidth:1/(3*Math.max(Math.pow(2,i),112)),texelHeight:n,maxMip:i}}(i),p=i.isWebGL2?"":function(t){return[t.extensionDerivatives||t.envMapCubeUVHeight||t.bumpMap||t.normalMapTangentSpace||t.clearcoatNormalMap||t.flatShading||"physical"===t.shaderID?"#extension GL_OES_standard_derivatives : enable":"",(t.extensionFragDepth||t.logarithmicDepthBuffer)&&t.rendererExtensionFragDepth?"#extension GL_EXT_frag_depth : enable":"",t.extensionDrawBuffers&&t.rendererExtensionDrawBuffers?"#extension GL_EXT_draw_buffers : require":"",(t.extensionShaderTextureLOD||t.envMap||t.transmission)&&t.rendererExtensionShaderTextureLod?"#extension GL_EXT_shader_texture_lod : enable":""].filter(Qr).join("\n")}(i),m=function(t){return[t.extensionClipCullDistance?"#extension GL_ANGLE_clip_cull_distance : require":""].filter(Qr).join("\n")}(i),f=function(t){const e=[];for(const i in t){const n=t[i];!1!==n&&e.push("#define "+i+" "+n)}return e.join("\n")}(r),g=s.createProgram();let v,y,x=i.glslVersion?"#version "+i.glslVersion+"\n":"";i.isRawShaderMaterial?(v=["#define SHADER_TYPE "+i.shaderType,"#define SHADER_NAME "+i.shaderName,f].filter(Qr).join("\n"),v.length>0&&(v+="\n"),y=[p,"#define SHADER_TYPE "+i.shaderType,"#define SHADER_NAME "+i.shaderName,f].filter(Qr).join("\n"),y.length>0&&(y+="\n")):(v=[la(i),"#define SHADER_TYPE "+i.shaderType,"#define SHADER_NAME "+i.shaderName,f,i.extensionClipCullDistance?"#define USE_CLIP_DISTANCE":"",i.batching?"#define USE_BATCHING":"",i.instancing?"#define USE_INSTANCING":"",i.instancingColor?"#define USE_INSTANCING_COLOR":"",i.useFog&&i.fog?"#define USE_FOG":"",i.useFog&&i.fogExp2?"#define FOG_EXP2":"",i.map?"#define USE_MAP":"",i.envMap?"#define USE_ENVMAP":"",i.envMap?"#define "+c:"",i.lightMap?"#define USE_LIGHTMAP":"",i.aoMap?"#define USE_AOMAP":"",i.bumpMap?"#define USE_BUMPMAP":"",i.normalMap?"#define USE_NORMALMAP":"",i.normalMapObjectSpace?"#define USE_NORMALMAP_OBJECTSPACE":"",i.normalMapTangentSpace?"#define USE_NORMALMAP_TANGENTSPACE":"",i.displacementMap?"#define USE_DISPLACEMENTMAP":"",i.emissiveMap?"#define USE_EMISSIVEMAP":"",i.anisotropy?"#define USE_ANISOTROPY":"",i.anisotropyMap?"#define USE_ANISOTROPYMAP":"",i.clearcoatMap?"#define USE_CLEARCOATMAP":"",i.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",i.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",i.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",i.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",i.specularMap?"#define USE_SPECULARMAP":"",i.specularColorMap?"#define USE_SPECULAR_COLORMAP":"",i.specularIntensityMap?"#define USE_SPECULAR_INTENSITYMAP":"",i.roughnessMap?"#define USE_ROUGHNESSMAP":"",i.metalnessMap?"#define USE_METALNESSMAP":"",i.alphaMap?"#define USE_ALPHAMAP":"",i.alphaHash?"#define USE_ALPHAHASH":"",i.transmission?"#define USE_TRANSMISSION":"",i.transmissionMap?"#define USE_TRANSMISSIONMAP":"",i.thicknessMap?"#define USE_THICKNESSMAP":"",i.sheenColorMap?"#define USE_SHEEN_COLORMAP":"",i.sheenRoughnessMap?"#define USE_SHEEN_ROUGHNESSMAP":"",i.mapUv?"#define MAP_UV "+i.mapUv:"",i.alphaMapUv?"#define ALPHAMAP_UV "+i.alphaMapUv:"",i.lightMapUv?"#define LIGHTMAP_UV "+i.lightMapUv:"",i.aoMapUv?"#define AOMAP_UV "+i.aoMapUv:"",i.emissiveMapUv?"#define EMISSIVEMAP_UV "+i.emissiveMapUv:"",i.bumpMapUv?"#define BUMPMAP_UV "+i.bumpMapUv:"",i.normalMapUv?"#define NORMALMAP_UV "+i.normalMapUv:"",i.displacementMapUv?"#define DISPLACEMENTMAP_UV "+i.displacementMapUv:"",i.metalnessMapUv?"#define METALNESSMAP_UV "+i.metalnessMapUv:"",i.roughnessMapUv?"#define ROUGHNESSMAP_UV "+i.roughnessMapUv:"",i.anisotropyMapUv?"#define ANISOTROPYMAP_UV "+i.anisotropyMapUv:"",i.clearcoatMapUv?"#define CLEARCOATMAP_UV "+i.clearcoatMapUv:"",i.clearcoatNormalMapUv?"#define CLEARCOAT_NORMALMAP_UV "+i.clearcoatNormalMapUv:"",i.clearcoatRoughnessMapUv?"#define CLEARCOAT_ROUGHNESSMAP_UV "+i.clearcoatRoughnessMapUv:"",i.iridescenceMapUv?"#define IRIDESCENCEMAP_UV "+i.iridescenceMapUv:"",i.iridescenceThicknessMapUv?"#define IRIDESCENCE_THICKNESSMAP_UV "+i.iridescenceThicknessMapUv:"",i.sheenColorMapUv?"#define SHEEN_COLORMAP_UV "+i.sheenColorMapUv:"",i.sheenRoughnessMapUv?"#define SHEEN_ROUGHNESSMAP_UV "+i.sheenRoughnessMapUv:"",i.specularMapUv?"#define SPECULARMAP_UV "+i.specularMapUv:"",i.specularColorMapUv?"#define SPECULAR_COLORMAP_UV "+i.specularColorMapUv:"",i.specularIntensityMapUv?"#define SPECULAR_INTENSITYMAP_UV "+i.specularIntensityMapUv:"",i.transmissionMapUv?"#define TRANSMISSIONMAP_UV "+i.transmissionMapUv:"",i.thicknessMapUv?"#define THICKNESSMAP_UV "+i.thicknessMapUv:"",i.vertexTangents&&!1===i.flatShading?"#define USE_TANGENT":"",i.vertexColors?"#define USE_COLOR":"",i.vertexAlphas?"#define USE_COLOR_ALPHA":"",i.vertexUv1s?"#define USE_UV1":"",i.vertexUv2s?"#define USE_UV2":"",i.vertexUv3s?"#define USE_UV3":"",i.pointsUvs?"#define USE_POINTS_UV":"",i.flatShading?"#define FLAT_SHADED":"",i.skinning?"#define USE_SKINNING":"",i.morphTargets?"#define USE_MORPHTARGETS":"",i.morphNormals&&!1===i.flatShading?"#define USE_MORPHNORMALS":"",i.morphColors&&i.isWebGL2?"#define USE_MORPHCOLORS":"",i.morphTargetsCount>0&&i.isWebGL2?"#define MORPHTARGETS_TEXTURE":"",i.morphTargetsCount>0&&i.isWebGL2?"#define MORPHTARGETS_TEXTURE_STRIDE "+i.morphTextureStride:"",i.morphTargetsCount>0&&i.isWebGL2?"#define MORPHTARGETS_COUNT "+i.morphTargetsCount:"",i.doubleSided?"#define DOUBLE_SIDED":"",i.flipSided?"#define FLIP_SIDED":"",i.shadowMapEnabled?"#define USE_SHADOWMAP":"",i.shadowMapEnabled?"#define "+h:"",i.sizeAttenuation?"#define USE_SIZEATTENUATION":"",i.numLightProbes>0?"#define USE_LIGHT_PROBES":"",i.useLegacyLights?"#define LEGACY_LIGHTS":"",i.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",i.logarithmicDepthBuffer&&i.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;","#ifdef USE_INSTANCING","\tattribute mat4 instanceMatrix;","#endif","#ifdef USE_INSTANCING_COLOR","\tattribute vec3 instanceColor;","#endif","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_UV1","\tattribute vec2 uv1;","#endif","#ifdef USE_UV2","\tattribute vec2 uv2;","#endif","#ifdef USE_UV3","\tattribute vec2 uv3;","#endif","#ifdef USE_TANGENT","\tattribute vec4 tangent;","#endif","#if defined( USE_COLOR_ALPHA )","\tattribute vec4 color;","#elif defined( USE_COLOR )","\tattribute vec3 color;","#endif","#if ( defined( USE_MORPHTARGETS ) && ! defined( MORPHTARGETS_TEXTURE ) )","\tattribute vec3 morphTarget0;","\tattribute vec3 morphTarget1;","\tattribute vec3 morphTarget2;","\tattribute vec3 morphTarget3;","\t#ifdef USE_MORPHNORMALS","\t\tattribute vec3 morphNormal0;","\t\tattribute vec3 morphNormal1;","\t\tattribute vec3 morphNormal2;","\t\tattribute vec3 morphNormal3;","\t#else","\t\tattribute vec3 morphTarget4;","\t\tattribute vec3 morphTarget5;","\t\tattribute vec3 morphTarget6;","\t\tattribute vec3 morphTarget7;","\t#endif","#endif","#ifdef USE_SKINNING","\tattribute vec4 skinIndex;","\tattribute vec4 skinWeight;","#endif","\n"].filter(Qr).join("\n"),y=[p,la(i),"#define SHADER_TYPE "+i.shaderType,"#define SHADER_NAME "+i.shaderName,f,i.useFog&&i.fog?"#define USE_FOG":"",i.useFog&&i.fogExp2?"#define FOG_EXP2":"",i.map?"#define USE_MAP":"",i.matcap?"#define USE_MATCAP":"",i.envMap?"#define USE_ENVMAP":"",i.envMap?"#define "+l:"",i.envMap?"#define "+c:"",i.envMap?"#define "+u:"",d?"#define CUBEUV_TEXEL_WIDTH "+d.texelWidth:"",d?"#define CUBEUV_TEXEL_HEIGHT "+d.texelHeight:"",d?"#define CUBEUV_MAX_MIP "+d.maxMip+".0":"",i.lightMap?"#define USE_LIGHTMAP":"",i.aoMap?"#define USE_AOMAP":"",i.bumpMap?"#define USE_BUMPMAP":"",i.normalMap?"#define USE_NORMALMAP":"",i.normalMapObjectSpace?"#define USE_NORMALMAP_OBJECTSPACE":"",i.normalMapTangentSpace?"#define USE_NORMALMAP_TANGENTSPACE":"",i.emissiveMap?"#define USE_EMISSIVEMAP":"",i.anisotropy?"#define USE_ANISOTROPY":"",i.anisotropyMap?"#define USE_ANISOTROPYMAP":"",i.clearcoat?"#define USE_CLEARCOAT":"",i.clearcoatMap?"#define USE_CLEARCOATMAP":"",i.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",i.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",i.iridescence?"#define USE_IRIDESCENCE":"",i.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",i.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",i.specularMap?"#define USE_SPECULARMAP":"",i.specularColorMap?"#define USE_SPECULAR_COLORMAP":"",i.specularIntensityMap?"#define USE_SPECULAR_INTENSITYMAP":"",i.roughnessMap?"#define USE_ROUGHNESSMAP":"",i.metalnessMap?"#define USE_METALNESSMAP":"",i.alphaMap?"#define USE_ALPHAMAP":"",i.alphaTest?"#define USE_ALPHATEST":"",i.alphaHash?"#define USE_ALPHAHASH":"",i.sheen?"#define USE_SHEEN":"",i.sheenColorMap?"#define USE_SHEEN_COLORMAP":"",i.sheenRoughnessMap?"#define USE_SHEEN_ROUGHNESSMAP":"",i.transmission?"#define USE_TRANSMISSION":"",i.transmissionMap?"#define USE_TRANSMISSIONMAP":"",i.thicknessMap?"#define USE_THICKNESSMAP":"",i.vertexTangents&&!1===i.flatShading?"#define USE_TANGENT":"",i.vertexColors||i.instancingColor?"#define USE_COLOR":"",i.vertexAlphas?"#define USE_COLOR_ALPHA":"",i.vertexUv1s?"#define USE_UV1":"",i.vertexUv2s?"#define USE_UV2":"",i.vertexUv3s?"#define USE_UV3":"",i.pointsUvs?"#define USE_POINTS_UV":"",i.gradientMap?"#define USE_GRADIENTMAP":"",i.flatShading?"#define FLAT_SHADED":"",i.doubleSided?"#define DOUBLE_SIDED":"",i.flipSided?"#define FLIP_SIDED":"",i.shadowMapEnabled?"#define USE_SHADOWMAP":"",i.shadowMapEnabled?"#define "+h:"",i.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",i.numLightProbes>0?"#define USE_LIGHT_PROBES":"",i.useLegacyLights?"#define LEGACY_LIGHTS":"",i.decodeVideoTexture?"#define DECODE_VIDEO_TEXTURE":"",i.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",i.logarithmicDepthBuffer&&i.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;",i.toneMapping!==O?"#define TONE_MAPPING":"",i.toneMapping!==O?rs.tonemapping_pars_fragment:"",i.toneMapping!==O?Zr("toneMapping",i.toneMapping):"",i.dithering?"#define DITHERING":"",i.opaque?"#define OPAQUE":"",rs.colorspace_pars_fragment,Kr("linearToOutputTexel",i.outputColorSpace),i.useDepthPacking?"#define DEPTH_PACKING "+i.depthPacking:"","\n"].filter(Qr).join("\n")),a=na(a),a=ta(a,i),a=ea(a,i),o=na(o),o=ta(o,i),o=ea(o,i),a=oa(a),o=oa(o),i.isWebGL2&&!0!==i.isRawShaderMaterial&&(x="#version 300 es\n",v=[m,"precision mediump sampler2DArray;","#define attribute in","#define varying out","#define texture2D texture"].join("\n")+"\n"+v,y=["precision mediump sampler2DArray;","#define varying in",i.glslVersion===Ft?"":"layout(location = 0) out highp vec4 pc_fragColor;",i.glslVersion===Ft?"":"#define gl_FragColor pc_fragColor","#define gl_FragDepthEXT gl_FragDepth","#define texture2D texture","#define textureCube texture","#define texture2DProj textureProj","#define texture2DLodEXT textureLod","#define texture2DProjLodEXT textureProjLod","#define textureCubeLodEXT textureLod","#define texture2DGradEXT textureGrad","#define texture2DProjGradEXT textureProjGrad","#define textureCubeGradEXT textureGrad"].join("\n")+"\n"+y);const b=x+v+a,_=x+y+o,w=qr(s,s.VERTEX_SHADER,b),M=qr(s,s.FRAGMENT_SHADER,_);function S(e){if(t.debug.checkShaderErrors){const i=s.getProgramInfoLog(g).trim(),n=s.getShaderInfoLog(w).trim(),r=s.getShaderInfoLog(M).trim();let a=!0,o=!0;if(!1===s.getProgramParameter(g,s.LINK_STATUS))if(a=!1,"function"==typeof t.debug.onShaderError)t.debug.onShaderError(s,g,w,M);else{$r(s,w,"vertex"),$r(s,M,"fragment")}else""!==i||""!==n&&""!==r||(o=!1);o&&(e.diagnostics={runnable:a,programLog:i,vertexShader:{log:n,prefix:v},fragmentShader:{log:r,prefix:y}})}s.deleteShader(w),s.deleteShader(M),E=new Xr(s,g),I=function(t,e){const i={},n=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES);for(let s=0;s<n;s++){const n=t.getActiveAttrib(e,s),r=n.name;let a=1;n.type===t.FLOAT_MAT2&&(a=2),n.type===t.FLOAT_MAT3&&(a=3),n.type===t.FLOAT_MAT4&&(a=4),i[r]={type:n.type,location:t.getAttribLocation(e,r),locationSize:a}}return i}(s,g)}let E,I;s.attachShader(g,w),s.attachShader(g,M),void 0!==i.index0AttributeName?s.bindAttribLocation(g,0,i.index0AttributeName):!0===i.morphTargets&&s.bindAttribLocation(g,0,"position"),s.linkProgram(g),this.getUniforms=function(){return void 0===E&&S(this),E},this.getAttributes=function(){return void 0===I&&S(this),I};let R=!1===i.rendererExtensionParallelShaderCompile;return this.isReady=function(){return!1===R&&(R=s.getProgramParameter(g,Yr)),R},this.destroy=function(){n.releaseStatesOfProgram(this),s.deleteProgram(g),this.program=void 0},this.type=i.shaderType,this.name=i.shaderName,this.id=Jr++,this.cacheKey=e,this.usedTimes=1,this.program=g,this.vertexShader=w,this.fragmentShader=M,this}let ua=0;class da{constructor(){this.shaderCache=new Map,this.materialCache=new Map}update(t){const e=t.vertexShader,i=t.fragmentShader,n=this._getShaderStage(e),s=this._getShaderStage(i),r=this._getShaderCacheForMaterial(t);return!1===r.has(n)&&(r.add(n),n.usedTimes++),!1===r.has(s)&&(r.add(s),s.usedTimes++),this}remove(t){const e=this.materialCache.get(t);for(const t of e)t.usedTimes--,0===t.usedTimes&&this.shaderCache.delete(t.code);return this.materialCache.delete(t),this}getVertexShaderID(t){return this._getShaderStage(t.vertexShader).id}getFragmentShaderID(t){return this._getShaderStage(t.fragmentShader).id}dispose(){this.shaderCache.clear(),this.materialCache.clear()}_getShaderCacheForMaterial(t){const e=this.materialCache;let i=e.get(t);return void 0===i&&(i=new Set,e.set(t,i)),i}_getShaderStage(t){const e=this.shaderCache;let i=e.get(t);return void 0===i&&(i=new pa(t),e.set(t,i)),i}}class pa{constructor(t){this.id=ua++,this.code=t,this.usedTimes=0}}function ma(t,e,i,n,s,r,a){const o=new _i,h=new da,l=[],c=s.isWebGL2,u=s.logarithmicDepthBuffer,d=s.vertexTextures;let p=s.precision;const m={MeshDepthMaterial:"depth",MeshDistanceMaterial:"distanceRGBA",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"toon",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",MeshMatcapMaterial:"matcap",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points",ShadowMaterial:"shadow",SpriteMaterial:"sprite"};function f(t){return 0===t?"uv":`uv${t}`}return{getParameters:function(r,o,l,g,v){const y=g.fog,x=v.geometry,b=r.isMeshStandardMaterial?g.environment:null,_=(r.isMeshStandardMaterial?i:e).get(r.envMap||b),w=_&&_.mapping===q?_.image.height:null,M=m[r.type];null!==r.precision&&(p=s.getMaxPrecision(r.precision),r.precision);const S=x.morphAttributes.position||x.morphAttributes.normal||x.morphAttributes.color,E=void 0!==S?S.length:0;let T,A,C,I,k=0;if(void 0!==x.morphAttributes.position&&(k=1),void 0!==x.morphAttributes.normal&&(k=2),void 0!==x.morphAttributes.color&&(k=3),M){const t=os[M];T=t.vertexShader,A=t.fragmentShader}else T=r.vertexShader,A=r.fragmentShader,h.update(r),C=h.getVertexShaderID(r),I=h.getFragmentShaderID(r);const P=t.getRenderTarget(),D=!0===v.isInstancedMesh,L=!0===v.isBatchedMesh,N=!!r.map,B=!!r.matcap,z=!!_,U=!!r.aoMap,F=!!r.lightMap,G=!!r.bumpMap,V=!!r.normalMap,H=!!r.displacementMap,j=!!r.emissiveMap,W=!!r.metalnessMap,X=!!r.roughnessMap,Y=r.anisotropy>0,J=r.clearcoat>0,$=r.iridescence>0,K=r.sheen>0,Z=r.transmission>0,Q=Y&&!!r.anisotropyMap,tt=J&&!!r.clearcoatMap,et=J&&!!r.clearcoatNormalMap,it=J&&!!r.clearcoatRoughnessMap,nt=$&&!!r.iridescenceMap,st=$&&!!r.iridescenceThicknessMap,rt=K&&!!r.sheenColorMap,at=K&&!!r.sheenRoughnessMap,ot=!!r.specularMap,ht=!!r.specularColorMap,lt=!!r.specularIntensityMap,ct=Z&&!!r.transmissionMap,ut=Z&&!!r.thicknessMap,dt=!!r.gradientMap,pt=!!r.alphaMap,mt=r.alphaTest>0,ft=!!r.alphaHash,gt=!!r.extensions,vt=!!x.attributes.uv1,yt=!!x.attributes.uv2,xt=!!x.attributes.uv3;let bt=O;return r.toneMapped&&(null!==P&&!0!==P.isXRRenderTarget||(bt=t.toneMapping)),{isWebGL2:c,shaderID:M,shaderType:r.type,shaderName:r.name,vertexShader:T,fragmentShader:A,defines:r.defines,customVertexShaderID:C,customFragmentShaderID:I,isRawShaderMaterial:!0===r.isRawShaderMaterial,glslVersion:r.glslVersion,precision:p,batching:L,instancing:D,instancingColor:D&&null!==v.instanceColor,supportsVertexTextures:d,outputColorSpace:null===P?t.outputColorSpace:!0===P.isXRRenderTarget?P.texture.colorSpace:Rt,map:N,matcap:B,envMap:z,envMapMode:z&&_.mapping,envMapCubeUVHeight:w,aoMap:U,lightMap:F,bumpMap:G,normalMap:V,displacementMap:d&&H,emissiveMap:j,normalMapObjectSpace:V&&1===r.normalMapType,normalMapTangentSpace:V&&0===r.normalMapType,metalnessMap:W,roughnessMap:X,anisotropy:Y,anisotropyMap:Q,clearcoat:J,clearcoatMap:tt,clearcoatNormalMap:et,clearcoatRoughnessMap:it,iridescence:$,iridescenceMap:nt,iridescenceThicknessMap:st,sheen:K,sheenColorMap:rt,sheenRoughnessMap:at,specularMap:ot,specularColorMap:ht,specularIntensityMap:lt,transmission:Z,transmissionMap:ct,thicknessMap:ut,gradientMap:dt,opaque:!1===r.transparent&&1===r.blending,alphaMap:pt,alphaTest:mt,alphaHash:ft,combine:r.combine,mapUv:N&&f(r.map.channel),aoMapUv:U&&f(r.aoMap.channel),lightMapUv:F&&f(r.lightMap.channel),bumpMapUv:G&&f(r.bumpMap.channel),normalMapUv:V&&f(r.normalMap.channel),displacementMapUv:H&&f(r.displacementMap.channel),emissiveMapUv:j&&f(r.emissiveMap.channel),metalnessMapUv:W&&f(r.metalnessMap.channel),roughnessMapUv:X&&f(r.roughnessMap.channel),anisotropyMapUv:Q&&f(r.anisotropyMap.channel),clearcoatMapUv:tt&&f(r.clearcoatMap.channel),clearcoatNormalMapUv:et&&f(r.clearcoatNormalMap.channel),clearcoatRoughnessMapUv:it&&f(r.clearcoatRoughnessMap.channel),iridescenceMapUv:nt&&f(r.iridescenceMap.channel),iridescenceThicknessMapUv:st&&f(r.iridescenceThicknessMap.channel),sheenColorMapUv:rt&&f(r.sheenColorMap.channel),sheenRoughnessMapUv:at&&f(r.sheenRoughnessMap.channel),specularMapUv:ot&&f(r.specularMap.channel),specularColorMapUv:ht&&f(r.specularColorMap.channel),specularIntensityMapUv:lt&&f(r.specularIntensityMap.channel),transmissionMapUv:ct&&f(r.transmissionMap.channel),thicknessMapUv:ut&&f(r.thicknessMap.channel),alphaMapUv:pt&&f(r.alphaMap.channel),vertexTangents:!!x.attributes.tangent&&(V||Y),vertexColors:r.vertexColors,vertexAlphas:!0===r.vertexColors&&!!x.attributes.color&&4===x.attributes.color.itemSize,vertexUv1s:vt,vertexUv2s:yt,vertexUv3s:xt,pointsUvs:!0===v.isPoints&&!!x.attributes.uv&&(N||pt),fog:!!y,useFog:!0===r.fog,fogExp2:y&&y.isFogExp2,flatShading:!0===r.flatShading,sizeAttenuation:!0===r.sizeAttenuation,logarithmicDepthBuffer:u,skinning:!0===v.isSkinnedMesh,morphTargets:void 0!==x.morphAttributes.position,morphNormals:void 0!==x.morphAttributes.normal,morphColors:void 0!==x.morphAttributes.color,morphTargetsCount:E,morphTextureStride:k,numDirLights:o.directional.length,numPointLights:o.point.length,numSpotLights:o.spot.length,numSpotLightMaps:o.spotLightMap.length,numRectAreaLights:o.rectArea.length,numHemiLights:o.hemi.length,numDirLightShadows:o.directionalShadowMap.length,numPointLightShadows:o.pointShadowMap.length,numSpotLightShadows:o.spotShadowMap.length,numSpotLightShadowsWithMaps:o.numSpotLightShadowsWithMaps,numLightProbes:o.numLightProbes,numClippingPlanes:a.numPlanes,numClipIntersection:a.numIntersection,dithering:r.dithering,shadowMapEnabled:t.shadowMap.enabled&&l.length>0,shadowMapType:t.shadowMap.type,toneMapping:bt,useLegacyLights:t._useLegacyLights,decodeVideoTexture:N&&!0===r.map.isVideoTexture&&ye.getTransfer(r.map.colorSpace)===Lt,premultipliedAlpha:r.premultipliedAlpha,doubleSided:2===r.side,flipSided:r.side===R,useDepthPacking:r.depthPacking>=0,depthPacking:r.depthPacking||0,index0AttributeName:r.index0AttributeName,extensionDerivatives:gt&&!0===r.extensions.derivatives,extensionFragDepth:gt&&!0===r.extensions.fragDepth,extensionDrawBuffers:gt&&!0===r.extensions.drawBuffers,extensionShaderTextureLOD:gt&&!0===r.extensions.shaderTextureLOD,extensionClipCullDistance:gt&&r.extensions.clipCullDistance&&n.has("WEBGL_clip_cull_distance"),rendererExtensionFragDepth:c||n.has("EXT_frag_depth"),rendererExtensionDrawBuffers:c||n.has("WEBGL_draw_buffers"),rendererExtensionShaderTextureLod:c||n.has("EXT_shader_texture_lod"),rendererExtensionParallelShaderCompile:n.has("KHR_parallel_shader_compile"),customProgramCacheKey:r.customProgramCacheKey()}},getProgramCacheKey:function(e){const i=[];if(e.shaderID?i.push(e.shaderID):(i.push(e.customVertexShaderID),i.push(e.customFragmentShaderID)),void 0!==e.defines)for(const t in e.defines)i.push(t),i.push(e.defines[t]);return!1===e.isRawShaderMaterial&&(!function(t,e){t.push(e.precision),t.push(e.outputColorSpace),t.push(e.envMapMode),t.push(e.envMapCubeUVHeight),t.push(e.mapUv),t.push(e.alphaMapUv),t.push(e.lightMapUv),t.push(e.aoMapUv),t.push(e.bumpMapUv),t.push(e.normalMapUv),t.push(e.displacementMapUv),t.push(e.emissiveMapUv),t.push(e.metalnessMapUv),t.push(e.roughnessMapUv),t.push(e.anisotropyMapUv),t.push(e.clearcoatMapUv),t.push(e.clearcoatNormalMapUv),t.push(e.clearcoatRoughnessMapUv),t.push(e.iridescenceMapUv),t.push(e.iridescenceThicknessMapUv),t.push(e.sheenColorMapUv),t.push(e.sheenRoughnessMapUv),t.push(e.specularMapUv),t.push(e.specularColorMapUv),t.push(e.specularIntensityMapUv),t.push(e.transmissionMapUv),t.push(e.thicknessMapUv),t.push(e.combine),t.push(e.fogExp2),t.push(e.sizeAttenuation),t.push(e.morphTargetsCount),t.push(e.morphAttributeCount),t.push(e.numDirLights),t.push(e.numPointLights),t.push(e.numSpotLights),t.push(e.numSpotLightMaps),t.push(e.numHemiLights),t.push(e.numRectAreaLights),t.push(e.numDirLightShadows),t.push(e.numPointLightShadows),t.push(e.numSpotLightShadows),t.push(e.numSpotLightShadowsWithMaps),t.push(e.numLightProbes),t.push(e.shadowMapType),t.push(e.toneMapping),t.push(e.numClippingPlanes),t.push(e.numClipIntersection),t.push(e.depthPacking)}(i,e),function(t,e){o.disableAll(),e.isWebGL2&&o.enable(0);e.supportsVertexTextures&&o.enable(1);e.instancing&&o.enable(2);e.instancingColor&&o.enable(3);e.matcap&&o.enable(4);e.envMap&&o.enable(5);e.normalMapObjectSpace&&o.enable(6);e.normalMapTangentSpace&&o.enable(7);e.clearcoat&&o.enable(8);e.iridescence&&o.enable(9);e.alphaTest&&o.enable(10);e.vertexColors&&o.enable(11);e.vertexAlphas&&o.enable(12);e.vertexUv1s&&o.enable(13);e.vertexUv2s&&o.enable(14);e.vertexUv3s&&o.enable(15);e.vertexTangents&&o.enable(16);e.anisotropy&&o.enable(17);e.alphaHash&&o.enable(18);e.batching&&o.enable(19);t.push(o.mask),o.disableAll(),e.fog&&o.enable(0);e.useFog&&o.enable(1);e.flatShading&&o.enable(2);e.logarithmicDepthBuffer&&o.enable(3);e.skinning&&o.enable(4);e.morphTargets&&o.enable(5);e.morphNormals&&o.enable(6);e.morphColors&&o.enable(7);e.premultipliedAlpha&&o.enable(8);e.shadowMapEnabled&&o.enable(9);e.useLegacyLights&&o.enable(10);e.doubleSided&&o.enable(11);e.flipSided&&o.enable(12);e.useDepthPacking&&o.enable(13);e.dithering&&o.enable(14);e.transmission&&o.enable(15);e.sheen&&o.enable(16);e.opaque&&o.enable(17);e.pointsUvs&&o.enable(18);e.decodeVideoTexture&&o.enable(19);t.push(o.mask)}(i,e),i.push(t.outputColorSpace)),i.push(e.customProgramCacheKey),i.join()},getUniforms:function(t){const e=m[t.type];let i;if(e){const t=os[e];i=Gn.clone(t.uniforms)}else i=t.uniforms;return i},acquireProgram:function(e,i){let n;for(let t=0,e=l.length;t<e;t++){const e=l[t];if(e.cacheKey===i){n=e,++n.usedTimes;break}}return void 0===n&&(n=new ca(t,i,e,r),l.push(n)),n},releaseProgram:function(t){if(0==--t.usedTimes){const e=l.indexOf(t);l[e]=l[l.length-1],l.pop(),t.destroy()}},releaseShaderCache:function(t){h.remove(t)},programs:l,dispose:function(){h.dispose()}}}function fa(){let t=new WeakMap;return{get:function(e){let i=t.get(e);return void 0===i&&(i={},t.set(e,i)),i},remove:function(e){t.delete(e)},update:function(e,i,n){t.get(e)[i]=n},dispose:function(){t=new WeakMap}}}function ga(t,e){return t.groupOrder!==e.groupOrder?t.groupOrder-e.groupOrder:t.renderOrder!==e.renderOrder?t.renderOrder-e.renderOrder:t.material.id!==e.material.id?t.material.id-e.material.id:t.z!==e.z?t.z-e.z:t.id-e.id}function va(t,e){return t.groupOrder!==e.groupOrder?t.groupOrder-e.groupOrder:t.renderOrder!==e.renderOrder?t.renderOrder-e.renderOrder:t.z!==e.z?e.z-t.z:t.id-e.id}function ya(){const t=[];let e=0;const i=[],n=[],s=[];function r(i,n,s,r,a,o){let h=t[e];return void 0===h?(h={id:i.id,object:i,geometry:n,material:s,groupOrder:r,renderOrder:i.renderOrder,z:a,group:o},t[e]=h):(h.id=i.id,h.object=i,h.geometry=n,h.material=s,h.groupOrder=r,h.renderOrder=i.renderOrder,h.z=a,h.group=o),e++,h}return{opaque:i,transmissive:n,transparent:s,init:function(){e=0,i.length=0,n.length=0,s.length=0},push:function(t,e,a,o,h,l){const c=r(t,e,a,o,h,l);a.transmission>0?n.push(c):!0===a.transparent?s.push(c):i.push(c)},unshift:function(t,e,a,o,h,l){const c=r(t,e,a,o,h,l);a.transmission>0?n.unshift(c):!0===a.transparent?s.unshift(c):i.unshift(c)},finish:function(){for(let i=e,n=t.length;i<n;i++){const e=t[i];if(null===e.id)break;e.id=null,e.object=null,e.geometry=null,e.material=null,e.group=null}},sort:function(t,e){i.length>1&&i.sort(t||ga),n.length>1&&n.sort(e||va),s.length>1&&s.sort(e||va)}}}function xa(){let t=new WeakMap;return{get:function(e,i){const n=t.get(e);let s;return void 0===n?(s=new ya,t.set(e,[s])):i>=n.length?(s=new ya,n.push(s)):s=n[i],s},dispose:function(){t=new WeakMap}}}function ba(){const t={};return{get:function(e){if(void 0!==t[e.id])return t[e.id];let i;switch(e.type){case"DirectionalLight":i={direction:new Le,color:new Zi};break;case"SpotLight":i={position:new Le,direction:new Le,color:new Zi,distance:0,coneCos:0,penumbraCos:0,decay:0};break;case"PointLight":i={position:new Le,color:new Zi,distance:0,decay:0};break;case"HemisphereLight":i={direction:new Le,skyColor:new Zi,groundColor:new Zi};break;case"RectAreaLight":i={color:new Zi,position:new Le,halfWidth:new Le,halfHeight:new Le}}return t[e.id]=i,i}}}let _a=0;function wa(t,e){return(e.castShadow?2:0)-(t.castShadow?2:0)+(e.map?1:0)-(t.map?1:0)}function Ma(t,e){const i=new ba,n=function(){const t={};return{get:function(e){if(void 0!==t[e.id])return t[e.id];let i;switch(e.type){case"DirectionalLight":case"SpotLight":i={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new se};break;case"PointLight":i={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new se,shadowCameraNear:1,shadowCameraFar:1e3}}return t[e.id]=i,i}}}(),s={version:0,hash:{directionalLength:-1,pointLength:-1,spotLength:-1,rectAreaLength:-1,hemiLength:-1,numDirectionalShadows:-1,numPointShadows:-1,numSpotShadows:-1,numSpotMaps:-1,numLightProbes:-1},ambient:[0,0,0],probe:[],directional:[],directionalShadow:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotLightMap:[],spotShadow:[],spotShadowMap:[],spotLightMatrix:[],rectArea:[],rectAreaLTC1:null,rectAreaLTC2:null,point:[],pointShadow:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[],numSpotLightShadowsWithMaps:0,numLightProbes:0};for(let t=0;t<9;t++)s.probe.push(new Le);const r=new Le,a=new ci,o=new ci;return{setup:function(r,a){let o=0,h=0,l=0;for(let t=0;t<9;t++)s.probe[t].set(0,0,0);let c=0,u=0,d=0,p=0,m=0,f=0,g=0,v=0,y=0,x=0,b=0;r.sort(wa);const _=!0===a?Math.PI:1;for(let t=0,e=r.length;t<e;t++){const e=r[t],a=e.color,w=e.intensity,M=e.distance,S=e.shadow&&e.shadow.map?e.shadow.map.texture:null;if(e.isAmbientLight)o+=a.r*w*_,h+=a.g*w*_,l+=a.b*w*_;else if(e.isLightProbe){for(let t=0;t<9;t++)s.probe[t].addScaledVector(e.sh.coefficients[t],w);b++}else if(e.isDirectionalLight){const t=i.get(e);if(t.color.copy(e.color).multiplyScalar(e.intensity*_),e.castShadow){const t=e.shadow,i=n.get(e);i.shadowBias=t.bias,i.shadowNormalBias=t.normalBias,i.shadowRadius=t.radius,i.shadowMapSize=t.mapSize,s.directionalShadow[c]=i,s.directionalShadowMap[c]=S,s.directionalShadowMatrix[c]=e.shadow.matrix,f++}s.directional[c]=t,c++}else if(e.isSpotLight){const t=i.get(e);t.position.setFromMatrixPosition(e.matrixWorld),t.color.copy(a).multiplyScalar(w*_),t.distance=M,t.coneCos=Math.cos(e.angle),t.penumbraCos=Math.cos(e.angle*(1-e.penumbra)),t.decay=e.decay,s.spot[d]=t;const r=e.shadow;if(e.map&&(s.spotLightMap[y]=e.map,y++,r.updateMatrices(e),e.castShadow&&x++),s.spotLightMatrix[d]=r.matrix,e.castShadow){const t=n.get(e);t.shadowBias=r.bias,t.shadowNormalBias=r.normalBias,t.shadowRadius=r.radius,t.shadowMapSize=r.mapSize,s.spotShadow[d]=t,s.spotShadowMap[d]=S,v++}d++}else if(e.isRectAreaLight){const t=i.get(e);t.color.copy(a).multiplyScalar(w),t.halfWidth.set(.5*e.width,0,0),t.halfHeight.set(0,.5*e.height,0),s.rectArea[p]=t,p++}else if(e.isPointLight){const t=i.get(e);if(t.color.copy(e.color).multiplyScalar(e.intensity*_),t.distance=e.distance,t.decay=e.decay,e.castShadow){const t=e.shadow,i=n.get(e);i.shadowBias=t.bias,i.shadowNormalBias=t.normalBias,i.shadowRadius=t.radius,i.shadowMapSize=t.mapSize,i.shadowCameraNear=t.camera.near,i.shadowCameraFar=t.camera.far,s.pointShadow[u]=i,s.pointShadowMap[u]=S,s.pointShadowMatrix[u]=e.shadow.matrix,g++}s.point[u]=t,u++}else if(e.isHemisphereLight){const t=i.get(e);t.skyColor.copy(e.color).multiplyScalar(w*_),t.groundColor.copy(e.groundColor).multiplyScalar(w*_),s.hemi[m]=t,m++}}p>0&&(e.isWebGL2?!0===t.has("OES_texture_float_linear")?(s.rectAreaLTC1=as.LTC_FLOAT_1,s.rectAreaLTC2=as.LTC_FLOAT_2):(s.rectAreaLTC1=as.LTC_HALF_1,s.rectAreaLTC2=as.LTC_HALF_2):!0===t.has("OES_texture_float_linear")?(s.rectAreaLTC1=as.LTC_FLOAT_1,s.rectAreaLTC2=as.LTC_FLOAT_2):!0===t.has("OES_texture_half_float_linear")&&(s.rectAreaLTC1=as.LTC_HALF_1,s.rectAreaLTC2=as.LTC_HALF_2)),s.ambient[0]=o,s.ambient[1]=h,s.ambient[2]=l;const w=s.hash;w.directionalLength===c&&w.pointLength===u&&w.spotLength===d&&w.rectAreaLength===p&&w.hemiLength===m&&w.numDirectionalShadows===f&&w.numPointShadows===g&&w.numSpotShadows===v&&w.numSpotMaps===y&&w.numLightProbes===b||(s.directional.length=c,s.spot.length=d,s.rectArea.length=p,s.point.length=u,s.hemi.length=m,s.directionalShadow.length=f,s.directionalShadowMap.length=f,s.pointShadow.length=g,s.pointShadowMap.length=g,s.spotShadow.length=v,s.spotShadowMap.length=v,s.directionalShadowMatrix.length=f,s.pointShadowMatrix.length=g,s.spotLightMatrix.length=v+y-x,s.spotLightMap.length=y,s.numSpotLightShadowsWithMaps=x,s.numLightProbes=b,w.directionalLength=c,w.pointLength=u,w.spotLength=d,w.rectAreaLength=p,w.hemiLength=m,w.numDirectionalShadows=f,w.numPointShadows=g,w.numSpotShadows=v,w.numSpotMaps=y,w.numLightProbes=b,s.version=_a++)},setupView:function(t,e){let i=0,n=0,h=0,l=0,c=0;const u=e.matrixWorldInverse;for(let e=0,d=t.length;e<d;e++){const d=t[e];if(d.isDirectionalLight){const t=s.directional[i];t.direction.setFromMatrixPosition(d.matrixWorld),r.setFromMatrixPosition(d.target.matrixWorld),t.direction.sub(r),t.direction.transformDirection(u),i++}else if(d.isSpotLight){const t=s.spot[h];t.position.setFromMatrixPosition(d.matrixWorld),t.position.applyMatrix4(u),t.direction.setFromMatrixPosition(d.matrixWorld),r.setFromMatrixPosition(d.target.matrixWorld),t.direction.sub(r),t.direction.transformDirection(u),h++}else if(d.isRectAreaLight){const t=s.rectArea[l];t.position.setFromMatrixPosition(d.matrixWorld),t.position.applyMatrix4(u),o.identity(),a.copy(d.matrixWorld),a.premultiply(u),o.extractRotation(a),t.halfWidth.set(.5*d.width,0,0),t.halfHeight.set(0,.5*d.height,0),t.halfWidth.applyMatrix4(o),t.halfHeight.applyMatrix4(o),l++}else if(d.isPointLight){const t=s.point[n];t.position.setFromMatrixPosition(d.matrixWorld),t.position.applyMatrix4(u),n++}else if(d.isHemisphereLight){const t=s.hemi[c];t.direction.setFromMatrixPosition(d.matrixWorld),t.direction.transformDirection(u),c++}}},state:s}}function Sa(t,e){const i=new Ma(t,e),n=[],s=[];return{init:function(){n.length=0,s.length=0},state:{lightsArray:n,shadowsArray:s,lights:i},setupLights:function(t){i.setup(n,t)},setupLightsView:function(t){i.setupView(n,t)},pushLight:function(t){n.push(t)},pushShadow:function(t){s.push(t)}}}function Ea(t,e){let i=new WeakMap;return{get:function(n,s=0){const r=i.get(n);let a;return void 0===r?(a=new Sa(t,e),i.set(n,[a])):s>=r.length?(a=new Sa(t,e),r.push(a)):a=r[s],a},dispose:function(){i=new WeakMap}}}class Ta extends en{constructor(t){super(),this.isMeshDepthMaterial=!0,this.type="MeshDepthMaterial",this.depthPacking=3200,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.setValues(t)}copy(t){return super.copy(t),this.depthPacking=t.depthPacking,this.map=t.map,this.alphaMap=t.alphaMap,this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this}}class Aa extends en{constructor(t){super(),this.isMeshDistanceMaterial=!0,this.type="MeshDistanceMaterial",this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.setValues(t)}copy(t){return super.copy(t),this.map=t.map,this.alphaMap=t.alphaMap,this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this}}function Ca(t,e,i){let n=new es;const s=new se,r=new se,a=new Ce,o=new Ta({depthPacking:3201}),h=new Aa,l={},c=i.maxTextureSize,u={[I]:R,[R]:I,2:2},d=new Vn({defines:{VSM_SAMPLES:8},uniforms:{shadow_pass:{value:null},resolution:{value:new se},radius:{value:4}},vertexShader:"void main() {\n\tgl_Position = vec4( position, 1.0 );\n}",fragmentShader:"uniform sampler2D shadow_pass;\nuniform vec2 resolution;\nuniform float radius;\n#include <packing>\nvoid main() {\n\tconst float samples = float( VSM_SAMPLES );\n\tfloat mean = 0.0;\n\tfloat squared_mean = 0.0;\n\tfloat uvStride = samples <= 1.0 ? 0.0 : 2.0 / ( samples - 1.0 );\n\tfloat uvStart = samples <= 1.0 ? 0.0 : - 1.0;\n\tfor ( float i = 0.0; i < samples; i ++ ) {\n\t\tfloat uvOffset = uvStart + i * uvStride;\n\t\t#ifdef HORIZONTAL_PASS\n\t\t\tvec2 distribution = unpackRGBATo2Half( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( uvOffset, 0.0 ) * radius ) / resolution ) );\n\t\t\tmean += distribution.x;\n\t\t\tsquared_mean += distribution.y * distribution.y + distribution.x * distribution.x;\n\t\t#else\n\t\t\tfloat depth = unpackRGBAToDepth( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( 0.0, uvOffset ) * radius ) / resolution ) );\n\t\t\tmean += depth;\n\t\t\tsquared_mean += depth * depth;\n\t\t#endif\n\t}\n\tmean = mean / samples;\n\tsquared_mean = squared_mean / samples;\n\tfloat std_dev = sqrt( squared_mean - mean * mean );\n\tgl_FragColor = pack2HalfToRGBA( vec2( mean, std_dev ) );\n}"}),p=d.clone();p.defines.HORIZONTAL_PASS=1;const m=new vn;m.setAttribute("position",new an(new Float32Array([-1,-1,.5,3,-1,.5,-1,3,.5]),3));const f=new On(m,d),g=this;this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=T;let v=this.type;function y(i,n){const r=e.update(f);d.defines.VSM_SAMPLES!==i.blurSamples&&(d.defines.VSM_SAMPLES=i.blurSamples,p.defines.VSM_SAMPLES=i.blurSamples,d.needsUpdate=!0,p.needsUpdate=!0),null===i.mapPass&&(i.mapPass=new Re(s.x,s.y)),d.uniforms.shadow_pass.value=i.map.texture,d.uniforms.resolution.value=i.mapSize,d.uniforms.radius.value=i.radius,t.setRenderTarget(i.mapPass),t.clear(),t.renderBufferDirect(n,null,r,d,f,null),p.uniforms.shadow_pass.value=i.mapPass.texture,p.uniforms.resolution.value=i.mapSize,p.uniforms.radius.value=i.radius,t.setRenderTarget(i.map),t.clear(),t.renderBufferDirect(n,null,r,p,f,null)}function x(e,i,n,s){let r=null;const a=!0===n.isPointLight?e.customDistanceMaterial:e.customDepthMaterial;if(void 0!==a)r=a;else if(r=!0===n.isPointLight?h:o,t.localClippingEnabled&&!0===i.clipShadows&&Array.isArray(i.clippingPlanes)&&0!==i.clippingPlanes.length||i.displacementMap&&0!==i.displacementScale||i.alphaMap&&i.alphaTest>0||i.map&&i.alphaTest>0){const t=r.uuid,e=i.uuid;let n=l[t];void 0===n&&(n={},l[t]=n);let s=n[e];void 0===s&&(s=r.clone(),n[e]=s,i.addEventListener("dispose",_)),r=s}if(r.visible=i.visible,r.wireframe=i.wireframe,r.side=s===C?null!==i.shadowSide?i.shadowSide:i.side:null!==i.shadowSide?i.shadowSide:u[i.side],r.alphaMap=i.alphaMap,r.alphaTest=i.alphaTest,r.map=i.map,r.clipShadows=i.clipShadows,r.clippingPlanes=i.clippingPlanes,r.clipIntersection=i.clipIntersection,r.displacementMap=i.displacementMap,r.displacementScale=i.displacementScale,r.displacementBias=i.displacementBias,r.wireframeLinewidth=i.wireframeLinewidth,r.linewidth=i.linewidth,!0===n.isPointLight&&!0===r.isMeshDistanceMaterial){t.properties.get(r).light=n}return r}function b(i,s,r,a,o){if(!1===i.visible)return;if(i.layers.test(s.layers)&&(i.isMesh||i.isLine||i.isPoints)&&(i.castShadow||i.receiveShadow&&o===C)&&(!i.frustumCulled||n.intersectsObject(i))){i.modelViewMatrix.multiplyMatrices(r.matrixWorldInverse,i.matrixWorld);const n=e.update(i),h=i.material;if(Array.isArray(h)){const e=n.groups;for(let l=0,c=e.length;l<c;l++){const c=e[l],u=h[c.materialIndex];if(u&&u.visible){const e=x(i,u,a,o);i.onBeforeShadow(t,i,s,r,n,e,c),t.renderBufferDirect(r,null,n,e,i,c),i.onAfterShadow(t,i,s,r,n,e,c)}}}else if(h.visible){const e=x(i,h,a,o);i.onBeforeShadow(t,i,s,r,n,e,null),t.renderBufferDirect(r,null,n,e,i,null),i.onAfterShadow(t,i,s,r,n,e,null)}}const h=i.children;for(let t=0,e=h.length;t<e;t++)b(h[t],s,r,a,o)}function _(t){t.target.removeEventListener("dispose",_);for(const e in l){const i=l[e],n=t.target.uuid;if(n in i){i[n].dispose(),delete i[n]}}}this.render=function(e,i,o){if(!1===g.enabled)return;if(!1===g.autoUpdate&&!1===g.needsUpdate)return;if(0===e.length)return;const h=t.getRenderTarget(),l=t.getActiveCubeFace(),u=t.getActiveMipmapLevel(),d=t.state;d.setBlending(0),d.buffers.color.setClear(1,1,1,1),d.buffers.depth.setTest(!0),d.setScissorTest(!1);const p=v!==C&&this.type===C,m=v===C&&this.type!==C;for(let h=0,l=e.length;h<l;h++){const l=e[h],u=l.shadow;if(void 0===u)continue;if(!1===u.autoUpdate&&!1===u.needsUpdate)continue;s.copy(u.mapSize);const f=u.getFrameExtents();if(s.multiply(f),r.copy(u.mapSize),(s.x>c||s.y>c)&&(s.x>c&&(r.x=Math.floor(c/f.x),s.x=r.x*f.x,u.mapSize.x=r.x),s.y>c&&(r.y=Math.floor(c/f.y),s.y=r.y*f.y,u.mapSize.y=r.y)),null===u.map||!0===p||!0===m){const t=this.type!==C?{minFilter:K,magFilter:K}:{};null!==u.map&&u.map.dispose(),u.map=new Re(s.x,s.y,t),u.map.texture.name=l.name+".shadowMap",u.camera.updateProjectionMatrix()}t.setRenderTarget(u.map),t.clear();const g=u.getViewportCount();for(let t=0;t<g;t++){const e=u.getViewport(t);a.set(r.x*e.x,r.y*e.y,r.x*e.z,r.y*e.w),d.viewport(a),u.updateMatrices(l,t),n=u.getFrustum(),b(i,o,u.camera,l,this.type)}!0!==u.isPointLightShadow&&this.type===C&&y(u,o),u.needsUpdate=!1}v=this.type,g.needsUpdate=!1,t.setRenderTarget(h,l,u)}}function Ia(t,e,i){const n=i.isWebGL2;const s=new function(){let e=!1;const i=new Ce;let n=null;const s=new Ce(0,0,0,0);return{setMask:function(i){n===i||e||(t.colorMask(i,i,i,i),n=i)},setLocked:function(t){e=t},setClear:function(e,n,r,a,o){!0===o&&(e*=a,n*=a,r*=a),i.set(e,n,r,a),!1===s.equals(i)&&(t.clearColor(e,n,r,a),s.copy(i))},reset:function(){e=!1,n=null,s.set(-1,0,0,0)}}},r=new function(){let e=!1,i=null,n=null,s=null;return{setTest:function(e){e?j(t.DEPTH_TEST):W(t.DEPTH_TEST)},setMask:function(n){i===n||e||(t.depthMask(n),i=n)},setFunc:function(e){if(n!==e){switch(e){case 0:t.depthFunc(t.NEVER);break;case 1:t.depthFunc(t.ALWAYS);break;case 2:t.depthFunc(t.LESS);break;case 3:default:t.depthFunc(t.LEQUAL);break;case 4:t.depthFunc(t.EQUAL);break;case 5:t.depthFunc(t.GEQUAL);break;case 6:t.depthFunc(t.GREATER);break;case 7:t.depthFunc(t.NOTEQUAL)}n=e}},setLocked:function(t){e=t},setClear:function(e){s!==e&&(t.clearDepth(e),s=e)},reset:function(){e=!1,i=null,n=null,s=null}}},a=new function(){let e=!1,i=null,n=null,s=null,r=null,a=null,o=null,h=null,l=null;return{setTest:function(i){e||(i?j(t.STENCIL_TEST):W(t.STENCIL_TEST))},setMask:function(n){i===n||e||(t.stencilMask(n),i=n)},setFunc:function(e,i,a){n===e&&s===i&&r===a||(t.stencilFunc(e,i,a),n=e,s=i,r=a)},setOp:function(e,i,n){a===e&&o===i&&h===n||(t.stencilOp(e,i,n),a=e,o=i,h=n)},setLocked:function(t){e=t},setClear:function(e){l!==e&&(t.clearStencil(e),l=e)},reset:function(){e=!1,i=null,n=null,s=null,r=null,a=null,o=null,h=null,l=null}}},o=new WeakMap,h=new WeakMap;let l={},c={},u=new WeakMap,d=[],p=null,m=!1,f=null,g=null,v=null,y=null,x=null,b=null,_=null,w=new Zi(0,0,0),M=0,S=!1,E=null,T=null,A=null,C=null,I=null;const P=t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS);let D=!1,L=0;const O=t.getParameter(t.VERSION);-1!==O.indexOf("WebGL")?(L=parseFloat(/^WebGL (\d)/.exec(O)[1]),D=L>=1):-1!==O.indexOf("OpenGL ES")&&(L=parseFloat(/^OpenGL ES (\d)/.exec(O)[1]),D=L>=2);let N=null,B={};const z=t.getParameter(t.SCISSOR_BOX),U=t.getParameter(t.VIEWPORT),F=(new Ce).fromArray(z),G=(new Ce).fromArray(U);function V(e,i,s,r){const a=new Uint8Array(4),o=t.createTexture();t.bindTexture(e,o),t.texParameteri(e,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(e,t.TEXTURE_MAG_FILTER,t.NEAREST);for(let o=0;o<s;o++)!n||e!==t.TEXTURE_3D&&e!==t.TEXTURE_2D_ARRAY?t.texImage2D(i+o,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,a):t.texImage3D(i,0,t.RGBA,1,1,r,0,t.RGBA,t.UNSIGNED_BYTE,a);return o}const H={};function j(e){!0!==l[e]&&(t.enable(e),l[e]=!0)}function W(e){!1!==l[e]&&(t.disable(e),l[e]=!1)}H[t.TEXTURE_2D]=V(t.TEXTURE_2D,t.TEXTURE_2D,1),H[t.TEXTURE_CUBE_MAP]=V(t.TEXTURE_CUBE_MAP,t.TEXTURE_CUBE_MAP_POSITIVE_X,6),n&&(H[t.TEXTURE_2D_ARRAY]=V(t.TEXTURE_2D_ARRAY,t.TEXTURE_2D_ARRAY,1,1),H[t.TEXTURE_3D]=V(t.TEXTURE_3D,t.TEXTURE_3D,1,1)),s.setClear(0,0,0,1),r.setClear(1),a.setClear(0),j(t.DEPTH_TEST),r.setFunc(3),J(!1),$(1),j(t.CULL_FACE),Y(0);const X={[k]:t.FUNC_ADD,101:t.FUNC_SUBTRACT,102:t.FUNC_REVERSE_SUBTRACT};if(n)X[103]=t.MIN,X[104]=t.MAX;else{const t=e.get("EXT_blend_minmax");null!==t&&(X[103]=t.MIN_EXT,X[104]=t.MAX_EXT)}const q={200:t.ZERO,201:t.ONE,202:t.SRC_COLOR,204:t.SRC_ALPHA,210:t.SRC_ALPHA_SATURATE,208:t.DST_COLOR,206:t.DST_ALPHA,203:t.ONE_MINUS_SRC_COLOR,205:t.ONE_MINUS_SRC_ALPHA,209:t.ONE_MINUS_DST_COLOR,207:t.ONE_MINUS_DST_ALPHA,211:t.CONSTANT_COLOR,212:t.ONE_MINUS_CONSTANT_COLOR,213:t.CONSTANT_ALPHA,214:t.ONE_MINUS_CONSTANT_ALPHA};function Y(e,i,n,s,r,a,o,h,l,c){if(0!==e){if(!1===m&&(j(t.BLEND),m=!0),5===e)r=r||i,a=a||n,o=o||s,i===g&&r===x||(t.blendEquationSeparate(X[i],X[r]),g=i,x=r),n===v&&s===y&&a===b&&o===_||(t.blendFuncSeparate(q[n],q[s],q[a],q[o]),v=n,y=s,b=a,_=o),!1!==h.equals(w)&&l===M||(t.blendColor(h.r,h.g,h.b,l),w.copy(h),M=l),f=e,S=!1;else if(e!==f||c!==S){if(g===k&&x===k||(t.blendEquation(t.FUNC_ADD),g=k,x=k),c)switch(e){case 1:t.blendFuncSeparate(t.ONE,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA);break;case 2:t.blendFunc(t.ONE,t.ONE);break;case 3:t.blendFuncSeparate(t.ZERO,t.ONE_MINUS_SRC_COLOR,t.ZERO,t.ONE);break;case 4:t.blendFuncSeparate(t.ZERO,t.SRC_COLOR,t.ZERO,t.SRC_ALPHA)}else switch(e){case 1:t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA);break;case 2:t.blendFunc(t.SRC_ALPHA,t.ONE);break;case 3:t.blendFuncSeparate(t.ZERO,t.ONE_MINUS_SRC_COLOR,t.ZERO,t.ONE);break;case 4:t.blendFunc(t.ZERO,t.SRC_COLOR)}v=null,y=null,b=null,_=null,w.set(0,0,0),M=0,f=e,S=c}}else!0===m&&(W(t.BLEND),m=!1)}function J(e){E!==e&&(e?t.frontFace(t.CW):t.frontFace(t.CCW),E=e)}function $(e){0!==e?(j(t.CULL_FACE),e!==T&&(1===e?t.cullFace(t.BACK):2===e?t.cullFace(t.FRONT):t.cullFace(t.FRONT_AND_BACK))):W(t.CULL_FACE),T=e}function K(e,i,n){e?(j(t.POLYGON_OFFSET_FILL),C===i&&I===n||(t.polygonOffset(i,n),C=i,I=n)):W(t.POLYGON_OFFSET_FILL)}return{buffers:{color:s,depth:r,stencil:a},enable:j,disable:W,bindFramebuffer:function(e,i){return c[e]!==i&&(t.bindFramebuffer(e,i),c[e]=i,n&&(e===t.DRAW_FRAMEBUFFER&&(c[t.FRAMEBUFFER]=i),e===t.FRAMEBUFFER&&(c[t.DRAW_FRAMEBUFFER]=i)),!0)},drawBuffers:function(n,s){let r=d,a=!1;if(n)if(r=u.get(s),void 0===r&&(r=[],u.set(s,r)),n.isWebGLMultipleRenderTargets){const e=n.texture;if(r.length!==e.length||r[0]!==t.COLOR_ATTACHMENT0){for(let i=0,n=e.length;i<n;i++)r[i]=t.COLOR_ATTACHMENT0+i;r.length=e.length,a=!0}}else r[0]!==t.COLOR_ATTACHMENT0&&(r[0]=t.COLOR_ATTACHMENT0,a=!0);else r[0]!==t.BACK&&(r[0]=t.BACK,a=!0);a&&(i.isWebGL2?t.drawBuffers(r):e.get("WEBGL_draw_buffers").drawBuffersWEBGL(r))},useProgram:function(e){return p!==e&&(t.useProgram(e),p=e,!0)},setBlending:Y,setMaterial:function(e,i){2===e.side?W(t.CULL_FACE):j(t.CULL_FACE);let n=e.side===R;i&&(n=!n),J(n),1===e.blending&&!1===e.transparent?Y(0):Y(e.blending,e.blendEquation,e.blendSrc,e.blendDst,e.blendEquationAlpha,e.blendSrcAlpha,e.blendDstAlpha,e.blendColor,e.blendAlpha,e.premultipliedAlpha),r.setFunc(e.depthFunc),r.setTest(e.depthTest),r.setMask(e.depthWrite),s.setMask(e.colorWrite);const o=e.stencilWrite;a.setTest(o),o&&(a.setMask(e.stencilWriteMask),a.setFunc(e.stencilFunc,e.stencilRef,e.stencilFuncMask),a.setOp(e.stencilFail,e.stencilZFail,e.stencilZPass)),K(e.polygonOffset,e.polygonOffsetFactor,e.polygonOffsetUnits),!0===e.alphaToCoverage?j(t.SAMPLE_ALPHA_TO_COVERAGE):W(t.SAMPLE_ALPHA_TO_COVERAGE)},setFlipSided:J,setCullFace:$,setLineWidth:function(e){e!==A&&(D&&t.lineWidth(e),A=e)},setPolygonOffset:K,setScissorTest:function(e){e?j(t.SCISSOR_TEST):W(t.SCISSOR_TEST)},activeTexture:function(e){void 0===e&&(e=t.TEXTURE0+P-1),N!==e&&(t.activeTexture(e),N=e)},bindTexture:function(e,i,n){void 0===n&&(n=null===N?t.TEXTURE0+P-1:N);let s=B[n];void 0===s&&(s={type:void 0,texture:void 0},B[n]=s),s.type===e&&s.texture===i||(N!==n&&(t.activeTexture(n),N=n),t.bindTexture(e,i||H[e]),s.type=e,s.texture=i)},unbindTexture:function(){const e=B[N];void 0!==e&&void 0!==e.type&&(t.bindTexture(e.type,null),e.type=void 0,e.texture=void 0)},compressedTexImage2D:function(){try{t.compressedTexImage2D.apply(t,arguments)}catch(t){}},compressedTexImage3D:function(){try{t.compressedTexImage3D.apply(t,arguments)}catch(t){}},texImage2D:function(){try{t.texImage2D.apply(t,arguments)}catch(t){}},texImage3D:function(){try{t.texImage3D.apply(t,arguments)}catch(t){}},updateUBOMapping:function(e,i){let n=h.get(i);void 0===n&&(n=new WeakMap,h.set(i,n));let s=n.get(e);void 0===s&&(s=t.getUniformBlockIndex(i,e.name),n.set(e,s))},uniformBlockBinding:function(e,i){const n=h.get(i).get(e);o.get(i)!==n&&(t.uniformBlockBinding(i,n,e.__bindingPointIndex),o.set(i,n))},texStorage2D:function(){try{t.texStorage2D.apply(t,arguments)}catch(t){}},texStorage3D:function(){try{t.texStorage3D.apply(t,arguments)}catch(t){}},texSubImage2D:function(){try{t.texSubImage2D.apply(t,arguments)}catch(t){}},texSubImage3D:function(){try{t.texSubImage3D.apply(t,arguments)}catch(t){}},compressedTexSubImage2D:function(){try{t.compressedTexSubImage2D.apply(t,arguments)}catch(t){}},compressedTexSubImage3D:function(){try{t.compressedTexSubImage3D.apply(t,arguments)}catch(t){}},scissor:function(e){!1===F.equals(e)&&(t.scissor(e.x,e.y,e.z,e.w),F.copy(e))},viewport:function(e){!1===G.equals(e)&&(t.viewport(e.x,e.y,e.z,e.w),G.copy(e))},reset:function(){t.disable(t.BLEND),t.disable(t.CULL_FACE),t.disable(t.DEPTH_TEST),t.disable(t.POLYGON_OFFSET_FILL),t.disable(t.SCISSOR_TEST),t.disable(t.STENCIL_TEST),t.disable(t.SAMPLE_ALPHA_TO_COVERAGE),t.blendEquation(t.FUNC_ADD),t.blendFunc(t.ONE,t.ZERO),t.blendFuncSeparate(t.ONE,t.ZERO,t.ONE,t.ZERO),t.blendColor(0,0,0,0),t.colorMask(!0,!0,!0,!0),t.clearColor(0,0,0,0),t.depthMask(!0),t.depthFunc(t.LESS),t.clearDepth(1),t.stencilMask(4294967295),t.stencilFunc(t.ALWAYS,0,4294967295),t.stencilOp(t.KEEP,t.KEEP,t.KEEP),t.clearStencil(0),t.cullFace(t.BACK),t.frontFace(t.CCW),t.polygonOffset(0,0),t.activeTexture(t.TEXTURE0),t.bindFramebuffer(t.FRAMEBUFFER,null),!0===n&&(t.bindFramebuffer(t.DRAW_FRAMEBUFFER,null),t.bindFramebuffer(t.READ_FRAMEBUFFER,null)),t.useProgram(null),t.lineWidth(1),t.scissor(0,0,t.canvas.width,t.canvas.height),t.viewport(0,0,t.canvas.width,t.canvas.height),l={},N=null,B={},c={},u=new WeakMap,d=[],p=null,m=!1,f=null,g=null,v=null,y=null,x=null,b=null,_=null,w=new Zi(0,0,0),M=0,S=!1,E=null,T=null,A=null,C=null,I=null,F.set(0,0,t.canvas.width,t.canvas.height),G.set(0,0,t.canvas.width,t.canvas.height),s.reset(),r.reset(),a.reset()}}}function Ra(t,e,i,n,s,r,a){const o=s.isWebGL2,h=e.has("WEBGL_multisampled_render_to_texture")?e.get("WEBGL_multisampled_render_to_texture"):null,l="undefined"!=typeof navigator&&/OculusBrowser/g.test(navigator.userAgent),c=new WeakMap;let u;const d=new WeakMap;let p=!1;try{p="undefined"!=typeof OffscreenCanvas&&null!==new OffscreenCanvas(1,1).getContext("2d")}catch(t){}function m(t,e){return p?new OffscreenCanvas(t,e):ce("canvas")}function f(t,e,i,n){let s=1;if((t.width>n||t.height>n)&&(s=n/Math.max(t.width,t.height)),s<1||!0===e){if("undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap){const n=e?te:Math.floor,r=n(s*t.width),a=n(s*t.height);void 0===u&&(u=m(r,a));const o=i?m(r,a):u;o.width=r,o.height=a;return o.getContext("2d").drawImage(t,0,0,r,a),o}return t}return t}function g(t){return Qt(t.width)&&Qt(t.height)}function v(t,e){return t.generateMipmaps&&e&&t.minFilter!==K&&t.minFilter!==tt}function y(e){t.generateMipmap(e)}function x(i,n,s,r,a=!1){if(!1===o)return n;if(null!==i&&void 0!==t[i])return t[i];let h=n;if(n===t.RED&&(s===t.FLOAT&&(h=t.R32F),s===t.HALF_FLOAT&&(h=t.R16F),s===t.UNSIGNED_BYTE&&(h=t.R8)),n===t.RED_INTEGER&&(s===t.UNSIGNED_BYTE&&(h=t.R8UI),s===t.UNSIGNED_SHORT&&(h=t.R16UI),s===t.UNSIGNED_INT&&(h=t.R32UI),s===t.BYTE&&(h=t.R8I),s===t.SHORT&&(h=t.R16I),s===t.INT&&(h=t.R32I)),n===t.RG&&(s===t.FLOAT&&(h=t.RG32F),s===t.HALF_FLOAT&&(h=t.RG16F),s===t.UNSIGNED_BYTE&&(h=t.RG8)),n===t.RGBA){const e=a?Dt:ye.getTransfer(r);s===t.FLOAT&&(h=t.RGBA32F),s===t.HALF_FLOAT&&(h=t.RGBA16F),s===t.UNSIGNED_BYTE&&(h=e===Lt?t.SRGB8_ALPHA8:t.RGBA8),s===t.UNSIGNED_SHORT_4_4_4_4&&(h=t.RGBA4),s===t.UNSIGNED_SHORT_5_5_5_1&&(h=t.RGB5_A1)}return h!==t.R16F&&h!==t.R32F&&h!==t.RG16F&&h!==t.RG32F&&h!==t.RGBA16F&&h!==t.RGBA32F||e.get("EXT_color_buffer_float"),h}function b(t,e,i){return!0===v(t,i)||t.isFramebufferTexture&&t.minFilter!==K&&t.minFilter!==tt?Math.log2(Math.max(e.width,e.height))+1:void 0!==t.mipmaps&&t.mipmaps.length>0?t.mipmaps.length:t.isCompressedTexture&&Array.isArray(t.image)?e.mipmaps.length:1}function _(e){return e===K||e===Z||e===Q?t.NEAREST:t.LINEAR}function w(t){const e=t.target;e.removeEventListener("dispose",w),function(t){const e=n.get(t);if(void 0===e.__webglInit)return;const i=t.source,s=d.get(i);if(s){const n=s[e.__cacheKey];n.usedTimes--,0===n.usedTimes&&S(t),0===Object.keys(s).length&&d.delete(i)}n.remove(t)}(e),e.isVideoTexture&&c.delete(e)}function M(e){const i=e.target;i.removeEventListener("dispose",M),function(e){const i=e.texture,s=n.get(e),r=n.get(i);void 0!==r.__webglTexture&&(t.deleteTexture(r.__webglTexture),a.memory.textures--);e.depthTexture&&e.depthTexture.dispose();if(e.isWebGLCubeRenderTarget)for(let e=0;e<6;e++){if(Array.isArray(s.__webglFramebuffer[e]))for(let i=0;i<s.__webglFramebuffer[e].length;i++)t.deleteFramebuffer(s.__webglFramebuffer[e][i]);else t.deleteFramebuffer(s.__webglFramebuffer[e]);s.__webglDepthbuffer&&t.deleteRenderbuffer(s.__webglDepthbuffer[e])}else{if(Array.isArray(s.__webglFramebuffer))for(let e=0;e<s.__webglFramebuffer.length;e++)t.deleteFramebuffer(s.__webglFramebuffer[e]);else t.deleteFramebuffer(s.__webglFramebuffer);if(s.__webglDepthbuffer&&t.deleteRenderbuffer(s.__webglDepthbuffer),s.__webglMultisampledFramebuffer&&t.deleteFramebuffer(s.__webglMultisampledFramebuffer),s.__webglColorRenderbuffer)for(let e=0;e<s.__webglColorRenderbuffer.length;e++)s.__webglColorRenderbuffer[e]&&t.deleteRenderbuffer(s.__webglColorRenderbuffer[e]);s.__webglDepthRenderbuffer&&t.deleteRenderbuffer(s.__webglDepthRenderbuffer)}if(e.isWebGLMultipleRenderTargets)for(let e=0,s=i.length;e<s;e++){const s=n.get(i[e]);s.__webglTexture&&(t.deleteTexture(s.__webglTexture),a.memory.textures--),n.remove(i[e])}n.remove(i),n.remove(e)}(i)}function S(e){const i=n.get(e);t.deleteTexture(i.__webglTexture);const s=e.source;delete d.get(s)[i.__cacheKey],a.memory.textures--}let E=0;function T(e,s){const r=n.get(e);if(e.isVideoTexture&&function(t){const e=a.render.frame;c.get(t)!==e&&(c.set(t,e),t.update())}(e),!1===e.isRenderTargetTexture&&e.version>0&&r.__version!==e.version){const t=e.image;if(null===t);else if(!1!==t.complete)return void P(r,e,s)}i.bindTexture(t.TEXTURE_2D,r.__webglTexture,t.TEXTURE0+s)}const A={[Y]:t.REPEAT,[J]:t.CLAMP_TO_EDGE,[$]:t.MIRRORED_REPEAT},C={[K]:t.NEAREST,[Z]:t.NEAREST_MIPMAP_NEAREST,[Q]:t.NEAREST_MIPMAP_LINEAR,[tt]:t.LINEAR,[et]:t.LINEAR_MIPMAP_NEAREST,[it]:t.LINEAR_MIPMAP_LINEAR},I={512:t.NEVER,519:t.ALWAYS,513:t.LESS,515:t.LEQUAL,514:t.EQUAL,518:t.GEQUAL,516:t.GREATER,517:t.NOTEQUAL};function R(i,r,a){if(a?(t.texParameteri(i,t.TEXTURE_WRAP_S,A[r.wrapS]),t.texParameteri(i,t.TEXTURE_WRAP_T,A[r.wrapT]),i!==t.TEXTURE_3D&&i!==t.TEXTURE_2D_ARRAY||t.texParameteri(i,t.TEXTURE_WRAP_R,A[r.wrapR]),t.texParameteri(i,t.TEXTURE_MAG_FILTER,C[r.magFilter]),t.texParameteri(i,t.TEXTURE_MIN_FILTER,C[r.minFilter])):(t.texParameteri(i,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(i,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),i!==t.TEXTURE_3D&&i!==t.TEXTURE_2D_ARRAY||t.texParameteri(i,t.TEXTURE_WRAP_R,t.CLAMP_TO_EDGE),r.wrapS!==J||r.wrapT,t.texParameteri(i,t.TEXTURE_MAG_FILTER,_(r.magFilter)),t.texParameteri(i,t.TEXTURE_MIN_FILTER,_(r.minFilter)),r.minFilter!==K&&r.minFilter),r.compareFunction&&(t.texParameteri(i,t.TEXTURE_COMPARE_MODE,t.COMPARE_REF_TO_TEXTURE),t.texParameteri(i,t.TEXTURE_COMPARE_FUNC,I[r.compareFunction])),!0===e.has("EXT_texture_filter_anisotropic")){const a=e.get("EXT_texture_filter_anisotropic");if(r.magFilter===K)return;if(r.minFilter!==Q&&r.minFilter!==it)return;if(r.type===ot&&!1===e.has("OES_texture_float_linear"))return;if(!1===o&&r.type===ht&&!1===e.has("OES_texture_half_float_linear"))return;(r.anisotropy>1||n.get(r).__currentAnisotropy)&&(t.texParameterf(i,a.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(r.anisotropy,s.getMaxAnisotropy())),n.get(r).__currentAnisotropy=r.anisotropy)}}function k(e,i){let n=!1;void 0===e.__webglInit&&(e.__webglInit=!0,i.addEventListener("dispose",w));const s=i.source;let r=d.get(s);void 0===r&&(r={},d.set(s,r));const o=function(t){const e=[];return e.push(t.wrapS),e.push(t.wrapT),e.push(t.wrapR||0),e.push(t.magFilter),e.push(t.minFilter),e.push(t.anisotropy),e.push(t.internalFormat),e.push(t.format),e.push(t.type),e.push(t.generateMipmaps),e.push(t.premultiplyAlpha),e.push(t.flipY),e.push(t.unpackAlignment),e.push(t.colorSpace),e.join()}(i);if(o!==e.__cacheKey){void 0===r[o]&&(r[o]={texture:t.createTexture(),usedTimes:0},a.memory.textures++,n=!0),r[o].usedTimes++;const s=r[e.__cacheKey];void 0!==s&&(r[e.__cacheKey].usedTimes--,0===s.usedTimes&&S(i)),e.__cacheKey=o,e.__webglTexture=r[o].texture}return n}function P(e,a,h){let l=t.TEXTURE_2D;(a.isDataArrayTexture||a.isCompressedArrayTexture)&&(l=t.TEXTURE_2D_ARRAY),a.isData3DTexture&&(l=t.TEXTURE_3D);const c=k(e,a),u=a.source;i.bindTexture(l,e.__webglTexture,t.TEXTURE0+h);const d=n.get(u);if(u.version!==d.__version||!0===c){i.activeTexture(t.TEXTURE0+h);const e=ye.getPrimaries(ye.workingColorSpace),n=a.colorSpace===Ct?null:ye.getPrimaries(a.colorSpace),p=a.colorSpace===Ct||e===n?t.NONE:t.BROWSER_DEFAULT_WEBGL;t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,a.flipY),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,a.premultiplyAlpha),t.pixelStorei(t.UNPACK_ALIGNMENT,a.unpackAlignment),t.pixelStorei(t.UNPACK_COLORSPACE_CONVERSION_WEBGL,p);const m=function(t){return!o&&(t.wrapS!==J||t.wrapT!==J||t.minFilter!==K&&t.minFilter!==tt)}(a)&&!1===g(a.image);let _=f(a.image,m,!1,s.maxTextureSize);_=z(a,_);const w=g(_)||o,M=r.convert(a.format,a.colorSpace);let S,E=r.convert(a.type),T=x(a.internalFormat,M,E,a.colorSpace,a.isVideoTexture);R(l,a,w);const A=a.mipmaps,C=o&&!0!==a.isVideoTexture&&36196!==T,I=void 0===d.__version||!0===c,k=b(a,_,w);if(a.isDepthTexture)T=t.DEPTH_COMPONENT,o?T=a.type===ot?t.DEPTH_COMPONENT32F:a.type===at?t.DEPTH_COMPONENT24:a.type===lt?t.DEPTH24_STENCIL8:t.DEPTH_COMPONENT16:a.type,a.format===ut&&T===t.DEPTH_COMPONENT&&a.type!==st&&a.type!==at&&(a.type=at,E=r.convert(a.type)),a.format===dt&&T===t.DEPTH_COMPONENT&&(T=t.DEPTH_STENCIL,a.type!==lt&&(a.type=lt,E=r.convert(a.type))),I&&(C?i.texStorage2D(t.TEXTURE_2D,1,T,_.width,_.height):i.texImage2D(t.TEXTURE_2D,0,T,_.width,_.height,0,M,E,null));else if(a.isDataTexture)if(A.length>0&&w){C&&I&&i.texStorage2D(t.TEXTURE_2D,k,T,A[0].width,A[0].height);for(let e=0,n=A.length;e<n;e++)S=A[e],C?i.texSubImage2D(t.TEXTURE_2D,e,0,0,S.width,S.height,M,E,S.data):i.texImage2D(t.TEXTURE_2D,e,T,S.width,S.height,0,M,E,S.data);a.generateMipmaps=!1}else C?(I&&i.texStorage2D(t.TEXTURE_2D,k,T,_.width,_.height),i.texSubImage2D(t.TEXTURE_2D,0,0,0,_.width,_.height,M,E,_.data)):i.texImage2D(t.TEXTURE_2D,0,T,_.width,_.height,0,M,E,_.data);else if(a.isCompressedTexture)if(a.isCompressedArrayTexture){C&&I&&i.texStorage3D(t.TEXTURE_2D_ARRAY,k,T,A[0].width,A[0].height,_.depth);for(let e=0,n=A.length;e<n;e++)S=A[e],a.format!==ct?null!==M&&(C?i.compressedTexSubImage3D(t.TEXTURE_2D_ARRAY,e,0,0,0,S.width,S.height,_.depth,M,S.data,0,0):i.compressedTexImage3D(t.TEXTURE_2D_ARRAY,e,T,S.width,S.height,_.depth,0,S.data,0,0)):C?i.texSubImage3D(t.TEXTURE_2D_ARRAY,e,0,0,0,S.width,S.height,_.depth,M,E,S.data):i.texImage3D(t.TEXTURE_2D_ARRAY,e,T,S.width,S.height,_.depth,0,M,E,S.data)}else{C&&I&&i.texStorage2D(t.TEXTURE_2D,k,T,A[0].width,A[0].height);for(let e=0,n=A.length;e<n;e++)S=A[e],a.format!==ct?null!==M&&(C?i.compressedTexSubImage2D(t.TEXTURE_2D,e,0,0,S.width,S.height,M,S.data):i.compressedTexImage2D(t.TEXTURE_2D,e,T,S.width,S.height,0,S.data)):C?i.texSubImage2D(t.TEXTURE_2D,e,0,0,S.width,S.height,M,E,S.data):i.texImage2D(t.TEXTURE_2D,e,T,S.width,S.height,0,M,E,S.data)}else if(a.isDataArrayTexture)C?(I&&i.texStorage3D(t.TEXTURE_2D_ARRAY,k,T,_.width,_.height,_.depth),i.texSubImage3D(t.TEXTURE_2D_ARRAY,0,0,0,0,_.width,_.height,_.depth,M,E,_.data)):i.texImage3D(t.TEXTURE_2D_ARRAY,0,T,_.width,_.height,_.depth,0,M,E,_.data);else if(a.isData3DTexture)C?(I&&i.texStorage3D(t.TEXTURE_3D,k,T,_.width,_.height,_.depth),i.texSubImage3D(t.TEXTURE_3D,0,0,0,0,_.width,_.height,_.depth,M,E,_.data)):i.texImage3D(t.TEXTURE_3D,0,T,_.width,_.height,_.depth,0,M,E,_.data);else if(a.isFramebufferTexture){if(I)if(C)i.texStorage2D(t.TEXTURE_2D,k,T,_.width,_.height);else{let e=_.width,n=_.height;for(let s=0;s<k;s++)i.texImage2D(t.TEXTURE_2D,s,T,e,n,0,M,E,null),e>>=1,n>>=1}}else if(A.length>0&&w){C&&I&&i.texStorage2D(t.TEXTURE_2D,k,T,A[0].width,A[0].height);for(let e=0,n=A.length;e<n;e++)S=A[e],C?i.texSubImage2D(t.TEXTURE_2D,e,0,0,M,E,S):i.texImage2D(t.TEXTURE_2D,e,T,M,E,S);a.generateMipmaps=!1}else C?(I&&i.texStorage2D(t.TEXTURE_2D,k,T,_.width,_.height),i.texSubImage2D(t.TEXTURE_2D,0,0,0,M,E,_)):i.texImage2D(t.TEXTURE_2D,0,T,M,E,_);v(a,w)&&y(l),d.__version=u.version,a.onUpdate&&a.onUpdate(a)}e.__version=a.version}function D(e,s,a,o,l,c){const u=r.convert(a.format,a.colorSpace),d=r.convert(a.type),p=x(a.internalFormat,u,d,a.colorSpace);if(!n.get(s).__hasExternalTextures){const e=Math.max(1,s.width>>c),n=Math.max(1,s.height>>c);l===t.TEXTURE_3D||l===t.TEXTURE_2D_ARRAY?i.texImage3D(l,c,p,e,n,s.depth,0,u,d,null):i.texImage2D(l,c,p,e,n,0,u,d,null)}i.bindFramebuffer(t.FRAMEBUFFER,e),B(s)?h.framebufferTexture2DMultisampleEXT(t.FRAMEBUFFER,o,l,n.get(a).__webglTexture,0,N(s)):(l===t.TEXTURE_2D||l>=t.TEXTURE_CUBE_MAP_POSITIVE_X&&l<=t.TEXTURE_CUBE_MAP_NEGATIVE_Z)&&t.framebufferTexture2D(t.FRAMEBUFFER,o,l,n.get(a).__webglTexture,c),i.bindFramebuffer(t.FRAMEBUFFER,null)}function L(e,i,n){if(t.bindRenderbuffer(t.RENDERBUFFER,e),i.depthBuffer&&!i.stencilBuffer){let s=!0===o?t.DEPTH_COMPONENT24:t.DEPTH_COMPONENT16;if(n||B(i)){const e=i.depthTexture;e&&e.isDepthTexture&&(e.type===ot?s=t.DEPTH_COMPONENT32F:e.type===at&&(s=t.DEPTH_COMPONENT24));const n=N(i);B(i)?h.renderbufferStorageMultisampleEXT(t.RENDERBUFFER,n,s,i.width,i.height):t.renderbufferStorageMultisample(t.RENDERBUFFER,n,s,i.width,i.height)}else t.renderbufferStorage(t.RENDERBUFFER,s,i.width,i.height);t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,e)}else if(i.depthBuffer&&i.stencilBuffer){const s=N(i);n&&!1===B(i)?t.renderbufferStorageMultisample(t.RENDERBUFFER,s,t.DEPTH24_STENCIL8,i.width,i.height):B(i)?h.renderbufferStorageMultisampleEXT(t.RENDERBUFFER,s,t.DEPTH24_STENCIL8,i.width,i.height):t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_STENCIL,i.width,i.height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,t.RENDERBUFFER,e)}else{const e=!0===i.isWebGLMultipleRenderTargets?i.texture:[i.texture];for(let s=0;s<e.length;s++){const a=e[s],o=r.convert(a.format,a.colorSpace),l=r.convert(a.type),c=x(a.internalFormat,o,l,a.colorSpace),u=N(i);n&&!1===B(i)?t.renderbufferStorageMultisample(t.RENDERBUFFER,u,c,i.width,i.height):B(i)?h.renderbufferStorageMultisampleEXT(t.RENDERBUFFER,u,c,i.width,i.height):t.renderbufferStorage(t.RENDERBUFFER,c,i.width,i.height)}}t.bindRenderbuffer(t.RENDERBUFFER,null)}function O(e){const s=n.get(e),r=!0===e.isWebGLCubeRenderTarget;if(e.depthTexture&&!s.__autoAllocateDepthBuffer){if(r)throw new Error("target.depthTexture not supported in Cube render targets");!function(e,s){if(s&&s.isWebGLCubeRenderTarget)throw new Error("Depth Texture with cube render targets is not supported");if(i.bindFramebuffer(t.FRAMEBUFFER,e),!s.depthTexture||!s.depthTexture.isDepthTexture)throw new Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");n.get(s.depthTexture).__webglTexture&&s.depthTexture.image.width===s.width&&s.depthTexture.image.height===s.height||(s.depthTexture.image.width=s.width,s.depthTexture.image.height=s.height,s.depthTexture.needsUpdate=!0),T(s.depthTexture,0);const r=n.get(s.depthTexture).__webglTexture,a=N(s);if(s.depthTexture.format===ut)B(s)?h.framebufferTexture2DMultisampleEXT(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.TEXTURE_2D,r,0,a):t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.TEXTURE_2D,r,0);else{if(s.depthTexture.format!==dt)throw new Error("Unknown depthTexture format");B(s)?h.framebufferTexture2DMultisampleEXT(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,t.TEXTURE_2D,r,0,a):t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,t.TEXTURE_2D,r,0)}}(s.__webglFramebuffer,e)}else if(r){s.__webglDepthbuffer=[];for(let n=0;n<6;n++)i.bindFramebuffer(t.FRAMEBUFFER,s.__webglFramebuffer[n]),s.__webglDepthbuffer[n]=t.createRenderbuffer(),L(s.__webglDepthbuffer[n],e,!1)}else i.bindFramebuffer(t.FRAMEBUFFER,s.__webglFramebuffer),s.__webglDepthbuffer=t.createRenderbuffer(),L(s.__webglDepthbuffer,e,!1);i.bindFramebuffer(t.FRAMEBUFFER,null)}function N(t){return Math.min(s.maxSamples,t.samples)}function B(t){const i=n.get(t);return o&&t.samples>0&&!0===e.has("WEBGL_multisampled_render_to_texture")&&!1!==i.__useRenderToTexture}function z(t,i){const n=t.colorSpace,s=t.format;t.type;return!0===t.isCompressedTexture||!0===t.isVideoTexture||t.format===Gt||n!==Rt&&n!==Ct&&ye.getTransfer(n)===Lt&&!1===o&&(!0===e.has("EXT_sRGB")&&s===ct?(t.format=Gt,t.minFilter=tt,t.generateMipmaps=!1):i=we.sRGBToLinear(i)),i}this.allocateTextureUnit=function(){const t=E;return s.maxTextures,E+=1,t},this.resetTextureUnits=function(){E=0},this.setTexture2D=T,this.setTexture2DArray=function(e,s){const r=n.get(e);e.version>0&&r.__version!==e.version?P(r,e,s):i.bindTexture(t.TEXTURE_2D_ARRAY,r.__webglTexture,t.TEXTURE0+s)},this.setTexture3D=function(e,s){const r=n.get(e);e.version>0&&r.__version!==e.version?P(r,e,s):i.bindTexture(t.TEXTURE_3D,r.__webglTexture,t.TEXTURE0+s)},this.setTextureCube=function(e,a){const h=n.get(e);e.version>0&&h.__version!==e.version?function(e,a,h){if(6!==a.image.length)return;const l=k(e,a),c=a.source;i.bindTexture(t.TEXTURE_CUBE_MAP,e.__webglTexture,t.TEXTURE0+h);const u=n.get(c);if(c.version!==u.__version||!0===l){i.activeTexture(t.TEXTURE0+h);const e=ye.getPrimaries(ye.workingColorSpace),n=a.colorSpace===Ct?null:ye.getPrimaries(a.colorSpace),d=a.colorSpace===Ct||e===n?t.NONE:t.BROWSER_DEFAULT_WEBGL;t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,a.flipY),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,a.premultiplyAlpha),t.pixelStorei(t.UNPACK_ALIGNMENT,a.unpackAlignment),t.pixelStorei(t.UNPACK_COLORSPACE_CONVERSION_WEBGL,d);const p=a.isCompressedTexture||a.image[0].isCompressedTexture,m=a.image[0]&&a.image[0].isDataTexture,_=[];for(let t=0;t<6;t++)_[t]=p||m?m?a.image[t].image:a.image[t]:f(a.image[t],!1,!0,s.maxCubemapSize),_[t]=z(a,_[t]);const w=_[0],M=g(w)||o,S=r.convert(a.format,a.colorSpace),E=r.convert(a.type),T=x(a.internalFormat,S,E,a.colorSpace),A=o&&!0!==a.isVideoTexture,C=void 0===u.__version||!0===l;let I,k=b(a,w,M);if(R(t.TEXTURE_CUBE_MAP,a,M),p){A&&C&&i.texStorage2D(t.TEXTURE_CUBE_MAP,k,T,w.width,w.height);for(let e=0;e<6;e++){I=_[e].mipmaps;for(let n=0;n<I.length;n++){const s=I[n];a.format!==ct?null!==S&&(A?i.compressedTexSubImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,n,0,0,s.width,s.height,S,s.data):i.compressedTexImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,n,T,s.width,s.height,0,s.data)):A?i.texSubImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,n,0,0,s.width,s.height,S,E,s.data):i.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,n,T,s.width,s.height,0,S,E,s.data)}}}else{I=a.mipmaps,A&&C&&(I.length>0&&k++,i.texStorage2D(t.TEXTURE_CUBE_MAP,k,T,_[0].width,_[0].height));for(let e=0;e<6;e++)if(m){A?i.texSubImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,0,0,_[e].width,_[e].height,S,E,_[e].data):i.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,T,_[e].width,_[e].height,0,S,E,_[e].data);for(let n=0;n<I.length;n++){const s=I[n].image[e].image;A?i.texSubImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,n+1,0,0,s.width,s.height,S,E,s.data):i.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,n+1,T,s.width,s.height,0,S,E,s.data)}}else{A?i.texSubImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,0,0,S,E,_[e]):i.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,T,S,E,_[e]);for(let n=0;n<I.length;n++){const s=I[n];A?i.texSubImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,n+1,0,0,S,E,s.image[e]):i.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,n+1,T,S,E,s.image[e])}}}v(a,M)&&y(t.TEXTURE_CUBE_MAP),u.__version=c.version,a.onUpdate&&a.onUpdate(a)}e.__version=a.version}(h,e,a):i.bindTexture(t.TEXTURE_CUBE_MAP,h.__webglTexture,t.TEXTURE0+a)},this.rebindTextures=function(e,i,s){const r=n.get(e);void 0!==i&&D(r.__webglFramebuffer,e,e.texture,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,0),void 0!==s&&O(e)},this.setupRenderTarget=function(e){const h=e.texture,l=n.get(e),c=n.get(h);e.addEventListener("dispose",M),!0!==e.isWebGLMultipleRenderTargets&&(void 0===c.__webglTexture&&(c.__webglTexture=t.createTexture()),c.__version=h.version,a.memory.textures++);const u=!0===e.isWebGLCubeRenderTarget,d=!0===e.isWebGLMultipleRenderTargets,p=g(e)||o;if(u){l.__webglFramebuffer=[];for(let e=0;e<6;e++)if(o&&h.mipmaps&&h.mipmaps.length>0){l.__webglFramebuffer[e]=[];for(let i=0;i<h.mipmaps.length;i++)l.__webglFramebuffer[e][i]=t.createFramebuffer()}else l.__webglFramebuffer[e]=t.createFramebuffer()}else{if(o&&h.mipmaps&&h.mipmaps.length>0){l.__webglFramebuffer=[];for(let e=0;e<h.mipmaps.length;e++)l.__webglFramebuffer[e]=t.createFramebuffer()}else l.__webglFramebuffer=t.createFramebuffer();if(d&&s.drawBuffers){const i=e.texture;for(let e=0,s=i.length;e<s;e++){const s=n.get(i[e]);void 0===s.__webglTexture&&(s.__webglTexture=t.createTexture(),a.memory.textures++)}}if(o&&e.samples>0&&!1===B(e)){const n=d?h:[h];l.__webglMultisampledFramebuffer=t.createFramebuffer(),l.__webglColorRenderbuffer=[],i.bindFramebuffer(t.FRAMEBUFFER,l.__webglMultisampledFramebuffer);for(let i=0;i<n.length;i++){const s=n[i];l.__webglColorRenderbuffer[i]=t.createRenderbuffer(),t.bindRenderbuffer(t.RENDERBUFFER,l.__webglColorRenderbuffer[i]);const a=r.convert(s.format,s.colorSpace),o=r.convert(s.type),h=x(s.internalFormat,a,o,s.colorSpace,!0===e.isXRRenderTarget),c=N(e);t.renderbufferStorageMultisample(t.RENDERBUFFER,c,h,e.width,e.height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+i,t.RENDERBUFFER,l.__webglColorRenderbuffer[i])}t.bindRenderbuffer(t.RENDERBUFFER,null),e.depthBuffer&&(l.__webglDepthRenderbuffer=t.createRenderbuffer(),L(l.__webglDepthRenderbuffer,e,!0)),i.bindFramebuffer(t.FRAMEBUFFER,null)}}if(u){i.bindTexture(t.TEXTURE_CUBE_MAP,c.__webglTexture),R(t.TEXTURE_CUBE_MAP,h,p);for(let i=0;i<6;i++)if(o&&h.mipmaps&&h.mipmaps.length>0)for(let n=0;n<h.mipmaps.length;n++)D(l.__webglFramebuffer[i][n],e,h,t.COLOR_ATTACHMENT0,t.TEXTURE_CUBE_MAP_POSITIVE_X+i,n);else D(l.__webglFramebuffer[i],e,h,t.COLOR_ATTACHMENT0,t.TEXTURE_CUBE_MAP_POSITIVE_X+i,0);v(h,p)&&y(t.TEXTURE_CUBE_MAP),i.unbindTexture()}else if(d){const s=e.texture;for(let r=0,a=s.length;r<a;r++){const a=s[r],o=n.get(a);i.bindTexture(t.TEXTURE_2D,o.__webglTexture),R(t.TEXTURE_2D,a,p),D(l.__webglFramebuffer,e,a,t.COLOR_ATTACHMENT0+r,t.TEXTURE_2D,0),v(a,p)&&y(t.TEXTURE_2D)}i.unbindTexture()}else{let n=t.TEXTURE_2D;if((e.isWebGL3DRenderTarget||e.isWebGLArrayRenderTarget)&&o&&(n=e.isWebGL3DRenderTarget?t.TEXTURE_3D:t.TEXTURE_2D_ARRAY),i.bindTexture(n,c.__webglTexture),R(n,h,p),o&&h.mipmaps&&h.mipmaps.length>0)for(let i=0;i<h.mipmaps.length;i++)D(l.__webglFramebuffer[i],e,h,t.COLOR_ATTACHMENT0,n,i);else D(l.__webglFramebuffer,e,h,t.COLOR_ATTACHMENT0,n,0);v(h,p)&&y(n),i.unbindTexture()}e.depthBuffer&&O(e)},this.updateRenderTargetMipmap=function(e){const s=g(e)||o,r=!0===e.isWebGLMultipleRenderTargets?e.texture:[e.texture];for(let a=0,o=r.length;a<o;a++){const o=r[a];if(v(o,s)){const s=e.isWebGLCubeRenderTarget?t.TEXTURE_CUBE_MAP:t.TEXTURE_2D,r=n.get(o).__webglTexture;i.bindTexture(s,r),y(s),i.unbindTexture()}}},this.updateMultisampleRenderTarget=function(e){if(o&&e.samples>0&&!1===B(e)){const s=e.isWebGLMultipleRenderTargets?e.texture:[e.texture],r=e.width,a=e.height;let o=t.COLOR_BUFFER_BIT;const h=[],c=e.stencilBuffer?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT,u=n.get(e),d=!0===e.isWebGLMultipleRenderTargets;if(d)for(let e=0;e<s.length;e++)i.bindFramebuffer(t.FRAMEBUFFER,u.__webglMultisampledFramebuffer),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+e,t.RENDERBUFFER,null),i.bindFramebuffer(t.FRAMEBUFFER,u.__webglFramebuffer),t.framebufferTexture2D(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0+e,t.TEXTURE_2D,null,0);i.bindFramebuffer(t.READ_FRAMEBUFFER,u.__webglMultisampledFramebuffer),i.bindFramebuffer(t.DRAW_FRAMEBUFFER,u.__webglFramebuffer);for(let i=0;i<s.length;i++){h.push(t.COLOR_ATTACHMENT0+i),e.depthBuffer&&h.push(c);const p=void 0!==u.__ignoreDepthValues&&u.__ignoreDepthValues;if(!1===p&&(e.depthBuffer&&(o|=t.DEPTH_BUFFER_BIT),e.stencilBuffer&&(o|=t.STENCIL_BUFFER_BIT)),d&&t.framebufferRenderbuffer(t.READ_FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.RENDERBUFFER,u.__webglColorRenderbuffer[i]),!0===p&&(t.invalidateFramebuffer(t.READ_FRAMEBUFFER,[c]),t.invalidateFramebuffer(t.DRAW_FRAMEBUFFER,[c])),d){const e=n.get(s[i]).__webglTexture;t.framebufferTexture2D(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,e,0)}t.blitFramebuffer(0,0,r,a,0,0,r,a,o,t.NEAREST),l&&t.invalidateFramebuffer(t.READ_FRAMEBUFFER,h)}if(i.bindFramebuffer(t.READ_FRAMEBUFFER,null),i.bindFramebuffer(t.DRAW_FRAMEBUFFER,null),d)for(let e=0;e<s.length;e++){i.bindFramebuffer(t.FRAMEBUFFER,u.__webglMultisampledFramebuffer),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+e,t.RENDERBUFFER,u.__webglColorRenderbuffer[e]);const r=n.get(s[e]).__webglTexture;i.bindFramebuffer(t.FRAMEBUFFER,u.__webglFramebuffer),t.framebufferTexture2D(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0+e,t.TEXTURE_2D,r,0)}i.bindFramebuffer(t.DRAW_FRAMEBUFFER,u.__webglMultisampledFramebuffer)}},this.setupDepthRenderbuffer=O,this.setupFrameBufferTexture=D,this.useMultisampledRTT=B}function ka(t,e,i){const n=i.isWebGL2;return{convert:function(i,s=""){let r;const a=ye.getTransfer(s);if(i===nt)return t.UNSIGNED_BYTE;if(1017===i)return t.UNSIGNED_SHORT_4_4_4_4;if(1018===i)return t.UNSIGNED_SHORT_5_5_5_1;if(1010===i)return t.BYTE;if(1011===i)return t.SHORT;if(i===st)return t.UNSIGNED_SHORT;if(i===rt)return t.INT;if(i===at)return t.UNSIGNED_INT;if(i===ot)return t.FLOAT;if(i===ht)return n?t.HALF_FLOAT:(r=e.get("OES_texture_half_float"),null!==r?r.HALF_FLOAT_OES:null);if(1021===i)return t.ALPHA;if(i===ct)return t.RGBA;if(1024===i)return t.LUMINANCE;if(1025===i)return t.LUMINANCE_ALPHA;if(i===ut)return t.DEPTH_COMPONENT;if(i===dt)return t.DEPTH_STENCIL;if(i===Gt)return r=e.get("EXT_sRGB"),null!==r?r.SRGB_ALPHA_EXT:null;if(1028===i)return t.RED;if(1029===i)return t.RED_INTEGER;if(1030===i)return t.RG;if(1031===i)return t.RG_INTEGER;if(1033===i)return t.RGBA_INTEGER;if(i===pt||i===mt||i===ft||i===gt)if(a===Lt){if(r=e.get("WEBGL_compressed_texture_s3tc_srgb"),null===r)return null;if(i===pt)return r.COMPRESSED_SRGB_S3TC_DXT1_EXT;if(i===mt)return r.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;if(i===ft)return r.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;if(i===gt)return r.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT}else{if(r=e.get("WEBGL_compressed_texture_s3tc"),null===r)return null;if(i===pt)return r.COMPRESSED_RGB_S3TC_DXT1_EXT;if(i===mt)return r.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(i===ft)return r.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(i===gt)return r.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(35840===i||35841===i||35842===i||35843===i){if(r=e.get("WEBGL_compressed_texture_pvrtc"),null===r)return null;if(35840===i)return r.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(35841===i)return r.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(35842===i)return r.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(35843===i)return r.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(36196===i)return r=e.get("WEBGL_compressed_texture_etc1"),null!==r?r.COMPRESSED_RGB_ETC1_WEBGL:null;if(37492===i||37496===i){if(r=e.get("WEBGL_compressed_texture_etc"),null===r)return null;if(37492===i)return a===Lt?r.COMPRESSED_SRGB8_ETC2:r.COMPRESSED_RGB8_ETC2;if(37496===i)return a===Lt?r.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:r.COMPRESSED_RGBA8_ETC2_EAC}if(37808===i||37809===i||37810===i||37811===i||37812===i||37813===i||37814===i||37815===i||37816===i||37817===i||37818===i||37819===i||37820===i||37821===i){if(r=e.get("WEBGL_compressed_texture_astc"),null===r)return null;if(37808===i)return a===Lt?r.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR:r.COMPRESSED_RGBA_ASTC_4x4_KHR;if(37809===i)return a===Lt?r.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR:r.COMPRESSED_RGBA_ASTC_5x4_KHR;if(37810===i)return a===Lt?r.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR:r.COMPRESSED_RGBA_ASTC_5x5_KHR;if(37811===i)return a===Lt?r.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR:r.COMPRESSED_RGBA_ASTC_6x5_KHR;if(37812===i)return a===Lt?r.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR:r.COMPRESSED_RGBA_ASTC_6x6_KHR;if(37813===i)return a===Lt?r.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR:r.COMPRESSED_RGBA_ASTC_8x5_KHR;if(37814===i)return a===Lt?r.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR:r.COMPRESSED_RGBA_ASTC_8x6_KHR;if(37815===i)return a===Lt?r.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR:r.COMPRESSED_RGBA_ASTC_8x8_KHR;if(37816===i)return a===Lt?r.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR:r.COMPRESSED_RGBA_ASTC_10x5_KHR;if(37817===i)return a===Lt?r.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR:r.COMPRESSED_RGBA_ASTC_10x6_KHR;if(37818===i)return a===Lt?r.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR:r.COMPRESSED_RGBA_ASTC_10x8_KHR;if(37819===i)return a===Lt?r.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR:r.COMPRESSED_RGBA_ASTC_10x10_KHR;if(37820===i)return a===Lt?r.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR:r.COMPRESSED_RGBA_ASTC_12x10_KHR;if(37821===i)return a===Lt?r.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR:r.COMPRESSED_RGBA_ASTC_12x12_KHR}if(i===vt||36494===i||36495===i){if(r=e.get("EXT_texture_compression_bptc"),null===r)return null;if(i===vt)return a===Lt?r.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT:r.COMPRESSED_RGBA_BPTC_UNORM_EXT;if(36494===i)return r.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT;if(36495===i)return r.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT}if(36283===i||36284===i||36285===i||36286===i){if(r=e.get("EXT_texture_compression_rgtc"),null===r)return null;if(i===vt)return r.COMPRESSED_RED_RGTC1_EXT;if(36284===i)return r.COMPRESSED_SIGNED_RED_RGTC1_EXT;if(36285===i)return r.COMPRESSED_RED_GREEN_RGTC2_EXT;if(36286===i)return r.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT}return i===lt?n?t.UNSIGNED_INT_24_8:(r=e.get("WEBGL_depth_texture"),null!==r?r.UNSIGNED_INT_24_8_WEBGL:null):void 0!==t[i]?t[i]:null}}}class Pa extends jn{constructor(t=[]){super(),this.isArrayCamera=!0,this.cameras=t}}class Da extends Oi{constructor(){super(),this.isGroup=!0,this.type="Group"}}const La={type:"move"};class Oa{constructor(){this._targetRay=null,this._grip=null,this._hand=null}getHandSpace(){return null===this._hand&&(this._hand=new Da,this._hand.matrixAutoUpdate=!1,this._hand.visible=!1,this._hand.joints={},this._hand.inputState={pinching:!1}),this._hand}getTargetRaySpace(){return null===this._targetRay&&(this._targetRay=new Da,this._targetRay.matrixAutoUpdate=!1,this._targetRay.visible=!1,this._targetRay.hasLinearVelocity=!1,this._targetRay.linearVelocity=new Le,this._targetRay.hasAngularVelocity=!1,this._targetRay.angularVelocity=new Le),this._targetRay}getGripSpace(){return null===this._grip&&(this._grip=new Da,this._grip.matrixAutoUpdate=!1,this._grip.visible=!1,this._grip.hasLinearVelocity=!1,this._grip.linearVelocity=new Le,this._grip.hasAngularVelocity=!1,this._grip.angularVelocity=new Le),this._grip}dispatchEvent(t){return null!==this._targetRay&&this._targetRay.dispatchEvent(t),null!==this._grip&&this._grip.dispatchEvent(t),null!==this._hand&&this._hand.dispatchEvent(t),this}connect(t){if(t&&t.hand){const e=this._hand;if(e)for(const i of t.hand.values())this._getHandJoint(e,i)}return this.dispatchEvent({type:"connected",data:t}),this}disconnect(t){return this.dispatchEvent({type:"disconnected",data:t}),null!==this._targetRay&&(this._targetRay.visible=!1),null!==this._grip&&(this._grip.visible=!1),null!==this._hand&&(this._hand.visible=!1),this}update(t,e,i){let n=null,s=null,r=null;const a=this._targetRay,o=this._grip,h=this._hand;if(t&&"visible-blurred"!==e.session.visibilityState){if(h&&t.hand){r=!0;for(const n of t.hand.values()){const t=e.getJointPose(n,i),s=this._getHandJoint(h,n);null!==t&&(s.matrix.fromArray(t.transform.matrix),s.matrix.decompose(s.position,s.rotation,s.scale),s.matrixWorldNeedsUpdate=!0,s.jointRadius=t.radius),s.visible=null!==t}const n=h.joints["index-finger-tip"],s=h.joints["thumb-tip"],a=n.position.distanceTo(s.position),o=.02,l=.005;h.inputState.pinching&&a>o+l?(h.inputState.pinching=!1,this.dispatchEvent({type:"pinchend",handedness:t.handedness,target:this})):!h.inputState.pinching&&a<=o-l&&(h.inputState.pinching=!0,this.dispatchEvent({type:"pinchstart",handedness:t.handedness,target:this}))}else null!==o&&t.gripSpace&&(s=e.getPose(t.gripSpace,i),null!==s&&(o.matrix.fromArray(s.transform.matrix),o.matrix.decompose(o.position,o.rotation,o.scale),o.matrixWorldNeedsUpdate=!0,s.linearVelocity?(o.hasLinearVelocity=!0,o.linearVelocity.copy(s.linearVelocity)):o.hasLinearVelocity=!1,s.angularVelocity?(o.hasAngularVelocity=!0,o.angularVelocity.copy(s.angularVelocity)):o.hasAngularVelocity=!1));null!==a&&(n=e.getPose(t.targetRaySpace,i),null===n&&null!==s&&(n=s),null!==n&&(a.matrix.fromArray(n.transform.matrix),a.matrix.decompose(a.position,a.rotation,a.scale),a.matrixWorldNeedsUpdate=!0,n.linearVelocity?(a.hasLinearVelocity=!0,a.linearVelocity.copy(n.linearVelocity)):a.hasLinearVelocity=!1,n.angularVelocity?(a.hasAngularVelocity=!0,a.angularVelocity.copy(n.angularVelocity)):a.hasAngularVelocity=!1,this.dispatchEvent(La)))}return null!==a&&(a.visible=null!==n),null!==o&&(o.visible=null!==s),null!==h&&(h.visible=null!==r),this}_getHandJoint(t,e){if(void 0===t.joints[e.jointName]){const i=new Da;i.matrixAutoUpdate=!1,i.visible=!1,t.joints[e.jointName]=i,t.add(i)}return t.joints[e.jointName]}}class Na extends jt{constructor(t,e){super();const i=this;let n=null,s=1,r=null,a="local-floor",o=1,h=null,l=null,c=null,u=null,d=null,p=null;const m=e.getContextAttributes();let f=null,g=null;const v=[],y=[],x=new se;let b=null;const _=new jn;_.layers.enable(1),_.viewport=new Ce;const w=new jn;w.layers.enable(2),w.viewport=new Ce;const M=[_,w],S=new Pa;S.layers.enable(1),S.layers.enable(2);let E=null,T=null;function A(t){const e=y.indexOf(t.inputSource);if(-1===e)return;const i=v[e];void 0!==i&&(i.update(t.inputSource,t.frame,h||r),i.dispatchEvent({type:t.type,data:t.inputSource}))}function C(){n.removeEventListener("select",A),n.removeEventListener("selectstart",A),n.removeEventListener("selectend",A),n.removeEventListener("squeeze",A),n.removeEventListener("squeezestart",A),n.removeEventListener("squeezeend",A),n.removeEventListener("end",C),n.removeEventListener("inputsourceschange",I);for(let t=0;t<v.length;t++){const e=y[t];null!==e&&(y[t]=null,v[t].disconnect(e))}E=null,T=null,t.setRenderTarget(f),d=null,u=null,c=null,n=null,g=null,L.stop(),i.isPresenting=!1,t.setPixelRatio(b),t.setSize(x.width,x.height,!1),i.dispatchEvent({type:"sessionend"})}function I(t){for(let e=0;e<t.removed.length;e++){const i=t.removed[e],n=y.indexOf(i);n>=0&&(y[n]=null,v[n].disconnect(i))}for(let e=0;e<t.added.length;e++){const i=t.added[e];let n=y.indexOf(i);if(-1===n){for(let t=0;t<v.length;t++){if(t>=y.length){y.push(i),n=t;break}if(null===y[t]){y[t]=i,n=t;break}}if(-1===n)break}const s=v[n];s&&s.connect(i)}}this.cameraAutoUpdate=!0,this.enabled=!1,this.isPresenting=!1,this.getController=function(t){let e=v[t];return void 0===e&&(e=new Oa,v[t]=e),e.getTargetRaySpace()},this.getControllerGrip=function(t){let e=v[t];return void 0===e&&(e=new Oa,v[t]=e),e.getGripSpace()},this.getHand=function(t){let e=v[t];return void 0===e&&(e=new Oa,v[t]=e),e.getHandSpace()},this.setFramebufferScaleFactor=function(t){s=t,i.isPresenting},this.setReferenceSpaceType=function(t){a=t,i.isPresenting},this.getReferenceSpace=function(){return h||r},this.setReferenceSpace=function(t){h=t},this.getBaseLayer=function(){return null!==u?u:d},this.getBinding=function(){return c},this.getFrame=function(){return p},this.getSession=function(){return n},this.setSession=async function(l){if(n=l,null!==n){if(f=t.getRenderTarget(),n.addEventListener("select",A),n.addEventListener("selectstart",A),n.addEventListener("selectend",A),n.addEventListener("squeeze",A),n.addEventListener("squeezestart",A),n.addEventListener("squeezeend",A),n.addEventListener("end",C),n.addEventListener("inputsourceschange",I),!0!==m.xrCompatible&&await e.makeXRCompatible(),b=t.getPixelRatio(),t.getSize(x),void 0===n.renderState.layers||!1===t.capabilities.isWebGL2){const i={antialias:void 0!==n.renderState.layers||m.antialias,alpha:!0,depth:m.depth,stencil:m.stencil,framebufferScaleFactor:s};d=new XRWebGLLayer(n,e,i),n.updateRenderState({baseLayer:d}),t.setPixelRatio(1),t.setSize(d.framebufferWidth,d.framebufferHeight,!1),g=new Re(d.framebufferWidth,d.framebufferHeight,{format:ct,type:nt,colorSpace:t.outputColorSpace,stencilBuffer:m.stencil})}else{let i=null,r=null,a=null;m.depth&&(a=m.stencil?e.DEPTH24_STENCIL8:e.DEPTH_COMPONENT24,i=m.stencil?dt:ut,r=m.stencil?lt:at);const o={colorFormat:e.RGBA8,depthFormat:a,scaleFactor:s};c=new XRWebGLBinding(n,e),u=c.createProjectionLayer(o),n.updateRenderState({layers:[u]}),t.setPixelRatio(1),t.setSize(u.textureWidth,u.textureHeight,!1),g=new Re(u.textureWidth,u.textureHeight,{format:ct,type:nt,depthTexture:new Gs(u.textureWidth,u.textureHeight,r,void 0,void 0,void 0,void 0,void 0,void 0,i),stencilBuffer:m.stencil,colorSpace:t.outputColorSpace,samples:m.antialias?4:0});t.properties.get(g).__ignoreDepthValues=u.ignoreDepthValues}g.isXRRenderTarget=!0,this.setFoveation(o),h=null,r=await n.requestReferenceSpace(a),L.setContext(n),L.start(),i.isPresenting=!0,i.dispatchEvent({type:"sessionstart"})}},this.getEnvironmentBlendMode=function(){if(null!==n)return n.environmentBlendMode};const R=new Le,k=new Le;function P(t,e){null===e?t.matrixWorld.copy(t.matrix):t.matrixWorld.multiplyMatrices(e.matrixWorld,t.matrix),t.matrixWorldInverse.copy(t.matrixWorld).invert()}this.updateCamera=function(t){if(null===n)return;S.near=w.near=_.near=t.near,S.far=w.far=_.far=t.far,E===S.near&&T===S.far||(n.updateRenderState({depthNear:S.near,depthFar:S.far}),E=S.near,T=S.far);const e=t.parent,i=S.cameras;P(S,e);for(let t=0;t<i.length;t++)P(i[t],e);2===i.length?function(t,e,i){R.setFromMatrixPosition(e.matrixWorld),k.setFromMatrixPosition(i.matrixWorld);const n=R.distanceTo(k),s=e.projectionMatrix.elements,r=i.projectionMatrix.elements,a=s[14]/(s[10]-1),o=s[14]/(s[10]+1),h=(s[9]+1)/s[5],l=(s[9]-1)/s[5],c=(s[8]-1)/s[0],u=(r[8]+1)/r[0],d=a*c,p=a*u,m=n/(-c+u),f=m*-c;e.matrixWorld.decompose(t.position,t.quaternion,t.scale),t.translateX(f),t.translateZ(m),t.matrixWorld.compose(t.position,t.quaternion,t.scale),t.matrixWorldInverse.copy(t.matrixWorld).invert();const g=a+m,v=o+m,y=d-f,x=p+(n-f),b=h*o/v*g,_=l*o/v*g;t.projectionMatrix.makePerspective(y,x,b,_,g,v),t.projectionMatrixInverse.copy(t.projectionMatrix).invert()}(S,_,w):S.projectionMatrix.copy(_.projectionMatrix),function(t,e,i){null===i?t.matrix.copy(e.matrixWorld):(t.matrix.copy(i.matrixWorld),t.matrix.invert(),t.matrix.multiply(e.matrixWorld));t.matrix.decompose(t.position,t.quaternion,t.scale),t.updateMatrixWorld(!0),t.projectionMatrix.copy(e.projectionMatrix),t.projectionMatrixInverse.copy(e.projectionMatrixInverse),t.isPerspectiveCamera&&(t.fov=2*Yt*Math.atan(1/t.projectionMatrix.elements[5]),t.zoom=1)}(t,S,e)},this.getCamera=function(){return S},this.getFoveation=function(){if(null!==u||null!==d)return o},this.setFoveation=function(t){o=t,null!==u&&(u.fixedFoveation=t),null!==d&&void 0!==d.fixedFoveation&&(d.fixedFoveation=t)};let D=null;const L=new is;L.setAnimationLoop((function(e,n){if(l=n.getViewerPose(h||r),p=n,null!==l){const e=l.views;null!==d&&(t.setRenderTargetFramebuffer(g,d.framebuffer),t.setRenderTarget(g));let i=!1;e.length!==S.cameras.length&&(S.cameras.length=0,i=!0);for(let n=0;n<e.length;n++){const s=e[n];let r=null;if(null!==d)r=d.getViewport(s);else{const e=c.getViewSubImage(u,s);r=e.viewport,0===n&&(t.setRenderTargetTextures(g,e.colorTexture,u.ignoreDepthValues?void 0:e.depthStencilTexture),t.setRenderTarget(g))}let a=M[n];void 0===a&&(a=new jn,a.layers.enable(n),a.viewport=new Ce,M[n]=a),a.matrix.fromArray(s.transform.matrix),a.matrix.decompose(a.position,a.quaternion,a.scale),a.projectionMatrix.fromArray(s.projectionMatrix),a.projectionMatrixInverse.copy(a.projectionMatrix).invert(),a.viewport.set(r.x,r.y,r.width,r.height),0===n&&(S.matrix.copy(a.matrix),S.matrix.decompose(S.position,S.quaternion,S.scale)),!0===i&&S.cameras.push(a)}}for(let t=0;t<v.length;t++){const e=y[t],i=v[t];null!==e&&void 0!==i&&i.update(e,n,h||r)}D&&D(e,n),n.detectedPlanes&&i.dispatchEvent({type:"planesdetected",data:n}),p=null})),this.setAnimationLoop=function(t){D=t},this.dispose=function(){}}}function Ba(t,e){function i(t,e){!0===t.matrixAutoUpdate&&t.updateMatrix(),e.value.copy(t.matrix)}function n(n,s){n.opacity.value=s.opacity,s.color&&n.diffuse.value.copy(s.color),s.emissive&&n.emissive.value.copy(s.emissive).multiplyScalar(s.emissiveIntensity),s.map&&(n.map.value=s.map,i(s.map,n.mapTransform)),s.alphaMap&&(n.alphaMap.value=s.alphaMap,i(s.alphaMap,n.alphaMapTransform)),s.bumpMap&&(n.bumpMap.value=s.bumpMap,i(s.bumpMap,n.bumpMapTransform),n.bumpScale.value=s.bumpScale,s.side===R&&(n.bumpScale.value*=-1)),s.normalMap&&(n.normalMap.value=s.normalMap,i(s.normalMap,n.normalMapTransform),n.normalScale.value.copy(s.normalScale),s.side===R&&n.normalScale.value.negate()),s.displacementMap&&(n.displacementMap.value=s.displacementMap,i(s.displacementMap,n.displacementMapTransform),n.displacementScale.value=s.displacementScale,n.displacementBias.value=s.displacementBias),s.emissiveMap&&(n.emissiveMap.value=s.emissiveMap,i(s.emissiveMap,n.emissiveMapTransform)),s.specularMap&&(n.specularMap.value=s.specularMap,i(s.specularMap,n.specularMapTransform)),s.alphaTest>0&&(n.alphaTest.value=s.alphaTest);const r=e.get(s).envMap;if(r&&(n.envMap.value=r,n.flipEnvMap.value=r.isCubeTexture&&!1===r.isRenderTargetTexture?-1:1,n.reflectivity.value=s.reflectivity,n.ior.value=s.ior,n.refractionRatio.value=s.refractionRatio),s.lightMap){n.lightMap.value=s.lightMap;const e=!0===t._useLegacyLights?Math.PI:1;n.lightMapIntensity.value=s.lightMapIntensity*e,i(s.lightMap,n.lightMapTransform)}s.aoMap&&(n.aoMap.value=s.aoMap,n.aoMapIntensity.value=s.aoMapIntensity,i(s.aoMap,n.aoMapTransform))}return{refreshFogUniforms:function(e,i){i.color.getRGB(e.fogColor.value,Fn(t)),i.isFog?(e.fogNear.value=i.near,e.fogFar.value=i.far):i.isFogExp2&&(e.fogDensity.value=i.density)},refreshMaterialUniforms:function(t,s,r,a,o){s.isMeshBasicMaterial||s.isMeshLambertMaterial?n(t,s):s.isMeshToonMaterial?(n(t,s),function(t,e){e.gradientMap&&(t.gradientMap.value=e.gradientMap)}(t,s)):s.isMeshPhongMaterial?(n(t,s),function(t,e){t.specular.value.copy(e.specular),t.shininess.value=Math.max(e.shininess,1e-4)}(t,s)):s.isMeshStandardMaterial?(n(t,s),function(t,n){t.metalness.value=n.metalness,n.metalnessMap&&(t.metalnessMap.value=n.metalnessMap,i(n.metalnessMap,t.metalnessMapTransform));t.roughness.value=n.roughness,n.roughnessMap&&(t.roughnessMap.value=n.roughnessMap,i(n.roughnessMap,t.roughnessMapTransform));const s=e.get(n).envMap;s&&(t.envMapIntensity.value=n.envMapIntensity)}(t,s),s.isMeshPhysicalMaterial&&function(t,e,n){t.ior.value=e.ior,e.sheen>0&&(t.sheenColor.value.copy(e.sheenColor).multiplyScalar(e.sheen),t.sheenRoughness.value=e.sheenRoughness,e.sheenColorMap&&(t.sheenColorMap.value=e.sheenColorMap,i(e.sheenColorMap,t.sheenColorMapTransform)),e.sheenRoughnessMap&&(t.sheenRoughnessMap.value=e.sheenRoughnessMap,i(e.sheenRoughnessMap,t.sheenRoughnessMapTransform)));e.clearcoat>0&&(t.clearcoat.value=e.clearcoat,t.clearcoatRoughness.value=e.clearcoatRoughness,e.clearcoatMap&&(t.clearcoatMap.value=e.clearcoatMap,i(e.clearcoatMap,t.clearcoatMapTransform)),e.clearcoatRoughnessMap&&(t.clearcoatRoughnessMap.value=e.clearcoatRoughnessMap,i(e.clearcoatRoughnessMap,t.clearcoatRoughnessMapTransform)),e.clearcoatNormalMap&&(t.clearcoatNormalMap.value=e.clearcoatNormalMap,i(e.clearcoatNormalMap,t.clearcoatNormalMapTransform),t.clearcoatNormalScale.value.copy(e.clearcoatNormalScale),e.side===R&&t.clearcoatNormalScale.value.negate()));e.iridescence>0&&(t.iridescence.value=e.iridescence,t.iridescenceIOR.value=e.iridescenceIOR,t.iridescenceThicknessMinimum.value=e.iridescenceThicknessRange[0],t.iridescenceThicknessMaximum.value=e.iridescenceThicknessRange[1],e.iridescenceMap&&(t.iridescenceMap.value=e.iridescenceMap,i(e.iridescenceMap,t.iridescenceMapTransform)),e.iridescenceThicknessMap&&(t.iridescenceThicknessMap.value=e.iridescenceThicknessMap,i(e.iridescenceThicknessMap,t.iridescenceThicknessMapTransform)));e.transmission>0&&(t.transmission.value=e.transmission,t.transmissionSamplerMap.value=n.texture,t.transmissionSamplerSize.value.set(n.width,n.height),e.transmissionMap&&(t.transmissionMap.value=e.transmissionMap,i(e.transmissionMap,t.transmissionMapTransform)),t.thickness.value=e.thickness,e.thicknessMap&&(t.thicknessMap.value=e.thicknessMap,i(e.thicknessMap,t.thicknessMapTransform)),t.attenuationDistance.value=e.attenuationDistance,t.attenuationColor.value.copy(e.attenuationColor));e.anisotropy>0&&(t.anisotropyVector.value.set(e.anisotropy*Math.cos(e.anisotropyRotation),e.anisotropy*Math.sin(e.anisotropyRotation)),e.anisotropyMap&&(t.anisotropyMap.value=e.anisotropyMap,i(e.anisotropyMap,t.anisotropyMapTransform)));t.specularIntensity.value=e.specularIntensity,t.specularColor.value.copy(e.specularColor),e.specularColorMap&&(t.specularColorMap.value=e.specularColorMap,i(e.specularColorMap,t.specularColorMapTransform));e.specularIntensityMap&&(t.specularIntensityMap.value=e.specularIntensityMap,i(e.specularIntensityMap,t.specularIntensityMapTransform))}(t,s,o)):s.isMeshMatcapMaterial?(n(t,s),function(t,e){e.matcap&&(t.matcap.value=e.matcap)}(t,s)):s.isMeshDepthMaterial?n(t,s):s.isMeshDistanceMaterial?(n(t,s),function(t,i){const n=e.get(i).light;t.referencePosition.value.setFromMatrixPosition(n.matrixWorld),t.nearDistance.value=n.shadow.camera.near,t.farDistance.value=n.shadow.camera.far}(t,s)):s.isMeshNormalMaterial?n(t,s):s.isLineBasicMaterial?(function(t,e){t.diffuse.value.copy(e.color),t.opacity.value=e.opacity,e.map&&(t.map.value=e.map,i(e.map,t.mapTransform))}(t,s),s.isLineDashedMaterial&&function(t,e){t.dashSize.value=e.dashSize,t.totalSize.value=e.dashSize+e.gapSize,t.scale.value=e.scale}(t,s)):s.isPointsMaterial?function(t,e,n,s){t.diffuse.value.copy(e.color),t.opacity.value=e.opacity,t.size.value=e.size*n,t.scale.value=.5*s,e.map&&(t.map.value=e.map,i(e.map,t.uvTransform));e.alphaMap&&(t.alphaMap.value=e.alphaMap,i(e.alphaMap,t.alphaMapTransform));e.alphaTest>0&&(t.alphaTest.value=e.alphaTest)}(t,s,r,a):s.isSpriteMaterial?function(t,e){t.diffuse.value.copy(e.color),t.opacity.value=e.opacity,t.rotation.value=e.rotation,e.map&&(t.map.value=e.map,i(e.map,t.mapTransform));e.alphaMap&&(t.alphaMap.value=e.alphaMap,i(e.alphaMap,t.alphaMapTransform));e.alphaTest>0&&(t.alphaTest.value=e.alphaTest)}(t,s):s.isShadowMaterial?(t.color.value.copy(s.color),t.opacity.value=s.opacity):s.isShaderMaterial&&(s.uniformsNeedUpdate=!1)}}}function za(t,e,i,n){let s={},r={},a=[];const o=i.isWebGL2?t.getParameter(t.MAX_UNIFORM_BUFFER_BINDINGS):0;function h(t,e,i,n){const s=t.value,r=e+"_"+i;if(void 0===n[r])return n[r]="number"==typeof s||"boolean"==typeof s?s:s.clone(),!0;{const t=n[r];if("number"==typeof s||"boolean"==typeof s){if(t!==s)return n[r]=s,!0}else if(!1===t.equals(s))return t.copy(s),!0}return!1}function l(t){const e={boundary:0,storage:0};return"number"==typeof t||"boolean"==typeof t?(e.boundary=4,e.storage=4):t.isVector2?(e.boundary=8,e.storage=8):t.isVector3||t.isColor?(e.boundary=16,e.storage=12):t.isVector4?(e.boundary=16,e.storage=16):t.isMatrix3?(e.boundary=48,e.storage=48):t.isMatrix4?(e.boundary=64,e.storage=64):t.isTexture,e}function c(e){const i=e.target;i.removeEventListener("dispose",c);const n=a.indexOf(i.__bindingPointIndex);a.splice(n,1),t.deleteBuffer(s[i.id]),delete s[i.id],delete r[i.id]}return{bind:function(t,e){const i=e.program;n.uniformBlockBinding(t,i)},update:function(i,u){let d=s[i.id];void 0===d&&(!function(t){const e=t.uniforms;let i=0;const n=16;for(let t=0,s=e.length;t<s;t++){const s=Array.isArray(e[t])?e[t]:[e[t]];for(let t=0,e=s.length;t<e;t++){const e=s[t],r=Array.isArray(e.value)?e.value:[e.value];for(let t=0,s=r.length;t<s;t++){const s=l(r[t]),a=i%n;0!==a&&n-a<s.boundary&&(i+=n-a),e.__data=new Float32Array(s.storage/Float32Array.BYTES_PER_ELEMENT),e.__offset=i,i+=s.storage}}}const s=i%n;s>0&&(i+=n-s);t.__size=i,t.__cache={}}(i),d=function(e){const i=function(){for(let t=0;t<o;t++)if(-1===a.indexOf(t))return a.push(t),t;return 0}();e.__bindingPointIndex=i;const n=t.createBuffer(),s=e.__size,r=e.usage;return t.bindBuffer(t.UNIFORM_BUFFER,n),t.bufferData(t.UNIFORM_BUFFER,s,r),t.bindBuffer(t.UNIFORM_BUFFER,null),t.bindBufferBase(t.UNIFORM_BUFFER,i,n),n}(i),s[i.id]=d,i.addEventListener("dispose",c));const p=u.program;n.updateUBOMapping(i,p);const m=e.render.frame;r[i.id]!==m&&(!function(e){const i=s[e.id],n=e.uniforms,r=e.__cache;t.bindBuffer(t.UNIFORM_BUFFER,i);for(let e=0,i=n.length;e<i;e++){const i=Array.isArray(n[e])?n[e]:[n[e]];for(let n=0,s=i.length;n<s;n++){const s=i[n];if(!0===h(s,e,n,r)){const e=s.__offset,i=Array.isArray(s.value)?s.value:[s.value];let n=0;for(let r=0;r<i.length;r++){const a=i[r],o=l(a);"number"==typeof a||"boolean"==typeof a?(s.__data[0]=a,t.bufferSubData(t.UNIFORM_BUFFER,e+n,s.__data)):a.isMatrix3?(s.__data[0]=a.elements[0],s.__data[1]=a.elements[1],s.__data[2]=a.elements[2],s.__data[3]=0,s.__data[4]=a.elements[3],s.__data[5]=a.elements[4],s.__data[6]=a.elements[5],s.__data[7]=0,s.__data[8]=a.elements[6],s.__data[9]=a.elements[7],s.__data[10]=a.elements[8],s.__data[11]=0):(a.toArray(s.__data,n),n+=o.storage/Float32Array.BYTES_PER_ELEMENT)}t.bufferSubData(t.UNIFORM_BUFFER,e,s.__data)}}}t.bindBuffer(t.UNIFORM_BUFFER,null)}(i),r[i.id]=m)},dispose:function(){for(const e in s)t.deleteBuffer(s[e]);a=[],s={},r={}}}}class Ua{constructor(t={}){const{canvas:e=ue(),context:i=null,depth:n=!0,stencil:s=!0,alpha:r=!1,antialias:a=!1,premultipliedAlpha:o=!0,preserveDrawingBuffer:h=!1,powerPreference:l="default",failIfMajorPerformanceCaveat:c=!1}=t;let u;this.isWebGLRenderer=!0,u=null!==i?i.getContextAttributes().alpha:r;const d=new Uint32Array(4),p=new Int32Array(4);let m=null,f=null;const g=[],v=[];this.domElement=e,this.debug={checkShaderErrors:!0,onShaderError:null},this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this._outputColorSpace=It,this._useLegacyLights=!1,this.toneMapping=O,this.toneMappingExposure=1;const x=this;let b=!1,_=0,w=0,M=null,S=-1,E=null;const T=new Ce,A=new Ce;let C=null;const k=new Zi(0);let P=0,D=e.width,L=e.height,N=1,B=null,z=null;const U=new Ce(0,0,D,L),F=new Ce(0,0,D,L);let G=!1;const V=new es;let H=!1,j=!1,W=null;const X=new ci,q=new se,Y=new Le,J={background:null,fog:null,environment:null,overrideMaterial:null,isScene:!0};function $(){return null===M?N:1}let K,Z,Q,tt,et,rt,ut,dt,pt,mt,ft,gt,vt,yt,xt,bt,_t,wt,Mt,St,Et,Tt,At,Ct,kt=i;function Pt(t,i){for(let n=0;n<t.length;n++){const s=t[n],r=e.getContext(s,i);if(null!==r)return r}return null}try{const t={alpha:!0,depth:n,stencil:s,antialias:a,premultipliedAlpha:o,preserveDrawingBuffer:h,powerPreference:l,failIfMajorPerformanceCaveat:c};if("setAttribute"in e&&e.setAttribute("data-engine",`three.js r${y}`),e.addEventListener("webglcontextlost",Ot,!1),e.addEventListener("webglcontextrestored",Nt,!1),e.addEventListener("webglcontextcreationerror",Bt,!1),null===kt){const e=["webgl2","webgl","experimental-webgl"];if(!0===x.isWebGL1Renderer&&e.shift(),kt=Pt(e,t),null===kt)throw Pt(e)?new Error("Error creating WebGL context with your selected attributes."):new Error("Error creating WebGL context.")}"undefined"!=typeof WebGLRenderingContext&&WebGLRenderingContext,void 0===kt.getShaderPrecisionFormat&&(kt.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}})}catch(t){throw t}function Dt(){K=new Ds(kt),Z=new ds(kt,K,t),K.init(Z),Tt=new ka(kt,K,Z),Q=new Ia(kt,K,Z),tt=new Ns(kt),et=new fa,rt=new Ra(kt,K,Q,et,Z,Tt,tt),ut=new ms(x),dt=new Ps(x),pt=new ns(kt,Z),At=new cs(kt,K,pt,Z),mt=new Ls(kt,pt,tt,At),ft=new Fs(kt,mt,pt,tt),Mt=new Us(kt,Z,rt),bt=new ps(et),gt=new ma(x,ut,dt,K,Z,At,bt),vt=new Ba(x,et),yt=new xa,xt=new Ea(K,Z),wt=new ls(x,ut,dt,Q,ft,u,o),_t=new Ca(x,ft,Z),Ct=new za(kt,tt,Z,Q),St=new us(kt,K,tt,Z),Et=new Os(kt,K,tt,Z),tt.programs=gt.programs,x.capabilities=Z,x.extensions=K,x.properties=et,x.renderLists=yt,x.shadowMap=_t,x.state=Q,x.info=tt}Dt();const Lt=new Na(x,kt);function Ot(t){t.preventDefault(),b=!0}function Nt(){b=!1;const t=tt.autoReset,e=_t.enabled,i=_t.autoUpdate,n=_t.needsUpdate,s=_t.type;Dt(),tt.autoReset=t,_t.enabled=e,_t.autoUpdate=i,_t.needsUpdate=n,_t.type=s}function Bt(t){}function zt(t){const e=t.target;e.removeEventListener("dispose",zt),function(t){(function(t){const e=et.get(t).programs;void 0!==e&&(e.forEach((function(t){gt.releaseProgram(t)})),t.isShaderMaterial&&gt.releaseShaderCache(t))})(t),et.remove(t)}(e)}function Ut(t,e,i){!0===t.transparent&&2===t.side&&!1===t.forceSinglePass?(t.side=R,t.needsUpdate=!0,Yt(t,e,i),t.side=I,t.needsUpdate=!0,Yt(t,e,i),t.side=2):Yt(t,e,i)}this.xr=Lt,this.getContext=function(){return kt},this.getContextAttributes=function(){return kt.getContextAttributes()},this.forceContextLoss=function(){const t=K.get("WEBGL_lose_context");t&&t.loseContext()},this.forceContextRestore=function(){const t=K.get("WEBGL_lose_context");t&&t.restoreContext()},this.getPixelRatio=function(){return N},this.setPixelRatio=function(t){void 0!==t&&(N=t,this.setSize(D,L,!1))},this.getSize=function(t){return t.set(D,L)},this.setSize=function(t,i,n=!0){Lt.isPresenting||(D=t,L=i,e.width=Math.floor(t*N),e.height=Math.floor(i*N),!0===n&&(e.style.width=t+"px",e.style.height=i+"px"),this.setViewport(0,0,t,i))},this.getDrawingBufferSize=function(t){return t.set(D*N,L*N).floor()},this.setDrawingBufferSize=function(t,i,n){D=t,L=i,N=n,e.width=Math.floor(t*n),e.height=Math.floor(i*n),this.setViewport(0,0,t,i)},this.getCurrentViewport=function(t){return t.copy(T)},this.getViewport=function(t){return t.copy(U)},this.setViewport=function(t,e,i,n){t.isVector4?U.set(t.x,t.y,t.z,t.w):U.set(t,e,i,n),Q.viewport(T.copy(U).multiplyScalar(N).floor())},this.getScissor=function(t){return t.copy(F)},this.setScissor=function(t,e,i,n){t.isVector4?F.set(t.x,t.y,t.z,t.w):F.set(t,e,i,n),Q.scissor(A.copy(F).multiplyScalar(N).floor())},this.getScissorTest=function(){return G},this.setScissorTest=function(t){Q.setScissorTest(G=t)},this.setOpaqueSort=function(t){B=t},this.setTransparentSort=function(t){z=t},this.getClearColor=function(t){return t.copy(wt.getClearColor())},this.setClearColor=function(){wt.setClearColor.apply(wt,arguments)},this.getClearAlpha=function(){return wt.getClearAlpha()},this.setClearAlpha=function(){wt.setClearAlpha.apply(wt,arguments)},this.clear=function(t=!0,e=!0,i=!0){let n=0;if(t){let t=!1;if(null!==M){const e=M.texture.format;t=1033===e||1031===e||1029===e}if(t){const t=M.texture.type,e=t===nt||t===at||t===st||t===lt||1017===t||1018===t,i=wt.getClearColor(),n=wt.getClearAlpha(),s=i.r,r=i.g,a=i.b;e?(d[0]=s,d[1]=r,d[2]=a,d[3]=n,kt.clearBufferuiv(kt.COLOR,0,d)):(p[0]=s,p[1]=r,p[2]=a,p[3]=n,kt.clearBufferiv(kt.COLOR,0,p))}else n|=kt.COLOR_BUFFER_BIT}e&&(n|=kt.DEPTH_BUFFER_BIT),i&&(n|=kt.STENCIL_BUFFER_BIT,this.state.buffers.stencil.setMask(4294967295)),kt.clear(n)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.dispose=function(){e.removeEventListener("webglcontextlost",Ot,!1),e.removeEventListener("webglcontextrestored",Nt,!1),e.removeEventListener("webglcontextcreationerror",Bt,!1),yt.dispose(),xt.dispose(),et.dispose(),ut.dispose(),dt.dispose(),ft.dispose(),At.dispose(),Ct.dispose(),gt.dispose(),Lt.dispose(),Lt.removeEventListener("sessionstart",Gt),Lt.removeEventListener("sessionend",Vt),W&&(W.dispose(),W=null),Ht.stop()},this.renderBufferDirect=function(t,e,i,n,s,r){null===e&&(e=J);const a=s.isMesh&&s.matrixWorld.determinant()<0,o=function(t,e,i,n,s){!0!==e.isScene&&(e=J);rt.resetTextureUnits();const r=e.fog,a=n.isMeshStandardMaterial?e.environment:null,o=null===M?x.outputColorSpace:!0===M.isXRRenderTarget?M.texture.colorSpace:Rt,h=(n.isMeshStandardMaterial?dt:ut).get(n.envMap||a),l=!0===n.vertexColors&&!!i.attributes.color&&4===i.attributes.color.itemSize,c=!!i.attributes.tangent&&(!!n.normalMap||n.anisotropy>0),u=!!i.morphAttributes.position,d=!!i.morphAttributes.normal,p=!!i.morphAttributes.color;let m=O;n.toneMapped&&(null!==M&&!0!==M.isXRRenderTarget||(m=x.toneMapping));const g=i.morphAttributes.position||i.morphAttributes.normal||i.morphAttributes.color,v=void 0!==g?g.length:0,y=et.get(n),b=f.state.lights;if(!0===H&&(!0===j||t!==E)){const e=t===E&&n.id===S;bt.setState(n,t,e)}let _=!1;n.version===y.__version?y.needsLights&&y.lightsStateVersion!==b.state.version||y.outputColorSpace!==o||s.isBatchedMesh&&!1===y.batching?_=!0:s.isBatchedMesh||!0!==y.batching?s.isInstancedMesh&&!1===y.instancing?_=!0:s.isInstancedMesh||!0!==y.instancing?s.isSkinnedMesh&&!1===y.skinning?_=!0:s.isSkinnedMesh||!0!==y.skinning?s.isInstancedMesh&&!0===y.instancingColor&&null===s.instanceColor||s.isInstancedMesh&&!1===y.instancingColor&&null!==s.instanceColor||y.envMap!==h||!0===n.fog&&y.fog!==r?_=!0:void 0===y.numClippingPlanes||y.numClippingPlanes===bt.numPlanes&&y.numIntersection===bt.numIntersection?(y.vertexAlphas!==l||y.vertexTangents!==c||y.morphTargets!==u||y.morphNormals!==d||y.morphColors!==p||y.toneMapping!==m||!0===Z.isWebGL2&&y.morphTargetsCount!==v)&&(_=!0):_=!0:_=!0:_=!0:_=!0:(_=!0,y.__version=n.version);let w=y.currentProgram;!0===_&&(w=Yt(n,e,s));let T=!1,A=!1,C=!1;const I=w.getUniforms(),R=y.uniforms;Q.useProgram(w.program)&&(T=!0,A=!0,C=!0);n.id!==S&&(S=n.id,A=!0);if(T||E!==t){I.setValue(kt,"projectionMatrix",t.projectionMatrix),I.setValue(kt,"viewMatrix",t.matrixWorldInverse);const e=I.map.cameraPosition;void 0!==e&&e.setValue(kt,Y.setFromMatrixPosition(t.matrixWorld)),Z.logarithmicDepthBuffer&&I.setValue(kt,"logDepthBufFC",2/(Math.log(t.far+1)/Math.LN2)),(n.isMeshPhongMaterial||n.isMeshToonMaterial||n.isMeshLambertMaterial||n.isMeshBasicMaterial||n.isMeshStandardMaterial||n.isShaderMaterial)&&I.setValue(kt,"isOrthographic",!0===t.isOrthographicCamera),E!==t&&(E=t,A=!0,C=!0)}if(s.isSkinnedMesh){I.setOptional(kt,s,"bindMatrix"),I.setOptional(kt,s,"bindMatrixInverse");const t=s.skeleton;t&&Z.floatVertexTextures&&(null===t.boneTexture&&t.computeBoneTexture(),I.setValue(kt,"boneTexture",t.boneTexture,rt))}s.isBatchedMesh&&(I.setOptional(kt,s,"batchingTexture"),I.setValue(kt,"batchingTexture",s._matricesTexture,rt));const k=i.morphAttributes;(void 0!==k.position||void 0!==k.normal||void 0!==k.color&&!0===Z.isWebGL2)&&Mt.update(s,i,w);(A||y.receiveShadow!==s.receiveShadow)&&(y.receiveShadow=s.receiveShadow,I.setValue(kt,"receiveShadow",s.receiveShadow));n.isMeshGouraudMaterial&&null!==n.envMap&&(R.envMap.value=h,R.flipEnvMap.value=h.isCubeTexture&&!1===h.isRenderTargetTexture?-1:1);A&&(I.setValue(kt,"toneMappingExposure",x.toneMappingExposure),y.needsLights&&(D=C,(P=R).ambientLightColor.needsUpdate=D,P.lightProbe.needsUpdate=D,P.directionalLights.needsUpdate=D,P.directionalLightShadows.needsUpdate=D,P.pointLights.needsUpdate=D,P.pointLightShadows.needsUpdate=D,P.spotLights.needsUpdate=D,P.spotLightShadows.needsUpdate=D,P.rectAreaLights.needsUpdate=D,P.hemisphereLights.needsUpdate=D),r&&!0===n.fog&&vt.refreshFogUniforms(R,r),vt.refreshMaterialUniforms(R,n,N,L,W),Xr.upload(kt,Jt(y),R,rt));var P,D;n.isShaderMaterial&&!0===n.uniformsNeedUpdate&&(Xr.upload(kt,Jt(y),R,rt),n.uniformsNeedUpdate=!1);n.isSpriteMaterial&&I.setValue(kt,"center",s.center);if(I.setValue(kt,"modelViewMatrix",s.modelViewMatrix),I.setValue(kt,"normalMatrix",s.normalMatrix),I.setValue(kt,"modelMatrix",s.matrixWorld),n.isShaderMaterial||n.isRawShaderMaterial){const t=n.uniformsGroups;for(let e=0,i=t.length;e<i;e++)if(Z.isWebGL2){const i=t[e];Ct.update(i,w),Ct.bind(i,w)}}return w}(t,e,i,n,s);Q.setMaterial(n,a);let h=i.index,l=1;if(!0===n.wireframe){if(h=mt.getWireframeAttribute(i),void 0===h)return;l=2}const c=i.drawRange,u=i.attributes.position;let d=c.start*l,p=(c.start+c.count)*l;null!==r&&(d=Math.max(d,r.start*l),p=Math.min(p,(r.start+r.count)*l)),null!==h?(d=Math.max(d,0),p=Math.min(p,h.count)):null!=u&&(d=Math.max(d,0),p=Math.min(p,u.count));const m=p-d;if(m<0||m===1/0)return;let g;At.setup(s,n,o,i,h);let v=St;if(null!==h&&(g=pt.get(h),v=Et,v.setIndex(g)),s.isMesh)!0===n.wireframe?(Q.setLineWidth(n.wireframeLinewidth*$()),v.setMode(kt.LINES)):v.setMode(kt.TRIANGLES);else if(s.isLine){let t=n.linewidth;void 0===t&&(t=1),Q.setLineWidth(t*$()),s.isLineSegments?v.setMode(kt.LINES):s.isLineLoop?v.setMode(kt.LINE_LOOP):v.setMode(kt.LINE_STRIP)}else s.isPoints?v.setMode(kt.POINTS):s.isSprite&&v.setMode(kt.TRIANGLES);if(s.isBatchedMesh)v.renderMultiDraw(s._multiDrawStarts,s._multiDrawCounts,s._multiDrawCount);else if(s.isInstancedMesh)v.renderInstances(d,m,s.count);else if(i.isInstancedBufferGeometry){const t=void 0!==i._maxInstanceCount?i._maxInstanceCount:1/0,e=Math.min(i.instanceCount,t);v.renderInstances(d,m,e)}else v.render(d,m)},this.compile=function(t,e,i=null){null===i&&(i=t),f=xt.get(i),f.init(),v.push(f),i.traverseVisible((function(t){t.isLight&&t.layers.test(e.layers)&&(f.pushLight(t),t.castShadow&&f.pushShadow(t))})),t!==i&&t.traverseVisible((function(t){t.isLight&&t.layers.test(e.layers)&&(f.pushLight(t),t.castShadow&&f.pushShadow(t))})),f.setupLights(x._useLegacyLights);const n=new Set;return t.traverse((function(t){const e=t.material;if(e)if(Array.isArray(e))for(let s=0;s<e.length;s++){const r=e[s];Ut(r,i,t),n.add(r)}else Ut(e,i,t),n.add(e)})),v.pop(),f=null,n},this.compileAsync=function(t,e,i=null){const n=this.compile(t,e,i);return new Promise((e=>{function i(){n.forEach((function(t){et.get(t).currentProgram.isReady()&&n.delete(t)})),0!==n.size?setTimeout(i,10):e(t)}null!==K.get("KHR_parallel_shader_compile")?i():setTimeout(i,10)}))};let Ft=null;function Gt(){Ht.stop()}function Vt(){Ht.start()}const Ht=new is;function jt(t,e,i,n){if(!1===t.visible)return;if(t.layers.test(e.layers))if(t.isGroup)i=t.renderOrder;else if(t.isLOD)!0===t.autoUpdate&&t.update(e);else if(t.isLight)f.pushLight(t),t.castShadow&&f.pushShadow(t);else if(t.isSprite){if(!t.frustumCulled||V.intersectsSprite(t)){n&&Y.setFromMatrixPosition(t.matrixWorld).applyMatrix4(X);const e=ft.update(t),s=t.material;s.visible&&m.push(t,e,s,i,Y.z,null)}}else if((t.isMesh||t.isLine||t.isPoints)&&(!t.frustumCulled||V.intersectsObject(t))){const e=ft.update(t),s=t.material;if(n&&(void 0!==t.boundingSphere?(null===t.boundingSphere&&t.computeBoundingSphere(),Y.copy(t.boundingSphere.center)):(null===e.boundingSphere&&e.computeBoundingSphere(),Y.copy(e.boundingSphere.center)),Y.applyMatrix4(t.matrixWorld).applyMatrix4(X)),Array.isArray(s)){const n=e.groups;for(let r=0,a=n.length;r<a;r++){const a=n[r],o=s[a.materialIndex];o&&o.visible&&m.push(t,e,o,i,Y.z,a)}}else s.visible&&m.push(t,e,s,i,Y.z,null)}const s=t.children;for(let t=0,r=s.length;t<r;t++)jt(s[t],e,i,n)}function Wt(t,e,i,n){const s=t.opaque,r=t.transmissive,a=t.transparent;f.setupLightsView(i),!0===H&&bt.setGlobalState(x.clippingPlanes,i),r.length>0&&function(t,e,i,n){const s=!0===i.isScene?i.overrideMaterial:null;if(null!==s)return;const r=Z.isWebGL2;null===W&&(W=new Re(1,1,{generateMipmaps:!0,type:K.has("EXT_color_buffer_half_float")?ht:nt,minFilter:it,samples:r?4:0}));x.getDrawingBufferSize(q),r?W.setSize(q.x,q.y):W.setSize(te(q.x),te(q.y));const a=x.getRenderTarget();x.setRenderTarget(W),x.getClearColor(k),P=x.getClearAlpha(),P<1&&x.setClearColor(16777215,.5);x.clear();const o=x.toneMapping;x.toneMapping=O,Xt(t,i,n),rt.updateMultisampleRenderTarget(W),rt.updateRenderTargetMipmap(W);let h=!1;for(let t=0,s=e.length;t<s;t++){const s=e[t],r=s.object,a=s.geometry,o=s.material,l=s.group;if(2===o.side&&r.layers.test(n.layers)){const t=o.side;o.side=R,o.needsUpdate=!0,qt(r,i,n,a,o,l),o.side=t,o.needsUpdate=!0,h=!0}}!0===h&&(rt.updateMultisampleRenderTarget(W),rt.updateRenderTargetMipmap(W));x.setRenderTarget(a),x.setClearColor(k,P),x.toneMapping=o}(s,r,e,i),n&&Q.viewport(T.copy(n)),s.length>0&&Xt(s,e,i),r.length>0&&Xt(r,e,i),a.length>0&&Xt(a,e,i),Q.buffers.depth.setTest(!0),Q.buffers.depth.setMask(!0),Q.buffers.color.setMask(!0),Q.setPolygonOffset(!1)}function Xt(t,e,i){const n=!0===e.isScene?e.overrideMaterial:null;for(let s=0,r=t.length;s<r;s++){const r=t[s],a=r.object,o=r.geometry,h=null===n?r.material:n,l=r.group;a.layers.test(i.layers)&&qt(a,e,i,o,h,l)}}function qt(t,e,i,n,s,r){t.onBeforeRender(x,e,i,n,s,r),t.modelViewMatrix.multiplyMatrices(i.matrixWorldInverse,t.matrixWorld),t.normalMatrix.getNormalMatrix(t.modelViewMatrix),s.onBeforeRender(x,e,i,n,t,r),!0===s.transparent&&2===s.side&&!1===s.forceSinglePass?(s.side=R,s.needsUpdate=!0,x.renderBufferDirect(i,e,n,s,t,r),s.side=I,s.needsUpdate=!0,x.renderBufferDirect(i,e,n,s,t,r),s.side=2):x.renderBufferDirect(i,e,n,s,t,r),t.onAfterRender(x,e,i,n,s,r)}function Yt(t,e,i){!0!==e.isScene&&(e=J);const n=et.get(t),s=f.state.lights,r=f.state.shadowsArray,a=s.state.version,o=gt.getParameters(t,s.state,r,e,i),h=gt.getProgramCacheKey(o);let l=n.programs;n.environment=t.isMeshStandardMaterial?e.environment:null,n.fog=e.fog,n.envMap=(t.isMeshStandardMaterial?dt:ut).get(t.envMap||n.environment),void 0===l&&(t.addEventListener("dispose",zt),l=new Map,n.programs=l);let c=l.get(h);if(void 0!==c){if(n.currentProgram===c&&n.lightsStateVersion===a)return $t(t,o),c}else o.uniforms=gt.getUniforms(t),t.onBuild(i,o,x),t.onBeforeCompile(o,x),c=gt.acquireProgram(o,h),l.set(h,c),n.uniforms=o.uniforms;const u=n.uniforms;return(t.isShaderMaterial||t.isRawShaderMaterial)&&!0!==t.clipping||(u.clippingPlanes=bt.uniform),$t(t,o),n.needsLights=function(t){return t.isMeshLambertMaterial||t.isMeshToonMaterial||t.isMeshPhongMaterial||t.isMeshStandardMaterial||t.isShadowMaterial||t.isShaderMaterial&&!0===t.lights}(t),n.lightsStateVersion=a,n.needsLights&&(u.ambientLightColor.value=s.state.ambient,u.lightProbe.value=s.state.probe,u.directionalLights.value=s.state.directional,u.directionalLightShadows.value=s.state.directionalShadow,u.spotLights.value=s.state.spot,u.spotLightShadows.value=s.state.spotShadow,u.rectAreaLights.value=s.state.rectArea,u.ltc_1.value=s.state.rectAreaLTC1,u.ltc_2.value=s.state.rectAreaLTC2,u.pointLights.value=s.state.point,u.pointLightShadows.value=s.state.pointShadow,u.hemisphereLights.value=s.state.hemi,u.directionalShadowMap.value=s.state.directionalShadowMap,u.directionalShadowMatrix.value=s.state.directionalShadowMatrix,u.spotShadowMap.value=s.state.spotShadowMap,u.spotLightMatrix.value=s.state.spotLightMatrix,u.spotLightMap.value=s.state.spotLightMap,u.pointShadowMap.value=s.state.pointShadowMap,u.pointShadowMatrix.value=s.state.pointShadowMatrix),n.currentProgram=c,n.uniformsList=null,c}function Jt(t){if(null===t.uniformsList){const e=t.currentProgram.getUniforms();t.uniformsList=Xr.seqWithValue(e.seq,t.uniforms)}return t.uniformsList}function $t(t,e){const i=et.get(t);i.outputColorSpace=e.outputColorSpace,i.batching=e.batching,i.instancing=e.instancing,i.instancingColor=e.instancingColor,i.skinning=e.skinning,i.morphTargets=e.morphTargets,i.morphNormals=e.morphNormals,i.morphColors=e.morphColors,i.morphTargetsCount=e.morphTargetsCount,i.numClippingPlanes=e.numClippingPlanes,i.numIntersection=e.numClipIntersection,i.vertexAlphas=e.vertexAlphas,i.vertexTangents=e.vertexTangents,i.toneMapping=e.toneMapping}Ht.setAnimationLoop((function(t){Ft&&Ft(t)})),"undefined"!=typeof self&&Ht.setContext(self),this.setAnimationLoop=function(t){Ft=t,Lt.setAnimationLoop(t),null===t?Ht.stop():Ht.start()},Lt.addEventListener("sessionstart",Gt),Lt.addEventListener("sessionend",Vt),this.render=function(t,e){if(void 0!==e&&!0!==e.isCamera)return;if(!0===b)return;!0===t.matrixWorldAutoUpdate&&t.updateMatrixWorld(),null===e.parent&&!0===e.matrixWorldAutoUpdate&&e.updateMatrixWorld(),!0===Lt.enabled&&!0===Lt.isPresenting&&(!0===Lt.cameraAutoUpdate&&Lt.updateCamera(e),e=Lt.getCamera()),!0===t.isScene&&t.onBeforeRender(x,t,e,M),f=xt.get(t,v.length),f.init(),v.push(f),X.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse),V.setFromProjectionMatrix(X),j=this.localClippingEnabled,H=bt.init(this.clippingPlanes,j),m=yt.get(t,g.length),m.init(),g.push(m),jt(t,e,0,x.sortObjects),m.finish(),!0===x.sortObjects&&m.sort(B,z),this.info.render.frame++,!0===H&&bt.beginShadows();const i=f.state.shadowsArray;if(_t.render(i,t,e),!0===H&&bt.endShadows(),!0===this.info.autoReset&&this.info.reset(),wt.render(m,t),f.setupLights(x._useLegacyLights),e.isArrayCamera){const i=e.cameras;for(let e=0,n=i.length;e<n;e++){const n=i[e];Wt(m,t,n,n.viewport)}}else Wt(m,t,e);null!==M&&(rt.updateMultisampleRenderTarget(M),rt.updateRenderTargetMipmap(M)),!0===t.isScene&&t.onAfterRender(x,t,e),At.resetDefaultState(),S=-1,E=null,v.pop(),f=v.length>0?v[v.length-1]:null,g.pop(),m=g.length>0?g[g.length-1]:null},this.getActiveCubeFace=function(){return _},this.getActiveMipmapLevel=function(){return w},this.getRenderTarget=function(){return M},this.setRenderTargetTextures=function(t,e,i){et.get(t.texture).__webglTexture=e,et.get(t.depthTexture).__webglTexture=i;const n=et.get(t);n.__hasExternalTextures=!0,n.__hasExternalTextures&&(n.__autoAllocateDepthBuffer=void 0===i,n.__autoAllocateDepthBuffer||!0===K.has("WEBGL_multisampled_render_to_texture")&&(n.__useRenderToTexture=!1))},this.setRenderTargetFramebuffer=function(t,e){const i=et.get(t);i.__webglFramebuffer=e,i.__useDefaultFramebuffer=void 0===e},this.setRenderTarget=function(t,e=0,i=0){M=t,_=e,w=i;let n=!0,s=null,r=!1,a=!1;if(t){const o=et.get(t);void 0!==o.__useDefaultFramebuffer?(Q.bindFramebuffer(kt.FRAMEBUFFER,null),n=!1):void 0===o.__webglFramebuffer?rt.setupRenderTarget(t):o.__hasExternalTextures&&rt.rebindTextures(t,et.get(t.texture).__webglTexture,et.get(t.depthTexture).__webglTexture);const h=t.texture;(h.isData3DTexture||h.isDataArrayTexture||h.isCompressedArrayTexture)&&(a=!0);const l=et.get(t).__webglFramebuffer;t.isWebGLCubeRenderTarget?(s=Array.isArray(l[e])?l[e][i]:l[e],r=!0):s=Z.isWebGL2&&t.samples>0&&!1===rt.useMultisampledRTT(t)?et.get(t).__webglMultisampledFramebuffer:Array.isArray(l)?l[i]:l,T.copy(t.viewport),A.copy(t.scissor),C=t.scissorTest}else T.copy(U).multiplyScalar(N).floor(),A.copy(F).multiplyScalar(N).floor(),C=G;if(Q.bindFramebuffer(kt.FRAMEBUFFER,s)&&Z.drawBuffers&&n&&Q.drawBuffers(t,s),Q.viewport(T),Q.scissor(A),Q.setScissorTest(C),r){const n=et.get(t.texture);kt.framebufferTexture2D(kt.FRAMEBUFFER,kt.COLOR_ATTACHMENT0,kt.TEXTURE_CUBE_MAP_POSITIVE_X+e,n.__webglTexture,i)}else if(a){const n=et.get(t.texture),s=e||0;kt.framebufferTextureLayer(kt.FRAMEBUFFER,kt.COLOR_ATTACHMENT0,n.__webglTexture,i||0,s)}S=-1},this.readRenderTargetPixels=function(t,e,i,n,s,r,a){if(!t||!t.isWebGLRenderTarget)return;let o=et.get(t).__webglFramebuffer;if(t.isWebGLCubeRenderTarget&&void 0!==a&&(o=o[a]),o){Q.bindFramebuffer(kt.FRAMEBUFFER,o);try{const a=t.texture,o=a.format,h=a.type;if(o!==ct&&Tt.convert(o)!==kt.getParameter(kt.IMPLEMENTATION_COLOR_READ_FORMAT))return;const l=h===ht&&(K.has("EXT_color_buffer_half_float")||Z.isWebGL2&&K.has("EXT_color_buffer_float"));if(!(h===nt||Tt.convert(h)===kt.getParameter(kt.IMPLEMENTATION_COLOR_READ_TYPE)||h===ot&&(Z.isWebGL2||K.has("OES_texture_float")||K.has("WEBGL_color_buffer_float"))||l))return;e>=0&&e<=t.width-n&&i>=0&&i<=t.height-s&&kt.readPixels(e,i,n,s,Tt.convert(o),Tt.convert(h),r)}finally{const t=null!==M?et.get(M).__webglFramebuffer:null;Q.bindFramebuffer(kt.FRAMEBUFFER,t)}}},this.copyFramebufferToTexture=function(t,e,i=0){const n=Math.pow(2,-i),s=Math.floor(e.image.width*n),r=Math.floor(e.image.height*n);rt.setTexture2D(e,0),kt.copyTexSubImage2D(kt.TEXTURE_2D,i,0,0,t.x,t.y,s,r),Q.unbindTexture()},this.copyTextureToTexture=function(t,e,i,n=0){const s=e.image.width,r=e.image.height,a=Tt.convert(i.format),o=Tt.convert(i.type);rt.setTexture2D(i,0),kt.pixelStorei(kt.UNPACK_FLIP_Y_WEBGL,i.flipY),kt.pixelStorei(kt.UNPACK_PREMULTIPLY_ALPHA_WEBGL,i.premultiplyAlpha),kt.pixelStorei(kt.UNPACK_ALIGNMENT,i.unpackAlignment),e.isDataTexture?kt.texSubImage2D(kt.TEXTURE_2D,n,t.x,t.y,s,r,a,o,e.image.data):e.isCompressedTexture?kt.compressedTexSubImage2D(kt.TEXTURE_2D,n,t.x,t.y,e.mipmaps[0].width,e.mipmaps[0].height,a,e.mipmaps[0].data):kt.texSubImage2D(kt.TEXTURE_2D,n,t.x,t.y,a,o,e.image),0===n&&i.generateMipmaps&&kt.generateMipmap(kt.TEXTURE_2D),Q.unbindTexture()},this.copyTextureToTexture3D=function(t,e,i,n,s=0){if(x.isWebGL1Renderer)return;const r=t.max.x-t.min.x+1,a=t.max.y-t.min.y+1,o=t.max.z-t.min.z+1,h=Tt.convert(n.format),l=Tt.convert(n.type);let c;if(n.isData3DTexture)rt.setTexture3D(n,0),c=kt.TEXTURE_3D;else{if(!n.isDataArrayTexture&&!n.isCompressedArrayTexture)return;rt.setTexture2DArray(n,0),c=kt.TEXTURE_2D_ARRAY}kt.pixelStorei(kt.UNPACK_FLIP_Y_WEBGL,n.flipY),kt.pixelStorei(kt.UNPACK_PREMULTIPLY_ALPHA_WEBGL,n.premultiplyAlpha),kt.pixelStorei(kt.UNPACK_ALIGNMENT,n.unpackAlignment);const u=kt.getParameter(kt.UNPACK_ROW_LENGTH),d=kt.getParameter(kt.UNPACK_IMAGE_HEIGHT),p=kt.getParameter(kt.UNPACK_SKIP_PIXELS),m=kt.getParameter(kt.UNPACK_SKIP_ROWS),f=kt.getParameter(kt.UNPACK_SKIP_IMAGES),g=i.isCompressedTexture?i.mipmaps[s]:i.image;kt.pixelStorei(kt.UNPACK_ROW_LENGTH,g.width),kt.pixelStorei(kt.UNPACK_IMAGE_HEIGHT,g.height),kt.pixelStorei(kt.UNPACK_SKIP_PIXELS,t.min.x),kt.pixelStorei(kt.UNPACK_SKIP_ROWS,t.min.y),kt.pixelStorei(kt.UNPACK_SKIP_IMAGES,t.min.z),i.isDataTexture||i.isData3DTexture?kt.texSubImage3D(c,s,e.x,e.y,e.z,r,a,o,h,l,g.data):i.isCompressedArrayTexture?kt.compressedTexSubImage3D(c,s,e.x,e.y,e.z,r,a,o,h,g.data):kt.texSubImage3D(c,s,e.x,e.y,e.z,r,a,o,h,l,g),kt.pixelStorei(kt.UNPACK_ROW_LENGTH,u),kt.pixelStorei(kt.UNPACK_IMAGE_HEIGHT,d),kt.pixelStorei(kt.UNPACK_SKIP_PIXELS,p),kt.pixelStorei(kt.UNPACK_SKIP_ROWS,m),kt.pixelStorei(kt.UNPACK_SKIP_IMAGES,f),0===s&&n.generateMipmaps&&kt.generateMipmap(c),Q.unbindTexture()},this.initTexture=function(t){t.isCubeTexture?rt.setTextureCube(t,0):t.isData3DTexture?rt.setTexture3D(t,0):t.isDataArrayTexture||t.isCompressedArrayTexture?rt.setTexture2DArray(t,0):rt.setTexture2D(t,0),Q.unbindTexture()},this.resetState=function(){_=0,w=0,M=null,Q.reset(),At.reset()},"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}get coordinateSystem(){return Vt}get outputColorSpace(){return this._outputColorSpace}set outputColorSpace(t){this._outputColorSpace=t;const e=this.getContext();e.drawingBufferColorSpace=t===kt?"display-p3":"srgb",e.unpackColorSpace=ye.workingColorSpace===Pt?"display-p3":"srgb"}get outputEncoding(){return this.outputColorSpace===It?At:3e3}set outputEncoding(t){this.outputColorSpace=t===At?It:Rt}get useLegacyLights(){return this._useLegacyLights}set useLegacyLights(t){this._useLegacyLights=t}}(class extends Ua{}).prototype.isWebGL1Renderer=!0;class Fa{constructor(t,e=25e-5){this.isFogExp2=!0,this.name="",this.color=new Zi(t),this.density=e}clone(){return new Fa(this.color,this.density)}toJSON(){return{type:"FogExp2",name:this.name,color:this.color.getHex(),density:this.density}}}class Ga{constructor(t,e=1,i=1e3){this.isFog=!0,this.name="",this.color=new Zi(t),this.near=e,this.far=i}clone(){return new Ga(this.color,this.near,this.far)}toJSON(){return{type:"Fog",name:this.name,color:this.color.getHex(),near:this.near,far:this.far}}}class Va extends Oi{constructor(){super(),this.isScene=!0,this.type="Scene",this.background=null,this.environment=null,this.fog=null,this.backgroundBlurriness=0,this.backgroundIntensity=1,this.overrideMaterial=null,"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}copy(t,e){return super.copy(t,e),null!==t.background&&(this.background=t.background.clone()),null!==t.environment&&(this.environment=t.environment.clone()),null!==t.fog&&(this.fog=t.fog.clone()),this.backgroundBlurriness=t.backgroundBlurriness,this.backgroundIntensity=t.backgroundIntensity,null!==t.overrideMaterial&&(this.overrideMaterial=t.overrideMaterial.clone()),this.matrixAutoUpdate=t.matrixAutoUpdate,this}toJSON(t){const e=super.toJSON(t);return null!==this.fog&&(e.object.fog=this.fog.toJSON()),this.backgroundBlurriness>0&&(e.object.backgroundBlurriness=this.backgroundBlurriness),1!==this.backgroundIntensity&&(e.object.backgroundIntensity=this.backgroundIntensity),e}}class Ha{constructor(t,e){this.isInterleavedBuffer=!0,this.array=t,this.stride=e,this.count=void 0!==t?t.length/e:0,this.usage=zt,this._updateRange={offset:0,count:-1},this.updateRanges=[],this.version=0,this.uuid=Jt()}onUploadCallback(){}set needsUpdate(t){!0===t&&this.version++}get updateRange(){return this._updateRange}setUsage(t){return this.usage=t,this}addUpdateRange(t,e){this.updateRanges.push({start:t,count:e})}clearUpdateRanges(){this.updateRanges.length=0}copy(t){return this.array=new t.array.constructor(t.array),this.count=t.count,this.stride=t.stride,this.usage=t.usage,this}copyAt(t,e,i){t*=this.stride,i*=e.stride;for(let n=0,s=this.stride;n<s;n++)this.array[t+n]=e.array[i+n];return this}set(t,e=0){return this.array.set(t,e),this}clone(t){void 0===t.arrayBuffers&&(t.arrayBuffers={}),void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=Jt()),void 0===t.arrayBuffers[this.array.buffer._uuid]&&(t.arrayBuffers[this.array.buffer._uuid]=this.array.slice(0).buffer);const e=new this.array.constructor(t.arrayBuffers[this.array.buffer._uuid]),i=new this.constructor(e,this.stride);return i.setUsage(this.usage),i}onUpload(t){return this.onUploadCallback=t,this}toJSON(t){return void 0===t.arrayBuffers&&(t.arrayBuffers={}),void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=Jt()),void 0===t.arrayBuffers[this.array.buffer._uuid]&&(t.arrayBuffers[this.array.buffer._uuid]=Array.from(new Uint32Array(this.array.buffer))),{uuid:this.uuid,buffer:this.array.buffer._uuid,type:this.array.constructor.name,stride:this.stride}}}const ja=new Le;class Wa{constructor(t,e,i,n=!1){this.isInterleavedBufferAttribute=!0,this.name="",this.data=t,this.itemSize=e,this.offset=i,this.normalized=n}get count(){return this.data.count}get array(){return this.data.array}set needsUpdate(t){this.data.needsUpdate=t}applyMatrix4(t){for(let e=0,i=this.data.count;e<i;e++)ja.fromBufferAttribute(this,e),ja.applyMatrix4(t),this.setXYZ(e,ja.x,ja.y,ja.z);return this}applyNormalMatrix(t){for(let e=0,i=this.count;e<i;e++)ja.fromBufferAttribute(this,e),ja.applyNormalMatrix(t),this.setXYZ(e,ja.x,ja.y,ja.z);return this}transformDirection(t){for(let e=0,i=this.count;e<i;e++)ja.fromBufferAttribute(this,e),ja.transformDirection(t),this.setXYZ(e,ja.x,ja.y,ja.z);return this}setX(t,e){return this.normalized&&(e=ie(e,this.array)),this.data.array[t*this.data.stride+this.offset]=e,this}setY(t,e){return this.normalized&&(e=ie(e,this.array)),this.data.array[t*this.data.stride+this.offset+1]=e,this}setZ(t,e){return this.normalized&&(e=ie(e,this.array)),this.data.array[t*this.data.stride+this.offset+2]=e,this}setW(t,e){return this.normalized&&(e=ie(e,this.array)),this.data.array[t*this.data.stride+this.offset+3]=e,this}getX(t){let e=this.data.array[t*this.data.stride+this.offset];return this.normalized&&(e=ee(e,this.array)),e}getY(t){let e=this.data.array[t*this.data.stride+this.offset+1];return this.normalized&&(e=ee(e,this.array)),e}getZ(t){let e=this.data.array[t*this.data.stride+this.offset+2];return this.normalized&&(e=ee(e,this.array)),e}getW(t){let e=this.data.array[t*this.data.stride+this.offset+3];return this.normalized&&(e=ee(e,this.array)),e}setXY(t,e,i){return t=t*this.data.stride+this.offset,this.normalized&&(e=ie(e,this.array),i=ie(i,this.array)),this.data.array[t+0]=e,this.data.array[t+1]=i,this}setXYZ(t,e,i,n){return t=t*this.data.stride+this.offset,this.normalized&&(e=ie(e,this.array),i=ie(i,this.array),n=ie(n,this.array)),this.data.array[t+0]=e,this.data.array[t+1]=i,this.data.array[t+2]=n,this}setXYZW(t,e,i,n,s){return t=t*this.data.stride+this.offset,this.normalized&&(e=ie(e,this.array),i=ie(i,this.array),n=ie(n,this.array),s=ie(s,this.array)),this.data.array[t+0]=e,this.data.array[t+1]=i,this.data.array[t+2]=n,this.data.array[t+3]=s,this}clone(t){if(void 0===t){const t=[];for(let e=0;e<this.count;e++){const i=e*this.data.stride+this.offset;for(let e=0;e<this.itemSize;e++)t.push(this.data.array[i+e])}return new an(new this.array.constructor(t),this.itemSize,this.normalized)}return void 0===t.interleavedBuffers&&(t.interleavedBuffers={}),void 0===t.interleavedBuffers[this.data.uuid]&&(t.interleavedBuffers[this.data.uuid]=this.data.clone(t)),new Wa(t.interleavedBuffers[this.data.uuid],this.itemSize,this.offset,this.normalized)}toJSON(t){if(void 0===t){const t=[];for(let e=0;e<this.count;e++){const i=e*this.data.stride+this.offset;for(let e=0;e<this.itemSize;e++)t.push(this.data.array[i+e])}return{itemSize:this.itemSize,type:this.array.constructor.name,array:t,normalized:this.normalized}}return void 0===t.interleavedBuffers&&(t.interleavedBuffers={}),void 0===t.interleavedBuffers[this.data.uuid]&&(t.interleavedBuffers[this.data.uuid]=this.data.toJSON(t)),{isInterleavedBufferAttribute:!0,itemSize:this.itemSize,data:this.data.uuid,offset:this.offset,normalized:this.normalized}}}class Xa extends en{constructor(t){super(),this.isSpriteMaterial=!0,this.type="SpriteMaterial",this.color=new Zi(16777215),this.map=null,this.alphaMap=null,this.rotation=0,this.sizeAttenuation=!0,this.transparent=!0,this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.color.copy(t.color),this.map=t.map,this.alphaMap=t.alphaMap,this.rotation=t.rotation,this.sizeAttenuation=t.sizeAttenuation,this.fog=t.fog,this}}let qa;const Ya=new Le,Ja=new Le,$a=new Le,Ka=new se,Za=new se,Qa=new ci,to=new Le,eo=new Le,io=new Le,no=new se,so=new se,ro=new se;class ao extends Oi{constructor(t=new Xa){if(super(),this.isSprite=!0,this.type="Sprite",void 0===qa){qa=new vn;const t=new Float32Array([-.5,-.5,0,0,0,.5,-.5,0,1,0,.5,.5,0,1,1,-.5,.5,0,0,1]),e=new Ha(t,5);qa.setIndex([0,1,2,0,2,3]),qa.setAttribute("position",new Wa(e,3,0,!1)),qa.setAttribute("uv",new Wa(e,2,3,!1))}this.geometry=qa,this.material=t,this.center=new se(.5,.5)}raycast(t,e){t.camera,Ja.setFromMatrixScale(this.matrixWorld),Qa.copy(t.camera.matrixWorld),this.modelViewMatrix.multiplyMatrices(t.camera.matrixWorldInverse,this.matrixWorld),$a.setFromMatrixPosition(this.modelViewMatrix),t.camera.isPerspectiveCamera&&!1===this.material.sizeAttenuation&&Ja.multiplyScalar(-$a.z);const i=this.material.rotation;let n,s;0!==i&&(s=Math.cos(i),n=Math.sin(i));const r=this.center;oo(to.set(-.5,-.5,0),$a,r,Ja,n,s),oo(eo.set(.5,-.5,0),$a,r,Ja,n,s),oo(io.set(.5,.5,0),$a,r,Ja,n,s),no.set(0,0),so.set(1,0),ro.set(1,1);let a=t.ray.intersectTriangle(to,eo,io,!1,Ya);if(null===a&&(oo(eo.set(-.5,.5,0),$a,r,Ja,n,s),so.set(0,1),a=t.ray.intersectTriangle(to,io,eo,!1,Ya),null===a))return;const o=t.ray.origin.distanceTo(Ya);o<t.near||o>t.far||e.push({distance:o,point:Ya.clone(),uv:qi.getInterpolation(Ya,to,eo,io,no,so,ro,new se),face:null,object:this})}copy(t,e){return super.copy(t,e),void 0!==t.center&&this.center.copy(t.center),this.material=t.material,this}}function oo(t,e,i,n,s,r){Ka.subVectors(t,i).addScalar(.5).multiply(n),void 0!==s?(Za.x=r*Ka.x-s*Ka.y,Za.y=s*Ka.x+r*Ka.y):Za.copy(Ka),t.copy(e),t.x+=Za.x,t.y+=Za.y,t.applyMatrix4(Qa)}const ho=new Le,lo=new Le;class co extends Oi{constructor(){super(),this._currentLevel=0,this.type="LOD",Object.defineProperties(this,{levels:{enumerable:!0,value:[]},isLOD:{value:!0}}),this.autoUpdate=!0}copy(t){super.copy(t,!1);const e=t.levels;for(let t=0,i=e.length;t<i;t++){const i=e[t];this.addLevel(i.object.clone(),i.distance,i.hysteresis)}return this.autoUpdate=t.autoUpdate,this}addLevel(t,e=0,i=0){e=Math.abs(e);const n=this.levels;let s;for(s=0;s<n.length&&!(e<n[s].distance);s++);return n.splice(s,0,{distance:e,hysteresis:i,object:t}),this.add(t),this}getCurrentLevel(){return this._currentLevel}getObjectForDistance(t){const e=this.levels;if(e.length>0){let i,n;for(i=1,n=e.length;i<n;i++){let n=e[i].distance;if(e[i].object.visible&&(n-=n*e[i].hysteresis),t<n)break}return e[i-1].object}return null}raycast(t,e){if(this.levels.length>0){ho.setFromMatrixPosition(this.matrixWorld);const i=t.ray.origin.distanceTo(ho);this.getObjectForDistance(i).raycast(t,e)}}update(t){const e=this.levels;if(e.length>1){ho.setFromMatrixPosition(t.matrixWorld),lo.setFromMatrixPosition(this.matrixWorld);const i=ho.distanceTo(lo)/t.zoom;let n,s;for(e[0].object.visible=!0,n=1,s=e.length;n<s;n++){let t=e[n].distance;if(e[n].object.visible&&(t-=t*e[n].hysteresis),!(i>=t))break;e[n-1].object.visible=!1,e[n].object.visible=!0}for(this._currentLevel=n-1;n<s;n++)e[n].object.visible=!1}}toJSON(t){const e=super.toJSON(t);!1===this.autoUpdate&&(e.object.autoUpdate=!1),e.object.levels=[];const i=this.levels;for(let t=0,n=i.length;t<n;t++){const n=i[t];e.object.levels.push({object:n.object.uuid,distance:n.distance,hysteresis:n.hysteresis})}return e}}const uo=new Le,po=new Ce,mo=new Ce,fo=new Le,go=new ci,vo=new Le,yo=new ei,xo=new ci,bo=new li;class _o extends On{constructor(t,e){super(t,e),this.isSkinnedMesh=!0,this.type="SkinnedMesh",this.bindMode=V,this.bindMatrix=new ci,this.bindMatrixInverse=new ci,this.boundingBox=null,this.boundingSphere=null}computeBoundingBox(){const t=this.geometry;null===this.boundingBox&&(this.boundingBox=new Be),this.boundingBox.makeEmpty();const e=t.getAttribute("position");for(let t=0;t<e.count;t++)this.getVertexPosition(t,vo),this.boundingBox.expandByPoint(vo)}computeBoundingSphere(){const t=this.geometry;null===this.boundingSphere&&(this.boundingSphere=new ei),this.boundingSphere.makeEmpty();const e=t.getAttribute("position");for(let t=0;t<e.count;t++)this.getVertexPosition(t,vo),this.boundingSphere.expandByPoint(vo)}copy(t,e){return super.copy(t,e),this.bindMode=t.bindMode,this.bindMatrix.copy(t.bindMatrix),this.bindMatrixInverse.copy(t.bindMatrixInverse),this.skeleton=t.skeleton,null!==t.boundingBox&&(this.boundingBox=t.boundingBox.clone()),null!==t.boundingSphere&&(this.boundingSphere=t.boundingSphere.clone()),this}raycast(t,e){const i=this.material,n=this.matrixWorld;void 0!==i&&(null===this.boundingSphere&&this.computeBoundingSphere(),yo.copy(this.boundingSphere),yo.applyMatrix4(n),!1!==t.ray.intersectsSphere(yo)&&(xo.copy(n).invert(),bo.copy(t.ray).applyMatrix4(xo),null!==this.boundingBox&&!1===bo.intersectsBox(this.boundingBox)||this._computeIntersections(t,e,bo)))}getVertexPosition(t,e){return super.getVertexPosition(t,e),this.applyBoneTransform(t,e),e}bind(t,e){this.skeleton=t,void 0===e&&(this.updateMatrixWorld(!0),this.skeleton.calculateInverses(),e=this.matrixWorld),this.bindMatrix.copy(e),this.bindMatrixInverse.copy(e).invert()}pose(){this.skeleton.pose()}normalizeSkinWeights(){const t=new Ce,e=this.geometry.attributes.skinWeight;for(let i=0,n=e.count;i<n;i++){t.fromBufferAttribute(e,i);const n=1/t.manhattanLength();n!==1/0?t.multiplyScalar(n):t.set(1,0,0,0),e.setXYZW(i,t.x,t.y,t.z,t.w)}}updateMatrixWorld(t){super.updateMatrixWorld(t),this.bindMode===V?this.bindMatrixInverse.copy(this.matrixWorld).invert():"detached"===this.bindMode&&this.bindMatrixInverse.copy(this.bindMatrix).invert()}applyBoneTransform(t,e){const i=this.skeleton,n=this.geometry;po.fromBufferAttribute(n.attributes.skinIndex,t),mo.fromBufferAttribute(n.attributes.skinWeight,t),uo.copy(e).applyMatrix4(this.bindMatrix),e.set(0,0,0);for(let t=0;t<4;t++){const n=mo.getComponent(t);if(0!==n){const s=po.getComponent(t);go.multiplyMatrices(i.bones[s].matrixWorld,i.boneInverses[s]),e.addScaledVector(fo.copy(uo).applyMatrix4(go),n)}}return e.applyMatrix4(this.bindMatrixInverse)}boneTransform(t,e){return this.applyBoneTransform(t,e)}}class wo extends Oi{constructor(){super(),this.isBone=!0,this.type="Bone"}}class Mo extends Ae{constructor(t=null,e=1,i=1,n,s,r,a,o,h=1003,l=1003,c,u){super(null,r,a,o,h,l,n,s,c,u),this.isDataTexture=!0,this.image={data:t,width:e,height:i},this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}const So=new ci,Eo=new ci;class To{constructor(t=[],e=[]){this.uuid=Jt(),this.bones=t.slice(0),this.boneInverses=e,this.boneMatrices=null,this.boneTexture=null,this.init()}init(){const t=this.bones,e=this.boneInverses;if(this.boneMatrices=new Float32Array(16*t.length),0===e.length)this.calculateInverses();else if(t.length!==e.length){this.boneInverses=[];for(let t=0,e=this.bones.length;t<e;t++)this.boneInverses.push(new ci)}}calculateInverses(){this.boneInverses.length=0;for(let t=0,e=this.bones.length;t<e;t++){const e=new ci;this.bones[t]&&e.copy(this.bones[t].matrixWorld).invert(),this.boneInverses.push(e)}}pose(){for(let t=0,e=this.bones.length;t<e;t++){const e=this.bones[t];e&&e.matrixWorld.copy(this.boneInverses[t]).invert()}for(let t=0,e=this.bones.length;t<e;t++){const e=this.bones[t];e&&(e.parent&&e.parent.isBone?(e.matrix.copy(e.parent.matrixWorld).invert(),e.matrix.multiply(e.matrixWorld)):e.matrix.copy(e.matrixWorld),e.matrix.decompose(e.position,e.quaternion,e.scale))}}update(){const t=this.bones,e=this.boneInverses,i=this.boneMatrices,n=this.boneTexture;for(let n=0,s=t.length;n<s;n++){const s=t[n]?t[n].matrixWorld:Eo;So.multiplyMatrices(s,e[n]),So.toArray(i,16*n)}null!==n&&(n.needsUpdate=!0)}clone(){return new To(this.bones,this.boneInverses)}computeBoneTexture(){let t=Math.sqrt(4*this.bones.length);t=4*Math.ceil(t/4),t=Math.max(t,4);const e=new Float32Array(t*t*4);e.set(this.boneMatrices);const i=new Mo(e,t,t,ct,ot);return i.needsUpdate=!0,this.boneMatrices=e,this.boneTexture=i,this}getBoneByName(t){for(let e=0,i=this.bones.length;e<i;e++){const i=this.bones[e];if(i.name===t)return i}}dispose(){null!==this.boneTexture&&(this.boneTexture.dispose(),this.boneTexture=null)}fromJSON(t,e){this.uuid=t.uuid;for(let i=0,n=t.bones.length;i<n;i++){let n=e[t.bones[i]];void 0===n&&(n=new wo),this.bones.push(n),this.boneInverses.push((new ci).fromArray(t.boneInverses[i]))}return this.init(),this}toJSON(){const t={metadata:{version:4.6,type:"Skeleton",generator:"Skeleton.toJSON"},bones:[],boneInverses:[]};t.uuid=this.uuid;const e=this.bones,i=this.boneInverses;for(let n=0,s=e.length;n<s;n++){const s=e[n];t.bones.push(s.uuid);const r=i[n];t.boneInverses.push(r.toArray())}return t}}class Ao extends an{constructor(t,e,i,n=1){super(t,e,i),this.isInstancedBufferAttribute=!0,this.meshPerAttribute=n}copy(t){return super.copy(t),this.meshPerAttribute=t.meshPerAttribute,this}toJSON(){const t=super.toJSON();return t.meshPerAttribute=this.meshPerAttribute,t.isInstancedBufferAttribute=!0,t}}const Co=new ci,Io=new ci,Ro=[],ko=new Be,Po=new ci,Do=new On,Lo=new ei;class Oo extends On{constructor(t,e,i){super(t,e),this.isInstancedMesh=!0,this.instanceMatrix=new Ao(new Float32Array(16*i),16),this.instanceColor=null,this.count=i,this.boundingBox=null,this.boundingSphere=null;for(let t=0;t<i;t++)this.setMatrixAt(t,Po)}computeBoundingBox(){const t=this.geometry,e=this.count;null===this.boundingBox&&(this.boundingBox=new Be),null===t.boundingBox&&t.computeBoundingBox(),this.boundingBox.makeEmpty();for(let i=0;i<e;i++)this.getMatrixAt(i,Co),ko.copy(t.boundingBox).applyMatrix4(Co),this.boundingBox.union(ko)}computeBoundingSphere(){const t=this.geometry,e=this.count;null===this.boundingSphere&&(this.boundingSphere=new ei),null===t.boundingSphere&&t.computeBoundingSphere(),this.boundingSphere.makeEmpty();for(let i=0;i<e;i++)this.getMatrixAt(i,Co),Lo.copy(t.boundingSphere).applyMatrix4(Co),this.boundingSphere.union(Lo)}copy(t,e){return super.copy(t,e),this.instanceMatrix.copy(t.instanceMatrix),null!==t.instanceColor&&(this.instanceColor=t.instanceColor.clone()),this.count=t.count,null!==t.boundingBox&&(this.boundingBox=t.boundingBox.clone()),null!==t.boundingSphere&&(this.boundingSphere=t.boundingSphere.clone()),this}getColorAt(t,e){e.fromArray(this.instanceColor.array,3*t)}getMatrixAt(t,e){e.fromArray(this.instanceMatrix.array,16*t)}raycast(t,e){const i=this.matrixWorld,n=this.count;if(Do.geometry=this.geometry,Do.material=this.material,void 0!==Do.material&&(null===this.boundingSphere&&this.computeBoundingSphere(),Lo.copy(this.boundingSphere),Lo.applyMatrix4(i),!1!==t.ray.intersectsSphere(Lo)))for(let s=0;s<n;s++){this.getMatrixAt(s,Co),Io.multiplyMatrices(i,Co),Do.matrixWorld=Io,Do.raycast(t,Ro);for(let t=0,i=Ro.length;t<i;t++){const i=Ro[t];i.instanceId=s,i.object=this,e.push(i)}Ro.length=0}}setColorAt(t,e){null===this.instanceColor&&(this.instanceColor=new Ao(new Float32Array(3*this.instanceMatrix.count),3)),e.toArray(this.instanceColor.array,3*t)}setMatrixAt(t,e){e.toArray(this.instanceMatrix.array,16*t)}updateMorphTargets(){}dispose(){this.dispatchEvent({type:"dispose"})}}function No(t,e){return t.z-e.z}function Bo(t,e){return e.z-t.z}class zo{constructor(){this.index=0,this.pool=[],this.list=[]}push(t,e){const i=this.pool,n=this.list;this.index>=i.length&&i.push({start:-1,count:-1,z:-1});const s=i[this.index];n.push(s),this.index++,s.start=t.start,s.count=t.count,s.z=e}reset(){this.list.length=0,this.index=0}}const Uo="batchId",Fo=new ci,Go=new ci,Vo=new ci,Ho=new ci,jo=new es,Wo=new Be,Xo=new ei,qo=new Le,Yo=new zo,Jo=new On,$o=[];function Ko(t,e,i=0){const n=e.itemSize;if(t.isInterleavedBufferAttribute||t.array.constructor!==e.array.constructor){const s=t.count;for(let r=0;r<s;r++)for(let s=0;s<n;s++)e.setComponent(r+i,s,t.getComponent(r,s))}else e.array.set(t.array,i*n);e.needsUpdate=!0}class Zo extends On{get maxGeometryCount(){return this._maxGeometryCount}constructor(t,e,i=2*e,n){super(new vn,n),this.isBatchedMesh=!0,this.perObjectFrustumCulled=!0,this.sortObjects=!0,this.boundingBox=null,this.boundingSphere=null,this.customSort=null,this._drawRanges=[],this._reservedRanges=[],this._visibility=[],this._active=[],this._bounds=[],this._maxGeometryCount=t,this._maxVertexCount=e,this._maxIndexCount=i,this._geometryInitialized=!1,this._geometryCount=0,this._multiDrawCounts=new Int32Array(t),this._multiDrawStarts=new Int32Array(t),this._multiDrawCount=0,this._visibilityChanged=!0,this._matricesTexture=null,this._initMatricesTexture()}_initMatricesTexture(){let t=Math.sqrt(4*this._maxGeometryCount);t=4*Math.ceil(t/4),t=Math.max(t,4);const e=new Float32Array(t*t*4),i=new Mo(e,t,t,ct,ot);this._matricesTexture=i}_initializeGeometry(t){const e=this.geometry,i=this._maxVertexCount,n=this._maxGeometryCount,s=this._maxIndexCount;if(!1===this._geometryInitialized){for(const n in t.attributes){const s=t.getAttribute(n),{array:r,itemSize:a,normalized:o}=s,h=new r.constructor(i*a),l=new s.constructor(h,a,o);l.setUsage(s.usage),e.setAttribute(n,l)}if(null!==t.getIndex()){const t=i>65536?new Uint32Array(s):new Uint16Array(s);e.setIndex(new an(t,1))}const r=n>65536?new Uint32Array(i):new Uint16Array(i);e.setAttribute(Uo,new an(r,1)),this._geometryInitialized=!0}}_validateGeometry(t){if(t.getAttribute(Uo))throw new Error(`BatchedMesh: Geometry cannot use attribute "${Uo}"`);const e=this.geometry;if(Boolean(t.getIndex())!==Boolean(e.getIndex()))throw new Error('BatchedMesh: All geometries must consistently have "index".');for(const i in e.attributes){if(i===Uo)continue;if(!t.hasAttribute(i))throw new Error(`BatchedMesh: Added geometry missing "${i}". All geometries must have consistent attributes.`);const n=t.getAttribute(i),s=e.getAttribute(i);if(n.itemSize!==s.itemSize||n.normalized!==s.normalized)throw new Error("BatchedMesh: All attributes must have a consistent itemSize and normalized value.")}}setCustomSort(t){return this.customSort=t,this}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new Be);const t=this._geometryCount,e=this.boundingBox,i=this._active;e.makeEmpty();for(let n=0;n<t;n++)!1!==i[n]&&(this.getMatrixAt(n,Fo),this.getBoundingBoxAt(n,Wo).applyMatrix4(Fo),e.union(Wo))}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new ei);const t=this._geometryCount,e=this.boundingSphere,i=this._active;e.makeEmpty();for(let n=0;n<t;n++)!1!==i[n]&&(this.getMatrixAt(n,Fo),this.getBoundingSphereAt(n,Xo).applyMatrix4(Fo),e.union(Xo))}addGeometry(t,e=-1,i=-1){if(this._initializeGeometry(t),this._validateGeometry(t),this._geometryCount>=this._maxGeometryCount)throw new Error("BatchedMesh: Maximum geometry count reached.");const n={vertexStart:-1,vertexCount:-1,indexStart:-1,indexCount:-1};let s=null;const r=this._reservedRanges,a=this._drawRanges,o=this._bounds;0!==this._geometryCount&&(s=r[r.length-1]),n.vertexCount=-1===e?t.getAttribute("position").count:e,n.vertexStart=null===s?0:s.vertexStart+s.vertexCount;const h=t.getIndex(),l=null!==h;if(l&&(n.indexCount=-1===i?h.count:i,n.indexStart=null===s?0:s.indexStart+s.indexCount),-1!==n.indexStart&&n.indexStart+n.indexCount>this._maxIndexCount||n.vertexStart+n.vertexCount>this._maxVertexCount)throw new Error("BatchedMesh: Reserved space request exceeds the maximum buffer size.");const c=this._visibility,u=this._active,d=this._matricesTexture,p=this._matricesTexture.image.data;c.push(!0),u.push(!0);const m=this._geometryCount;this._geometryCount++,Vo.toArray(p,16*m),d.needsUpdate=!0,r.push(n),a.push({start:l?n.indexStart:n.vertexStart,count:-1}),o.push({boxInitialized:!1,box:new Be,sphereInitialized:!1,sphere:new ei});const f=this.geometry.getAttribute(Uo);for(let t=0;t<n.vertexCount;t++)f.setX(n.vertexStart+t,m);return f.needsUpdate=!0,this.setGeometryAt(m,t),m}setGeometryAt(t,e){if(t>=this._geometryCount)throw new Error("BatchedMesh: Maximum geometry count reached.");this._validateGeometry(e);const i=this.geometry,n=null!==i.getIndex(),s=i.getIndex(),r=e.getIndex(),a=this._reservedRanges[t];if(n&&r.count>a.indexCount||e.attributes.position.count>a.vertexCount)throw new Error("BatchedMesh: Reserved space not large enough for provided geometry.");const o=a.vertexStart,h=a.vertexCount;for(const t in i.attributes){if(t===Uo)continue;const n=e.getAttribute(t),s=i.getAttribute(t);Ko(n,s,o);const r=n.itemSize;for(let t=n.count,e=h;t<e;t++){const e=o+t;for(let t=0;t<r;t++)s.setComponent(e,t,0)}s.needsUpdate=!0}if(n){const t=a.indexStart;for(let e=0;e<r.count;e++)s.setX(t+e,o+r.getX(e));for(let e=r.count,i=a.indexCount;e<i;e++)s.setX(t+e,o);s.needsUpdate=!0}const l=this._bounds[t];null!==e.boundingBox?(l.box.copy(e.boundingBox),l.boxInitialized=!0):l.boxInitialized=!1,null!==e.boundingSphere?(l.sphere.copy(e.boundingSphere),l.sphereInitialized=!0):l.sphereInitialized=!1;const c=this._drawRanges[t],u=e.getAttribute("position");return c.count=n?r.count:u.count,this._visibilityChanged=!0,t}deleteGeometry(t){const e=this._active;return t>=e.length||!1===e[t]||(e[t]=!1,this._visibilityChanged=!0),this}getBoundingBoxAt(t,e){if(!1===this._active[t])return this;const i=this._bounds[t],n=i.box,s=this.geometry;if(!1===i.boxInitialized){n.makeEmpty();const e=s.index,r=s.attributes.position,a=this._drawRanges[t];for(let t=a.start,i=a.start+a.count;t<i;t++){let i=t;e&&(i=e.getX(i)),n.expandByPoint(qo.fromBufferAttribute(r,i))}i.boxInitialized=!0}return e.copy(n),e}getBoundingSphereAt(t,e){if(!1===this._active[t])return this;const i=this._bounds[t],n=i.sphere,s=this.geometry;if(!1===i.sphereInitialized){n.makeEmpty(),this.getBoundingBoxAt(t,Wo),Wo.getCenter(n.center);const e=s.index,r=s.attributes.position,a=this._drawRanges[t];let o=0;for(let t=a.start,i=a.start+a.count;t<i;t++){let i=t;e&&(i=e.getX(i)),qo.fromBufferAttribute(r,i),o=Math.max(o,n.center.distanceToSquared(qo))}n.radius=Math.sqrt(o),i.sphereInitialized=!0}return e.copy(n),e}setMatrixAt(t,e){const i=this._active,n=this._matricesTexture,s=this._matricesTexture.image.data;return t>=this._geometryCount||!1===i[t]||(e.toArray(s,16*t),n.needsUpdate=!0),this}getMatrixAt(t,e){const i=this._active,n=this._matricesTexture.image.data;return t>=this._geometryCount||!1===i[t]?null:e.fromArray(n,16*t)}setVisibleAt(t,e){const i=this._visibility,n=this._active;return t>=this._geometryCount||!1===n[t]||i[t]===e||(i[t]=e,this._visibilityChanged=!0),this}getVisibleAt(t){const e=this._visibility,i=this._active;return!(t>=this._geometryCount||!1===i[t])&&e[t]}raycast(t,e){const i=this._visibility,n=this._active,s=this._drawRanges,r=this._geometryCount,a=this.matrixWorld,o=this.geometry;Jo.material=this.material,Jo.geometry.index=o.index,Jo.geometry.attributes=o.attributes,null===Jo.geometry.boundingBox&&(Jo.geometry.boundingBox=new Be),null===Jo.geometry.boundingSphere&&(Jo.geometry.boundingSphere=new ei);for(let o=0;o<r;o++){if(!i[o]||!n[o])continue;const r=s[o];Jo.geometry.setDrawRange(r.start,r.count),this.getMatrixAt(o,Jo.matrixWorld).premultiply(a),this.getBoundingBoxAt(o,Jo.geometry.boundingBox),this.getBoundingSphereAt(o,Jo.geometry.boundingSphere),Jo.raycast(t,$o);for(let t=0,i=$o.length;t<i;t++){const i=$o[t];i.object=this,i.batchId=o,e.push(i)}$o.length=0}Jo.material=null,Jo.geometry.index=null,Jo.geometry.attributes={},Jo.geometry.setDrawRange(0,1/0)}copy(t){return super.copy(t),this.geometry=t.geometry.clone(),this.perObjectFrustumCulled=t.perObjectFrustumCulled,this.sortObjects=t.sortObjects,this.boundingBox=null!==t.boundingBox?t.boundingBox.clone():null,this.boundingSphere=null!==t.boundingSphere?t.boundingSphere.clone():null,this._drawRanges=t._drawRanges.map((t=>({...t}))),this._reservedRanges=t._reservedRanges.map((t=>({...t}))),this._visibility=t._visibility.slice(),this._active=t._active.slice(),this._bounds=t._bounds.map((t=>({boxInitialized:t.boxInitialized,box:t.box.clone(),sphereInitialized:t.sphereInitialized,sphere:t.sphere.clone()}))),this._maxGeometryCount=t._maxGeometryCount,this._maxVertexCount=t._maxVertexCount,this._maxIndexCount=t._maxIndexCount,this._geometryInitialized=t._geometryInitialized,this._geometryCount=t._geometryCount,this._multiDrawCounts=t._multiDrawCounts.slice(),this._multiDrawStarts=t._multiDrawStarts.slice(),this._matricesTexture=t._matricesTexture.clone(),this._matricesTexture.image.data=this._matricesTexture.image.slice(),this}dispose(){return this.geometry.dispose(),this._matricesTexture.dispose(),this._matricesTexture=null,this}onBeforeRender(t,e,i,n,s){if(!this._visibilityChanged&&!this.perObjectFrustumCulled&&!this.sortObjects)return;const r=n.getIndex(),a=null===r?1:r.array.BYTES_PER_ELEMENT,o=this._visibility,h=this._multiDrawStarts,l=this._multiDrawCounts,c=this._drawRanges,u=this.perObjectFrustumCulled;u&&(Ho.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse).multiply(this.matrixWorld),jo.setFromProjectionMatrix(Ho,t.isWebGPURenderer?Ht:Vt));let d=0;if(this.sortObjects){Go.copy(this.matrixWorld).invert(),qo.setFromMatrixPosition(i.matrixWorld).applyMatrix4(Go);for(let t=0,e=o.length;t<e;t++)if(o[t]){this.getMatrixAt(t,Fo),this.getBoundingSphereAt(t,Xo).applyMatrix4(Fo);let e=!1;if(u&&(e=!jo.intersectsSphere(Xo)),!e){const e=qo.distanceTo(Xo.center);Yo.push(c[t],e)}}const t=Yo.list,e=this.customSort;null===e?t.sort(s.transparent?Bo:No):e.call(this,t,i);for(let e=0,i=t.length;e<i;e++){const i=t[e];h[d]=i.start*a,l[d]=i.count,d++}Yo.reset()}else for(let t=0,e=o.length;t<e;t++)if(o[t]){let e=!1;if(u&&(this.getMatrixAt(t,Fo),this.getBoundingSphereAt(t,Xo).applyMatrix4(Fo),e=!jo.intersectsSphere(Xo)),!e){const e=c[t];h[d]=e.start*a,l[d]=e.count,d++}}this._multiDrawCount=d,this._visibilityChanged=!1}onBeforeShadow(t,e,i,n,s,r){this.onBeforeRender(t,null,n,s,r)}}class Qo extends en{constructor(t){super(),this.isLineBasicMaterial=!0,this.type="LineBasicMaterial",this.color=new Zi(16777215),this.map=null,this.linewidth=1,this.linecap="round",this.linejoin="round",this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.color.copy(t.color),this.map=t.map,this.linewidth=t.linewidth,this.linecap=t.linecap,this.linejoin=t.linejoin,this.fog=t.fog,this}}const th=new Le,eh=new Le,ih=new ci,nh=new li,sh=new ei;class rh extends Oi{constructor(t=new vn,e=new Qo){super(),this.isLine=!0,this.type="Line",this.geometry=t,this.material=e,this.updateMorphTargets()}copy(t,e){return super.copy(t,e),this.material=Array.isArray(t.material)?t.material.slice():t.material,this.geometry=t.geometry,this}computeLineDistances(){const t=this.geometry;if(null===t.index){const e=t.attributes.position,i=[0];for(let t=1,n=e.count;t<n;t++)th.fromBufferAttribute(e,t-1),eh.fromBufferAttribute(e,t),i[t]=i[t-1],i[t]+=th.distanceTo(eh);t.setAttribute("lineDistance",new ln(i,1))}return this}raycast(t,e){const i=this.geometry,n=this.matrixWorld,s=t.params.Line.threshold,r=i.drawRange;if(null===i.boundingSphere&&i.computeBoundingSphere(),sh.copy(i.boundingSphere),sh.applyMatrix4(n),sh.radius+=s,!1===t.ray.intersectsSphere(sh))return;ih.copy(n).invert(),nh.copy(t.ray).applyMatrix4(ih);const a=s/((this.scale.x+this.scale.y+this.scale.z)/3),o=a*a,h=new Le,l=new Le,c=new Le,u=new Le,d=this.isLineSegments?2:1,p=i.index,m=i.attributes.position;if(null!==p){for(let i=Math.max(0,r.start),n=Math.min(p.count,r.start+r.count)-1;i<n;i+=d){const n=p.getX(i),s=p.getX(i+1);h.fromBufferAttribute(m,n),l.fromBufferAttribute(m,s);if(nh.distanceSqToSegment(h,l,u,c)>o)continue;u.applyMatrix4(this.matrixWorld);const r=t.ray.origin.distanceTo(u);r<t.near||r>t.far||e.push({distance:r,point:c.clone().applyMatrix4(this.matrixWorld),index:i,face:null,faceIndex:null,object:this})}}else{for(let i=Math.max(0,r.start),n=Math.min(m.count,r.start+r.count)-1;i<n;i+=d){h.fromBufferAttribute(m,i),l.fromBufferAttribute(m,i+1);if(nh.distanceSqToSegment(h,l,u,c)>o)continue;u.applyMatrix4(this.matrixWorld);const n=t.ray.origin.distanceTo(u);n<t.near||n>t.far||e.push({distance:n,point:c.clone().applyMatrix4(this.matrixWorld),index:i,face:null,faceIndex:null,object:this})}}}updateMorphTargets(){const t=this.geometry.morphAttributes,e=Object.keys(t);if(e.length>0){const i=t[e[0]];if(void 0!==i){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let t=0,e=i.length;t<e;t++){const e=i[t].name||String(t);this.morphTargetInfluences.push(0),this.morphTargetDictionary[e]=t}}}}}const ah=new Le,oh=new Le;class hh extends rh{constructor(t,e){super(t,e),this.isLineSegments=!0,this.type="LineSegments"}computeLineDistances(){const t=this.geometry;if(null===t.index){const e=t.attributes.position,i=[];for(let t=0,n=e.count;t<n;t+=2)ah.fromBufferAttribute(e,t),oh.fromBufferAttribute(e,t+1),i[t]=0===t?0:i[t-1],i[t+1]=i[t]+ah.distanceTo(oh);t.setAttribute("lineDistance",new ln(i,1))}return this}}class lh extends rh{constructor(t,e){super(t,e),this.isLineLoop=!0,this.type="LineLoop"}}class ch extends en{constructor(t){super(),this.isPointsMaterial=!0,this.type="PointsMaterial",this.color=new Zi(16777215),this.map=null,this.alphaMap=null,this.size=1,this.sizeAttenuation=!0,this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.color.copy(t.color),this.map=t.map,this.alphaMap=t.alphaMap,this.size=t.size,this.sizeAttenuation=t.sizeAttenuation,this.fog=t.fog,this}}const uh=new ci,dh=new li,ph=new ei,mh=new Le;class fh extends Oi{constructor(t=new vn,e=new ch){super(),this.isPoints=!0,this.type="Points",this.geometry=t,this.material=e,this.updateMorphTargets()}copy(t,e){return super.copy(t,e),this.material=Array.isArray(t.material)?t.material.slice():t.material,this.geometry=t.geometry,this}raycast(t,e){const i=this.geometry,n=this.matrixWorld,s=t.params.Points.threshold,r=i.drawRange;if(null===i.boundingSphere&&i.computeBoundingSphere(),ph.copy(i.boundingSphere),ph.applyMatrix4(n),ph.radius+=s,!1===t.ray.intersectsSphere(ph))return;uh.copy(n).invert(),dh.copy(t.ray).applyMatrix4(uh);const a=s/((this.scale.x+this.scale.y+this.scale.z)/3),o=a*a,h=i.index,l=i.attributes.position;if(null!==h){for(let i=Math.max(0,r.start),s=Math.min(h.count,r.start+r.count);i<s;i++){const s=h.getX(i);mh.fromBufferAttribute(l,s),gh(mh,s,o,n,t,e,this)}}else{for(let i=Math.max(0,r.start),s=Math.min(l.count,r.start+r.count);i<s;i++)mh.fromBufferAttribute(l,i),gh(mh,i,o,n,t,e,this)}}updateMorphTargets(){const t=this.geometry.morphAttributes,e=Object.keys(t);if(e.length>0){const i=t[e[0]];if(void 0!==i){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let t=0,e=i.length;t<e;t++){const e=i[t].name||String(t);this.morphTargetInfluences.push(0),this.morphTargetDictionary[e]=t}}}}}function gh(t,e,i,n,s,r,a){const o=dh.distanceSqToPoint(t);if(o<i){const i=new Le;dh.closestPointToPoint(t,i),i.applyMatrix4(n);const h=s.ray.origin.distanceTo(i);if(h<s.near||h>s.far)return;r.push({distance:h,distanceToRay:Math.sqrt(o),point:i,index:e,face:null,object:a})}}class vh extends Ae{constructor(t,e,i,n,s,r,a,o,h){super(t,e,i,n,s,r,a,o,h),this.isCanvasTexture=!0,this.needsUpdate=!0}}class yh{constructor(){this.type="Curve",this.arcLengthDivisions=200}getPoint(){return null}getPointAt(t,e){const i=this.getUtoTmapping(t);return this.getPoint(i,e)}getPoints(t=5){const e=[];for(let i=0;i<=t;i++)e.push(this.getPoint(i/t));return e}getSpacedPoints(t=5){const e=[];for(let i=0;i<=t;i++)e.push(this.getPointAt(i/t));return e}getLength(){const t=this.getLengths();return t[t.length-1]}getLengths(t=this.arcLengthDivisions){if(this.cacheArcLengths&&this.cacheArcLengths.length===t+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;const e=[];let i,n=this.getPoint(0),s=0;e.push(0);for(let r=1;r<=t;r++)i=this.getPoint(r/t),s+=i.distanceTo(n),e.push(s),n=i;return this.cacheArcLengths=e,e}updateArcLengths(){this.needsUpdate=!0,this.getLengths()}getUtoTmapping(t,e){const i=this.getLengths();let n=0;const s=i.length;let r;r=e||t*i[s-1];let a,o=0,h=s-1;for(;o<=h;)if(n=Math.floor(o+(h-o)/2),a=i[n]-r,a<0)o=n+1;else{if(!(a>0)){h=n;break}h=n-1}if(n=h,i[n]===r)return n/(s-1);const l=i[n];return(n+(r-l)/(i[n+1]-l))/(s-1)}getTangent(t,e){const i=1e-4;let n=t-i,s=t+i;n<0&&(n=0),s>1&&(s=1);const r=this.getPoint(n),a=this.getPoint(s),o=e||(r.isVector2?new se:new Le);return o.copy(a).sub(r).normalize(),o}getTangentAt(t,e){const i=this.getUtoTmapping(t);return this.getTangent(i,e)}computeFrenetFrames(t,e){const i=new Le,n=[],s=[],r=[],a=new Le,o=new ci;for(let e=0;e<=t;e++){const i=e/t;n[e]=this.getTangentAt(i,new Le)}s[0]=new Le,r[0]=new Le;let h=Number.MAX_VALUE;const l=Math.abs(n[0].x),c=Math.abs(n[0].y),u=Math.abs(n[0].z);l<=h&&(h=l,i.set(1,0,0)),c<=h&&(h=c,i.set(0,1,0)),u<=h&&i.set(0,0,1),a.crossVectors(n[0],i).normalize(),s[0].crossVectors(n[0],a),r[0].crossVectors(n[0],s[0]);for(let e=1;e<=t;e++){if(s[e]=s[e-1].clone(),r[e]=r[e-1].clone(),a.crossVectors(n[e-1],n[e]),a.length()>Number.EPSILON){a.normalize();const t=Math.acos($t(n[e-1].dot(n[e]),-1,1));s[e].applyMatrix4(o.makeRotationAxis(a,t))}r[e].crossVectors(n[e],s[e])}if(!0===e){let e=Math.acos($t(s[0].dot(s[t]),-1,1));e/=t,n[0].dot(a.crossVectors(s[0],s[t]))>0&&(e=-e);for(let i=1;i<=t;i++)s[i].applyMatrix4(o.makeRotationAxis(n[i],e*i)),r[i].crossVectors(n[i],s[i])}return{tangents:n,normals:s,binormals:r}}clone(){return(new this.constructor).copy(this)}copy(t){return this.arcLengthDivisions=t.arcLengthDivisions,this}toJSON(){const t={metadata:{version:4.6,type:"Curve",generator:"Curve.toJSON"}};return t.arcLengthDivisions=this.arcLengthDivisions,t.type=this.type,t}fromJSON(t){return this.arcLengthDivisions=t.arcLengthDivisions,this}}class xh extends yh{constructor(t=0,e=0,i=1,n=1,s=0,r=2*Math.PI,a=!1,o=0){super(),this.isEllipseCurve=!0,this.type="EllipseCurve",this.aX=t,this.aY=e,this.xRadius=i,this.yRadius=n,this.aStartAngle=s,this.aEndAngle=r,this.aClockwise=a,this.aRotation=o}getPoint(t,e){const i=e||new se,n=2*Math.PI;let s=this.aEndAngle-this.aStartAngle;const r=Math.abs(s)<Number.EPSILON;for(;s<0;)s+=n;for(;s>n;)s-=n;s<Number.EPSILON&&(s=r?0:n),!0!==this.aClockwise||r||(s===n?s=-n:s-=n);const a=this.aStartAngle+t*s;let o=this.aX+this.xRadius*Math.cos(a),h=this.aY+this.yRadius*Math.sin(a);if(0!==this.aRotation){const t=Math.cos(this.aRotation),e=Math.sin(this.aRotation),i=o-this.aX,n=h-this.aY;o=i*t-n*e+this.aX,h=i*e+n*t+this.aY}return i.set(o,h)}copy(t){return super.copy(t),this.aX=t.aX,this.aY=t.aY,this.xRadius=t.xRadius,this.yRadius=t.yRadius,this.aStartAngle=t.aStartAngle,this.aEndAngle=t.aEndAngle,this.aClockwise=t.aClockwise,this.aRotation=t.aRotation,this}toJSON(){const t=super.toJSON();return t.aX=this.aX,t.aY=this.aY,t.xRadius=this.xRadius,t.yRadius=this.yRadius,t.aStartAngle=this.aStartAngle,t.aEndAngle=this.aEndAngle,t.aClockwise=this.aClockwise,t.aRotation=this.aRotation,t}fromJSON(t){return super.fromJSON(t),this.aX=t.aX,this.aY=t.aY,this.xRadius=t.xRadius,this.yRadius=t.yRadius,this.aStartAngle=t.aStartAngle,this.aEndAngle=t.aEndAngle,this.aClockwise=t.aClockwise,this.aRotation=t.aRotation,this}}function bh(){let t=0,e=0,i=0,n=0;function s(s,r,a,o){t=s,e=a,i=-3*s+3*r-2*a-o,n=2*s-2*r+a+o}return{initCatmullRom:function(t,e,i,n,r){s(e,i,r*(i-t),r*(n-e))},initNonuniformCatmullRom:function(t,e,i,n,r,a,o){let h=(e-t)/r-(i-t)/(r+a)+(i-e)/a,l=(i-e)/a-(n-e)/(a+o)+(n-i)/o;h*=a,l*=a,s(e,i,h,l)},calc:function(s){const r=s*s;return t+e*s+i*r+n*(r*s)}}}const _h=new Le,wh=new bh,Mh=new bh,Sh=new bh;function Eh(t,e,i,n,s){const r=.5*(n-e),a=.5*(s-i),o=t*t;return(2*i-2*n+r+a)*(t*o)+(-3*i+3*n-2*r-a)*o+r*t+i}function Th(t,e,i,n){return function(t,e){const i=1-t;return i*i*e}(t,e)+function(t,e){return 2*(1-t)*t*e}(t,i)+function(t,e){return t*t*e}(t,n)}function Ah(t,e,i,n,s){return function(t,e){const i=1-t;return i*i*i*e}(t,e)+function(t,e){const i=1-t;return 3*i*i*t*e}(t,i)+function(t,e){return 3*(1-t)*t*t*e}(t,n)+function(t,e){return t*t*t*e}(t,s)}class Ch extends yh{constructor(t=new se,e=new se,i=new se,n=new se){super(),this.isCubicBezierCurve=!0,this.type="CubicBezierCurve",this.v0=t,this.v1=e,this.v2=i,this.v3=n}getPoint(t,e=new se){const i=e,n=this.v0,s=this.v1,r=this.v2,a=this.v3;return i.set(Ah(t,n.x,s.x,r.x,a.x),Ah(t,n.y,s.y,r.y,a.y)),i}copy(t){return super.copy(t),this.v0.copy(t.v0),this.v1.copy(t.v1),this.v2.copy(t.v2),this.v3.copy(t.v3),this}toJSON(){const t=super.toJSON();return t.v0=this.v0.toArray(),t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t.v3=this.v3.toArray(),t}fromJSON(t){return super.fromJSON(t),this.v0.fromArray(t.v0),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this.v3.fromArray(t.v3),this}}class Ih extends yh{constructor(t=new se,e=new se){super(),this.isLineCurve=!0,this.type="LineCurve",this.v1=t,this.v2=e}getPoint(t,e=new se){const i=e;return 1===t?i.copy(this.v2):(i.copy(this.v2).sub(this.v1),i.multiplyScalar(t).add(this.v1)),i}getPointAt(t,e){return this.getPoint(t,e)}getTangent(t,e=new se){return e.subVectors(this.v2,this.v1).normalize()}getTangentAt(t,e){return this.getTangent(t,e)}copy(t){return super.copy(t),this.v1.copy(t.v1),this.v2.copy(t.v2),this}toJSON(){const t=super.toJSON();return t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t}fromJSON(t){return super.fromJSON(t),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this}}class Rh extends yh{constructor(t=new se,e=new se,i=new se){super(),this.isQuadraticBezierCurve=!0,this.type="QuadraticBezierCurve",this.v0=t,this.v1=e,this.v2=i}getPoint(t,e=new se){const i=e,n=this.v0,s=this.v1,r=this.v2;return i.set(Th(t,n.x,s.x,r.x),Th(t,n.y,s.y,r.y)),i}copy(t){return super.copy(t),this.v0.copy(t.v0),this.v1.copy(t.v1),this.v2.copy(t.v2),this}toJSON(){const t=super.toJSON();return t.v0=this.v0.toArray(),t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t}fromJSON(t){return super.fromJSON(t),this.v0.fromArray(t.v0),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this}}class kh extends yh{constructor(t=new Le,e=new Le,i=new Le){super(),this.isQuadraticBezierCurve3=!0,this.type="QuadraticBezierCurve3",this.v0=t,this.v1=e,this.v2=i}getPoint(t,e=new Le){const i=e,n=this.v0,s=this.v1,r=this.v2;return i.set(Th(t,n.x,s.x,r.x),Th(t,n.y,s.y,r.y),Th(t,n.z,s.z,r.z)),i}copy(t){return super.copy(t),this.v0.copy(t.v0),this.v1.copy(t.v1),this.v2.copy(t.v2),this}toJSON(){const t=super.toJSON();return t.v0=this.v0.toArray(),t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t}fromJSON(t){return super.fromJSON(t),this.v0.fromArray(t.v0),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this}}class Ph extends yh{constructor(t=[]){super(),this.isSplineCurve=!0,this.type="SplineCurve",this.points=t}getPoint(t,e=new se){const i=e,n=this.points,s=(n.length-1)*t,r=Math.floor(s),a=s-r,o=n[0===r?r:r-1],h=n[r],l=n[r>n.length-2?n.length-1:r+1],c=n[r>n.length-3?n.length-1:r+2];return i.set(Eh(a,o.x,h.x,l.x,c.x),Eh(a,o.y,h.y,l.y,c.y)),i}copy(t){super.copy(t),this.points=[];for(let e=0,i=t.points.length;e<i;e++){const i=t.points[e];this.points.push(i.clone())}return this}toJSON(){const t=super.toJSON();t.points=[];for(let e=0,i=this.points.length;e<i;e++){const i=this.points[e];t.points.push(i.toArray())}return t}fromJSON(t){super.fromJSON(t),this.points=[];for(let e=0,i=t.points.length;e<i;e++){const i=t.points[e];this.points.push((new se).fromArray(i))}return this}}var Dh=Object.freeze({__proto__:null,ArcCurve:class extends xh{constructor(t,e,i,n,s,r){super(t,e,i,i,n,s,r),this.isArcCurve=!0,this.type="ArcCurve"}},CatmullRomCurve3:class extends yh{constructor(t=[],e=!1,i="centripetal",n=.5){super(),this.isCatmullRomCurve3=!0,this.type="CatmullRomCurve3",this.points=t,this.closed=e,this.curveType=i,this.tension=n}getPoint(t,e=new Le){const i=e,n=this.points,s=n.length,r=(s-(this.closed?0:1))*t;let a,o,h=Math.floor(r),l=r-h;this.closed?h+=h>0?0:(Math.floor(Math.abs(h)/s)+1)*s:0===l&&h===s-1&&(h=s-2,l=1),this.closed||h>0?a=n[(h-1)%s]:(_h.subVectors(n[0],n[1]).add(n[0]),a=_h);const c=n[h%s],u=n[(h+1)%s];if(this.closed||h+2<s?o=n[(h+2)%s]:(_h.subVectors(n[s-1],n[s-2]).add(n[s-1]),o=_h),"centripetal"===this.curveType||"chordal"===this.curveType){const t="chordal"===this.curveType?.5:.25;let e=Math.pow(a.distanceToSquared(c),t),i=Math.pow(c.distanceToSquared(u),t),n=Math.pow(u.distanceToSquared(o),t);i<1e-4&&(i=1),e<1e-4&&(e=i),n<1e-4&&(n=i),wh.initNonuniformCatmullRom(a.x,c.x,u.x,o.x,e,i,n),Mh.initNonuniformCatmullRom(a.y,c.y,u.y,o.y,e,i,n),Sh.initNonuniformCatmullRom(a.z,c.z,u.z,o.z,e,i,n)}else"catmullrom"===this.curveType&&(wh.initCatmullRom(a.x,c.x,u.x,o.x,this.tension),Mh.initCatmullRom(a.y,c.y,u.y,o.y,this.tension),Sh.initCatmullRom(a.z,c.z,u.z,o.z,this.tension));return i.set(wh.calc(l),Mh.calc(l),Sh.calc(l)),i}copy(t){super.copy(t),this.points=[];for(let e=0,i=t.points.length;e<i;e++){const i=t.points[e];this.points.push(i.clone())}return this.closed=t.closed,this.curveType=t.curveType,this.tension=t.tension,this}toJSON(){const t=super.toJSON();t.points=[];for(let e=0,i=this.points.length;e<i;e++){const i=this.points[e];t.points.push(i.toArray())}return t.closed=this.closed,t.curveType=this.curveType,t.tension=this.tension,t}fromJSON(t){super.fromJSON(t),this.points=[];for(let e=0,i=t.points.length;e<i;e++){const i=t.points[e];this.points.push((new Le).fromArray(i))}return this.closed=t.closed,this.curveType=t.curveType,this.tension=t.tension,this}},CubicBezierCurve:Ch,CubicBezierCurve3:class extends yh{constructor(t=new Le,e=new Le,i=new Le,n=new Le){super(),this.isCubicBezierCurve3=!0,this.type="CubicBezierCurve3",this.v0=t,this.v1=e,this.v2=i,this.v3=n}getPoint(t,e=new Le){const i=e,n=this.v0,s=this.v1,r=this.v2,a=this.v3;return i.set(Ah(t,n.x,s.x,r.x,a.x),Ah(t,n.y,s.y,r.y,a.y),Ah(t,n.z,s.z,r.z,a.z)),i}copy(t){return super.copy(t),this.v0.copy(t.v0),this.v1.copy(t.v1),this.v2.copy(t.v2),this.v3.copy(t.v3),this}toJSON(){const t=super.toJSON();return t.v0=this.v0.toArray(),t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t.v3=this.v3.toArray(),t}fromJSON(t){return super.fromJSON(t),this.v0.fromArray(t.v0),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this.v3.fromArray(t.v3),this}},EllipseCurve:xh,LineCurve:Ih,LineCurve3:class extends yh{constructor(t=new Le,e=new Le){super(),this.isLineCurve3=!0,this.type="LineCurve3",this.v1=t,this.v2=e}getPoint(t,e=new Le){const i=e;return 1===t?i.copy(this.v2):(i.copy(this.v2).sub(this.v1),i.multiplyScalar(t).add(this.v1)),i}getPointAt(t,e){return this.getPoint(t,e)}getTangent(t,e=new Le){return e.subVectors(this.v2,this.v1).normalize()}getTangentAt(t,e){return this.getTangent(t,e)}copy(t){return super.copy(t),this.v1.copy(t.v1),this.v2.copy(t.v2),this}toJSON(){const t=super.toJSON();return t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t}fromJSON(t){return super.fromJSON(t),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this}},QuadraticBezierCurve:Rh,QuadraticBezierCurve3:kh,SplineCurve:Ph});class Lh extends yh{constructor(){super(),this.type="CurvePath",this.curves=[],this.autoClose=!1}add(t){this.curves.push(t)}closePath(){const t=this.curves[0].getPoint(0),e=this.curves[this.curves.length-1].getPoint(1);if(!t.equals(e)){const i=!0===t.isVector2?"LineCurve":"LineCurve3";this.curves.push(new Dh[i](e,t))}return this}getPoint(t,e){const i=t*this.getLength(),n=this.getCurveLengths();let s=0;for(;s<n.length;){if(n[s]>=i){const t=n[s]-i,r=this.curves[s],a=r.getLength(),o=0===a?0:1-t/a;return r.getPointAt(o,e)}s++}return null}getLength(){const t=this.getCurveLengths();return t[t.length-1]}updateArcLengths(){this.needsUpdate=!0,this.cacheLengths=null,this.getCurveLengths()}getCurveLengths(){if(this.cacheLengths&&this.cacheLengths.length===this.curves.length)return this.cacheLengths;const t=[];let e=0;for(let i=0,n=this.curves.length;i<n;i++)e+=this.curves[i].getLength(),t.push(e);return this.cacheLengths=t,t}getSpacedPoints(t=40){const e=[];for(let i=0;i<=t;i++)e.push(this.getPoint(i/t));return this.autoClose&&e.push(e[0]),e}getPoints(t=12){const e=[];let i;for(let n=0,s=this.curves;n<s.length;n++){const r=s[n],a=r.isEllipseCurve?2*t:r.isLineCurve||r.isLineCurve3?1:r.isSplineCurve?t*r.points.length:t,o=r.getPoints(a);for(let t=0;t<o.length;t++){const n=o[t];i&&i.equals(n)||(e.push(n),i=n)}}return this.autoClose&&e.length>1&&!e[e.length-1].equals(e[0])&&e.push(e[0]),e}copy(t){super.copy(t),this.curves=[];for(let e=0,i=t.curves.length;e<i;e++){const i=t.curves[e];this.curves.push(i.clone())}return this.autoClose=t.autoClose,this}toJSON(){const t=super.toJSON();t.autoClose=this.autoClose,t.curves=[];for(let e=0,i=this.curves.length;e<i;e++){const i=this.curves[e];t.curves.push(i.toJSON())}return t}fromJSON(t){super.fromJSON(t),this.autoClose=t.autoClose,this.curves=[];for(let e=0,i=t.curves.length;e<i;e++){const i=t.curves[e];this.curves.push((new Dh[i.type]).fromJSON(i))}return this}}class Oh extends Lh{constructor(t){super(),this.type="Path",this.currentPoint=new se,t&&this.setFromPoints(t)}setFromPoints(t){this.moveTo(t[0].x,t[0].y);for(let e=1,i=t.length;e<i;e++)this.lineTo(t[e].x,t[e].y);return this}moveTo(t,e){return this.currentPoint.set(t,e),this}lineTo(t,e){const i=new Ih(this.currentPoint.clone(),new se(t,e));return this.curves.push(i),this.currentPoint.set(t,e),this}quadraticCurveTo(t,e,i,n){const s=new Rh(this.currentPoint.clone(),new se(t,e),new se(i,n));return this.curves.push(s),this.currentPoint.set(i,n),this}bezierCurveTo(t,e,i,n,s,r){const a=new Ch(this.currentPoint.clone(),new se(t,e),new se(i,n),new se(s,r));return this.curves.push(a),this.currentPoint.set(s,r),this}splineThru(t){const e=[this.currentPoint.clone()].concat(t),i=new Ph(e);return this.curves.push(i),this.currentPoint.copy(t[t.length-1]),this}arc(t,e,i,n,s,r){const a=this.currentPoint.x,o=this.currentPoint.y;return this.absarc(t+a,e+o,i,n,s,r),this}absarc(t,e,i,n,s,r){return this.absellipse(t,e,i,i,n,s,r),this}ellipse(t,e,i,n,s,r,a,o){const h=this.currentPoint.x,l=this.currentPoint.y;return this.absellipse(t+h,e+l,i,n,s,r,a,o),this}absellipse(t,e,i,n,s,r,a,o){const h=new xh(t,e,i,n,s,r,a,o);if(this.curves.length>0){const t=h.getPoint(0);t.equals(this.currentPoint)||this.lineTo(t.x,t.y)}this.curves.push(h);const l=h.getPoint(1);return this.currentPoint.copy(l),this}copy(t){return super.copy(t),this.currentPoint.copy(t.currentPoint),this}toJSON(){const t=super.toJSON();return t.currentPoint=this.currentPoint.toArray(),t}fromJSON(t){return super.fromJSON(t),this.currentPoint.fromArray(t.currentPoint),this}}class Nh extends vn{constructor(t=[new se(0,-.5),new se(.5,0),new se(0,.5)],e=12,i=0,n=2*Math.PI){super(),this.type="LatheGeometry",this.parameters={points:t,segments:e,phiStart:i,phiLength:n},e=Math.floor(e),n=$t(n,0,2*Math.PI);const s=[],r=[],a=[],o=[],h=[],l=1/e,c=new Le,u=new se,d=new Le,p=new Le,m=new Le;let f=0,g=0;for(let e=0;e<=t.length-1;e++)switch(e){case 0:f=t[e+1].x-t[e].x,g=t[e+1].y-t[e].y,d.x=1*g,d.y=-f,d.z=0*g,m.copy(d),d.normalize(),o.push(d.x,d.y,d.z);break;case t.length-1:o.push(m.x,m.y,m.z);break;default:f=t[e+1].x-t[e].x,g=t[e+1].y-t[e].y,d.x=1*g,d.y=-f,d.z=0*g,p.copy(d),d.x+=m.x,d.y+=m.y,d.z+=m.z,d.normalize(),o.push(d.x,d.y,d.z),m.copy(p)}for(let s=0;s<=e;s++){const d=i+s*l*n,p=Math.sin(d),m=Math.cos(d);for(let i=0;i<=t.length-1;i++){c.x=t[i].x*p,c.y=t[i].y,c.z=t[i].x*m,r.push(c.x,c.y,c.z),u.x=s/e,u.y=i/(t.length-1),a.push(u.x,u.y);const n=o[3*i+0]*p,l=o[3*i+1],d=o[3*i+0]*m;h.push(n,l,d)}}for(let i=0;i<e;i++)for(let e=0;e<t.length-1;e++){const n=e+i*t.length,r=n,a=n+t.length,o=n+t.length+1,h=n+1;s.push(r,a,h),s.push(o,h,a)}this.setIndex(s),this.setAttribute("position",new ln(r,3)),this.setAttribute("uv",new ln(a,2)),this.setAttribute("normal",new ln(h,3))}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}static fromJSON(t){return new Nh(t.points,t.segments,t.phiStart,t.phiLength)}}class Bh extends Nh{constructor(t=1,e=1,i=4,n=8){const s=new Oh;s.absarc(0,-e/2,t,1.5*Math.PI,0),s.absarc(0,e/2,t,0,.5*Math.PI),super(s.getPoints(i),n),this.type="CapsuleGeometry",this.parameters={radius:t,length:e,capSegments:i,radialSegments:n}}static fromJSON(t){return new Bh(t.radius,t.length,t.capSegments,t.radialSegments)}}class zh extends vn{constructor(t=1,e=32,i=0,n=2*Math.PI){super(),this.type="CircleGeometry",this.parameters={radius:t,segments:e,thetaStart:i,thetaLength:n},e=Math.max(3,e);const s=[],r=[],a=[],o=[],h=new Le,l=new se;r.push(0,0,0),a.push(0,0,1),o.push(.5,.5);for(let s=0,c=3;s<=e;s++,c+=3){const u=i+s/e*n;h.x=t*Math.cos(u),h.y=t*Math.sin(u),r.push(h.x,h.y,h.z),a.push(0,0,1),l.x=(r[c]/t+1)/2,l.y=(r[c+1]/t+1)/2,o.push(l.x,l.y)}for(let t=1;t<=e;t++)s.push(t,t+1,0);this.setIndex(s),this.setAttribute("position",new ln(r,3)),this.setAttribute("normal",new ln(a,3)),this.setAttribute("uv",new ln(o,2))}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}static fromJSON(t){return new zh(t.radius,t.segments,t.thetaStart,t.thetaLength)}}class Uh extends vn{constructor(t=1,e=1,i=1,n=32,s=1,r=!1,a=0,o=2*Math.PI){super(),this.type="CylinderGeometry",this.parameters={radiusTop:t,radiusBottom:e,height:i,radialSegments:n,heightSegments:s,openEnded:r,thetaStart:a,thetaLength:o};const h=this;n=Math.floor(n),s=Math.floor(s);const l=[],c=[],u=[],d=[];let p=0;const m=[],f=i/2;let g=0;function v(i){const s=p,r=new se,m=new Le;let v=0;const y=!0===i?t:e,x=!0===i?1:-1;for(let t=1;t<=n;t++)c.push(0,f*x,0),u.push(0,x,0),d.push(.5,.5),p++;const b=p;for(let t=0;t<=n;t++){const e=t/n*o+a,i=Math.cos(e),s=Math.sin(e);m.x=y*s,m.y=f*x,m.z=y*i,c.push(m.x,m.y,m.z),u.push(0,x,0),r.x=.5*i+.5,r.y=.5*s*x+.5,d.push(r.x,r.y),p++}for(let t=0;t<n;t++){const e=s+t,n=b+t;!0===i?l.push(n,n+1,e):l.push(n+1,n,e),v+=3}h.addGroup(g,v,!0===i?1:2),g+=v}!function(){const r=new Le,v=new Le;let y=0;const x=(e-t)/i;for(let h=0;h<=s;h++){const l=[],g=h/s,y=g*(e-t)+t;for(let t=0;t<=n;t++){const e=t/n,s=e*o+a,h=Math.sin(s),m=Math.cos(s);v.x=y*h,v.y=-g*i+f,v.z=y*m,c.push(v.x,v.y,v.z),r.set(h,x,m).normalize(),u.push(r.x,r.y,r.z),d.push(e,1-g),l.push(p++)}m.push(l)}for(let t=0;t<n;t++)for(let e=0;e<s;e++){const i=m[e][t],n=m[e+1][t],s=m[e+1][t+1],r=m[e][t+1];l.push(i,n,r),l.push(n,s,r),y+=6}h.addGroup(g,y,0),g+=y}(),!1===r&&(t>0&&v(!0),e>0&&v(!1)),this.setIndex(l),this.setAttribute("position",new ln(c,3)),this.setAttribute("normal",new ln(u,3)),this.setAttribute("uv",new ln(d,2))}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}static fromJSON(t){return new Uh(t.radiusTop,t.radiusBottom,t.height,t.radialSegments,t.heightSegments,t.openEnded,t.thetaStart,t.thetaLength)}}class Fh extends Uh{constructor(t=1,e=1,i=32,n=1,s=!1,r=0,a=2*Math.PI){super(0,t,e,i,n,s,r,a),this.type="ConeGeometry",this.parameters={radius:t,height:e,radialSegments:i,heightSegments:n,openEnded:s,thetaStart:r,thetaLength:a}}static fromJSON(t){return new Fh(t.radius,t.height,t.radialSegments,t.heightSegments,t.openEnded,t.thetaStart,t.thetaLength)}}class Gh extends vn{constructor(t=[],e=[],i=1,n=0){super(),this.type="PolyhedronGeometry",this.parameters={vertices:t,indices:e,radius:i,detail:n};const s=[],r=[];function a(t,e,i,n){const s=n+1,r=[];for(let n=0;n<=s;n++){r[n]=[];const a=t.clone().lerp(i,n/s),o=e.clone().lerp(i,n/s),h=s-n;for(let t=0;t<=h;t++)r[n][t]=0===t&&n===s?a:a.clone().lerp(o,t/h)}for(let t=0;t<s;t++)for(let e=0;e<2*(s-t)-1;e++){const i=Math.floor(e/2);e%2==0?(o(r[t][i+1]),o(r[t+1][i]),o(r[t][i])):(o(r[t][i+1]),o(r[t+1][i+1]),o(r[t+1][i]))}}function o(t){s.push(t.x,t.y,t.z)}function h(e,i){const n=3*e;i.x=t[n+0],i.y=t[n+1],i.z=t[n+2]}function l(t,e,i,n){n<0&&1===t.x&&(r[e]=t.x-1),0===i.x&&0===i.z&&(r[e]=n/2/Math.PI+.5)}function c(t){return Math.atan2(t.z,-t.x)}!function(t){const i=new Le,n=new Le,s=new Le;for(let r=0;r<e.length;r+=3)h(e[r+0],i),h(e[r+1],n),h(e[r+2],s),a(i,n,s,t)}(n),function(t){const e=new Le;for(let i=0;i<s.length;i+=3)e.x=s[i+0],e.y=s[i+1],e.z=s[i+2],e.normalize().multiplyScalar(t),s[i+0]=e.x,s[i+1]=e.y,s[i+2]=e.z}(i),function(){const t=new Le;for(let i=0;i<s.length;i+=3){t.x=s[i+0],t.y=s[i+1],t.z=s[i+2];const n=c(t)/2/Math.PI+.5,a=(e=t,Math.atan2(-e.y,Math.sqrt(e.x*e.x+e.z*e.z))/Math.PI+.5);r.push(n,1-a)}var e;(function(){const t=new Le,e=new Le,i=new Le,n=new Le,a=new se,o=new se,h=new se;for(let u=0,d=0;u<s.length;u+=9,d+=6){t.set(s[u+0],s[u+1],s[u+2]),e.set(s[u+3],s[u+4],s[u+5]),i.set(s[u+6],s[u+7],s[u+8]),a.set(r[d+0],r[d+1]),o.set(r[d+2],r[d+3]),h.set(r[d+4],r[d+5]),n.copy(t).add(e).add(i).divideScalar(3);const p=c(n);l(a,d+0,t,p),l(o,d+2,e,p),l(h,d+4,i,p)}})(),function(){for(let t=0;t<r.length;t+=6){const e=r[t+0],i=r[t+2],n=r[t+4],s=Math.max(e,i,n),a=Math.min(e,i,n);s>.9&&a<.1&&(e<.2&&(r[t+0]+=1),i<.2&&(r[t+2]+=1),n<.2&&(r[t+4]+=1))}}()}(),this.setAttribute("position",new ln(s,3)),this.setAttribute("normal",new ln(s.slice(),3)),this.setAttribute("uv",new ln(r,2)),0===n?this.computeVertexNormals():this.normalizeNormals()}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}static fromJSON(t){return new Gh(t.vertices,t.indices,t.radius,t.details)}}class Vh extends Gh{constructor(t=1,e=0){const i=(1+Math.sqrt(5))/2,n=1/i;super([-1,-1,-1,-1,-1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,1,1,1,-1,1,1,1,0,-n,-i,0,-n,i,0,n,-i,0,n,i,-n,-i,0,-n,i,0,n,-i,0,n,i,0,-i,0,-n,i,0,-n,-i,0,n,i,0,n],[3,11,7,3,7,15,3,15,13,7,19,17,7,17,6,7,6,15,17,4,8,17,8,10,17,10,6,8,0,16,8,16,2,8,2,10,0,12,1,0,1,18,0,18,16,6,10,2,6,2,13,6,13,15,2,16,18,2,18,3,2,3,13,18,1,9,18,9,11,18,11,3,4,14,12,4,12,0,4,0,8,11,9,5,11,5,19,11,19,7,19,5,14,19,14,4,19,4,17,1,12,14,1,14,5,1,5,9],t,e),this.type="DodecahedronGeometry",this.parameters={radius:t,detail:e}}static fromJSON(t){return new Vh(t.radius,t.detail)}}const Hh=new Le,jh=new Le,Wh=new Le,Xh=new qi;class qh extends Oh{constructor(t){super(t),this.uuid=Jt(),this.type="Shape",this.holes=[]}getPointsHoles(t){const e=[];for(let i=0,n=this.holes.length;i<n;i++)e[i]=this.holes[i].getPoints(t);return e}extractPoints(t){return{shape:this.getPoints(t),holes:this.getPointsHoles(t)}}copy(t){super.copy(t),this.holes=[];for(let e=0,i=t.holes.length;e<i;e++){const i=t.holes[e];this.holes.push(i.clone())}return this}toJSON(){const t=super.toJSON();t.uuid=this.uuid,t.holes=[];for(let e=0,i=this.holes.length;e<i;e++){const i=this.holes[e];t.holes.push(i.toJSON())}return t}fromJSON(t){super.fromJSON(t),this.uuid=t.uuid,this.holes=[];for(let e=0,i=t.holes.length;e<i;e++){const i=t.holes[e];this.holes.push((new Oh).fromJSON(i))}return this}}const Yh=function(t,e,i=2){const n=e&&e.length,s=n?e[0]*i:t.length;let r=Jh(t,0,s,i,!0);const a=[];if(!r||r.next===r.prev)return a;let o,h,l,c,u,d,p;if(n&&(r=function(t,e,i,n){const s=[];let r,a,o,h,l;for(r=0,a=e.length;r<a;r++)o=e[r]*n,h=r<a-1?e[r+1]*n:t.length,l=Jh(t,o,h,n,!1),l===l.next&&(l.steiner=!0),s.push(al(l));for(s.sort(il),r=0;r<s.length;r++)i=nl(s[r],i);return i}(t,e,r,i)),t.length>80*i){o=l=t[0],h=c=t[1];for(let e=i;e<s;e+=i)u=t[e],d=t[e+1],u<o&&(o=u),d<h&&(h=d),u>l&&(l=u),d>c&&(c=d);p=Math.max(l-o,c-h),p=0!==p?32767/p:0}return Kh(r,a,i,o,h,p,0),a};function Jh(t,e,i,n,s){let r,a;if(s===function(t,e,i,n){let s=0;for(let r=e,a=i-n;r<i;r+=n)s+=(t[a]-t[r])*(t[r+1]+t[a+1]),a=r;return s}(t,e,i,n)>0)for(r=e;r<i;r+=n)a=gl(r,t[r],t[r+1],a);else for(r=i-n;r>=e;r-=n)a=gl(r,t[r],t[r+1],a);return a&&cl(a,a.next)&&(vl(a),a=a.next),a}function $h(t,e){if(!t)return t;e||(e=t);let i,n=t;do{if(i=!1,n.steiner||!cl(n,n.next)&&0!==ll(n.prev,n,n.next))n=n.next;else{if(vl(n),n=e=n.prev,n===n.next)break;i=!0}}while(i||n!==e);return e}function Kh(t,e,i,n,s,r,a){if(!t)return;!a&&r&&function(t,e,i,n){let s=t;do{0===s.z&&(s.z=rl(s.x,s.y,e,i,n)),s.prevZ=s.prev,s.nextZ=s.next,s=s.next}while(s!==t);s.prevZ.nextZ=null,s.prevZ=null,function(t){let e,i,n,s,r,a,o,h,l=1;do{for(i=t,t=null,r=null,a=0;i;){for(a++,n=i,o=0,e=0;e<l&&(o++,n=n.nextZ,n);e++);for(h=l;o>0||h>0&&n;)0!==o&&(0===h||!n||i.z<=n.z)?(s=i,i=i.nextZ,o--):(s=n,n=n.nextZ,h--),r?r.nextZ=s:t=s,s.prevZ=r,r=s;i=n}r.nextZ=null,l*=2}while(a>1)}(s)}(t,n,s,r);let o,h,l=t;for(;t.prev!==t.next;)if(o=t.prev,h=t.next,r?Qh(t,n,s,r):Zh(t))e.push(o.i/i|0),e.push(t.i/i|0),e.push(h.i/i|0),vl(t),t=h.next,l=h.next;else if((t=h)===l){a?1===a?Kh(t=tl($h(t),e,i),e,i,n,s,r,2):2===a&&el(t,e,i,n,s,r):Kh($h(t),e,i,n,s,r,1);break}}function Zh(t){const e=t.prev,i=t,n=t.next;if(ll(e,i,n)>=0)return!1;const s=e.x,r=i.x,a=n.x,o=e.y,h=i.y,l=n.y,c=s<r?s<a?s:a:r<a?r:a,u=o<h?o<l?o:l:h<l?h:l,d=s>r?s>a?s:a:r>a?r:a,p=o>h?o>l?o:l:h>l?h:l;let m=n.next;for(;m!==e;){if(m.x>=c&&m.x<=d&&m.y>=u&&m.y<=p&&ol(s,o,r,h,a,l,m.x,m.y)&&ll(m.prev,m,m.next)>=0)return!1;m=m.next}return!0}function Qh(t,e,i,n){const s=t.prev,r=t,a=t.next;if(ll(s,r,a)>=0)return!1;const o=s.x,h=r.x,l=a.x,c=s.y,u=r.y,d=a.y,p=o<h?o<l?o:l:h<l?h:l,m=c<u?c<d?c:d:u<d?u:d,f=o>h?o>l?o:l:h>l?h:l,g=c>u?c>d?c:d:u>d?u:d,v=rl(p,m,e,i,n),y=rl(f,g,e,i,n);let x=t.prevZ,b=t.nextZ;for(;x&&x.z>=v&&b&&b.z<=y;){if(x.x>=p&&x.x<=f&&x.y>=m&&x.y<=g&&x!==s&&x!==a&&ol(o,c,h,u,l,d,x.x,x.y)&&ll(x.prev,x,x.next)>=0)return!1;if(x=x.prevZ,b.x>=p&&b.x<=f&&b.y>=m&&b.y<=g&&b!==s&&b!==a&&ol(o,c,h,u,l,d,b.x,b.y)&&ll(b.prev,b,b.next)>=0)return!1;b=b.nextZ}for(;x&&x.z>=v;){if(x.x>=p&&x.x<=f&&x.y>=m&&x.y<=g&&x!==s&&x!==a&&ol(o,c,h,u,l,d,x.x,x.y)&&ll(x.prev,x,x.next)>=0)return!1;x=x.prevZ}for(;b&&b.z<=y;){if(b.x>=p&&b.x<=f&&b.y>=m&&b.y<=g&&b!==s&&b!==a&&ol(o,c,h,u,l,d,b.x,b.y)&&ll(b.prev,b,b.next)>=0)return!1;b=b.nextZ}return!0}function tl(t,e,i){let n=t;do{const s=n.prev,r=n.next.next;!cl(s,r)&&ul(s,n,n.next,r)&&ml(s,r)&&ml(r,s)&&(e.push(s.i/i|0),e.push(n.i/i|0),e.push(r.i/i|0),vl(n),vl(n.next),n=t=r),n=n.next}while(n!==t);return $h(n)}function el(t,e,i,n,s,r){let a=t;do{let t=a.next.next;for(;t!==a.prev;){if(a.i!==t.i&&hl(a,t)){let o=fl(a,t);return a=$h(a,a.next),o=$h(o,o.next),Kh(a,e,i,n,s,r,0),void Kh(o,e,i,n,s,r,0)}t=t.next}a=a.next}while(a!==t)}function il(t,e){return t.x-e.x}function nl(t,e){const i=function(t,e){let i,n=e,s=-1/0;const r=t.x,a=t.y;do{if(a<=n.y&&a>=n.next.y&&n.next.y!==n.y){const t=n.x+(a-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(t<=r&&t>s&&(s=t,i=n.x<n.next.x?n:n.next,t===r))return i}n=n.next}while(n!==e);if(!i)return null;const o=i,h=i.x,l=i.y;let c,u=1/0;n=i;do{r>=n.x&&n.x>=h&&r!==n.x&&ol(a<l?r:s,a,h,l,a<l?s:r,a,n.x,n.y)&&(c=Math.abs(a-n.y)/(r-n.x),ml(n,t)&&(c<u||c===u&&(n.x>i.x||n.x===i.x&&sl(i,n)))&&(i=n,u=c)),n=n.next}while(n!==o);return i}(t,e);if(!i)return e;const n=fl(i,t);return $h(n,n.next),$h(i,i.next)}function sl(t,e){return ll(t.prev,t,e.prev)<0&&ll(e.next,t,t.next)<0}function rl(t,e,i,n,s){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-i)*s|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-n)*s|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function al(t){let e=t,i=t;do{(e.x<i.x||e.x===i.x&&e.y<i.y)&&(i=e),e=e.next}while(e!==t);return i}function ol(t,e,i,n,s,r,a,o){return(s-a)*(e-o)>=(t-a)*(r-o)&&(t-a)*(n-o)>=(i-a)*(e-o)&&(i-a)*(r-o)>=(s-a)*(n-o)}function hl(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){let i=t;do{if(i.i!==t.i&&i.next.i!==t.i&&i.i!==e.i&&i.next.i!==e.i&&ul(i,i.next,t,e))return!0;i=i.next}while(i!==t);return!1}(t,e)&&(ml(t,e)&&ml(e,t)&&function(t,e){let i=t,n=!1;const s=(t.x+e.x)/2,r=(t.y+e.y)/2;do{i.y>r!=i.next.y>r&&i.next.y!==i.y&&s<(i.next.x-i.x)*(r-i.y)/(i.next.y-i.y)+i.x&&(n=!n),i=i.next}while(i!==t);return n}(t,e)&&(ll(t.prev,t,e.prev)||ll(t,e.prev,e))||cl(t,e)&&ll(t.prev,t,t.next)>0&&ll(e.prev,e,e.next)>0)}function ll(t,e,i){return(e.y-t.y)*(i.x-e.x)-(e.x-t.x)*(i.y-e.y)}function cl(t,e){return t.x===e.x&&t.y===e.y}function ul(t,e,i,n){const s=pl(ll(t,e,i)),r=pl(ll(t,e,n)),a=pl(ll(i,n,t)),o=pl(ll(i,n,e));return s!==r&&a!==o||(!(0!==s||!dl(t,i,e))||(!(0!==r||!dl(t,n,e))||(!(0!==a||!dl(i,t,n))||!(0!==o||!dl(i,e,n)))))}function dl(t,e,i){return e.x<=Math.max(t.x,i.x)&&e.x>=Math.min(t.x,i.x)&&e.y<=Math.max(t.y,i.y)&&e.y>=Math.min(t.y,i.y)}function pl(t){return t>0?1:t<0?-1:0}function ml(t,e){return ll(t.prev,t,t.next)<0?ll(t,e,t.next)>=0&&ll(t,t.prev,e)>=0:ll(t,e,t.prev)<0||ll(t,t.next,e)<0}function fl(t,e){const i=new yl(t.i,t.x,t.y),n=new yl(e.i,e.x,e.y),s=t.next,r=e.prev;return t.next=e,e.prev=t,i.next=s,s.prev=i,n.next=i,i.prev=n,r.next=n,n.prev=r,n}function gl(t,e,i,n){const s=new yl(t,e,i);return n?(s.next=n.next,s.prev=n,n.next.prev=s,n.next=s):(s.prev=s,s.next=s),s}function vl(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function yl(t,e,i){this.i=t,this.x=e,this.y=i,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}class xl{static area(t){const e=t.length;let i=0;for(let n=e-1,s=0;s<e;n=s++)i+=t[n].x*t[s].y-t[s].x*t[n].y;return.5*i}static isClockWise(t){return xl.area(t)<0}static triangulateShape(t,e){const i=[],n=[],s=[];bl(t),_l(i,t);let r=t.length;e.forEach(bl);for(let t=0;t<e.length;t++)n.push(r),r+=e[t].length,_l(i,e[t]);const a=Yh(i,n);for(let t=0;t<a.length;t+=3)s.push(a.slice(t,t+3));return s}}function bl(t){const e=t.length;e>2&&t[e-1].equals(t[0])&&t.pop()}function _l(t,e){for(let i=0;i<e.length;i++)t.push(e[i].x),t.push(e[i].y)}class wl extends vn{constructor(t=new qh([new se(.5,.5),new se(-.5,.5),new se(-.5,-.5),new se(.5,-.5)]),e={}){super(),this.type="ExtrudeGeometry",this.parameters={shapes:t,options:e},t=Array.isArray(t)?t:[t];const i=this,n=[],s=[];for(let e=0,i=t.length;e<i;e++){r(t[e])}function r(t){const r=[],a=void 0!==e.curveSegments?e.curveSegments:12,o=void 0!==e.steps?e.steps:1,h=void 0!==e.depth?e.depth:1;let l=void 0===e.bevelEnabled||e.bevelEnabled,c=void 0!==e.bevelThickness?e.bevelThickness:.2,u=void 0!==e.bevelSize?e.bevelSize:c-.1,d=void 0!==e.bevelOffset?e.bevelOffset:0,p=void 0!==e.bevelSegments?e.bevelSegments:3;const m=e.extrudePath,f=void 0!==e.UVGenerator?e.UVGenerator:Ml;let g,v,y,x,b,_=!1;m&&(g=m.getSpacedPoints(o),_=!0,l=!1,v=m.computeFrenetFrames(o,!1),y=new Le,x=new Le,b=new Le),l||(p=0,c=0,u=0,d=0);const w=t.extractPoints(a);let M=w.shape;const S=w.holes;if(!xl.isClockWise(M)){M=M.reverse();for(let t=0,e=S.length;t<e;t++){const e=S[t];xl.isClockWise(e)&&(S[t]=e.reverse())}}const E=xl.triangulateShape(M,S),T=M;for(let t=0,e=S.length;t<e;t++){const e=S[t];M=M.concat(e)}function A(t,e,i){return t.clone().addScaledVector(e,i)}const C=M.length,I=E.length;function R(t,e,i){let n,s,r;const a=t.x-e.x,o=t.y-e.y,h=i.x-t.x,l=i.y-t.y,c=a*a+o*o,u=a*l-o*h;if(Math.abs(u)>Number.EPSILON){const u=Math.sqrt(c),d=Math.sqrt(h*h+l*l),p=e.x-o/u,m=e.y+a/u,f=((i.x-l/d-p)*l-(i.y+h/d-m)*h)/(a*l-o*h);n=p+a*f-t.x,s=m+o*f-t.y;const g=n*n+s*s;if(g<=2)return new se(n,s);r=Math.sqrt(g/2)}else{let t=!1;a>Number.EPSILON?h>Number.EPSILON&&(t=!0):a<-Number.EPSILON?h<-Number.EPSILON&&(t=!0):Math.sign(o)===Math.sign(l)&&(t=!0),t?(n=-o,s=a,r=Math.sqrt(c)):(n=a,s=o,r=Math.sqrt(c/2))}return new se(n/r,s/r)}const k=[];for(let t=0,e=T.length,i=e-1,n=t+1;t<e;t++,i++,n++)i===e&&(i=0),n===e&&(n=0),k[t]=R(T[t],T[i],T[n]);const P=[];let D,L=k.concat();for(let t=0,e=S.length;t<e;t++){const e=S[t];D=[];for(let t=0,i=e.length,n=i-1,s=t+1;t<i;t++,n++,s++)n===i&&(n=0),s===i&&(s=0),D[t]=R(e[t],e[n],e[s]);P.push(D),L=L.concat(D)}for(let t=0;t<p;t++){const e=t/p,i=c*Math.cos(e*Math.PI/2),n=u*Math.sin(e*Math.PI/2)+d;for(let t=0,e=T.length;t<e;t++){const e=A(T[t],k[t],n);B(e.x,e.y,-i)}for(let t=0,e=S.length;t<e;t++){const e=S[t];D=P[t];for(let t=0,s=e.length;t<s;t++){const s=A(e[t],D[t],n);B(s.x,s.y,-i)}}}const O=u+d;for(let t=0;t<C;t++){const e=l?A(M[t],L[t],O):M[t];_?(x.copy(v.normals[0]).multiplyScalar(e.x),y.copy(v.binormals[0]).multiplyScalar(e.y),b.copy(g[0]).add(x).add(y),B(b.x,b.y,b.z)):B(e.x,e.y,0)}for(let t=1;t<=o;t++)for(let e=0;e<C;e++){const i=l?A(M[e],L[e],O):M[e];_?(x.copy(v.normals[t]).multiplyScalar(i.x),y.copy(v.binormals[t]).multiplyScalar(i.y),b.copy(g[t]).add(x).add(y),B(b.x,b.y,b.z)):B(i.x,i.y,h/o*t)}for(let t=p-1;t>=0;t--){const e=t/p,i=c*Math.cos(e*Math.PI/2),n=u*Math.sin(e*Math.PI/2)+d;for(let t=0,e=T.length;t<e;t++){const e=A(T[t],k[t],n);B(e.x,e.y,h+i)}for(let t=0,e=S.length;t<e;t++){const e=S[t];D=P[t];for(let t=0,s=e.length;t<s;t++){const s=A(e[t],D[t],n);_?B(s.x,s.y+g[o-1].y,g[o-1].x+i):B(s.x,s.y,h+i)}}}function N(t,e){let i=t.length;for(;--i>=0;){const n=i;let s=i-1;s<0&&(s=t.length-1);for(let t=0,i=o+2*p;t<i;t++){const i=C*t,r=C*(t+1);U(e+n+i,e+s+i,e+s+r,e+n+r)}}}function B(t,e,i){r.push(t),r.push(e),r.push(i)}function z(t,e,s){F(t),F(e),F(s);const r=n.length/3,a=f.generateTopUV(i,n,r-3,r-2,r-1);G(a[0]),G(a[1]),G(a[2])}function U(t,e,s,r){F(t),F(e),F(r),F(e),F(s),F(r);const a=n.length/3,o=f.generateSideWallUV(i,n,a-6,a-3,a-2,a-1);G(o[0]),G(o[1]),G(o[3]),G(o[1]),G(o[2]),G(o[3])}function F(t){n.push(r[3*t+0]),n.push(r[3*t+1]),n.push(r[3*t+2])}function G(t){s.push(t.x),s.push(t.y)}!function(){const t=n.length/3;if(l){let t=0,e=C*t;for(let t=0;t<I;t++){const i=E[t];z(i[2]+e,i[1]+e,i[0]+e)}t=o+2*p,e=C*t;for(let t=0;t<I;t++){const i=E[t];z(i[0]+e,i[1]+e,i[2]+e)}}else{for(let t=0;t<I;t++){const e=E[t];z(e[2],e[1],e[0])}for(let t=0;t<I;t++){const e=E[t];z(e[0]+C*o,e[1]+C*o,e[2]+C*o)}}i.addGroup(t,n.length/3-t,0)}(),function(){const t=n.length/3;let e=0;N(T,e),e+=T.length;for(let t=0,i=S.length;t<i;t++){const i=S[t];N(i,e),e+=i.length}i.addGroup(t,n.length/3-t,1)}()}this.setAttribute("position",new ln(n,3)),this.setAttribute("uv",new ln(s,2)),this.computeVertexNormals()}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}toJSON(){const t=super.toJSON();return function(t,e,i){if(i.shapes=[],Array.isArray(t))for(let e=0,n=t.length;e<n;e++){const n=t[e];i.shapes.push(n.uuid)}else i.shapes.push(t.uuid);i.options=Object.assign({},e),void 0!==e.extrudePath&&(i.options.extrudePath=e.extrudePath.toJSON());return i}(this.parameters.shapes,this.parameters.options,t)}static fromJSON(t,e){const i=[];for(let n=0,s=t.shapes.length;n<s;n++){const s=e[t.shapes[n]];i.push(s)}const n=t.options.extrudePath;return void 0!==n&&(t.options.extrudePath=(new Dh[n.type]).fromJSON(n)),new wl(i,t.options)}}const Ml={generateTopUV:function(t,e,i,n,s){const r=e[3*i],a=e[3*i+1],o=e[3*n],h=e[3*n+1],l=e[3*s],c=e[3*s+1];return[new se(r,a),new se(o,h),new se(l,c)]},generateSideWallUV:function(t,e,i,n,s,r){const a=e[3*i],o=e[3*i+1],h=e[3*i+2],l=e[3*n],c=e[3*n+1],u=e[3*n+2],d=e[3*s],p=e[3*s+1],m=e[3*s+2],f=e[3*r],g=e[3*r+1],v=e[3*r+2];return Math.abs(o-c)<Math.abs(a-l)?[new se(a,1-h),new se(l,1-u),new se(d,1-m),new se(f,1-v)]:[new se(o,1-h),new se(c,1-u),new se(p,1-m),new se(g,1-v)]}};class Sl extends Gh{constructor(t=1,e=0){const i=(1+Math.sqrt(5))/2;super([-1,i,0,1,i,0,-1,-i,0,1,-i,0,0,-1,i,0,1,i,0,-1,-i,0,1,-i,i,0,-1,i,0,1,-i,0,-1,-i,0,1],[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1],t,e),this.type="IcosahedronGeometry",this.parameters={radius:t,detail:e}}static fromJSON(t){return new Sl(t.radius,t.detail)}}class El extends Gh{constructor(t=1,e=0){super([1,0,0,-1,0,0,0,1,0,0,-1,0,0,0,1,0,0,-1],[0,2,4,0,4,3,0,3,5,0,5,2,1,2,5,1,5,3,1,3,4,1,4,2],t,e),this.type="OctahedronGeometry",this.parameters={radius:t,detail:e}}static fromJSON(t){return new El(t.radius,t.detail)}}class Tl extends vn{constructor(t=.5,e=1,i=32,n=1,s=0,r=2*Math.PI){super(),this.type="RingGeometry",this.parameters={innerRadius:t,outerRadius:e,thetaSegments:i,phiSegments:n,thetaStart:s,thetaLength:r},i=Math.max(3,i);const a=[],o=[],h=[],l=[];let c=t;const u=(e-t)/(n=Math.max(1,n)),d=new Le,p=new se;for(let t=0;t<=n;t++){for(let t=0;t<=i;t++){const n=s+t/i*r;d.x=c*Math.cos(n),d.y=c*Math.sin(n),o.push(d.x,d.y,d.z),h.push(0,0,1),p.x=(d.x/e+1)/2,p.y=(d.y/e+1)/2,l.push(p.x,p.y)}c+=u}for(let t=0;t<n;t++){const e=t*(i+1);for(let t=0;t<i;t++){const n=t+e,s=n,r=n+i+1,o=n+i+2,h=n+1;a.push(s,r,h),a.push(r,o,h)}}this.setIndex(a),this.setAttribute("position",new ln(o,3)),this.setAttribute("normal",new ln(h,3)),this.setAttribute("uv",new ln(l,2))}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}static fromJSON(t){return new Tl(t.innerRadius,t.outerRadius,t.thetaSegments,t.phiSegments,t.thetaStart,t.thetaLength)}}class Al extends vn{constructor(t=new qh([new se(0,.5),new se(-.5,-.5),new se(.5,-.5)]),e=12){super(),this.type="ShapeGeometry",this.parameters={shapes:t,curveSegments:e};const i=[],n=[],s=[],r=[];let a=0,o=0;if(!1===Array.isArray(t))h(t);else for(let e=0;e<t.length;e++)h(t[e]),this.addGroup(a,o,e),a+=o,o=0;function h(t){const a=n.length/3,h=t.extractPoints(e);let l=h.shape;const c=h.holes;!1===xl.isClockWise(l)&&(l=l.reverse());for(let t=0,e=c.length;t<e;t++){const e=c[t];!0===xl.isClockWise(e)&&(c[t]=e.reverse())}const u=xl.triangulateShape(l,c);for(let t=0,e=c.length;t<e;t++){const e=c[t];l=l.concat(e)}for(let t=0,e=l.length;t<e;t++){const e=l[t];n.push(e.x,e.y,0),s.push(0,0,1),r.push(e.x,e.y)}for(let t=0,e=u.length;t<e;t++){const e=u[t],n=e[0]+a,s=e[1]+a,r=e[2]+a;i.push(n,s,r),o+=3}}this.setIndex(i),this.setAttribute("position",new ln(n,3)),this.setAttribute("normal",new ln(s,3)),this.setAttribute("uv",new ln(r,2))}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}toJSON(){const t=super.toJSON();return function(t,e){if(e.shapes=[],Array.isArray(t))for(let i=0,n=t.length;i<n;i++){const n=t[i];e.shapes.push(n.uuid)}else e.shapes.push(t.uuid);return e}(this.parameters.shapes,t)}static fromJSON(t,e){const i=[];for(let n=0,s=t.shapes.length;n<s;n++){const s=e[t.shapes[n]];i.push(s)}return new Al(i,t.curveSegments)}}class Cl extends vn{constructor(t=1,e=32,i=16,n=0,s=2*Math.PI,r=0,a=Math.PI){super(),this.type="SphereGeometry",this.parameters={radius:t,widthSegments:e,heightSegments:i,phiStart:n,phiLength:s,thetaStart:r,thetaLength:a},e=Math.max(3,Math.floor(e)),i=Math.max(2,Math.floor(i));const o=Math.min(r+a,Math.PI);let h=0;const l=[],c=new Le,u=new Le,d=[],p=[],m=[],f=[];for(let d=0;d<=i;d++){const g=[],v=d/i;let y=0;0===d&&0===r?y=.5/e:d===i&&o===Math.PI&&(y=-.5/e);for(let i=0;i<=e;i++){const o=i/e;c.x=-t*Math.cos(n+o*s)*Math.sin(r+v*a),c.y=t*Math.cos(r+v*a),c.z=t*Math.sin(n+o*s)*Math.sin(r+v*a),p.push(c.x,c.y,c.z),u.copy(c).normalize(),m.push(u.x,u.y,u.z),f.push(o+y,1-v),g.push(h++)}l.push(g)}for(let t=0;t<i;t++)for(let n=0;n<e;n++){const e=l[t][n+1],s=l[t][n],a=l[t+1][n],h=l[t+1][n+1];(0!==t||r>0)&&d.push(e,s,h),(t!==i-1||o<Math.PI)&&d.push(s,a,h)}this.setIndex(d),this.setAttribute("position",new ln(p,3)),this.setAttribute("normal",new ln(m,3)),this.setAttribute("uv",new ln(f,2))}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}static fromJSON(t){return new Cl(t.radius,t.widthSegments,t.heightSegments,t.phiStart,t.phiLength,t.thetaStart,t.thetaLength)}}class Il extends Gh{constructor(t=1,e=0){super([1,1,1,-1,-1,1,-1,1,-1,1,-1,-1],[2,1,0,0,3,2,1,3,0,2,3,1],t,e),this.type="TetrahedronGeometry",this.parameters={radius:t,detail:e}}static fromJSON(t){return new Il(t.radius,t.detail)}}class Rl extends vn{constructor(t=1,e=.4,i=12,n=48,s=2*Math.PI){super(),this.type="TorusGeometry",this.parameters={radius:t,tube:e,radialSegments:i,tubularSegments:n,arc:s},i=Math.floor(i),n=Math.floor(n);const r=[],a=[],o=[],h=[],l=new Le,c=new Le,u=new Le;for(let r=0;r<=i;r++)for(let d=0;d<=n;d++){const p=d/n*s,m=r/i*Math.PI*2;c.x=(t+e*Math.cos(m))*Math.cos(p),c.y=(t+e*Math.cos(m))*Math.sin(p),c.z=e*Math.sin(m),a.push(c.x,c.y,c.z),l.x=t*Math.cos(p),l.y=t*Math.sin(p),u.subVectors(c,l).normalize(),o.push(u.x,u.y,u.z),h.push(d/n),h.push(r/i)}for(let t=1;t<=i;t++)for(let e=1;e<=n;e++){const i=(n+1)*t+e-1,s=(n+1)*(t-1)+e-1,a=(n+1)*(t-1)+e,o=(n+1)*t+e;r.push(i,s,o),r.push(s,a,o)}this.setIndex(r),this.setAttribute("position",new ln(a,3)),this.setAttribute("normal",new ln(o,3)),this.setAttribute("uv",new ln(h,2))}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}static fromJSON(t){return new Rl(t.radius,t.tube,t.radialSegments,t.tubularSegments,t.arc)}}class kl extends vn{constructor(t=1,e=.4,i=64,n=8,s=2,r=3){super(),this.type="TorusKnotGeometry",this.parameters={radius:t,tube:e,tubularSegments:i,radialSegments:n,p:s,q:r},i=Math.floor(i),n=Math.floor(n);const a=[],o=[],h=[],l=[],c=new Le,u=new Le,d=new Le,p=new Le,m=new Le,f=new Le,g=new Le;for(let a=0;a<=i;++a){const y=a/i*s*Math.PI*2;v(y,s,r,t,d),v(y+.01,s,r,t,p),f.subVectors(p,d),g.addVectors(p,d),m.crossVectors(f,g),g.crossVectors(m,f),m.normalize(),g.normalize();for(let t=0;t<=n;++t){const s=t/n*Math.PI*2,r=-e*Math.cos(s),p=e*Math.sin(s);c.x=d.x+(r*g.x+p*m.x),c.y=d.y+(r*g.y+p*m.y),c.z=d.z+(r*g.z+p*m.z),o.push(c.x,c.y,c.z),u.subVectors(c,d).normalize(),h.push(u.x,u.y,u.z),l.push(a/i),l.push(t/n)}}for(let t=1;t<=i;t++)for(let e=1;e<=n;e++){const i=(n+1)*(t-1)+(e-1),s=(n+1)*t+(e-1),r=(n+1)*t+e,o=(n+1)*(t-1)+e;a.push(i,s,o),a.push(s,r,o)}function v(t,e,i,n,s){const r=Math.cos(t),a=Math.sin(t),o=i/e*t,h=Math.cos(o);s.x=n*(2+h)*.5*r,s.y=n*(2+h)*a*.5,s.z=n*Math.sin(o)*.5}this.setIndex(a),this.setAttribute("position",new ln(o,3)),this.setAttribute("normal",new ln(h,3)),this.setAttribute("uv",new ln(l,2))}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}static fromJSON(t){return new kl(t.radius,t.tube,t.tubularSegments,t.radialSegments,t.p,t.q)}}class Pl extends vn{constructor(t=new kh(new Le(-1,-1,0),new Le(-1,1,0),new Le(1,1,0)),e=64,i=1,n=8,s=!1){super(),this.type="TubeGeometry",this.parameters={path:t,tubularSegments:e,radius:i,radialSegments:n,closed:s};const r=t.computeFrenetFrames(e,s);this.tangents=r.tangents,this.normals=r.normals,this.binormals=r.binormals;const a=new Le,o=new Le,h=new se;let l=new Le;const c=[],u=[],d=[],p=[];function m(s){l=t.getPointAt(s/e,l);const h=r.normals[s],d=r.binormals[s];for(let t=0;t<=n;t++){const e=t/n*Math.PI*2,s=Math.sin(e),r=-Math.cos(e);o.x=r*h.x+s*d.x,o.y=r*h.y+s*d.y,o.z=r*h.z+s*d.z,o.normalize(),u.push(o.x,o.y,o.z),a.x=l.x+i*o.x,a.y=l.y+i*o.y,a.z=l.z+i*o.z,c.push(a.x,a.y,a.z)}}!function(){for(let t=0;t<e;t++)m(t);m(!1===s?e:0),function(){for(let t=0;t<=e;t++)for(let i=0;i<=n;i++)h.x=t/e,h.y=i/n,d.push(h.x,h.y)}(),function(){for(let t=1;t<=e;t++)for(let e=1;e<=n;e++){const i=(n+1)*(t-1)+(e-1),s=(n+1)*t+(e-1),r=(n+1)*t+e,a=(n+1)*(t-1)+e;p.push(i,s,a),p.push(s,r,a)}}()}(),this.setIndex(p),this.setAttribute("position",new ln(c,3)),this.setAttribute("normal",new ln(u,3)),this.setAttribute("uv",new ln(d,2))}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}toJSON(){const t=super.toJSON();return t.path=this.parameters.path.toJSON(),t}static fromJSON(t){return new Pl((new Dh[t.path.type]).fromJSON(t.path),t.tubularSegments,t.radius,t.radialSegments,t.closed)}}function Dl(t,e,i){const n=`${t.x},${t.y},${t.z}-${e.x},${e.y},${e.z}`,s=`${e.x},${e.y},${e.z}-${t.x},${t.y},${t.z}`;return!0!==i.has(n)&&!0!==i.has(s)&&(i.add(n),i.add(s),!0)}var Ll=Object.freeze({__proto__:null,BoxGeometry:Bn,CapsuleGeometry:Bh,CircleGeometry:zh,ConeGeometry:Fh,CylinderGeometry:Uh,DodecahedronGeometry:Vh,EdgesGeometry:class extends vn{constructor(t=null,e=1){if(super(),this.type="EdgesGeometry",this.parameters={geometry:t,thresholdAngle:e},null!==t){const i=4,n=Math.pow(10,i),s=Math.cos(qt*e),r=t.getIndex(),a=t.getAttribute("position"),o=r?r.count:a.count,h=[0,0,0],l=["a","b","c"],c=new Array(3),u={},d=[];for(let t=0;t<o;t+=3){r?(h[0]=r.getX(t),h[1]=r.getX(t+1),h[2]=r.getX(t+2)):(h[0]=t,h[1]=t+1,h[2]=t+2);const{a:e,b:i,c:o}=Xh;if(e.fromBufferAttribute(a,h[0]),i.fromBufferAttribute(a,h[1]),o.fromBufferAttribute(a,h[2]),Xh.getNormal(Wh),c[0]=`${Math.round(e.x*n)},${Math.round(e.y*n)},${Math.round(e.z*n)}`,c[1]=`${Math.round(i.x*n)},${Math.round(i.y*n)},${Math.round(i.z*n)}`,c[2]=`${Math.round(o.x*n)},${Math.round(o.y*n)},${Math.round(o.z*n)}`,c[0]!==c[1]&&c[1]!==c[2]&&c[2]!==c[0])for(let t=0;t<3;t++){const e=(t+1)%3,i=c[t],n=c[e],r=Xh[l[t]],a=Xh[l[e]],o=`${i}_${n}`,p=`${n}_${i}`;p in u&&u[p]?(Wh.dot(u[p].normal)<=s&&(d.push(r.x,r.y,r.z),d.push(a.x,a.y,a.z)),u[p]=null):o in u||(u[o]={index0:h[t],index1:h[e],normal:Wh.clone()})}}for(const t in u)if(u[t]){const{index0:e,index1:i}=u[t];Hh.fromBufferAttribute(a,e),jh.fromBufferAttribute(a,i),d.push(Hh.x,Hh.y,Hh.z),d.push(jh.x,jh.y,jh.z)}this.setAttribute("position",new ln(d,3))}}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}},ExtrudeGeometry:wl,IcosahedronGeometry:Sl,LatheGeometry:Nh,OctahedronGeometry:El,PlaneGeometry:ss,PolyhedronGeometry:Gh,RingGeometry:Tl,ShapeGeometry:Al,SphereGeometry:Cl,TetrahedronGeometry:Il,TorusGeometry:Rl,TorusKnotGeometry:kl,TubeGeometry:Pl,WireframeGeometry:class extends vn{constructor(t=null){if(super(),this.type="WireframeGeometry",this.parameters={geometry:t},null!==t){const e=[],i=new Set,n=new Le,s=new Le;if(null!==t.index){const r=t.attributes.position,a=t.index;let o=t.groups;0===o.length&&(o=[{start:0,count:a.count,materialIndex:0}]);for(let t=0,h=o.length;t<h;++t){const h=o[t],l=h.start;for(let t=l,o=l+h.count;t<o;t+=3)for(let o=0;o<3;o++){const h=a.getX(t+o),l=a.getX(t+(o+1)%3);n.fromBufferAttribute(r,h),s.fromBufferAttribute(r,l),!0===Dl(n,s,i)&&(e.push(n.x,n.y,n.z),e.push(s.x,s.y,s.z))}}}else{const r=t.attributes.position;for(let t=0,a=r.count/3;t<a;t++)for(let a=0;a<3;a++){const o=3*t+a,h=3*t+(a+1)%3;n.fromBufferAttribute(r,o),s.fromBufferAttribute(r,h),!0===Dl(n,s,i)&&(e.push(n.x,n.y,n.z),e.push(s.x,s.y,s.z))}}this.setAttribute("position",new ln(e,3))}}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}}});class Ol extends en{constructor(t){super(),this.isShadowMaterial=!0,this.type="ShadowMaterial",this.color=new Zi(0),this.transparent=!0,this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.color.copy(t.color),this.fog=t.fog,this}}class Nl extends Vn{constructor(t){super(t),this.isRawShaderMaterial=!0,this.type="RawShaderMaterial"}}class Bl extends en{constructor(t){super(),this.isMeshStandardMaterial=!0,this.defines={STANDARD:""},this.type="MeshStandardMaterial",this.color=new Zi(16777215),this.roughness=1,this.metalness=0,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Zi(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new se(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.roughnessMap=null,this.metalnessMap=null,this.alphaMap=null,this.envMap=null,this.envMapIntensity=1,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.defines={STANDARD:""},this.color.copy(t.color),this.roughness=t.roughness,this.metalness=t.metalness,this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.emissive.copy(t.emissive),this.emissiveMap=t.emissiveMap,this.emissiveIntensity=t.emissiveIntensity,this.bumpMap=t.bumpMap,this.bumpScale=t.bumpScale,this.normalMap=t.normalMap,this.normalMapType=t.normalMapType,this.normalScale.copy(t.normalScale),this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.roughnessMap=t.roughnessMap,this.metalnessMap=t.metalnessMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.envMapIntensity=t.envMapIntensity,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.flatShading=t.flatShading,this.fog=t.fog,this}}class zl extends Bl{constructor(t){super(),this.isMeshPhysicalMaterial=!0,this.defines={STANDARD:"",PHYSICAL:""},this.type="MeshPhysicalMaterial",this.anisotropyRotation=0,this.anisotropyMap=null,this.clearcoatMap=null,this.clearcoatRoughness=0,this.clearcoatRoughnessMap=null,this.clearcoatNormalScale=new se(1,1),this.clearcoatNormalMap=null,this.ior=1.5,Object.defineProperty(this,"reflectivity",{get:function(){return $t(2.5*(this.ior-1)/(this.ior+1),0,1)},set:function(t){this.ior=(1+.4*t)/(1-.4*t)}}),this.iridescenceMap=null,this.iridescenceIOR=1.3,this.iridescenceThicknessRange=[100,400],this.iridescenceThicknessMap=null,this.sheenColor=new Zi(0),this.sheenColorMap=null,this.sheenRoughness=1,this.sheenRoughnessMap=null,this.transmissionMap=null,this.thickness=0,this.thicknessMap=null,this.attenuationDistance=1/0,this.attenuationColor=new Zi(1,1,1),this.specularIntensity=1,this.specularIntensityMap=null,this.specularColor=new Zi(1,1,1),this.specularColorMap=null,this._anisotropy=0,this._clearcoat=0,this._iridescence=0,this._sheen=0,this._transmission=0,this.setValues(t)}get anisotropy(){return this._anisotropy}set anisotropy(t){this._anisotropy>0!=t>0&&this.version++,this._anisotropy=t}get clearcoat(){return this._clearcoat}set clearcoat(t){this._clearcoat>0!=t>0&&this.version++,this._clearcoat=t}get iridescence(){return this._iridescence}set iridescence(t){this._iridescence>0!=t>0&&this.version++,this._iridescence=t}get sheen(){return this._sheen}set sheen(t){this._sheen>0!=t>0&&this.version++,this._sheen=t}get transmission(){return this._transmission}set transmission(t){this._transmission>0!=t>0&&this.version++,this._transmission=t}copy(t){return super.copy(t),this.defines={STANDARD:"",PHYSICAL:""},this.anisotropy=t.anisotropy,this.anisotropyRotation=t.anisotropyRotation,this.anisotropyMap=t.anisotropyMap,this.clearcoat=t.clearcoat,this.clearcoatMap=t.clearcoatMap,this.clearcoatRoughness=t.clearcoatRoughness,this.clearcoatRoughnessMap=t.clearcoatRoughnessMap,this.clearcoatNormalMap=t.clearcoatNormalMap,this.clearcoatNormalScale.copy(t.clearcoatNormalScale),this.ior=t.ior,this.iridescence=t.iridescence,this.iridescenceMap=t.iridescenceMap,this.iridescenceIOR=t.iridescenceIOR,this.iridescenceThicknessRange=[...t.iridescenceThicknessRange],this.iridescenceThicknessMap=t.iridescenceThicknessMap,this.sheen=t.sheen,this.sheenColor.copy(t.sheenColor),this.sheenColorMap=t.sheenColorMap,this.sheenRoughness=t.sheenRoughness,this.sheenRoughnessMap=t.sheenRoughnessMap,this.transmission=t.transmission,this.transmissionMap=t.transmissionMap,this.thickness=t.thickness,this.thicknessMap=t.thicknessMap,this.attenuationDistance=t.attenuationDistance,this.attenuationColor.copy(t.attenuationColor),this.specularIntensity=t.specularIntensity,this.specularIntensityMap=t.specularIntensityMap,this.specularColor.copy(t.specularColor),this.specularColorMap=t.specularColorMap,this}}class Ul extends en{constructor(t){super(),this.isMeshPhongMaterial=!0,this.type="MeshPhongMaterial",this.color=new Zi(16777215),this.specular=new Zi(1118481),this.shininess=30,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Zi(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new se(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=P,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.color.copy(t.color),this.specular.copy(t.specular),this.shininess=t.shininess,this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.emissive.copy(t.emissive),this.emissiveMap=t.emissiveMap,this.emissiveIntensity=t.emissiveIntensity,this.bumpMap=t.bumpMap,this.bumpScale=t.bumpScale,this.normalMap=t.normalMap,this.normalMapType=t.normalMapType,this.normalScale.copy(t.normalScale),this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.specularMap=t.specularMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.combine=t.combine,this.reflectivity=t.reflectivity,this.refractionRatio=t.refractionRatio,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.flatShading=t.flatShading,this.fog=t.fog,this}}class Fl extends en{constructor(t){super(),this.isMeshToonMaterial=!0,this.defines={TOON:""},this.type="MeshToonMaterial",this.color=new Zi(16777215),this.map=null,this.gradientMap=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Zi(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new se(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.alphaMap=null,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.color.copy(t.color),this.map=t.map,this.gradientMap=t.gradientMap,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.emissive.copy(t.emissive),this.emissiveMap=t.emissiveMap,this.emissiveIntensity=t.emissiveIntensity,this.bumpMap=t.bumpMap,this.bumpScale=t.bumpScale,this.normalMap=t.normalMap,this.normalMapType=t.normalMapType,this.normalScale.copy(t.normalScale),this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.alphaMap=t.alphaMap,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.fog=t.fog,this}}class Gl extends en{constructor(t){super(),this.isMeshNormalMaterial=!0,this.type="MeshNormalMaterial",this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new se(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.flatShading=!1,this.setValues(t)}copy(t){return super.copy(t),this.bumpMap=t.bumpMap,this.bumpScale=t.bumpScale,this.normalMap=t.normalMap,this.normalMapType=t.normalMapType,this.normalScale.copy(t.normalScale),this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.flatShading=t.flatShading,this}}class Vl extends en{constructor(t){super(),this.isMeshLambertMaterial=!0,this.type="MeshLambertMaterial",this.color=new Zi(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Zi(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new se(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=P,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.color.copy(t.color),this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.emissive.copy(t.emissive),this.emissiveMap=t.emissiveMap,this.emissiveIntensity=t.emissiveIntensity,this.bumpMap=t.bumpMap,this.bumpScale=t.bumpScale,this.normalMap=t.normalMap,this.normalMapType=t.normalMapType,this.normalScale.copy(t.normalScale),this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.specularMap=t.specularMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.combine=t.combine,this.reflectivity=t.reflectivity,this.refractionRatio=t.refractionRatio,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.flatShading=t.flatShading,this.fog=t.fog,this}}class Hl extends en{constructor(t){super(),this.isMeshMatcapMaterial=!0,this.defines={MATCAP:""},this.type="MeshMatcapMaterial",this.color=new Zi(16777215),this.matcap=null,this.map=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new se(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.alphaMap=null,this.flatShading=!1,this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.defines={MATCAP:""},this.color.copy(t.color),this.matcap=t.matcap,this.map=t.map,this.bumpMap=t.bumpMap,this.bumpScale=t.bumpScale,this.normalMap=t.normalMap,this.normalMapType=t.normalMapType,this.normalScale.copy(t.normalScale),this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.alphaMap=t.alphaMap,this.flatShading=t.flatShading,this.fog=t.fog,this}}class jl extends Qo{constructor(t){super(),this.isLineDashedMaterial=!0,this.type="LineDashedMaterial",this.scale=1,this.dashSize=3,this.gapSize=1,this.setValues(t)}copy(t){return super.copy(t),this.scale=t.scale,this.dashSize=t.dashSize,this.gapSize=t.gapSize,this}}function Wl(t,e,i){return!t||!i&&t.constructor===e?t:"number"==typeof e.BYTES_PER_ELEMENT?new e(t):Array.prototype.slice.call(t)}function Xl(t){return ArrayBuffer.isView(t)&&!(t instanceof DataView)}function ql(t){const e=t.length,i=new Array(e);for(let t=0;t!==e;++t)i[t]=t;return i.sort((function(e,i){return t[e]-t[i]})),i}function Yl(t,e,i){const n=t.length,s=new t.constructor(n);for(let r=0,a=0;a!==n;++r){const n=i[r]*e;for(let i=0;i!==e;++i)s[a++]=t[n+i]}return s}function Jl(t,e,i,n){let s=1,r=t[0];for(;void 0!==r&&void 0===r[n];)r=t[s++];if(void 0===r)return;let a=r[n];if(void 0!==a)if(Array.isArray(a))do{a=r[n],void 0!==a&&(e.push(r.time),i.push.apply(i,a)),r=t[s++]}while(void 0!==r);else if(void 0!==a.toArray)do{a=r[n],void 0!==a&&(e.push(r.time),a.toArray(i,i.length)),r=t[s++]}while(void 0!==r);else do{a=r[n],void 0!==a&&(e.push(r.time),i.push(a)),r=t[s++]}while(void 0!==r)}class $l{constructor(t,e,i,n){this.parameterPositions=t,this._cachedIndex=0,this.resultBuffer=void 0!==n?n:new e.constructor(i),this.sampleValues=e,this.valueSize=i,this.settings=null,this.DefaultSettings_={}}evaluate(t){const e=this.parameterPositions;let i=this._cachedIndex,n=e[i],s=e[i-1];t:{e:{let r;i:{n:if(!(t<n)){for(let r=i+2;;){if(void 0===n){if(t<s)break n;return i=e.length,this._cachedIndex=i,this.copySampleValue_(i-1)}if(i===r)break;if(s=n,n=e[++i],t<n)break e}r=e.length;break i}if(t>=s)break t;{const a=e[1];t<a&&(i=2,s=a);for(let r=i-2;;){if(void 0===s)return this._cachedIndex=0,this.copySampleValue_(0);if(i===r)break;if(n=s,s=e[--i-1],t>=s)break e}r=i,i=0}}for(;i<r;){const n=i+r>>>1;t<e[n]?r=n:i=n+1}if(n=e[i],s=e[i-1],void 0===s)return this._cachedIndex=0,this.copySampleValue_(0);if(void 0===n)return i=e.length,this._cachedIndex=i,this.copySampleValue_(i-1)}this._cachedIndex=i,this.intervalChanged_(i,s,n)}return this.interpolate_(i,s,t,n)}getSettings_(){return this.settings||this.DefaultSettings_}copySampleValue_(t){const e=this.resultBuffer,i=this.sampleValues,n=this.valueSize,s=t*n;for(let t=0;t!==n;++t)e[t]=i[s+t];return e}interpolate_(){throw new Error("call to abstract method")}intervalChanged_(){}}class Kl extends $l{constructor(t,e,i,n){super(t,e,i,n),this._weightPrev=-0,this._offsetPrev=-0,this._weightNext=-0,this._offsetNext=-0,this.DefaultSettings_={endingStart:Mt,endingEnd:Mt}}intervalChanged_(t,e,i){const n=this.parameterPositions;let s=t-2,r=t+1,a=n[s],o=n[r];if(void 0===a)switch(this.getSettings_().endingStart){case St:s=t,a=2*e-i;break;case Et:s=n.length-2,a=e+n[s]-n[s+1];break;default:s=t,a=i}if(void 0===o)switch(this.getSettings_().endingEnd){case St:r=t,o=2*i-e;break;case Et:r=1,o=i+n[1]-n[0];break;default:r=t-1,o=e}const h=.5*(i-e),l=this.valueSize;this._weightPrev=h/(e-a),this._weightNext=h/(o-i),this._offsetPrev=s*l,this._offsetNext=r*l}interpolate_(t,e,i,n){const s=this.resultBuffer,r=this.sampleValues,a=this.valueSize,o=t*a,h=o-a,l=this._offsetPrev,c=this._offsetNext,u=this._weightPrev,d=this._weightNext,p=(i-e)/(n-e),m=p*p,f=m*p,g=-u*f+2*u*m-u*p,v=(1+u)*f+(-1.5-2*u)*m+(-.5+u)*p+1,y=(-1-d)*f+(1.5+d)*m+.5*p,x=d*f-d*m;for(let t=0;t!==a;++t)s[t]=g*r[l+t]+v*r[h+t]+y*r[o+t]+x*r[c+t];return s}}class Zl extends $l{constructor(t,e,i,n){super(t,e,i,n)}interpolate_(t,e,i,n){const s=this.resultBuffer,r=this.sampleValues,a=this.valueSize,o=t*a,h=o-a,l=(i-e)/(n-e),c=1-l;for(let t=0;t!==a;++t)s[t]=r[h+t]*c+r[o+t]*l;return s}}class Ql extends $l{constructor(t,e,i,n){super(t,e,i,n)}interpolate_(t){return this.copySampleValue_(t-1)}}class tc{constructor(t,e,i,n){if(void 0===t)throw new Error("THREE.KeyframeTrack: track name is undefined");if(void 0===e||0===e.length)throw new Error("THREE.KeyframeTrack: no keyframes in track named "+t);this.name=t,this.times=Wl(e,this.TimeBufferType),this.values=Wl(i,this.ValueBufferType),this.setInterpolation(n||this.DefaultInterpolation)}static toJSON(t){const e=t.constructor;let i;if(e.toJSON!==this.toJSON)i=e.toJSON(t);else{i={name:t.name,times:Wl(t.times,Array),values:Wl(t.values,Array)};const e=t.getInterpolation();e!==t.DefaultInterpolation&&(i.interpolation=e)}return i.type=t.ValueTypeName,i}InterpolantFactoryMethodDiscrete(t){return new Ql(this.times,this.values,this.getValueSize(),t)}InterpolantFactoryMethodLinear(t){return new Zl(this.times,this.values,this.getValueSize(),t)}InterpolantFactoryMethodSmooth(t){return new Kl(this.times,this.values,this.getValueSize(),t)}setInterpolation(t){let e;switch(t){case bt:e=this.InterpolantFactoryMethodDiscrete;break;case _t:e=this.InterpolantFactoryMethodLinear;break;case wt:e=this.InterpolantFactoryMethodSmooth}if(void 0===e){const e="unsupported interpolation for "+this.ValueTypeName+" keyframe track named "+this.name;if(void 0===this.createInterpolant){if(t===this.DefaultInterpolation)throw new Error(e);this.setInterpolation(this.DefaultInterpolation)}return this}return this.createInterpolant=e,this}getInterpolation(){switch(this.createInterpolant){case this.InterpolantFactoryMethodDiscrete:return bt;case this.InterpolantFactoryMethodLinear:return _t;case this.InterpolantFactoryMethodSmooth:return wt}}getValueSize(){return this.values.length/this.times.length}shift(t){if(0!==t){const e=this.times;for(let i=0,n=e.length;i!==n;++i)e[i]+=t}return this}scale(t){if(1!==t){const e=this.times;for(let i=0,n=e.length;i!==n;++i)e[i]*=t}return this}trim(t,e){const i=this.times,n=i.length;let s=0,r=n-1;for(;s!==n&&i[s]<t;)++s;for(;-1!==r&&i[r]>e;)--r;if(++r,0!==s||r!==n){s>=r&&(r=Math.max(r,1),s=r-1);const t=this.getValueSize();this.times=i.slice(s,r),this.values=this.values.slice(s*t,r*t)}return this}validate(){let t=!0;const e=this.getValueSize();e-Math.floor(e)!=0&&(t=!1);const i=this.times,n=this.values,s=i.length;0===s&&(t=!1);let r=null;for(let e=0;e!==s;e++){const n=i[e];if("number"==typeof n&&isNaN(n)){t=!1;break}if(null!==r&&r>n){t=!1;break}r=n}if(void 0!==n&&Xl(n))for(let e=0,i=n.length;e!==i;++e){const i=n[e];if(isNaN(i)){t=!1;break}}return t}optimize(){const t=this.times.slice(),e=this.values.slice(),i=this.getValueSize(),n=this.getInterpolation()===wt,s=t.length-1;let r=1;for(let a=1;a<s;++a){let s=!1;const o=t[a];if(o!==t[a+1]&&(1!==a||o!==t[0]))if(n)s=!0;else{const t=a*i,n=t-i,r=t+i;for(let a=0;a!==i;++a){const i=e[t+a];if(i!==e[n+a]||i!==e[r+a]){s=!0;break}}}if(s){if(a!==r){t[r]=t[a];const n=a*i,s=r*i;for(let t=0;t!==i;++t)e[s+t]=e[n+t]}++r}}if(s>0){t[r]=t[s];for(let t=s*i,n=r*i,a=0;a!==i;++a)e[n+a]=e[t+a];++r}return r!==t.length?(this.times=t.slice(0,r),this.values=e.slice(0,r*i)):(this.times=t,this.values=e),this}clone(){const t=this.times.slice(),e=this.values.slice(),i=new(0,this.constructor)(this.name,t,e);return i.createInterpolant=this.createInterpolant,i}}tc.prototype.TimeBufferType=Float32Array,tc.prototype.ValueBufferType=Float32Array,tc.prototype.DefaultInterpolation=_t;class ec extends tc{}ec.prototype.ValueTypeName="bool",ec.prototype.ValueBufferType=Array,ec.prototype.DefaultInterpolation=bt,ec.prototype.InterpolantFactoryMethodLinear=void 0,ec.prototype.InterpolantFactoryMethodSmooth=void 0;class ic extends tc{}ic.prototype.ValueTypeName="color";class nc extends tc{}nc.prototype.ValueTypeName="number";class sc extends $l{constructor(t,e,i,n){super(t,e,i,n)}interpolate_(t,e,i,n){const s=this.resultBuffer,r=this.sampleValues,a=this.valueSize,o=(i-e)/(n-e);let h=t*a;for(let t=h+a;h!==t;h+=4)De.slerpFlat(s,0,r,h-a,r,h,o);return s}}class rc extends tc{InterpolantFactoryMethodLinear(t){return new sc(this.times,this.values,this.getValueSize(),t)}}rc.prototype.ValueTypeName="quaternion",rc.prototype.DefaultInterpolation=_t,rc.prototype.InterpolantFactoryMethodSmooth=void 0;class ac extends tc{}ac.prototype.ValueTypeName="string",ac.prototype.ValueBufferType=Array,ac.prototype.DefaultInterpolation=bt,ac.prototype.InterpolantFactoryMethodLinear=void 0,ac.prototype.InterpolantFactoryMethodSmooth=void 0;class oc extends tc{}oc.prototype.ValueTypeName="vector";class hc{constructor(t,e=-1,i,n=2500){this.name=t,this.tracks=i,this.duration=e,this.blendMode=n,this.uuid=Jt(),this.duration<0&&this.resetDuration()}static parse(t){const e=[],i=t.tracks,n=1/(t.fps||1);for(let t=0,s=i.length;t!==s;++t)e.push(lc(i[t]).scale(n));const s=new this(t.name,t.duration,e,t.blendMode);return s.uuid=t.uuid,s}static toJSON(t){const e=[],i=t.tracks,n={name:t.name,duration:t.duration,tracks:e,uuid:t.uuid,blendMode:t.blendMode};for(let t=0,n=i.length;t!==n;++t)e.push(tc.toJSON(i[t]));return n}static CreateFromMorphTargetSequence(t,e,i,n){const s=e.length,r=[];for(let t=0;t<s;t++){let a=[],o=[];a.push((t+s-1)%s,t,(t+1)%s),o.push(0,1,0);const h=ql(a);a=Yl(a,1,h),o=Yl(o,1,h),n||0!==a[0]||(a.push(s),o.push(o[0])),r.push(new nc(".morphTargetInfluences["+e[t].name+"]",a,o).scale(1/i))}return new this(t,-1,r)}static findByName(t,e){let i=t;if(!Array.isArray(t)){const e=t;i=e.geometry&&e.geometry.animations||e.animations}for(let t=0;t<i.length;t++)if(i[t].name===e)return i[t];return null}static CreateClipsFromMorphTargetSequences(t,e,i){const n={},s=/^([\w-]*?)([\d]+)$/;for(let e=0,i=t.length;e<i;e++){const i=t[e],r=i.name.match(s);if(r&&r.length>1){const t=r[1];let e=n[t];e||(n[t]=e=[]),e.push(i)}}const r=[];for(const t in n)r.push(this.CreateFromMorphTargetSequence(t,n[t],e,i));return r}static parseAnimation(t,e){if(!t)return null;const i=function(t,e,i,n,s){if(0!==i.length){const r=[],a=[];Jl(i,r,a,n),0!==r.length&&s.push(new t(e,r,a))}},n=[],s=t.name||"default",r=t.fps||30,a=t.blendMode;let o=t.length||-1;const h=t.hierarchy||[];for(let t=0;t<h.length;t++){const s=h[t].keys;if(s&&0!==s.length)if(s[0].morphTargets){const t={};let e;for(e=0;e<s.length;e++)if(s[e].morphTargets)for(let i=0;i<s[e].morphTargets.length;i++)t[s[e].morphTargets[i]]=-1;for(const i in t){const t=[],r=[];for(let n=0;n!==s[e].morphTargets.length;++n){const n=s[e];t.push(n.time),r.push(n.morphTarget===i?1:0)}n.push(new nc(".morphTargetInfluence["+i+"]",t,r))}o=t.length*r}else{const r=".bones["+e[t].name+"]";i(oc,r+".position",s,"pos",n),i(rc,r+".quaternion",s,"rot",n),i(oc,r+".scale",s,"scl",n)}}if(0===n.length)return null;return new this(s,o,n,a)}resetDuration(){let t=0;for(let e=0,i=this.tracks.length;e!==i;++e){const i=this.tracks[e];t=Math.max(t,i.times[i.times.length-1])}return this.duration=t,this}trim(){for(let t=0;t<this.tracks.length;t++)this.tracks[t].trim(0,this.duration);return this}validate(){let t=!0;for(let e=0;e<this.tracks.length;e++)t=t&&this.tracks[e].validate();return t}optimize(){for(let t=0;t<this.tracks.length;t++)this.tracks[t].optimize();return this}clone(){const t=[];for(let e=0;e<this.tracks.length;e++)t.push(this.tracks[e].clone());return new this.constructor(this.name,this.duration,t,this.blendMode)}toJSON(){return this.constructor.toJSON(this)}}function lc(t){if(void 0===t.type)throw new Error("THREE.KeyframeTrack: track type undefined, can not parse");const e=function(t){switch(t.toLowerCase()){case"scalar":case"double":case"float":case"number":case"integer":return nc;case"vector":case"vector2":case"vector3":case"vector4":return oc;case"color":return ic;case"quaternion":return rc;case"bool":case"boolean":return ec;case"string":return ac}throw new Error("THREE.KeyframeTrack: Unsupported typeName: "+t)}(t.type);if(void 0===t.times){const e=[],i=[];Jl(t.keys,e,i,"value"),t.times=e,t.values=i}return void 0!==e.parse?e.parse(t):new e(t.name,t.times,t.values,t.interpolation)}const cc={enabled:!1,files:{},add:function(t,e){!1!==this.enabled&&(this.files[t]=e)},get:function(t){if(!1!==this.enabled)return this.files[t]},remove:function(t){delete this.files[t]},clear:function(){this.files={}}};class uc{constructor(t,e,i){const n=this;let s,r=!1,a=0,o=0;const h=[];this.onStart=void 0,this.onLoad=t,this.onProgress=e,this.onError=i,this.itemStart=function(t){o++,!1===r&&void 0!==n.onStart&&n.onStart(t,a,o),r=!0},this.itemEnd=function(t){a++,void 0!==n.onProgress&&n.onProgress(t,a,o),a===o&&(r=!1,void 0!==n.onLoad&&n.onLoad())},this.itemError=function(t){void 0!==n.onError&&n.onError(t)},this.resolveURL=function(t){return s?s(t):t},this.setURLModifier=function(t){return s=t,this},this.addHandler=function(t,e){return h.push(t,e),this},this.removeHandler=function(t){const e=h.indexOf(t);return-1!==e&&h.splice(e,2),this},this.getHandler=function(t){for(let e=0,i=h.length;e<i;e+=2){const i=h[e],n=h[e+1];if(i.global&&(i.lastIndex=0),i.test(t))return n}return null}}}const dc=new uc;class pc{constructor(t){this.manager=void 0!==t?t:dc,this.crossOrigin="anonymous",this.withCredentials=!1,this.path="",this.resourcePath="",this.requestHeader={}}load(){}loadAsync(t,e){const i=this;return new Promise((function(n,s){i.load(t,n,e,s)}))}parse(){}setCrossOrigin(t){return this.crossOrigin=t,this}setWithCredentials(t){return this.withCredentials=t,this}setPath(t){return this.path=t,this}setResourcePath(t){return this.resourcePath=t,this}setRequestHeader(t){return this.requestHeader=t,this}}pc.DEFAULT_MATERIAL_NAME="__DEFAULT";const mc={};class fc extends Error{constructor(t,e){super(t),this.response=e}}class gc extends pc{constructor(t){super(t)}load(t,e,i,n){void 0===t&&(t=""),void 0!==this.path&&(t=this.path+t),t=this.manager.resolveURL(t);const s=cc.get(t);if(void 0!==s)return this.manager.itemStart(t),setTimeout((()=>{e&&e(s),this.manager.itemEnd(t)}),0),s;if(void 0!==mc[t])return void mc[t].push({onLoad:e,onProgress:i,onError:n});mc[t]=[],mc[t].push({onLoad:e,onProgress:i,onError:n});const r=new Request(t,{headers:new Headers(this.requestHeader),credentials:this.withCredentials?"include":"same-origin"}),a=this.mimeType,o=this.responseType;fetch(r).then((e=>{if(200===e.status||0===e.status){if(e.status,"undefined"==typeof ReadableStream||void 0===e.body||void 0===e.body.getReader)return e;const i=mc[t],n=e.body.getReader(),s=e.headers.get("Content-Length")||e.headers.get("X-File-Size"),r=s?parseInt(s):0,a=0!==r;let o=0;const h=new ReadableStream({start(t){!function e(){n.read().then((({done:n,value:s})=>{if(n)t.close();else{o+=s.byteLength;const n=new ProgressEvent("progress",{lengthComputable:a,loaded:o,total:r});for(let t=0,e=i.length;t<e;t++){const e=i[t];e.onProgress&&e.onProgress(n)}t.enqueue(s),e()}}))}()}});return new Response(h)}throw new fc(`fetch for "${e.url}" responded with ${e.status}: ${e.statusText}`,e)})).then((t=>{switch(o){case"arraybuffer":return t.arrayBuffer();case"blob":return t.blob();case"document":return t.text().then((t=>(new DOMParser).parseFromString(t,a)));case"json":return t.json();default:if(void 0===a)return t.text();{const e=/charset="?([^;"\s]*)"?/i.exec(a),i=e&&e[1]?e[1].toLowerCase():void 0,n=new TextDecoder(i);return t.arrayBuffer().then((t=>n.decode(t)))}}})).then((e=>{cc.add(t,e);const i=mc[t];delete mc[t];for(let t=0,n=i.length;t<n;t++){const n=i[t];n.onLoad&&n.onLoad(e)}})).catch((e=>{const i=mc[t];if(void 0===i)throw this.manager.itemError(t),e;delete mc[t];for(let t=0,n=i.length;t<n;t++){const n=i[t];n.onError&&n.onError(e)}this.manager.itemError(t)})).finally((()=>{this.manager.itemEnd(t)})),this.manager.itemStart(t)}setResponseType(t){return this.responseType=t,this}setMimeType(t){return this.mimeType=t,this}}class vc extends pc{constructor(t){super(t)}load(t,e,i,n){void 0!==this.path&&(t=this.path+t),t=this.manager.resolveURL(t);const s=this,r=cc.get(t);if(void 0!==r)return s.manager.itemStart(t),setTimeout((function(){e&&e(r),s.manager.itemEnd(t)}),0),r;const a=ce("img");function o(){l(),cc.add(t,this),e&&e(this),s.manager.itemEnd(t)}function h(e){l(),n&&n(e),s.manager.itemError(t),s.manager.itemEnd(t)}function l(){a.removeEventListener("load",o,!1),a.removeEventListener("error",h,!1)}return a.addEventListener("load",o,!1),a.addEventListener("error",h,!1),"data:"!==t.slice(0,5)&&void 0!==this.crossOrigin&&(a.crossOrigin=this.crossOrigin),s.manager.itemStart(t),a.src=t,a}}class yc extends pc{constructor(t){super(t)}load(t,e,i,n){const s=new Ae,r=new vc(this.manager);return r.setCrossOrigin(this.crossOrigin),r.setPath(this.path),r.load(t,(function(t){s.image=t,s.needsUpdate=!0,void 0!==e&&e(s)}),i,n),s}}class xc extends Oi{constructor(t,e=1){super(),this.isLight=!0,this.type="Light",this.color=new Zi(t),this.intensity=e}dispose(){}copy(t,e){return super.copy(t,e),this.color.copy(t.color),this.intensity=t.intensity,this}toJSON(t){const e=super.toJSON(t);return e.object.color=this.color.getHex(),e.object.intensity=this.intensity,void 0!==this.groundColor&&(e.object.groundColor=this.groundColor.getHex()),void 0!==this.distance&&(e.object.distance=this.distance),void 0!==this.angle&&(e.object.angle=this.angle),void 0!==this.decay&&(e.object.decay=this.decay),void 0!==this.penumbra&&(e.object.penumbra=this.penumbra),void 0!==this.shadow&&(e.object.shadow=this.shadow.toJSON()),e}}class bc extends xc{constructor(t,e,i){super(t,i),this.isHemisphereLight=!0,this.type="HemisphereLight",this.position.copy(Oi.DEFAULT_UP),this.updateMatrix(),this.groundColor=new Zi(e)}copy(t,e){return super.copy(t,e),this.groundColor.copy(t.groundColor),this}}const _c=new ci,wc=new Le,Mc=new Le;class Sc{constructor(t){this.camera=t,this.bias=0,this.normalBias=0,this.radius=1,this.blurSamples=8,this.mapSize=new se(512,512),this.map=null,this.mapPass=null,this.matrix=new ci,this.autoUpdate=!0,this.needsUpdate=!1,this._frustum=new es,this._frameExtents=new se(1,1),this._viewportCount=1,this._viewports=[new Ce(0,0,1,1)]}getViewportCount(){return this._viewportCount}getFrustum(){return this._frustum}updateMatrices(t){const e=this.camera,i=this.matrix;wc.setFromMatrixPosition(t.matrixWorld),e.position.copy(wc),Mc.setFromMatrixPosition(t.target.matrixWorld),e.lookAt(Mc),e.updateMatrixWorld(),_c.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse),this._frustum.setFromProjectionMatrix(_c),i.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),i.multiply(_c)}getViewport(t){return this._viewports[t]}getFrameExtents(){return this._frameExtents}dispose(){this.map&&this.map.dispose(),this.mapPass&&this.mapPass.dispose()}copy(t){return this.camera=t.camera.clone(),this.bias=t.bias,this.radius=t.radius,this.mapSize.copy(t.mapSize),this}clone(){return(new this.constructor).copy(this)}toJSON(){const t={};return 0!==this.bias&&(t.bias=this.bias),0!==this.normalBias&&(t.normalBias=this.normalBias),1!==this.radius&&(t.radius=this.radius),512===this.mapSize.x&&512===this.mapSize.y||(t.mapSize=this.mapSize.toArray()),t.camera=this.camera.toJSON(!1).object,delete t.camera.matrix,t}}class Ec extends Sc{constructor(){super(new jn(50,1,.5,500)),this.isSpotLightShadow=!0,this.focus=1}updateMatrices(t){const e=this.camera,i=2*Yt*t.angle*this.focus,n=this.mapSize.width/this.mapSize.height,s=t.distance||e.far;i===e.fov&&n===e.aspect&&s===e.far||(e.fov=i,e.aspect=n,e.far=s,e.updateProjectionMatrix()),super.updateMatrices(t)}copy(t){return super.copy(t),this.focus=t.focus,this}}class Tc extends xc{constructor(t,e,i=0,n=Math.PI/3,s=0,r=2){super(t,e),this.isSpotLight=!0,this.type="SpotLight",this.position.copy(Oi.DEFAULT_UP),this.updateMatrix(),this.target=new Oi,this.distance=i,this.angle=n,this.penumbra=s,this.decay=r,this.map=null,this.shadow=new Ec}get power(){return this.intensity*Math.PI}set power(t){this.intensity=t/Math.PI}dispose(){this.shadow.dispose()}copy(t,e){return super.copy(t,e),this.distance=t.distance,this.angle=t.angle,this.penumbra=t.penumbra,this.decay=t.decay,this.target=t.target.clone(),this.shadow=t.shadow.clone(),this}}const Ac=new ci,Cc=new Le,Ic=new Le;class Rc extends Sc{constructor(){super(new jn(90,1,.5,500)),this.isPointLightShadow=!0,this._frameExtents=new se(4,2),this._viewportCount=6,this._viewports=[new Ce(2,1,1,1),new Ce(0,1,1,1),new Ce(3,1,1,1),new Ce(1,1,1,1),new Ce(3,0,1,1),new Ce(1,0,1,1)],this._cubeDirections=[new Le(1,0,0),new Le(-1,0,0),new Le(0,0,1),new Le(0,0,-1),new Le(0,1,0),new Le(0,-1,0)],this._cubeUps=[new Le(0,1,0),new Le(0,1,0),new Le(0,1,0),new Le(0,1,0),new Le(0,0,1),new Le(0,0,-1)]}updateMatrices(t,e=0){const i=this.camera,n=this.matrix,s=t.distance||i.far;s!==i.far&&(i.far=s,i.updateProjectionMatrix()),Cc.setFromMatrixPosition(t.matrixWorld),i.position.copy(Cc),Ic.copy(i.position),Ic.add(this._cubeDirections[e]),i.up.copy(this._cubeUps[e]),i.lookAt(Ic),i.updateMatrixWorld(),n.makeTranslation(-Cc.x,-Cc.y,-Cc.z),Ac.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse),this._frustum.setFromProjectionMatrix(Ac)}}class kc extends xc{constructor(t,e,i=0,n=2){super(t,e),this.isPointLight=!0,this.type="PointLight",this.distance=i,this.decay=n,this.shadow=new Rc}get power(){return 4*this.intensity*Math.PI}set power(t){this.intensity=t/(4*Math.PI)}dispose(){this.shadow.dispose()}copy(t,e){return super.copy(t,e),this.distance=t.distance,this.decay=t.decay,this.shadow=t.shadow.clone(),this}}class Pc extends Sc{constructor(){super(new fs(-5,5,5,-5,.5,500)),this.isDirectionalLightShadow=!0}}class Dc extends xc{constructor(t,e){super(t,e),this.isDirectionalLight=!0,this.type="DirectionalLight",this.position.copy(Oi.DEFAULT_UP),this.updateMatrix(),this.target=new Oi,this.shadow=new Pc}dispose(){this.shadow.dispose()}copy(t){return super.copy(t),this.target=t.target.clone(),this.shadow=t.shadow.clone(),this}}class Lc extends xc{constructor(t,e){super(t,e),this.isAmbientLight=!0,this.type="AmbientLight"}}class Oc extends xc{constructor(t,e,i=10,n=10){super(t,e),this.isRectAreaLight=!0,this.type="RectAreaLight",this.width=i,this.height=n}get power(){return this.intensity*this.width*this.height*Math.PI}set power(t){this.intensity=t/(this.width*this.height*Math.PI)}copy(t){return super.copy(t),this.width=t.width,this.height=t.height,this}toJSON(t){const e=super.toJSON(t);return e.object.width=this.width,e.object.height=this.height,e}}class Nc{constructor(){this.isSphericalHarmonics3=!0,this.coefficients=[];for(let t=0;t<9;t++)this.coefficients.push(new Le)}set(t){for(let e=0;e<9;e++)this.coefficients[e].copy(t[e]);return this}zero(){for(let t=0;t<9;t++)this.coefficients[t].set(0,0,0);return this}getAt(t,e){const i=t.x,n=t.y,s=t.z,r=this.coefficients;return e.copy(r[0]).multiplyScalar(.282095),e.addScaledVector(r[1],.488603*n),e.addScaledVector(r[2],.488603*s),e.addScaledVector(r[3],.488603*i),e.addScaledVector(r[4],i*n*1.092548),e.addScaledVector(r[5],n*s*1.092548),e.addScaledVector(r[6],.315392*(3*s*s-1)),e.addScaledVector(r[7],i*s*1.092548),e.addScaledVector(r[8],.546274*(i*i-n*n)),e}getIrradianceAt(t,e){const i=t.x,n=t.y,s=t.z,r=this.coefficients;return e.copy(r[0]).multiplyScalar(.886227),e.addScaledVector(r[1],1.023328*n),e.addScaledVector(r[2],1.023328*s),e.addScaledVector(r[3],1.023328*i),e.addScaledVector(r[4],.858086*i*n),e.addScaledVector(r[5],.858086*n*s),e.addScaledVector(r[6],.743125*s*s-.247708),e.addScaledVector(r[7],.858086*i*s),e.addScaledVector(r[8],.429043*(i*i-n*n)),e}add(t){for(let e=0;e<9;e++)this.coefficients[e].add(t.coefficients[e]);return this}addScaledSH(t,e){for(let i=0;i<9;i++)this.coefficients[i].addScaledVector(t.coefficients[i],e);return this}scale(t){for(let e=0;e<9;e++)this.coefficients[e].multiplyScalar(t);return this}lerp(t,e){for(let i=0;i<9;i++)this.coefficients[i].lerp(t.coefficients[i],e);return this}equals(t){for(let e=0;e<9;e++)if(!this.coefficients[e].equals(t.coefficients[e]))return!1;return!0}copy(t){return this.set(t.coefficients)}clone(){return(new this.constructor).copy(this)}fromArray(t,e=0){const i=this.coefficients;for(let n=0;n<9;n++)i[n].fromArray(t,e+3*n);return this}toArray(t=[],e=0){const i=this.coefficients;for(let n=0;n<9;n++)i[n].toArray(t,e+3*n);return t}static getBasisAt(t,e){const i=t.x,n=t.y,s=t.z;e[0]=.282095,e[1]=.488603*n,e[2]=.488603*s,e[3]=.488603*i,e[4]=1.092548*i*n,e[5]=1.092548*n*s,e[6]=.315392*(3*s*s-1),e[7]=1.092548*i*s,e[8]=.546274*(i*i-n*n)}}class Bc extends xc{constructor(t=new Nc,e=1){super(void 0,e),this.isLightProbe=!0,this.sh=t}copy(t){return super.copy(t),this.sh.copy(t.sh),this}fromJSON(t){return this.intensity=t.intensity,this.sh.fromArray(t.sh),this}toJSON(t){const e=super.toJSON(t);return e.object.sh=this.sh.toArray(),e}}class zc extends pc{constructor(t){super(t),this.textures={}}load(t,e,i,n){const s=this,r=new gc(s.manager);r.setPath(s.path),r.setRequestHeader(s.requestHeader),r.setWithCredentials(s.withCredentials),r.load(t,(function(i){try{e(s.parse(JSON.parse(i)))}catch(e){n&&n(e),s.manager.itemError(t)}}),i,n)}parse(t){const e=this.textures;function i(t){return e[t],e[t]}const n=zc.createMaterialFromType(t.type);if(void 0!==t.uuid&&(n.uuid=t.uuid),void 0!==t.name&&(n.name=t.name),void 0!==t.color&&void 0!==n.color&&n.color.setHex(t.color),void 0!==t.roughness&&(n.roughness=t.roughness),void 0!==t.metalness&&(n.metalness=t.metalness),void 0!==t.sheen&&(n.sheen=t.sheen),void 0!==t.sheenColor&&(n.sheenColor=(new Zi).setHex(t.sheenColor)),void 0!==t.sheenRoughness&&(n.sheenRoughness=t.sheenRoughness),void 0!==t.emissive&&void 0!==n.emissive&&n.emissive.setHex(t.emissive),void 0!==t.specular&&void 0!==n.specular&&n.specular.setHex(t.specular),void 0!==t.specularIntensity&&(n.specularIntensity=t.specularIntensity),void 0!==t.specularColor&&void 0!==n.specularColor&&n.specularColor.setHex(t.specularColor),void 0!==t.shininess&&(n.shininess=t.shininess),void 0!==t.clearcoat&&(n.clearcoat=t.clearcoat),void 0!==t.clearcoatRoughness&&(n.clearcoatRoughness=t.clearcoatRoughness),void 0!==t.iridescence&&(n.iridescence=t.iridescence),void 0!==t.iridescenceIOR&&(n.iridescenceIOR=t.iridescenceIOR),void 0!==t.iridescenceThicknessRange&&(n.iridescenceThicknessRange=t.iridescenceThicknessRange),void 0!==t.transmission&&(n.transmission=t.transmission),void 0!==t.thickness&&(n.thickness=t.thickness),void 0!==t.attenuationDistance&&(n.attenuationDistance=t.attenuationDistance),void 0!==t.attenuationColor&&void 0!==n.attenuationColor&&n.attenuationColor.setHex(t.attenuationColor),void 0!==t.anisotropy&&(n.anisotropy=t.anisotropy),void 0!==t.anisotropyRotation&&(n.anisotropyRotation=t.anisotropyRotation),void 0!==t.fog&&(n.fog=t.fog),void 0!==t.flatShading&&(n.flatShading=t.flatShading),void 0!==t.blending&&(n.blending=t.blending),void 0!==t.combine&&(n.combine=t.combine),void 0!==t.side&&(n.side=t.side),void 0!==t.shadowSide&&(n.shadowSide=t.shadowSide),void 0!==t.opacity&&(n.opacity=t.opacity),void 0!==t.transparent&&(n.transparent=t.transparent),void 0!==t.alphaTest&&(n.alphaTest=t.alphaTest),void 0!==t.alphaHash&&(n.alphaHash=t.alphaHash),void 0!==t.depthFunc&&(n.depthFunc=t.depthFunc),void 0!==t.depthTest&&(n.depthTest=t.depthTest),void 0!==t.depthWrite&&(n.depthWrite=t.depthWrite),void 0!==t.colorWrite&&(n.colorWrite=t.colorWrite),void 0!==t.blendSrc&&(n.blendSrc=t.blendSrc),void 0!==t.blendDst&&(n.blendDst=t.blendDst),void 0!==t.blendEquation&&(n.blendEquation=t.blendEquation),void 0!==t.blendSrcAlpha&&(n.blendSrcAlpha=t.blendSrcAlpha),void 0!==t.blendDstAlpha&&(n.blendDstAlpha=t.blendDstAlpha),void 0!==t.blendEquationAlpha&&(n.blendEquationAlpha=t.blendEquationAlpha),void 0!==t.blendColor&&void 0!==n.blendColor&&n.blendColor.setHex(t.blendColor),void 0!==t.blendAlpha&&(n.blendAlpha=t.blendAlpha),void 0!==t.stencilWriteMask&&(n.stencilWriteMask=t.stencilWriteMask),void 0!==t.stencilFunc&&(n.stencilFunc=t.stencilFunc),void 0!==t.stencilRef&&(n.stencilRef=t.stencilRef),void 0!==t.stencilFuncMask&&(n.stencilFuncMask=t.stencilFuncMask),void 0!==t.stencilFail&&(n.stencilFail=t.stencilFail),void 0!==t.stencilZFail&&(n.stencilZFail=t.stencilZFail),void 0!==t.stencilZPass&&(n.stencilZPass=t.stencilZPass),void 0!==t.stencilWrite&&(n.stencilWrite=t.stencilWrite),void 0!==t.wireframe&&(n.wireframe=t.wireframe),void 0!==t.wireframeLinewidth&&(n.wireframeLinewidth=t.wireframeLinewidth),void 0!==t.wireframeLinecap&&(n.wireframeLinecap=t.wireframeLinecap),void 0!==t.wireframeLinejoin&&(n.wireframeLinejoin=t.wireframeLinejoin),void 0!==t.rotation&&(n.rotation=t.rotation),void 0!==t.linewidth&&(n.linewidth=t.linewidth),void 0!==t.dashSize&&(n.dashSize=t.dashSize),void 0!==t.gapSize&&(n.gapSize=t.gapSize),void 0!==t.scale&&(n.scale=t.scale),void 0!==t.polygonOffset&&(n.polygonOffset=t.polygonOffset),void 0!==t.polygonOffsetFactor&&(n.polygonOffsetFactor=t.polygonOffsetFactor),void 0!==t.polygonOffsetUnits&&(n.polygonOffsetUnits=t.polygonOffsetUnits),void 0!==t.dithering&&(n.dithering=t.dithering),void 0!==t.alphaToCoverage&&(n.alphaToCoverage=t.alphaToCoverage),void 0!==t.premultipliedAlpha&&(n.premultipliedAlpha=t.premultipliedAlpha),void 0!==t.forceSinglePass&&(n.forceSinglePass=t.forceSinglePass),void 0!==t.visible&&(n.visible=t.visible),void 0!==t.toneMapped&&(n.toneMapped=t.toneMapped),void 0!==t.userData&&(n.userData=t.userData),void 0!==t.vertexColors&&("number"==typeof t.vertexColors?n.vertexColors=t.vertexColors>0:n.vertexColors=t.vertexColors),void 0!==t.uniforms)for(const e in t.uniforms){const s=t.uniforms[e];switch(n.uniforms[e]={},s.type){case"t":n.uniforms[e].value=i(s.value);break;case"c":n.uniforms[e].value=(new Zi).setHex(s.value);break;case"v2":n.uniforms[e].value=(new se).fromArray(s.value);break;case"v3":n.uniforms[e].value=(new Le).fromArray(s.value);break;case"v4":n.uniforms[e].value=(new Ce).fromArray(s.value);break;case"m3":n.uniforms[e].value=(new re).fromArray(s.value);break;case"m4":n.uniforms[e].value=(new ci).fromArray(s.value);break;default:n.uniforms[e].value=s.value}}if(void 0!==t.defines&&(n.defines=t.defines),void 0!==t.vertexShader&&(n.vertexShader=t.vertexShader),void 0!==t.fragmentShader&&(n.fragmentShader=t.fragmentShader),void 0!==t.glslVersion&&(n.glslVersion=t.glslVersion),void 0!==t.extensions)for(const e in t.extensions)n.extensions[e]=t.extensions[e];if(void 0!==t.lights&&(n.lights=t.lights),void 0!==t.clipping&&(n.clipping=t.clipping),void 0!==t.size&&(n.size=t.size),void 0!==t.sizeAttenuation&&(n.sizeAttenuation=t.sizeAttenuation),void 0!==t.map&&(n.map=i(t.map)),void 0!==t.matcap&&(n.matcap=i(t.matcap)),void 0!==t.alphaMap&&(n.alphaMap=i(t.alphaMap)),void 0!==t.bumpMap&&(n.bumpMap=i(t.bumpMap)),void 0!==t.bumpScale&&(n.bumpScale=t.bumpScale),void 0!==t.normalMap&&(n.normalMap=i(t.normalMap)),void 0!==t.normalMapType&&(n.normalMapType=t.normalMapType),void 0!==t.normalScale){let e=t.normalScale;!1===Array.isArray(e)&&(e=[e,e]),n.normalScale=(new se).fromArray(e)}return void 0!==t.displacementMap&&(n.displacementMap=i(t.displacementMap)),void 0!==t.displacementScale&&(n.displacementScale=t.displacementScale),void 0!==t.displacementBias&&(n.displacementBias=t.displacementBias),void 0!==t.roughnessMap&&(n.roughnessMap=i(t.roughnessMap)),void 0!==t.metalnessMap&&(n.metalnessMap=i(t.metalnessMap)),void 0!==t.emissiveMap&&(n.emissiveMap=i(t.emissiveMap)),void 0!==t.emissiveIntensity&&(n.emissiveIntensity=t.emissiveIntensity),void 0!==t.specularMap&&(n.specularMap=i(t.specularMap)),void 0!==t.specularIntensityMap&&(n.specularIntensityMap=i(t.specularIntensityMap)),void 0!==t.specularColorMap&&(n.specularColorMap=i(t.specularColorMap)),void 0!==t.envMap&&(n.envMap=i(t.envMap)),void 0!==t.envMapIntensity&&(n.envMapIntensity=t.envMapIntensity),void 0!==t.reflectivity&&(n.reflectivity=t.reflectivity),void 0!==t.refractionRatio&&(n.refractionRatio=t.refractionRatio),void 0!==t.lightMap&&(n.lightMap=i(t.lightMap)),void 0!==t.lightMapIntensity&&(n.lightMapIntensity=t.lightMapIntensity),void 0!==t.aoMap&&(n.aoMap=i(t.aoMap)),void 0!==t.aoMapIntensity&&(n.aoMapIntensity=t.aoMapIntensity),void 0!==t.gradientMap&&(n.gradientMap=i(t.gradientMap)),void 0!==t.clearcoatMap&&(n.clearcoatMap=i(t.clearcoatMap)),void 0!==t.clearcoatRoughnessMap&&(n.clearcoatRoughnessMap=i(t.clearcoatRoughnessMap)),void 0!==t.clearcoatNormalMap&&(n.clearcoatNormalMap=i(t.clearcoatNormalMap)),void 0!==t.clearcoatNormalScale&&(n.clearcoatNormalScale=(new se).fromArray(t.clearcoatNormalScale)),void 0!==t.iridescenceMap&&(n.iridescenceMap=i(t.iridescenceMap)),void 0!==t.iridescenceThicknessMap&&(n.iridescenceThicknessMap=i(t.iridescenceThicknessMap)),void 0!==t.transmissionMap&&(n.transmissionMap=i(t.transmissionMap)),void 0!==t.thicknessMap&&(n.thicknessMap=i(t.thicknessMap)),void 0!==t.anisotropyMap&&(n.anisotropyMap=i(t.anisotropyMap)),void 0!==t.sheenColorMap&&(n.sheenColorMap=i(t.sheenColorMap)),void 0!==t.sheenRoughnessMap&&(n.sheenRoughnessMap=i(t.sheenRoughnessMap)),n}setTextures(t){return this.textures=t,this}static createMaterialFromType(t){return new{ShadowMaterial:Ol,SpriteMaterial:Xa,RawShaderMaterial:Nl,ShaderMaterial:Vn,PointsMaterial:ch,MeshPhysicalMaterial:zl,MeshStandardMaterial:Bl,MeshPhongMaterial:Ul,MeshToonMaterial:Fl,MeshNormalMaterial:Gl,MeshLambertMaterial:Vl,MeshDepthMaterial:Ta,MeshDistanceMaterial:Aa,MeshBasicMaterial:nn,MeshMatcapMaterial:Hl,LineDashedMaterial:jl,LineBasicMaterial:Qo,Material:en}[t]}}class Uc{static decodeText(t){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(t);let e="";for(let i=0,n=t.length;i<n;i++)e+=String.fromCharCode(t[i]);try{return decodeURIComponent(escape(e))}catch(t){return e}}static extractUrlBase(t){const e=t.lastIndexOf("/");return-1===e?"./":t.slice(0,e+1)}static resolveURL(t,e){return"string"!=typeof t||""===t?"":(/^https?:\/\//i.test(e)&&/^\//.test(t)&&(e=e.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(t)||/^data:.*,.*$/i.test(t)||/^blob:.*$/i.test(t)?t:e+t)}}class Fc extends vn{constructor(){super(),this.isInstancedBufferGeometry=!0,this.type="InstancedBufferGeometry",this.instanceCount=1/0}copy(t){return super.copy(t),this.instanceCount=t.instanceCount,this}toJSON(){const t=super.toJSON();return t.instanceCount=this.instanceCount,t.isInstancedBufferGeometry=!0,t}}class Gc extends pc{constructor(t){super(t)}load(t,e,i,n){const s=this,r=new gc(s.manager);r.setPath(s.path),r.setRequestHeader(s.requestHeader),r.setWithCredentials(s.withCredentials),r.load(t,(function(i){try{e(s.parse(JSON.parse(i)))}catch(e){n&&n(e),s.manager.itemError(t)}}),i,n)}parse(t){const e={},i={};function n(t,n){if(void 0!==e[n])return e[n];const s=t.interleavedBuffers[n],r=function(t,e){if(void 0!==i[e])return i[e];const n=t.arrayBuffers,s=n[e],r=new Uint32Array(s).buffer;return i[e]=r,r}(t,s.buffer),a=le(s.type,r),o=new Ha(a,s.stride);return o.uuid=s.uuid,e[n]=o,o}const s=t.isInstancedBufferGeometry?new Fc:new vn,r=t.data.index;if(void 0!==r){const t=le(r.type,r.array);s.setIndex(new an(t,1))}const a=t.data.attributes;for(const e in a){const i=a[e];let r;if(i.isInterleavedBufferAttribute){const e=n(t.data,i.data);r=new Wa(e,i.itemSize,i.offset,i.normalized)}else{const t=le(i.type,i.array);r=new(i.isInstancedBufferAttribute?Ao:an)(t,i.itemSize,i.normalized)}void 0!==i.name&&(r.name=i.name),void 0!==i.usage&&r.setUsage(i.usage),s.setAttribute(e,r)}const o=t.data.morphAttributes;if(o)for(const e in o){const i=o[e],r=[];for(let e=0,s=i.length;e<s;e++){const s=i[e];let a;if(s.isInterleavedBufferAttribute){const e=n(t.data,s.data);a=new Wa(e,s.itemSize,s.offset,s.normalized)}else{const t=le(s.type,s.array);a=new an(t,s.itemSize,s.normalized)}void 0!==s.name&&(a.name=s.name),r.push(a)}s.morphAttributes[e]=r}t.data.morphTargetsRelative&&(s.morphTargetsRelative=!0);const h=t.data.groups||t.data.drawcalls||t.data.offsets;if(void 0!==h)for(let t=0,e=h.length;t!==e;++t){const e=h[t];s.addGroup(e.start,e.count,e.materialIndex)}const l=t.data.boundingSphere;if(void 0!==l){const t=new Le;void 0!==l.center&&t.fromArray(l.center),s.boundingSphere=new ei(t,l.radius)}return t.name&&(s.name=t.name),t.userData&&(s.userData=t.userData),s}}class Vc extends pc{constructor(t){super(t)}load(t,e,i,n){const s=this,r=""===this.path?Uc.extractUrlBase(t):this.path;this.resourcePath=this.resourcePath||r;const a=new gc(this.manager);a.setPath(this.path),a.setRequestHeader(this.requestHeader),a.setWithCredentials(this.withCredentials),a.load(t,(function(i){let r=null;try{r=JSON.parse(i)}catch(t){return void(void 0!==n&&n(t))}const a=r.metadata;void 0!==a&&void 0!==a.type&&"geometry"!==a.type.toLowerCase()?s.parse(r,e):void 0!==n&&n(new Error("THREE.ObjectLoader: Can't load "+t))}),i,n)}async loadAsync(t,e){const i=""===this.path?Uc.extractUrlBase(t):this.path;this.resourcePath=this.resourcePath||i;const n=new gc(this.manager);n.setPath(this.path),n.setRequestHeader(this.requestHeader),n.setWithCredentials(this.withCredentials);const s=await n.loadAsync(t,e),r=JSON.parse(s),a=r.metadata;if(void 0===a||void 0===a.type||"geometry"===a.type.toLowerCase())throw new Error("THREE.ObjectLoader: Can't load "+t);return await this.parseAsync(r)}parse(t,e){const i=this.parseAnimations(t.animations),n=this.parseShapes(t.shapes),s=this.parseGeometries(t.geometries,n),r=this.parseImages(t.images,(function(){void 0!==e&&e(h)})),a=this.parseTextures(t.textures,r),o=this.parseMaterials(t.materials,a),h=this.parseObject(t.object,s,o,a,i),l=this.parseSkeletons(t.skeletons,h);if(this.bindSkeletons(h,l),void 0!==e){let t=!1;for(const e in r)if(r[e].data instanceof HTMLImageElement){t=!0;break}!1===t&&e(h)}return h}async parseAsync(t){const e=this.parseAnimations(t.animations),i=this.parseShapes(t.shapes),n=this.parseGeometries(t.geometries,i),s=await this.parseImagesAsync(t.images),r=this.parseTextures(t.textures,s),a=this.parseMaterials(t.materials,r),o=this.parseObject(t.object,n,a,r,e),h=this.parseSkeletons(t.skeletons,o);return this.bindSkeletons(o,h),o}parseShapes(t){const e={};if(void 0!==t)for(let i=0,n=t.length;i<n;i++){const n=(new qh).fromJSON(t[i]);e[n.uuid]=n}return e}parseSkeletons(t,e){const i={},n={};if(e.traverse((function(t){t.isBone&&(n[t.uuid]=t)})),void 0!==t)for(let e=0,s=t.length;e<s;e++){const s=(new To).fromJSON(t[e],n);i[s.uuid]=s}return i}parseGeometries(t,e){const i={};if(void 0!==t){const n=new Gc;for(let s=0,r=t.length;s<r;s++){let r;const a=t[s];switch(a.type){case"BufferGeometry":case"InstancedBufferGeometry":r=n.parse(a);break;default:a.type in Ll&&(r=Ll[a.type].fromJSON(a,e))}r.uuid=a.uuid,void 0!==a.name&&(r.name=a.name),void 0!==a.userData&&(r.userData=a.userData),i[a.uuid]=r}}return i}parseMaterials(t,e){const i={},n={};if(void 0!==t){const s=new zc;s.setTextures(e);for(let e=0,r=t.length;e<r;e++){const r=t[e];void 0===i[r.uuid]&&(i[r.uuid]=s.parse(r)),n[r.uuid]=i[r.uuid]}}return n}parseAnimations(t){const e={};if(void 0!==t)for(let i=0;i<t.length;i++){const n=t[i],s=hc.parse(n);e[s.uuid]=s}return e}parseImages(t,e){const i=this,n={};let s;function r(t){if("string"==typeof t){const e=t;return function(t){return i.manager.itemStart(t),s.load(t,(function(){i.manager.itemEnd(t)}),void 0,(function(){i.manager.itemError(t),i.manager.itemEnd(t)}))}(/^(\/\/)|([a-z]+:(\/\/)?)/i.test(e)?e:i.resourcePath+e)}return t.data?{data:le(t.type,t.data),width:t.width,height:t.height}:null}if(void 0!==t&&t.length>0){const i=new uc(e);s=new vc(i),s.setCrossOrigin(this.crossOrigin);for(let e=0,i=t.length;e<i;e++){const i=t[e],s=i.url;if(Array.isArray(s)){const t=[];for(let e=0,i=s.length;e<i;e++){const i=r(s[e]);null!==i&&(i instanceof HTMLImageElement?t.push(i):t.push(new Mo(i.data,i.width,i.height)))}n[i.uuid]=new Se(t)}else{const t=r(i.url);n[i.uuid]=new Se(t)}}}return n}async parseImagesAsync(t){const e=this,i={};let n;async function s(t){if("string"==typeof t){const i=t,s=/^(\/\/)|([a-z]+:(\/\/)?)/i.test(i)?i:e.resourcePath+i;return await n.loadAsync(s)}return t.data?{data:le(t.type,t.data),width:t.width,height:t.height}:null}if(void 0!==t&&t.length>0){n=new vc(this.manager),n.setCrossOrigin(this.crossOrigin);for(let e=0,n=t.length;e<n;e++){const n=t[e],r=n.url;if(Array.isArray(r)){const t=[];for(let e=0,i=r.length;e<i;e++){const i=r[e],n=await s(i);null!==n&&(n instanceof HTMLImageElement?t.push(n):t.push(new Mo(n.data,n.width,n.height)))}i[n.uuid]=new Se(t)}else{const t=await s(n.url);i[n.uuid]=new Se(t)}}}return i}parseTextures(t,e){function i(t,e){return"number"==typeof t?t:e[t]}const n={};if(void 0!==t)for(let s=0,r=t.length;s<r;s++){const r=t[s];r.image,e[r.image];const a=e[r.image],o=a.data;let h;Array.isArray(o)?(h=new qn,6===o.length&&(h.needsUpdate=!0)):(h=o&&o.data?new Mo:new Ae,o&&(h.needsUpdate=!0)),h.source=a,h.uuid=r.uuid,void 0!==r.name&&(h.name=r.name),void 0!==r.mapping&&(h.mapping=i(r.mapping,Hc)),void 0!==r.channel&&(h.channel=r.channel),void 0!==r.offset&&h.offset.fromArray(r.offset),void 0!==r.repeat&&h.repeat.fromArray(r.repeat),void 0!==r.center&&h.center.fromArray(r.center),void 0!==r.rotation&&(h.rotation=r.rotation),void 0!==r.wrap&&(h.wrapS=i(r.wrap[0],jc),h.wrapT=i(r.wrap[1],jc)),void 0!==r.format&&(h.format=r.format),void 0!==r.internalFormat&&(h.internalFormat=r.internalFormat),void 0!==r.type&&(h.type=r.type),void 0!==r.colorSpace&&(h.colorSpace=r.colorSpace),void 0!==r.encoding&&(h.encoding=r.encoding),void 0!==r.minFilter&&(h.minFilter=i(r.minFilter,Wc)),void 0!==r.magFilter&&(h.magFilter=i(r.magFilter,Wc)),void 0!==r.anisotropy&&(h.anisotropy=r.anisotropy),void 0!==r.flipY&&(h.flipY=r.flipY),void 0!==r.generateMipmaps&&(h.generateMipmaps=r.generateMipmaps),void 0!==r.premultiplyAlpha&&(h.premultiplyAlpha=r.premultiplyAlpha),void 0!==r.unpackAlignment&&(h.unpackAlignment=r.unpackAlignment),void 0!==r.compareFunction&&(h.compareFunction=r.compareFunction),void 0!==r.userData&&(h.userData=r.userData),n[r.uuid]=h}return n}parseObject(t,e,i,n,s){let r,a,o;function h(t){return e[t],e[t]}function l(t){if(void 0!==t){if(Array.isArray(t)){const e=[];for(let n=0,s=t.length;n<s;n++){const s=t[n];i[s],e.push(i[s])}return e}return i[t],i[t]}}function c(t){return n[t],n[t]}switch(t.type){case"Scene":r=new Va,void 0!==t.background&&(Number.isInteger(t.background)?r.background=new Zi(t.background):r.background=c(t.background)),void 0!==t.environment&&(r.environment=c(t.environment)),void 0!==t.fog&&("Fog"===t.fog.type?r.fog=new Ga(t.fog.color,t.fog.near,t.fog.far):"FogExp2"===t.fog.type&&(r.fog=new Fa(t.fog.color,t.fog.density)),""!==t.fog.name&&(r.fog.name=t.fog.name)),void 0!==t.backgroundBlurriness&&(r.backgroundBlurriness=t.backgroundBlurriness),void 0!==t.backgroundIntensity&&(r.backgroundIntensity=t.backgroundIntensity);break;case"PerspectiveCamera":r=new jn(t.fov,t.aspect,t.near,t.far),void 0!==t.focus&&(r.focus=t.focus),void 0!==t.zoom&&(r.zoom=t.zoom),void 0!==t.filmGauge&&(r.filmGauge=t.filmGauge),void 0!==t.filmOffset&&(r.filmOffset=t.filmOffset),void 0!==t.view&&(r.view=Object.assign({},t.view));break;case"OrthographicCamera":r=new fs(t.left,t.right,t.top,t.bottom,t.near,t.far),void 0!==t.zoom&&(r.zoom=t.zoom),void 0!==t.view&&(r.view=Object.assign({},t.view));break;case"AmbientLight":r=new Lc(t.color,t.intensity);break;case"DirectionalLight":r=new Dc(t.color,t.intensity);break;case"PointLight":r=new kc(t.color,t.intensity,t.distance,t.decay);break;case"RectAreaLight":r=new Oc(t.color,t.intensity,t.width,t.height);break;case"SpotLight":r=new Tc(t.color,t.intensity,t.distance,t.angle,t.penumbra,t.decay);break;case"HemisphereLight":r=new bc(t.color,t.groundColor,t.intensity);break;case"LightProbe":r=(new Bc).fromJSON(t);break;case"SkinnedMesh":a=h(t.geometry),o=l(t.material),r=new _o(a,o),void 0!==t.bindMode&&(r.bindMode=t.bindMode),void 0!==t.bindMatrix&&r.bindMatrix.fromArray(t.bindMatrix),void 0!==t.skeleton&&(r.skeleton=t.skeleton);break;case"Mesh":a=h(t.geometry),o=l(t.material),r=new On(a,o);break;case"InstancedMesh":a=h(t.geometry),o=l(t.material);const e=t.count,i=t.instanceMatrix,n=t.instanceColor;r=new Oo(a,o,e),r.instanceMatrix=new Ao(new Float32Array(i.array),16),void 0!==n&&(r.instanceColor=new Ao(new Float32Array(n.array),n.itemSize));break;case"BatchedMesh":a=h(t.geometry),o=l(t.material),r=new Zo(t.maxGeometryCount,t.maxVertexCount,t.maxIndexCount,o),r.geometry=a,r.perObjectFrustumCulled=t.perObjectFrustumCulled,r.sortObjects=t.sortObjects,r._drawRanges=t.drawRanges,r._reservedRanges=t.reservedRanges,r._visibility=t.visibility,r._active=t.active,r._bounds=t.bounds.map((t=>{const e=new Be;e.min.fromArray(t.boxMin),e.max.fromArray(t.boxMax);const i=new ei;return i.radius=t.sphereRadius,i.center.fromArray(t.sphereCenter),{boxInitialized:t.boxInitialized,box:e,sphereInitialized:t.sphereInitialized,sphere:i}})),r._maxGeometryCount=t.maxGeometryCount,r._maxVertexCount=t.maxVertexCount,r._maxIndexCount=t.maxIndexCount,r._geometryInitialized=t.geometryInitialized,r._geometryCount=t.geometryCount,r._matricesTexture=c(t.matricesTexture.uuid);break;case"LOD":r=new co;break;case"Line":r=new rh(h(t.geometry),l(t.material));break;case"LineLoop":r=new lh(h(t.geometry),l(t.material));break;case"LineSegments":r=new hh(h(t.geometry),l(t.material));break;case"PointCloud":case"Points":r=new fh(h(t.geometry),l(t.material));break;case"Sprite":r=new ao(l(t.material));break;case"Group":r=new Da;break;case"Bone":r=new wo;break;default:r=new Oi}if(r.uuid=t.uuid,void 0!==t.name&&(r.name=t.name),void 0!==t.matrix?(r.matrix.fromArray(t.matrix),void 0!==t.matrixAutoUpdate&&(r.matrixAutoUpdate=t.matrixAutoUpdate),r.matrixAutoUpdate&&r.matrix.decompose(r.position,r.quaternion,r.scale)):(void 0!==t.position&&r.position.fromArray(t.position),void 0!==t.rotation&&r.rotation.fromArray(t.rotation),void 0!==t.quaternion&&r.quaternion.fromArray(t.quaternion),void 0!==t.scale&&r.scale.fromArray(t.scale)),void 0!==t.up&&r.up.fromArray(t.up),void 0!==t.castShadow&&(r.castShadow=t.castShadow),void 0!==t.receiveShadow&&(r.receiveShadow=t.receiveShadow),t.shadow&&(void 0!==t.shadow.bias&&(r.shadow.bias=t.shadow.bias),void 0!==t.shadow.normalBias&&(r.shadow.normalBias=t.shadow.normalBias),void 0!==t.shadow.radius&&(r.shadow.radius=t.shadow.radius),void 0!==t.shadow.mapSize&&r.shadow.mapSize.fromArray(t.shadow.mapSize),void 0!==t.shadow.camera&&(r.shadow.camera=this.parseObject(t.shadow.camera))),void 0!==t.visible&&(r.visible=t.visible),void 0!==t.frustumCulled&&(r.frustumCulled=t.frustumCulled),void 0!==t.renderOrder&&(r.renderOrder=t.renderOrder),void 0!==t.userData&&(r.userData=t.userData),void 0!==t.layers&&(r.layers.mask=t.layers),void 0!==t.children){const a=t.children;for(let t=0;t<a.length;t++)r.add(this.parseObject(a[t],e,i,n,s))}if(void 0!==t.animations){const e=t.animations;for(let t=0;t<e.length;t++){const i=e[t];r.animations.push(s[i])}}if("LOD"===t.type){void 0!==t.autoUpdate&&(r.autoUpdate=t.autoUpdate);const e=t.levels;for(let t=0;t<e.length;t++){const i=e[t],n=r.getObjectByProperty("uuid",i.object);void 0!==n&&r.addLevel(n,i.distance,i.hysteresis)}}return r}bindSkeletons(t,e){0!==Object.keys(e).length&&t.traverse((function(t){if(!0===t.isSkinnedMesh&&void 0!==t.skeleton){const i=e[t.skeleton];void 0===i||t.bind(i,t.bindMatrix)}}))}}const Hc={UVMapping:300,CubeReflectionMapping:H,CubeRefractionMapping:j,EquirectangularReflectionMapping:W,EquirectangularRefractionMapping:X,CubeUVReflectionMapping:q},jc={RepeatWrapping:Y,ClampToEdgeWrapping:J,MirroredRepeatWrapping:$},Wc={NearestFilter:K,NearestMipmapNearestFilter:Z,NearestMipmapLinearFilter:Q,LinearFilter:tt,LinearMipmapNearestFilter:et,LinearMipmapLinearFilter:it};class Xc extends pc{constructor(t){super(t),this.isImageBitmapLoader=!0,this.options={premultiplyAlpha:"none"}}setOptions(t){return this.options=t,this}load(t,e,i,n){void 0===t&&(t=""),void 0!==this.path&&(t=this.path+t),t=this.manager.resolveURL(t);const s=this,r=cc.get(t);if(void 0!==r)return s.manager.itemStart(t),r.then?void r.then((i=>{e&&e(i),s.manager.itemEnd(t)})).catch((t=>{n&&n(t)})):(setTimeout((function(){e&&e(r),s.manager.itemEnd(t)}),0),r);const a={};a.credentials="anonymous"===this.crossOrigin?"same-origin":"include",a.headers=this.requestHeader;const o=fetch(t,a).then((function(t){return t.blob()})).then((function(t){return createImageBitmap(t,Object.assign(s.options,{colorSpaceConversion:"none"}))})).then((function(i){return cc.add(t,i),e&&e(i),s.manager.itemEnd(t),i})).catch((function(e){n&&n(e),cc.remove(t),s.manager.itemError(t),s.manager.itemEnd(t)}));cc.add(t,o),s.manager.itemStart(t)}}class qc{constructor(t=!0){this.autoStart=t,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}start(){this.startTime=Yc(),this.oldTime=this.startTime,this.elapsedTime=0,this.running=!0}stop(){this.getElapsedTime(),this.running=!1,this.autoStart=!1}getElapsedTime(){return this.getDelta(),this.elapsedTime}getDelta(){let t=0;if(this.autoStart&&!this.running)return this.start(),0;if(this.running){const e=Yc();t=(e-this.oldTime)/1e3,this.oldTime=e,this.elapsedTime+=t}return t}}function Yc(){return("undefined"==typeof performance?Date:performance).now()}class Jc{constructor(t,e,i){let n,s,r;switch(this.binding=t,this.valueSize=i,e){case"quaternion":n=this._slerp,s=this._slerpAdditive,r=this._setAdditiveIdentityQuaternion,this.buffer=new Float64Array(6*i),this._workIndex=5;break;case"string":case"bool":n=this._select,s=this._select,r=this._setAdditiveIdentityOther,this.buffer=new Array(5*i);break;default:n=this._lerp,s=this._lerpAdditive,r=this._setAdditiveIdentityNumeric,this.buffer=new Float64Array(5*i)}this._mixBufferRegion=n,this._mixBufferRegionAdditive=s,this._setIdentity=r,this._origIndex=3,this._addIndex=4,this.cumulativeWeight=0,this.cumulativeWeightAdditive=0,this.useCount=0,this.referenceCount=0}accumulate(t,e){const i=this.buffer,n=this.valueSize,s=t*n+n;let r=this.cumulativeWeight;if(0===r){for(let t=0;t!==n;++t)i[s+t]=i[t];r=e}else{r+=e;const t=e/r;this._mixBufferRegion(i,s,0,t,n)}this.cumulativeWeight=r}accumulateAdditive(t){const e=this.buffer,i=this.valueSize,n=i*this._addIndex;0===this.cumulativeWeightAdditive&&this._setIdentity(),this._mixBufferRegionAdditive(e,n,0,t,i),this.cumulativeWeightAdditive+=t}apply(t){const e=this.valueSize,i=this.buffer,n=t*e+e,s=this.cumulativeWeight,r=this.cumulativeWeightAdditive,a=this.binding;if(this.cumulativeWeight=0,this.cumulativeWeightAdditive=0,s<1){const t=e*this._origIndex;this._mixBufferRegion(i,n,t,1-s,e)}r>0&&this._mixBufferRegionAdditive(i,n,this._addIndex*e,1,e);for(let t=e,s=e+e;t!==s;++t)if(i[t]!==i[t+e]){a.setValue(i,n);break}}saveOriginalState(){const t=this.binding,e=this.buffer,i=this.valueSize,n=i*this._origIndex;t.getValue(e,n);for(let t=i,s=n;t!==s;++t)e[t]=e[n+t%i];this._setIdentity(),this.cumulativeWeight=0,this.cumulativeWeightAdditive=0}restoreOriginalState(){const t=3*this.valueSize;this.binding.setValue(this.buffer,t)}_setAdditiveIdentityNumeric(){const t=this._addIndex*this.valueSize,e=t+this.valueSize;for(let i=t;i<e;i++)this.buffer[i]=0}_setAdditiveIdentityQuaternion(){this._setAdditiveIdentityNumeric(),this.buffer[this._addIndex*this.valueSize+3]=1}_setAdditiveIdentityOther(){const t=this._origIndex*this.valueSize,e=this._addIndex*this.valueSize;for(let i=0;i<this.valueSize;i++)this.buffer[e+i]=this.buffer[t+i]}_select(t,e,i,n,s){if(n>=.5)for(let n=0;n!==s;++n)t[e+n]=t[i+n]}_slerp(t,e,i,n){De.slerpFlat(t,e,t,e,t,i,n)}_slerpAdditive(t,e,i,n,s){const r=this._workIndex*s;De.multiplyQuaternionsFlat(t,r,t,e,t,i),De.slerpFlat(t,e,t,e,t,r,n)}_lerp(t,e,i,n,s){const r=1-n;for(let a=0;a!==s;++a){const s=e+a;t[s]=t[s]*r+t[i+a]*n}}_lerpAdditive(t,e,i,n,s){for(let r=0;r!==s;++r){const s=e+r;t[s]=t[s]+t[i+r]*n}}}const $c="\\[\\]\\.:\\/",Kc=new RegExp("["+$c+"]","g"),Zc="[^"+$c+"]",Qc="[^"+$c.replace("\\.","")+"]",tu=new RegExp("^"+/((?:WC+[\/:])*)/.source.replace("WC",Zc)+/(WCOD+)?/.source.replace("WCOD",Qc)+/(?:\.(WC+)(?:\[(.+)\])?)?/.source.replace("WC",Zc)+/\.(WC+)(?:\[(.+)\])?/.source.replace("WC",Zc)+"$"),eu=["material","materials","bones","map"];class iu{constructor(t,e,i){this.path=e,this.parsedPath=i||iu.parseTrackName(e),this.node=iu.findNode(t,this.parsedPath.nodeName),this.rootNode=t,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}static create(t,e,i){return t&&t.isAnimationObjectGroup?new iu.Composite(t,e,i):new iu(t,e,i)}static sanitizeNodeName(t){return t.replace(/\s/g,"_").replace(Kc,"")}static parseTrackName(t){const e=tu.exec(t);if(null===e)throw new Error("PropertyBinding: Cannot parse trackName: "+t);const i={nodeName:e[2],objectName:e[3],objectIndex:e[4],propertyName:e[5],propertyIndex:e[6]},n=i.nodeName&&i.nodeName.lastIndexOf(".");if(void 0!==n&&-1!==n){const t=i.nodeName.substring(n+1);-1!==eu.indexOf(t)&&(i.nodeName=i.nodeName.substring(0,n),i.objectName=t)}if(null===i.propertyName||0===i.propertyName.length)throw new Error("PropertyBinding: can not parse propertyName from trackName: "+t);return i}static findNode(t,e){if(void 0===e||""===e||"."===e||-1===e||e===t.name||e===t.uuid)return t;if(t.skeleton){const i=t.skeleton.getBoneByName(e);if(void 0!==i)return i}if(t.children){const i=function(t){for(let n=0;n<t.length;n++){const s=t[n];if(s.name===e||s.uuid===e)return s;const r=i(s.children);if(r)return r}return null},n=i(t.children);if(n)return n}return null}_getValue_unavailable(){}_setValue_unavailable(){}_getValue_direct(t,e){t[e]=this.targetObject[this.propertyName]}_getValue_array(t,e){const i=this.resolvedProperty;for(let n=0,s=i.length;n!==s;++n)t[e++]=i[n]}_getValue_arrayElement(t,e){t[e]=this.resolvedProperty[this.propertyIndex]}_getValue_toArray(t,e){this.resolvedProperty.toArray(t,e)}_setValue_direct(t,e){this.targetObject[this.propertyName]=t[e]}_setValue_direct_setNeedsUpdate(t,e){this.targetObject[this.propertyName]=t[e],this.targetObject.needsUpdate=!0}_setValue_direct_setMatrixWorldNeedsUpdate(t,e){this.targetObject[this.propertyName]=t[e],this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_array(t,e){const i=this.resolvedProperty;for(let n=0,s=i.length;n!==s;++n)i[n]=t[e++]}_setValue_array_setNeedsUpdate(t,e){const i=this.resolvedProperty;for(let n=0,s=i.length;n!==s;++n)i[n]=t[e++];this.targetObject.needsUpdate=!0}_setValue_array_setMatrixWorldNeedsUpdate(t,e){const i=this.resolvedProperty;for(let n=0,s=i.length;n!==s;++n)i[n]=t[e++];this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_arrayElement(t,e){this.resolvedProperty[this.propertyIndex]=t[e]}_setValue_arrayElement_setNeedsUpdate(t,e){this.resolvedProperty[this.propertyIndex]=t[e],this.targetObject.needsUpdate=!0}_setValue_arrayElement_setMatrixWorldNeedsUpdate(t,e){this.resolvedProperty[this.propertyIndex]=t[e],this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_fromArray(t,e){this.resolvedProperty.fromArray(t,e)}_setValue_fromArray_setNeedsUpdate(t,e){this.resolvedProperty.fromArray(t,e),this.targetObject.needsUpdate=!0}_setValue_fromArray_setMatrixWorldNeedsUpdate(t,e){this.resolvedProperty.fromArray(t,e),this.targetObject.matrixWorldNeedsUpdate=!0}_getValue_unbound(t,e){this.bind(),this.getValue(t,e)}_setValue_unbound(t,e){this.bind(),this.setValue(t,e)}bind(){let t=this.node;const e=this.parsedPath,i=e.objectName,n=e.propertyName;let s=e.propertyIndex;if(t||(t=iu.findNode(this.rootNode,e.nodeName),this.node=t),this.getValue=this._getValue_unavailable,this.setValue=this._setValue_unavailable,!t)return;if(i){let n=e.objectIndex;switch(i){case"materials":if(!t.material)return;if(!t.material.materials)return;t=t.material.materials;break;case"bones":if(!t.skeleton)return;t=t.skeleton.bones;for(let e=0;e<t.length;e++)if(t[e].name===n){n=e;break}break;case"map":if("map"in t){t=t.map;break}if(!t.material)return;if(!t.material.map)return;t=t.material.map;break;default:if(void 0===t[i])return;t=t[i]}if(void 0!==n){if(void 0===t[n])return;t=t[n]}}const r=t[n];if(void 0===r){e.nodeName;return}let a=this.Versioning.None;this.targetObject=t,void 0!==t.needsUpdate?a=this.Versioning.NeedsUpdate:void 0!==t.matrixWorldNeedsUpdate&&(a=this.Versioning.MatrixWorldNeedsUpdate);let o=this.BindingType.Direct;if(void 0!==s){if("morphTargetInfluences"===n){if(!t.geometry)return;if(!t.geometry.morphAttributes)return;void 0!==t.morphTargetDictionary[s]&&(s=t.morphTargetDictionary[s])}o=this.BindingType.ArrayElement,this.resolvedProperty=r,this.propertyIndex=s}else void 0!==r.fromArray&&void 0!==r.toArray?(o=this.BindingType.HasFromToArray,this.resolvedProperty=r):Array.isArray(r)?(o=this.BindingType.EntireArray,this.resolvedProperty=r):this.propertyName=n;this.getValue=this.GetterByBindingType[o],this.setValue=this.SetterByBindingTypeAndVersioning[o][a]}unbind(){this.node=null,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}}iu.Composite=class{constructor(t,e,i){const n=i||iu.parseTrackName(e);this._targetGroup=t,this._bindings=t.subscribe_(e,n)}getValue(t,e){this.bind();const i=this._targetGroup.nCachedObjects_,n=this._bindings[i];void 0!==n&&n.getValue(t,e)}setValue(t,e){const i=this._bindings;for(let n=this._targetGroup.nCachedObjects_,s=i.length;n!==s;++n)i[n].setValue(t,e)}bind(){const t=this._bindings;for(let e=this._targetGroup.nCachedObjects_,i=t.length;e!==i;++e)t[e].bind()}unbind(){const t=this._bindings;for(let e=this._targetGroup.nCachedObjects_,i=t.length;e!==i;++e)t[e].unbind()}},iu.prototype.BindingType={Direct:0,EntireArray:1,ArrayElement:2,HasFromToArray:3},iu.prototype.Versioning={None:0,NeedsUpdate:1,MatrixWorldNeedsUpdate:2},iu.prototype.GetterByBindingType=[iu.prototype._getValue_direct,iu.prototype._getValue_array,iu.prototype._getValue_arrayElement,iu.prototype._getValue_toArray],iu.prototype.SetterByBindingTypeAndVersioning=[[iu.prototype._setValue_direct,iu.prototype._setValue_direct_setNeedsUpdate,iu.prototype._setValue_direct_setMatrixWorldNeedsUpdate],[iu.prototype._setValue_array,iu.prototype._setValue_array_setNeedsUpdate,iu.prototype._setValue_array_setMatrixWorldNeedsUpdate],[iu.prototype._setValue_arrayElement,iu.prototype._setValue_arrayElement_setNeedsUpdate,iu.prototype._setValue_arrayElement_setMatrixWorldNeedsUpdate],[iu.prototype._setValue_fromArray,iu.prototype._setValue_fromArray_setNeedsUpdate,iu.prototype._setValue_fromArray_setMatrixWorldNeedsUpdate]];class nu{constructor(t,e,i=null,n=e.blendMode){this._mixer=t,this._clip=e,this._localRoot=i,this.blendMode=n;const s=e.tracks,r=s.length,a=new Array(r),o={endingStart:Mt,endingEnd:Mt};for(let t=0;t!==r;++t){const e=s[t].createInterpolant(null);a[t]=e,e.settings=o}this._interpolantSettings=o,this._interpolants=a,this._propertyBindings=new Array(r),this._cacheIndex=null,this._byClipCacheIndex=null,this._timeScaleInterpolant=null,this._weightInterpolant=null,this.loop=xt,this._loopCount=-1,this._startTime=null,this.time=0,this.timeScale=1,this._effectiveTimeScale=1,this.weight=1,this._effectiveWeight=1,this.repetitions=1/0,this.paused=!1,this.enabled=!0,this.clampWhenFinished=!1,this.zeroSlopeAtStart=!0,this.zeroSlopeAtEnd=!0}play(){return this._mixer._activateAction(this),this}stop(){return this._mixer._deactivateAction(this),this.reset()}reset(){return this.paused=!1,this.enabled=!0,this.time=0,this._loopCount=-1,this._startTime=null,this.stopFading().stopWarping()}isRunning(){return this.enabled&&!this.paused&&0!==this.timeScale&&null===this._startTime&&this._mixer._isActiveAction(this)}isScheduled(){return this._mixer._isActiveAction(this)}startAt(t){return this._startTime=t,this}setLoop(t,e){return this.loop=t,this.repetitions=e,this}setEffectiveWeight(t){return this.weight=t,this._effectiveWeight=this.enabled?t:0,this.stopFading()}getEffectiveWeight(){return this._effectiveWeight}fadeIn(t){return this._scheduleFading(t,0,1)}fadeOut(t){return this._scheduleFading(t,1,0)}crossFadeFrom(t,e,i){if(t.fadeOut(e),this.fadeIn(e),i){const i=this._clip.duration,n=t._clip.duration,s=n/i,r=i/n;t.warp(1,s,e),this.warp(r,1,e)}return this}crossFadeTo(t,e,i){return t.crossFadeFrom(this,e,i)}stopFading(){const t=this._weightInterpolant;return null!==t&&(this._weightInterpolant=null,this._mixer._takeBackControlInterpolant(t)),this}setEffectiveTimeScale(t){return this.timeScale=t,this._effectiveTimeScale=this.paused?0:t,this.stopWarping()}getEffectiveTimeScale(){return this._effectiveTimeScale}setDuration(t){return this.timeScale=this._clip.duration/t,this.stopWarping()}syncWith(t){return this.time=t.time,this.timeScale=t.timeScale,this.stopWarping()}halt(t){return this.warp(this._effectiveTimeScale,0,t)}warp(t,e,i){const n=this._mixer,s=n.time,r=this.timeScale;let a=this._timeScaleInterpolant;null===a&&(a=n._lendControlInterpolant(),this._timeScaleInterpolant=a);const o=a.parameterPositions,h=a.sampleValues;return o[0]=s,o[1]=s+i,h[0]=t/r,h[1]=e/r,this}stopWarping(){const t=this._timeScaleInterpolant;return null!==t&&(this._timeScaleInterpolant=null,this._mixer._takeBackControlInterpolant(t)),this}getMixer(){return this._mixer}getClip(){return this._clip}getRoot(){return this._localRoot||this._mixer._root}_update(t,e,i,n){if(!this.enabled)return void this._updateWeight(t);const s=this._startTime;if(null!==s){const n=(t-s)*i;n<0||0===i?e=0:(this._startTime=null,e=i*n)}e*=this._updateTimeScale(t);const r=this._updateTime(e),a=this._updateWeight(t);if(a>0){const t=this._interpolants,e=this._propertyBindings;if(2501===this.blendMode)for(let i=0,n=t.length;i!==n;++i)t[i].evaluate(r),e[i].accumulateAdditive(a);else for(let i=0,s=t.length;i!==s;++i)t[i].evaluate(r),e[i].accumulate(n,a)}}_updateWeight(t){let e=0;if(this.enabled){e=this.weight;const i=this._weightInterpolant;if(null!==i){const n=i.evaluate(t)[0];e*=n,t>i.parameterPositions[1]&&(this.stopFading(),0===n&&(this.enabled=!1))}}return this._effectiveWeight=e,e}_updateTimeScale(t){let e=0;if(!this.paused){e=this.timeScale;const i=this._timeScaleInterpolant;if(null!==i){e*=i.evaluate(t)[0],t>i.parameterPositions[1]&&(this.stopWarping(),0===e?this.paused=!0:this.timeScale=e)}}return this._effectiveTimeScale=e,e}_updateTime(t){const e=this._clip.duration,i=this.loop;let n=this.time+t,s=this._loopCount;const r=2202===i;if(0===t)return-1===s?n:r&&1==(1&s)?e-n:n;if(i===yt){-1===s&&(this._loopCount=0,this._setEndings(!0,!0,!1));t:{if(n>=e)n=e;else{if(!(n<0)){this.time=n;break t}n=0}this.clampWhenFinished?this.paused=!0:this.enabled=!1,this.time=n,this._mixer.dispatchEvent({type:"finished",action:this,direction:t<0?-1:1})}}else{if(-1===s&&(t>=0?(s=0,this._setEndings(!0,0===this.repetitions,r)):this._setEndings(0===this.repetitions,!0,r)),n>=e||n<0){const i=Math.floor(n/e);n-=e*i,s+=Math.abs(i);const a=this.repetitions-s;if(a<=0)this.clampWhenFinished?this.paused=!0:this.enabled=!1,n=t>0?e:0,this.time=n,this._mixer.dispatchEvent({type:"finished",action:this,direction:t>0?1:-1});else{if(1===a){const e=t<0;this._setEndings(e,!e,r)}else this._setEndings(!1,!1,r);this._loopCount=s,this.time=n,this._mixer.dispatchEvent({type:"loop",action:this,loopDelta:i})}}else this.time=n;if(r&&1==(1&s))return e-n}return n}_setEndings(t,e,i){const n=this._interpolantSettings;i?(n.endingStart=St,n.endingEnd=St):(n.endingStart=t?this.zeroSlopeAtStart?St:Mt:Et,n.endingEnd=e?this.zeroSlopeAtEnd?St:Mt:Et)}_scheduleFading(t,e,i){const n=this._mixer,s=n.time;let r=this._weightInterpolant;null===r&&(r=n._lendControlInterpolant(),this._weightInterpolant=r);const a=r.parameterPositions,o=r.sampleValues;return a[0]=s,o[0]=e,a[1]=s+t,o[1]=i,this}}const su=new Float32Array(1);class ru extends jt{constructor(t){super(),this._root=t,this._initMemoryManager(),this._accuIndex=0,this.time=0,this.timeScale=1}_bindAction(t,e){const i=t._localRoot||this._root,n=t._clip.tracks,s=n.length,r=t._propertyBindings,a=t._interpolants,o=i.uuid,h=this._bindingsByRootAndName;let l=h[o];void 0===l&&(l={},h[o]=l);for(let t=0;t!==s;++t){const s=n[t],h=s.name;let c=l[h];if(void 0!==c)++c.referenceCount,r[t]=c;else{if(c=r[t],void 0!==c){null===c._cacheIndex&&(++c.referenceCount,this._addInactiveBinding(c,o,h));continue}const n=e&&e._propertyBindings[t].binding.parsedPath;c=new Jc(iu.create(i,h,n),s.ValueTypeName,s.getValueSize()),++c.referenceCount,this._addInactiveBinding(c,o,h),r[t]=c}a[t].resultBuffer=c.buffer}}_activateAction(t){if(!this._isActiveAction(t)){if(null===t._cacheIndex){const e=(t._localRoot||this._root).uuid,i=t._clip.uuid,n=this._actionsByClip[i];this._bindAction(t,n&&n.knownActions[0]),this._addInactiveAction(t,i,e)}const e=t._propertyBindings;for(let t=0,i=e.length;t!==i;++t){const i=e[t];0==i.useCount++&&(this._lendBinding(i),i.saveOriginalState())}this._lendAction(t)}}_deactivateAction(t){if(this._isActiveAction(t)){const e=t._propertyBindings;for(let t=0,i=e.length;t!==i;++t){const i=e[t];0==--i.useCount&&(i.restoreOriginalState(),this._takeBackBinding(i))}this._takeBackAction(t)}}_initMemoryManager(){this._actions=[],this._nActiveActions=0,this._actionsByClip={},this._bindings=[],this._nActiveBindings=0,this._bindingsByRootAndName={},this._controlInterpolants=[],this._nActiveControlInterpolants=0;const t=this;this.stats={actions:{get total(){return t._actions.length},get inUse(){return t._nActiveActions}},bindings:{get total(){return t._bindings.length},get inUse(){return t._nActiveBindings}},controlInterpolants:{get total(){return t._controlInterpolants.length},get inUse(){return t._nActiveControlInterpolants}}}}_isActiveAction(t){const e=t._cacheIndex;return null!==e&&e<this._nActiveActions}_addInactiveAction(t,e,i){const n=this._actions,s=this._actionsByClip;let r=s[e];if(void 0===r)r={knownActions:[t],actionByRoot:{}},t._byClipCacheIndex=0,s[e]=r;else{const e=r.knownActions;t._byClipCacheIndex=e.length,e.push(t)}t._cacheIndex=n.length,n.push(t),r.actionByRoot[i]=t}_removeInactiveAction(t){const e=this._actions,i=e[e.length-1],n=t._cacheIndex;i._cacheIndex=n,e[n]=i,e.pop(),t._cacheIndex=null;const s=t._clip.uuid,r=this._actionsByClip,a=r[s],o=a.knownActions,h=o[o.length-1],l=t._byClipCacheIndex;h._byClipCacheIndex=l,o[l]=h,o.pop(),t._byClipCacheIndex=null;delete a.actionByRoot[(t._localRoot||this._root).uuid],0===o.length&&delete r[s],this._removeInactiveBindingsForAction(t)}_removeInactiveBindingsForAction(t){const e=t._propertyBindings;for(let t=0,i=e.length;t!==i;++t){const i=e[t];0==--i.referenceCount&&this._removeInactiveBinding(i)}}_lendAction(t){const e=this._actions,i=t._cacheIndex,n=this._nActiveActions++,s=e[n];t._cacheIndex=n,e[n]=t,s._cacheIndex=i,e[i]=s}_takeBackAction(t){const e=this._actions,i=t._cacheIndex,n=--this._nActiveActions,s=e[n];t._cacheIndex=n,e[n]=t,s._cacheIndex=i,e[i]=s}_addInactiveBinding(t,e,i){const n=this._bindingsByRootAndName,s=this._bindings;let r=n[e];void 0===r&&(r={},n[e]=r),r[i]=t,t._cacheIndex=s.length,s.push(t)}_removeInactiveBinding(t){const e=this._bindings,i=t.binding,n=i.rootNode.uuid,s=i.path,r=this._bindingsByRootAndName,a=r[n],o=e[e.length-1],h=t._cacheIndex;o._cacheIndex=h,e[h]=o,e.pop(),delete a[s],0===Object.keys(a).length&&delete r[n]}_lendBinding(t){const e=this._bindings,i=t._cacheIndex,n=this._nActiveBindings++,s=e[n];t._cacheIndex=n,e[n]=t,s._cacheIndex=i,e[i]=s}_takeBackBinding(t){const e=this._bindings,i=t._cacheIndex,n=--this._nActiveBindings,s=e[n];t._cacheIndex=n,e[n]=t,s._cacheIndex=i,e[i]=s}_lendControlInterpolant(){const t=this._controlInterpolants,e=this._nActiveControlInterpolants++;let i=t[e];return void 0===i&&(i=new Zl(new Float32Array(2),new Float32Array(2),1,su),i.__cacheIndex=e,t[e]=i),i}_takeBackControlInterpolant(t){const e=this._controlInterpolants,i=t.__cacheIndex,n=--this._nActiveControlInterpolants,s=e[n];t.__cacheIndex=n,e[n]=t,s.__cacheIndex=i,e[i]=s}clipAction(t,e,i){const n=e||this._root,s=n.uuid;let r="string"==typeof t?hc.findByName(n,t):t;const a=null!==r?r.uuid:t,o=this._actionsByClip[a];let h=null;if(void 0===i&&(i=null!==r?r.blendMode:Tt),void 0!==o){const t=o.actionByRoot[s];if(void 0!==t&&t.blendMode===i)return t;h=o.knownActions[0],null===r&&(r=h._clip)}if(null===r)return null;const l=new nu(this,r,e,i);return this._bindAction(l,h),this._addInactiveAction(l,a,s),l}existingAction(t,e){const i=e||this._root,n=i.uuid,s="string"==typeof t?hc.findByName(i,t):t,r=s?s.uuid:t,a=this._actionsByClip[r];return void 0!==a&&a.actionByRoot[n]||null}stopAllAction(){const t=this._actions;for(let e=this._nActiveActions-1;e>=0;--e)t[e].stop();return this}update(t){t*=this.timeScale;const e=this._actions,i=this._nActiveActions,n=this.time+=t,s=Math.sign(t),r=this._accuIndex^=1;for(let a=0;a!==i;++a){e[a]._update(n,t,s,r)}const a=this._bindings,o=this._nActiveBindings;for(let t=0;t!==o;++t)a[t].apply(r);return this}setTime(t){this.time=0;for(let t=0;t<this._actions.length;t++)this._actions[t].time=0;return this.update(t)}getRoot(){return this._root}uncacheClip(t){const e=this._actions,i=t.uuid,n=this._actionsByClip,s=n[i];if(void 0!==s){const t=s.knownActions;for(let i=0,n=t.length;i!==n;++i){const n=t[i];this._deactivateAction(n);const s=n._cacheIndex,r=e[e.length-1];n._cacheIndex=null,n._byClipCacheIndex=null,r._cacheIndex=s,e[s]=r,e.pop(),this._removeInactiveBindingsForAction(n)}delete n[i]}}uncacheRoot(t){const e=t.uuid,i=this._actionsByClip;for(const t in i){const n=i[t].actionByRoot[e];void 0!==n&&(this._deactivateAction(n),this._removeInactiveAction(n))}const n=this._bindingsByRootAndName[e];if(void 0!==n)for(const t in n){const e=n[t];e.restoreOriginalState(),this._removeInactiveBinding(e)}}uncacheAction(t,e){const i=this.existingAction(t,e);null!==i&&(this._deactivateAction(i),this._removeInactiveAction(i))}}class au{constructor(t){this.value=t}clone(){return new au(void 0===this.value.clone?this.value:this.value.clone())}}class ou{constructor(t,e,i=0,n=1/0){this.ray=new li(t,e),this.near=i,this.far=n,this.camera=null,this.layers=new _i,this.params={Mesh:{},Line:{threshold:1},LOD:{},Points:{threshold:1},Sprite:{}}}set(t,e){this.ray.set(t,e)}setFromCamera(t,e){e.isPerspectiveCamera?(this.ray.origin.setFromMatrixPosition(e.matrixWorld),this.ray.direction.set(t.x,t.y,.5).unproject(e).sub(this.ray.origin).normalize(),this.camera=e):e.isOrthographicCamera&&(this.ray.origin.set(t.x,t.y,(e.near+e.far)/(e.near-e.far)).unproject(e),this.ray.direction.set(0,0,-1).transformDirection(e.matrixWorld),this.camera=e)}intersectObject(t,e=!0,i=[]){return lu(t,this,i,e),i.sort(hu),i}intersectObjects(t,e=!0,i=[]){for(let n=0,s=t.length;n<s;n++)lu(t[n],this,i,e);return i.sort(hu),i}}function hu(t,e){return t.distance-e.distance}function lu(t,e,i,n){if(t.layers.test(e.layers)&&t.raycast(e,i),!0===n){const n=t.children;for(let t=0,s=n.length;t<s;t++)lu(n[t],e,i,!0)}}class cu{constructor(t=1,e=0,i=0){return this.radius=t,this.phi=e,this.theta=i,this}set(t,e,i){return this.radius=t,this.phi=e,this.theta=i,this}copy(t){return this.radius=t.radius,this.phi=t.phi,this.theta=t.theta,this}makeSafe(){const t=1e-6;return this.phi=Math.max(t,Math.min(Math.PI-t,this.phi)),this}setFromVector3(t){return this.setFromCartesianCoords(t.x,t.y,t.z)}setFromCartesianCoords(t,e,i){return this.radius=Math.sqrt(t*t+e*e+i*i),0===this.radius?(this.theta=0,this.phi=0):(this.theta=Math.atan2(t,i),this.phi=Math.acos($t(e/this.radius,-1,1))),this}clone(){return(new this.constructor).copy(this)}}const uu=new Le,du=new Le;class pu{constructor(t=new Le,e=new Le){this.start=t,this.end=e}set(t,e){return this.start.copy(t),this.end.copy(e),this}copy(t){return this.start.copy(t.start),this.end.copy(t.end),this}getCenter(t){return t.addVectors(this.start,this.end).multiplyScalar(.5)}delta(t){return t.subVectors(this.end,this.start)}distanceSq(){return this.start.distanceToSquared(this.end)}distance(){return this.start.distanceTo(this.end)}at(t,e){return this.delta(e).multiplyScalar(t).add(this.start)}closestPointToPointParameter(t,e){uu.subVectors(t,this.start),du.subVectors(this.end,this.start);const i=du.dot(du);let n=du.dot(uu)/i;return e&&(n=$t(n,0,1)),n}closestPointToPoint(t,e,i){const n=this.closestPointToPointParameter(t,e);return this.delta(i).multiplyScalar(n).add(this.start)}applyMatrix4(t){return this.start.applyMatrix4(t),this.end.applyMatrix4(t),this}equals(t){return t.start.equals(this.start)&&t.end.equals(this.end)}clone(){return(new this.constructor).copy(this)}}class mu extends hh{constructor(t=10,e=10,i=4473924,n=8947848){i=new Zi(i),n=new Zi(n);const s=e/2,r=t/e,a=t/2,o=[],h=[];for(let t=0,l=0,c=-a;t<=e;t++,c+=r){o.push(-a,0,c,a,0,c),o.push(c,0,-a,c,0,a);const e=t===s?i:n;e.toArray(h,l),l+=3,e.toArray(h,l),l+=3,e.toArray(h,l),l+=3,e.toArray(h,l),l+=3}const l=new vn;l.setAttribute("position",new ln(o,3)),l.setAttribute("color",new ln(h,3));super(l,new Qo({vertexColors:!0,toneMapped:!1})),this.type="GridHelper"}dispose(){this.geometry.dispose(),this.material.dispose()}}const fu=new Le,gu=new Le,vu=new Le;class yu extends Oi{constructor(t,e,i){super(),this.light=t,this.matrix=t.matrixWorld,this.matrixAutoUpdate=!1,this.color=i,this.type="DirectionalLightHelper",void 0===e&&(e=1);let n=new vn;n.setAttribute("position",new ln([-e,e,0,e,e,0,e,-e,0,-e,-e,0,-e,e,0],3));const s=new Qo({fog:!1,toneMapped:!1});this.lightPlane=new rh(n,s),this.add(this.lightPlane),n=new vn,n.setAttribute("position",new ln([0,0,0,0,0,1],3)),this.targetLine=new rh(n,s),this.add(this.targetLine),this.update()}dispose(){this.lightPlane.geometry.dispose(),this.lightPlane.material.dispose(),this.targetLine.geometry.dispose(),this.targetLine.material.dispose()}update(){this.light.updateWorldMatrix(!0,!1),this.light.target.updateWorldMatrix(!0,!1),fu.setFromMatrixPosition(this.light.matrixWorld),gu.setFromMatrixPosition(this.light.target.matrixWorld),vu.subVectors(gu,fu),this.lightPlane.lookAt(gu),void 0!==this.color?(this.lightPlane.material.color.set(this.color),this.targetLine.material.color.set(this.color)):(this.lightPlane.material.color.copy(this.light.color),this.targetLine.material.color.copy(this.light.color)),this.targetLine.lookAt(gu),this.targetLine.scale.z=vu.length()}}const xu=new Be;class bu extends hh{constructor(t,e=16776960){const i=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),n=new Float32Array(24),s=new vn;s.setIndex(new an(i,1)),s.setAttribute("position",new an(n,3)),super(s,new Qo({color:e,toneMapped:!1})),this.object=t,this.type="BoxHelper",this.matrixAutoUpdate=!1,this.update()}update(t){if(void 0!==this.object&&xu.setFromObject(this.object),xu.isEmpty())return;const e=xu.min,i=xu.max,n=this.geometry.attributes.position,s=n.array;s[0]=i.x,s[1]=i.y,s[2]=i.z,s[3]=e.x,s[4]=i.y,s[5]=i.z,s[6]=e.x,s[7]=e.y,s[8]=i.z,s[9]=i.x,s[10]=e.y,s[11]=i.z,s[12]=i.x,s[13]=i.y,s[14]=e.z,s[15]=e.x,s[16]=i.y,s[17]=e.z,s[18]=e.x,s[19]=e.y,s[20]=e.z,s[21]=i.x,s[22]=e.y,s[23]=e.z,n.needsUpdate=!0,this.geometry.computeBoundingSphere()}setFromObject(t){return this.object=t,this.update(),this}copy(t,e){return super.copy(t,e),this.object=t.object,this}dispose(){this.geometry.dispose(),this.material.dispose()}}const _u=new Le;let wu,Mu;class Su extends Oi{constructor(t=new Le(0,0,1),e=new Le(0,0,0),i=1,n=16776960,s=.2*i,r=.2*s){super(),this.type="ArrowHelper",void 0===wu&&(wu=new vn,wu.setAttribute("position",new ln([0,0,0,0,1,0],3)),Mu=new Uh(0,.5,1,5,1),Mu.translate(0,-.5,0)),this.position.copy(e),this.line=new rh(wu,new Qo({color:n,toneMapped:!1})),this.line.matrixAutoUpdate=!1,this.add(this.line),this.cone=new On(Mu,new nn({color:n,toneMapped:!1})),this.cone.matrixAutoUpdate=!1,this.add(this.cone),this.setDirection(t),this.setLength(i,s,r)}setDirection(t){if(t.y>.99999)this.quaternion.set(0,0,0,1);else if(t.y<-.99999)this.quaternion.set(1,0,0,0);else{_u.set(t.z,0,-t.x).normalize();const e=Math.acos(t.y);this.quaternion.setFromAxisAngle(_u,e)}}setLength(t,e=.2*t,i=.2*e){this.line.scale.set(1,Math.max(1e-4,t-e),1),this.line.updateMatrix(),this.cone.scale.set(i,e,i),this.cone.position.y=t,this.cone.updateMatrix()}setColor(t){this.line.material.color.set(t),this.cone.material.color.set(t)}copy(t){return super.copy(t,!1),this.line.copy(t.line),this.cone.copy(t.cone),this}dispose(){this.line.geometry.dispose(),this.line.material.dispose(),this.cone.geometry.dispose(),this.cone.material.dispose()}}class Eu extends hh{constructor(t=1){const e=[0,0,0,t,0,0,0,0,0,0,t,0,0,0,0,0,0,t],i=new vn;i.setAttribute("position",new ln(e,3)),i.setAttribute("color",new ln([1,0,0,1,.6,0,0,1,0,.6,1,0,0,0,1,0,.6,1],3));super(i,new Qo({vertexColors:!0,toneMapped:!1})),this.type="AxesHelper"}setColors(t,e,i){const n=new Zi,s=this.geometry.attributes.color.array;return n.set(t),n.toArray(s,0),n.toArray(s,3),n.set(e),n.toArray(s,6),n.toArray(s,9),n.set(i),n.toArray(s,12),n.toArray(s,15),this.geometry.attributes.color.needsUpdate=!0,this}dispose(){this.geometry.dispose(),this.material.dispose()}}"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("register",{detail:{revision:y}})),"undefined"!=typeof window&&(window.__THREE__||(window.__THREE__=y));var Tu,Au,Cu,Iu,Ru=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};!function(t){t[t.Body=0]="Body",t[t.Hands_L=1]="Hands_L",t[t.Hands_R=2]="Hands_R",t[t.Head=3]="Head",t[t.Legs=4]="Legs",t[t.Feet=5]="Feet"}(Tu||(Tu={})),function(t){t[t.Idle=0]="Idle",t[t.Walk=1]="Walk",t[t.Run=2]="Run",t[t.Jump=3]="Jump",t[t.Punch=4]="Punch",t[t.FightIdle=5]="FightIdle",t[t.Dying=6]="Dying",t[t.Shooting=7]="Shooting",t[t.Sword=8]="Sword",t[t.MagicH1=9]="MagicH1",t[t.MagicH2=10]="MagicH2",t[t.Dance0=11]="Dance0",t[t.Wartering=12]="Wartering",t[t.Hammering=13]="Hammering",t[t.PickFruit=14]="PickFruit",t[t.PickFruitTree=15]="PickFruitTree",t[t.PlantAPlant=16]="PlantAPlant",t[t.MonBiting=17]="MonBiting",t[t.MonScream=18]="MonScream",t[t.MonHurt=19]="MonHurt"}(Au||(Au={})),function(t){t[t.Male=0]="Male",t[t.Female=1]="Female",t[t.TwoB=2]="TwoB",t[t.Wizard=3]="Wizard",t[t.CuteGirl=4]="CuteGirl",t[t.OfficeGirl=5]="OfficeGirl",t[t.Hellboy=6]="Hellboy",t[t.Arrow=7]="Arrow",t[t.Tree=8]="Tree",t[t.DeadTree=9]="DeadTree",t[t.DeadTree2=10]="DeadTree2",t[t.Mushroom1=11]="Mushroom1",t[t.Mushroom2=12]="Mushroom2",t[t.Portal=13]="Portal",t[t.Test=14]="Test",t[t.Zombie=15]="Zombie",t[t.Minataur=16]="Minataur",t[t.BatPig=17]="BatPig",t[t.BilbyMon=18]="BilbyMon",t[t.BirdMon=19]="BirdMon",t[t.CrabMon=20]="CrabMon",t[t.Gorillish=21]="Gorillish",t[t.PantherBlackWhite=22]="PantherBlackWhite",t[t.PantherBlue=23]="PantherBlue",t[t.PantherRed=24]="PantherRed",t[t.AnimalPack=25]="AnimalPack",t[t.WereWolf=26]="WereWolf",t[t.Golem=27]="Golem",t[t.BigGolem=28]="BigGolem",t[t.Snake=29]="Snake",t[t.Viking=30]="Viking",t[t.Builder=31]="Builder",t[t.ToadMage=32]="ToadMage",t[t.KittenMonk=33]="KittenMonk",t[t.Skeleton=34]="Skeleton",t[t.Bilby=35]="Bilby",t[t.Dog=36]="Dog",t[t.Bee=37]="Bee",t[t.PetSnake=38]="PetSnake",t[t.Bat=39]="Bat",t[t.Gun=40]="Gun",t[t.WarteringCan=41]="WarteringCan",t[t.Hammer=42]="Hammer",t[t.Grass=43]="Grass",t[t.AppleTree=44]="AppleTree",t[t.Apple=45]="Apple",t[t.CoconutTree=46]="CoconutTree",t[t.Coconut=47]="Coconut",t[t.Tomato0=48]="Tomato0",t[t.Tomato1=49]="Tomato1",t[t.Tomato2=50]="Tomato2",t[t.Potato0=51]="Potato0",t[t.Potato1=52]="Potato1",t[t.Potato2=53]="Potato2",t[t.Carrot0=54]="Carrot0",t[t.Carrot1=55]="Carrot1",t[t.Carrot2=56]="Carrot2",t[t.Bed=57]="Bed",t[t.Bath=58]="Bath",t[t.Bookshelf=59]="Bookshelf",t[t.Closet=60]="Closet",t[t.Desk=61]="Desk",t[t.Kitchen=62]="Kitchen",t[t.KitTable=63]="KitTable",t[t.Oven=64]="Oven",t[t.Refrigerator=65]="Refrigerator",t[t.Sink=66]="Sink",t[t.Table=67]="Table",t[t.Toilet=68]="Toilet",t[t.TV=69]="TV",t[t.Stone=70]="Stone",t[t.Empty=71]="Empty",t[t.None=72]="None"}(Cu||(Cu={})),function(t){t[t.Gltf=0]="Gltf",t[t.GltfParser=1]="GltfParser",t[t.Fbx=2]="Fbx"}(Iu||(Iu={}));class ku{get Clips(){return this.clips}get Mixer(){return this.mixer}get BoxMesh(){return this.box}get Info(){return this.info}constructor(t,e,i,n){this.loader=t,this.loaderType=e,this.path=i,this.afterLoad=n,this.clips=new Map,this.models=new Map,this.mixers=new Map,this.boxMat=new nn({color:16777215,wireframe:!0})}GetAnimationClip(t){return this.clips.get(t)}UniqModel(t){return Ru(this,void 0,void 0,(function*(){const e=this.models.get(t);if(null!=e)return[e,!0];const i=yield this.NewModel();return this.models.set(t,i),[i,!1]}))}LoadAnimation(t,e){return Ru(this,void 0,void 0,(function*(){const i=yield this.loader.FBXLoader.loadAsync(t);this.clips.set(e,i.animations[0])}))}GetMixer(t){const e=this.mixers.get(t);if(null!=e)return e;const i=this.models.get(t);if(null==i)return;const n=new ru(i);return this.mixers.set(t,n),n}NewModel(){return Ru(this,void 0,void 0,(function*(){return this.loaderType==Iu.Gltf?yield new Promise((t=>Ru(this,void 0,void 0,(function*(){yield this.loader.Load.load(this.path,(e=>Ru(this,void 0,void 0,(function*(){this.meshs=e.scene,yield this.afterLoad(e),t(e.scene)}))))})))):this.loaderType==Iu.GltfParser?yield new Promise((t=>Ru(this,void 0,void 0,(function*(){yield this.afterLoad(t)})))):yield new Promise((t=>Ru(this,void 0,void 0,(function*(){yield this.loader.FBXLoader.load(this.path,(e=>Ru(this,void 0,void 0,(function*(){yield this.afterLoad(e),t(e)}))))}))))}))}CloneModel(){return Ru(this,void 0,void 0,(function*(){return null!=this.meshs?this.meshs.clone():yield this.NewModel()}))}GetBoxPos(t){const e=t.position,i=this.size?e.y+this.size.y/2:e.y;return new Le(e.x,i,e.z)}}class Pu{}Pu.projectile=Symbol("projectile"),Pu.PlayerStatus=Symbol("changeplayerstatus"),Pu.AppMode=Symbol("appmode"),Pu.BrickMode=Symbol("brickmode"),Pu.EditMode=Symbol("editmode"),Pu.PlayMode=Symbol("playmode"),Pu.WeaponMode=Symbol("weaponmode"),Pu.LocatMode=Symbol("locatmode"),Pu.FunitureMode=Symbol("funimode"),Pu.CloseMode=Symbol("closemode"),Pu.LongMode=Symbol("longmode"),Pu.PortalMode=Symbol("portalmode"),Pu.LegoMode=Symbol("legomode"),Pu.StartPosition=new Le(0,0,6),Pu.DefaultPortalPosition=new Le(21,0,17),Pu.LegoFieldW=18,Pu.LegoFieldH=24,Pu.ModelPath={[Cu.Male]:"assets/male/male.gltf",[Cu.Female]:"assets/female/female.gltf"};const Du=Pu;var Lu,Ou;!function(t){t[t.Start=0]="Start",t[t.Message=1]="Message",t[t.End=2]="End"}(Lu||(Lu={}));class Nu{constructor(){this.curMode=DP.Long,this.eventEmitter=new v}OnKeyDownEvent(t){this.eventEmitter.emit("keydown",t)}RegisterKeyDownEvent(t){this.eventEmitter.addListener("keydown",t)}OnKeyUpEvent(t){this.eventEmitter.emit("keyup",t)}RegisterKeyUpEvent(t){this.eventEmitter.on("keyup",t)}OnInputEvent(t,e,i){this.eventEmitter.emit("input",t,e,i)}RegisterInputEvent(t){this.eventEmitter.on("input",t)}OnChangeCtrlObjEvent(t){this.eventEmitter.emit("ctrlobj",t)}RegisterChangeCtrlObjEvent(t){this.eventEmitter.on("ctrlobj",t)}OnChangeEquipmentEvent(t){this.eventEmitter.emit("equip",t)}RegisterChangeEquipmentEvent(t){this.eventEmitter.on("equip",t)}OnChangeBrickInfo(t){this.eventEmitter.emit("bsize",t)}RegisterBrickInfo(t){this.eventEmitter.on("bsize",t)}OnChangeTerrainInfo(t){this.eventEmitter.emit("tsize",t)}RegisterTerrainInfo(t){this.eventEmitter.on("tsize",t)}OnAttackEvent(t,e){this.eventEmitter.emit(t,e)}RegisterAttackEvent(t,e){this.eventEmitter.on(t,e)}OnSceneClearEvent(){this.eventEmitter.emit("clear")}RegisterSceneClearEvent(t){this.eventEmitter.on("clear",t)}OnSceneReloadEvent(){this.eventEmitter.emit("reload")}RegisterReloadEvent(t){this.eventEmitter.on("reload",t)}OnAppModeEvent(t,...e){t!=this.curMode&&(this.eventEmitter.emit(Du.AppMode,this.curMode,Lu.End,...e),this.eventEmitter.emit(Du.AppMode,t,Lu.Start,...e),this.curMode=t)}OnAppModeMessage(...t){this.eventEmitter.emit(Du.AppMode,this.curMode,Lu.Message,t)}RegisterAppModeEvent(t){this.eventEmitter.on(Du.AppMode,t)}OnChangePlayerStatusEvent(t){this.eventEmitter.emit(Du.PlayerStatus,t)}RegisterChangePlayerStatusEvent(t){this.eventEmitter.on(Du.PlayerStatus,t)}OnProjectileEvent(t){this.eventEmitter.emit(Du.projectile,t)}RegisterProjectileEvent(t){this.eventEmitter.on(Du.projectile,t)}}!function(t){t[t.None=0]="None",t[t.Up=1]="Up",t[t.Down=2]="Down",t[t.Left=3]="Left",t[t.Right=4]="Right",t[t.Action0=5]="Action0",t[t.Action1=6]="Action1",t[t.Action2=7]="Action2",t[t.Action3=8]="Action3",t[t.Action4=9]="Action4",t[t.Action5=10]="Action5",t[t.System0=11]="System0",t[t.Count=12]="Count"}(Ou||(Ou={}));class Bu{get Type(){return Ou.None}ExecuteKeyUp(){return new Le(0,0,0)}ExecuteKeyDown(){return new Le(0,0,0)}}class zu{get Type(){return Ou.Action1}ExecuteKeyUp(){return new Le(0,0,0)}ExecuteKeyDown(){return new Le(0,0,0)}}class Uu{get Type(){return Ou.Action2}ExecuteKeyUp(){return new Le(0,0,0)}ExecuteKeyDown(){return new Le(0,0,0)}}class Fu{get Type(){return Ou.Action3}ExecuteKeyUp(){return new Le(0,0,0)}ExecuteKeyDown(){return new Le(0,0,0)}}class Gu{get Type(){return Ou.Action4}ExecuteKeyUp(){return new Le(0,0,0)}ExecuteKeyDown(){return new Le(0,0,0)}}class Vu{get Type(){return Ou.Action5}ExecuteKeyUp(){return new Le(0,0,0)}ExecuteKeyDown(){return new Le(0,0,0)}}class Hu{get Type(){return Ou.Action0}ExecuteKeyUp(){return new Le(0,7,0)}ExecuteKeyDown(){return new Le(0,7,0)}}class ju{get Type(){return Ou.Up}ExecuteKeyUp(){return new Le(0,0,-1)}ExecuteKeyDown(){return new Le(0,0,-1)}}class Wu{get Type(){return Ou.Down}ExecuteKeyUp(){return new Le(0,0,1)}ExecuteKeyDown(){return new Le(0,0,1)}}class Xu{get Type(){return Ou.Left}ExecuteKeyUp(){return new Le(-1,0,0)}ExecuteKeyDown(){return new Le(-1,0,0)}}class qu{get Type(){return Ou.Right}ExecuteKeyUp(){return new Le(1,0,0)}ExecuteKeyDown(){return new Le(1,0,0)}}class Yu{get Type(){return Ou.System0}ExecuteKeyUp(){return new Le}ExecuteKeyDown(){return new Le}}class Ju extends Va{constructor(t,...e){super();const i=new Lc(16777215,.3),n=new bc(16777215,3355443);n.position.set(0,20,10),this.objs=e,this.models=e.map((t=>t.Meshs));this.fog=new Fa(8900331,.0025),this.add(i,n,t,t.target,...this.models),this.meshs=this.models.filter((t=>t.isMesh))}play(){}dispose(){this.objs.forEach((t=>{const e=t.Meshs;e.isMesh&&(e.geometry.dispose(),e.material instanceof Array?e.material.map((t=>t.dispose())):e.material.dispose(),this.remove(e))}))}}class $u{get Velocity(){return this.velocity}set Velocity(t){this.velocity=t}get CenterPos(){return this.centerPos.copy(this.meshs.position).y+=this.Size.y/2,this.centerPos}get CannonPos(){return this.meshs.position}set CannonPos(t){this.meshs.position.copy(t)}set Quaternion(t){this.meshs.quaternion.copy(t)}get Size(){return this.asset.GetSize(this.meshs)}get Meshs(){return this.meshs}get Helper(){return null!=this.helper?this.helper:new bu(this.meshs,new Zi(0,255,0))}get UUID(){return this.meshs.uuid}get Visible(){return this.vFlag}set Visible(t){this.vFlag==t&&this.meshs.visible==t||(this.meshs.visible=t,this.meshs.traverse((e=>{e instanceof On&&(e.visible=t)})),null!=this.text&&(this.text.visible=t),this.vFlag=t)}get Asset(){return this.asset}get Box(){return this.asset.GetBox(this.meshs)}constructor(t){this.asset=t,this.meshs=new Da,this.vFlag=!0,this.velocity=0,this.centerPos=new Le}}class Ku extends On{constructor(){super(...arguments),this.velocity=0,this.centerPos=new Le}get Velocity(){return this.velocity}set Velocity(t){this.velocity=t}get Box(){return(new Be).setFromObject(this)}get CenterPos(){return this.centerPos.copy(this.position).y+=this.Size.y/2,this.centerPos}get CannonPos(){return this.position}set CannonPos(t){this.position.copy(t)}set Quaternion(t){this.quaternion.copy(t)}get Meshs(){return this}get UUID(){return this.uuid}get Size(){const t=(new Be).setFromObject(this);return this.size=t.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.y=Math.round(this.size.y),this.size.z=Math.ceil(this.size.z),this.size}set Visible(t){this.visible=t}}class Zu extends Ku{get BoxPos(){const t=this.CannonPos;return new Le(t.x,t.y,t.z)}constructor(t){super(new zh(t*=10,6),new Bl({color:16764006})),this.position.set(0,0,0),this.rotateX(-Math.PI/2),this.receiveShadow=!0}getRandomGreen(){if(Math.random()<.3)return new Zi(1,.8,.4);const t=.2*Math.random(),e=.1+.5*Math.random(),i=.2*Math.random();return new Zi(t,e,i)}}class Qu extends Ku{get BoxPos(){const t=this.CannonPos;return new Le(t.x,t.y,t.z)}constructor(){const t=new Vn({vertexShader:"\nvarying vec3 vWorldPosition;\n\nvoid main() {\n    vec4 worldPosition = modelMatrix * vec4(position, 1.0);\n    vWorldPosition = worldPosition.xyz;\n    gl_Position = projectionMatrix * viewMatrix * worldPosition;\n}\n",fragmentShader:"\nvarying vec3 vWorldPosition;\n\nvoid main() {\n    float height = normalize(vWorldPosition).y;\n    vec3 skyColor = mix(vec3(0.6, 0.8, 1.0), vec3(0.1, 0.4, 0.8), height * 0.5 + 0.5);\n    gl_FragColor = vec4(skyColor, 1.0);\n}\n",side:R});super(new Cl(500,32,32),t)}}class td{constructor(...t){this.clock=new qc,this.canvas=document.getElementById("avatar-bg"),this.width=window.innerWidth,this.height=window.innerHeight,this.objs=t}RegisterViewer(t){this.objs.push(t)}update(){const t=this.clock.getDelta();this.objs.forEach((e=>{e.update(t)}))}resize(){this.width=window.innerWidth,this.height=window.innerHeight,this.objs.forEach((t=>{var e;null===(e=t.resize)||void 0===e||e.call(t,this.width,this.height)}))}get Canvas(){return this.canvas}get Width(){return this.width}get Height(){return this.height}}function ed(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function id(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t.__proto__=e}var nd,sd,rd,ad,od,hd,ld,cd,ud,dd,pd,md={autoSleep:120,force3D:"auto",nullTargetWarn:1,units:{lineHeight:""}},fd={duration:.5,overwrite:!1,delay:0},gd=1e8,vd=1e-8,yd=2*Math.PI,xd=yd/4,bd=0,_d=Math.sqrt,wd=Math.cos,Md=Math.sin,Sd=function(t){return"string"==typeof t},Ed=function(t){return"function"==typeof t},Td=function(t){return"number"==typeof t},Ad=function(t){return void 0===t},Cd=function(t){return"object"==typeof t},Id=function(t){return!1!==t},Rd=function(){return"undefined"!=typeof window},kd=function(t){return Ed(t)||Sd(t)},Pd="function"==typeof ArrayBuffer&&ArrayBuffer.isView||function(){},Dd=Array.isArray,Ld=/(?:-?\.?\d|\.)+/gi,Od=/[-+=.]*\d+[.e\-+]*\d*[e\-+]*\d*/g,Nd=/[-+=.]*\d+[.e-]*\d*[a-z%]*/g,Bd=/[-+=.]*\d+\.?\d*(?:e-|e\+)?\d*/gi,zd=/[+-]=-?[.\d]+/,Ud=/[^,'"\[\]\s]+/gi,Fd=/^[+\-=e\s\d]*\d+[.\d]*([a-z]*|%)\s*$/i,Gd={},Vd={},Hd=function(t){return(Vd=vp(t,Gd))&&xf},jd=function(t,e){return!e&&void 0},Wd=function(t,e){return t&&(Gd[t]=e)&&Vd&&(Vd[t]=e)||Gd},Xd=function(){return 0},qd={suppressEvents:!0,isStart:!0,kill:!1},Yd={suppressEvents:!0,kill:!1},Jd={suppressEvents:!0},$d={},Kd=[],Zd={},Qd={},tp={},ep=30,ip=[],np="",sp=function(t){var e,i,n=t[0];if(Cd(n)||Ed(n)||(t=[t]),!(e=(n._gsap||{}).harness)){for(i=ip.length;i--&&!ip[i].targetTest(n););e=ip[i]}for(i=t.length;i--;)t[i]&&(t[i]._gsap||(t[i]._gsap=new Pm(t[i],e)))||t.splice(i,1);return t},rp=function(t){return t._gsap||sp(Jp(t))[0]._gsap},ap=function(t,e,i){return(i=t[e])&&Ed(i)?t[e]():Ad(i)&&t.getAttribute&&t.getAttribute(e)||i},op=function(t,e){return(t=t.split(",")).forEach(e)||t},hp=function(t){return Math.round(1e5*t)/1e5||0},lp=function(t){return Math.round(1e7*t)/1e7||0},cp=function(t,e){var i=e.charAt(0),n=parseFloat(e.substr(2));return t=parseFloat(t),"+"===i?t+n:"-"===i?t-n:"*"===i?t*n:t/n},up=function(t,e){for(var i=e.length,n=0;t.indexOf(e[n])<0&&++n<i;);return n<i},dp=function(){var t,e,i=Kd.length,n=Kd.slice(0);for(Zd={},Kd.length=0,t=0;t<i;t++)(e=n[t])&&e._lazy&&(e.render(e._lazy[0],e._lazy[1],!0)._lazy=0)},pp=function(t,e,i,n){Kd.length&&!sd&&dp(),t.render(e,i,n||sd&&e<0&&(t._initted||t._startAt)),Kd.length&&!sd&&dp()},mp=function(t){var e=parseFloat(t);return(e||0===e)&&(t+"").match(Ud).length<2?e:Sd(t)?t.trim():t},fp=function(t){return t},gp=function(t,e){for(var i in e)i in t||(t[i]=e[i]);return t},vp=function(t,e){for(var i in e)t[i]=e[i];return t},yp=function t(e,i){for(var n in i)"__proto__"!==n&&"constructor"!==n&&"prototype"!==n&&(e[n]=Cd(i[n])?t(e[n]||(e[n]={}),i[n]):i[n]);return e},xp=function(t,e){var i,n={};for(i in t)i in e||(n[i]=t[i]);return n},bp=function(t){var e,i=t.parent||ad,n=t.keyframes?(e=Dd(t.keyframes),function(t,i){for(var n in i)n in t||"duration"===n&&e||"ease"===n||(t[n]=i[n])}):gp;if(Id(t.inherit))for(;i;)n(t,i.vars.defaults),i=i.parent||i._dp;return t},_p=function(t,e,i,n,s){void 0===i&&(i="_first"),void 0===n&&(n="_last");var r,a=t[n];if(s)for(r=e[s];a&&a[s]>r;)a=a._prev;return a?(e._next=a._next,a._next=e):(e._next=t[i],t[i]=e),e._next?e._next._prev=e:t[n]=e,e._prev=a,e.parent=e._dp=t,e},wp=function(t,e,i,n){void 0===i&&(i="_first"),void 0===n&&(n="_last");var s=e._prev,r=e._next;s?s._next=r:t[i]===e&&(t[i]=r),r?r._prev=s:t[n]===e&&(t[n]=s),e._next=e._prev=e.parent=null},Mp=function(t,e){t.parent&&(!e||t.parent.autoRemoveChildren)&&t.parent.remove&&t.parent.remove(t),t._act=0},Sp=function(t,e){if(t&&(!e||e._end>t._dur||e._start<0))for(var i=t;i;)i._dirty=1,i=i.parent;return t},Ep=function(t,e,i,n){return t._startAt&&(sd?t._startAt.revert(Yd):t.vars.immediateRender&&!t.vars.autoRevert||t._startAt.render(e,!0,n))},Tp=function t(e){return!e||e._ts&&t(e.parent)},Ap=function(t){return t._repeat?Cp(t._tTime,t=t.duration()+t._rDelay)*t:0},Cp=function(t,e){var i=Math.floor(t/=e);return t&&i===t?i-1:i},Ip=function(t,e){return(t-e._start)*e._ts+(e._ts>=0?0:e._dirty?e.totalDuration():e._tDur)},Rp=function(t){return t._end=lp(t._start+(t._tDur/Math.abs(t._ts||t._rts||vd)||0))},kp=function(t,e){var i=t._dp;return i&&i.smoothChildTiming&&t._ts&&(t._start=lp(i._time-(t._ts>0?e/t._ts:((t._dirty?t.totalDuration():t._tDur)-e)/-t._ts)),Rp(t),i._dirty||Sp(i,t)),t},Pp=function(t,e){var i;if((e._time||!e._dur&&e._initted||e._start<t._time&&(e._dur||!e.add))&&(i=Ip(t.rawTime(),e),(!e._dur||jp(0,e.totalDuration(),i)-e._tTime>vd)&&e.render(i,!0)),Sp(t,e)._dp&&t._initted&&t._time>=t._dur&&t._ts){if(t._dur<t.duration())for(i=t;i._dp;)i.rawTime()>=0&&i.totalTime(i._tTime),i=i._dp;t._zTime=-1e-8}},Dp=function(t,e,i,n){return e.parent&&Mp(e),e._start=lp((Td(i)?i:i||t!==ad?Gp(t,i,e):t._time)+e._delay),e._end=lp(e._start+(e.totalDuration()/Math.abs(e.timeScale())||0)),_p(t,e,"_first","_last",t._sort?"_start":0),Bp(e)||(t._recent=e),n||Pp(t,e),t._ts<0&&kp(t,t._tTime),t},Lp=function(t,e){return Gd.ScrollTrigger?Gd.ScrollTrigger.create(e,t):void 0},Op=function(t,e,i,n,s){return Fm(t,e,s),t._initted?!i&&t._pt&&!sd&&(t._dur&&!1!==t.vars.lazy||!t._dur&&t.vars.lazy)&&ud!==xm.frame?(Kd.push(t),t._lazy=[s,n],1):void 0:1},Np=function t(e){var i=e.parent;return i&&i._ts&&i._initted&&!i._lock&&(i.rawTime()<0||t(i))},Bp=function(t){var e=t.data;return"isFromStart"===e||"isStart"===e},zp=function(t,e,i,n){var s=t._repeat,r=lp(e)||0,a=t._tTime/t._tDur;return a&&!n&&(t._time*=r/t._dur),t._dur=r,t._tDur=s?s<0?1e10:lp(r*(s+1)+t._rDelay*s):r,a>0&&!n&&kp(t,t._tTime=t._tDur*a),t.parent&&Rp(t),i||Sp(t.parent,t),t},Up=function(t){return t instanceof Lm?Sp(t):zp(t,t._dur)},Fp={_start:0,endTime:Xd,totalDuration:Xd},Gp=function t(e,i,n){var s,r,a,o=e.labels,h=e._recent||Fp,l=e.duration()>=gd?h.endTime(!1):e._dur;return Sd(i)&&(isNaN(i)||i in o)?(r=i.charAt(0),a="%"===i.substr(-1),s=i.indexOf("="),"<"===r||">"===r?(s>=0&&(i=i.replace(/=/,"")),("<"===r?h._start:h.endTime(h._repeat>=0))+(parseFloat(i.substr(1))||0)*(a?(s<0?h:n).totalDuration()/100:1)):s<0?(i in o||(o[i]=l),o[i]):(r=parseFloat(i.charAt(s-1)+i.substr(s+1)),a&&n&&(r=r/100*(Dd(n)?n[0]:n).totalDuration()),s>1?t(e,i.substr(0,s-1),n)+r:l+r)):null==i?l:+i},Vp=function(t,e,i){var n,s,r=Td(e[1]),a=(r?2:1)+(t<2?0:1),o=e[a];if(r&&(o.duration=e[1]),o.parent=i,t){for(n=o,s=i;s&&!("immediateRender"in n);)n=s.vars.defaults||{},s=Id(s.vars.inherit)&&s.parent;o.immediateRender=Id(n.immediateRender),t<2?o.runBackwards=1:o.startAt=e[a-1]}return new Wm(e[0],o,e[a+1])},Hp=function(t,e){return t||0===t?e(t):e},jp=function(t,e,i){return i<t?t:i>e?e:i},Wp=function(t,e){return Sd(t)&&(e=Fd.exec(t))?e[1]:""},Xp=[].slice,qp=function(t,e){return t&&Cd(t)&&"length"in t&&(!e&&!t.length||t.length-1 in t&&Cd(t[0]))&&!t.nodeType&&t!==od},Yp=function(t,e,i){return void 0===i&&(i=[]),t.forEach((function(t){var n;return Sd(t)&&!e||qp(t,1)?(n=i).push.apply(n,Jp(t)):i.push(t)}))||i},Jp=function(t,e,i){return rd&&!e&&rd.selector?rd.selector(t):!Sd(t)||i||!hd&&bm()?Dd(t)?Yp(t,i):qp(t)?Xp.call(t,0):t?[t]:[]:Xp.call((e||ld).querySelectorAll(t),0)},$p=function(t){return t=Jp(t)[0]||jd()||{},function(e){var i=t.current||t.nativeElement||t;return Jp(e,i.querySelectorAll?i:i===t?jd()||ld.createElement("div"):t)}},Kp=function(t){return t.sort((function(){return.5-Math.random()}))},Zp=function(t){if(Ed(t))return t;var e=Cd(t)?t:{each:t},i=Am(e.ease),n=e.from||0,s=parseFloat(e.base)||0,r={},a=n>0&&n<1,o=isNaN(n)||a,h=e.axis,l=n,c=n;return Sd(n)?l=c={center:.5,edges:.5,end:1}[n]||0:!a&&o&&(l=n[0],c=n[1]),function(t,a,u){var d,p,m,f,g,v,y,x,b,_=(u||e).length,w=r[_];if(!w){if(!(b="auto"===e.grid?0:(e.grid||[1,gd])[1])){for(y=-gd;y<(y=u[b++].getBoundingClientRect().left)&&b<_;);b<_&&b--}for(w=r[_]=[],d=o?Math.min(b,_)*l-.5:n%b,p=b===gd?0:o?_*c/b-.5:n/b|0,y=0,x=gd,v=0;v<_;v++)m=v%b-d,f=p-(v/b|0),w[v]=g=h?Math.abs("y"===h?f:m):_d(m*m+f*f),g>y&&(y=g),g<x&&(x=g);"random"===n&&Kp(w),w.max=y-x,w.min=x,w.v=_=(parseFloat(e.amount)||parseFloat(e.each)*(b>_?_-1:h?"y"===h?_/b:b:Math.max(b,_/b))||0)*("edges"===n?-1:1),w.b=_<0?s-_:s,w.u=Wp(e.amount||e.each)||0,i=i&&_<0?Em(i):i}return _=(w[t]-w.min)/w.max||0,lp(w.b+(i?i(_):_)*w.v)+w.u}},Qp=function(t){var e=Math.pow(10,((t+"").split(".")[1]||"").length);return function(i){var n=lp(Math.round(parseFloat(i)/t)*t*e);return(n-n%1)/e+(Td(i)?0:Wp(i))}},tm=function(t,e){var i,n,s=Dd(t);return!s&&Cd(t)&&(i=s=t.radius||gd,t.values?(t=Jp(t.values),(n=!Td(t[0]))&&(i*=i)):t=Qp(t.increment)),Hp(e,s?Ed(t)?function(e){return n=t(e),Math.abs(n-e)<=i?n:e}:function(e){for(var s,r,a=parseFloat(n?e.x:e),o=parseFloat(n?e.y:0),h=gd,l=0,c=t.length;c--;)(s=n?(s=t[c].x-a)*s+(r=t[c].y-o)*r:Math.abs(t[c]-a))<h&&(h=s,l=c);return l=!i||h<=i?t[l]:e,n||l===e||Td(e)?l:l+Wp(e)}:Qp(t))},em=function(t,e,i,n){return Hp(Dd(t)?!e:!0===i?!!(i=0):!n,(function(){return Dd(t)?t[~~(Math.random()*t.length)]:(i=i||1e-5)&&(n=i<1?Math.pow(10,(i+"").length-2):1)&&Math.floor(Math.round((t-i/2+Math.random()*(e-t+.99*i))/i)*i*n)/n}))},im=function(t,e,i){return Hp(i,(function(i){return t[~~e(i)]}))},nm=function(t){for(var e,i,n,s,r=0,a="";~(e=t.indexOf("random(",r));)n=t.indexOf(")",e),s="["===t.charAt(e+7),i=t.substr(e+7,n-e-7).match(s?Ud:Ld),a+=t.substr(r,e-r)+em(s?i:+i[0],s?0:+i[1],+i[2]||1e-5),r=n+1;return a+t.substr(r,t.length-r)},sm=function(t,e,i,n,s){var r=e-t,a=n-i;return Hp(s,(function(e){return i+((e-t)/r*a||0)}))},rm=function(t,e,i){var n,s,r,a=t.labels,o=gd;for(n in a)(s=a[n]-e)<0==!!i&&s&&o>(s=Math.abs(s))&&(r=n,o=s);return r},am=function(t,e,i){var n,s,r,a=t.vars,o=a[e],h=rd,l=t._ctx;if(o)return n=a[e+"Params"],s=a.callbackScope||t,i&&Kd.length&&dp(),l&&(rd=l),r=n?o.apply(s,n):o.call(s),rd=h,r},om=function(t){return Mp(t),t.scrollTrigger&&t.scrollTrigger.kill(!!sd),t.progress()<1&&am(t,"onInterrupt"),t},hm=[],lm=function(t){if(t)if(t=!t.name&&t.default||t,Rd()||t.headless){var e=t.name,i=Ed(t),n=e&&!i&&t.init?function(){this._props=[]}:t,s={init:Xd,render:tf,add:zm,kill:nf,modifier:ef,rawVars:0},r={targetTest:0,get:0,getSetter:$m,aliases:{},register:0};if(bm(),t!==n){if(Qd[e])return;gp(n,gp(xp(t,s),r)),vp(n.prototype,vp(s,xp(t,r))),Qd[n.prop=e]=n,t.targetTest&&(ip.push(n),$d[e]=1),e=("css"===e?"CSS":e.charAt(0).toUpperCase()+e.substr(1))+"Plugin"}Wd(e,n),t.register&&t.register(xf,n,af)}else hm.push(t)},cm=255,um={aqua:[0,cm,cm],lime:[0,cm,0],silver:[192,192,192],black:[0,0,0],maroon:[128,0,0],teal:[0,128,128],blue:[0,0,cm],navy:[0,0,128],white:[cm,cm,cm],olive:[128,128,0],yellow:[cm,cm,0],orange:[cm,165,0],gray:[128,128,128],purple:[128,0,128],green:[0,128,0],red:[cm,0,0],pink:[cm,192,203],cyan:[0,cm,cm],transparent:[cm,cm,cm,0]},dm=function(t,e,i){return(6*(t+=t<0?1:t>1?-1:0)<1?e+(i-e)*t*6:t<.5?i:3*t<2?e+(i-e)*(2/3-t)*6:e)*cm+.5|0},pm=function(t,e,i){var n,s,r,a,o,h,l,c,u,d,p=t?Td(t)?[t>>16,t>>8&cm,t&cm]:0:um.black;if(!p){if(","===t.substr(-1)&&(t=t.substr(0,t.length-1)),um[t])p=um[t];else if("#"===t.charAt(0)){if(t.length<6&&(n=t.charAt(1),s=t.charAt(2),r=t.charAt(3),t="#"+n+n+s+s+r+r+(5===t.length?t.charAt(4)+t.charAt(4):"")),9===t.length)return[(p=parseInt(t.substr(1,6),16))>>16,p>>8&cm,p&cm,parseInt(t.substr(7),16)/255];p=[(t=parseInt(t.substr(1),16))>>16,t>>8&cm,t&cm]}else if("hsl"===t.substr(0,3))if(p=d=t.match(Ld),e){if(~t.indexOf("="))return p=t.match(Od),i&&p.length<4&&(p[3]=1),p}else a=+p[0]%360/360,o=+p[1]/100,n=2*(h=+p[2]/100)-(s=h<=.5?h*(o+1):h+o-h*o),p.length>3&&(p[3]*=1),p[0]=dm(a+1/3,n,s),p[1]=dm(a,n,s),p[2]=dm(a-1/3,n,s);else p=t.match(Ld)||um.transparent;p=p.map(Number)}return e&&!d&&(n=p[0]/cm,s=p[1]/cm,r=p[2]/cm,h=((l=Math.max(n,s,r))+(c=Math.min(n,s,r)))/2,l===c?a=o=0:(u=l-c,o=h>.5?u/(2-l-c):u/(l+c),a=l===n?(s-r)/u+(s<r?6:0):l===s?(r-n)/u+2:(n-s)/u+4,a*=60),p[0]=~~(a+.5),p[1]=~~(100*o+.5),p[2]=~~(100*h+.5)),i&&p.length<4&&(p[3]=1),p},mm=function(t){var e=[],i=[],n=-1;return t.split(gm).forEach((function(t){var s=t.match(Nd)||[];e.push.apply(e,s),i.push(n+=s.length+1)})),e.c=i,e},fm=function(t,e,i){var n,s,r,a,o="",h=(t+o).match(gm),l=e?"hsla(":"rgba(",c=0;if(!h)return t;if(h=h.map((function(t){return(t=pm(t,e,1))&&l+(e?t[0]+","+t[1]+"%,"+t[2]+"%,"+t[3]:t.join(","))+")"})),i&&(r=mm(t),(n=i.c).join(o)!==r.c.join(o)))for(a=(s=t.replace(gm,"1").split(Nd)).length-1;c<a;c++)o+=s[c]+(~n.indexOf(c)?h.shift()||l+"0,0,0,0)":(r.length?r:h.length?h:i).shift());if(!s)for(a=(s=t.split(gm)).length-1;c<a;c++)o+=s[c]+h[c];return o+s[a]},gm=function(){var t,e="(?:\\b(?:(?:rgb|rgba|hsl|hsla)\\(.+?\\))|\\B#(?:[0-9a-f]{3,4}){1,2}\\b";for(t in um)e+="|"+t+"\\b";return new RegExp(e+")","gi")}(),vm=/hsl[a]?\(/,ym=function(t){var e,i=t.join(" ");if(gm.lastIndex=0,gm.test(i))return e=vm.test(i),t[1]=fm(t[1],e),t[0]=fm(t[0],e,mm(t[1])),!0},xm=function(){var t,e,i,n,s,r,a=Date.now,o=500,h=33,l=a(),c=l,u=1e3/240,d=u,p=[],m=function i(m){var f,g,v,y,x=a()-c,b=!0===m;if((x>o||x<0)&&(l+=x-h),((f=(v=(c+=x)-l)-d)>0||b)&&(y=++n.frame,s=v-1e3*n.time,n.time=v/=1e3,d+=f+(f>=u?4:u-f),g=1),b||(t=e(i)),g)for(r=0;r<p.length;r++)p[r](v,s,y,m)};return n={time:0,frame:0,tick:function(){m(!0)},deltaRatio:function(t){return s/(1e3/(t||60))},wake:function(){cd&&(!hd&&Rd()&&(od=hd=window,ld=od.document||{},Gd.gsap=xf,(od.gsapVersions||(od.gsapVersions=[])).push(xf.version),Hd(Vd||od.GreenSockGlobals||!od.gsap&&od||{}),hm.forEach(lm)),i="undefined"!=typeof requestAnimationFrame&&requestAnimationFrame,t&&n.sleep(),e=i||function(t){return setTimeout(t,d-1e3*n.time+1|0)},pd=1,m(2))},sleep:function(){(i?cancelAnimationFrame:clearTimeout)(t),pd=0,e=Xd},lagSmoothing:function(t,e){o=t||1/0,h=Math.min(e||33,o)},fps:function(t){u=1e3/(t||240),d=1e3*n.time+u},add:function(t,e,i){var s=e?function(e,i,r,a){t(e,i,r,a),n.remove(s)}:t;return n.remove(t),p[i?"unshift":"push"](s),bm(),s},remove:function(t,e){~(e=p.indexOf(t))&&p.splice(e,1)&&r>=e&&r--},_listeners:p}}(),bm=function(){return!pd&&xm.wake()},_m={},wm=/^[\d.\-M][\d.\-,\s]/,Mm=/["']/g,Sm=function(t){for(var e,i,n,s={},r=t.substr(1,t.length-3).split(":"),a=r[0],o=1,h=r.length;o<h;o++)i=r[o],e=o!==h-1?i.lastIndexOf(","):i.length,n=i.substr(0,e),s[a]=isNaN(n)?n.replace(Mm,"").trim():+n,a=i.substr(e+1).trim();return s},Em=function(t){return function(e){return 1-t(1-e)}},Tm=function t(e,i){for(var n,s=e._first;s;)s instanceof Lm?t(s,i):!s.vars.yoyoEase||s._yoyo&&s._repeat||s._yoyo===i||(s.timeline?t(s.timeline,i):(n=s._ease,s._ease=s._yEase,s._yEase=n,s._yoyo=i)),s=s._next},Am=function(t,e){return t&&(Ed(t)?t:_m[t]||function(t){var e,i,n,s,r=(t+"").split("("),a=_m[r[0]];return a&&r.length>1&&a.config?a.config.apply(null,~t.indexOf("{")?[Sm(r[1])]:(e=t,i=e.indexOf("(")+1,n=e.indexOf(")"),s=e.indexOf("(",i),e.substring(i,~s&&s<n?e.indexOf(")",n+1):n)).split(",").map(mp)):_m._CE&&wm.test(t)?_m._CE("",t):a}(t))||e},Cm=function(t,e,i,n){void 0===i&&(i=function(t){return 1-e(1-t)}),void 0===n&&(n=function(t){return t<.5?e(2*t)/2:1-e(2*(1-t))/2});var s,r={easeIn:e,easeOut:i,easeInOut:n};return op(t,(function(t){for(var e in _m[t]=Gd[t]=r,_m[s=t.toLowerCase()]=i,r)_m[s+("easeIn"===e?".in":"easeOut"===e?".out":".inOut")]=_m[t+"."+e]=r[e]})),r},Im=function(t){return function(e){return e<.5?(1-t(1-2*e))/2:.5+t(2*(e-.5))/2}},Rm=function t(e,i,n){var s=i>=1?i:1,r=(n||(e?.3:.45))/(i<1?i:1),a=r/yd*(Math.asin(1/s)||0),o=function(t){return 1===t?1:s*Math.pow(2,-10*t)*Md((t-a)*r)+1},h="out"===e?o:"in"===e?function(t){return 1-o(1-t)}:Im(o);return r=yd/r,h.config=function(i,n){return t(e,i,n)},h},km=function t(e,i){void 0===i&&(i=1.70158);var n=function(t){return t?--t*t*((i+1)*t+i)+1:0},s="out"===e?n:"in"===e?function(t){return 1-n(1-t)}:Im(n);return s.config=function(i){return t(e,i)},s};op("Linear,Quad,Cubic,Quart,Quint,Strong",(function(t,e){var i=e<5?e+1:e;Cm(t+",Power"+(i-1),e?function(t){return Math.pow(t,i)}:function(t){return t},(function(t){return 1-Math.pow(1-t,i)}),(function(t){return t<.5?Math.pow(2*t,i)/2:1-Math.pow(2*(1-t),i)/2}))})),_m.Linear.easeNone=_m.none=_m.Linear.easeIn,Cm("Elastic",Rm("in"),Rm("out"),Rm()),function(t,e){var i=1/e,n=function(n){return n<i?t*n*n:n<.7272727272727273?t*Math.pow(n-1.5/e,2)+.75:n<.9090909090909092?t*(n-=2.25/e)*n+.9375:t*Math.pow(n-2.625/e,2)+.984375};Cm("Bounce",(function(t){return 1-n(1-t)}),n)}(7.5625,2.75),Cm("Expo",(function(t){return t?Math.pow(2,10*(t-1)):0})),Cm("Circ",(function(t){return-(_d(1-t*t)-1)})),Cm("Sine",(function(t){return 1===t?1:1-wd(t*xd)})),Cm("Back",km("in"),km("out"),km()),_m.SteppedEase=_m.steps=Gd.SteppedEase={config:function(t,e){void 0===t&&(t=1);var i=1/t,n=t+(e?0:1),s=e?1:0;return function(t){return((n*jp(0,.99999999,t)|0)+s)*i}}},fd.ease=_m["quad.out"],op("onComplete,onUpdate,onStart,onRepeat,onReverseComplete,onInterrupt",(function(t){return np+=t+","+t+"Params,"}));var Pm=function(t,e){this.id=bd++,t._gsap=this,this.target=t,this.harness=e,this.get=e?e.get:ap,this.set=e?e.getSetter:$m},Dm=function(){function t(t){this.vars=t,this._delay=+t.delay||0,(this._repeat=t.repeat===1/0?-2:t.repeat||0)&&(this._rDelay=t.repeatDelay||0,this._yoyo=!!t.yoyo||!!t.yoyoEase),this._ts=1,zp(this,+t.duration,1,1),this.data=t.data,rd&&(this._ctx=rd,rd.data.push(this)),pd||xm.wake()}var e=t.prototype;return e.delay=function(t){return t||0===t?(this.parent&&this.parent.smoothChildTiming&&this.startTime(this._start+t-this._delay),this._delay=t,this):this._delay},e.duration=function(t){return arguments.length?this.totalDuration(this._repeat>0?t+(t+this._rDelay)*this._repeat:t):this.totalDuration()&&this._dur},e.totalDuration=function(t){return arguments.length?(this._dirty=0,zp(this,this._repeat<0?t:(t-this._repeat*this._rDelay)/(this._repeat+1))):this._tDur},e.totalTime=function(t,e){if(bm(),!arguments.length)return this._tTime;var i=this._dp;if(i&&i.smoothChildTiming&&this._ts){for(kp(this,t),!i._dp||i.parent||Pp(i,this);i&&i.parent;)i.parent._time!==i._start+(i._ts>=0?i._tTime/i._ts:(i.totalDuration()-i._tTime)/-i._ts)&&i.totalTime(i._tTime,!0),i=i.parent;!this.parent&&this._dp.autoRemoveChildren&&(this._ts>0&&t<this._tDur||this._ts<0&&t>0||!this._tDur&&!t)&&Dp(this._dp,this,this._start-this._delay)}return(this._tTime!==t||!this._dur&&!e||this._initted&&Math.abs(this._zTime)===vd||!t&&!this._initted&&(this.add||this._ptLookup))&&(this._ts||(this._pTime=t),pp(this,t,e)),this},e.time=function(t,e){return arguments.length?this.totalTime(Math.min(this.totalDuration(),t+Ap(this))%(this._dur+this._rDelay)||(t?this._dur:0),e):this._time},e.totalProgress=function(t,e){return arguments.length?this.totalTime(this.totalDuration()*t,e):this.totalDuration()?Math.min(1,this._tTime/this._tDur):this.rawTime()>0?1:0},e.progress=function(t,e){return arguments.length?this.totalTime(this.duration()*(!this._yoyo||1&this.iteration()?t:1-t)+Ap(this),e):this.duration()?Math.min(1,this._time/this._dur):this.rawTime()>0?1:0},e.iteration=function(t,e){var i=this.duration()+this._rDelay;return arguments.length?this.totalTime(this._time+(t-1)*i,e):this._repeat?Cp(this._tTime,i)+1:1},e.timeScale=function(t,e){if(!arguments.length)return-1e-8===this._rts?0:this._rts;if(this._rts===t)return this;var i=this.parent&&this._ts?Ip(this.parent._time,this):this._tTime;return this._rts=+t||0,this._ts=this._ps||-1e-8===t?0:this._rts,this.totalTime(jp(-Math.abs(this._delay),this._tDur,i),!1!==e),Rp(this),function(t){for(var e=t.parent;e&&e.parent;)e._dirty=1,e.totalDuration(),e=e.parent;return t}(this)},e.paused=function(t){return arguments.length?(this._ps!==t&&(this._ps=t,t?(this._pTime=this._tTime||Math.max(-this._delay,this.rawTime()),this._ts=this._act=0):(bm(),this._ts=this._rts,this.totalTime(this.parent&&!this.parent.smoothChildTiming?this.rawTime():this._tTime||this._pTime,1===this.progress()&&Math.abs(this._zTime)!==vd&&(this._tTime-=vd)))),this):this._ps},e.startTime=function(t){if(arguments.length){this._start=t;var e=this.parent||this._dp;return e&&(e._sort||!this.parent)&&Dp(e,this,t-this._delay),this}return this._start},e.endTime=function(t){return this._start+(Id(t)?this.totalDuration():this.duration())/Math.abs(this._ts||1)},e.rawTime=function(t){var e=this.parent||this._dp;return e?t&&(!this._ts||this._repeat&&this._time&&this.totalProgress()<1)?this._tTime%(this._dur+this._rDelay):this._ts?Ip(e.rawTime(t),this):this._tTime:this._tTime},e.revert=function(t){void 0===t&&(t=Jd);var e=sd;return sd=t,(this._initted||this._startAt)&&(this.timeline&&this.timeline.revert(t),this.totalTime(-.01,t.suppressEvents)),"nested"!==this.data&&!1!==t.kill&&this.kill(),sd=e,this},e.globalTime=function(t){for(var e=this,i=arguments.length?t:e.rawTime();e;)i=e._start+i/(Math.abs(e._ts)||1),e=e._dp;return!this.parent&&this._sat?this._sat.globalTime(t):i},e.repeat=function(t){return arguments.length?(this._repeat=t===1/0?-2:t,Up(this)):-2===this._repeat?1/0:this._repeat},e.repeatDelay=function(t){if(arguments.length){var e=this._time;return this._rDelay=t,Up(this),e?this.time(e):this}return this._rDelay},e.yoyo=function(t){return arguments.length?(this._yoyo=t,this):this._yoyo},e.seek=function(t,e){return this.totalTime(Gp(this,t),Id(e))},e.restart=function(t,e){return this.play().totalTime(t?-this._delay:0,Id(e))},e.play=function(t,e){return null!=t&&this.seek(t,e),this.reversed(!1).paused(!1)},e.reverse=function(t,e){return null!=t&&this.seek(t||this.totalDuration(),e),this.reversed(!0).paused(!1)},e.pause=function(t,e){return null!=t&&this.seek(t,e),this.paused(!0)},e.resume=function(){return this.paused(!1)},e.reversed=function(t){return arguments.length?(!!t!==this.reversed()&&this.timeScale(-this._rts||(t?-1e-8:0)),this):this._rts<0},e.invalidate=function(){return this._initted=this._act=0,this._zTime=-1e-8,this},e.isActive=function(){var t,e=this.parent||this._dp,i=this._start;return!(e&&!(this._ts&&this._initted&&e.isActive()&&(t=e.rawTime(!0))>=i&&t<this.endTime(!0)-vd))},e.eventCallback=function(t,e,i){var n=this.vars;return arguments.length>1?(e?(n[t]=e,i&&(n[t+"Params"]=i),"onUpdate"===t&&(this._onUpdate=e)):delete n[t],this):n[t]},e.then=function(t){var e=this;return new Promise((function(i){var n=Ed(t)?t:fp,s=function(){var t=e.then;e.then=null,Ed(n)&&(n=n(e))&&(n.then||n===e)&&(e.then=t),i(n),e.then=t};e._initted&&1===e.totalProgress()&&e._ts>=0||!e._tTime&&e._ts<0?s():e._prom=s}))},e.kill=function(){om(this)},t}();gp(Dm.prototype,{_time:0,_start:0,_end:0,_tTime:0,_tDur:0,_dirty:0,_repeat:0,_yoyo:!1,parent:null,_initted:!1,_rDelay:0,_ts:1,_dp:0,ratio:0,_zTime:-1e-8,_prom:0,_ps:!1,_rts:1});var Lm=function(t){function e(e,i){var n;return void 0===e&&(e={}),(n=t.call(this,e)||this).labels={},n.smoothChildTiming=!!e.smoothChildTiming,n.autoRemoveChildren=!!e.autoRemoveChildren,n._sort=Id(e.sortChildren),ad&&Dp(e.parent||ad,ed(n),i),e.reversed&&n.reverse(),e.paused&&n.paused(!0),e.scrollTrigger&&Lp(ed(n),e.scrollTrigger),n}id(e,t);var i=e.prototype;return i.to=function(t,e,i){return Vp(0,arguments,this),this},i.from=function(t,e,i){return Vp(1,arguments,this),this},i.fromTo=function(t,e,i,n){return Vp(2,arguments,this),this},i.set=function(t,e,i){return e.duration=0,e.parent=this,bp(e).repeatDelay||(e.repeat=0),e.immediateRender=!!e.immediateRender,new Wm(t,e,Gp(this,i),1),this},i.call=function(t,e,i){return Dp(this,Wm.delayedCall(0,t,e),i)},i.staggerTo=function(t,e,i,n,s,r,a){return i.duration=e,i.stagger=i.stagger||n,i.onComplete=r,i.onCompleteParams=a,i.parent=this,new Wm(t,i,Gp(this,s)),this},i.staggerFrom=function(t,e,i,n,s,r,a){return i.runBackwards=1,bp(i).immediateRender=Id(i.immediateRender),this.staggerTo(t,e,i,n,s,r,a)},i.staggerFromTo=function(t,e,i,n,s,r,a,o){return n.startAt=i,bp(n).immediateRender=Id(n.immediateRender),this.staggerTo(t,e,n,s,r,a,o)},i.render=function(t,e,i){var n,s,r,a,o,h,l,c,u,d,p,m,f=this._time,g=this._dirty?this.totalDuration():this._tDur,v=this._dur,y=t<=0?0:lp(t),x=this._zTime<0!=t<0&&(this._initted||!v);if(this!==ad&&y>g&&t>=0&&(y=g),y!==this._tTime||i||x){if(f!==this._time&&v&&(y+=this._time-f,t+=this._time-f),n=y,u=this._start,h=!(c=this._ts),x&&(v||(f=this._zTime),(t||!e)&&(this._zTime=t)),this._repeat){if(p=this._yoyo,o=v+this._rDelay,this._repeat<-1&&t<0)return this.totalTime(100*o+t,e,i);if(n=lp(y%o),y===g?(a=this._repeat,n=v):((a=~~(y/o))&&a===y/o&&(n=v,a--),n>v&&(n=v)),d=Cp(this._tTime,o),!f&&this._tTime&&d!==a&&this._tTime-d*o-this._dur<=0&&(d=a),p&&1&a&&(n=v-n,m=1),a!==d&&!this._lock){var b=p&&1&d,_=b===(p&&1&a);if(a<d&&(b=!b),f=b?0:y%v?v:y,this._lock=1,this.render(f||(m?0:lp(a*o)),e,!v)._lock=0,this._tTime=y,!e&&this.parent&&am(this,"onRepeat"),this.vars.repeatRefresh&&!m&&(this.invalidate()._lock=1),f&&f!==this._time||h!==!this._ts||this.vars.onRepeat&&!this.parent&&!this._act)return this;if(v=this._dur,g=this._tDur,_&&(this._lock=2,f=b?v:-1e-4,this.render(f,!0),this.vars.repeatRefresh&&!m&&this.invalidate()),this._lock=0,!this._ts&&!h)return this;Tm(this,m)}}if(this._hasPause&&!this._forcing&&this._lock<2&&(l=function(t,e,i){var n;if(i>e)for(n=t._first;n&&n._start<=i;){if("isPause"===n.data&&n._start>e)return n;n=n._next}else for(n=t._last;n&&n._start>=i;){if("isPause"===n.data&&n._start<e)return n;n=n._prev}}(this,lp(f),lp(n)),l&&(y-=n-(n=l._start))),this._tTime=y,this._time=n,this._act=!c,this._initted||(this._onUpdate=this.vars.onUpdate,this._initted=1,this._zTime=t,f=0),!f&&n&&!e&&!a&&(am(this,"onStart"),this._tTime!==y))return this;if(n>=f&&t>=0)for(s=this._first;s;){if(r=s._next,(s._act||n>=s._start)&&s._ts&&l!==s){if(s.parent!==this)return this.render(t,e,i);if(s.render(s._ts>0?(n-s._start)*s._ts:(s._dirty?s.totalDuration():s._tDur)+(n-s._start)*s._ts,e,i),n!==this._time||!this._ts&&!h){l=0,r&&(y+=this._zTime=-1e-8);break}}s=r}else{s=this._last;for(var w=t<0?t:n;s;){if(r=s._prev,(s._act||w<=s._end)&&s._ts&&l!==s){if(s.parent!==this)return this.render(t,e,i);if(s.render(s._ts>0?(w-s._start)*s._ts:(s._dirty?s.totalDuration():s._tDur)+(w-s._start)*s._ts,e,i||sd&&(s._initted||s._startAt)),n!==this._time||!this._ts&&!h){l=0,r&&(y+=this._zTime=w?-1e-8:vd);break}}s=r}}if(l&&!e&&(this.pause(),l.render(n>=f?0:-1e-8)._zTime=n>=f?1:-1,this._ts))return this._start=u,Rp(this),this.render(t,e,i);this._onUpdate&&!e&&am(this,"onUpdate",!0),(y===g&&this._tTime>=this.totalDuration()||!y&&f)&&(u!==this._start&&Math.abs(c)===Math.abs(this._ts)||this._lock||((t||!v)&&(y===g&&this._ts>0||!y&&this._ts<0)&&Mp(this,1),e||t<0&&!f||!y&&!f&&g||(am(this,y===g&&t>=0?"onComplete":"onReverseComplete",!0),this._prom&&!(y<g&&this.timeScale()>0)&&this._prom())))}return this},i.add=function(t,e){var i=this;if(Td(e)||(e=Gp(this,e,t)),!(t instanceof Dm)){if(Dd(t))return t.forEach((function(t){return i.add(t,e)})),this;if(Sd(t))return this.addLabel(t,e);if(!Ed(t))return this;t=Wm.delayedCall(0,t)}return this!==t?Dp(this,t,e):this},i.getChildren=function(t,e,i,n){void 0===t&&(t=!0),void 0===e&&(e=!0),void 0===i&&(i=!0),void 0===n&&(n=-gd);for(var s=[],r=this._first;r;)r._start>=n&&(r instanceof Wm?e&&s.push(r):(i&&s.push(r),t&&s.push.apply(s,r.getChildren(!0,e,i)))),r=r._next;return s},i.getById=function(t){for(var e=this.getChildren(1,1,1),i=e.length;i--;)if(e[i].vars.id===t)return e[i]},i.remove=function(t){return Sd(t)?this.removeLabel(t):Ed(t)?this.killTweensOf(t):(wp(this,t),t===this._recent&&(this._recent=this._last),Sp(this))},i.totalTime=function(e,i){return arguments.length?(this._forcing=1,!this._dp&&this._ts&&(this._start=lp(xm.time-(this._ts>0?e/this._ts:(this.totalDuration()-e)/-this._ts))),t.prototype.totalTime.call(this,e,i),this._forcing=0,this):this._tTime},i.addLabel=function(t,e){return this.labels[t]=Gp(this,e),this},i.removeLabel=function(t){return delete this.labels[t],this},i.addPause=function(t,e,i){var n=Wm.delayedCall(0,e||Xd,i);return n.data="isPause",this._hasPause=1,Dp(this,n,Gp(this,t))},i.removePause=function(t){var e=this._first;for(t=Gp(this,t);e;)e._start===t&&"isPause"===e.data&&Mp(e),e=e._next},i.killTweensOf=function(t,e,i){for(var n=this.getTweensOf(t,i),s=n.length;s--;)Om!==n[s]&&n[s].kill(t,e);return this},i.getTweensOf=function(t,e){for(var i,n=[],s=Jp(t),r=this._first,a=Td(e);r;)r instanceof Wm?up(r._targets,s)&&(a?(!Om||r._initted&&r._ts)&&r.globalTime(0)<=e&&r.globalTime(r.totalDuration())>e:!e||r.isActive())&&n.push(r):(i=r.getTweensOf(s,e)).length&&n.push.apply(n,i),r=r._next;return n},i.tweenTo=function(t,e){e=e||{};var i,n=this,s=Gp(n,t),r=e,a=r.startAt,o=r.onStart,h=r.onStartParams,l=r.immediateRender,c=Wm.to(n,gp({ease:e.ease||"none",lazy:!1,immediateRender:!1,time:s,overwrite:"auto",duration:e.duration||Math.abs((s-(a&&"time"in a?a.time:n._time))/n.timeScale())||vd,onStart:function(){if(n.pause(),!i){var t=e.duration||Math.abs((s-(a&&"time"in a?a.time:n._time))/n.timeScale());c._dur!==t&&zp(c,t,0,1).render(c._time,!0,!0),i=1}o&&o.apply(c,h||[])}},e));return l?c.render(0):c},i.tweenFromTo=function(t,e,i){return this.tweenTo(e,gp({startAt:{time:Gp(this,t)}},i))},i.recent=function(){return this._recent},i.nextLabel=function(t){return void 0===t&&(t=this._time),rm(this,Gp(this,t))},i.previousLabel=function(t){return void 0===t&&(t=this._time),rm(this,Gp(this,t),1)},i.currentLabel=function(t){return arguments.length?this.seek(t,!0):this.previousLabel(this._time+vd)},i.shiftChildren=function(t,e,i){void 0===i&&(i=0);for(var n,s=this._first,r=this.labels;s;)s._start>=i&&(s._start+=t,s._end+=t),s=s._next;if(e)for(n in r)r[n]>=i&&(r[n]+=t);return Sp(this)},i.invalidate=function(e){var i=this._first;for(this._lock=0;i;)i.invalidate(e),i=i._next;return t.prototype.invalidate.call(this,e)},i.clear=function(t){void 0===t&&(t=!0);for(var e,i=this._first;i;)e=i._next,this.remove(i),i=e;return this._dp&&(this._time=this._tTime=this._pTime=0),t&&(this.labels={}),Sp(this)},i.totalDuration=function(t){var e,i,n,s=0,r=this,a=r._last,o=gd;if(arguments.length)return r.timeScale((r._repeat<0?r.duration():r.totalDuration())/(r.reversed()?-t:t));if(r._dirty){for(n=r.parent;a;)e=a._prev,a._dirty&&a.totalDuration(),(i=a._start)>o&&r._sort&&a._ts&&!r._lock?(r._lock=1,Dp(r,a,i-a._delay,1)._lock=0):o=i,i<0&&a._ts&&(s-=i,(!n&&!r._dp||n&&n.smoothChildTiming)&&(r._start+=i/r._ts,r._time-=i,r._tTime-=i),r.shiftChildren(-i,!1,-Infinity),o=0),a._end>s&&a._ts&&(s=a._end),a=e;zp(r,r===ad&&r._time>s?r._time:s,1,1),r._dirty=0}return r._tDur},e.updateRoot=function(t){if(ad._ts&&(pp(ad,Ip(t,ad)),ud=xm.frame),xm.frame>=ep){ep+=md.autoSleep||120;var e=ad._first;if((!e||!e._ts)&&md.autoSleep&&xm._listeners.length<2){for(;e&&!e._ts;)e=e._next;e||xm.sleep()}}},e}(Dm);gp(Lm.prototype,{_lock:0,_hasPause:0,_forcing:0});var Om,Nm,Bm=function(t,e,i,n,s,r,a){var o,h,l,c,u,d,p,m,f=new af(this._pt,t,e,0,1,Qm,null,s),g=0,v=0;for(f.b=i,f.e=n,i+="",(p=~(n+="").indexOf("random("))&&(n=nm(n)),r&&(r(m=[i,n],t,e),i=m[0],n=m[1]),h=i.match(Bd)||[];o=Bd.exec(n);)c=o[0],u=n.substring(g,o.index),l?l=(l+1)%5:"rgba("===u.substr(-5)&&(l=1),c!==h[v++]&&(d=parseFloat(h[v-1])||0,f._pt={_next:f._pt,p:u||1===v?u:",",s:d,c:"="===c.charAt(1)?cp(d,c)-d:parseFloat(c)-d,m:l&&l<4?Math.round:0},g=Bd.lastIndex);return f.c=g<n.length?n.substring(g,n.length):"",f.fp=a,(zd.test(n)||p)&&(f.e=0),this._pt=f,f},zm=function(t,e,i,n,s,r,a,o,h,l){Ed(n)&&(n=n(s||0,t,r));var c,u=t[e],d="get"!==i?i:Ed(u)?h?t[e.indexOf("set")||!Ed(t["get"+e.substr(3)])?e:"get"+e.substr(3)](h):t[e]():u,p=Ed(u)?h?Ym:qm:Xm;if(Sd(n)&&(~n.indexOf("random(")&&(n=nm(n)),"="===n.charAt(1)&&((c=cp(d,n)+(Wp(d)||0))||0===c)&&(n=c)),!l||d!==n||Nm)return isNaN(d*n)||""===n?Bm.call(this,t,e,d,n,p,o||md.stringFilter,h):(c=new af(this._pt,t,e,+d||0,n-(d||0),"boolean"==typeof u?Zm:Km,0,p),h&&(c.fp=h),a&&c.modifier(a,this,t),this._pt=c)},Um=function(t,e,i,n,s,r){var a,o,h,l;if(Qd[t]&&!1!==(a=new Qd[t]).init(s,a.rawVars?e[t]:function(t,e,i,n,s){if(Ed(t)&&(t=Vm(t,s,e,i,n)),!Cd(t)||t.style&&t.nodeType||Dd(t)||Pd(t))return Sd(t)?Vm(t,s,e,i,n):t;var r,a={};for(r in t)a[r]=Vm(t[r],s,e,i,n);return a}(e[t],n,s,r,i),i,n,r)&&(i._pt=o=new af(i._pt,s,t,0,1,a.render,a,0,a.priority),i!==dd))for(h=i._ptLookup[i._targets.indexOf(s)],l=a._props.length;l--;)h[a._props[l]]=o;return a},Fm=function t(e,i,n){var s,r,a,o,h,l,c,u,d,p,m,f,g,v=e.vars,y=v.ease,x=v.startAt,b=v.immediateRender,_=v.lazy,w=v.onUpdate,M=v.runBackwards,S=v.yoyoEase,E=v.keyframes,T=v.autoRevert,A=e._dur,C=e._startAt,I=e._targets,R=e.parent,k=R&&"nested"===R.data?R.vars.targets:I,P="auto"===e._overwrite&&!nd,D=e.timeline;if(D&&(!E||!y)&&(y="none"),e._ease=Am(y,fd.ease),e._yEase=S?Em(Am(!0===S?y:S,fd.ease)):0,S&&e._yoyo&&!e._repeat&&(S=e._yEase,e._yEase=e._ease,e._ease=S),e._from=!D&&!!v.runBackwards,!D||E&&!v.stagger){if(f=(u=I[0]?rp(I[0]).harness:0)&&v[u.prop],s=xp(v,$d),C&&(C._zTime<0&&C.progress(1),i<0&&M&&b&&!T?C.render(-1,!0):C.revert(M&&A?Yd:qd),C._lazy=0),x){if(Mp(e._startAt=Wm.set(I,gp({data:"isStart",overwrite:!1,parent:R,immediateRender:!0,lazy:!C&&Id(_),startAt:null,delay:0,onUpdate:w&&function(){return am(e,"onUpdate")},stagger:0},x))),e._startAt._dp=0,e._startAt._sat=e,i<0&&(sd||!b&&!T)&&e._startAt.revert(Yd),b&&A&&i<=0&&n<=0)return void(i&&(e._zTime=i))}else if(M&&A&&!C)if(i&&(b=!1),a=gp({overwrite:!1,data:"isFromStart",lazy:b&&!C&&Id(_),immediateRender:b,stagger:0,parent:R},s),f&&(a[u.prop]=f),Mp(e._startAt=Wm.set(I,a)),e._startAt._dp=0,e._startAt._sat=e,i<0&&(sd?e._startAt.revert(Yd):e._startAt.render(-1,!0)),e._zTime=i,b){if(!i)return}else t(e._startAt,vd,vd);for(e._pt=e._ptCache=0,_=A&&Id(_)||_&&!A,r=0;r<I.length;r++){if(c=(h=I[r])._gsap||sp(I)[r]._gsap,e._ptLookup[r]=p={},Zd[c.id]&&Kd.length&&dp(),m=k===I?r:k.indexOf(h),u&&!1!==(d=new u).init(h,f||s,e,m,k)&&(e._pt=o=new af(e._pt,h,d.name,0,1,d.render,d,0,d.priority),d._props.forEach((function(t){p[t]=o})),d.priority&&(l=1)),!u||f)for(a in s)Qd[a]&&(d=Um(a,s,e,m,h,k))?d.priority&&(l=1):p[a]=o=zm.call(e,h,a,"get",s[a],m,k,0,v.stringFilter);e._op&&e._op[r]&&e.kill(h,e._op[r]),P&&e._pt&&(Om=e,ad.killTweensOf(h,p,e.globalTime(i)),g=!e.parent,Om=0),e._pt&&_&&(Zd[c.id]=1)}l&&rf(e),e._onInit&&e._onInit(e)}e._onUpdate=w,e._initted=(!e._op||e._pt)&&!g,E&&i<=0&&D.render(gd,!0,!0)},Gm=function(t,e,i,n){var s,r,a=e.ease||n||"power1.inOut";if(Dd(e))r=i[t]||(i[t]=[]),e.forEach((function(t,i){return r.push({t:i/(e.length-1)*100,v:t,e:a})}));else for(s in e)r=i[s]||(i[s]=[]),"ease"===s||r.push({t:parseFloat(t),v:e[s],e:a})},Vm=function(t,e,i,n,s){return Ed(t)?t.call(e,i,n,s):Sd(t)&&~t.indexOf("random(")?nm(t):t},Hm=np+"repeat,repeatDelay,yoyo,repeatRefresh,yoyoEase,autoRevert",jm={};op(Hm+",id,stagger,delay,duration,paused,scrollTrigger",(function(t){return jm[t]=1}));var Wm=function(t){function e(e,i,n,s){var r;"number"==typeof i&&(n.duration=i,i=n,n=null);var a,o,h,l,c,u,d,p,m=(r=t.call(this,s?i:bp(i))||this).vars,f=m.duration,g=m.delay,v=m.immediateRender,y=m.stagger,x=m.overwrite,b=m.keyframes,_=m.defaults,w=m.scrollTrigger,M=m.yoyoEase,S=i.parent||ad,E=(Dd(e)||Pd(e)?Td(e[0]):"length"in i)?[e]:Jp(e);if(r._targets=E.length?sp(E):jd(0,!md.nullTargetWarn)||[],r._ptLookup=[],r._overwrite=x,b||y||kd(f)||kd(g)){if(i=r.vars,(a=r.timeline=new Lm({data:"nested",defaults:_||{},targets:S&&"nested"===S.data?S.vars.targets:E})).kill(),a.parent=a._dp=ed(r),a._start=0,y||kd(f)||kd(g)){if(l=E.length,d=y&&Zp(y),Cd(y))for(c in y)~Hm.indexOf(c)&&(p||(p={}),p[c]=y[c]);for(o=0;o<l;o++)(h=xp(i,jm)).stagger=0,M&&(h.yoyoEase=M),p&&vp(h,p),u=E[o],h.duration=+Vm(f,ed(r),o,u,E),h.delay=(+Vm(g,ed(r),o,u,E)||0)-r._delay,!y&&1===l&&h.delay&&(r._delay=g=h.delay,r._start+=g,h.delay=0),a.to(u,h,d?d(o,u,E):0),a._ease=_m.none;a.duration()?f=g=0:r.timeline=0}else if(b){bp(gp(a.vars.defaults,{ease:"none"})),a._ease=Am(b.ease||i.ease||"none");var T,A,C,I=0;if(Dd(b))b.forEach((function(t){return a.to(E,t,">")})),a.duration();else{for(c in h={},b)"ease"===c||"easeEach"===c||Gm(c,b[c],h,b.easeEach);for(c in h)for(T=h[c].sort((function(t,e){return t.t-e.t})),I=0,o=0;o<T.length;o++)(C={ease:(A=T[o]).e,duration:(A.t-(o?T[o-1].t:0))/100*f})[c]=A.v,a.to(E,C,I),I+=C.duration;a.duration()<f&&a.to({},{duration:f-a.duration()})}}f||r.duration(f=a.duration())}else r.timeline=0;return!0!==x||nd||(Om=ed(r),ad.killTweensOf(E),Om=0),Dp(S,ed(r),n),i.reversed&&r.reverse(),i.paused&&r.paused(!0),(v||!f&&!b&&r._start===lp(S._time)&&Id(v)&&Tp(ed(r))&&"nested"!==S.data)&&(r._tTime=-1e-8,r.render(Math.max(0,-g)||0)),w&&Lp(ed(r),w),r}id(e,t);var i=e.prototype;return i.render=function(t,e,i){var n,s,r,a,o,h,l,c,u,d=this._time,p=this._tDur,m=this._dur,f=t<0,g=t>p-vd&&!f?p:t<vd?0:t;if(m){if(g!==this._tTime||!t||i||!this._initted&&this._tTime||this._startAt&&this._zTime<0!==f){if(n=g,c=this.timeline,this._repeat){if(a=m+this._rDelay,this._repeat<-1&&f)return this.totalTime(100*a+t,e,i);if(n=lp(g%a),g===p?(r=this._repeat,n=m):((r=~~(g/a))&&r===lp(g/a)&&(n=m,r--),n>m&&(n=m)),(h=this._yoyo&&1&r)&&(u=this._yEase,n=m-n),o=Cp(this._tTime,a),n===d&&!i&&this._initted&&r===o)return this._tTime=g,this;r!==o&&(c&&this._yEase&&Tm(c,h),this.vars.repeatRefresh&&!h&&!this._lock&&this._time!==a&&this._initted&&(this._lock=i=1,this.render(lp(a*r),!0).invalidate()._lock=0))}if(!this._initted){if(Op(this,f?t:n,i,e,g))return this._tTime=0,this;if(!(d===this._time||i&&this.vars.repeatRefresh&&r!==o))return this;if(m!==this._dur)return this.render(t,e,i)}if(this._tTime=g,this._time=n,!this._act&&this._ts&&(this._act=1,this._lazy=0),this.ratio=l=(u||this._ease)(n/m),this._from&&(this.ratio=l=1-l),n&&!d&&!e&&!r&&(am(this,"onStart"),this._tTime!==g))return this;for(s=this._pt;s;)s.r(l,s.d),s=s._next;c&&c.render(t<0?t:c._dur*c._ease(n/this._dur),e,i)||this._startAt&&(this._zTime=t),this._onUpdate&&!e&&(f&&Ep(this,t,0,i),am(this,"onUpdate")),this._repeat&&r!==o&&this.vars.onRepeat&&!e&&this.parent&&am(this,"onRepeat"),g!==this._tDur&&g||this._tTime!==g||(f&&!this._onUpdate&&Ep(this,t,0,!0),(t||!m)&&(g===this._tDur&&this._ts>0||!g&&this._ts<0)&&Mp(this,1),e||f&&!d||!(g||d||h)||(am(this,g===p?"onComplete":"onReverseComplete",!0),this._prom&&!(g<p&&this.timeScale()>0)&&this._prom()))}}else!function(t,e,i,n){var s,r,a,o=t.ratio,h=e<0||!e&&(!t._start&&Np(t)&&(t._initted||!Bp(t))||(t._ts<0||t._dp._ts<0)&&!Bp(t))?0:1,l=t._rDelay,c=0;if(l&&t._repeat&&(c=jp(0,t._tDur,e),r=Cp(c,l),t._yoyo&&1&r&&(h=1-h),r!==Cp(t._tTime,l)&&(o=1-h,t.vars.repeatRefresh&&t._initted&&t.invalidate())),h!==o||sd||n||t._zTime===vd||!e&&t._zTime){if(!t._initted&&Op(t,e,n,i,c))return;for(a=t._zTime,t._zTime=e||(i?vd:0),i||(i=e&&!a),t.ratio=h,t._from&&(h=1-h),t._time=0,t._tTime=c,s=t._pt;s;)s.r(h,s.d),s=s._next;e<0&&Ep(t,e,0,!0),t._onUpdate&&!i&&am(t,"onUpdate"),c&&t._repeat&&!i&&t.parent&&am(t,"onRepeat"),(e>=t._tDur||e<0)&&t.ratio===h&&(h&&Mp(t,1),i||sd||(am(t,h?"onComplete":"onReverseComplete",!0),t._prom&&t._prom()))}else t._zTime||(t._zTime=e)}(this,t,e,i);return this},i.targets=function(){return this._targets},i.invalidate=function(e){return(!e||!this.vars.runBackwards)&&(this._startAt=0),this._pt=this._op=this._onUpdate=this._lazy=this.ratio=0,this._ptLookup=[],this.timeline&&this.timeline.invalidate(e),t.prototype.invalidate.call(this,e)},i.resetTo=function(t,e,i,n,s){pd||xm.wake(),this._ts||this.play();var r=Math.min(this._dur,(this._dp._time-this._start)*this._ts);return this._initted||Fm(this,r),function(t,e,i,n,s,r,a,o){var h,l,c,u,d=(t._pt&&t._ptCache||(t._ptCache={}))[e];if(!d)for(d=t._ptCache[e]=[],c=t._ptLookup,u=t._targets.length;u--;){if((h=c[u][e])&&h.d&&h.d._pt)for(h=h.d._pt;h&&h.p!==e&&h.fp!==e;)h=h._next;if(!h)return Nm=1,t.vars[e]="+=0",Fm(t,a),Nm=0,o?jd():1;d.push(h)}for(u=d.length;u--;)(h=(l=d[u])._pt||l).s=!n&&0!==n||s?h.s+(n||0)+r*h.c:n,h.c=i-h.s,l.e&&(l.e=hp(i)+Wp(l.e)),l.b&&(l.b=h.s+Wp(l.b))}(this,t,e,i,n,this._ease(r/this._dur),r,s)?this.resetTo(t,e,i,n,1):(kp(this,0),this.parent||_p(this._dp,this,"_first","_last",this._dp._sort?"_start":0),this.render(0))},i.kill=function(t,e){if(void 0===e&&(e="all"),!(t||e&&"all"!==e))return this._lazy=this._pt=0,this.parent?om(this):this;if(this.timeline){var i=this.timeline.totalDuration();return this.timeline.killTweensOf(t,e,Om&&!0!==Om.vars.overwrite)._first||om(this),this.parent&&i!==this.timeline.totalDuration()&&zp(this,this._dur*this.timeline._tDur/i,0,1),this}var n,s,r,a,o,h,l,c=this._targets,u=t?Jp(t):c,d=this._ptLookup,p=this._pt;if((!e||"all"===e)&&function(t,e){for(var i=t.length,n=i===e.length;n&&i--&&t[i]===e[i];);return i<0}(c,u))return"all"===e&&(this._pt=0),om(this);for(n=this._op=this._op||[],"all"!==e&&(Sd(e)&&(o={},op(e,(function(t){return o[t]=1})),e=o),e=function(t,e){var i,n,s,r,a=t[0]?rp(t[0]).harness:0,o=a&&a.aliases;if(!o)return e;for(n in i=vp({},e),o)if(n in i)for(s=(r=o[n].split(",")).length;s--;)i[r[s]]=i[n];return i}(c,e)),l=c.length;l--;)if(~u.indexOf(c[l]))for(o in s=d[l],"all"===e?(n[l]=e,a=s,r={}):(r=n[l]=n[l]||{},a=e),a)(h=s&&s[o])&&("kill"in h.d&&!0!==h.d.kill(o)||wp(this,h,"_pt"),delete s[o]),"all"!==r&&(r[o]=1);return this._initted&&!this._pt&&p&&om(this),this},e.to=function(t,i){return new e(t,i,arguments[2])},e.from=function(t,e){return Vp(1,arguments)},e.delayedCall=function(t,i,n,s){return new e(i,0,{immediateRender:!1,lazy:!1,overwrite:!1,delay:t,onComplete:i,onReverseComplete:i,onCompleteParams:n,onReverseCompleteParams:n,callbackScope:s})},e.fromTo=function(t,e,i){return Vp(2,arguments)},e.set=function(t,i){return i.duration=0,i.repeatDelay||(i.repeat=0),new e(t,i)},e.killTweensOf=function(t,e,i){return ad.killTweensOf(t,e,i)},e}(Dm);gp(Wm.prototype,{_targets:[],_lazy:0,_startAt:0,_op:0,_onInit:0}),op("staggerTo,staggerFrom,staggerFromTo",(function(t){Wm[t]=function(){var e=new Lm,i=Xp.call(arguments,0);return i.splice("staggerFromTo"===t?5:4,0,0),e[t].apply(e,i)}}));var Xm=function(t,e,i){return t[e]=i},qm=function(t,e,i){return t[e](i)},Ym=function(t,e,i,n){return t[e](n.fp,i)},Jm=function(t,e,i){return t.setAttribute(e,i)},$m=function(t,e){return Ed(t[e])?qm:Ad(t[e])&&t.setAttribute?Jm:Xm},Km=function(t,e){return e.set(e.t,e.p,Math.round(1e6*(e.s+e.c*t))/1e6,e)},Zm=function(t,e){return e.set(e.t,e.p,!!(e.s+e.c*t),e)},Qm=function(t,e){var i=e._pt,n="";if(!t&&e.b)n=e.b;else if(1===t&&e.e)n=e.e;else{for(;i;)n=i.p+(i.m?i.m(i.s+i.c*t):Math.round(1e4*(i.s+i.c*t))/1e4)+n,i=i._next;n+=e.c}e.set(e.t,e.p,n,e)},tf=function(t,e){for(var i=e._pt;i;)i.r(t,i.d),i=i._next},ef=function(t,e,i,n){for(var s,r=this._pt;r;)s=r._next,r.p===n&&r.modifier(t,e,i),r=s},nf=function(t){for(var e,i,n=this._pt;n;)i=n._next,n.p===t&&!n.op||n.op===t?wp(this,n,"_pt"):n.dep||(e=1),n=i;return!e},sf=function(t,e,i,n){n.mSet(t,e,n.m.call(n.tween,i,n.mt),n)},rf=function(t){for(var e,i,n,s,r=t._pt;r;){for(e=r._next,i=n;i&&i.pr>r.pr;)i=i._next;(r._prev=i?i._prev:s)?r._prev._next=r:n=r,(r._next=i)?i._prev=r:s=r,r=e}t._pt=n},af=function(){function t(t,e,i,n,s,r,a,o,h){this.t=e,this.s=n,this.c=s,this.p=i,this.r=r||Km,this.d=a||this,this.set=o||Xm,this.pr=h||0,this._next=t,t&&(t._prev=this)}return t.prototype.modifier=function(t,e,i){this.mSet=this.mSet||this.set,this.set=sf,this.m=t,this.mt=i,this.tween=e},t}();op(np+"parent,duration,ease,delay,overwrite,runBackwards,startAt,yoyo,immediateRender,repeat,repeatDelay,data,paused,reversed,lazy,callbackScope,stringFilter,id,yoyoEase,stagger,inherit,repeatRefresh,keyframes,autoRevert,scrollTrigger",(function(t){return $d[t]=1})),Gd.TweenMax=Gd.TweenLite=Wm,Gd.TimelineLite=Gd.TimelineMax=Lm,ad=new Lm({sortChildren:!1,defaults:fd,autoRemoveChildren:!0,id:"root",smoothChildTiming:!0}),md.stringFilter=ym;var of=[],hf={},lf=[],cf=0,uf=0,df=function(t){return(hf[t]||lf).map((function(t){return t()}))},pf=function(){var t=Date.now(),e=[];t-cf>2&&(df("matchMediaInit"),of.forEach((function(t){var i,n,s,r,a=t.queries,o=t.conditions;for(n in a)(i=od.matchMedia(a[n]).matches)&&(s=1),i!==o[n]&&(o[n]=i,r=1);r&&(t.revert(),s&&e.push(t))})),df("matchMediaRevert"),e.forEach((function(t){return t.onMatch(t,(function(e){return t.add(null,e)}))})),cf=t,df("matchMedia"))},mf=function(){function t(t,e){this.selector=e&&$p(e),this.data=[],this._r=[],this.isReverted=!1,this.id=uf++,t&&this.add(t)}var e=t.prototype;return e.add=function(t,e,i){Ed(t)&&(i=e,e=t,t=Ed);var n=this,s=function(){var t,s=rd,r=n.selector;return s&&s!==n&&s.data.push(n),i&&(n.selector=$p(i)),rd=n,t=e.apply(n,arguments),Ed(t)&&n._r.push(t),rd=s,n.selector=r,n.isReverted=!1,t};return n.last=s,t===Ed?s(n,(function(t){return n.add(null,t)})):t?n[t]=s:s},e.ignore=function(t){var e=rd;rd=null,t(this),rd=e},e.getTweens=function(){var e=[];return this.data.forEach((function(i){return i instanceof t?e.push.apply(e,i.getTweens()):i instanceof Wm&&!(i.parent&&"nested"===i.parent.data)&&e.push(i)})),e},e.clear=function(){this._r.length=this.data.length=0},e.kill=function(t,e){var i=this;if(t?function(){for(var e,n=i.getTweens(),s=i.data.length;s--;)"isFlip"===(e=i.data[s]).data&&(e.revert(),e.getChildren(!0,!0,!1).forEach((function(t){return n.splice(n.indexOf(t),1)})));for(n.map((function(t){return{g:t._dur||t._delay||t._sat&&!t._sat.vars.immediateRender?t.globalTime(0):-1/0,t}})).sort((function(t,e){return e.g-t.g||-1/0})).forEach((function(e){return e.t.revert(t)})),s=i.data.length;s--;)(e=i.data[s])instanceof Lm?"nested"!==e.data&&(e.scrollTrigger&&e.scrollTrigger.revert(),e.kill()):!(e instanceof Wm)&&e.revert&&e.revert(t);i._r.forEach((function(e){return e(t,i)})),i.isReverted=!0}():this.data.forEach((function(t){return t.kill&&t.kill()})),this.clear(),e)for(var n=of.length;n--;)of[n].id===this.id&&of.splice(n,1)},e.revert=function(t){this.kill(t||{})},t}(),ff=function(){function t(t){this.contexts=[],this.scope=t,rd&&rd.data.push(this)}var e=t.prototype;return e.add=function(t,e,i){Cd(t)||(t={matches:t});var n,s,r,a=new mf(0,i||this.scope),o=a.conditions={};for(s in rd&&!a.selector&&(a.selector=rd.selector),this.contexts.push(a),e=a.add("onMatch",e),a.queries=t,t)"all"===s?r=1:(n=od.matchMedia(t[s]))&&(of.indexOf(a)<0&&of.push(a),(o[s]=n.matches)&&(r=1),n.addListener?n.addListener(pf):n.addEventListener("change",pf));return r&&e(a,(function(t){return a.add(null,t)})),this},e.revert=function(t){this.kill(t||{})},e.kill=function(t){this.contexts.forEach((function(e){return e.kill(t,!0)}))},t}(),gf={registerPlugin:function(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];e.forEach((function(t){return lm(t)}))},timeline:function(t){return new Lm(t)},getTweensOf:function(t,e){return ad.getTweensOf(t,e)},getProperty:function(t,e,i,n){Sd(t)&&(t=Jp(t)[0]);var s=rp(t||{}).get,r=i?fp:mp;return"native"===i&&(i=""),t?e?r((Qd[e]&&Qd[e].get||s)(t,e,i,n)):function(e,i,n){return r((Qd[e]&&Qd[e].get||s)(t,e,i,n))}:t},quickSetter:function(t,e,i){if((t=Jp(t)).length>1){var n=t.map((function(t){return xf.quickSetter(t,e,i)})),s=n.length;return function(t){for(var e=s;e--;)n[e](t)}}t=t[0]||{};var r=Qd[e],a=rp(t),o=a.harness&&(a.harness.aliases||{})[e]||e,h=r?function(e){var n=new r;dd._pt=0,n.init(t,i?e+i:e,dd,0,[t]),n.render(1,n),dd._pt&&tf(1,dd)}:a.set(t,o);return r?h:function(e){return h(t,o,i?e+i:e,a,1)}},quickTo:function(t,e,i){var n,s=xf.to(t,vp(((n={})[e]="+=0.1",n.paused=!0,n),i||{})),r=function(t,i,n){return s.resetTo(e,t,i,n)};return r.tween=s,r},isTweening:function(t){return ad.getTweensOf(t,!0).length>0},defaults:function(t){return t&&t.ease&&(t.ease=Am(t.ease,fd.ease)),yp(fd,t||{})},config:function(t){return yp(md,t||{})},registerEffect:function(t){var e=t.name,i=t.effect,n=t.plugins,s=t.defaults,r=t.extendTimeline;(n||"").split(",").forEach((function(t){return t&&!Qd[t]&&!Gd[t]&&jd()})),tp[e]=function(t,e,n){return i(Jp(t),gp(e||{},s),n)},r&&(Lm.prototype[e]=function(t,i,n){return this.add(tp[e](t,Cd(i)?i:(n=i)&&{},this),n)})},registerEase:function(t,e){_m[t]=Am(e)},parseEase:function(t,e){return arguments.length?Am(t,e):_m},getById:function(t){return ad.getById(t)},exportRoot:function(t,e){void 0===t&&(t={});var i,n,s=new Lm(t);for(s.smoothChildTiming=Id(t.smoothChildTiming),ad.remove(s),s._dp=0,s._time=s._tTime=ad._time,i=ad._first;i;)n=i._next,!e&&!i._dur&&i instanceof Wm&&i.vars.onComplete===i._targets[0]||Dp(s,i,i._start-i._delay),i=n;return Dp(ad,s,0),s},context:function(t,e){return t?new mf(t,e):rd},matchMedia:function(t){return new ff(t)},matchMediaRefresh:function(){return of.forEach((function(t){var e,i,n=t.conditions;for(i in n)n[i]&&(n[i]=!1,e=1);e&&t.revert()}))||pf()},addEventListener:function(t,e){var i=hf[t]||(hf[t]=[]);~i.indexOf(e)||i.push(e)},removeEventListener:function(t,e){var i=hf[t],n=i&&i.indexOf(e);n>=0&&i.splice(n,1)},utils:{wrap:function t(e,i,n){var s=i-e;return Dd(e)?im(e,t(0,e.length),i):Hp(n,(function(t){return(s+(t-e)%s)%s+e}))},wrapYoyo:function t(e,i,n){var s=i-e,r=2*s;return Dd(e)?im(e,t(0,e.length-1),i):Hp(n,(function(t){return e+((t=(r+(t-e)%r)%r||0)>s?r-t:t)}))},distribute:Zp,random:em,snap:tm,normalize:function(t,e,i){return sm(t,e,0,1,i)},getUnit:Wp,clamp:function(t,e,i){return Hp(i,(function(i){return jp(t,e,i)}))},splitColor:pm,toArray:Jp,selector:$p,mapRange:sm,pipe:function(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];return function(t){return e.reduce((function(t,e){return e(t)}),t)}},unitize:function(t,e){return function(i){return t(parseFloat(i))+(e||Wp(i))}},interpolate:function t(e,i,n,s){var r=isNaN(e+i)?0:function(t){return(1-t)*e+t*i};if(!r){var a,o,h,l,c,u=Sd(e),d={};if(!0===n&&(s=1)&&(n=null),u)e={p:e},i={p:i};else if(Dd(e)&&!Dd(i)){for(h=[],l=e.length,c=l-2,o=1;o<l;o++)h.push(t(e[o-1],e[o]));l--,r=function(t){t*=l;var e=Math.min(c,~~t);return h[e](t-e)},n=i}else s||(e=vp(Dd(e)?[]:{},e));if(!h){for(a in i)zm.call(d,e,a,"get",i[a]);r=function(t){return tf(t,d)||(u?e.p:e)}}}return Hp(n,r)},shuffle:Kp},install:Hd,effects:tp,ticker:xm,updateRoot:Lm.updateRoot,plugins:Qd,globalTimeline:ad,core:{PropTween:af,globals:Wd,Tween:Wm,Timeline:Lm,Animation:Dm,getCache:rp,_removeLinkedListItem:wp,reverting:function(){return sd},context:function(t){return t&&rd&&(rd.data.push(t),t._ctx=rd),rd},suppressOverwrites:function(t){return nd=t}}};op("to,from,fromTo,delayedCall,set,killTweensOf",(function(t){return gf[t]=Wm[t]})),xm.add(Lm.updateRoot),dd=gf.to({},{duration:0});var vf=function(t,e){for(var i=t._pt;i&&i.p!==e&&i.op!==e&&i.fp!==e;)i=i._next;return i},yf=function(t,e){return{name:t,rawVars:1,init:function(t,i,n){n._onInit=function(t){var n,s;if(Sd(i)&&(n={},op(i,(function(t){return n[t]=1})),i=n),e){for(s in n={},i)n[s]=e(i[s]);i=n}!function(t,e){var i,n,s,r=t._targets;for(i in e)for(n=r.length;n--;)(s=t._ptLookup[n][i])&&(s=s.d)&&(s._pt&&(s=vf(s,i)),s&&s.modifier&&s.modifier(e[i],t,r[n],i))}(t,i)}}}},xf=gf.registerPlugin({name:"attr",init:function(t,e,i,n,s){var r,a,o;for(r in this.tween=i,e)o=t.getAttribute(r)||"",(a=this.add(t,"setAttribute",(o||0)+"",e[r],n,s,0,0,r)).op=r,a.b=o,this._props.push(r)},render:function(t,e){for(var i=e._pt;i;)sd?i.set(i.t,i.p,i.b,i):i.r(t,i.d),i=i._next}},{name:"endArray",init:function(t,e){for(var i=e.length;i--;)this.add(t,i,t[i]||0,e[i],0,0,0,0,0,1)}},yf("roundProps",Qp),yf("modifiers"),yf("snap",tm))||gf;Wm.version=Lm.version=xf.version="3.12.5",cd=1,Rd()&&bm();_m.Power0,_m.Power1,_m.Power2,_m.Power3,_m.Power4,_m.Linear,_m.Quad,_m.Cubic,_m.Quart,_m.Quint,_m.Strong,_m.Elastic,_m.Back,_m.SteppedEase,_m.Bounce,_m.Sine,_m.Expo,_m.Circ;var bf,_f,wf,Mf,Sf,Ef,Tf,Af,Cf={},If=180/Math.PI,Rf=Math.PI/180,kf=Math.atan2,Pf=/([A-Z])/g,Df=/(left|right|width|margin|padding|x)/i,Lf=/[\s,\(]\S/,Of={autoAlpha:"opacity,visibility",scale:"scaleX,scaleY",alpha:"opacity"},Nf=function(t,e){return e.set(e.t,e.p,Math.round(1e4*(e.s+e.c*t))/1e4+e.u,e)},Bf=function(t,e){return e.set(e.t,e.p,1===t?e.e:Math.round(1e4*(e.s+e.c*t))/1e4+e.u,e)},zf=function(t,e){return e.set(e.t,e.p,t?Math.round(1e4*(e.s+e.c*t))/1e4+e.u:e.b,e)},Uf=function(t,e){var i=e.s+e.c*t;e.set(e.t,e.p,~~(i+(i<0?-.5:.5))+e.u,e)},Ff=function(t,e){return e.set(e.t,e.p,t?e.e:e.b,e)},Gf=function(t,e){return e.set(e.t,e.p,1!==t?e.b:e.e,e)},Vf=function(t,e,i){return t.style[e]=i},Hf=function(t,e,i){return t.style.setProperty(e,i)},jf=function(t,e,i){return t._gsap[e]=i},Wf=function(t,e,i){return t._gsap.scaleX=t._gsap.scaleY=i},Xf=function(t,e,i,n,s){var r=t._gsap;r.scaleX=r.scaleY=i,r.renderTransform(s,r)},qf=function(t,e,i,n,s){var r=t._gsap;r[e]=i,r.renderTransform(s,r)},Yf="transform",Jf=Yf+"Origin",$f=function t(e,i){var n=this,s=this.target,r=s.style,a=s._gsap;if(e in Cf&&r){if(this.tfm=this.tfm||{},"transform"===e)return Of.transform.split(",").forEach((function(e){return t.call(n,e,i)}));if(~(e=Of[e]||e).indexOf(",")?e.split(",").forEach((function(t){return n.tfm[t]=mg(s,t)})):this.tfm[e]=a.x?a[e]:mg(s,e),e===Jf&&(this.tfm.zOrigin=a.zOrigin),this.props.indexOf(Yf)>=0)return;a.svg&&(this.svgo=s.getAttribute("data-svg-origin"),this.props.push(Jf,i,"")),e=Yf}(r||i)&&this.props.push(e,i,r[e])},Kf=function(t){t.translate&&(t.removeProperty("translate"),t.removeProperty("scale"),t.removeProperty("rotate"))},Zf=function(){var t,e,i=this.props,n=this.target,s=n.style,r=n._gsap;for(t=0;t<i.length;t+=3)i[t+1]?n[i[t]]=i[t+2]:i[t+2]?s[i[t]]=i[t+2]:s.removeProperty("--"===i[t].substr(0,2)?i[t]:i[t].replace(Pf,"-$1").toLowerCase());if(this.tfm){for(e in this.tfm)r[e]=this.tfm[e];r.svg&&(r.renderTransform(),n.setAttribute("data-svg-origin",this.svgo||"")),(t=Tf())&&t.isStart||s[Yf]||(Kf(s),r.zOrigin&&s[Jf]&&(s[Jf]+=" "+r.zOrigin+"px",r.zOrigin=0,r.renderTransform()),r.uncache=1)}},Qf=function(t,e){var i={target:t,props:[],revert:Zf,save:$f};return t._gsap||xf.core.getCache(t),e&&e.split(",").forEach((function(t){return i.save(t)})),i},tg=function(t,e){var i=_f.createElementNS?_f.createElementNS((e||"http://www.w3.org/1999/xhtml").replace(/^https/,"http"),t):_f.createElement(t);return i&&i.style?i:_f.createElement(t)},eg=function t(e,i,n){var s=getComputedStyle(e);return s[i]||s.getPropertyValue(i.replace(Pf,"-$1").toLowerCase())||s.getPropertyValue(i)||!n&&t(e,ng(i)||i,1)||""},ig="O,Moz,ms,Ms,Webkit".split(","),ng=function(t,e,i){var n=(e||Sf).style,s=5;if(t in n&&!i)return t;for(t=t.charAt(0).toUpperCase()+t.substr(1);s--&&!(ig[s]+t in n););return s<0?null:(3===s?"ms":s>=0?ig[s]:"")+t},sg=function(){"undefined"!=typeof window&&window.document&&(bf=window,_f=bf.document,wf=_f.documentElement,Sf=tg("div")||{style:{}},tg("div"),Yf=ng(Yf),Jf=Yf+"Origin",Sf.style.cssText="border-width:0;line-height:0;position:absolute;padding:0",Af=!!ng("perspective"),Tf=xf.core.reverting,Mf=1)},rg=function t(e){var i,n=tg("svg",this.ownerSVGElement&&this.ownerSVGElement.getAttribute("xmlns")||"http://www.w3.org/2000/svg"),s=this.parentNode,r=this.nextSibling,a=this.style.cssText;if(wf.appendChild(n),n.appendChild(this),this.style.display="block",e)try{i=this.getBBox(),this._gsapBBox=this.getBBox,this.getBBox=t}catch(t){}else this._gsapBBox&&(i=this._gsapBBox());return s&&(r?s.insertBefore(this,r):s.appendChild(this)),wf.removeChild(n),this.style.cssText=a,i},ag=function(t,e){for(var i=e.length;i--;)if(t.hasAttribute(e[i]))return t.getAttribute(e[i])},og=function(t){var e;try{e=t.getBBox()}catch(i){e=rg.call(t,!0)}return e&&(e.width||e.height)||t.getBBox===rg||(e=rg.call(t,!0)),!e||e.width||e.x||e.y?e:{x:+ag(t,["x","cx","x1"])||0,y:+ag(t,["y","cy","y1"])||0,width:0,height:0}},hg=function(t){return!(!t.getCTM||t.parentNode&&!t.ownerSVGElement||!og(t))},lg=function(t,e){if(e){var i,n=t.style;e in Cf&&e!==Jf&&(e=Yf),n.removeProperty?("ms"!==(i=e.substr(0,2))&&"webkit"!==e.substr(0,6)||(e="-"+e),n.removeProperty("--"===i?e:e.replace(Pf,"-$1").toLowerCase())):n.removeAttribute(e)}},cg=function(t,e,i,n,s,r){var a=new af(t._pt,e,i,0,1,r?Gf:Ff);return t._pt=a,a.b=n,a.e=s,t._props.push(i),a},ug={deg:1,rad:1,turn:1},dg={grid:1,flex:1},pg=function t(e,i,n,s){var r,a,o,h,l=parseFloat(n)||0,c=(n+"").trim().substr((l+"").length)||"px",u=Sf.style,d=Df.test(i),p="svg"===e.tagName.toLowerCase(),m=(p?"client":"offset")+(d?"Width":"Height"),f=100,g="px"===s,v="%"===s;if(s===c||!l||ug[s]||ug[c])return l;if("px"!==c&&!g&&(l=t(e,i,n,"px")),h=e.getCTM&&hg(e),(v||"%"===c)&&(Cf[i]||~i.indexOf("adius")))return r=h?e.getBBox()[d?"width":"height"]:e[m],hp(v?l/r*f:l/100*r);if(u[d?"width":"height"]=f+(g?c:s),a=~i.indexOf("adius")||"em"===s&&e.appendChild&&!p?e:e.parentNode,h&&(a=(e.ownerSVGElement||{}).parentNode),a&&a!==_f&&a.appendChild||(a=_f.body),(o=a._gsap)&&v&&o.width&&d&&o.time===xm.time&&!o.uncache)return hp(l/o.width*f);if(!v||"height"!==i&&"width"!==i)(v||"%"===c)&&!dg[eg(a,"display")]&&(u.position=eg(e,"position")),a===e&&(u.position="static"),a.appendChild(Sf),r=Sf[m],a.removeChild(Sf),u.position="absolute";else{var y=e.style[i];e.style[i]=f+s,r=e[m],y?e.style[i]=y:lg(e,i)}return d&&v&&((o=rp(a)).time=xm.time,o.width=a[m]),hp(g?r*l/f:r&&l?f/r*l:0)},mg=function(t,e,i,n){var s;return Mf||sg(),e in Of&&"transform"!==e&&~(e=Of[e]).indexOf(",")&&(e=e.split(",")[0]),Cf[e]&&"transform"!==e?(s=Tg(t,n),s="transformOrigin"!==e?s[e]:s.svg?s.origin:Ag(eg(t,Jf))+" "+s.zOrigin+"px"):(!(s=t.style[e])||"auto"===s||n||~(s+"").indexOf("calc("))&&(s=xg[e]&&xg[e](t,e,i)||eg(t,e)||ap(t,e)||("opacity"===e?1:0)),i&&!~(s+"").trim().indexOf(" ")?pg(t,e,s,i)+i:s},fg=function(t,e,i,n){if(!i||"none"===i){var s=ng(e,t,1),r=s&&eg(t,s,1);r&&r!==i?(e=s,i=r):"borderColor"===e&&(i=eg(t,"borderTopColor"))}var a,o,h,l,c,u,d,p,m,f,g,v=new af(this._pt,t.style,e,0,1,Qm),y=0,x=0;if(v.b=i,v.e=n,i+="","auto"===(n+="")&&(u=t.style[e],t.style[e]=n,n=eg(t,e)||n,u?t.style[e]=u:lg(t,e)),ym(a=[i,n]),n=a[1],h=(i=a[0]).match(Nd)||[],(n.match(Nd)||[]).length){for(;o=Nd.exec(n);)d=o[0],m=n.substring(y,o.index),c?c=(c+1)%5:"rgba("!==m.substr(-5)&&"hsla("!==m.substr(-5)||(c=1),d!==(u=h[x++]||"")&&(l=parseFloat(u)||0,g=u.substr((l+"").length),"="===d.charAt(1)&&(d=cp(l,d)+g),p=parseFloat(d),f=d.substr((p+"").length),y=Nd.lastIndex-f.length,f||(f=f||md.units[e]||g,y===n.length&&(n+=f,v.e+=f)),g!==f&&(l=pg(t,e,u,f)||0),v._pt={_next:v._pt,p:m||1===x?m:",",s:l,c:p-l,m:c&&c<4||"zIndex"===e?Math.round:0});v.c=y<n.length?n.substring(y,n.length):""}else v.r="display"===e&&"none"===n?Gf:Ff;return zd.test(n)&&(v.e=0),this._pt=v,v},gg={top:"0%",bottom:"100%",left:"0%",right:"100%",center:"50%"},vg=function(t){var e=t.split(" "),i=e[0],n=e[1]||"50%";return"top"!==i&&"bottom"!==i&&"left"!==n&&"right"!==n||(t=i,i=n,n=t),e[0]=gg[i]||i,e[1]=gg[n]||n,e.join(" ")},yg=function(t,e){if(e.tween&&e.tween._time===e.tween._dur){var i,n,s,r=e.t,a=r.style,o=e.u,h=r._gsap;if("all"===o||!0===o)a.cssText="",n=1;else for(s=(o=o.split(",")).length;--s>-1;)i=o[s],Cf[i]&&(n=1,i="transformOrigin"===i?Jf:Yf),lg(r,i);n&&(lg(r,Yf),h&&(h.svg&&r.removeAttribute("transform"),Tg(r,1),h.uncache=1,Kf(a)))}},xg={clearProps:function(t,e,i,n,s){if("isFromStart"!==s.data){var r=t._pt=new af(t._pt,e,i,0,0,yg);return r.u=n,r.pr=-10,r.tween=s,t._props.push(i),1}}},bg=[1,0,0,1,0,0],_g={},wg=function(t){return"matrix(1, 0, 0, 1, 0, 0)"===t||"none"===t||!t},Mg=function(t){var e=eg(t,Yf);return wg(e)?bg:e.substr(7).match(Od).map(hp)},Sg=function(t,e){var i,n,s,r,a=t._gsap||rp(t),o=t.style,h=Mg(t);return a.svg&&t.getAttribute("transform")?"1,0,0,1,0,0"===(h=[(s=t.transform.baseVal.consolidate().matrix).a,s.b,s.c,s.d,s.e,s.f]).join(",")?bg:h:(h!==bg||t.offsetParent||t===wf||a.svg||(s=o.display,o.display="block",(i=t.parentNode)&&t.offsetParent||(r=1,n=t.nextElementSibling,wf.appendChild(t)),h=Mg(t),s?o.display=s:lg(t,"display"),r&&(n?i.insertBefore(t,n):i?i.appendChild(t):wf.removeChild(t))),e&&h.length>6?[h[0],h[1],h[4],h[5],h[12],h[13]]:h)},Eg=function(t,e,i,n,s,r){var a,o,h,l=t._gsap,c=s||Sg(t,!0),u=l.xOrigin||0,d=l.yOrigin||0,p=l.xOffset||0,m=l.yOffset||0,f=c[0],g=c[1],v=c[2],y=c[3],x=c[4],b=c[5],_=e.split(" "),w=parseFloat(_[0])||0,M=parseFloat(_[1])||0;i?c!==bg&&(o=f*y-g*v)&&(h=w*(-g/o)+M*(f/o)-(f*b-g*x)/o,w=w*(y/o)+M*(-v/o)+(v*b-y*x)/o,M=h):(w=(a=og(t)).x+(~_[0].indexOf("%")?w/100*a.width:w),M=a.y+(~(_[1]||_[0]).indexOf("%")?M/100*a.height:M)),n||!1!==n&&l.smooth?(x=w-u,b=M-d,l.xOffset=p+(x*f+b*v)-x,l.yOffset=m+(x*g+b*y)-b):l.xOffset=l.yOffset=0,l.xOrigin=w,l.yOrigin=M,l.smooth=!!n,l.origin=e,l.originIsAbsolute=!!i,t.style[Jf]="0px 0px",r&&(cg(r,l,"xOrigin",u,w),cg(r,l,"yOrigin",d,M),cg(r,l,"xOffset",p,l.xOffset),cg(r,l,"yOffset",m,l.yOffset)),t.setAttribute("data-svg-origin",w+" "+M)},Tg=function(t,e){var i=t._gsap||new Pm(t);if("x"in i&&!e&&!i.uncache)return i;var n,s,r,a,o,h,l,c,u,d,p,m,f,g,v,y,x,b,_,w,M,S,E,T,A,C,I,R,k,P,D,L,O=t.style,N=i.scaleX<0,B="px",z="deg",U=getComputedStyle(t),F=eg(t,Jf)||"0";return n=s=r=h=l=c=u=d=p=0,a=o=1,i.svg=!(!t.getCTM||!hg(t)),U.translate&&("none"===U.translate&&"none"===U.scale&&"none"===U.rotate||(O[Yf]=("none"!==U.translate?"translate3d("+(U.translate+" 0 0").split(" ").slice(0,3).join(", ")+") ":"")+("none"!==U.rotate?"rotate("+U.rotate+") ":"")+("none"!==U.scale?"scale("+U.scale.split(" ").join(",")+") ":"")+("none"!==U[Yf]?U[Yf]:"")),O.scale=O.rotate=O.translate="none"),g=Sg(t,i.svg),i.svg&&(i.uncache?(A=t.getBBox(),F=i.xOrigin-A.x+"px "+(i.yOrigin-A.y)+"px",T=""):T=!e&&t.getAttribute("data-svg-origin"),Eg(t,T||F,!!T||i.originIsAbsolute,!1!==i.smooth,g)),m=i.xOrigin||0,f=i.yOrigin||0,g!==bg&&(b=g[0],_=g[1],w=g[2],M=g[3],n=S=g[4],s=E=g[5],6===g.length?(a=Math.sqrt(b*b+_*_),o=Math.sqrt(M*M+w*w),h=b||_?kf(_,b)*If:0,(u=w||M?kf(w,M)*If+h:0)&&(o*=Math.abs(Math.cos(u*Rf))),i.svg&&(n-=m-(m*b+f*w),s-=f-(m*_+f*M))):(L=g[6],P=g[7],I=g[8],R=g[9],k=g[10],D=g[11],n=g[12],s=g[13],r=g[14],l=(v=kf(L,k))*If,v&&(T=S*(y=Math.cos(-v))+I*(x=Math.sin(-v)),A=E*y+R*x,C=L*y+k*x,I=S*-x+I*y,R=E*-x+R*y,k=L*-x+k*y,D=P*-x+D*y,S=T,E=A,L=C),c=(v=kf(-w,k))*If,v&&(y=Math.cos(-v),D=M*(x=Math.sin(-v))+D*y,b=T=b*y-I*x,_=A=_*y-R*x,w=C=w*y-k*x),h=(v=kf(_,b))*If,v&&(T=b*(y=Math.cos(v))+_*(x=Math.sin(v)),A=S*y+E*x,_=_*y-b*x,E=E*y-S*x,b=T,S=A),l&&Math.abs(l)+Math.abs(h)>359.9&&(l=h=0,c=180-c),a=hp(Math.sqrt(b*b+_*_+w*w)),o=hp(Math.sqrt(E*E+L*L)),v=kf(S,E),u=Math.abs(v)>2e-4?v*If:0,p=D?1/(D<0?-D:D):0),i.svg&&(T=t.getAttribute("transform"),i.forceCSS=t.setAttribute("transform","")||!wg(eg(t,Yf)),T&&t.setAttribute("transform",T))),Math.abs(u)>90&&Math.abs(u)<270&&(N?(a*=-1,u+=h<=0?180:-180,h+=h<=0?180:-180):(o*=-1,u+=u<=0?180:-180)),e=e||i.uncache,i.x=n-((i.xPercent=n&&(!e&&i.xPercent||(Math.round(t.offsetWidth/2)===Math.round(-n)?-50:0)))?t.offsetWidth*i.xPercent/100:0)+B,i.y=s-((i.yPercent=s&&(!e&&i.yPercent||(Math.round(t.offsetHeight/2)===Math.round(-s)?-50:0)))?t.offsetHeight*i.yPercent/100:0)+B,i.z=r+B,i.scaleX=hp(a),i.scaleY=hp(o),i.rotation=hp(h)+z,i.rotationX=hp(l)+z,i.rotationY=hp(c)+z,i.skewX=u+z,i.skewY=d+z,i.transformPerspective=p+B,(i.zOrigin=parseFloat(F.split(" ")[2])||!e&&i.zOrigin||0)&&(O[Jf]=Ag(F)),i.xOffset=i.yOffset=0,i.force3D=md.force3D,i.renderTransform=i.svg?Lg:Af?Dg:Ig,i.uncache=0,i},Ag=function(t){return(t=t.split(" "))[0]+" "+t[1]},Cg=function(t,e,i){var n=Wp(e);return hp(parseFloat(e)+parseFloat(pg(t,"x",i+"px",n)))+n},Ig=function(t,e){e.z="0px",e.rotationY=e.rotationX="0deg",e.force3D=0,Dg(t,e)},Rg="0deg",kg="0px",Pg=") ",Dg=function(t,e){var i=e||this,n=i.xPercent,s=i.yPercent,r=i.x,a=i.y,o=i.z,h=i.rotation,l=i.rotationY,c=i.rotationX,u=i.skewX,d=i.skewY,p=i.scaleX,m=i.scaleY,f=i.transformPerspective,g=i.force3D,v=i.target,y=i.zOrigin,x="",b="auto"===g&&t&&1!==t||!0===g;if(y&&(c!==Rg||l!==Rg)){var _,w=parseFloat(l)*Rf,M=Math.sin(w),S=Math.cos(w);w=parseFloat(c)*Rf,_=Math.cos(w),r=Cg(v,r,M*_*-y),a=Cg(v,a,-Math.sin(w)*-y),o=Cg(v,o,S*_*-y+y)}f!==kg&&(x+="perspective("+f+Pg),(n||s)&&(x+="translate("+n+"%, "+s+"%) "),(b||r!==kg||a!==kg||o!==kg)&&(x+=o!==kg||b?"translate3d("+r+", "+a+", "+o+") ":"translate("+r+", "+a+Pg),h!==Rg&&(x+="rotate("+h+Pg),l!==Rg&&(x+="rotateY("+l+Pg),c!==Rg&&(x+="rotateX("+c+Pg),u===Rg&&d===Rg||(x+="skew("+u+", "+d+Pg),1===p&&1===m||(x+="scale("+p+", "+m+Pg),v.style[Yf]=x||"translate(0, 0)"},Lg=function(t,e){var i,n,s,r,a,o=e||this,h=o.xPercent,l=o.yPercent,c=o.x,u=o.y,d=o.rotation,p=o.skewX,m=o.skewY,f=o.scaleX,g=o.scaleY,v=o.target,y=o.xOrigin,x=o.yOrigin,b=o.xOffset,_=o.yOffset,w=o.forceCSS,M=parseFloat(c),S=parseFloat(u);d=parseFloat(d),p=parseFloat(p),(m=parseFloat(m))&&(p+=m=parseFloat(m),d+=m),d||p?(d*=Rf,p*=Rf,i=Math.cos(d)*f,n=Math.sin(d)*f,s=Math.sin(d-p)*-g,r=Math.cos(d-p)*g,p&&(m*=Rf,a=Math.tan(p-m),s*=a=Math.sqrt(1+a*a),r*=a,m&&(a=Math.tan(m),i*=a=Math.sqrt(1+a*a),n*=a)),i=hp(i),n=hp(n),s=hp(s),r=hp(r)):(i=f,r=g,n=s=0),(M&&!~(c+"").indexOf("px")||S&&!~(u+"").indexOf("px"))&&(M=pg(v,"x",c,"px"),S=pg(v,"y",u,"px")),(y||x||b||_)&&(M=hp(M+y-(y*i+x*s)+b),S=hp(S+x-(y*n+x*r)+_)),(h||l)&&(a=v.getBBox(),M=hp(M+h/100*a.width),S=hp(S+l/100*a.height)),a="matrix("+i+","+n+","+s+","+r+","+M+","+S+")",v.setAttribute("transform",a),w&&(v.style[Yf]=a)},Og=function(t,e,i,n,s){var r,a,o=360,h=Sd(s),l=parseFloat(s)*(h&&~s.indexOf("rad")?If:1)-n,c=n+l+"deg";return h&&("short"===(r=s.split("_")[1])&&(l%=o)!==l%180&&(l+=l<0?o:-360),"cw"===r&&l<0?l=(l+36e9)%o-~~(l/o)*o:"ccw"===r&&l>0&&(l=(l-36e9)%o-~~(l/o)*o)),t._pt=a=new af(t._pt,e,i,n,l,Bf),a.e=c,a.u="deg",t._props.push(i),a},Ng=function(t,e){for(var i in e)t[i]=e[i];return t},Bg=function(t,e,i){var n,s,r,a,o,h,l,c=Ng({},i._gsap),u=i.style;for(s in c.svg?(r=i.getAttribute("transform"),i.setAttribute("transform",""),u[Yf]=e,n=Tg(i,1),lg(i,Yf),i.setAttribute("transform",r)):(r=getComputedStyle(i)[Yf],u[Yf]=e,n=Tg(i,1),u[Yf]=r),Cf)(r=c[s])!==(a=n[s])&&"perspective,force3D,transformOrigin,svgOrigin".indexOf(s)<0&&(o=Wp(r)!==(l=Wp(a))?pg(i,s,r,l):parseFloat(r),h=parseFloat(a),t._pt=new af(t._pt,n,s,o,h-o,Nf),t._pt.u=l||0,t._props.push(s));Ng(n,c)};op("padding,margin,Width,Radius",(function(t,e){var i="Top",n="Right",s="Bottom",r="Left",a=(e<3?[i,n,s,r]:[i+r,i+n,s+n,s+r]).map((function(i){return e<2?t+i:"border"+i+t}));xg[e>1?"border"+t:t]=function(t,e,i,n,s){var r,o;if(arguments.length<4)return r=a.map((function(e){return mg(t,e,i)})),5===(o=r.join(" ")).split(r[0]).length?r[0]:o;r=(n+"").split(" "),o={},a.forEach((function(t,e){return o[t]=r[e]=r[e]||r[(e-1)/2|0]})),t.init(e,o,s)}}));var zg,Ug,Fg,Gg={name:"css",register:sg,targetTest:function(t){return t.style&&t.nodeType},init:function(t,e,i,n,s){var r,a,o,h,l,c,u,d,p,m,f,g,v,y,x,b,_=this._props,w=t.style,M=i.vars.startAt;for(u in Mf||sg(),this.styles=this.styles||Qf(t),b=this.styles.props,this.tween=i,e)if("autoRound"!==u&&(a=e[u],!Qd[u]||!Um(u,e,i,n,t,s)))if(l=typeof a,c=xg[u],"function"===l&&(l=typeof(a=a.call(i,n,t,s))),"string"===l&&~a.indexOf("random(")&&(a=nm(a)),c)c(this,t,u,a,i)&&(x=1);else if("--"===u.substr(0,2))r=(getComputedStyle(t).getPropertyValue(u)+"").trim(),a+="",gm.lastIndex=0,gm.test(r)||(d=Wp(r),p=Wp(a)),p?d!==p&&(r=pg(t,u,r,p)+p):d&&(a+=d),this.add(w,"setProperty",r,a,n,s,0,0,u),_.push(u),b.push(u,0,w[u]);else if("undefined"!==l){if(M&&u in M?(r="function"==typeof M[u]?M[u].call(i,n,t,s):M[u],Sd(r)&&~r.indexOf("random(")&&(r=nm(r)),Wp(r+"")||"auto"===r||(r+=md.units[u]||Wp(mg(t,u))||""),"="===(r+"").charAt(1)&&(r=mg(t,u))):r=mg(t,u),h=parseFloat(r),(m="string"===l&&"="===a.charAt(1)&&a.substr(0,2))&&(a=a.substr(2)),o=parseFloat(a),u in Of&&("autoAlpha"===u&&(1===h&&"hidden"===mg(t,"visibility")&&o&&(h=0),b.push("visibility",0,w.visibility),cg(this,w,"visibility",h?"inherit":"hidden",o?"inherit":"hidden",!o)),"scale"!==u&&"transform"!==u&&~(u=Of[u]).indexOf(",")&&(u=u.split(",")[0])),f=u in Cf)if(this.styles.save(u),g||((v=t._gsap).renderTransform&&!e.parseTransform||Tg(t,e.parseTransform),y=!1!==e.smoothOrigin&&v.smooth,(g=this._pt=new af(this._pt,w,Yf,0,1,v.renderTransform,v,0,-1)).dep=1),"scale"===u)this._pt=new af(this._pt,v,"scaleY",v.scaleY,(m?cp(v.scaleY,m+o):o)-v.scaleY||0,Nf),this._pt.u=0,_.push("scaleY",u),u+="X";else{if("transformOrigin"===u){b.push(Jf,0,w[Jf]),a=vg(a),v.svg?Eg(t,a,0,y,0,this):((p=parseFloat(a.split(" ")[2])||0)!==v.zOrigin&&cg(this,v,"zOrigin",v.zOrigin,p),cg(this,w,u,Ag(r),Ag(a)));continue}if("svgOrigin"===u){Eg(t,a,1,y,0,this);continue}if(u in _g){Og(this,v,u,h,m?cp(h,m+a):a);continue}if("smoothOrigin"===u){cg(this,v,"smooth",v.smooth,a);continue}if("force3D"===u){v[u]=a;continue}if("transform"===u){Bg(this,a,t);continue}}else u in w||(u=ng(u)||u);if(f||(o||0===o)&&(h||0===h)&&!Lf.test(a)&&u in w)o||(o=0),(d=(r+"").substr((h+"").length))!==(p=Wp(a)||(u in md.units?md.units[u]:d))&&(h=pg(t,u,r,p)),this._pt=new af(this._pt,f?v:w,u,h,(m?cp(h,m+o):o)-h,f||"px"!==p&&"zIndex"!==u||!1===e.autoRound?Nf:Uf),this._pt.u=p||0,d!==p&&"%"!==p&&(this._pt.b=r,this._pt.r=zf);else if(u in w)fg.call(this,t,u,r,m?m+a:a);else if(u in t)this.add(t,u,r||t[u],m?m+a:a,n,s);else if("parseTransform"!==u)continue;f||(u in w?b.push(u,0,w[u]):b.push(u,1,r||t[u])),_.push(u)}x&&rf(this)},render:function(t,e){if(e.tween._time||!Tf())for(var i=e._pt;i;)i.r(t,i.d),i=i._next;else e.styles.revert()},get:mg,aliases:Of,getSetter:function(t,e,i){var n=Of[e];return n&&n.indexOf(",")<0&&(e=n),e in Cf&&e!==Jf&&(t._gsap.x||mg(t,"x"))?i&&Ef===i?"scale"===e?Wf:jf:(Ef=i||{})&&("scale"===e?Xf:qf):t.style&&!Ad(t.style[e])?Vf:~e.indexOf("-")?Hf:$m(t,e)},core:{_removeProperty:lg,_getMatrix:Sg}};xf.utils.checkPrefix=ng,xf.core.getStyleSaver=Qf,Fg=op((zg="x,y,z,scale,scaleX,scaleY,xPercent,yPercent")+","+(Ug="rotation,rotationX,rotationY,skewX,skewY")+",transform,transformOrigin,svgOrigin,force3D,smoothOrigin,transformPerspective",(function(t){Cf[t]=1})),op(Ug,(function(t){md.units[t]="deg",_g[t]=1})),Of[Fg[13]]=zg+","+Ug,op("0:translateX,1:translateY,2:translateZ,8:rotate,8:rotationZ,8:rotateZ,9:rotateX,10:rotateY",(function(t){var e=t.split(":");Of[e[1]]=Fg[e[0]]})),op("x,y,z,top,right,bottom,left,width,height,fontSize,padding,margin,perspective",(function(t){md.units[t]="px"})),xf.registerPlugin(Gg);var Vg=xf.registerPlugin(Gg)||xf;Vg.core.Tween;const Hg={type:"change"},jg={type:"start"},Wg={type:"end"},Xg=new li,qg=new Zn,Yg=Math.cos(70*ne.DEG2RAD);class Jg extends jt{constructor(t,e){super(),this.object=t,this.domElement=e,this.domElement.style.touchAction="none",this.enabled=!0,this.target=new Le,this.cursor=new Le,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minTargetRadius=0,this.maxTargetRadius=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.zoomToCursor=!1,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:x,MIDDLE:b,RIGHT:_},this.touches={ONE:w,TWO:S},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this.getPolarAngle=function(){return a.phi},this.getAzimuthalAngle=function(){return a.theta},this.getDistance=function(){return this.object.position.distanceTo(this.target)},this.listenToKeyEvents=function(t){t.addEventListener("keydown",et),this._domElementKeyEvents=t},this.stopListenToKeyEvents=function(){this._domElementKeyEvents.removeEventListener("keydown",et),this._domElementKeyEvents=null},this.saveState=function(){i.target0.copy(i.target),i.position0.copy(i.object.position),i.zoom0=i.object.zoom},this.reset=function(){i.target.copy(i.target0),i.object.position.copy(i.position0),i.object.zoom=i.zoom0,i.object.updateProjectionMatrix(),i.dispatchEvent(Hg),i.update(),s=n.NONE},this.update=function(){const e=new Le,c=(new De).setFromUnitVectors(t.up,new Le(0,1,0)),u=c.clone().invert(),d=new Le,p=new De,m=new Le,f=2*Math.PI;return function(g=null){const v=i.object.position;e.copy(v).sub(i.target),e.applyQuaternion(c),a.setFromVector3(e),i.autoRotate&&s===n.NONE&&D(function(t){return null!==t?2*Math.PI/60*i.autoRotateSpeed*t:2*Math.PI/60/60*i.autoRotateSpeed}(g)),i.enableDamping?(a.theta+=o.theta*i.dampingFactor,a.phi+=o.phi*i.dampingFactor):(a.theta+=o.theta,a.phi+=o.phi);let y=i.minAzimuthAngle,x=i.maxAzimuthAngle;isFinite(y)&&isFinite(x)&&(y<-Math.PI?y+=f:y>Math.PI&&(y-=f),x<-Math.PI?x+=f:x>Math.PI&&(x-=f),a.theta=y<=x?Math.max(y,Math.min(x,a.theta)):a.theta>(y+x)/2?Math.max(y,a.theta):Math.min(x,a.theta)),a.phi=Math.max(i.minPolarAngle,Math.min(i.maxPolarAngle,a.phi)),a.makeSafe(),!0===i.enableDamping?i.target.addScaledVector(l,i.dampingFactor):i.target.add(l),i.target.sub(i.cursor),i.target.clampLength(i.minTargetRadius,i.maxTargetRadius),i.target.add(i.cursor),i.zoomToCursor&&C||i.object.isOrthographicCamera?a.radius=G(a.radius):a.radius=G(a.radius*h),e.setFromSpherical(a),e.applyQuaternion(u),v.copy(i.target).add(e),i.object.lookAt(i.target),!0===i.enableDamping?(o.theta*=1-i.dampingFactor,o.phi*=1-i.dampingFactor,l.multiplyScalar(1-i.dampingFactor)):(o.set(0,0,0),l.set(0,0,0));let b=!1;if(i.zoomToCursor&&C){let n=null;if(i.object.isPerspectiveCamera){const t=e.length();n=G(t*h);const s=t-n;i.object.position.addScaledVector(T,s),i.object.updateMatrixWorld()}else if(i.object.isOrthographicCamera){const t=new Le(A.x,A.y,0);t.unproject(i.object),i.object.zoom=Math.max(i.minZoom,Math.min(i.maxZoom,i.object.zoom/h)),i.object.updateProjectionMatrix(),b=!0;const s=new Le(A.x,A.y,0);s.unproject(i.object),i.object.position.sub(s).add(t),i.object.updateMatrixWorld(),n=e.length()}else i.zoomToCursor=!1;null!==n&&(this.screenSpacePanning?i.target.set(0,0,-1).transformDirection(i.object.matrix).multiplyScalar(n).add(i.object.position):(Xg.origin.copy(i.object.position),Xg.direction.set(0,0,-1).transformDirection(i.object.matrix),Math.abs(i.object.up.dot(Xg.direction))<Yg?t.lookAt(i.target):(qg.setFromNormalAndCoplanarPoint(i.object.up,i.target),Xg.intersectPlane(qg,i.target))))}else i.object.isOrthographicCamera&&(i.object.zoom=Math.max(i.minZoom,Math.min(i.maxZoom,i.object.zoom/h)),i.object.updateProjectionMatrix(),b=!0);return h=1,C=!1,!!(b||d.distanceToSquared(i.object.position)>r||8*(1-p.dot(i.object.quaternion))>r||m.distanceToSquared(i.target)>0)&&(i.dispatchEvent(Hg),d.copy(i.object.position),p.copy(i.object.quaternion),m.copy(i.target),!0)}}(),this.dispose=function(){i.domElement.removeEventListener("contextmenu",it),i.domElement.removeEventListener("pointerdown",$),i.domElement.removeEventListener("pointercancel",Z),i.domElement.removeEventListener("wheel",Q),i.domElement.removeEventListener("pointermove",K),i.domElement.removeEventListener("pointerup",Z),null!==i._domElementKeyEvents&&(i._domElementKeyEvents.removeEventListener("keydown",et),i._domElementKeyEvents=null)};const i=this,n={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let s=n.NONE;const r=1e-6,a=new cu,o=new cu;let h=1;const l=new Le,c=new se,u=new se,d=new se,p=new se,m=new se,f=new se,g=new se,v=new se,y=new se,T=new Le,A=new se;let C=!1;const I=[],R={};let k=!1;function P(t){const e=Math.abs(.01*t);return Math.pow(.95,i.zoomSpeed*e)}function D(t){o.theta-=t}function L(t){o.phi-=t}const O=function(){const t=new Le;return function(e,i){t.setFromMatrixColumn(i,0),t.multiplyScalar(-e),l.add(t)}}(),N=function(){const t=new Le;return function(e,n){!0===i.screenSpacePanning?t.setFromMatrixColumn(n,1):(t.setFromMatrixColumn(n,0),t.crossVectors(i.object.up,t)),t.multiplyScalar(e),l.add(t)}}(),B=function(){const t=new Le;return function(e,n){const s=i.domElement;if(i.object.isPerspectiveCamera){const r=i.object.position;t.copy(r).sub(i.target);let a=t.length();a*=Math.tan(i.object.fov/2*Math.PI/180),O(2*e*a/s.clientHeight,i.object.matrix),N(2*n*a/s.clientHeight,i.object.matrix)}else i.object.isOrthographicCamera?(O(e*(i.object.right-i.object.left)/i.object.zoom/s.clientWidth,i.object.matrix),N(n*(i.object.top-i.object.bottom)/i.object.zoom/s.clientHeight,i.object.matrix)):i.enablePan=!1}}();function z(t){i.object.isPerspectiveCamera||i.object.isOrthographicCamera?h/=t:i.enableZoom=!1}function U(t){i.object.isPerspectiveCamera||i.object.isOrthographicCamera?h*=t:i.enableZoom=!1}function F(t,e){if(!i.zoomToCursor)return;C=!0;const n=i.domElement.getBoundingClientRect(),s=t-n.left,r=e-n.top,a=n.width,o=n.height;A.x=s/a*2-1,A.y=-r/o*2+1,T.set(A.x,A.y,1).unproject(i.object).sub(i.object.position).normalize()}function G(t){return Math.max(i.minDistance,Math.min(i.maxDistance,t))}function V(t){c.set(t.clientX,t.clientY)}function H(t){p.set(t.clientX,t.clientY)}function j(t){if(1===I.length)c.set(t.pageX,t.pageY);else{const e=st(t),i=.5*(t.pageX+e.x),n=.5*(t.pageY+e.y);c.set(i,n)}}function W(t){if(1===I.length)p.set(t.pageX,t.pageY);else{const e=st(t),i=.5*(t.pageX+e.x),n=.5*(t.pageY+e.y);p.set(i,n)}}function X(t){const e=st(t),i=t.pageX-e.x,n=t.pageY-e.y,s=Math.sqrt(i*i+n*n);g.set(0,s)}function q(t){if(1==I.length)u.set(t.pageX,t.pageY);else{const e=st(t),i=.5*(t.pageX+e.x),n=.5*(t.pageY+e.y);u.set(i,n)}d.subVectors(u,c).multiplyScalar(i.rotateSpeed);const e=i.domElement;D(2*Math.PI*d.x/e.clientHeight),L(2*Math.PI*d.y/e.clientHeight),c.copy(u)}function Y(t){if(1===I.length)m.set(t.pageX,t.pageY);else{const e=st(t),i=.5*(t.pageX+e.x),n=.5*(t.pageY+e.y);m.set(i,n)}f.subVectors(m,p).multiplyScalar(i.panSpeed),B(f.x,f.y),p.copy(m)}function J(t){const e=st(t),n=t.pageX-e.x,s=t.pageY-e.y,r=Math.sqrt(n*n+s*s);v.set(0,r),y.set(0,Math.pow(v.y/g.y,i.zoomSpeed)),z(y.y),g.copy(v);F(.5*(t.pageX+e.x),.5*(t.pageY+e.y))}function $(t){!1!==i.enabled&&(0===I.length&&(i.domElement.setPointerCapture(t.pointerId),i.domElement.addEventListener("pointermove",K),i.domElement.addEventListener("pointerup",Z)),function(t){I.push(t.pointerId)}(t),"touch"===t.pointerType?function(t){switch(nt(t),I.length){case 1:switch(i.touches.ONE){case w:if(!1===i.enableRotate)return;j(t),s=n.TOUCH_ROTATE;break;case M:if(!1===i.enablePan)return;W(t),s=n.TOUCH_PAN;break;default:s=n.NONE}break;case 2:switch(i.touches.TWO){case S:if(!1===i.enableZoom&&!1===i.enablePan)return;!function(t){i.enableZoom&&X(t),i.enablePan&&W(t)}(t),s=n.TOUCH_DOLLY_PAN;break;case E:if(!1===i.enableZoom&&!1===i.enableRotate)return;!function(t){i.enableZoom&&X(t),i.enableRotate&&j(t)}(t),s=n.TOUCH_DOLLY_ROTATE;break;default:s=n.NONE}break;default:s=n.NONE}s!==n.NONE&&i.dispatchEvent(jg)}(t):function(t){let e;switch(t.button){case 0:e=i.mouseButtons.LEFT;break;case 1:e=i.mouseButtons.MIDDLE;break;case 2:e=i.mouseButtons.RIGHT;break;default:e=-1}switch(e){case b:if(!1===i.enableZoom)return;!function(t){F(t.clientX,t.clientX),g.set(t.clientX,t.clientY)}(t),s=n.DOLLY;break;case x:if(t.ctrlKey||t.metaKey||t.shiftKey){if(!1===i.enablePan)return;H(t),s=n.PAN}else{if(!1===i.enableRotate)return;V(t),s=n.ROTATE}break;case _:if(t.ctrlKey||t.metaKey||t.shiftKey){if(!1===i.enableRotate)return;V(t),s=n.ROTATE}else{if(!1===i.enablePan)return;H(t),s=n.PAN}break;default:s=n.NONE}s!==n.NONE&&i.dispatchEvent(jg)}(t))}function K(t){!1!==i.enabled&&("touch"===t.pointerType?function(t){switch(nt(t),s){case n.TOUCH_ROTATE:if(!1===i.enableRotate)return;q(t),i.update();break;case n.TOUCH_PAN:if(!1===i.enablePan)return;Y(t),i.update();break;case n.TOUCH_DOLLY_PAN:if(!1===i.enableZoom&&!1===i.enablePan)return;!function(t){i.enableZoom&&J(t),i.enablePan&&Y(t)}(t),i.update();break;case n.TOUCH_DOLLY_ROTATE:if(!1===i.enableZoom&&!1===i.enableRotate)return;!function(t){i.enableZoom&&J(t),i.enableRotate&&q(t)}(t),i.update();break;default:s=n.NONE}}(t):function(t){switch(s){case n.ROTATE:if(!1===i.enableRotate)return;!function(t){u.set(t.clientX,t.clientY),d.subVectors(u,c).multiplyScalar(i.rotateSpeed);const e=i.domElement;D(2*Math.PI*d.x/e.clientHeight),L(2*Math.PI*d.y/e.clientHeight),c.copy(u),i.update()}(t);break;case n.DOLLY:if(!1===i.enableZoom)return;!function(t){v.set(t.clientX,t.clientY),y.subVectors(v,g),y.y>0?z(P(y.y)):y.y<0&&U(P(y.y)),g.copy(v),i.update()}(t);break;case n.PAN:if(!1===i.enablePan)return;!function(t){m.set(t.clientX,t.clientY),f.subVectors(m,p).multiplyScalar(i.panSpeed),B(f.x,f.y),p.copy(m),i.update()}(t)}}(t))}function Z(t){!function(t){delete R[t.pointerId];for(let e=0;e<I.length;e++)if(I[e]==t.pointerId)return void I.splice(e,1)}(t),0===I.length&&(i.domElement.releasePointerCapture(t.pointerId),i.domElement.removeEventListener("pointermove",K),i.domElement.removeEventListener("pointerup",Z)),i.dispatchEvent(Wg),s=n.NONE}function Q(t){!1!==i.enabled&&!1!==i.enableZoom&&s===n.NONE&&(t.preventDefault(),i.dispatchEvent(jg),function(t){F(t.clientX,t.clientY),t.deltaY<0?U(P(t.deltaY)):t.deltaY>0&&z(P(t.deltaY)),i.update()}(function(t){const e=t.deltaMode,i={clientX:t.clientX,clientY:t.clientY,deltaY:t.deltaY};switch(e){case 1:i.deltaY*=16;break;case 2:i.deltaY*=100}t.ctrlKey&&!k&&(i.deltaY*=10);return i}(t)),i.dispatchEvent(Wg))}function tt(t){"Control"===t.key&&(k=!1,document.removeEventListener("keyup",tt,{passive:!0,capture:!0}))}function et(t){!1!==i.enabled&&!1!==i.enablePan&&function(t){let e=!1;switch(t.code){case i.keys.UP:t.ctrlKey||t.metaKey||t.shiftKey?L(2*Math.PI*i.rotateSpeed/i.domElement.clientHeight):B(0,i.keyPanSpeed),e=!0;break;case i.keys.BOTTOM:t.ctrlKey||t.metaKey||t.shiftKey?L(-2*Math.PI*i.rotateSpeed/i.domElement.clientHeight):B(0,-i.keyPanSpeed),e=!0;break;case i.keys.LEFT:t.ctrlKey||t.metaKey||t.shiftKey?D(2*Math.PI*i.rotateSpeed/i.domElement.clientHeight):B(i.keyPanSpeed,0),e=!0;break;case i.keys.RIGHT:t.ctrlKey||t.metaKey||t.shiftKey?D(-2*Math.PI*i.rotateSpeed/i.domElement.clientHeight):B(-i.keyPanSpeed,0),e=!0}e&&(t.preventDefault(),i.update())}(t)}function it(t){!1!==i.enabled&&t.preventDefault()}function nt(t){let e=R[t.pointerId];void 0===e&&(e=new se,R[t.pointerId]=e),e.set(t.pageX,t.pageY)}function st(t){const e=t.pointerId===I[0]?I[1]:I[0];return R[e]}i.domElement.addEventListener("contextmenu",it),i.domElement.addEventListener("pointerdown",$),i.domElement.addEventListener("pointercancel",Z),i.domElement.addEventListener("wheel",Q,{passive:!1}),document.addEventListener("keydown",(function(t){"Control"===t.key&&(k=!0,document.addEventListener("keyup",tt,{passive:!0,capture:!0}))}),{passive:!0,capture:!0}),this.update()}}var $g;!function(t){t[t.Close=0]="Close",t[t.Long=1]="Long",t[t.Target=2]="Target",t[t.Edit=3]="Edit",t[t.Play=4]="Play",t[t.PlayDone=5]="PlayDone"}($g||($g={}));class Kg extends jn{constructor(t,e,i,n,s,r,a,o,h,l,c){super(75,t.Width/t.Height,.1,800),this.player=e,this.terrainer=i,this.npcs=n,this.brick=s,this.legos=r,this.nonlegos=a,this.portal=o,this.farmer=h,this.carp=l,this.eventCtrl=c,this.animate=[],this.cityPos=new Le(-40,50,100),this.longPos=new Le(16,24,79),this.shortPos=new Le(0,0,0),this.debugMode=!1,this.backup=new Le,t.RegisterViewer(this),this.controls=new Jg(this,t.Canvas),this.bakRotation=(new bi).copy(this.rotation.set(-.27,0,.03)),this.viewMode=$g.Long,this.position.set(this.longPos.x,this.longPos.y,this.longPos.z),this.eventCtrl.RegisterAppModeEvent(((t,e,i)=>{var n,s;switch(this.controls.enabled=!1,this.animate&&this.animate.forEach((t=>t.kill())),this.timeline&&this.timeline.kill(),t){case DP.Intro:if(e==Lu.Start){this.viewMode=$g.Long,this.eventCtrl.OnChangeCtrlObjEvent(this.portal),this.rotation.set(this.bakRotation.x,this.bakRotation.y,this.bakRotation.z),this.rotation.x=-Math.PI/4,this.position.set(this.cityPos.x,this.cityPos.y,this.cityPos.z),this.timeline&&this.timeline.kill(),this.timeline=Vg.timeline(),this.timeline.to(this.cityPos,{x:10,y:30,z:this.portal.CannonPos.z+50,duration:10,ease:"power1.inOut",onUpdate:()=>{this.rotation.set(this.bakRotation.x,this.bakRotation.y,this.bakRotation.z),this.position.set(this.cityPos.x,this.cityPos.y,this.cityPos.z)}}).to(this.cityPos,{x:this.portal.CannonPos.x+10,z:this.portal.CannonPos.z+30,duration:10,ease:"power1.inOut",onUpdate:()=>{this.rotation.set(this.bakRotation.x,this.bakRotation.y,this.bakRotation.z),this.position.set(this.cityPos.x,this.cityPos.y,this.cityPos.z),this.lookAt(this.portal.CannonPos)}});const t=this.npcs.Owner;if(null==t)break;this.timeline.to(this.cityPos,{x:t.CannonPos.x,y:20,z:t.CannonPos.z+20,duration:10,ease:"power1.inOut",onStart:()=>{},onUpdate:()=>{this.rotation.set(this.bakRotation.x,this.bakRotation.y,this.bakRotation.z),this.position.set(this.cityPos.x,this.cityPos.y,this.cityPos.z),this.lookAt(t.CannonPos)}})}break;case DP.CityView:e==Lu.Start&&(this.viewMode=$g.Long,this.eventCtrl.OnChangeCtrlObjEvent(this.portal),this.rotation.set(this.bakRotation.x,this.bakRotation.y,this.bakRotation.z),this.rotation.x=-Math.PI/4,this.position.set(this.cityPos.x,this.cityPos.y,this.cityPos.z),this.animate.push(Vg.to(this.cityPos,{x:16,y:30,z:50,duration:10,ease:"power1.inOut",onUpdate:()=>{this.rotation.set(this.bakRotation.x,this.bakRotation.y,this.bakRotation.z),this.position.set(this.cityPos.x,this.cityPos.y,this.cityPos.z)}})),this.animate.push(Vg.to(this.rotation,{x:-.5,y:0,z:0,duration:10,ease:"power1.inOut"})));break;case DP.EditCity:e==Lu.Start&&(this.viewMode=$g.Target,this.target=this.terrainer.Meshs,this.focusAt(this.terrainer.CannonPos,new Le(0,40,50)));break;case DP.Portal:e==Lu.Start&&(this.viewMode=$g.Target,this.target=this.portal.Meshs,this.focusAt(this.portal.CannonPos,new Le(0,30,30)));break;case DP.Furniture:if(e==Lu.Start){if(this.viewMode=$g.Target,this.target=null===(n=this.carp.target)||void 0===n?void 0:n.Meshs,!this.target)break;this.focusAt(this.target.position)}break;case DP.Farmer:if(e==Lu.Start){if(this.viewMode=$g.Target,this.target=null===(s=this.farmer.target)||void 0===s?void 0:s.Meshs,!this.target)break;this.focusAt(this.target.position)}break;case DP.NonLego:e==Lu.Start?(this.backup.copy(this.position),this.viewMode=$g.Edit,this.target=this.nonlegos.GetBrickGuide(this.player.CenterPos),this.focusAt(this.target.position)):e==Lu.End&&(this.position.copy(this.backup),this.focusAt(this.player.CenterPos));break;case DP.LegoDelete:case DP.Lego:e==Lu.Start?(this.backup.copy(this.position),this.viewMode=$g.Edit,this.target=this.legos.GetBrickGuide(this.player.CenterPos),this.focusAt(this.target.position)):e==Lu.End&&(this.position.copy(this.backup),this.focusAt(this.player.CenterPos));break;case DP.Brick:e==Lu.Start&&(this.viewMode=$g.Target,this.target=this.brick.GetBrickGuide(this.player.CenterPos),this.focusAt(this.target.position));break;case DP.EditPlay:e==Lu.Start&&(this.viewMode=$g.Target,this.target=this.player.Meshs,this.focusAt(this.target.position));break;case DP.Play:if(e==Lu.Start){this.viewMode=$g.Play,this.rotation.set(this.bakRotation.x,this.bakRotation.y,this.bakRotation.z),this.rotation.x=-Math.PI/4;const t=this.player.CannonPos;this.animate.push(Vg.to(this.position,{x:t.x,y:t.y+13,z:t.z+13,duration:2,ease:"power1.inOut",onComplete:()=>{this.position.set(t.x,t.y,t.z),this.shortPos.set(0,13,13),this.lookAt(t.x,t.y,t.z),this.viewMode=$g.PlayDone}}))}break;case DP.Close:if(e==Lu.Start){if(this.viewMode=$g.Close,this.owner=this.npcs.Owner,null==this.owner)return;this.focusAt(this.owner.CannonPos)}break;case DP.Long:i&&i[0]?this.controls.enabled=!0:this.controls.enabled=!1,e==Lu.Start&&(this.viewMode=$g.Long,this.rotation.set(this.bakRotation.x,this.bakRotation.y,this.bakRotation.z),this.rotation.x=-Math.PI/4,this.position.set(this.longPos.x,this.longPos.y,this.longPos.z),this.animate.push(Vg.to(this.longPos,{x:16,y:4,z:36,duration:4,ease:"power1.inOut",onUpdate:()=>{this.rotation.set(this.bakRotation.x,this.bakRotation.y,this.bakRotation.z),this.position.set(this.longPos.x,this.longPos.y,this.longPos.z)}})))}}))}resize(t,e){this.aspect=t/e,this.updateProjectionMatrix()}focusAt(t,e){this.rotation.copy(this.bakRotation),this.rotation.x=-Math.PI/4,this.position.copy(t),this.lookAt(t),e?this.shortPos.copy(e):this.shortPos.set(0,13,13)}update(){var t,e,i;switch(this.viewMode){case $g.Edit:{const e=null===(t=this.target)||void 0===t?void 0:t.position;if(null==e)return;this.controls.enabled=!0,this.controls.update(),this.lookAt(e);break}case $g.Target:{const t=null===(e=this.target)||void 0===e?void 0:e.position;if(null==t)return;if(this.debugMode)return this.controls.enabled=!0,void this.controls.update();this.controls.enabled=!1,this.rotation.x=-Math.PI/4,this.position.set(t.x+this.shortPos.x,t.y+this.shortPos.y,t.z+this.shortPos.z);break}case $g.Close:{const t=null===(i=this.owner)||void 0===i?void 0:i.CannonPos;if(null==t)return;this.rotation.x=-Math.PI/4,this.position.set(t.x+this.shortPos.x,t.y+this.shortPos.y,t.z+this.shortPos.z);break}case $g.Long:this.controls.enabled&&this.controls.update();break;case $g.Play:break;case $g.PlayDone:const n=this.player.CannonPos;this.rotation.x=-Math.PI/4,this.position.set(n.x+this.shortPos.x,n.y+this.shortPos.y,n.z+this.shortPos.z)}}}class Zg extends Ua{constructor(t,e,i){super({antialias:!0,canvas:i.Canvas}),this.camera=t,this.scene=e,ye.enabled=!0,this.outputColorSpace=It,this.shadowMap.enabled=!0,this.shadowMap.type=A,this.setClearColor(6737151,1),this.setSize(i.Width,i.Height),this.setPixelRatio(Math.min(window.devicePixelRatio,2)),i.RegisterViewer(this)}setScene(t){this.scene=t}resize(t,e){this.setSize(t,e),this.setPixelRatio(Math.min(window.devicePixelRatio,2))}update(){this.render(this.scene,this.camera)}}class Qg extends Dc{constructor(){super(16777215,2);const t=Du.StartPosition;this.position.set(t.x+100,200,t.z+30),this.target.position.set(t.x,3,t.z),this.castShadow=!0,this.shadow.radius=1e3,this.shadow.mapSize.width=4096,this.shadow.mapSize.height=4096,this.shadow.camera.near=1,this.shadow.camera.far=1e3,this.shadow.camera.left=500,this.shadow.camera.right=-500,this.shadow.camera.top=500,this.shadow.camera.bottom=-500}resize(){}update(){}}const tv="bold 14pt sans-serif";class ev extends ao{get Mesh(){return this}constructor(t,e){const i=document.createElement("canvas");let n=i.getContext("2d");if(null==n)return;n.font=tv;const s=n.measureText(t),r=s.width,a=s.fontBoundingBoxAscent+s.fontBoundingBoxDescent;if(i.width=r,i.height=a,n=i.getContext("2d"),null==n)return;n.font=tv,n.fillStyle=e,n.shadowOffsetX=3,n.shadowOffsetY=3,n.shadowBlur=2,n.textAlign="center",n.textBaseline="middle",n.fillText(t,r/2,a/2,r);const o=new vh(n.canvas);super(new Xa({map:o,color:16777215,fog:!1})),this.processFlag=!1,this.v=1e-4,this.scale.set(1,1,1),this.position.y=3.3,this.position.z=.5,this.params_=t,this.visible_=!0,this.visible=!1}Destroy(){this.traverse((t=>{if(t instanceof On){if(t.material){let e=t.material;t.material instanceof Array||(e=[t.material]);for(let t of e)t.dispose()}t.geometry&&t.geometry.dispose()}})),this.parent&&this.parent.remove(this)}InitComponent(){}OnDeath_(){this.Destroy()}Start(t,e){this.visible=!0,this.SetText(t,e),this.position.set(ne.randFloatSpread(1),3.3,.5),this.material.opacity=1,this.v=1e-4,this.processFlag=!0}Complete(){this.visible=!1,this.processFlag=!1}Update(t){this.processFlag&&(this.position.y+=.5*t,this.v+=.001,this.material.opacity-=this.v,this.material.opacity<0&&this.Complete())}SetText(t,e){if(!this.visible_)return;const i=document.createElement("canvas");if(this.material.dispose(),this.params_=t,null==i)return;const n=i.getContext("2d");if(null==n)return;n.font=tv;const s=n.measureText(t),r=s.width,a=s.fontBoundingBoxAscent+s.fontBoundingBoxDescent;i.width=r+10,i.height=a;const o=i.getContext("2d");if(null==o)return;o.font=tv,o.shadowOffsetX=1,o.shadowOffsetY=1,o.shadowColor="rgba(0, 0, 0, 1)",o.shadowBlur=0,o.fillStyle=e,o.textAlign="center",o.textBaseline="middle",o.fillText(t,r/2,a/2,r);const h=new vh(o.canvas);this.renderOrder=99,this.material=new Xa({map:h,color:16777215,fog:!1,transparent:!0,depthTest:!1,depthWrite:!1})}}class iv{get Mesh(){return this.points}constructor(t,e,i){this.material=new ch({size:.1,vertexColors:!0,transparent:!0,opacity:1,depthTest:!1}),this.geometry=new vn,this.count=30,this.delta=[],this.velocity=5+Math.random(),this.processFlag=!1,this.v=.1;const n=[],s=[],r=new Zi;r.setRGB(t,e,i);for(let t=0;t<this.count;t++){const e=new Le(0,0,0),i=Math.random()*Math.PI*2,a=2*Math.random();e.x=this.velocity*Math.sin(i)*Math.cos(a),e.y=this.velocity*Math.sin(i)*Math.sin(a),e.z=this.velocity*Math.cos(i)*5,this.delta.push(e),n.push(0,0,0,t),s.push(r.r,r.g,r.b,t)}this.geometry.setAttribute("position",new ln(n,4)),this.geometry.setAttribute("color",new ln(s,4)),this.points=new fh(this.geometry,this.material),this.points.visible=!1,this.points.geometry.attributes.color.needsUpdate=!0}Start(){const t=this.points.geometry.attributes.position;this.material.opacity=1,this.v=.001;for(let e=0;e<this.delta.length;e++)t.setX(e,0),t.setY(e,0),t.setZ(e,1);this.points.visible=!0,this.processFlag=!0}Complet(){this.points.visible=!1,this.processFlag=!1}Update(t){if(this.material.opacity<=0||!this.processFlag)return;const e=this.points.geometry.attributes.position;for(let i=0;i<this.delta.length;i++){const n=e.getX(i),s=e.getY(i),r=e.getZ(i);e.setX(i,n+this.delta[i].x*t),e.setY(i,s+this.delta[i].y*t),e.setZ(i,r-Math.abs(this.delta[i].z*this.v)*t)}this.v+=.1,this.material.opacity-=2*t,this.material.opacity<=0&&this.Complet(),e.needsUpdate=!0}}class nv{constructor(){this.process=!1,this.startTime=0,this.start=new Le,this.end=this.start.clone(),this.count=10,this.end.y+=10;const t=new vn,e=this.lightning(this.start,this.end,ne.randInt(5,8),this.count);t.setFromPoints(e);const i=[],n=ne.randInt(Math.random(),.1),s=ne.randInt(.6,1),r=ne.randInt(0,.8);for(let t=0;t<e.length;t++)i.push(n,s,r);t.setAttribute("color",new ln(i,3));const a=os.points,o=Gn.clone(a.uniforms),h=new Image;o.map.value=new Ae(h),h.onload=()=>{o.map.value.needsUpdate=!0},h.src="assets/texture/particle.png";const l=ne.randInt(2,3);o.size.value=l,o.scale.value=40,this.points=new fh(t,new Vn({uniforms:o,defines:{USE_COLOR:"",USE_MAP:"",USE_SIZEATTENUATION:""},transparent:!0,depthWrite:!1,depthTest:!1,blending:2,vertexShader:a.vertexShader,fragmentShader:a.fragmentShader})),this.points.visible=!1}Start(){this.points.visible=!0,this.start.set(0,0,0),this.end.copy(this.start),this.end.y+=5,this.process=!0}Update(t){if(!this.process)return;const e=this.points.geometry,i=this.lightning(this.start,this.end,ne.randInt(6,10),this.count);e.setFromPoints(i),e.attributes.position.needsUpdate=!0,this.startTime+=t,this.startTime>1&&(this.process=!1,this.points.visible=!1)}lightning(t,e,i,n){let s,r,a,o,h=[t,e],l=[];if(n=n||100,i<1)return h;for(;i--;){for(o=h.length;o--;){if(t=h[o],o<1){l.push(t);break}e=h[o-1],s=t.clone().lerp(e,.5),a=new Le(ne.randInt(-1,1),ne.randInt(-1,1),ne.randInt(-1,1)),r=a.cross(e.clone().sub(t).normalize()),s.add(r.multiplyScalar(ne.randInt(-n,n))),l.push(t,s)}h=l.splice(0),n/=2}return h}getPositions(t,e,i){let n=[];if(!t)return n;let s,r,a,o=e,h=new Le,l=h.clone(),c=h.clone();for(;o--;){if(h.set(t.getX(o),t.getY(o),t.getZ(o)),c.set(h.x,h.y,h.z),o<1){n.push(c.x,c.y,c.z);break}for(l.set(t.getX(o-1),t.getY(o-1),t.getZ(o-1)),s=c.distanceTo(l),r=s*i|0,a=0;a<r;a++)c.set(h.x,h.y,h.z),c.lerp(l,a/r),n.push(c.x,c.y,c.z)}return n}}var sv=rs;function rv(){rv=function(){return e};var t,e={},i=Object.prototype,n=i.hasOwnProperty,s=Object.defineProperty||function(t,e,i){t[e]=i.value},r="function"==typeof Symbol?Symbol:{},a=r.iterator||"@@iterator",o=r.asyncIterator||"@@asyncIterator",h=r.toStringTag||"@@toStringTag";function l(t,e,i){return Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{l({},"")}catch(t){l=function(t,e,i){return t[e]=i}}function c(t,e,i,n){var r=e&&e.prototype instanceof v?e:v,a=Object.create(r.prototype),o=new R(n||[]);return s(a,"_invoke",{value:T(t,i,o)}),a}function u(t,e,i){try{return{type:"normal",arg:t.call(e,i)}}catch(t){return{type:"throw",arg:t}}}e.wrap=c;var d="suspendedStart",p="suspendedYield",m="executing",f="completed",g={};function v(){}function y(){}function x(){}var b={};l(b,a,(function(){return this}));var _=Object.getPrototypeOf,w=_&&_(_(k([])));w&&w!==i&&n.call(w,a)&&(b=w);var M=x.prototype=v.prototype=Object.create(b);function S(t){["next","throw","return"].forEach((function(e){l(t,e,(function(t){return this._invoke(e,t)}))}))}function E(t,e){function i(s,r,a,o){var h=u(t[s],t,r);if("throw"!==h.type){var l=h.arg,c=l.value;return c&&"object"==typeof c&&n.call(c,"__await")?e.resolve(c.__await).then((function(t){i("next",t,a,o)}),(function(t){i("throw",t,a,o)})):e.resolve(c).then((function(t){l.value=t,a(l)}),(function(t){return i("throw",t,a,o)}))}o(h.arg)}var r;s(this,"_invoke",{value:function(t,n){function s(){return new e((function(e,s){i(t,n,e,s)}))}return r=r?r.then(s,s):s()}})}function T(e,i,n){var s=d;return function(r,a){if(s===m)throw new Error("Generator is already running");if(s===f){if("throw"===r)throw a;return{value:t,done:!0}}for(n.method=r,n.arg=a;;){var o=n.delegate;if(o){var h=A(o,n);if(h){if(h===g)continue;return h}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(s===d)throw s=f,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);s=m;var l=u(e,i,n);if("normal"===l.type){if(s=n.done?f:p,l.arg===g)continue;return{value:l.arg,done:n.done}}"throw"===l.type&&(s=f,n.method="throw",n.arg=l.arg)}}}function A(e,i){var n=i.method,s=e.iterator[n];if(s===t)return i.delegate=null,"throw"===n&&e.iterator.return&&(i.method="return",i.arg=t,A(e,i),"throw"===i.method)||"return"!==n&&(i.method="throw",i.arg=new TypeError("The iterator does not provide a '"+n+"' method")),g;var r=u(s,e.iterator,i.arg);if("throw"===r.type)return i.method="throw",i.arg=r.arg,i.delegate=null,g;var a=r.arg;return a?a.done?(i[e.resultName]=a.value,i.next=e.nextLoc,"return"!==i.method&&(i.method="next",i.arg=t),i.delegate=null,g):a:(i.method="throw",i.arg=new TypeError("iterator result is not an object"),i.delegate=null,g)}function C(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function I(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function R(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(C,this),this.reset(!0)}function k(e){if(e||""===e){var i=e[a];if(i)return i.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var s=-1,r=function i(){for(;++s<e.length;)if(n.call(e,s))return i.value=e[s],i.done=!1,i;return i.value=t,i.done=!0,i};return r.next=r}}throw new TypeError(typeof e+" is not iterable")}return y.prototype=x,s(M,"constructor",{value:x,configurable:!0}),s(x,"constructor",{value:y,configurable:!0}),y.displayName=l(x,h,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===y||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,x):(t.__proto__=x,l(t,h,"GeneratorFunction")),t.prototype=Object.create(M),t},e.awrap=function(t){return{__await:t}},S(E.prototype),l(E.prototype,o,(function(){return this})),e.AsyncIterator=E,e.async=function(t,i,n,s,r){void 0===r&&(r=Promise);var a=new E(c(t,i,n,s),r);return e.isGeneratorFunction(i)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},S(M),l(M,h,"Generator"),l(M,a,(function(){return this})),l(M,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),i=[];for(var n in e)i.push(n);return i.reverse(),function t(){for(;i.length;){var n=i.pop();if(n in e)return t.value=n,t.done=!1,t}return t.done=!0,t}},e.values=k,R.prototype={constructor:R,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(I),!e)for(var i in this)"t"===i.charAt(0)&&n.call(this,i)&&!isNaN(+i.slice(1))&&(this[i]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var i=this;function s(n,s){return o.type="throw",o.arg=e,i.next=n,s&&(i.method="next",i.arg=t),!!s}for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r],o=a.completion;if("root"===a.tryLoc)return s("end");if(a.tryLoc<=this.prev){var h=n.call(a,"catchLoc"),l=n.call(a,"finallyLoc");if(h&&l){if(this.prev<a.catchLoc)return s(a.catchLoc,!0);if(this.prev<a.finallyLoc)return s(a.finallyLoc)}else if(h){if(this.prev<a.catchLoc)return s(a.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return s(a.finallyLoc)}}}},abrupt:function(t,e){for(var i=this.tryEntries.length-1;i>=0;--i){var s=this.tryEntries[i];if(s.tryLoc<=this.prev&&n.call(s,"finallyLoc")&&this.prev<s.finallyLoc){var r=s;break}}r&&("break"===t||"continue"===t)&&r.tryLoc<=e&&e<=r.finallyLoc&&(r=null);var a=r?r.completion:{};return a.type=t,a.arg=e,r?(this.method="next",this.next=r.finallyLoc,g):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),g},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var i=this.tryEntries[e];if(i.finallyLoc===t)return this.complete(i.completion,i.afterLoc),I(i),g}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var i=this.tryEntries[e];if(i.tryLoc===t){var n=i.completion;if("throw"===n.type){var s=n.arg;I(i)}return s}}throw new Error("illegal catch attempt")},delegateYield:function(e,i,n){return this.delegate={iterator:k(e),resultName:i,nextLoc:n},"next"===this.method&&(this.arg=t),g}},e}function av(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function ov(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,bv(n.key),n)}}function hv(t,e,i){return e&&ov(t.prototype,e),i&&ov(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}function lv(t,e,i){return(e=bv(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function cv(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&dv(t,e)}function uv(t){return uv=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},uv(t)}function dv(t,e){return dv=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},dv(t,e)}function pv(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function mv(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var i,n=uv(t);if(e){var s=uv(this).constructor;i=Reflect.construct(n,arguments,s)}else i=n.apply(this,arguments);return function(t,e){if(e&&("object"==typeof e||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return pv(t)}(this,i)}}function fv(){return fv="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(t,e,i){var n=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=uv(t)););return t}(t,e);if(n){var s=Object.getOwnPropertyDescriptor(n,e);return s.get?s.get.call(arguments.length<3?t:i):s.value}},fv.apply(this,arguments)}function gv(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var i=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=i){var n,s,r,a,o=[],h=!0,l=!1;try{if(r=(i=i.call(t)).next,0===e){if(Object(i)!==i)return;h=!1}else for(;!(h=(n=r.call(i)).done)&&(o.push(n.value),o.length!==e);h=!0);}catch(t){l=!0,s=t}finally{try{if(!h&&null!=i.return&&(a=i.return(),Object(a)!==a))return}finally{if(l)throw s}}return o}}(t,e)||vv(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function vv(t,e){if(t){if("string"==typeof t)return yv(t,e);var i=Object.prototype.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?yv(t,e):void 0}}function yv(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=new Array(e);i<e;i++)n[i]=t[i];return n}function xv(t,e){var i="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!i){if(Array.isArray(t)||(i=vv(t))||e&&t&&"number"==typeof t.length){i&&(t=i);var n=0,s=function(){};return{s,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:s}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,a=!0,o=!1;return{s:function(){i=i.call(t)},n:function(){var t=i.next();return a=t.done,t},e:function(t){o=!0,r=t},f:function(){try{a||null==i.return||i.return()}finally{if(o)throw r}}}}function bv(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:String(e)}var _v=function(t){cv(i,t);var e=mv(i);function i(t){var n;return av(this,i),lv(pv(n=e.call(this)),"type","ParticleEmitter"),lv(pv(n),"system",void 0),n.system=t,n}return hv(i,[{key:"clone",value:function(){var t=this.system.clone();return t.emitter.copy(this,!0),t.emitter}},{key:"dispose",value:function(){}},{key:"extractFromCache",value:function(t){var e=[];for(var i in t){var n=t[i];delete n.metadata,e.push(n)}return e}},{key:"toJSON",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=void 0===t||"string"==typeof t,n={};i&&(t={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},n.metadata={version:4.5,type:"Object",generator:"Object3D.toJSON"});var s={};if(s.uuid=this.uuid,s.type=this.type,""!==this.name&&(s.name=this.name),!0===this.castShadow&&(s.castShadow=!0),!0===this.receiveShadow&&(s.receiveShadow=!0),!1===this.visible&&(s.visible=!1),!1===this.frustumCulled&&(s.frustumCulled=!1),0!==this.renderOrder&&(s.renderOrder=this.renderOrder),"{}"!==JSON.stringify(this.userData)&&(s.userData=this.userData),s.layers=this.layers.mask,s.matrix=this.matrix.toArray(),!1===this.matrixAutoUpdate&&(s.matrixAutoUpdate=!1),null!==this.system&&(s.ps=this.system.toJSON(t,e)),this.children.length>0){s.children=[];for(var r=0;r<this.children.length;r++)"ParticleSystemPreview"!==this.children[r].type&&s.children.push(this.children[r].toJSON(t).object)}if(i){var a=this.extractFromCache(t.geometries),o=this.extractFromCache(t.materials),h=this.extractFromCache(t.textures),l=this.extractFromCache(t.images);a.length>0&&(n.geometries=a),o.length>0&&(n.materials=o),h.length>0&&(n.textures=h),l.length>0&&(n.images=l)}return n.object=s,n}}]),i}(Oi),wv=function(){function t(e){av(this,t),lv(this,"data",void 0),lv(this,"next",void 0),lv(this,"prev",void 0),this.data=e,this.next=null,this.prev=null}return hv(t,[{key:"hasPrev",value:function(){return null!==this.prev}},{key:"hasNext",value:function(){return null!==this.next}}]),t}(),Mv=function(){function t(){av(this,t),lv(this,"length",void 0),lv(this,"head",void 0),lv(this,"tail",void 0),this.length=0,this.head=this.tail=null}return hv(t,[{key:"isEmpty",value:function(){return null===this.head}},{key:"clear",value:function(){this.length=0,this.head=this.tail=null}},{key:"front",value:function(){return null===this.head?null:this.head.data}},{key:"back",value:function(){return null===this.tail?null:this.tail.data}},{key:"dequeue",value:function(){if(this.head){var t=this.head.data;return this.head=this.head.next,this.head?this.head.prev=null:this.tail=null,this.length--,t}}},{key:"pop",value:function(){if(this.tail){var t=this.tail.data;return this.tail=this.tail.prev,this.tail?this.tail.next=null:this.head=null,this.length--,t}}},{key:"queue",value:function(t){var e=new wv(t);this.tail||(this.tail=e),this.head&&(this.head.prev=e,e.next=this.head),this.head=e,this.length++}},{key:"push",value:function(t){var e=new wv(t);this.head||(this.head=e),this.tail&&(this.tail.next=e,e.prev=this.tail),this.tail=e,this.length++}},{key:"insertBefore",value:function(t,e){var i=new wv(e);i.next=t,i.prev=t.prev,null!==i.prev&&(i.prev.next=i),i.next.prev=i,t==this.head&&(this.head=i),this.length++}},{key:"remove",value:function(t){if(null!==this.head&&null!==this.tail){var e=this.head;for(t===this.head.data&&(this.head=this.head.next),t===this.tail.data&&(this.tail=this.tail.prev);null!==e.next&&e.data!==t;)e=e.next;e.data===t&&(null!==e.prev&&(e.prev.next=e.next),null!==e.next&&(e.next.prev=e.prev),this.length--)}}},{key:"values",value:rv().mark((function t(){var e;return rv().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:e=this.head;case 1:if(null===e){t.next=7;break}return t.next=4,e.data;case 4:e=e.next,t.next=1;break;case 7:case"end":return t.stop()}}),t,this)}))}]),t}(),Sv=function(){function t(){av(this,t),lv(this,"parentMatrix",void 0),lv(this,"startSpeed",0),lv(this,"startColor",new Ce),lv(this,"startSize",1),lv(this,"position",new Le),lv(this,"velocity",new Le),lv(this,"age",0),lv(this,"life",1),lv(this,"size",1),lv(this,"speedModifier",1),lv(this,"angularVelocity",void 0),lv(this,"rotation",0),lv(this,"color",new Ce),lv(this,"uvTile",0)}return hv(t,[{key:"died",get:function(){return this.age>=this.life}}]),t}(),Ev=hv((function t(e,i,n){av(this,t),this.position=e,this.size=i,this.color=n})),Tv=function(){function t(){av(this,t),lv(this,"parentMatrix",void 0),lv(this,"startSpeed",0),lv(this,"startColor",new Ce),lv(this,"startSize",1),lv(this,"position",new Le),lv(this,"localPosition",void 0),lv(this,"velocity",new Le),lv(this,"age",0),lv(this,"life",1),lv(this,"size",1),lv(this,"length",100),lv(this,"speedModifier",1),lv(this,"color",new Ce),lv(this,"previous",new Mv),lv(this,"uvTile",0)}return hv(t,[{key:"update",value:function(){for(this.age<=this.life?this.previous.push(new Ev(this.position.clone(),this.size,this.color.clone())):this.previous.length>0&&this.previous.dequeue();this.previous.length>this.length;)this.previous.dequeue()}},{key:"died",get:function(){return this.age>=this.life}},{key:"reset",value:function(){this.previous.clear()}}]),t}(),Av=function(){function t(e,i,n,s){av(this,t),lv(this,"p",void 0),this.p=[e,i,n,s]}return hv(t,[{key:"genValue",value:function(t){var e=t*t,i=t*t*t,n=1-t,s=n*n,r=s*n;return this.p[0]*r+this.p[1]*s*t*3+this.p[2]*n*e*3+this.p[3]*i}},{key:"derivativeCoefficients",value:function(t){for(var e=[],i=t,n=i.length-1;n>0;n--){for(var s=[],r=0;r<n;r++){var a=n*(i[r+1]-i[r]);s.push(a)}e.push(s),i=s}return e}},{key:"getSlope",value:function(t){var e=this.derivativeCoefficients(this.p)[0],i=1-t,n=i*t*2,s=t*t;return i*i*e[0]+n*e[1]+s*e[2]}},{key:"controlCurve",value:function(t,e){this.p[1]=t/3+this.p[0],this.p[2]=this.p[3]-e/3}},{key:"hull",value:function(t){var e,i=this.p,n=[],s=0,r=0,a=0,o=[];for(o[s++]=i[0],o[s++]=i[1],o[s++]=i[2],o[s++]=i[3];i.length>1;){for(n=[],r=0,a=i.length-1;r<a;r++)e=t*i[r]+(1-t)*i[r+1],o[s++]=e,n.push(e);i=n}return o}},{key:"split",value:function(e){var i=this.hull(e);return{left:new t(i[0],i[4],i[7],i[9]),right:new t(i[9],i[8],i[6],i[3]),span:i}}},{key:"clone",value:function(){return new t(this.p[0],this.p[1],this.p[2],this.p[3])}},{key:"toJSON",value:function(){return{p0:this.p[0],p1:this.p[1],p2:this.p[2],p3:this.p[3]}}}],[{key:"fromJSON",value:function(e){return new t(e.p0,e.p1,e.p2,e.p3)}}]),t}(),Cv=function(t){return{r:t.x,g:t.y,b:t.z,a:t.w}},Iv=function(t){return new Ce(t.r,t.g,t.b,t.a)},Rv=function(t,e){switch(e){case"Vector3":return new Le(t.x,t.y,t.z);case"Vector4":return new Ce(t.x,t.y,t.z,t.w);case"Color":return new Le(t.r,t.g,t.b);default:return t}},kv=function(t,e){switch(e){case"Vector3":return{x:t.x,y:t.y,z:t.z};case"Vector4":return{x:t.x,y:t.y,z:t.z,w:t.w};case"Color":return{r:t.x,g:t.y,b:t.z};default:return t}},Pv=function(){function t(e,i){av(this,t),lv(this,"type",void 0),this.a=e,this.b=i,this.type="value"}return hv(t,[{key:"genColor",value:function(t){var e=Math.random();return t.copy(this.a).lerp(this.b,e)}},{key:"toJSON",value:function(){return{type:"RandomColor",a:Cv(this.a),b:Cv(this.b)}}},{key:"clone",value:function(){return new t(this.a.clone(),this.b.clone())}}],[{key:"fromJSON",value:function(e){return new t(Iv(e.a),Iv(e.b))}}]),t}(),Dv=function(){function t(e,i){av(this,t),lv(this,"type",void 0),this.a=e,this.b=i,this.type="value"}return hv(t,[{key:"genColor",value:function(t,e){return t.copy(this.a).lerp(this.b,Math.random())}},{key:"toJSON",value:function(){return{type:"ColorRange",a:Cv(this.a),b:Cv(this.b)}}},{key:"clone",value:function(){return new t(this.a.clone(),this.b.clone())}}],[{key:"fromJSON",value:function(e){return new t(Iv(e.a),Iv(e.b))}}]),t}(),Lv=function(){function t(e,i){av(this,t),lv(this,"keys",void 0),lv(this,"type",void 0),lv(this,"subType",void 0),this.subType=i,this.type="function",this.keys=e}return hv(t,[{key:"findKey",value:function(t){for(var e=0,i=0,n=this.keys.length-1;i+1<n;)if(e=Math.floor((i+n)/2),t<this.getStartX(e))n=e-1;else{if(!(t>this.getEndX(e)))return e;i=e+1}for(var s=i;s<=n;s++)if(t>=this.getStartX(s)&&t<=this.getEndX(s))return s;return-1}},{key:"getStartX",value:function(t){return this.keys[t][1]}},{key:"getEndX",value:function(t){return t+1<this.keys.length?this.keys[t+1][1]:1}},{key:"genValue",value:function(t,e){var i=this.findKey(e);return"Number"===this.subType?-1===i?this.keys[0][0]:i+1>=this.keys.length?this.keys[this.keys.length-1][0]:(this.keys[i+1][0]-this.keys[i][0])*((e-this.getStartX(i))/(this.getEndX(i)-this.getStartX(i)))+this.keys[i][0]:-1===i?t.copy(this.keys[0][0]):i+1>=this.keys.length?t.copy(this.keys[this.keys.length-1][0]):t.copy(this.keys[i][0]).lerp(this.keys[i+1][0],(e-this.getStartX(i))/(this.getEndX(i)-this.getStartX(i)))}},{key:"toJSON",value:function(){var t=this;return this.keys[0][0].constructor.name,{type:"CLinearFunction",subType:this.subType,keys:this.keys.map((function(e){var i=gv(e,2),n=i[0],s=i[1];return{value:kv(n,t.subType),pos:s}}))}}},{key:"clone",value:function(){return"Number"===this.subType?new t(this.keys.map((function(t){var e=gv(t,2);return[e[0],e[1]]})),this.subType):new t(this.keys.map((function(t){var e=gv(t,2),i=e[0],n=e[1];return[i.clone(),n]})),this.subType)}}],[{key:"fromJSON",value:function(e){return new t(e.keys.map((function(t){return[Rv(t.value,e.subType),t.pos]})),e.subType)}}]),t}(),Ov=new Le,Nv=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[[new Le(0,0,0),0],[new Le(1,1,1),0]],i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[[1,0],[1,1]];av(this,t),lv(this,"type",void 0),lv(this,"color",void 0),lv(this,"alpha",void 0),this.type="function",this.color=new Lv(e,"Color"),this.alpha=new Lv(i,"Number")}return hv(t,[{key:"genColor",value:function(t,e){return this.color.genValue(Ov,e),t.set(Ov.x,Ov.y,Ov.z,this.alpha.genValue(1,e))}},{key:"toJSON",value:function(){return{type:"Gradient",color:this.color.toJSON(),alpha:this.alpha.toJSON()}}},{key:"clone",value:function(){var e=new t;return e.alpha=this.alpha.clone(),e.color=this.color.clone(),e}}],[{key:"fromJSON",value:function(e){if(e.functions){var i=e.functions.map((function(t){return[Dv.fromJSON(t.function).a,t.start]}));return e.functions.length>0&&i.push([Dv.fromJSON(e.functions[e.functions.length-1].function).b,1]),new t(i.map((function(t){return[new Le(t[0].x,t[0].y,t[0].z),t[1]]})),i.map((function(t){return[t[0].w,t[1]]})))}var n=new t;return n.alpha=Lv.fromJSON(e.alpha),n.color=Lv.fromJSON(e.color),n}}]),t}(),Bv=new Ce,zv=function(){function t(e,i){av(this,t),lv(this,"gradient1",void 0),lv(this,"gradient2",void 0),lv(this,"type",void 0),this.type="memorizedFunction",this.gradient1=e,this.gradient2=i}return hv(t,[{key:"startGen",value:function(t){t.rand=Math.random()}},{key:"genColor",value:function(t,e,i){return this.gradient1.genColor(t,e),this.gradient2.genColor(Bv,e),i&&i.rand?t.lerp(Bv,i.rand):t.lerp(Bv,Math.random()),t}},{key:"toJSON",value:function(){return{type:"RandomColorBetweenGradient",gradient1:this.gradient1.toJSON(),gradient2:this.gradient2.toJSON()}}},{key:"clone",value:function(){return new t(this.gradient1.clone(),this.gradient2.clone())}}],[{key:"fromJSON",value:function(e){return new t(Nv.fromJSON(e.gradient1),Nv.fromJSON(e.gradient2))}}]),t}(),Uv=function(){function t(e){av(this,t),lv(this,"type",void 0),this.color=e,this.type="value"}return hv(t,[{key:"genColor",value:function(t){return t.copy(this.color)}},{key:"toJSON",value:function(){return{type:"ConstantColor",color:Cv(this.color)}}},{key:"clone",value:function(){return new t(this.color.clone())}}],[{key:"fromJSON",value:function(e){return new t(Iv(e.color))}}]),t}();function Fv(t){switch(t.type){case"ConstantColor":return Uv.fromJSON(t);case"ColorRange":return Dv.fromJSON(t);case"RandomColor":return Pv.fromJSON(t);case"Gradient":return Nv.fromJSON(t);case"RandomColorBetweenGradient":return zv.fromJSON(t);default:return new Uv(new Ce(1,1,1,1))}}var Gv=function(){function t(e){av(this,t),lv(this,"type",void 0),this.value=e,this.type="value"}return hv(t,[{key:"genValue",value:function(){return this.value}},{key:"toJSON",value:function(){return{type:"ConstantValue",value:this.value}}},{key:"clone",value:function(){return new t(this.value)}}],[{key:"fromJSON",value:function(e){return new t(e.value)}}]),t}(),Vv=function(){function t(e,i){av(this,t),lv(this,"type",void 0),this.a=e,this.b=i,this.type="value"}return hv(t,[{key:"genValue",value:function(){return ne.lerp(this.a,this.b,Math.random())}},{key:"toJSON",value:function(){return{type:"IntervalValue",a:this.a,b:this.b}}},{key:"clone",value:function(){return new t(this.a,this.b)}}],[{key:"fromJSON",value:function(e){return new t(e.a,e.b)}}]),t}(),Hv=function(){function t(){av(this,t),lv(this,"functions",void 0),this.functions=new Array}return hv(t,[{key:"findFunction",value:function(t){for(var e=0,i=0,n=this.functions.length-1;i+1<n;)if(e=Math.floor((i+n)/2),t<this.getStartX(e))n=e-1;else{if(!(t>this.getEndX(e)))return e;i=e+1}for(var s=i;s<=n;s++)if(t>=this.functions[s][1]&&t<=this.getEndX(s))return s;return-1}},{key:"getStartX",value:function(t){return this.functions[t][1]}},{key:"setStartX",value:function(t,e){t>0&&(this.functions[t][1]=e)}},{key:"getEndX",value:function(t){return t+1<this.functions.length?this.functions[t+1][1]:1}},{key:"setEndX",value:function(t,e){t+1<this.functions.length&&(this.functions[t+1][1]=e)}},{key:"insertFunction",value:function(t,e){var i=this.findFunction(t);this.functions.splice(i+1,0,[e,t])}},{key:"removeFunction",value:function(t){return this.functions.splice(t,1)[0][0]}},{key:"getFunction",value:function(t){return this.functions[t][0]}},{key:"setFunction",value:function(t,e){this.functions[t][0]=e}},{key:"numOfFunctions",get:function(){return this.functions.length}}]),t}(),jv=function(t){cv(i,t);var e=mv(i);function i(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[[new Av(0,1/3,1/3*2,1),0]];return av(this,i),lv(pv(t=e.call(this)),"type",void 0),t.type="function",t.functions=n,t}return hv(i,[{key:"genValue",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=this.findFunction(t);return-1===e?0:this.functions[e][0].genValue((t-this.getStartX(e))/(this.getEndX(e)-this.getStartX(e)))}},{key:"toSVG",value:function(t,e){if(e<1)return"";for(var i=["M",0,this.functions[0][0].p[0]].join(" "),n=1/e;n<=1;n+=1/e)i=[i,"L",n*t,this.genValue(n)].join(" ");return i}},{key:"toJSON",value:function(){return{type:"PiecewiseBezier",functions:this.functions.map((function(t){var e=gv(t,2),i=e[0],n=e[1];return{function:i.toJSON(),start:n}}))}}},{key:"clone",value:function(){return new i(this.functions.map((function(t){var e=gv(t,2),i=e[0],n=e[1];return[i.clone(),n]})))}}],[{key:"fromJSON",value:function(t){return new i(t.functions.map((function(t){return[Av.fromJSON(t.function),t.start]})))}}]),i}(Hv);function Wv(t){switch(t.type){case"ConstantValue":return Gv.fromJSON(t);case"IntervalValue":return Vv.fromJSON(t);case"PiecewiseBezier":return jv.fromJSON(t);default:return new Gv(0)}}var Xv=function(){function t(){av(this,t),lv(this,"type",void 0),this.type="rotation"}return hv(t,[{key:"genValue",value:function(t,e){var i,n,s,r,a,o;do{s=(i=2*Math.random()-1)*i+(n=2*Math.random()-1)*n}while(s>1);do{o=(r=2*Math.random()-1)*r+(a=2*Math.random()-1)*a}while(o>1);var h=Math.sqrt((1-s)/o);return t.set(i,n,h*r,h*a),t}},{key:"toJSON",value:function(){return{type:"RandomQuat"}}},{key:"clone",value:function(){return new t}}],[{key:"fromJSON",value:function(e){return new t}}]),t}(),qv=function(){function t(e,i){av(this,t),lv(this,"type",void 0),this.axis=e,this.angle=i,this.type="rotation"}return hv(t,[{key:"genValue",value:function(t,e){return t.setFromAxisAngle(this.axis,this.angle.genValue(e))}},{key:"toJSON",value:function(){return{type:"AxisAngle",axis:{x:this.axis.x,y:this.axis.y,z:this.axis.z},angle:this.angle.toJSON()}}},{key:"clone",value:function(){return new t(this.axis.clone(),this.angle.clone())}}],[{key:"fromJSON",value:function(e){return new t(new Le(e.axis.x,e.axis.y,e.axis.z),Wv(e.angle))}}]),t}(),Yv=function(){function t(e,i,n,s){av(this,t),lv(this,"type",void 0),lv(this,"eular",void 0),this.angleX=e,this.angleY=i,this.angleZ=n,this.type="rotation",this.eular=new bi(0,0,0,s)}return hv(t,[{key:"genValue",value:function(t,e){return this.eular.set(this.angleX.genValue(e),this.angleY.genValue(e),this.angleZ.genValue(e)),t.setFromEuler(this.eular)}},{key:"toJSON",value:function(){return{type:"Euler",angleX:this.angleX.toJSON(),angleY:this.angleY.toJSON(),angleZ:this.angleZ.toJSON(),eulerOrder:this.eular.order}}},{key:"clone",value:function(){return new t(this.angleX,this.angleY,this.angleZ,this.eular.order)}}],[{key:"fromJSON",value:function(e){return new t(Wv(e.angleX),Wv(e.angleY),Wv(e.angleZ),e.eulerOrder)}}]),t}();function Jv(t){switch(t.type){case"AxisAngle":return qv.fromJSON(t);case"Euler":return Yv.fromJSON(t);case"RandomQuat":return Xv.fromJSON(t);default:return new Xv}}function $v(t){switch(t.type){case"ConstantValue":case"IntervalValue":case"PiecewiseBezier":return Wv(t);case"AxisAngle":case"RandomQuat":case"Euler":return Jv(t);default:return new Gv(0)}}var Kv=function(){function t(e){av(this,t),lv(this,"type","ColorOverLife"),this.color=e}return hv(t,[{key:"initialize",value:function(t){"memorizedFunction"===this.color.type&&(t.colorOverLifeMemory={},this.color.startGen(t.colorOverLifeMemory))}},{key:"update",value:function(t,e){"memorizedFunction"===this.color.type?this.color.genColor(t.color,t.age/t.life,t.colorOverLifeMemory):this.color.genColor(t.color,t.age/t.life),t.color.x*=t.startColor.x,t.color.y*=t.startColor.y,t.color.z*=t.startColor.z,t.color.w*=t.startColor.w}},{key:"frameUpdate",value:function(t){}},{key:"toJSON",value:function(){return{type:this.type,color:this.color.toJSON()}}},{key:"clone",value:function(){return new t(this.color.clone())}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(e){return new t(Fv(e.color))}}]),t}(),Zv=function(){function t(e){av(this,t),lv(this,"type","RotationOverLife"),lv(this,"dynamic",void 0),this.angularVelocity=e,this.dynamic=!(e instanceof Gv||e instanceof Vv)}return hv(t,[{key:"initialize",value:function(t){this.dynamic=!(this.angularVelocity instanceof Gv||this.angularVelocity instanceof Vv),this.dynamic||"number"!=typeof t.rotation||(t.angularVelocity=this.angularVelocity.genValue())}},{key:"update",value:function(t,e){this.dynamic?"number"==typeof t.rotation&&(t.rotation+=e*this.angularVelocity.genValue(t.age/t.life)):"number"==typeof t.rotation&&(t.rotation+=e*t.angularVelocity)}},{key:"toJSON",value:function(){return{type:this.type,angularVelocity:this.angularVelocity.toJSON()}}},{key:"frameUpdate",value:function(t){}},{key:"clone",value:function(){return new t(this.angularVelocity.clone())}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(e){return new t(Wv(e.angularVelocity))}}]),t}(),Qv=new De,ty=function(){function t(e){av(this,t),lv(this,"type","Rotation3DOverLife"),lv(this,"tempQuat",new De),lv(this,"dynamic",void 0),this.angularVelocity=e,this.dynamic=!(e instanceof Xv)}return hv(t,[{key:"initialize",value:function(t){this.dynamic=!(this.angularVelocity instanceof Xv),t.rotation instanceof De&&(t.angularVelocity=new De,this.angularVelocity.genValue(t.angularVelocity))}},{key:"update",value:function(t,e){t.rotation instanceof De&&(this.dynamic?(this.angularVelocity.genValue(this.tempQuat,t.age/t.life),this.tempQuat.slerpQuaternions(Qv,this.tempQuat,e),t.rotation.multiply(this.tempQuat)):(this.tempQuat.slerpQuaternions(Qv,t.angularVelocity,e),t.rotation.multiply(this.tempQuat)))}},{key:"toJSON",value:function(){return{type:this.type,angularVelocity:this.angularVelocity.toJSON()}}},{key:"frameUpdate",value:function(t){}},{key:"clone",value:function(){return new t(this.angularVelocity.clone())}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(e){return new t(Jv(e.angularVelocity))}}]),t}(),ey=function(){function t(e,i,n){av(this,t),lv(this,"type","ForceOverLife"),lv(this,"_temp",new Le),this.x=e,this.y=i,this.z=n}return hv(t,[{key:"initialize",value:function(t){}},{key:"update",value:function(t,e){this._temp.set(this.x.genValue(t.age/t.life),this.y.genValue(t.age/t.life),this.z.genValue(t.age/t.life)),t.velocity.addScaledVector(this._temp,e)}},{key:"toJSON",value:function(){return{type:this.type,x:this.x.toJSON(),y:this.y.toJSON(),z:this.z.toJSON()}}},{key:"frameUpdate",value:function(t){}},{key:"clone",value:function(){return new t(this.x.clone(),this.y.clone(),this.z.clone())}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(e){return new t(Wv(e.x),Wv(e.y),Wv(e.z))}}]),t}(),iy=function(){function t(e){av(this,t),lv(this,"type","SizeOverLife"),this.size=e}return hv(t,[{key:"initialize",value:function(t){}},{key:"update",value:function(t){t.size=t.startSize*this.size.genValue(t.age/t.life)}},{key:"toJSON",value:function(){return{type:this.type,size:this.size.toJSON()}}},{key:"frameUpdate",value:function(t){}},{key:"clone",value:function(){return new t(this.size.clone())}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(e){return new t(Wv(e.size))}}]),t}(),ny=function(){function t(e){av(this,t),lv(this,"type","SpeedOverLife"),this.speed=e}return hv(t,[{key:"initialize",value:function(t){}},{key:"update",value:function(t){t.speedModifier=this.speed.genValue(t.age/t.life)}},{key:"toJSON",value:function(){return{type:this.type,speed:this.speed.toJSON()}}},{key:"frameUpdate",value:function(t){}},{key:"clone",value:function(){return new t(this.speed.clone())}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(e){return new t(Wv(e.speed))}}]),t}(),sy=function(){function t(e){av(this,t),lv(this,"type","FrameOverLife"),this.frame=e}return hv(t,[{key:"initialize",value:function(t){this.frame instanceof jv||(t.uvTile=this.frame.genValue(0))}},{key:"update",value:function(t,e){this.frame instanceof jv&&(t.uvTile=this.frame.genValue(t.age/t.life))}},{key:"frameUpdate",value:function(t){}},{key:"toJSON",value:function(){return{type:this.type,frame:this.frame.toJSON()}}},{key:"clone",value:function(){return new t(this.frame.clone())}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(e){return new t(Wv(e.frame))}}]),t}();new Le(0,0,1);var ry=function(){function t(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Le(0,1,0);av(this,t),lv(this,"type","OrbitOverLife"),lv(this,"rotation",void 0),lv(this,"line",void 0),lv(this,"temp",new Le),this.orbitSpeed=e,this.axis=i,this.rotation=new De,this.line=new pu}return hv(t,[{key:"initialize",value:function(t){}},{key:"update",value:function(t,e){this.line.set(new Le(0,0,0),this.axis),this.line.closestPointToPoint(t.position,!1,this.temp),this.rotation.setFromAxisAngle(this.axis,this.orbitSpeed.genValue(t.age/t.life)*e),t.position.sub(this.temp),t.position.applyQuaternion(this.rotation),t.position.add(this.temp)}},{key:"frameUpdate",value:function(t){}},{key:"toJSON",value:function(){return{type:this.type,orbitSpeed:this.orbitSpeed.toJSON(),axis:[this.axis.x,this.axis.y,this.axis.z]}}},{key:"clone",value:function(){return new t(this.orbitSpeed.clone())}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(e){return new t(Wv(e.orbitSpeed),e.axis?new Le(e.axis[0],e.axis[1],e.axis[2]):void 0)}}]),t}(),ay=function(){function t(e){av(this,t),lv(this,"type","WidthOverLength"),this.width=e}return hv(t,[{key:"initialize",value:function(t){}},{key:"update",value:function(t){if(t instanceof Tv)for(var e=t.previous.values(),i=0;i<t.previous.length;i++){e.next().value.size=this.width.genValue((t.previous.length-i)/t.length)}}},{key:"frameUpdate",value:function(t){}},{key:"toJSON",value:function(){return{type:this.type,width:this.width.toJSON()}}},{key:"clone",value:function(){return new t(this.width.clone())}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(e){return new t(Wv(e.width))}}]),t}(),oy=function(){function t(e,i){av(this,t),lv(this,"type","ApplyForce"),lv(this,"magnitudeValue",void 0),this.direction=e,this.magnitude=i,this.magnitudeValue=this.magnitude.genValue()}return hv(t,[{key:"initialize",value:function(t){}},{key:"update",value:function(t,e){t.velocity.addScaledVector(this.direction,this.magnitudeValue*e)}},{key:"frameUpdate",value:function(t){this.magnitudeValue=this.magnitude.genValue()}},{key:"toJSON",value:function(){return{type:this.type,direction:[this.direction.x,this.direction.y,this.direction.z],magnitude:this.magnitude.toJSON()}}},{key:"clone",value:function(){return new t(this.direction.clone(),this.magnitude.clone())}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(e){var i;return new t(new Le(e.direction[0],e.direction[1],e.direction[2]),Wv(null!==(i=e.magnitude)&&void 0!==i?i:e.force))}}]),t}(),hy=function(){function t(e,i){av(this,t),lv(this,"type","GravityForce"),lv(this,"temp",new Le),this.center=e,this.magnitude=i}return hv(t,[{key:"initialize",value:function(t){}},{key:"update",value:function(t,e){this.temp.copy(this.center).sub(t.position).normalize(),t.velocity.addScaledVector(this.temp,this.magnitude/t.position.distanceToSquared(this.center)*e)}},{key:"frameUpdate",value:function(t){}},{key:"toJSON",value:function(){return{type:this.type,center:[this.center.x,this.center.y,this.center.z],magnitude:this.magnitude}}},{key:"clone",value:function(){return new t(this.center.clone(),this.magnitude)}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(e){return new t(new Le(e.center[0],e.center[1],e.center[2]),e.magnitude)}}]),t}();new Le(0,0,1);var ly=function(){function t(e){av(this,t),lv(this,"type","ChangeEmitDirection"),lv(this,"_temp",new Le),lv(this,"_q",new De),this.angle=e}return hv(t,[{key:"initialize",value:function(t){var e=t.velocity.length();0!=e&&(t.velocity.normalize(),0===t.velocity.x&&0===t.velocity.y?this._temp.set(0,t.velocity.z,0):this._temp.set(-t.velocity.y,t.velocity.x,0),this._q.setFromAxisAngle(this._temp.normalize(),this.angle.genValue()),this._temp.copy(t.velocity),t.velocity.applyQuaternion(this._q),this._q.setFromAxisAngle(this._temp,Math.random()*Math.PI*2),t.velocity.applyQuaternion(this._q),t.velocity.setLength(e))}},{key:"update",value:function(t,e){}},{key:"frameUpdate",value:function(t){}},{key:"toJSON",value:function(){return{type:this.type,angle:this.angle.toJSON()}}},{key:"clone",value:function(){return new t(this.angle)}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(e){return new t(Wv(e.angle))}}]),t}(),cy=new Le(1,1,1),uy=new Le(0,0,1),dy=function(t){return t[t.Death=0]="Death",t[t.Birth=1]="Birth",t[t.Frame=2]="Frame",t}({}),py=function(){function t(e,i,n){var s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:dy.Frame,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;av(this,t),lv(this,"type","EmitSubParticleSystem"),lv(this,"q_",new De),lv(this,"v_",new Le),lv(this,"v2_",new Le),lv(this,"subEmissions",new Array),this.particleSystem=e,this.useVelocityAsBasis=i,this.subParticleSystem=n,this.mode=s,this.emitProbability=r,this.subParticleSystem&&this.subParticleSystem.system&&(this.subParticleSystem.system.onlyUsedByOther=!0)}return hv(t,[{key:"initialize",value:function(t){}},{key:"update",value:function(t,e){(this.mode===dy.Frame||this.mode===dy.Birth&&0===t.age||this.mode===dy.Death&&t.age+e>=t.life)&&this.emit(t,e)}},{key:"emit",value:function(t,e){if(this.subParticleSystem&&!(Math.random()>this.emitProbability)){var i=new ci;this.setMatrixFromParticle(i,t),this.subEmissions.push({burstIndex:0,burstWaveIndex:0,time:0,waitEmiting:0,matrix:i,travelDistance:0,particle:t})}}},{key:"frameUpdate",value:function(t){if(this.subParticleSystem)for(var e=0;e<this.subEmissions.length;e++)if(this.subEmissions[e].time>=this.subParticleSystem.system.duration)this.subEmissions[e]=this.subEmissions[this.subEmissions.length-1],this.subEmissions.length=this.subEmissions.length-1,e--;else{var i=this.subEmissions[e];i.particle&&i.particle.age<i.particle.life?this.setMatrixFromParticle(i.matrix,i.particle):i.particle=void 0,this.subParticleSystem.system.emit(t,i,i.matrix)}}},{key:"toJSON",value:function(){return{type:this.type,subParticleSystem:this.subParticleSystem?this.subParticleSystem.uuid:"",useVelocityAsBasis:this.useVelocityAsBasis,mode:this.mode,emitProbability:this.emitProbability}}},{key:"clone",value:function(){return new t(this.particleSystem,this.useVelocityAsBasis,this.subParticleSystem,this.mode,this.emitProbability)}},{key:"reset",value:function(){}},{key:"setMatrixFromParticle",value:function(t,e){var i;if(void 0===e.rotation||this.useVelocityAsBasis)if(0!==e.velocity.x||0!==e.velocity.y||1!==e.velocity.z&&0!==e.velocity.z){this.v_.copy(uy).cross(e.velocity),this.v2_.copy(e.velocity).cross(this.v_);var n=this.v_.length(),s=this.v2_.length();t.set(this.v_.x/n,this.v2_.x/s,e.velocity.x,e.position.x,this.v_.y/n,this.v2_.y/s,e.velocity.y,e.position.y,this.v_.z/n,this.v2_.z/s,e.velocity.z,e.position.z,0,0,0,1)}else t.set(1,0,0,e.position.x,0,1,0,e.position.y,0,0,1,e.position.z,0,0,0,1);else e.rotation instanceof De?i=e.rotation:(this.q_.setFromAxisAngle(uy,e.rotation),i=this.q_),t.compose(e.position,i,cy);this.particleSystem.worldSpace||t.multiplyMatrices(this.particleSystem.emitter.matrixWorld,t)}}],[{key:"fromJSON",value:function(e,i){return new t(i,e.useVelocityAsBasis,e.subParticleSystem,e.mode,e.emitProbability)}}]),t}(),my=.5*(Math.sqrt(3)-1),fy=(3-Math.sqrt(3))/6,gy=1/6,vy=(Math.sqrt(5)-1)/4,yy=(5-Math.sqrt(5))/20,xy=new Float32Array([1,1,0,-1,1,0,1,-1,0,-1,-1,0,1,0,1,-1,0,1,1,0,-1,-1,0,-1,0,1,1,0,-1,1,0,1,-1,0,-1,-1]),by=new Float32Array([0,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,1,0,1,1,1,0,1,-1,1,0,-1,1,1,0,-1,-1,-1,0,1,1,-1,0,1,-1,-1,0,-1,1,-1,0,-1,-1,1,1,0,1,1,1,0,-1,1,-1,0,1,1,-1,0,-1,-1,1,0,1,-1,1,0,-1,-1,-1,0,1,-1,-1,0,-1,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,0]),_y=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Math.random;av(this,t),lv(this,"p",void 0),lv(this,"perm",void 0),lv(this,"permMod12",void 0);var i="function"==typeof e?e:function(t){var e=0,i=0,n=0,s=1,r=function(){var t=4022871197;return function(e){e=e.toString();for(var i=0;i<e.length;i++){var n=.02519603282416938*(t+=e.charCodeAt(i));n-=t=n>>>0,t=(n*=t)>>>0,t+=4294967296*(n-=t)}return 2.3283064365386963e-10*(t>>>0)}}();e=r(" "),i=r(" "),n=r(" "),(e-=r(t))<0&&(e+=1);(i-=r(t))<0&&(i+=1);(n-=r(t))<0&&(n+=1);return function(){var t=2091639*e+2.3283064365386963e-10*s;return e=i,i=n,n=t-(s=0|t)}}(e);this.p=function(t){for(var e=new Uint8Array(256),i=0;i<256;i++)e[i]=i;for(var n=0;n<255;n++){var s=n+~~(t()*(256-n)),r=e[n];e[n]=e[s],e[s]=r}return e}(i),this.perm=new Uint8Array(512),this.permMod12=new Uint8Array(512);for(var n=0;n<512;n++)this.perm[n]=this.p[255&n],this.permMod12[n]=this.perm[n]%12}return hv(t,[{key:"noise2D",value:function(t,e){var i,n,s=this.permMod12,r=this.perm,a=0,o=0,h=0,l=(t+e)*my,c=Math.floor(t+l),u=Math.floor(e+l),d=(c+u)*fy,p=t-(c-d),m=e-(u-d);p>m?(i=1,n=0):(i=0,n=1);var f=p-i+fy,g=m-n+fy,v=p-1+2*fy,y=m-1+2*fy,x=255&c,b=255&u,_=.5-p*p-m*m;if(_>=0){var w=3*s[x+r[b]];a=(_*=_)*_*(xy[w]*p+xy[w+1]*m)}var M=.5-f*f-g*g;if(M>=0){var S=3*s[x+i+r[b+n]];o=(M*=M)*M*(xy[S]*f+xy[S+1]*g)}var E=.5-v*v-y*y;if(E>=0){var T=3*s[x+1+r[b+1]];h=(E*=E)*E*(xy[T]*v+xy[T+1]*y)}return 70*(a+o+h)}},{key:"noise3D",value:function(t,e,i){var n,s,r,a,o,h,l,c,u,d,p=this.permMod12,m=this.perm,f=.3333333333333333*(t+e+i),g=Math.floor(t+f),v=Math.floor(e+f),y=Math.floor(i+f),x=(g+v+y)*gy,b=t-(g-x),_=e-(v-x),w=i-(y-x);b>=_?_>=w?(o=1,h=0,l=0,c=1,u=1,d=0):b>=w?(o=1,h=0,l=0,c=1,u=0,d=1):(o=0,h=0,l=1,c=1,u=0,d=1):_<w?(o=0,h=0,l=1,c=0,u=1,d=1):b<w?(o=0,h=1,l=0,c=0,u=1,d=1):(o=0,h=1,l=0,c=1,u=1,d=0);var M=b-o+gy,S=_-h+gy,E=w-l+gy,T=b-c+2*gy,A=_-u+2*gy,C=w-d+2*gy,I=b-1+.5,R=_-1+.5,k=w-1+.5,P=255&g,D=255&v,L=255&y,O=.6-b*b-_*_-w*w;if(O<0)n=0;else{var N=3*p[P+m[D+m[L]]];n=(O*=O)*O*(xy[N]*b+xy[N+1]*_+xy[N+2]*w)}var B=.6-M*M-S*S-E*E;if(B<0)s=0;else{var z=3*p[P+o+m[D+h+m[L+l]]];s=(B*=B)*B*(xy[z]*M+xy[z+1]*S+xy[z+2]*E)}var U=.6-T*T-A*A-C*C;if(U<0)r=0;else{var F=3*p[P+c+m[D+u+m[L+d]]];r=(U*=U)*U*(xy[F]*T+xy[F+1]*A+xy[F+2]*C)}var G=.6-I*I-R*R-k*k;if(G<0)a=0;else{var V=3*p[P+1+m[D+1+m[L+1]]];a=(G*=G)*G*(xy[V]*I+xy[V+1]*R+xy[V+2]*k)}return 32*(n+s+r+a)}},{key:"noise4D",value:function(t,e,i,n){var s,r,a,o,h,l=this.perm,c=(t+e+i+n)*vy,u=Math.floor(t+c),d=Math.floor(e+c),p=Math.floor(i+c),m=Math.floor(n+c),f=(u+d+p+m)*yy,g=t-(u-f),v=e-(d-f),y=i-(p-f),x=n-(m-f),b=0,_=0,w=0,M=0;g>v?b++:_++,g>y?b++:w++,g>x?b++:M++,v>y?_++:w++,v>x?_++:M++,y>x?w++:M++;var S=b>=3?1:0,E=_>=3?1:0,T=w>=3?1:0,A=M>=3?1:0,C=b>=2?1:0,I=_>=2?1:0,R=w>=2?1:0,k=M>=2?1:0,P=b>=1?1:0,D=_>=1?1:0,L=w>=1?1:0,O=M>=1?1:0,N=g-S+yy,B=v-E+yy,z=y-T+yy,U=x-A+yy,F=g-C+2*yy,G=v-I+2*yy,V=y-R+2*yy,H=x-k+2*yy,j=g-P+3*yy,W=v-D+3*yy,X=y-L+3*yy,q=x-O+3*yy,Y=g-1+4*yy,J=v-1+4*yy,$=y-1+4*yy,K=x-1+4*yy,Z=255&u,Q=255&d,tt=255&p,et=255&m,it=.6-g*g-v*v-y*y-x*x;if(it<0)s=0;else{var nt=l[Z+l[Q+l[tt+l[et]]]]%32*4;s=(it*=it)*it*(by[nt]*g+by[nt+1]*v+by[nt+2]*y+by[nt+3]*x)}var st=.6-N*N-B*B-z*z-U*U;if(st<0)r=0;else{var rt=l[Z+S+l[Q+E+l[tt+T+l[et+A]]]]%32*4;r=(st*=st)*st*(by[rt]*N+by[rt+1]*B+by[rt+2]*z+by[rt+3]*U)}var at=.6-F*F-G*G-V*V-H*H;if(at<0)a=0;else{var ot=l[Z+C+l[Q+I+l[tt+R+l[et+k]]]]%32*4;a=(at*=at)*at*(by[ot]*F+by[ot+1]*G+by[ot+2]*V+by[ot+3]*H)}var ht=.6-j*j-W*W-X*X-q*q;if(ht<0)o=0;else{var lt=l[Z+P+l[Q+D+l[tt+L+l[et+O]]]]%32*4;o=(ht*=ht)*ht*(by[lt]*j+by[lt+1]*W+by[lt+2]*X+by[lt+3]*q)}var ct=.6-Y*Y-J*J-$*$-K*K;if(ct<0)h=0;else{var ut=l[Z+1+l[Q+1+l[tt+1+l[et+1]]]]%32*4;h=(ct*=ct)*ct*(by[ut]*Y+by[ut+1]*J+by[ut+2]*$+by[ut+3]*K)}return 27*(s+r+a+o+h)}}]),t}();var wy=function(){function t(e,i,n,s){av(this,t),lv(this,"type","TurbulenceField"),lv(this,"generator",new _y),lv(this,"timeOffset",new Le),lv(this,"temp",new Le),lv(this,"temp2",new Le),this.scale=e,this.octaves=i,this.velocityMultiplier=n,this.timeScale=s,this.timeOffset.x=Math.random()/this.scale.x*this.timeScale.x,this.timeOffset.y=Math.random()/this.scale.y*this.timeScale.y,this.timeOffset.z=Math.random()/this.scale.z*this.timeScale.z}return hv(t,[{key:"initialize",value:function(t){}},{key:"update",value:function(t,e){var i=t.position.x/this.scale.x,n=t.position.y/this.scale.y,s=t.position.z/this.scale.z;this.temp.set(0,0,0);for(var r=1,a=0;a<this.octaves;a++)this.temp2.set(this.generator.noise4D(i*r,n*r,s*r,this.timeOffset.x*r)/r,this.generator.noise4D(i*r,n*r,s*r,this.timeOffset.y*r)/r,this.generator.noise4D(i*r,n*r,s*r,this.timeOffset.z*r)/r),this.temp.add(this.temp2),r*=2;this.temp.multiply(this.velocityMultiplier),t.velocity.addScaledVector(this.temp,e)}},{key:"toJSON",value:function(){return{type:this.type,scale:[this.scale.x,this.scale.y,this.scale.z],octaves:this.octaves,velocityMultiplier:[this.velocityMultiplier.x,this.velocityMultiplier.y,this.velocityMultiplier.z],timeScale:[this.timeScale.x,this.timeScale.y,this.timeScale.z]}}},{key:"frameUpdate",value:function(t){this.timeOffset.x+=t*this.timeScale.x,this.timeOffset.y+=t*this.timeScale.y,this.timeOffset.z+=t*this.timeScale.z}},{key:"clone",value:function(){return new t(this.scale.clone(),this.octaves,this.velocityMultiplier.clone(),this.timeScale.clone())}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(e){return new t(new Le(e.scale[0],e.scale[1],e.scale[2]),e.octaves,new Le(e.velocityMultiplier[0],e.velocityMultiplier[1],e.velocityMultiplier[2]),new Le(e.timeScale[0],e.timeScale[1],e.timeScale[2]))}}]),t}();function My(t,e){return Math.floor(Math.random()*(e-t))+t}var Sy=[],Ey=new Le,Ty=new De,Ay=function(){function t(e,i){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Gv(1),s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new Gv(0);if(av(this,t),lv(this,"type","Noise"),lv(this,"duration",0),this.frequency=e,this.power=i,this.positionAmount=n,this.rotationAmount=s,0===Sy.length)for(var r=0;r<100;r++)Sy.push(new _y)}return hv(t,[{key:"initialize",value:function(t){t.lastPosNoise=new Le,"number"==typeof t.rotation?t.lastRotNoise=0:t.lastRotNoise=new De,t.generatorIndex=[My(0,100),My(0,100),My(0,100),My(0,100)]}},{key:"update",value:function(t,e){var i=this.frequency.genValue(t.age/t.life),n=this.power.genValue(t.age/t.life),s=this.positionAmount.genValue(t.age/t.life),r=this.rotationAmount.genValue(t.age/t.life);s>0&&void 0!==t.lastPosNoise&&(t.position.sub(t.lastPosNoise),Ey.set(Sy[t.generatorIndex[0]].noise2D(0,t.age*i)*n*s,Sy[t.generatorIndex[1]].noise2D(0,t.age*i)*n*s,Sy[t.generatorIndex[2]].noise2D(0,t.age*i)*n*s),t.position.add(Ey),t.lastPosNoise.copy(Ey)),r>0&&void 0!==t.lastRotNoise&&("number"==typeof t.rotation?(t.rotation-=t.lastRotNoise,t.rotation+=Sy[t.generatorIndex[3]].noise2D(0,t.age*i)*Math.PI*n*r):(t.lastRotNoise.invert(),t.rotation.multiply(t.lastRotNoise),Ty.set(Sy[t.generatorIndex[0]].noise2D(0,t.age*i)*n*r,Sy[t.generatorIndex[1]].noise2D(0,t.age*i)*n*r,Sy[t.generatorIndex[2]].noise2D(0,t.age*i)*n*r,Sy[t.generatorIndex[3]].noise2D(0,t.age*i)*n*r).normalize(),t.rotation.multiply(Ty),t.lastRotNoise.copy(Ty)))}},{key:"toJSON",value:function(){return{type:this.type,frequency:this.frequency.toJSON(),power:this.power.toJSON(),positionAmount:this.positionAmount.toJSON(),rotationAmount:this.rotationAmount.toJSON()}}},{key:"frameUpdate",value:function(t){this.duration+=t}},{key:"clone",value:function(){return new t(this.frequency.clone(),this.power.clone(),this.positionAmount.clone(),this.rotationAmount.clone())}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(e){return new t(Wv(e.frequency),Wv(e.power),Wv(e.positionAmount),Wv(e.rotationAmount))}}]),t}(),Cy=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Le;av(this,t),lv(this,"locations",[]),this.scaleX=e,this.scaleY=i,this.position=n}return hv(t,[{key:"transform",value:function(t,e){t.x=this.locations[e%this.locations.length].x*this.scaleX+this.position.x,t.y=this.locations[e%this.locations.length].y*this.scaleY+this.position.y,t.z=this.position.z}},{key:"clone",value:function(){var e=new t(this.scaleX,this.scaleY,this.position.clone());return e.locations=this.locations.map((function(t){return t.clone()})),e}},{key:"toJSON",value:function(){return{scaleX:this.scaleX,scaleY:this.scaleY,position:this.position,locations:this.locations.map((function(t){return{x:t.x,y:t.y}}))}}},{key:"fromImage",value:function(t,e){var i=document.createElement("canvas");i.width=t.width,i.height=t.height;var n=i.getContext("2d");if(n){n.drawImage(t,0,0);var s=n.getImageData(0,0,i.width,i.height,{colorSpace:"srgb"});i.remove(),this.locations.length=0;for(var r=0;r<s.height;r++)for(var a=0;a<s.width;a++)s.data[4*(r*s.width+a)+3]>e&&this.locations.push(new se(a,s.height-r))}}}],[{key:"fromJSON",value:function(e){var i=new t(e.scaleX,e.scaleY,new Le(e.position[0],e.position[1],e.position[2]));return i.locations=e.locations.map((function(t){return new se(t.x,t.y)})),i}}]),t}();function Iy(t){return"TextureSequencer"===t.type?Cy.fromJSON(t):new Cy}var Ry,ky=function(){function t(e){av(this,t),lv(this,"type","ApplySequences"),lv(this,"sequencers",[]),lv(this,"time",0),lv(this,"index",0),lv(this,"pCount",0),lv(this,"delay",void 0),lv(this,"tempV",new Le),this.delay=e}return hv(t,[{key:"initialize",value:function(t){t.id=this.pCount,t.dst=new Le,t.begin=new Le,t.inMotion=!1,this.pCount++}},{key:"reset",value:function(){this.time=0,this.index=0,this.pCount=0}},{key:"update",value:function(e,i){var n=this.sequencers[this.index],s=e.id*this.delay;this.time>=n[0].a+s&&this.time<=n[0].b+s?(e.inMotion||(e.inMotion=!0,e.begin.copy(e.position),n[1].transform(e.dst,e.id)),e.position.lerpVectors(e.begin,e.dst,t.BEZIER.genValue((this.time-n[0].a-s)/(n[0].b-n[0].a)))):this.time>n[0].b+s&&(e.inMotion=!1)}},{key:"frameUpdate",value:function(t){for(;this.index+1<this.sequencers.length&&this.time>=this.sequencers[this.index+1][0].a;)this.index++;this.time+=t}},{key:"appendSequencer",value:function(t,e){this.sequencers.push([t,e])}},{key:"toJSON",value:function(){return{type:this.type,delay:this.delay,sequencers:this.sequencers.map((function(t){var e=gv(t,2),i=e[0],n=e[1];return{range:i.toJSON(),sequencer:n.toJSON()}}))}}},{key:"clone",value:function(){var e=new t(this.delay);return e.sequencers=this.sequencers.map((function(t){return[t[0].clone(),t[1].clone()]})),e}}],[{key:"fromJSON",value:function(e){var i=new t(e.delay);return e.sequencers.forEach((function(t){i.sequencers.push([Wv(t.range),Iy(t.sequencer)])})),i}}]),t}();lv(ky,"BEZIER",new Av(0,0,1,1));var Py=function(){function t(e,i){av(this,t),lv(this,"type","ApplyCollision"),lv(this,"tempV",new Le),this.resolver=e,this.bounce=i}return hv(t,[{key:"initialize",value:function(t){}},{key:"update",value:function(t,e){this.resolver.resolve(t.position,this.tempV)&&t.velocity.reflect(this.tempV).multiplyScalar(this.bounce)}},{key:"frameUpdate",value:function(t){}},{key:"toJSON",value:function(){return{type:this.type,bounce:this.bounce}}},{key:"clone",value:function(){return new t(this.resolver,this.bounce)}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(e){return new t(Ry,e.bounce)}}]),t}(),Dy=function(){function t(e,i){av(this,t),lv(this,"type","ColorBySpeed"),this.color=e,this.speedRange=i}return hv(t,[{key:"initialize",value:function(t){"memorizedFunction"===this.color.type&&(t.colorOverLifeMemory={},this.color.startGen(t.colorOverLifeMemory))}},{key:"update",value:function(t,e){var i=(t.startSpeed-this.speedRange.a)/(this.speedRange.b-this.speedRange.a);"memorizedFunction"===this.color.type?this.color.genColor(t.color,i,t.colorOverLifeMemory):this.color.genColor(t.color,i),t.color.x*=t.startColor.x,t.color.y*=t.startColor.y,t.color.z*=t.startColor.z,t.color.w*=t.startColor.w}},{key:"frameUpdate",value:function(t){}},{key:"toJSON",value:function(){return{type:this.type,color:this.color.toJSON(),speedRange:this.speedRange.toJSON()}}},{key:"clone",value:function(){return new t(this.color.clone(),this.speedRange.clone())}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(e){return new t(Fv(e.color),Vv.fromJSON(e.speedRange))}}]),t}(),Ly=function(){function t(e,i){av(this,t),lv(this,"type","SizeBySpeed"),this.size=e,this.speedRange=i}return hv(t,[{key:"initialize",value:function(t){}},{key:"update",value:function(t){var e=(t.startSpeed-this.speedRange.a)/(this.speedRange.b-this.speedRange.a);t.size=t.startSize*this.size.genValue(e)}},{key:"toJSON",value:function(){return{type:this.type,size:this.size.toJSON(),speedRange:this.speedRange.toJSON()}}},{key:"frameUpdate",value:function(t){}},{key:"clone",value:function(){return new t(this.size.clone(),this.speedRange.clone())}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(e){return new t(Wv(e.size),Vv.fromJSON(e.speedRange))}}]),t}(),Oy=function(){function t(e,i){av(this,t),lv(this,"type","RotationBySpeed"),lv(this,"tempQuat",new De),this.angularVelocity=e,this.speedRange=i}return hv(t,[{key:"initialize",value:function(t){}},{key:"update",value:function(t,e){var i=(t.startSpeed-this.speedRange.a)/(this.speedRange.b-this.speedRange.a);t.rotation+=e*this.angularVelocity.genValue(i)}},{key:"toJSON",value:function(){return{type:this.type,angularVelocity:this.angularVelocity.toJSON(),speedRange:this.speedRange.toJSON()}}},{key:"frameUpdate",value:function(t){}},{key:"clone",value:function(){return new t(this.angularVelocity.clone(),this.speedRange.clone())}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(e){return new t(Wv(e.angularVelocity),Vv.fromJSON(e.speedRange))}}]),t}(),Ny=function(){function t(e,i){av(this,t),lv(this,"type","LimitSpeedOverLife"),this.speed=e,this.dampen=i}return hv(t,[{key:"initialize",value:function(t){}},{key:"update",value:function(t,e){var i=t.velocity.length(),n=this.speed.genValue(t.age/t.life);if(i>n){var s=(i-n)/i;t.velocity.multiplyScalar(1-s*this.dampen*e*20)}}},{key:"toJSON",value:function(){return{type:this.type,speed:this.speed.toJSON(),dampen:this.dampen}}},{key:"frameUpdate",value:function(t){}},{key:"clone",value:function(){return new t(this.speed.clone(),this.dampen)}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(e){return new t(Wv(e.speed),e.dampen)}}]),t}(),By={ApplyForce:{type:"ApplyForce",constructor:oy,params:[["direction","vec3"],["magnitude","value"]],loadJSON:oy.fromJSON},Noise:{type:"Noise",constructor:Ay,params:[["frequency","value"],["power","value"],["positionAmount","value"],["rotationAmount","value"]],loadJSON:Ay.fromJSON},TurbulenceField:{type:"TurbulenceField",constructor:wy,params:[["scale","vec3"],["octaves","number"],["velocityMultiplier","vec3"],["timeScale","vec3"]],loadJSON:wy.fromJSON},GravityForce:{type:"GravityForce",constructor:hy,params:[["center","vec3"],["magnitude","number"]],loadJSON:hy.fromJSON},ColorOverLife:{type:"ColorOverLife",constructor:Kv,params:[["color","colorFunc"]],loadJSON:Kv.fromJSON},RotationOverLife:{type:"RotationOverLife",constructor:Zv,params:[["angularVelocity","valueFunc"]],loadJSON:Zv.fromJSON},Rotation3DOverLife:{type:"Rotation3DOverLife",constructor:ty,params:[["angularVelocity","rotationFunc"]],loadJSON:ty.fromJSON},SizeOverLife:{type:"SizeOverLife",constructor:iy,params:[["size","valueFunc"]],loadJSON:iy.fromJSON},ColorBySpeed:{type:"ColorBySpeed",constructor:Dy,params:[["color","colorFunc"],["speedRange","range"]],loadJSON:Dy.fromJSON},RotationBySpeed:{type:"RotationBySpeed",constructor:Oy,params:[["angularVelocity","valueFunc"],["speedRange","range"]],loadJSON:Oy.fromJSON},SizeBySpeed:{type:"SizeBySpeed",constructor:Ly,params:[["size","valueFunc"],["speedRange","range"]],loadJSON:Ly.fromJSON},SpeedOverLife:{type:"SpeedOverLife",constructor:ny,params:[["speed","valueFunc"]],loadJSON:ny.fromJSON},FrameOverLife:{type:"FrameOverLife",constructor:sy,params:[["frame","valueFunc"]],loadJSON:sy.fromJSON},ForceOverLife:{type:"ForceOverLife",constructor:ey,params:[["x","valueFunc"],["y","valueFunc"],["z","valueFunc"]],loadJSON:ey.fromJSON},OrbitOverLife:{type:"OrbitOverLife",constructor:ry,params:[["orbitSpeed","valueFunc"],["axis","vec3"]],loadJSON:ry.fromJSON},WidthOverLength:{type:"WidthOverLength",constructor:ay,params:[["width","valueFunc"]],loadJSON:ay.fromJSON},ChangeEmitDirection:{type:"ChangeEmitDirection",constructor:ly,params:[["angle","value"]],loadJSON:ly.fromJSON},EmitSubParticleSystem:{type:"EmitSubParticleSystem",constructor:py,params:[["particleSystem","self"],["useVelocityAsBasis","boolean"],["subParticleSystem","particleSystem"],["mode","number"],["emitProbability","number"]],loadJSON:py.fromJSON},LimitSpeedOverLife:{type:"LimitSpeedOverLife",constructor:Ny,params:[["speed","valueFunc"],["dampen","number"]],loadJSON:Ny.fromJSON}};var zy=function(t){return t[t.Random=0]="Random",t[t.Loop=1]="Loop",t[t.PingPong=2]="PingPong",t[t.Burst=3]="Burst",t}({});function Uy(t,e,i){var n;switch(zy.Random===t&&(e=Math.random()),n=i>0?Math.floor(e/i)*i:e,t){case zy.Loop:n%=1;break;case zy.PingPong:n=Math.abs(n%2-1)}return n}var Fy=function(){function t(){var e,i,n,s,r,a,o,h=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};av(this,t),lv(this,"type","cone"),lv(this,"radius",void 0),lv(this,"arc",void 0),lv(this,"thickness",void 0),lv(this,"angle",void 0),lv(this,"mode",void 0),lv(this,"spread",void 0),lv(this,"speed",void 0),lv(this,"currentValue",0),this.radius=null!==(e=h.radius)&&void 0!==e?e:10,this.arc=null!==(i=h.arc)&&void 0!==i?i:2*Math.PI,this.thickness=null!==(n=h.thickness)&&void 0!==n?n:1,this.angle=null!==(s=h.angle)&&void 0!==s?s:Math.PI/6,this.mode=null!==(r=h.mode)&&void 0!==r?r:zy.Random,this.spread=null!==(a=h.spread)&&void 0!==a?a:0,this.speed=null!==(o=h.speed)&&void 0!==o?o:new Gv(1)}return hv(t,[{key:"update",value:function(t,e){zy.Random!=this.mode&&(this.currentValue+=this.speed.genValue(t.emissionState.time/t.duration)*e)}},{key:"initialize",value:function(t){var e=Uy(this.mode,this.currentValue,this.spread),i=ne.lerp(1-this.thickness,1,Math.random()),n=e*this.arc,s=Math.sqrt(i),r=Math.sin(n),a=Math.cos(n);t.position.x=s*a,t.position.y=s*r,t.position.z=0;var o=this.angle*s;t.velocity.set(0,0,Math.cos(o)).addScaledVector(t.position,Math.sin(o)).multiplyScalar(t.startSpeed),t.position.multiplyScalar(this.radius)}},{key:"toJSON",value:function(){return{type:"cone",radius:this.radius,arc:this.arc,thickness:this.thickness,angle:this.angle,mode:this.mode,spread:this.spread,speed:this.speed.toJSON()}}},{key:"clone",value:function(){return new t({radius:this.radius,arc:this.arc,thickness:this.thickness,angle:this.angle,mode:this.mode,speed:this.speed.clone(),spread:this.spread})}}],[{key:"fromJSON",value:function(e){return new t({radius:e.radius,arc:e.arc,thickness:e.thickness,angle:e.angle,mode:e.mode,speed:e.speed?Wv(e.speed):void 0,spread:e.spread})}}]),t}(),Gy=function(){function t(){var e,i,n,s,r,a,o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};av(this,t),lv(this,"type","circle"),lv(this,"radius",void 0),lv(this,"arc",void 0),lv(this,"thickness",void 0),lv(this,"mode",void 0),lv(this,"spread",void 0),lv(this,"speed",void 0),lv(this,"currentValue",0),this.radius=null!==(e=o.radius)&&void 0!==e?e:10,this.arc=null!==(i=o.arc)&&void 0!==i?i:2*Math.PI,this.thickness=null!==(n=o.thickness)&&void 0!==n?n:1,this.mode=null!==(s=o.mode)&&void 0!==s?s:zy.Random,this.spread=null!==(r=o.spread)&&void 0!==r?r:0,this.speed=null!==(a=o.speed)&&void 0!==a?a:new Gv(1)}return hv(t,[{key:"update",value:function(t,e){this.currentValue+=this.speed.genValue(t.emissionState.time/t.duration)*e}},{key:"initialize",value:function(t){var e=Uy(this.mode,this.currentValue,this.spread),i=ne.lerp(1-this.thickness,1,Math.random()),n=e*this.arc;t.position.x=Math.cos(n),t.position.y=Math.sin(n),t.position.z=0,t.velocity.copy(t.position).multiplyScalar(t.startSpeed),t.position.multiplyScalar(this.radius*i)}},{key:"toJSON",value:function(){return{type:"circle",radius:this.radius,arc:this.arc,thickness:this.thickness,mode:this.mode,spread:this.spread,speed:this.speed.toJSON()}}},{key:"clone",value:function(){return new t({radius:this.radius,arc:this.arc,thickness:this.thickness,mode:this.mode,speed:this.speed.clone(),spread:this.spread})}}],[{key:"fromJSON",value:function(e){return new t({radius:e.radius,arc:e.arc,thickness:e.thickness,mode:e.mode,speed:e.speed?Wv(e.speed):void 0,spread:e.spread})}}]),t}(),Vy=function(){function t(){var e,i,n,s,r,a,o,h=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};av(this,t),lv(this,"type","donut"),lv(this,"radius",void 0),lv(this,"donutRadius",void 0),lv(this,"arc",void 0),lv(this,"thickness",void 0),lv(this,"mode",void 0),lv(this,"spread",void 0),lv(this,"speed",void 0),lv(this,"currentValue",0),this.radius=null!==(e=h.radius)&&void 0!==e?e:10,this.arc=null!==(i=h.arc)&&void 0!==i?i:2*Math.PI,this.thickness=null!==(n=h.thickness)&&void 0!==n?n:1,this.donutRadius=null!==(s=h.donutRadius)&&void 0!==s?s:.2*this.radius,this.mode=null!==(r=h.mode)&&void 0!==r?r:zy.Random,this.spread=null!==(a=h.spread)&&void 0!==a?a:0,this.speed=null!==(o=h.speed)&&void 0!==o?o:new Gv(1)}return hv(t,[{key:"update",value:function(t,e){zy.Random!=this.mode&&(this.currentValue+=this.speed.genValue(t.emissionState.time/t.duration)*e)}},{key:"initialize",value:function(t){var e=Uy(this.mode,this.currentValue,this.spread),i=Math.random(),n=ne.lerp(1-this.thickness,1,Math.random()),s=e*this.arc,r=i*Math.PI*2,a=Math.sin(s),o=Math.cos(s);t.position.x=this.radius*o,t.position.y=this.radius*a,t.position.z=0,t.velocity.z=this.donutRadius*n*Math.sin(r),t.velocity.x=this.donutRadius*n*Math.cos(r)*o,t.velocity.y=this.donutRadius*n*Math.cos(r)*a,t.position.add(t.velocity),t.velocity.normalize().multiplyScalar(t.startSpeed)}},{key:"toJSON",value:function(){return{type:"donut",radius:this.radius,arc:this.arc,thickness:this.thickness,donutRadius:this.donutRadius,mode:this.mode,spread:this.spread,speed:this.speed.toJSON()}}},{key:"clone",value:function(){return new t({radius:this.radius,arc:this.arc,thickness:this.thickness,donutRadius:this.donutRadius,mode:this.mode,speed:this.speed.clone(),spread:this.spread})}}],[{key:"fromJSON",value:function(e){return new t({radius:e.radius,arc:e.arc,thickness:e.thickness,donutRadius:e.donutRadius,mode:e.mode,speed:e.speed?Wv(e.speed):void 0,spread:e.spread})}}]),t}(),Hy=function(){function t(){av(this,t),lv(this,"type","point")}return hv(t,[{key:"update",value:function(t,e){}},{key:"initialize",value:function(t){var e=Math.random(),i=Math.random(),n=e*Math.PI*2,s=Math.acos(2*i-1),r=Math.cbrt(Math.random()),a=Math.sin(n),o=Math.cos(n),h=Math.sin(s),l=Math.cos(s);t.velocity.x=r*h*o,t.velocity.y=r*h*a,t.velocity.z=r*l,t.velocity.multiplyScalar(t.startSpeed),t.position.setScalar(0)}},{key:"toJSON",value:function(){return{type:"point"}}},{key:"clone",value:function(){return new t}}],[{key:"fromJSON",value:function(e){return new t}}]),t}(),jy=function(){function t(){var e,i,n,s,r,a,o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};av(this,t),lv(this,"type","sphere"),lv(this,"radius",void 0),lv(this,"arc",void 0),lv(this,"thickness",void 0),lv(this,"mode",void 0),lv(this,"spread",void 0),lv(this,"speed",void 0),lv(this,"currentValue",0),this.radius=null!==(e=o.radius)&&void 0!==e?e:10,this.arc=null!==(i=o.arc)&&void 0!==i?i:2*Math.PI,this.thickness=null!==(n=o.thickness)&&void 0!==n?n:1,this.mode=null!==(s=o.mode)&&void 0!==s?s:zy.Random,this.spread=null!==(r=o.spread)&&void 0!==r?r:0,this.speed=null!==(a=o.speed)&&void 0!==a?a:new Gv(1)}return hv(t,[{key:"update",value:function(t,e){zy.Random!=this.mode&&(this.currentValue+=this.speed.genValue(t.emissionState.time/t.duration)*e)}},{key:"initialize",value:function(t){var e=Uy(this.mode,this.currentValue,this.spread),i=Math.random(),n=ne.lerp(1-this.thickness,1,Math.random()),s=e*this.arc,r=Math.acos(2*i-1),a=Math.sin(s),o=Math.cos(s),h=Math.sin(r),l=Math.cos(r);t.position.x=h*o,t.position.y=h*a,t.position.z=l,t.velocity.copy(t.position).multiplyScalar(t.startSpeed),t.position.multiplyScalar(this.radius*n)}},{key:"toJSON",value:function(){return{type:"sphere",radius:this.radius,arc:this.arc,thickness:this.thickness,mode:this.mode,spread:this.spread,speed:this.speed.toJSON()}}},{key:"clone",value:function(){return new t({radius:this.radius,arc:this.arc,thickness:this.thickness,mode:this.mode,speed:this.speed.clone(),spread:this.spread})}}],[{key:"fromJSON",value:function(e){return new t({radius:e.radius,arc:e.arc,thickness:e.thickness,mode:e.mode,speed:e.speed?Wv(e.speed):void 0,spread:e.spread})}}]),t}(),Wy=function(){function t(){var e,i,n,s,r,a,o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};av(this,t),lv(this,"type","sphere"),lv(this,"radius",void 0),lv(this,"arc",void 0),lv(this,"thickness",void 0),lv(this,"mode",void 0),lv(this,"spread",void 0),lv(this,"speed",void 0),lv(this,"currentValue",0),this.radius=null!==(e=o.radius)&&void 0!==e?e:10,this.arc=null!==(i=o.arc)&&void 0!==i?i:2*Math.PI,this.thickness=null!==(n=o.thickness)&&void 0!==n?n:1,this.mode=null!==(s=o.mode)&&void 0!==s?s:zy.Random,this.spread=null!==(r=o.spread)&&void 0!==r?r:0,this.speed=null!==(a=o.speed)&&void 0!==a?a:new Gv(1)}return hv(t,[{key:"update",value:function(t,e){zy.Random!=this.mode&&(this.currentValue+=this.speed.genValue(t.emissionState.time/t.duration)*e)}},{key:"initialize",value:function(t){var e=Uy(this.mode,this.currentValue,this.spread),i=Math.random(),n=ne.lerp(1-this.thickness,1,Math.random()),s=e*this.arc,r=Math.acos(i),a=Math.sin(s),o=Math.cos(s),h=Math.sin(r),l=Math.cos(r);t.position.x=h*o,t.position.y=h*a,t.position.z=l,t.velocity.copy(t.position).multiplyScalar(t.startSpeed),t.position.multiplyScalar(this.radius*n)}},{key:"toJSON",value:function(){return{type:"hemisphere",radius:this.radius,arc:this.arc,thickness:this.thickness,mode:this.mode,spread:this.spread,speed:this.speed.toJSON()}}},{key:"clone",value:function(){return new t({radius:this.radius,arc:this.arc,thickness:this.thickness,mode:this.mode,speed:this.speed.clone(),spread:this.spread})}}],[{key:"fromJSON",value:function(e){return new t({radius:e.radius,arc:e.arc,thickness:e.thickness,mode:e.mode,speed:e.speed?Wv(e.speed):void 0,spread:e.spread})}}]),t}(),Xy=function(){function t(){var e,i,n,s,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};av(this,t),lv(this,"type","grid"),lv(this,"width",void 0),lv(this,"height",void 0),lv(this,"column",void 0),lv(this,"row",void 0),this.width=null!==(e=r.width)&&void 0!==e?e:1,this.height=null!==(i=r.height)&&void 0!==i?i:1,this.column=null!==(n=r.column)&&void 0!==n?n:10,this.row=null!==(s=r.row)&&void 0!==s?s:10}return hv(t,[{key:"initialize",value:function(t){var e=Math.floor(Math.random()*this.row),i=Math.floor(Math.random()*this.column);t.position.x=i*this.width/this.column-this.width/2,t.position.y=e*this.height/this.row-this.height/2,t.position.z=0,t.velocity.set(0,0,t.startSpeed)}},{key:"toJSON",value:function(){return{type:"grid",width:this.width,height:this.height,column:this.column,row:this.row}}},{key:"clone",value:function(){return new t({width:this.width,height:this.height,column:this.column,row:this.row})}},{key:"update",value:function(t,e){}}],[{key:"fromJSON",value:function(e){return new t(e)}}]),t}(),qy=function(){function t(e){av(this,t),lv(this,"type","mesh_surface"),lv(this,"_triangleIndexToArea",[]),lv(this,"_geometry",void 0),lv(this,"_tempA",new Le),lv(this,"_tempB",new Le),lv(this,"_tempC",new Le),e&&(this.geometry=e)}return hv(t,[{key:"geometry",get:function(){return this._geometry},set:function(t){if(this._geometry=t,void 0!==t&&"string"!=typeof t){var e=new qi;this._triangleIndexToArea.length=0;var i=0;if(t.getIndex()){var n=t.getIndex().array,s=n.length/3;this._triangleIndexToArea.push(0);for(var r=0;r<s;r++)e.setFromAttributeAndIndices(t.getAttribute("position"),n[3*r],n[3*r+1],n[3*r+2]),i+=e.getArea(),this._triangleIndexToArea.push(i);t.userData.triangleIndexToArea=this._triangleIndexToArea}}}},{key:"initialize",value:function(t){var e=this._geometry;if(!e||null===e.getIndex())return t.position.set(0,0,0),void t.velocity.set(0,0,1).multiplyScalar(t.startSpeed);for(var i=this._triangleIndexToArea.length-1,n=0,s=i,r=Math.random()*this._triangleIndexToArea[i];n+1<s;){var a=Math.floor((n+s)/2);r<this._triangleIndexToArea[a]?s=a:n=a}var o=Math.random(),h=Math.random();o+h>1&&(o=1-o,h=1-h);var l=e.getIndex().array[3*n],c=e.getIndex().array[3*n+1],u=e.getIndex().array[3*n+2],d=e.getAttribute("position");this._tempA.fromBufferAttribute(d,l),this._tempB.fromBufferAttribute(d,c),this._tempC.fromBufferAttribute(d,u),this._tempB.sub(this._tempA),this._tempC.sub(this._tempA),this._tempA.addScaledVector(this._tempB,o).addScaledVector(this._tempC,h),t.position.copy(this._tempA),this._tempA.copy(this._tempB).cross(this._tempC).normalize(),t.velocity.copy(this._tempA).normalize().multiplyScalar(t.startSpeed)}},{key:"toJSON",value:function(){return{type:"mesh_surface",mesh:this._geometry?this._geometry.uuid:""}}},{key:"clone",value:function(){return new t(this._geometry)}},{key:"update",value:function(t,e){}}],[{key:"fromJSON",value:function(e,i){return new t(i.geometries[e.geometry])}}]),t}(),Yy={circle:{type:"circle",params:[["radius","number"],["arc","radian"],["thickness","number"],["mode","emitterMode"],["spread","number"],["speed","valueFunc"]],constructor:Gy,loadJSON:Gy.fromJSON},cone:{type:"cone",params:[["radius","number"],["arc","radian"],["thickness","number"],["angle","radian"],["mode","emitterMode"],["spread","number"],["speed","valueFunc"]],constructor:Fy,loadJSON:Fy.fromJSON},donut:{type:"donut",params:[["radius","number"],["arc","radian"],["thickness","number"],["donutRadius","number"],["mode","emitterMode"],["spread","number"],["speed","valueFunc"]],constructor:Vy,loadJSON:Vy.fromJSON},point:{type:"point",params:[],constructor:Hy,loadJSON:Hy.fromJSON},sphere:{type:"sphere",params:[["radius","number"],["arc","radian"],["thickness","number"],["angle","radian"],["mode","emitterMode"],["spread","number"],["speed","valueFunc"]],constructor:jy,loadJSON:jy.fromJSON},hemisphere:{type:"hemisphere",params:[["radius","number"],["arc","radian"],["thickness","number"],["angle","radian"],["mode","emitterMode"],["spread","number"],["speed","valueFunc"]],constructor:Wy,loadJSON:Wy.fromJSON},grid:{type:"grid",params:[["width","number"],["height","number"],["rows","number"],["column","number"]],constructor:Xy,loadJSON:Xy.fromJSON},mesh_surface:{type:"mesh_surface",params:[["geometry","geometry"]],constructor:qy,loadJSON:qy.fromJSON}};var Jy=function(t){return t[t.BillBoard=0]="BillBoard",t[t.StretchedBillBoard=1]="StretchedBillBoard",t[t.Mesh=2]="Mesh",t[t.Trail=3]="Trail",t[t.HorizontalBillBoard=4]="HorizontalBillBoard",t[t.VerticalBillBoard=5]="VerticalBillBoard",t}({}),$y=function(t){cv(i,t);var e=mv(i);function i(t){var n;av(this,i),lv(pv(n=e.call(this)),"type","VFXBatch"),lv(pv(n),"systems",void 0),lv(pv(n),"settings",void 0),lv(pv(n),"maxParticles",void 0),n.maxParticles=1e3,n.systems=new Set;var s=new _i;s.mask=t.layers.mask;var r=t.material.clone();return r.defines={},Object.assign(r.defines,t.material.defines),n.settings={instancingGeometry:t.instancingGeometry,renderMode:t.renderMode,renderOrder:t.renderOrder,material:r,uTileCount:t.uTileCount,vTileCount:t.vTileCount,blendTiles:t.blendTiles,softParticles:t.softParticles,softNearFade:t.softNearFade,softFarFade:t.softFarFade,layers:s},n.frustumCulled=!1,n.renderOrder=n.settings.renderOrder,n}return hv(i,[{key:"addSystem",value:function(t){this.systems.add(t)}},{key:"removeSystem",value:function(t){this.systems.delete(t)}},{key:"applyDepthTexture",value:function(t){var e=this.material.uniforms.depthTexture;e&&e.value!==t&&(e.value=t,this.material.needsUpdate=!0)}}]),i}(On),Ky=new Le(0,0,1),Zy=new De,Qy=new Le,tx=new Le;new Le;var ex=new ss(1,1,1,1),ix=function(){function t(e){var i,n,s,r,a,o,h,l,c,u,d,p,m,f,g,v,y,x,b,_,w,M,S,E;if(av(this,t),lv(this,"autoDestroy",void 0),lv(this,"prewarm",void 0),lv(this,"looping",void 0),lv(this,"duration",void 0),lv(this,"startLife",void 0),lv(this,"startSpeed",void 0),lv(this,"startRotation",void 0),lv(this,"startSize",void 0),lv(this,"startColor",void 0),lv(this,"startTileIndex",void 0),lv(this,"rendererEmitterSettings",void 0),lv(this,"emissionOverTime",void 0),lv(this,"emissionOverDistance",void 0),lv(this,"emissionBursts",void 0),lv(this,"onlyUsedByOther",void 0),lv(this,"worldSpace",void 0),lv(this,"particleNum",void 0),lv(this,"paused",void 0),lv(this,"particles",void 0),lv(this,"emitterShape",void 0),lv(this,"emitter",void 0),lv(this,"rendererSettings",void 0),lv(this,"neededToUpdateRender",void 0),lv(this,"behaviors",void 0),lv(this,"emissionState",void 0),lv(this,"prewarmed",void 0),lv(this,"emitEnded",void 0),lv(this,"markForDestroy",void 0),lv(this,"previousWorldPos",void 0),lv(this,"temp",new Le),lv(this,"travelDistance",0),lv(this,"normalMatrix",new re),lv(this,"_renderer",void 0),lv(this,"firstTimeUpdate",!0),this.autoDestroy=void 0!==e.autoDestroy&&e.autoDestroy,this.duration=null!==(i=e.duration)&&void 0!==i?i:1,this.looping=void 0===e.looping||e.looping,this.prewarm=void 0!==e.prewarm&&e.prewarm,this.startLife=null!==(n=e.startLife)&&void 0!==n?n:new Gv(5),this.startSpeed=null!==(s=e.startSpeed)&&void 0!==s?s:new Gv(0),this.startRotation=null!==(r=e.startRotation)&&void 0!==r?r:new Gv(0),this.startSize=null!==(a=e.startSize)&&void 0!==a?a:new Gv(1),this.startColor=null!==(o=e.startColor)&&void 0!==o?o:new Uv(new Ce(1,1,1,1)),this.emissionOverTime=null!==(h=e.emissionOverTime)&&void 0!==h?h:new Gv(10),this.emissionOverDistance=null!==(l=e.emissionOverDistance)&&void 0!==l?l:new Gv(0),this.emissionBursts=null!==(c=e.emissionBursts)&&void 0!==c?c:[],this.onlyUsedByOther=null!==(u=e.onlyUsedByOther)&&void 0!==u&&u,this.emitterShape=null!==(d=e.shape)&&void 0!==d?d:new jy,this.behaviors=null!==(p=e.behaviors)&&void 0!==p?p:new Array,this.worldSpace=null!==(m=e.worldSpace)&&void 0!==m&&m,this.rendererEmitterSettings=null!==(f=e.rendererEmitterSettings)&&void 0!==f?f:{},e.renderMode===Jy.StretchedBillBoard){var T,A,C=this.rendererEmitterSettings;void 0!==e.speedFactor&&(C.speedFactor=e.speedFactor),C.speedFactor=null!==(T=C.speedFactor)&&void 0!==T?T:0,C.lengthFactor=null!==(A=C.lengthFactor)&&void 0!==A?A:0}this.rendererSettings={instancingGeometry:null!==(g=e.instancingGeometry)&&void 0!==g?g:ex,renderMode:null!==(v=e.renderMode)&&void 0!==v?v:Jy.BillBoard,renderOrder:null!==(y=e.renderOrder)&&void 0!==y?y:0,material:e.material,uTileCount:null!==(x=e.uTileCount)&&void 0!==x?x:1,vTileCount:null!==(b=e.vTileCount)&&void 0!==b?b:1,blendTiles:null!==(_=e.blendTiles)&&void 0!==_&&_,softParticles:null!==(w=e.softParticles)&&void 0!==w&&w,softNearFade:null!==(M=e.softNearFade)&&void 0!==M?M:0,softFarFade:null!==(S=e.softFarFade)&&void 0!==S?S:0,layers:null!==(E=e.layers)&&void 0!==E?E:new _i},this.neededToUpdateRender=!0,this.particles=new Array,this.startTileIndex=e.startTileIndex||new Gv(0),this.emitter=new _v(this),this.paused=!1,this.particleNum=0,this.emissionState={burstIndex:0,burstWaveIndex:0,time:0,waitEmiting:0,travelDistance:0},this.emitEnded=!1,this.markForDestroy=!1,this.prewarmed=!1}return hv(t,[{key:"time",get:function(){return this.emissionState.time},set:function(t){this.emissionState.time=t}},{key:"layers",get:function(){return this.rendererSettings.layers}},{key:"texture",get:function(){return this.rendererSettings.material.map},set:function(t){this.rendererSettings.material.map=t,this.neededToUpdateRender=!0}},{key:"material",get:function(){return this.rendererSettings.material},set:function(t){this.rendererSettings.material=t,this.neededToUpdateRender=!0}},{key:"uTileCount",get:function(){return this.rendererSettings.uTileCount},set:function(t){this.rendererSettings.uTileCount=t,this.neededToUpdateRender=!0}},{key:"vTileCount",get:function(){return this.rendererSettings.vTileCount},set:function(t){this.rendererSettings.vTileCount=t,this.neededToUpdateRender=!0}},{key:"blendTiles",get:function(){return this.rendererSettings.blendTiles},set:function(t){this.rendererSettings.blendTiles=t,this.neededToUpdateRender=!0}},{key:"softParticles",get:function(){return this.rendererSettings.softParticles},set:function(t){this.rendererSettings.softParticles=t,this.neededToUpdateRender=!0}},{key:"softNearFade",get:function(){return this.rendererSettings.softNearFade},set:function(t){this.rendererSettings.softNearFade=t,this.neededToUpdateRender=!0}},{key:"softFarFade",get:function(){return this.rendererSettings.softFarFade},set:function(t){this.rendererSettings.softFarFade=t,this.neededToUpdateRender=!0}},{key:"instancingGeometry",get:function(){return this.rendererSettings.instancingGeometry},set:function(t){this.restart(),this.particles.length=0,this.rendererSettings.instancingGeometry=t,this.neededToUpdateRender=!0}},{key:"renderMode",get:function(){return this.rendererSettings.renderMode},set:function(t){if((this.rendererSettings.renderMode!=Jy.Trail&&t===Jy.Trail||this.rendererSettings.renderMode==Jy.Trail&&t!==Jy.Trail)&&(this.restart(),this.particles.length=0),this.rendererSettings.renderMode!==t)switch(t){case Jy.Trail:this.rendererEmitterSettings={startLength:new Gv(30),followLocalOrigin:!1};break;case Jy.Mesh:this.rendererEmitterSettings={geometry:new ss(1,1)},this.startRotation=new qv(new Le(0,1,0),new Gv(0));break;case Jy.StretchedBillBoard:this.rendererEmitterSettings={speedFactor:0,lengthFactor:2},this.rendererSettings.renderMode===Jy.Mesh&&(this.startRotation=new Gv(0));break;case Jy.BillBoard:case Jy.VerticalBillBoard:case Jy.HorizontalBillBoard:this.rendererEmitterSettings={},this.rendererSettings.renderMode===Jy.Mesh&&(this.startRotation=new Gv(0))}this.rendererSettings.renderMode=t,this.neededToUpdateRender=!0}},{key:"renderOrder",get:function(){return this.rendererSettings.renderOrder},set:function(t){this.rendererSettings.renderOrder=t,this.neededToUpdateRender=!0}},{key:"blending",get:function(){return this.rendererSettings.material.blending},set:function(t){this.rendererSettings.material.blending=t,this.neededToUpdateRender=!0}},{key:"pause",value:function(){this.paused=!0}},{key:"play",value:function(){this.paused=!1}},{key:"spawn",value:function(t,e,i){Zy.setFromRotationMatrix(i);var n=Qy,s=Zy,r=tx;i.decompose(n,s,r);for(var a=0;a<t;a++){for(this.particleNum++;this.particles.length<this.particleNum;)this.rendererSettings.renderMode===Jy.Trail?this.particles.push(new Tv):this.particles.push(new Sv);var o=this.particles[this.particleNum-1];if(o.speedModifier=1,this.startColor.genColor(o.startColor,this.emissionState.time,{}),o.color.copy(o.startColor),o.startSpeed=this.startSpeed.genValue(e.time/this.duration),o.life=this.startLife.genValue(e.time/this.duration),o.age=0,o.startSize=this.startSize.genValue(e.time/this.duration),o.uvTile=this.startTileIndex.genValue(),o.size=o.startSize,this.rendererSettings.renderMode===Jy.Mesh||this.rendererSettings.renderMode===Jy.BillBoard||this.rendererSettings.renderMode===Jy.VerticalBillBoard||this.rendererSettings.renderMode===Jy.HorizontalBillBoard||this.rendererSettings.renderMode===Jy.StretchedBillBoard){var h=o;this.rendererSettings.renderMode===Jy.Mesh?(h.rotation instanceof De||(h.rotation=new De),"rotation"===this.startRotation.type?this.startRotation.genValue(h.rotation,e.time/this.duration):h.rotation.setFromAxisAngle(Ky,this.startRotation.genValue(e.time/this.duration))):"rotation"===this.startRotation.type?h.rotation=0:h.rotation=this.startRotation.genValue(e.time/this.duration)}else if(this.rendererSettings.renderMode===Jy.Trail){o.length=this.rendererEmitterSettings.startLength.genValue(e.time/this.duration)}if(this.emitterShape.initialize(o),this.rendererSettings.renderMode===Jy.Trail&&this.rendererEmitterSettings.followLocalOrigin){var l=o;l.localPosition=(new Le).copy(l.position)}this.worldSpace?(o.position.applyMatrix4(i),o.startSize=o.startSize*(Math.abs(r.x)+Math.abs(r.y)+Math.abs(r.z))/3,o.size=o.startSize,o.velocity.multiply(r).applyMatrix3(this.normalMatrix),o.rotation&&o.rotation instanceof De&&o.rotation.multiplyQuaternions(Zy,o.rotation)):this.onlyUsedByOther&&(o.parentMatrix=i);for(var c=0;c<this.behaviors.length;c++)this.behaviors[c].initialize(o)}}},{key:"endEmit",value:function(){this.emitEnded=!0,this.autoDestroy&&(this.markForDestroy=!0)}},{key:"dispose",value:function(){this._renderer&&this._renderer.deleteSystem(this),this.emitter.dispose(),this.emitter.parent&&this.emitter.parent.remove(this.emitter)}},{key:"restart",value:function(){this.paused=!1,this.particleNum=0,this.emissionState.burstIndex=0,this.emissionState.burstWaveIndex=0,this.emissionState.time=0,this.emissionState.waitEmiting=0,this.behaviors.forEach((function(t){t.reset()})),this.emitEnded=!1,this.markForDestroy=!1,this.prewarmed=!1}},{key:"update",value:function(t){if(!this.paused){for(var e=this.emitter;e.parent;)e=e.parent;if("Scene"===e.type)if(this.firstTimeUpdate&&(this.firstTimeUpdate=!1,this.emitter.updateWorldMatrix(!0,!1)),this.emitEnded&&0===this.particleNum)this.markForDestroy&&this.emitter.parent&&this.dispose();else{if(this.looping&&this.prewarm&&!this.prewarmed){this.prewarmed=!0;for(var i=0;i<60*this.duration;i++)this.update(1/60)}t>.1&&(t=.1),this.neededToUpdateRender&&(this._renderer&&this._renderer.updateSystem(this),this.neededToUpdateRender=!1),this.onlyUsedByOther||this.emit(t,this.emissionState,this.emitter.matrixWorld),this.emitterShape.update(this,t);for(var n=0;n<this.behaviors.length;n++){for(var s=0;s<this.particleNum;s++)this.particles[s].died||this.behaviors[n].update(this.particles[s],t);this.behaviors[n].frameUpdate(t)}for(var r=0;r<this.particleNum;r++)this.rendererEmitterSettings.followLocalOrigin&&this.particles[r].localPosition?(this.particles[r].position.copy(this.particles[r].localPosition),this.particles[r].parentMatrix?this.particles[r].position.applyMatrix4(this.particles[r].parentMatrix):this.particles[r].position.applyMatrix4(this.emitter.matrixWorld)):this.particles[r].position.addScaledVector(this.particles[r].velocity,t*this.particles[r].speedModifier),this.particles[r].age+=t;if(this.rendererSettings.renderMode===Jy.Trail)for(var a=0;a<this.particleNum;a++){this.particles[a].update()}for(var o=0;o<this.particleNum;o++){var h=this.particles[o];!h.died||h instanceof Tv&&0!==h.previous.length||(this.particles[o]=this.particles[this.particleNum-1],this.particles[this.particleNum-1]=h,this.particleNum--,o--)}}else this.dispose()}}},{key:"emit",value:function(t,e,i){e.time>this.duration&&(this.looping?(e.time-=this.duration,e.burstIndex=0,this.behaviors.forEach((function(t){t.reset()}))):this.emitEnded||this.onlyUsedByOther||this.endEmit()),this.normalMatrix.getNormalMatrix(i);var n=Math.ceil(e.waitEmiting);for(this.spawn(n,e,i),e.waitEmiting-=n;e.burstIndex<this.emissionBursts.length&&this.emissionBursts[e.burstIndex].time<=e.time;){if(Math.random()<this.emissionBursts[e.burstIndex].probability){var s=this.emissionBursts[e.burstIndex].count.genValue(this.time);this.spawn(s,e,i)}e.burstIndex++}if(!this.emitEnded&&(e.waitEmiting+=t*this.emissionOverTime.genValue(e.time/this.duration),null!=e.previousWorldPos)){this.temp.set(i.elements[12],i.elements[13],i.elements[14]),e.travelDistance+=e.previousWorldPos.distanceTo(this.temp);var r=this.emissionOverDistance.genValue(e.time/this.duration);if(e.travelDistance*r>0){var a=Math.floor(e.travelDistance*r);e.travelDistance-=a/r,e.waitEmiting+=a}}void 0===e.previousWorldPos&&(e.previousWorldPos=new Le),e.previousWorldPos.set(i.elements[12],i.elements[13],i.elements[14]),e.time+=t}},{key:"toJSON",value:function(t){var e,i,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(((void 0===t||"string"==typeof t)&&(t={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}}),t.materials[this.rendererSettings.material.uuid]=this.rendererSettings.material.toJSON(t),n.useUrlForImage)&&void 0!==(null===(e=this.texture)||void 0===e?void 0:e.source)){var s=this.texture.source;t.images[s.uuid]={uuid:s.uuid,url:this.texture.image.url}}i=this.renderMode===Jy.Trail?{startLength:this.rendererEmitterSettings.startLength.toJSON(),followLocalOrigin:this.rendererEmitterSettings.followLocalOrigin}:this.renderMode===Jy.Mesh?{}:this.renderMode===Jy.StretchedBillBoard?{speedFactor:this.rendererEmitterSettings.speedFactor,lengthFactor:this.rendererEmitterSettings.lengthFactor}:{};var r=this.rendererSettings.instancingGeometry;return t.geometries&&!t.geometries[r.uuid]&&(t.geometries[r.uuid]=r.toJSON()),{version:"3.0",autoDestroy:this.autoDestroy,looping:this.looping,prewarm:this.prewarm,duration:this.duration,shape:this.emitterShape.toJSON(),startLife:this.startLife.toJSON(),startSpeed:this.startSpeed.toJSON(),startRotation:this.startRotation.toJSON(),startSize:this.startSize.toJSON(),startColor:this.startColor.toJSON(),emissionOverTime:this.emissionOverTime.toJSON(),emissionOverDistance:this.emissionOverDistance.toJSON(),emissionBursts:this.emissionBursts.map((function(t){return{time:t.time,count:t.count.toJSON(),probability:t.probability,interval:t.interval,cycle:t.cycle}})),onlyUsedByOther:this.onlyUsedByOther,instancingGeometry:this.rendererSettings.instancingGeometry.uuid,renderOrder:this.renderOrder,renderMode:this.renderMode,rendererEmitterSettings:i,material:this.rendererSettings.material.uuid,layers:this.layers.mask,startTileIndex:this.startTileIndex.toJSON(),uTileCount:this.uTileCount,vTileCount:this.vTileCount,blendTiles:this.blendTiles,softParticles:this.rendererSettings.softParticles,softFarFade:this.rendererSettings.softFarFade,softNearFade:this.rendererSettings.softNearFade,behaviors:this.behaviors.map((function(t){return t.toJSON()})),worldSpace:this.worldSpace}}},{key:"addBehavior",value:function(t){this.behaviors.push(t)}},{key:"getRendererSettings",value:function(){return this.rendererSettings}},{key:"clone",value:function(){var e,i=[],n=xv(this.emissionBursts);try{for(n.s();!(e=n.n()).done;){var s=e.value,r={};Object.assign(r,s),i.push(r)}}catch(t){n.e(t)}finally{n.f()}var a,o,h=[],l=xv(this.behaviors);try{for(l.s();!(a=l.n()).done;){var c=a.value;h.push(c.clone())}}catch(t){l.e(t)}finally{l.f()}o=this.renderMode===Jy.Trail?{startLength:this.rendererEmitterSettings.startLength.clone(),followLocalOrigin:this.rendererEmitterSettings.followLocalOrigin}:{};var u=new _i;return u.mask=this.layers.mask,new t({autoDestroy:this.autoDestroy,looping:this.looping,duration:this.duration,shape:this.emitterShape.clone(),startLife:this.startLife.clone(),startSpeed:this.startSpeed.clone(),startRotation:this.startRotation.clone(),startSize:this.startSize.clone(),startColor:this.startColor.clone(),emissionOverTime:this.emissionOverTime.clone(),emissionOverDistance:this.emissionOverDistance.clone(),emissionBursts:i,onlyUsedByOther:this.onlyUsedByOther,instancingGeometry:this.rendererSettings.instancingGeometry,renderMode:this.renderMode,renderOrder:this.renderOrder,rendererEmitterSettings:o,material:this.rendererSettings.material,startTileIndex:this.startTileIndex,uTileCount:this.uTileCount,vTileCount:this.vTileCount,blendTiles:this.blendTiles,softParticles:this.softParticles,softFarFade:this.softFarFade,softNearFade:this.softNearFade,behaviors:h,worldSpace:this.worldSpace,layers:u})}}],[{key:"fromJSON",value:function(e,i,n){var s,r,a,o=function(t,e){return Yy[t.type].loadJSON(t,e)}(e.shape,i);if(e.renderMode===Jy.Trail){var h=e.rendererEmitterSettings;a={startLength:null!=h.startLength?Wv(h.startLength):new Gv(30),followLocalOrigin:h.followLocalOrigin}}else e.renderMode===Jy.Mesh?a={}:e.renderMode===Jy.StretchedBillBoard?(a=e.rendererEmitterSettings,null!=e.speedFactor&&(a.speedFactor=e.speedFactor)):a={};var l=new _i;e.layers&&(l.mask=e.layers);var c=new t({autoDestroy:e.autoDestroy,looping:e.looping,prewarm:e.prewarm,duration:e.duration,shape:o,startLife:Wv(e.startLife),startSpeed:Wv(e.startSpeed),startRotation:$v(e.startRotation),startSize:Wv(e.startSize),startColor:Fv(e.startColor),emissionOverTime:Wv(e.emissionOverTime),emissionOverDistance:Wv(e.emissionOverDistance),emissionBursts:null===(s=e.emissionBursts)||void 0===s?void 0:s.map((function(t){return{time:t.time,count:"number"==typeof t.count?new Gv(t.count):Wv(t.count),probability:t.probability,interval:t.interval,cycle:t.cycle}})),onlyUsedByOther:e.onlyUsedByOther,instancingGeometry:i.geometries[e.instancingGeometry],renderMode:e.renderMode,rendererEmitterSettings:a,renderOrder:e.renderOrder,layers:l,material:e.material?i.materials[e.material]:e.texture?new nn({map:i.textures[e.texture],transparent:null===(r=e.transparent)||void 0===r||r,blending:e.blending,side:2}):new nn({color:16777215,transparent:!0,blending:2,side:2}),startTileIndex:"number"==typeof e.startTileIndex?new Gv(e.startTileIndex):Wv(e.startTileIndex),uTileCount:e.uTileCount,vTileCount:e.vTileCount,blendTiles:e.blendTiles,softParticles:e.softParticles,softFarFade:e.softFarFade,softNearFade:e.softNearFade,behaviors:[],worldSpace:e.worldSpace});return c.behaviors=e.behaviors.map((function(t){var e=function(t,e){return By[t.type].loadJSON(t,e)}(t,c);return"EmitSubParticleSystem"===e.type&&(n[t.subParticleSystem]=e),e})),c}}]),t}(),nx="\n\n#include <common>\n#include <color_pars_fragment>\n#include <map_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n#include <alphatest_pars_fragment>\n\n#include <tile_pars_fragment>\n#include <soft_pars_fragment>\n\nvoid main() {\n\n    #include <clipping_planes_fragment>\n    \n    vec3 outgoingLight = vec3( 0.0 );\n    vec4 diffuseColor = vColor;\n    \n    #include <logdepthbuf_fragment>\n    \n    #include <tile_fragment>\n    #include <alphatest_fragment>\n\n    outgoingLight = diffuseColor.rgb;\n    \n    #ifdef USE_COLOR_AS_ALPHA\n    gl_FragColor = vec4( outgoingLight, diffuseColor.r );\n    #else\n    gl_FragColor = vec4( outgoingLight, diffuseColor.a );\n    #endif\n    \n    #include <soft_fragment>\n    #include <tonemapping_fragment>\n}\n";function sx(t){return 0===t?"uv":"uv".concat(t)}new Le(0,0,1);var rx=function(t){cv(i,t);var e=mv(i);function i(t){var n;return av(this,i),lv(pv(n=e.call(this,t)),"offsetBuffer",void 0),lv(pv(n),"rotationBuffer",void 0),lv(pv(n),"sizeBuffer",void 0),lv(pv(n),"colorBuffer",void 0),lv(pv(n),"uvTileBuffer",void 0),lv(pv(n),"velocityBuffer",void 0),lv(pv(n),"vector_",new Le),lv(pv(n),"vector2_",new Le),lv(pv(n),"vector3_",new Le),lv(pv(n),"quaternion_",new De),lv(pv(n),"quaternion2_",new De),lv(pv(n),"quaternion3_",new De),lv(pv(n),"rotationMat_",new re),lv(pv(n),"rotationMat2_",new re),n.maxParticles=1e3,n.setupBuffers(),n.rebuildMaterial(),n}return hv(i,[{key:"buildExpandableBuffers",value:function(){this.offsetBuffer=new Ao(new Float32Array(3*this.maxParticles),3),this.offsetBuffer.setUsage(Ut),this.geometry.setAttribute("offset",this.offsetBuffer),this.colorBuffer=new Ao(new Float32Array(4*this.maxParticles),4),this.colorBuffer.setUsage(Ut),this.geometry.setAttribute("color",this.colorBuffer),this.settings.renderMode===Jy.Mesh?(this.rotationBuffer=new Ao(new Float32Array(4*this.maxParticles),4),this.rotationBuffer.setUsage(Ut),this.geometry.setAttribute("rotation",this.rotationBuffer)):this.settings.renderMode!==Jy.BillBoard&&this.settings.renderMode!==Jy.HorizontalBillBoard&&this.settings.renderMode!==Jy.VerticalBillBoard&&this.settings.renderMode!==Jy.StretchedBillBoard||(this.rotationBuffer=new Ao(new Float32Array(this.maxParticles),1),this.rotationBuffer.setUsage(Ut),this.geometry.setAttribute("rotation",this.rotationBuffer)),this.sizeBuffer=new Ao(new Float32Array(this.maxParticles),1),this.sizeBuffer.setUsage(Ut),this.geometry.setAttribute("size",this.sizeBuffer),this.uvTileBuffer=new Ao(new Float32Array(this.maxParticles),1),this.uvTileBuffer.setUsage(Ut),this.geometry.setAttribute("uvTile",this.uvTileBuffer),this.settings.renderMode===Jy.StretchedBillBoard&&(this.velocityBuffer=new Ao(new Float32Array(4*this.maxParticles),4),this.velocityBuffer.setUsage(Ut),this.geometry.setAttribute("velocity",this.velocityBuffer))}},{key:"setupBuffers",value:function(){this.geometry&&this.geometry.dispose(),this.geometry=new Fc,this.geometry.setIndex(this.settings.instancingGeometry.getIndex()),this.settings.instancingGeometry.hasAttribute("normal")&&this.geometry.setAttribute("normal",this.settings.instancingGeometry.getAttribute("normal")),this.geometry.setAttribute("position",this.settings.instancingGeometry.getAttribute("position")),this.geometry.setAttribute("uv",this.settings.instancingGeometry.getAttribute("uv")),this.buildExpandableBuffers()}},{key:"expandBuffers",value:function(t){for(;t>=this.maxParticles;)this.maxParticles*=2;this.setupBuffers()}},{key:"rebuildMaterial",value:function(){var t;this.layers.mask=this.settings.layers.mask;var e={};if("MeshStandardMaterial"===this.settings.material.type||"MeshPhysicalMaterial"===this.settings.material.type){var i=this.settings.material;(t=Gn.merge([as.common,as.envmap,as.aomap,as.lightmap,as.emissivemap,as.bumpmap,as.normalmap,as.displacementmap,as.roughnessmap,as.metalnessmap,as.fog,as.lights,{emissive:{value:new Zi(0)},roughness:{value:1},metalness:{value:0},envMapIntensity:{value:1}}])).diffuse.value=i.color,t.opacity.value=i.opacity,t.emissive.value=i.emissive,t.roughness.value=i.roughness,t.metalness.value=i.metalness,i.envMap&&(t.envMap.value=i.envMap,t.envMapIntensity.value=i.envMapIntensity),i.normalMap&&(t.normalMap.value=i.normalMap,t.normalScale.value=i.normalScale),i.roughnessMap&&(t.roughnessMap.value=i.roughnessMap),i.metalnessMap&&(t.metalnessMap.value=i.metalnessMap),i.map&&(t.map=new au(i.map))}else(t={}).map=new au(this.settings.material.map);this.settings.material.alphaTest&&(e.USE_ALPHATEST="",t.alphaTest=new au(this.settings.material.alphaTest)),e.USE_UV="";var n,s=this.settings.uTileCount,r=this.settings.vTileCount;if((s>1||r>1)&&(e.UV_TILE="",t.tileCount=new au(new se(s,r))),this.settings.material.defines&&void 0!==this.settings.material.defines.USE_COLOR_AS_ALPHA&&(e.USE_COLOR_AS_ALPHA=""),this.settings.material.normalMap&&(e.USE_NORMALMAP="",e.NORMALMAP_UV=sx(this.settings.material.normalMap.channel),t.normalMapTransform=new au((new re).copy(this.settings.material.normalMap.matrix))),this.settings.material.map&&(e.USE_MAP="",this.settings.blendTiles&&(e.TILE_BLEND=""),e.MAP_UV=sx(this.settings.material.map.channel),t.mapTransform=new au((new re).copy(this.settings.material.map.matrix))),e.USE_COLOR_ALPHA="",this.settings.softParticles){e.SOFT_PARTICLES="";var a=this.settings.softNearFade,o=1/(this.settings.softFarFade-this.settings.softNearFade);t.softParams=new au(new se(a,o)),t.depthTexture=new au(null);var h=t.projParams=new au(new Ce);n=function(t,e,i){h.value.set(i.near,i.far,0,0)}}var l=!1;if(this.settings.renderMode===Jy.BillBoard||this.settings.renderMode===Jy.VerticalBillBoard||this.settings.renderMode===Jy.HorizontalBillBoard||this.settings.renderMode===Jy.Mesh){var c,u;this.settings.renderMode===Jy.Mesh?"MeshStandardMaterial"===this.settings.material.type||"MeshPhysicalMaterial"===this.settings.material.type?(e.USE_COLOR="",c="\n#define STANDARD\nvarying vec3 vViewPosition;\n#ifdef USE_TRANSMISSION\n\tvarying vec3 vWorldPosition;\n#endif\n#include <common>\n\nattribute vec3 offset;\nattribute vec4 rotation;\nattribute float size;\n#include <tile_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nvoid main() {\n\n    #include <tile_vertex>\n    float x2 = rotation.x + rotation.x, y2 = rotation.y + rotation.y, z2 = rotation.z + rotation.z;\n    float xx = rotation.x * x2, xy = rotation.x * y2, xz = rotation.x * z2;\n    float yy = rotation.y * y2, yz = rotation.y * z2, zz = rotation.z * z2;\n    float wx = rotation.w * x2, wy = rotation.w * y2, wz = rotation.w * z2;\n    float sx = size, sy = size, sz = size;\n\n    mat4 particleMatrix = mat4(( 1.0 - ( yy + zz ) ) * sx, ( xy + wz ) * sx, ( xz - wy ) * sx, 0.0,  // 1. column\n                      ( xy - wz ) * sy, ( 1.0 - ( xx + zz ) ) * sy, ( yz + wx ) * sy, 0.0,  // 2. column\n                      ( xz + wy ) * sz, ( yz - wx ) * sz, ( 1.0 - ( xx + yy ) ) * sz, 0.0,  // 3. column\n                      offset.x, offset.y, offset.z, 1.0);\n\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\n\t// replace defaultnormal_vertex\n\tvec3 transformedNormal = objectNormal;\n    mat3 m = mat3( particleMatrix );\n    transformedNormal /= vec3( dot( m[ 0 ], m[ 0 ] ), dot( m[ 1 ], m[ 1 ] ), dot( m[ 2 ], m[ 2 ] ) );\n    transformedNormal = m * transformedNormal;\n    transformedNormal = normalMatrix * transformedNormal;\n    #ifdef FLIP_SIDED\n        transformedNormal = - transformedNormal;\n    #endif\n    #ifdef USE_TANGENT\n        vec3 transformedTangent = ( modelViewMatrix * vec4( objectTangent, 0.0 ) ).xyz;\n        #ifdef FLIP_SIDED\n        transformedTangent = - transformedTangent;\n        #endif\n    #endif\n\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\n\t// replace include <project_vertex>\n  vec4 mvPosition = vec4( transformed, 1.0 );\n  mvPosition = modelViewMatrix * (particleMatrix * mvPosition);\n\tgl_Position = projectionMatrix * mvPosition;\n\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t\n\tvViewPosition = - mvPosition.xyz;\n\t\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n#ifdef USE_TRANSMISSION\n\tvWorldPosition = worldPosition.xyz;\n#endif\n}\n",u="\n#define STANDARD\n#ifdef PHYSICAL\n#define IOR\n#define SPECULAR\n#endif\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\n#ifdef IOR\nuniform float ior;\n#endif\n#ifdef SPECULAR\nuniform float specularIntensity;\nuniform vec3 specularColor;\n#ifdef USE_SPECULARINTENSITYMAP\nuniform sampler2D specularIntensityMap;\n#endif\n#ifdef USE_SPECULARCOLORMAP\nuniform sampler2D specularColorMap;\n#endif\n#endif\n#ifdef USE_CLEARCOAT\nuniform float clearcoat;\nuniform float clearcoatRoughness;\n#endif\n#ifdef USE_IRIDESCENCE\nuniform float iridescence;\nuniform float iridescenceIOR;\nuniform float iridescenceThicknessMinimum;\nuniform float iridescenceThicknessMaximum;\n#endif\n#ifdef USE_SHEEN\nuniform vec3 sheenColor;\nuniform float sheenRoughness;\n#ifdef USE_SHEENCOLORMAP\nuniform sampler2D sheenColorMap;\n#endif\n#ifdef USE_SHEENROUGHNESSMAP\nuniform sampler2D sheenRoughnessMap;\n#endif\n#endif\n\nvarying vec3 vViewPosition;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <bsdfs>\n#include <iridescence_fragment>\n#include <cube_uv_reflection_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_physical_pars_fragment>\n#include <fog_pars_fragment>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_physical_pars_fragment>\n#include <transmission_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <clearcoat_pars_fragment>\n#include <iridescence_pars_fragment>\n#include <roughnessmap_pars_fragment>\n#include <metalnessmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\nvoid main() {\n    #include <clipping_planes_fragment>\n    vec4 diffuseColor = vec4( diffuse, opacity );\n    ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n    vec3 totalEmissiveRadiance = emissive;\n    #include <logdepthbuf_fragment>\n    #include <map_fragment>\n    #include <color_fragment>\n    #include <alphamap_fragment>\n    #include <alphatest_fragment>\n    #include <roughnessmap_fragment>\n    #include <metalnessmap_fragment>\n    #include <normal_fragment_begin>\n    #include <normal_fragment_maps>\n    #include <clearcoat_normal_fragment_begin>\n    #include <clearcoat_normal_fragment_maps>\n    #include <emissivemap_fragment>\n    // accumulation\n    #include <lights_physical_fragment>\n    #include <lights_fragment_begin>\n    #include <lights_fragment_maps>\n    #include <lights_fragment_end>\n    // modulation\n    #include <aomap_fragment>\n    vec3 totalDiffuse = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse;\n    vec3 totalSpecular = reflectedLight.directSpecular + reflectedLight.indirectSpecular;\n    #include <transmission_fragment>\n    vec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;\n    #ifdef USE_SHEEN\n    // Sheen energy compensation approximation calculation can be found at the end of\n        // https://drive.google.com/file/d/1T0D1VSyR4AllqIJTQAraEIzjlb5h4FKH/view?usp=sharing\n        float sheenEnergyComp = 1.0 - 0.157 * max3( material.sheenColor );\n        outgoingLight = outgoingLight * sheenEnergyComp + sheenSpecular;\n    #endif\n    #ifdef USE_CLEARCOAT\n        float dotNVcc = saturate( dot( geometry.clearcoatNormal, geometry.viewDir ) );\n        vec3 Fcc = F_Schlick( material.clearcoatF0, material.clearcoatF90, dotNVcc );\n        outgoingLight = outgoingLight * ( 1.0 - material.clearcoat * Fcc ) + clearcoatSpecular * material.clearcoat;\n    #endif\n    #include <output_fragment>\n    #include <tonemapping_fragment>\n    #include <encodings_fragment>\n    #include <fog_fragment>\n    #include <premultiplied_alpha_fragment>\n    #include <dithering_fragment>\n}",l=!0):(c="\n#include <common>\n#include <color_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n#include <tile_pars_vertex>\n#include <soft_pars_vertex>\n\nattribute vec3 offset;\nattribute vec4 rotation;\nattribute float size;\n// attribute vec4 color;\n\nvoid main() {\n\n    float x2 = rotation.x + rotation.x, y2 = rotation.y + rotation.y, z2 = rotation.z + rotation.z;\n    float xx = rotation.x * x2, xy = rotation.x * y2, xz = rotation.x * z2;\n    float yy = rotation.y * y2, yz = rotation.y * z2, zz = rotation.z * z2;\n    float wx = rotation.w * x2, wy = rotation.w * y2, wz = rotation.w * z2;\n    float sx = size, sy = size, sz = size;\n    \n    mat4 matrix = mat4(( 1.0 - ( yy + zz ) ) * sx, ( xy + wz ) * sx, ( xz - wy ) * sx, 0.0,  // 1. column\n                      ( xy - wz ) * sy, ( 1.0 - ( xx + zz ) ) * sy, ( yz + wx ) * sy, 0.0,  // 2. column\n                      ( xz + wy ) * sz, ( yz - wx ) * sz, ( 1.0 - ( xx + yy ) ) * sz, 0.0,  // 3. column\n                      offset.x, offset.y, offset.z, 1.0);\n    \n    vec4 mvPosition = modelViewMatrix * (matrix * vec4( position, 1.0 ));\n\n\tvColor = color;\n\n\tgl_Position = projectionMatrix * mvPosition;\n\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n    #include <tile_vertex>\n    #include <soft_vertex>\n}\n",u=nx):(c="\n#include <common>\n#include <color_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\n#include <tile_pars_vertex>\n#include <soft_pars_vertex>\n\nattribute vec3 offset;\nattribute float rotation;\nattribute float size;\n\nvoid main() {\n\t\n    vec2 alignedPosition = ( position.xy ) * size;\n    \n    vec2 rotatedPosition;\n    rotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;\n    rotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;\n#ifdef HORIZONTAL\n    vec4 mvPosition = modelMatrix * vec4( offset, 1.0 );\n    mvPosition.x += rotatedPosition.x;\n    mvPosition.z -= rotatedPosition.y;\n    mvPosition = viewMatrix * mvPosition;\n#elif defined(VERTICAL)\n    vec4 mvPosition = modelMatrix * vec4( offset, 1.0 );\n    mvPosition.y += rotatedPosition.y;\n    mvPosition = viewMatrix * mvPosition;\n    mvPosition.x += rotatedPosition.x;\n#else\n    vec4 mvPosition = modelViewMatrix * vec4( offset, 1.0 );\n    mvPosition.xy += rotatedPosition;\n#endif\n\n\tvColor = color;\n\n\tgl_Position = projectionMatrix * mvPosition;\n\n\t#include <logdepthbuf_vertex>\n\n\t#include <clipping_planes_vertex>\n\n\t#include <tile_vertex>\n\t#include <soft_vertex>\n}\n",u=nx),this.settings.renderMode===Jy.VerticalBillBoard?e.VERTICAL="":this.settings.renderMode===Jy.HorizontalBillBoard&&(e.HORIZONTAL=""),this.material=new Vn({uniforms:t,defines:e,vertexShader:c,fragmentShader:u,transparent:this.settings.material.transparent,depthWrite:!this.settings.material.transparent,blending:this.settings.material.blending,side:this.settings.material.side,alphaTest:this.settings.material.alphaTest,lights:l})}else{if(this.settings.renderMode!==Jy.StretchedBillBoard)throw new Error("render mode unavailable");t.speedFactor=new au(1),this.material=new Vn({uniforms:t,defines:e,vertexShader:"\n#include <common>\n#include <color_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\n#include <tile_pars_vertex>\n#include <soft_pars_vertex>\n\nattribute vec3 offset;\nattribute float rotation;\nattribute float size;\nattribute vec4 velocity;\n\nuniform float speedFactor;\n\nvoid main() {\n    float lengthFactor = velocity.w;\n#ifdef USE_SKEW\n    vec4 mvPosition = modelViewMatrix * vec4( offset, 1.0 );\n    vec3 viewVelocity = normalMatrix * velocity.xyz;\n\n    vec3 scaledPos = vec3(position.xy * size, position.z);\n    float vlength = length(viewVelocity);\n    vec3 projVelocity =  dot(scaledPos, viewVelocity) * viewVelocity / vlength;\n    mvPosition.xyz += scaledPos + projVelocity * (speedFactor / size + lengthFactor / vlength);\n#else\n    vec4 mvPosition = modelViewMatrix * vec4( offset, 1.0 );\n    vec3 viewVelocity = normalMatrix * velocity.xyz;\n    float vlength = length(viewVelocity); \n    mvPosition.xyz += position.y * normalize(cross(mvPosition.xyz, viewVelocity)) * size; // switch the cross to  match unity implementation\n    mvPosition.xyz -= (position.x + 0.5) * viewVelocity * (1.0 + lengthFactor / vlength) * size; // minus position.x to match unity implementation\n#endif\n\tvColor = color;\n\tgl_Position = projectionMatrix * mvPosition;\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <tile_vertex>\n\t#include <soft_vertex>\n}\n",fragmentShader:nx,transparent:this.settings.material.transparent,depthWrite:!this.settings.material.transparent,blending:this.settings.material.blending,side:this.settings.material.side,alphaTest:this.settings.material.alphaTest})}this.material&&n&&(this.material.onBeforeRender=n)}},{key:"update",value:function(){var t=this,e=0,i=0;this.systems.forEach((function(t){i+=t.particleNum})),i>this.maxParticles&&this.expandBuffers(i),this.systems.forEach((function(i){var n=i.particles,s=i.particleNum,r=t.quaternion2_,a=t.vector2_,o=t.vector3_;i.emitter.matrixWorld.decompose(a,r,o),t.rotationMat_.setFromMatrix4(i.emitter.matrixWorld);for(var h=0;h<s;h++,e++){var l=n[h];if(t.settings.renderMode===Jy.Mesh){var c=void 0;if(i.worldSpace)c=l.rotation;else{var u=void 0;u=l.parentMatrix?t.quaternion3_.setFromRotationMatrix(l.parentMatrix):r,(c=t.quaternion_).copy(l.rotation).multiply(u)}t.rotationBuffer.setXYZW(e,c.x,c.y,c.z,c.w)}else t.settings.renderMode!==Jy.StretchedBillBoard&&t.settings.renderMode!==Jy.VerticalBillBoard&&t.settings.renderMode!==Jy.HorizontalBillBoard&&t.settings.renderMode!==Jy.BillBoard||t.rotationBuffer.setX(e,l.rotation);var d=void 0;if(i.worldSpace?d=l.position:(d=t.vector_,l.parentMatrix?d.copy(l.position).applyMatrix4(l.parentMatrix):d.copy(l.position).applyMatrix4(i.emitter.matrixWorld)),t.offsetBuffer.setXYZ(e,d.x,d.y,d.z),t.colorBuffer.setXYZW(e,l.color.x,l.color.y,l.color.z,l.color.w),i.worldSpace||l.parentMatrix?t.sizeBuffer.setX(e,l.size):t.sizeBuffer.setX(e,l.size*(Math.abs(o.x)+Math.abs(o.y)+Math.abs(o.z))/3),t.uvTileBuffer.setX(e,l.uvTile),t.settings.renderMode===Jy.StretchedBillBoard&&t.velocityBuffer){var p=i.rendererEmitterSettings.speedFactor;0===p&&(p=.001);var m=i.rendererEmitterSettings.lengthFactor,f=void 0;i.worldSpace?f=l.velocity:(f=t.vector_,l.parentMatrix?(t.rotationMat2_.setFromMatrix4(l.parentMatrix),f.copy(l.velocity).applyMatrix3(t.rotationMat2_)):f.copy(l.velocity).applyMatrix3(t.rotationMat_)),t.velocityBuffer.setXYZW(e,f.x*p,f.y*p,f.z*p,m)}}})),this.geometry.instanceCount=e,e>0&&(this.offsetBuffer.updateRange.count=3*e,this.offsetBuffer.needsUpdate=!0,this.sizeBuffer.updateRange.count=e,this.sizeBuffer.needsUpdate=!0,this.colorBuffer.updateRange.count=4*e,this.colorBuffer.needsUpdate=!0,this.uvTileBuffer.updateRange.count=e,this.uvTileBuffer.needsUpdate=!0,this.settings.renderMode===Jy.StretchedBillBoard&&this.velocityBuffer&&(this.velocityBuffer.updateRange.count=4*e,this.velocityBuffer.needsUpdate=!0),this.settings.renderMode===Jy.Mesh?(this.rotationBuffer.updateRange.count=4*e,this.rotationBuffer.needsUpdate=!0):this.settings.renderMode!==Jy.StretchedBillBoard&&this.settings.renderMode!==Jy.HorizontalBillBoard&&this.settings.renderMode!==Jy.VerticalBillBoard&&this.settings.renderMode!==Jy.BillBoard||(this.rotationBuffer.updateRange.count=e,this.rotationBuffer.needsUpdate=!0))}},{key:"dispose",value:function(){this.geometry.dispose()}}]),i}($y);new Le(0,0,1);var ax=function(t){cv(i,t);var e=mv(i);function i(t){var n;return av(this,i),lv(pv(n=e.call(this,t)),"positionBuffer",void 0),lv(pv(n),"previousBuffer",void 0),lv(pv(n),"nextBuffer",void 0),lv(pv(n),"uvBuffer",void 0),lv(pv(n),"sideBuffer",void 0),lv(pv(n),"widthBuffer",void 0),lv(pv(n),"colorBuffer",void 0),lv(pv(n),"indexBuffer",void 0),lv(pv(n),"vector_",new Le),lv(pv(n),"vector2_",new Le),lv(pv(n),"vector3_",new Le),lv(pv(n),"quaternion_",new De),n.maxParticles=1e4,n.setupBuffers(),n.rebuildMaterial(),n}return hv(i,[{key:"setupBuffers",value:function(){this.geometry&&this.geometry.dispose(),this.geometry=new vn,this.indexBuffer=new an(new Uint32Array(6*this.maxParticles),1),this.indexBuffer.setUsage(Ut),this.geometry.setIndex(this.indexBuffer),this.positionBuffer=new an(new Float32Array(6*this.maxParticles),3),this.positionBuffer.setUsage(Ut),this.geometry.setAttribute("position",this.positionBuffer),this.previousBuffer=new an(new Float32Array(6*this.maxParticles),3),this.previousBuffer.setUsage(Ut),this.geometry.setAttribute("previous",this.previousBuffer),this.nextBuffer=new an(new Float32Array(6*this.maxParticles),3),this.nextBuffer.setUsage(Ut),this.geometry.setAttribute("next",this.nextBuffer),this.widthBuffer=new an(new Float32Array(2*this.maxParticles),1),this.widthBuffer.setUsage(Ut),this.geometry.setAttribute("width",this.widthBuffer),this.sideBuffer=new an(new Float32Array(2*this.maxParticles),1),this.sideBuffer.setUsage(Ut),this.geometry.setAttribute("side",this.sideBuffer),this.uvBuffer=new an(new Float32Array(4*this.maxParticles),2),this.uvBuffer.setUsage(Ut),this.geometry.setAttribute("uv",this.uvBuffer),this.colorBuffer=new an(new Float32Array(8*this.maxParticles),4),this.colorBuffer.setUsage(Ut),this.geometry.setAttribute("color",this.colorBuffer)}},{key:"expandBuffers",value:function(t){for(;t>=this.maxParticles;)this.maxParticles*=2;this.setupBuffers()}},{key:"rebuildMaterial",value:function(){this.layers.mask=this.settings.layers.mask;var t={lineWidth:{value:1},map:{value:null},useMap:{value:0},alphaMap:{value:null},useAlphaMap:{value:0},resolution:{value:new se(1,1)},sizeAttenuation:{value:1},visibility:{value:1},alphaTest:{value:0}},e={USE_UV:"",USE_COLOR_ALPHA:""};if(this.settings.material.map&&(e.USE_MAP="",e.MAP_UV=sx(this.settings.material.map.channel),t.map=new au(this.settings.material.map),t.mapTransform=new au((new re).copy(this.settings.material.map.matrix))),this.settings.material.defines&&void 0!==this.settings.material.defines.USE_COLOR_AS_ALPHA&&(e.USE_COLOR_AS_ALPHA=""),this.settings.renderMode!==Jy.Trail)throw new Error("render mode unavailable");this.material=new Vn({uniforms:t,defines:e,vertexShader:"\n#include <common>\n#include <tile_pars_vertex>\n#include <color_pars_vertex>\n#include <clipping_planes_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <fog_pars_vertex>\n\nattribute vec3 previous;\nattribute vec3 next;\nattribute float side;\nattribute float width;\n\nuniform vec2 resolution;\nuniform float lineWidth;\nuniform float sizeAttenuation;\n    \nvec2 fix(vec4 i, float aspect) {\n    vec2 res = i.xy / i.w;\n    res.x *= aspect;\n    return res;\n}\n    \nvoid main() {\n\n    #include <tile_vertex>\n    \n    float aspect = resolution.x / resolution.y;\n\n    vColor = color;\n\n    mat4 m = projectionMatrix * modelViewMatrix;\n    vec4 finalPosition = m * vec4( position, 1.0 );\n    vec4 prevPos = m * vec4( previous, 1.0 );\n    vec4 nextPos = m * vec4( next, 1.0 );\n\n    vec2 currentP = fix( finalPosition, aspect );\n    vec2 prevP = fix( prevPos, aspect );\n    vec2 nextP = fix( nextPos, aspect );\n\n    float w = lineWidth * width;\n\n    vec2 dir;\n    if( nextP == currentP ) dir = normalize( currentP - prevP );\n    else if( prevP == currentP ) dir = normalize( nextP - currentP );\n    else {\n        vec2 dir1 = normalize( currentP - prevP );\n        vec2 dir2 = normalize( nextP - currentP );\n        dir = normalize( dir1 + dir2 );\n\n        vec2 perp = vec2( -dir1.y, dir1.x );\n        vec2 miter = vec2( -dir.y, dir.x );\n        //w = clamp( w / dot( miter, perp ), 0., 4., * lineWidth * width );\n\n    }\n\n    //vec2 normal = ( cross( vec3( dir, 0. ) vec3( 0., 0., 1. ) ) ).xy;\n    vec4 normal = vec4( -dir.y, dir.x, 0., 1. );\n    normal.xy *= .5 * w;\n    normal *= projectionMatrix;\n    if( sizeAttenuation == 0. ) {\n        normal.xy *= finalPosition.w;\n        normal.xy /= ( vec4( resolution, 0., 1. ) * projectionMatrix ).xy;\n    }\n\n    finalPosition.xy += normal.xy * side;\n\n    gl_Position = finalPosition;\n\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t\n    vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n    \n\t#include <fog_vertex>\n}",fragmentShader:"\n\n#include <common>\n#include <tile_pars_fragment>\n#include <map_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\nuniform sampler2D alphaMap;\nuniform float useAlphaMap;\nuniform float visibility;\nuniform float alphaTest;\n\nvarying vec4 vColor;\n    \nvoid main() {\n    #include <clipping_planes_fragment>\n    #include <logdepthbuf_fragment>\n\n    vec4 diffuseColor = vColor;\n    \n    #ifdef USE_MAP\n    #include <tile_fragment>\n    #ifndef USE_COLOR_AS_ALPHA\n    #endif\n    #endif\n    if( useAlphaMap == 1. ) diffuseColor.a *= texture2D( alphaMap, vUv).a;\n    if( diffuseColor.a < alphaTest ) discard;\n    gl_FragColor = diffuseColor;\n\n    #include <fog_fragment>\n    #include <tonemapping_fragment>\n}",transparent:this.settings.material.transparent,depthWrite:!this.settings.material.transparent,side:this.settings.material.side,blending:this.settings.material.blending||2})}},{key:"update",value:function(){var t=this,e=0,i=0,n=0;this.systems.forEach((function(t){for(var e=0;e<t.particleNum;e++)n+=2*t.particles[e].previous.length})),n>this.maxParticles&&this.expandBuffers(n),this.systems.forEach((function(n){var s=t.quaternion_,r=t.vector2_,a=t.vector3_;n.emitter.matrixWorld.decompose(r,s,a);for(var o=n.particles,h=n.particleNum,l=t.settings.uTileCount,c=t.settings.vTileCount,u=1/l,d=1/c,p=0;p<h;p++){var m=o[p],f=m.uvTile%c,g=Math.floor(m.uvTile/c+.001),v=m.previous.values(),y=v.next(),x=y.value,b=x;y.done||(y=v.next());var _=void 0;_=void 0!==y.value?y.value:b;for(var w=0;w<m.previous.length;w++,e+=2){if(t.positionBuffer.setXYZ(e,b.position.x,b.position.y,b.position.z),t.positionBuffer.setXYZ(e+1,b.position.x,b.position.y,b.position.z),n.worldSpace?(t.positionBuffer.setXYZ(e,b.position.x,b.position.y,b.position.z),t.positionBuffer.setXYZ(e+1,b.position.x,b.position.y,b.position.z)):(m.parentMatrix?t.vector_.copy(b.position).applyMatrix4(m.parentMatrix):t.vector_.copy(b.position).applyMatrix4(n.emitter.matrixWorld),t.positionBuffer.setXYZ(e,t.vector_.x,t.vector_.y,t.vector_.z),t.positionBuffer.setXYZ(e+1,t.vector_.x,t.vector_.y,t.vector_.z)),n.worldSpace?(t.previousBuffer.setXYZ(e,x.position.x,x.position.y,x.position.z),t.previousBuffer.setXYZ(e+1,x.position.x,x.position.y,x.position.z)):(m.parentMatrix?t.vector_.copy(x.position).applyMatrix4(m.parentMatrix):t.vector_.copy(x.position).applyMatrix4(n.emitter.matrixWorld),t.previousBuffer.setXYZ(e,t.vector_.x,t.vector_.y,t.vector_.z),t.previousBuffer.setXYZ(e+1,t.vector_.x,t.vector_.y,t.vector_.z)),n.worldSpace?(t.nextBuffer.setXYZ(e,_.position.x,_.position.y,_.position.z),t.nextBuffer.setXYZ(e+1,_.position.x,_.position.y,_.position.z)):(m.parentMatrix?t.vector_.copy(_.position).applyMatrix4(m.parentMatrix):t.vector_.copy(_.position).applyMatrix4(n.emitter.matrixWorld),t.nextBuffer.setXYZ(e,t.vector_.x,t.vector_.y,t.vector_.z),t.nextBuffer.setXYZ(e+1,t.vector_.x,t.vector_.y,t.vector_.z)),t.sideBuffer.setX(e,-1),t.sideBuffer.setX(e+1,1),n.worldSpace)t.widthBuffer.setX(e,b.size),t.widthBuffer.setX(e+1,b.size);else if(m.parentMatrix)t.widthBuffer.setX(e,b.size),t.widthBuffer.setX(e+1,b.size);else{var M=(Math.abs(a.x)+Math.abs(a.y)+Math.abs(a.z))/3;t.widthBuffer.setX(e,b.size*M),t.widthBuffer.setX(e+1,b.size*M)}t.uvBuffer.setXY(e,(w/m.previous.length+f)*u,(c-g-1)*d),t.uvBuffer.setXY(e+1,(w/m.previous.length+f)*u,(c-g)*d),t.colorBuffer.setXYZW(e,b.color.x,b.color.y,b.color.z,b.color.w),t.colorBuffer.setXYZW(e+1,b.color.x,b.color.y,b.color.z,b.color.w),w+1<m.previous.length&&(t.indexBuffer.setX(3*i,e),t.indexBuffer.setX(3*i+1,e+1),t.indexBuffer.setX(3*i+2,e+2),i++,t.indexBuffer.setX(3*i,e+2),t.indexBuffer.setX(3*i+1,e+1),t.indexBuffer.setX(3*i+2,e+3),i++),x=b,b=_,y.done||void 0!==(y=v.next()).value&&(_=y.value)}}})),this.positionBuffer.updateRange.count=3*e,this.positionBuffer.needsUpdate=!0,this.previousBuffer.updateRange.count=3*e,this.previousBuffer.needsUpdate=!0,this.nextBuffer.updateRange.count=3*e,this.nextBuffer.needsUpdate=!0,this.sideBuffer.updateRange.count=e,this.sideBuffer.needsUpdate=!0,this.widthBuffer.updateRange.count=e,this.widthBuffer.needsUpdate=!0,this.uvBuffer.updateRange.count=2*e,this.uvBuffer.needsUpdate=!0,this.colorBuffer.updateRange.count=4*e,this.colorBuffer.needsUpdate=!0,this.indexBuffer.updateRange.count=3*i,this.indexBuffer.needsUpdate=!0,this.geometry.setDrawRange(0,3*i)}},{key:"dispose",value:function(){this.geometry.dispose()}}]),i}($y),ox=function(t){cv(i,t);var e=mv(i);function i(){var t;return av(this,i),lv(pv(t=e.call(this)),"batches",[]),lv(pv(t),"systemToBatchIndex",new Map),lv(pv(t),"type","BatchedRenderer"),lv(pv(t),"depthTexture",null),t}return hv(i,[{key:"addSystem",value:function(t){t._renderer=this;for(var e,n=t.getRendererSettings(),s=0;s<this.batches.length;s++)if(i.equals(this.batches[s].settings,n))return this.batches[s].addSystem(t),void this.systemToBatchIndex.set(t,s);switch(n.renderMode){case Jy.Trail:e=new ax(n);break;case Jy.Mesh:case Jy.BillBoard:case Jy.VerticalBillBoard:case Jy.HorizontalBillBoard:case Jy.StretchedBillBoard:e=new rx(n)}this.depthTexture&&e.applyDepthTexture(this.depthTexture),e.addSystem(t),this.batches.push(e),this.systemToBatchIndex.set(t,this.batches.length-1),this.add(e)}},{key:"deleteSystem",value:function(t){var e=this.systemToBatchIndex.get(t);null!=e&&(this.batches[e].removeSystem(t),this.systemToBatchIndex.delete(t))}},{key:"setDepthTexture",value:function(t){this.depthTexture=t;var e,i=xv(this.batches);try{for(i.s();!(e=i.n()).done;){e.value.applyDepthTexture(t)}}catch(t){i.e(t)}finally{i.f()}}},{key:"updateSystem",value:function(t){this.deleteSystem(t),this.addSystem(t)}},{key:"update",value:function(t){this.systemToBatchIndex.forEach((function(e,i){i.update(t)}));for(var e=0;e<this.batches.length;e++)this.batches[e].update()}}],[{key:"equals",value:function(t,e){return t.material.side===e.material.side&&t.material.blending===e.material.blending&&t.material.transparent===e.material.transparent&&t.material.type===e.material.type&&t.material.alphaTest===e.material.alphaTest&&t.material.map===e.material.map&&t.renderMode===e.renderMode&&t.blendTiles===e.blendTiles&&t.softParticles===e.softParticles&&t.softFarFade===e.softFarFade&&t.softNearFade===e.softNearFade&&t.uTileCount===e.uTileCount&&t.vTileCount===e.vTileCount&&t.instancingGeometry===e.instancingGeometry&&t.renderOrder===e.renderOrder&&t.layers.mask===e.layers.mask}}]),i}(Oi);var hx=function(t){cv(i,t);var e=mv(i);function i(t){return av(this,i),e.call(this,t)}return hv(i,[{key:"linkReference",value:function(t){var e={};t.traverse((function(t){e[t.uuid]=t})),t.traverse((function(t){if("ParticleEmitter"===t.type){var i=t.system;i.emitterShape;for(var n=0;n<i.behaviors.length;n++)i.behaviors[n]instanceof py&&(i.behaviors[n].subParticleSystem=e[i.behaviors[n].subParticleSystem])}}))}},{key:"parse",value:function(t,e){var n=fv(uv(i.prototype),"parse",this).call(this,t,e);return this.linkReference(n),n}},{key:"parseObject",value:function(t,e,i,n,s){var r,a,o;function h(t){return e[t],e[t]}function l(t){if(void 0!==t){if(Array.isArray(t)){for(var e=[],n=0,s=t.length;n<s;n++){var r=t[n];i[r],e.push(i[r])}return e}return i[t],i[t]}}function c(t){return n[t],n[t]}var u={textures:n,geometries:e,materials:i};switch(t.type){case"ParticleEmitter":r=ix.fromJSON(t.ps,u,{}).emitter;break;case"Scene":r=new Va,void 0!==t.background&&(Number.isInteger(t.background)?r.background=new Zi(t.background):r.background=c(t.background)),void 0!==t.environment&&(r.environment=c(t.environment)),void 0!==t.fog&&("Fog"===t.fog.type?r.fog=new Ga(t.fog.color,t.fog.near,t.fog.far):"FogExp2"===t.fog.type&&(r.fog=new Fa(t.fog.color,t.fog.density))),void 0!==t.backgroundBlurriness&&(r.backgroundBlurriness=t.backgroundBlurriness);break;case"PerspectiveCamera":r=new jn(t.fov,t.aspect,t.near,t.far),void 0!==t.focus&&(r.focus=t.focus),void 0!==t.zoom&&(r.zoom=t.zoom),void 0!==t.filmGauge&&(r.filmGauge=t.filmGauge),void 0!==t.filmOffset&&(r.filmOffset=t.filmOffset),void 0!==t.view&&(r.view=Object.assign({},t.view));break;case"OrthographicCamera":r=new fs(t.left,t.right,t.top,t.bottom,t.near,t.far),void 0!==t.zoom&&(r.zoom=t.zoom),void 0!==t.view&&(r.view=Object.assign({},t.view));break;case"AmbientLight":r=new Lc(t.color,t.intensity);break;case"DirectionalLight":r=new Dc(t.color,t.intensity);break;case"PointLight":r=new kc(t.color,t.intensity,t.distance,t.decay);break;case"RectAreaLight":r=new Oc(t.color,t.intensity,t.width,t.height);break;case"SpotLight":r=new Tc(t.color,t.intensity,t.distance,t.angle,t.penumbra,t.decay);break;case"HemisphereLight":r=new bc(t.color,t.groundColor,t.intensity);break;case"LightProbe":r=(new Bc).fromJSON(t);break;case"SkinnedMesh":a=h(t.geometry),o=l(t.material),r=new _o(a,o),void 0!==t.bindMode&&(r.bindMode=t.bindMode),void 0!==t.bindMatrix&&r.bindMatrix.fromArray(t.bindMatrix),void 0!==t.skeleton&&(r.skeleton=t.skeleton);break;case"Mesh":a=h(t.geometry),o=l(t.material),r=new On(a,o);break;case"InstancedMesh":a=h(t.geometry),o=l(t.material);var d=t.count,p=t.instanceMatrix,m=t.instanceColor;(r=new Oo(a,o,d)).instanceMatrix=new Ao(new Float32Array(p.array),16),void 0!==m&&(r.instanceColor=new Ao(new Float32Array(m.array),m.itemSize));break;case"LOD":r=new co;break;case"Line":r=new rh(h(t.geometry),l(t.material));break;case"LineLoop":r=new lh(h(t.geometry),l(t.material));break;case"LineSegments":r=new hh(h(t.geometry),l(t.material));break;case"PointCloud":case"Points":r=new fh(h(t.geometry),l(t.material));break;case"Sprite":r=new ao(l(t.material));break;case"Group":r=new Da;break;case"Bone":r=new wo;break;default:r=new Oi}if(r.uuid=t.uuid,void 0!==t.name&&(r.name=t.name),void 0!==t.matrix?(r.matrix.fromArray(t.matrix),void 0!==t.matrixAutoUpdate&&(r.matrixAutoUpdate=t.matrixAutoUpdate),r.matrixAutoUpdate&&r.matrix.decompose(r.position,r.quaternion,r.scale)):(void 0!==t.position&&r.position.fromArray(t.position),void 0!==t.rotation&&r.rotation.fromArray(t.rotation),void 0!==t.quaternion&&r.quaternion.fromArray(t.quaternion),void 0!==t.scale&&r.scale.fromArray(t.scale)),void 0!==t.castShadow&&(r.castShadow=t.castShadow),void 0!==t.receiveShadow&&(r.receiveShadow=t.receiveShadow),t.shadow&&(void 0!==t.shadow.bias&&(r.shadow.bias=t.shadow.bias),void 0!==t.shadow.normalBias&&(r.normalBias=t.shadow.normalBias),void 0!==t.shadow.radius&&(r.radius=t.shadow.radius),void 0!==t.shadow.mapSize&&r.mapSize.fromArray(t.shadow.mapSize),void 0!==t.shadow.camera&&(r.camera=this.parseObject(t.shadow.camera))),void 0!==t.visible&&(r.visible=t.visible),void 0!==t.frustumCulled&&(r.frustumCulled=t.frustumCulled),void 0!==t.renderOrder&&(r.renderOrder=t.renderOrder),void 0!==t.userData&&(r.userData=t.userData),void 0!==t.layers&&(r.layers.mask=t.layers),void 0!==t.children)for(var f=t.children,g=0;g<f.length;g++)r.add(this.parseObject(f[g],e,i,n,s));if(void 0!==t.animations)for(var v=t.animations,y=0;y<v.length;y++){var x=v[y];r.animations.push(s[x])}if("LOD"===t.type){void 0!==t.autoUpdate&&(r.autoUpdate=t.autoUpdate);for(var b=t.levels,_=0;_<b.length;_++){var w=b[_],M=r.getObjectByProperty("uuid",w.object);void 0!==M&&r.addLevel(M,w.distance)}}return r}}]),i}(Vc);var lx=function(t){return t[t.Number=0]="Number",t[t.Vec2=1]="Vec2",t[t.Vec3=2]="Vec3",t[t.Vec4=3]="Vec4",t[t.Boolean=4]="Boolean",t[t.AnyType=5]="AnyType",t[t.NullableAnyType=6]="NullableAnyType",t[t.EventStream=7]="EventStream",t}({}),cx=function(){function t(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};av(this,t),lv(this,"id",void 0),lv(this,"inputs",[]),lv(this,"outputs",[]),lv(this,"definition",void 0),lv(this,"signatureIndex",-1),lv(this,"data",void 0),lv(this,"position",new se),lv(this,"outputValues",[]),this.id=""+Math.round(1e5*Math.random()),this.definition=e,this.signatureIndex=i,this.data=n;for(var s=-1===i?0:i,r=0;r<e.nodeTypeSignatures[s].inputTypes.length;r++)this.inputs.push(void 0);for(var a=0;a<e.nodeTypeSignatures[s].outputTypes.length;a++)this.outputs.push([])}return hv(t,[{key:"inputTypes",get:function(){var t=-1===this.signatureIndex?0:this.signatureIndex;return this.definition.nodeTypeSignatures[t].inputTypes}},{key:"outputTypes",get:function(){var t=-1===this.signatureIndex?0:this.signatureIndex;return this.definition.nodeTypeSignatures[t].outputTypes}},{key:"func",value:function(t,e,i){var n=-1===this.signatureIndex?0:this.signatureIndex;this.definition.nodeTypeSignatures[n].func(t,this.data,e,i)}}]),t}(),ux=hv((function t(e,i,n,s){av(this,t),lv(this,"input",void 0),lv(this,"inputIndex",void 0),lv(this,"output",void 0),lv(this,"outputIndex",void 0),this.input=e,this.inputIndex=i,this.input.outputs[i].push(this),this.output=n,this.outputIndex=s,this.output.inputs[s]=this})),dx=hv((function t(e,i,n,s){if(av(this,t),lv(this,"node",void 0),lv(this,"isInput",void 0),lv(this,"paramIndex",void 0),lv(this,"type",void 0),lv(this,"inputs",void 0),lv(this,"outputs",void 0),this.type=e,this.node=n,this.isInput=i,this.paramIndex=s,i)switch(e){case lx.Vec2:this.inputs=[void 0,void 0],this.outputs=[];break;case lx.Vec3:this.inputs=[void 0,void 0,void 0],this.outputs=[];break;case lx.Vec4:this.inputs=[void 0,void 0,void 0,void 0],this.outputs=[];break;default:this.inputs=[void 0],this.outputs=[]}else switch(e){case lx.Vec2:this.inputs=[],this.outputs=[[],[]];break;case lx.Vec3:this.inputs=[],this.outputs=[[],[],[]];break;case lx.Vec4:this.inputs=[],this.outputs=[[],[],[],[]];break;default:this.inputs=[],this.outputs=[[]]}})),px=function(){function t(){av(this,t),lv(this,"visited",new Set),lv(this,"debug",!1),t.Instance=this}return hv(t,[{key:"buildExecutionOrder",value:function(t,e){t.nodesInOrder.length=0,this.visited.clear();for(var i=0;i<t.outputNodes.length;i++){var n=t.outputNodes[i];void 0!==n.inputs[0]&&this._traverse(n,t,e)}t.compiled=!0}},{key:"_traverseWire",value:function(t,e,i){}},{key:"_traverse",value:function(t,e,i){this.visited.add(t.id);for(var n=0;n<t.inputs.length;n++)if(t.inputs[n]instanceof ux){var s=t.inputs[n].input;s instanceof cx?this.visited.has(s.id)||this._traverse(s,e,i):s instanceof dx&&(s.isInput||this._traverse(s.node,e,i))}else if(t.inputs[n]instanceof dx)for(var r=t.inputs[n],a=0;a<r.inputs.length;a++){var o=r.inputs[a];void 0!==o&&(o.input instanceof cx?this.visited.has(o.input.id)||this._traverse(o.input,e,i):this.visited.has(o.input.node.id)||this._traverse(o.input.node,e,i))}e.nodesInOrder.push(t)}}]),t}();lv(px,"Instance",void 0);var mx=function(t){return t[t.Variable=0]="Variable",t[t.Expression=1]="Expression",t[t.Storage=2]="Storage",t[t.Function=3]="Function",t}({}),fx=function(){function t(e,i){av(this,t),lv(this,"name",void 0),lv(this,"type",void 0),lv(this,"nodeTypeSignatures",[]),this.name=e,this.type=i}return hv(t,[{key:"addSignature",value:function(t,e,i){this.nodeTypeSignatures.push({inputTypes:t,outputTypes:e,func:i})}}]),t}(),gx={},vx=new fx("add",mx.Expression);vx.addSignature([lx.Number,lx.Number],[lx.Number],(function(t,e,i,n){n[0]=i[0]+i[1]})),vx.addSignature([lx.Vec2,lx.Vec2],[lx.Vec2],(function(t,e,i,n){n[0].addVectors(i[0],i[1])})),vx.addSignature([lx.Vec3,lx.Vec3],[lx.Vec3],(function(t,e,i,n){n[0].addVectors(i[0],i[1])})),vx.addSignature([lx.Vec4,lx.Vec4],[lx.Vec4],(function(t,e,i,n){n[0].addVectors(i[0],i[1])})),gx.add=vx;var yx=new fx("sub",mx.Expression);yx.addSignature([lx.Number,lx.Number],[lx.Number],(function(t,e,i,n){n[0]=i[0]-i[1]})),yx.addSignature([lx.Vec2,lx.Vec2],[lx.Vec2],(function(t,e,i,n){n[0].subVectors(i[0],i[1])})),yx.addSignature([lx.Vec3,lx.Vec3],[lx.Vec3],(function(t,e,i,n){n[0].subVectors(i[0],i[1])})),yx.addSignature([lx.Vec4,lx.Vec4],[lx.Vec4],(function(t,e,i,n){n[0].subVectors(i[0],i[1])})),gx.sub=yx;var xx=new fx("mul",mx.Expression);xx.addSignature([lx.Number,lx.Number],[lx.Number],(function(t,e,i,n){n[0]=i[0]*i[1]})),xx.addSignature([lx.Vec2,lx.Number],[lx.Vec2],(function(t,e,i,n){n[0].copy(i[0]).multiplyScalar(i[1])})),xx.addSignature([lx.Vec3,lx.Number],[lx.Vec3],(function(t,e,i,n){n[0].copy(i[0]).multiplyScalar(i[1])})),xx.addSignature([lx.Vec4,lx.Number],[lx.Vec4],(function(t,e,i,n){n[0].copy(i[0]).multiplyScalar(i[1])})),gx.mul=xx;var bx=new fx("div",mx.Expression);bx.addSignature([lx.Number,lx.Number],[lx.Number],(function(t,e,i,n){n[0]=i[0]/i[1]})),bx.addSignature([lx.Vec2,lx.Number],[lx.Vec2],(function(t,e,i,n){n[0].copy(i[0]).divideScalar(i[1])})),bx.addSignature([lx.Vec3,lx.Number],[lx.Vec3],(function(t,e,i,n){n[0].copy(i[0]).divideScalar(i[1])})),bx.addSignature([lx.Vec4,lx.Number],[lx.Vec4],(function(t,e,i,n){n[0].copy(i[0]).divideScalar(i[1])})),gx.div=bx;var _x=new fx("sin",mx.Expression);_x.addSignature([lx.Number],[lx.Number],(function(t,e,i,n){n[0]=Math.sin(i[0])})),gx.sin=_x;var wx=new fx("cos",mx.Expression);wx.addSignature([lx.Number],[lx.Number],(function(t,e,i,n){n[0]=Math.cos(i[0])})),gx.cos=wx;var Mx=new fx("tan",mx.Expression);Mx.addSignature([lx.Number],[lx.Number],(function(t,e,i,n){n[0]=Math.tan(i[0])})),gx.tan=Mx;var Sx=new fx("abs",mx.Expression);Sx.addSignature([lx.Number],[lx.Number],(function(t,e,i,n){n[0]=Math.abs(i[0])})),gx.abs=Sx;var Ex=new fx("min",mx.Expression);Ex.addSignature([lx.Number,lx.Number],[lx.Number],(function(t,e,i,n){n[0]=Math.min(i[0],i[1])})),gx.min=Ex;var Tx=new fx("max",mx.Expression);Tx.addSignature([lx.Number,lx.Number],[lx.Number],(function(t,e,i,n){n[0]=Math.max(i[0],i[1])})),gx.max=Tx;var Ax=new fx("dot",mx.Expression);Ax.addSignature([lx.Vec2,lx.Vec2],[lx.Number],(function(t,e,i,n){n[0]=i[0].dot(i[1])})),Ax.addSignature([lx.Vec3,lx.Vec3],[lx.Number],(function(t,e,i,n){n[0]=i[0].dot(i[1])})),Ax.addSignature([lx.Vec4,lx.Vec4],[lx.Number],(function(t,e,i,n){n[0]=i[0].dot(i[1])})),gx.dot=Ax;var Cx=new fx("cross",mx.Expression);Cx.addSignature([lx.Vec3,lx.Vec3],[lx.Vec3],(function(t,e,i,n){n[0].crossVectors(i[0],i[1])})),gx.cross=Cx;var Ix=new fx("length",mx.Expression);Ix.addSignature([lx.Vec2],[lx.Number],(function(t,e,i,n){n[0]=i[0].length()})),Ix.addSignature([lx.Vec3],[lx.Number],(function(t,e,i,n){n[0]=i[0].length()})),Ix.addSignature([lx.Vec4],[lx.Number],(function(t,e,i,n){n[0]=i[0].length()})),gx.length=Ix;var Rx=new fx("lengthSq",mx.Expression);Rx.addSignature([lx.Vec2],[lx.Number],(function(t,e,i,n){n[0]=i[0].lengthSq()})),Rx.addSignature([lx.Vec3],[lx.Number],(function(t,e,i,n){n[0]=i[0].lengthSq()})),Rx.addSignature([lx.Vec4],[lx.Number],(function(t,e,i,n){n[0]=i[0].lengthSq()})),gx.lengthSq=Rx;var kx=new fx("normalize",mx.Expression);kx.addSignature([lx.Vec2],[lx.Vec2],(function(t,e,i,n){n[0].copy(i[0]).normalize()})),kx.addSignature([lx.Vec3],[lx.Vec3],(function(t,e,i,n){n[0].copy(i[0]).normalize()})),kx.addSignature([lx.Vec4],[lx.Vec4],(function(t,e,i,n){n[0].copy(i[0]).normalize()})),gx.normalize=kx;var Px=new fx("distance",mx.Expression);Px.addSignature([lx.Vec2,lx.Vec2],[lx.Number],(function(t,e,i,n){n[0]=i[0].distanceTo(i[1])})),Px.addSignature([lx.Vec3,lx.Vec3],[lx.Number],(function(t,e,i,n){n[0]=i[0].distanceTo(i[1])})),gx.distance=Px;var Dx=new fx("and",mx.Expression);Dx.addSignature([lx.Boolean,lx.Boolean],[lx.Boolean],(function(t,e,i,n){n[0]=i[0]&&i[1]})),gx.and=Dx;var Lx=new fx("or",mx.Expression);Lx.addSignature([lx.Boolean,lx.Boolean],[lx.Boolean],(function(t,e,i,n){n[0]=i[0]||i[1]})),gx.or=Lx;var Ox=new fx("not",mx.Expression);Ox.addSignature([lx.Boolean],[lx.Boolean],(function(t,e,i,n){n[0]=!i[0]})),gx.not=Ox;var Nx=new fx("equal",mx.Expression);Nx.addSignature([lx.Number,lx.Number],[lx.Boolean],(function(t,e,i,n){n[0]=i[0]===i[1]})),Nx.addSignature([lx.Vec2,lx.Vec2],[lx.Boolean],(function(t,e,i,n){n[0]=i[0].equals(i[1])})),Nx.addSignature([lx.Vec3,lx.Vec3],[lx.Boolean],(function(t,e,i,n){n[0]=i[0].equals(i[1])})),Nx.addSignature([lx.Vec4,lx.Vec4],[lx.Boolean],(function(t,e,i,n){n[0]=i[0].equals(i[1])})),gx.equal=Nx;var Bx=new fx("lessThan",mx.Expression);Bx.addSignature([lx.Number,lx.Number],[lx.Boolean],(function(t,e,i,n){n[0]=i[0]<i[1]})),gx.lessThan=Bx;var zx=new fx("greaterThan",mx.Expression);zx.addSignature([lx.Number,lx.Number],[lx.Boolean],(function(t,e,i,n){n[0]=i[0]>i[1]})),gx.greaterThan=zx;var Ux=new fx("lessThanOrEqual",mx.Expression);Ux.addSignature([lx.Number,lx.Number],[lx.Boolean],(function(t,e,i,n){n[0]=i[0]<=i[1]})),gx.lessThanOrEqual=Ux;var Fx=new fx("greaterThanOrEqual",mx.Expression);Fx.addSignature([lx.Number,lx.Number],[lx.Boolean],(function(t,e,i,n){n[0]=i[0]>=i[1]})),gx.greaterThanOrEqual=Fx;var Gx=new fx("if",mx.Expression);Gx.addSignature([lx.Boolean,lx.AnyType,lx.AnyType],[lx.AnyType],(function(t,e,i,n){n[0]=i[0]?i[1]:i[2]})),gx.if=Gx;var Vx=new fx("number",mx.Expression);Vx.addSignature([],[lx.Number],(function(t,e,i,n){n[0]=e.value})),gx.number=Vx;var Hx=new fx("vec2",mx.Expression);Hx.addSignature([lx.Number,lx.Number],[lx.Vec2],(function(t,e,i,n){n[0].x=i[0],n[0].y=i[1]})),gx.vec2=Hx;var jx=new fx("vec3",mx.Expression);jx.addSignature([lx.Number,lx.Number,lx.Number],[lx.Vec3],(function(t,e,i,n){n[0].x=i[0],n[0].y=i[1],n[0].z=i[2]})),gx.vec3=jx;var Wx=new fx("vec4",mx.Expression);Wx.addSignature([lx.Number,lx.Number,lx.Number,lx.Number],[lx.Vec4],(function(t,e,i,n){n[0].x=i[0],n[0].y=i[1],n[0].z=i[2],n[0].w=i[3]})),gx.vec4=Wx;var Xx=new fx("bool",mx.Expression);Xx.addSignature([],[lx.Boolean],(function(t,e,i,n){n[0]=e.value})),gx.bool=Xx;var qx=new fx("particleProperty",mx.Storage);qx.addSignature([lx.NullableAnyType],[lx.NullableAnyType],(function(t,e,i,n){void 0!==i[0]&&(e.type!==lx.Number?t.particle[e.property].copy(i[0]):t.particle[e.property]=i[0]),void 0!==t.particle[e.property]&&(e.type!==lx.Number?n[0].copy(t.particle[e.property]):n[0]=t.particle[e.property])})),gx.particleProperty=qx;var Yx=new fx("emit",mx.Function);Yx.addSignature([lx.EventStream],[],(function(t,e,i,n){for(var s=i[0],r=0;r<s.length;r++)t.signal(r,s[r])})),gx.emit=Yx;var Jx=new fx("graphProperty",mx.Storage);Jx.addSignature([lx.NullableAnyType],[lx.NullableAnyType],(function(t,e,i,n){void 0!==i[0]&&(e.type!==lx.Number?t.graph[e.property].copy(i[0]):t.graph[e.property]=i[0]),void 0!==t.graph[e.property]&&(e.type!==lx.Number?n[0].copy(t.graph[e.property]):n[0]=t.graph[e.property])})),gx.graphProperty=Jx;var $x=new fx("startEvent",mx.Expression);$x.addSignature([],[lx.EventStream],(function(t,e,i,n){n[0]=[{type:"start"}]})),gx.startEvent=$x;var Kx=new fx("repeater",mx.Expression);Kx.addSignature([lx.EventStream,lx.Number],[lx.EventStream],(function(t,e,i,n){for(var s=i[0],r=i[1],a=[],o=0;o<s.length;o++)for(var h=0;h<r;h++)a.push(s[o]);n[0]=a})),gx.repeater=Kx;var Zx=new fx("time",mx.Expression);Zx.addSignature([],[lx.Number],(function(t,e,i,n){n[0]=t.emissionState.time})),gx.time=Zx;var Qx=new fx("delta",mx.Expression);Qx.addSignature([],[lx.Number],(function(t,e,i,n){n[0]=t.delta})),gx.delta=Qx;var tb=new fx("output",mx.Storage);tb.addSignature([lx.Number],[lx.Number],(function(t,e,i,n){n[0]=i[0]})),tb.addSignature([lx.Vec2],[lx.Vec2],(function(t,e,i,n){n[0]=i[0]})),tb.addSignature([lx.Vec3],[lx.Vec3],(function(t,e,i,n){n[0]=i[0]})),tb.addSignature([lx.Vec4],[lx.Vec4],(function(t,e,i,n){n[0]=i[0]})),tb.addSignature([lx.Boolean],[lx.Boolean],(function(t,e,i,n){n[0]=i[0]})),gx.output=tb;var eb=new fx("lerp",mx.Expression);eb.addSignature([lx.Number,lx.Number,lx.Number],[lx.Number],(function(t,e,i,n){n[0]=i[0]*(1-i[2])+i[1]*i[2]})),eb.addSignature([lx.Vec2,lx.Vec2,lx.Number],[lx.Vec2],(function(t,e,i,n){n[0].lerpVectors(i[0],i[1],i[2])})),eb.addSignature([lx.Vec3,lx.Vec3,lx.Number],[lx.Vec3],(function(t,e,i,n){n[0].lerpVectors(i[0],i[1],i[2])})),eb.addSignature([lx.Vec4,lx.Vec4,lx.Number],[lx.Vec4],(function(t,e,i,n){n[0].lerpVectors(i[0],i[1],i[2])})),gx.lerp=eb;var ib=new fx("normDistrib",mx.Expression);ib.addSignature([lx.Number],[lx.Number],(function(t,e,i,n){n[0]=function(t){return 1/Math.sqrt(2*Math.PI)*Math.exp(t*t*-.5)}(i[0])})),gx.normDistrib=ib;var nb=new fx("normcdf",mx.Expression);nb.addSignature([lx.Number],[lx.Number],(function(t,e,i,n){var s=i[0],r=1;s<0&&(r=-1);var a=1/(1+.3275911*(s=Math.abs(s)/Math.sqrt(2))),o=1-((((1.061405429*a-1.453152027)*a+1.421413741)*a-.284496736)*a+.254829592)*a*Math.exp(-s*s);n[0]=.5*(1+r*o)})),gx.normcdf=nb;var sb=new fx("normcdfInv",mx.Expression),rb=function(t){var e=[2.515517,.802853,.010328],i=[1.432788,.189269,.001308];return t-((e[2]*t+e[1])*t+e[0])/(((i[2]*t+i[1])*t+i[0])*t+1)},ab=function(t){return t<.5?-rb(Math.sqrt(-2*Math.log(t))):rb(Math.sqrt(-2*Math.log(1-t)))};sb.addSignature([lx.Number],[lx.Number],(function(t,e,i,n){n[0]=ab(i[0])})),gx.normcdfInv=sb;var ob=new fx("clamp",mx.Expression);ob.addSignature([lx.Number,lx.Number,lx.Number],[lx.Number],(function(t,e,i,n){n[0]=Math.max(Math.min(i[0],i[2]),i[1])})),gx.clamp=ob;var hb=new fx("smoothstep",mx.Expression);hb.addSignature([lx.Number,lx.Number,lx.Number],[lx.Number],(function(t,e,i,n){var s=Math.max(Math.min(i[0],i[2]),i[1]);n[0]=s*s*(3-2*s)})),gx.smoothstep=hb;var lb=new fx("random",mx.Expression);lb.addSignature([lx.Number,lx.Number],[lx.Number],(function(t,e,i,n){n[0]=Math.random()*(i[1]-i[0])+i[0]})),lb.addSignature([lx.Vec2,lx.Vec2],[lx.Vec2],(function(t,e,i,n){var s=Math.random();n[0].lerpVectors(i[0],i[1],s)})),lb.addSignature([lx.Vec3,lx.Vec3],[lx.Vec3],(function(t,e,i,n){var s=Math.random();n[0].lerpVectors(i[0],i[1],s)})),lb.addSignature([lx.Vec4,lx.Vec4],[lx.Vec4],(function(t,e,i,n){var s=Math.random();n[0].lerpVectors(i[0],i[1],s)})),gx.random=lb;var cb=new fx("vrand",mx.Expression);cb.addSignature([],[lx.Vec2],(function(t,e,i,n){var s=ab(Math.random()),r=ab(Math.random()),a=Math.sqrt(s*s+r*r);n[0].set(s/a,r/a)})),cb.addSignature([],[lx.Vec3],(function(t,e,i,n){var s=ab(Math.random()),r=ab(Math.random()),a=ab(Math.random()),o=Math.sqrt(s*s+r*r+a*a);n[0].set(s/o,r/o,a/o)})),cb.addSignature([],[lx.Vec4],(function(t,e,i,n){var s=ab(Math.random()),r=ab(Math.random()),a=ab(Math.random()),o=ab(Math.random()),h=Math.sqrt(s*s+r*r+a*a+o*o);n[0].set(s/h,r/h,a/h,o/h)})),gx.vrand=cb;var ub=new fx("bsdf",mx.Storage);ub.addSignature([lx.Vec3,lx.Vec3,lx.Vec3,lx.Number],[],(function(t,e,i,n){})),gx.bsdf=ub;new Set(["output","particleProperty","graphProperty","emit"]);new Le(0,0,1);new De,new Le,new Le,new ss(1,1,1,1),new Map([[lx.Vec2,2],[lx.Vec3,3],[lx.Vec4,4]]);sv.tile_pars_vertex="\n#ifdef UV_TILE\n    attribute float uvTile;\n    uniform vec2 tileCount;\n    \n    mat3 makeTileTransform(float uvTile) {\n        float col = mod(uvTile, tileCount.x);\n        float row = (tileCount.y - floor(uvTile / tileCount.x) - 1.0);\n        \n        return mat3(\n          1.0 / tileCount.x, 0.0, 0.0,\n          0.0, 1.0 / tileCount.y, 0.0, \n          col / tileCount.x, row / tileCount.y, 1.0);\n    }\n#else\n    mat3 makeTileTransform(float uvTile) {\n        return mat3(1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 1.0);\n    }\n#endif\n\n#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\n\tvarying vec2 vUv;\n#ifdef TILE_BLEND\n    varying vec2 vUvNext;\n    varying float vUvBlend;\n#endif\n\n#endif\n#ifdef USE_MAP\n\n\tuniform mat3 mapTransform;\n\tvarying vec2 vMapUv;\n#ifdef TILE_BLEND\n    varying vec2 vMapUvNext;\n#endif\n\n#endif\n#ifdef USE_ALPHAMAP\n\n\tuniform mat3 alphaMapTransform;\n\tvarying vec2 vAlphaMapUv;\n\n#endif\n#ifdef USE_LIGHTMAP\n\n\tuniform mat3 lightMapTransform;\n\tvarying vec2 vLightMapUv;\n\n#endif\n#ifdef USE_AOMAP\n\n\tuniform mat3 aoMapTransform;\n\tvarying vec2 vAoMapUv;\n\n#endif\n#ifdef USE_BUMPMAP\n\n\tuniform mat3 bumpMapTransform;\n\tvarying vec2 vBumpMapUv;\n\n#endif\n#ifdef USE_NORMALMAP\n\n\tuniform mat3 normalMapTransform;\n\tvarying vec2 vNormalMapUv;\n\n#endif\n#ifdef USE_DISPLACEMENTMAP\n\n\tuniform mat3 displacementMapTransform;\n\tvarying vec2 vDisplacementMapUv;\n\n#endif\n#ifdef USE_EMISSIVEMAP\n\n\tuniform mat3 emissiveMapTransform;\n\tvarying vec2 vEmissiveMapUv;\n\n#endif\n#ifdef USE_METALNESSMAP\n\n\tuniform mat3 metalnessMapTransform;\n\tvarying vec2 vMetalnessMapUv;\n\n#endif\n#ifdef USE_ROUGHNESSMAP\n\n\tuniform mat3 roughnessMapTransform;\n\tvarying vec2 vRoughnessMapUv;\n\n#endif\n#ifdef USE_ANISOTROPYMAP\n\n\tuniform mat3 anisotropyMapTransform;\n\tvarying vec2 vAnisotropyMapUv;\n\n#endif\n#ifdef USE_CLEARCOATMAP\n\n\tuniform mat3 clearcoatMapTransform;\n\tvarying vec2 vClearcoatMapUv;\n\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\n\tuniform mat3 clearcoatNormalMapTransform;\n\tvarying vec2 vClearcoatNormalMapUv;\n\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\n\tuniform mat3 clearcoatRoughnessMapTransform;\n\tvarying vec2 vClearcoatRoughnessMapUv;\n\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\n\tuniform mat3 sheenColorMapTransform;\n\tvarying vec2 vSheenColorMapUv;\n\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\n\tuniform mat3 sheenRoughnessMapTransform;\n\tvarying vec2 vSheenRoughnessMapUv;\n\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\n\tuniform mat3 iridescenceMapTransform;\n\tvarying vec2 vIridescenceMapUv;\n\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\n\tuniform mat3 iridescenceThicknessMapTransform;\n\tvarying vec2 vIridescenceThicknessMapUv;\n\n#endif\n#ifdef USE_SPECULARMAP\n\n\tuniform mat3 specularMapTransform;\n\tvarying vec2 vSpecularMapUv;\n\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\n\tuniform mat3 specularColorMapTransform;\n\tvarying vec2 vSpecularColorMapUv;\n\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\n\tuniform mat3 specularIntensityMapTransform;\n\tvarying vec2 vSpecularIntensityMapUv;\n\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\n\tuniform mat3 transmissionMapTransform;\n\tvarying vec2 vTransmissionMapUv;\n\n#endif\n#ifdef USE_THICKNESSMAP\n\n\tuniform mat3 thicknessMapTransform;\n\tvarying vec2 vThicknessMapUv;\n\n#endif\n",sv.tile_vertex="\n#ifdef UV_TILE\n    mat3 tileTransform = makeTileTransform(floor(uvTile));\n    #ifdef TILE_BLEND\n        mat3 nextTileTransform = makeTileTransform(ceil(uvTile));\n        vUvBlend = fract(uvTile);\n    #endif\n#else\n    mat3 tileTransform = makeTileTransform(0.0);\n#endif\n\n#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\nvUv = (tileTransform *vec3( uv, 1 )).xy;\n#if defined( TILE_BLEND ) && defined( UV_TILE )\n    vUvNext = (nextTileTransform *vec3( uv, 1 )).xy;\n#endif\n\n#endif\n#ifdef USE_MAP\n\nvMapUv = ( tileTransform * (mapTransform * vec3( MAP_UV, 1 ) )).xy;\n#if defined( TILE_BLEND ) && defined( UV_TILE )\n    vMapUvNext = (nextTileTransform * (mapTransform * vec3( MAP_UV, 1 ))).xy;\n#endif\n\n#endif\n#ifdef USE_ALPHAMAP\n\nvAlphaMapUv = ( tileTransform * (alphaMapTransform * vec3( ALPHAMAP_UV, 1 ) )).xy;\n    \n#endif\n#ifdef USE_LIGHTMAP\n\nvLightMapUv = ( tileTransform * (lightMapTransform * vec3( LIGHTMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_AOMAP\n\nvAoMapUv = ( tileTransform * (aoMapTransform * vec3( AOMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_BUMPMAP\n\nvBumpMapUv = ( tileTransform * (bumpMapTransform * vec3( BUMPMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_NORMALMAP\n\nvNormalMapUv = ( tileTransform * (normalMapTransform * vec3( NORMALMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_DISPLACEMENTMAP\n\nvDisplacementMapUv = ( tileTransform * (displacementMapTransform * vec3( DISPLACEMENTMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_EMISSIVEMAP\n\nvEmissiveMapUv = ( tileTransform * (emissiveMapTransform * vec3( EMISSIVEMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_METALNESSMAP\n\nvMetalnessMapUv = ( tileTransform * (metalnessMapTransform * vec3( METALNESSMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_ROUGHNESSMAP\n\nvRoughnessMapUv = ( tileTransform * (roughnessMapTransform * vec3( ROUGHNESSMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_ANISOTROPYMAP\n\nvAnisotropyMapUv = ( tileTransform * (anisotropyMapTransform * vec3( ANISOTROPYMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_CLEARCOATMAP\n\nvClearcoatMapUv = ( tileTransform * (clearcoatMapTransform * vec3( CLEARCOATMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\nvClearcoatNormalMapUv = ( tileTransform * (clearcoatNormalMapTransform * vec3( CLEARCOAT_NORMALMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\nvClearcoatRoughnessMapUv = ( tileTransform * (clearcoatRoughnessMapTransform * vec3( CLEARCOAT_ROUGHNESSMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\nvIridescenceMapUv = ( tileTransform * (iridescenceMapTransform * vec3( IRIDESCENCEMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\nvIridescenceThicknessMapUv = ( tileTransform * (iridescenceThicknessMapTransform * vec3( IRIDESCENCE_THICKNESSMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\nvSheenColorMapUv = ( tileTransform * (sheenColorMapTransform * vec3( SHEEN_COLORMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\nvSheenRoughnessMapUv = ( tileTransform * (sheenRoughnessMapTransform * vec3( SHEEN_ROUGHNESSMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_SPECULARMAP\n\nvSpecularMapUv = ( tileTransform * (specularMapTransform * vec3( SPECULARMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\nvSpecularColorMapUv = ( tileTransform * (specularColorMapTransform * vec3( SPECULAR_COLORMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\nvSpecularIntensityMapUv = ( tileTransform * (specularIntensityMapTransform * vec3( SPECULAR_INTENSITYMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\nvTransmissionMapUv = ( tileTransform * transmissionMapTransform * vec3( TRANSMISSIONMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_THICKNESSMAP\n\nvThicknessMapUv = ( tileTransform * thicknessMapTransform * vec3( THICKNESSMAP_UV, 1 ) )).xy;\n\n#endif\n\n",sv.tile_pars_fragment="\n#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\n\tvarying vec2 vUv;\n#ifdef TILE_BLEND\n    varying vec2 vUvNext;\n    varying float vUvBlend;\n#endif\n\n#endif\n#ifdef USE_MAP\n\n\tuniform mat3 mapTransform;\n\tvarying vec2 vMapUv;\n#ifdef TILE_BLEND\n    varying vec2 vMapUvNext;\n#endif\n\n#endif\n#ifdef USE_ALPHAMAP\n\n\tuniform mat3 alphaMapTransform;\n\tvarying vec2 vAlphaMapUv;\n\n#endif\n#ifdef USE_LIGHTMAP\n\n\tuniform mat3 lightMapTransform;\n\tvarying vec2 vLightMapUv;\n\n#endif\n#ifdef USE_AOMAP\n\n\tuniform mat3 aoMapTransform;\n\tvarying vec2 vAoMapUv;\n\n#endif\n#ifdef USE_BUMPMAP\n\n\tuniform mat3 bumpMapTransform;\n\tvarying vec2 vBumpMapUv;\n\n#endif\n#ifdef USE_NORMALMAP\n\n\tuniform mat3 normalMapTransform;\n\tvarying vec2 vNormalMapUv;\n\n#endif\n#ifdef USE_DISPLACEMENTMAP\n\n\tuniform mat3 displacementMapTransform;\n\tvarying vec2 vDisplacementMapUv;\n\n#endif\n#ifdef USE_EMISSIVEMAP\n\n\tuniform mat3 emissiveMapTransform;\n\tvarying vec2 vEmissiveMapUv;\n\n#endif\n#ifdef USE_METALNESSMAP\n\n\tuniform mat3 metalnessMapTransform;\n\tvarying vec2 vMetalnessMapUv;\n\n#endif\n#ifdef USE_ROUGHNESSMAP\n\n\tuniform mat3 roughnessMapTransform;\n\tvarying vec2 vRoughnessMapUv;\n\n#endif\n#ifdef USE_ANISOTROPYMAP\n\n\tuniform mat3 anisotropyMapTransform;\n\tvarying vec2 vAnisotropyMapUv;\n\n#endif\n#ifdef USE_CLEARCOATMAP\n\n\tuniform mat3 clearcoatMapTransform;\n\tvarying vec2 vClearcoatMapUv;\n\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\n\tuniform mat3 clearcoatNormalMapTransform;\n\tvarying vec2 vClearcoatNormalMapUv;\n\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\n\tuniform mat3 clearcoatRoughnessMapTransform;\n\tvarying vec2 vClearcoatRoughnessMapUv;\n\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\n\tuniform mat3 sheenColorMapTransform;\n\tvarying vec2 vSheenColorMapUv;\n\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\n\tuniform mat3 sheenRoughnessMapTransform;\n\tvarying vec2 vSheenRoughnessMapUv;\n\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\n\tuniform mat3 iridescenceMapTransform;\n\tvarying vec2 vIridescenceMapUv;\n\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\n\tuniform mat3 iridescenceThicknessMapTransform;\n\tvarying vec2 vIridescenceThicknessMapUv;\n\n#endif\n#ifdef USE_SPECULARMAP\n\n\tuniform mat3 specularMapTransform;\n\tvarying vec2 vSpecularMapUv;\n\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\n\tuniform mat3 specularColorMapTransform;\n\tvarying vec2 vSpecularColorMapUv;\n\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\n\tuniform mat3 specularIntensityMapTransform;\n\tvarying vec2 vSpecularIntensityMapUv;\n\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\n\tuniform mat3 transmissionMapTransform;\n\tvarying vec2 vTransmissionMapUv;\n\n#endif\n#ifdef USE_THICKNESSMAP\n\n\tuniform mat3 thicknessMapTransform;\n\tvarying vec2 vThicknessMapUv;\n\n#endif\n",sv.tile_fragment="\n#ifdef USE_MAP\n    vec4 texelColor = texture2D( map, vUv);\n    #ifdef TILE_BLEND\n        texelColor = mix( texelColor, texture2D( map, vUvNext ), vUvBlend );\n    #endif\n    diffuseColor *= texelColor;\n#endif\n",sv.soft_pars_vertex="\n#ifdef SOFT_PARTICLES\n    varying vec4 projPosition;\n    varying float linearDepth;\n#endif\n",sv.soft_vertex="\n#ifdef SOFT_PARTICLES\n    projPosition = gl_Position;\n    linearDepth = -mvPosition.z;\n#endif\n",sv.soft_pars_fragment="\n#ifdef SOFT_PARTICLES\n\n    uniform sampler2D depthTexture;\n    uniform vec4 projParams;\n    uniform vec2 softParams;\n\n    varying vec4 projPosition;\n    varying float linearDepth;\n\n    #define SOFT_NEAR_FADE softParams.x\n    #define SOFT_INV_FADE_DISTANCE softParams.y\n\n    #define zNear projParams.x\n    #define zFar projParams.y\n\n    float linearize_depth(float d)\n    {\n        return (zFar * zNear) / (zFar - d * (zFar - zNear));\n    }\n\n#endif\n",sv.soft_fragment="\n#ifdef SOFT_PARTICLES\n\n    /* #ifdef LOGDEPTH\n    float distSample = linearize_depth_log(sampleDepth, near, far);\n    #else\n    float distSample = ortho ? linearize_depth_ortho(sampleDepth, near, far) : linearize_depth(sampleDepth, near, far);\n    #endif */\n\n    vec2 p2 = projPosition.xy / projPosition.w;\n    \n    p2 = 0.5 * p2 + 0.5;\n\n    float readDepth = texture2D(depthTexture, p2.xy).r;\n    float viewDepth = linearize_depth(readDepth);\n\n    float softParticlesFade = saturate(SOFT_INV_FADE_DISTANCE * ((viewDepth - SOFT_NEAR_FADE) - linearDepth));\n    \n    gl_FragColor *= softParticlesFade;\n\n    //gl_FragColor = vec4(softParticlesFade , 0, 0, 1);\n#endif\n";class db{constructor(t){this.vfxPath=t,this.totalTime=0,this.refreshIndex=0,this.refreshTime=2,this.processFlag=!1,this.batchRenderer=new ox,this.loaded=!1,this.groups=[]}initEffect(t,e){this.loaded||(this.loaded=!0,(new hx).load(this.vfxPath,(i=>{i.traverse((t=>{t instanceof _v&&this.batchRenderer.addSystem(t.system)})),i instanceof _v&&this.batchRenderer.addSystem(i.system),e.add(this.batchRenderer,i),this.groups.push(i),this.target=t})))}Start(){if(!this.processFlag&&this.loaded){try{this.groups[this.refreshIndex].traverse((t=>{t instanceof _v&&t.system.restart()}))}catch(t){}this.target&&this.groups[this.refreshIndex].position.copy(this.target),this.processFlag=!0}}Update(t){if(this.processFlag&&(this.groups.forEach((e=>e.traverse((e=>{e.userData&&e.userData.func&&e.userData.func.call(e,t)})))),this.totalTime+=t,this.totalTime>this.refreshTime&&(this.totalTime=0,this.processFlag=!1),this.batchRenderer)){const e=console.warn;console.warn=()=>{},this.batchRenderer.update(t),console.warn=e}}}var pb,mb=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class fb{constructor(){this.totalTime=0,this.refreshIndex=0,this.refreshTime=5,this.processFlag=!1,this.batchRenderer=new ox,this.loaded=!1,this.textureloader=new yc,this.groups=[]}initTrailEffect(t,e){return mb(this,void 0,void 0,(function*(){if(this.loaded)return;this.texture=yield this.textureloader.loadAsync("assets/vfx/textures/texture1.png"),this.texture.name="assets/vfx/textures/texture1.png",this.loaded=!0;const i=new Da,n=new ix({duration:5,looping:!1,startLife:new Vv(3.8,4.4),startSpeed:new Vv(10,15),startSize:new Gv(.2),startColor:new Dv(new Ce(1,1,1,1),new Ce(1,1,1,1)),worldSpace:!0,emissionOverTime:new Gv(0),emissionBursts:[{time:0,count:new Gv(100),cycle:1,interval:.01,probability:1}],shape:new Fy({radius:.1,angle:1}),material:new nn({map:this.texture,blending:2,transparent:!0,side:2}),renderMode:Jy.Trail,rendererEmitterSettings:{startLength:new Gv(20)},startTileIndex:new Gv(0),uTileCount:10,vTileCount:10,renderOrder:0});n.emitter.name="beam",n.addBehavior(new iy(new jv([[new Av(1,.95,.75,0),0]]))),n.addBehavior(new Kv(new zv(new Nv([[new Le(1,0,0),0],[new Le(1,0,0),0]],[[1,0],[1,1]]),new Nv([[new Le(0,1,0),0],[new Le(0,1,0),1]],[[1,0],[1,1]])))),n.addBehavior(new oy(new Le(0,-1,0),new Gv(20))),n.addBehavior(new Py({resolve:(t,e)=>t.y<=-6&&(e.set(0,1,0),!0)},.6)),n.emitter.rotation.x=-Math.PI/2,i.add(n.emitter),this.batchRenderer.addSystem(n),this.target=t,i.visible=!0,e.add(this.batchRenderer,i),this.groups.push(i)}))}Start(){!this.processFlag&&this.target&&(this.groups[this.refreshIndex].traverse((t=>{t instanceof _v&&t.system.restart()})),this.groups[this.refreshIndex].position.copy(this.target),this.processFlag=!0)}Update(t){this.processFlag&&(this.groups.forEach((e=>e.traverse((e=>{e.userData&&e.userData.func&&e.userData.func.call(e,t)})))),this.totalTime+=t,this.totalTime>this.refreshTime&&(this.totalTime=0,this.processFlag=!1),this.batchRenderer&&this.batchRenderer.update(t))}}class gb{constructor(t,e){this.scene=e,this.direction=new Le,this.alive=!0,this.maxCount=20,this.trailPositions=new Float32Array(3*this.maxCount),this.pointsGeometry=new vn,this.life=5,this.speed=0,this.points=this.CreatePoints(t),this.points.frustumCulled=!1,this.points.renderOrder=1}Start(t,e){this.direction=t.clone(),this.speed=e,this.alive=!0,this.scene.add(this.points)}Update(t,e){if(this.alive){for(let t=this.trailPositions.length-3;t>0;t-=3)this.trailPositions[t]=this.trailPositions[t-3],this.trailPositions[t+1]=this.trailPositions[t-2],this.trailPositions[t+2]=this.trailPositions[t-1];this.trailPositions[0]=e.x,this.trailPositions[1]=e.y,this.trailPositions[2]=e.z,this.pointsGeometry.attributes.position.needsUpdate=!0,this.life-=t,this.life<=0&&(this.alive=!1,this.scene.remove(this.points))}}GetGeometry(t){const e=[],i=[];for(let e=0;e<this.trailPositions.length;e+=3)this.trailPositions[e]=t.x,this.trailPositions[e+1]=t.y,this.trailPositions[e+2]=t.z;for(let t=0;t<this.maxCount;t++){const n=ne.randInt(Math.random(),.1),s=ne.randInt(.6,1),r=ne.randInt(0,.8),a=1-1/this.maxCount*t;e.push(n,s,r,a),i.push(1)}this.pointsGeometry.setAttribute("position",new an(this.trailPositions,3)),this.pointsGeometry.setAttribute("color",new ln(e,4)),this.pointsGeometry.setAttribute("size",new ln(i,1))}CreatePoints(t){this.GetGeometry(t);const e=document.createElement("CANVAS");e.width=128,e.height=128;const i=e.getContext("2d");if(null==i)throw new Error("fail get context");i.globalAlpha=.3,i.filter="blur(16px)",i.fillStyle="white",i.beginPath(),i.arc(64,64,40,0,2*Math.PI),i.fill(),i.globalAlpha=1,i.filter="blur(5px)",i.fillStyle="white",i.beginPath(),i.arc(64,64,16,0,2*Math.PI),i.fill();const n=new vh(e),s=new ch({color:"white",vertexColors:!0,size:.3,sizeAttenuation:!0,map:n,transparent:!0,blending:2,depthWrite:!1});return new fh(this.pointsGeometry,s)}}class vb{constructor(t){this.processFlag=!1,this.colors=[15559258,16052667]}Start(){this.processFlag=!0}Complet(){this.processFlag=!1}Update(t){this.processFlag}}!function(t){t[t.Lightning=0]="Lightning",t[t.Damage=1]="Damage",t[t.Explosion=2]="Explosion",t[t.BloodExplosion=3]="BloodExplosion",t[t.Trail=4]="Trail",t[t.PointTrail=5]="PointTrail",t[t.Status=6]="Status",t[t.Test=7]="Test"}(pb||(pb={}));class yb{constructor(t){this.game=t,this.effects=[],this.meshs=new Da,this.meshs.name="effector"}Enable(t,...e){switch(t){case pb.Lightning:const t=new nv;this.effects[pb.Lightning]=t,this.meshs.add(t.points);break;case pb.Status:const i=new ev("0","#ff0000");this.effects[pb.Status]=i,this.meshs.add(i);break;case pb.Explosion:const n=new db("assets/vfx/ps.json");n.initEffect(e[0],this.game),this.effects[pb.Explosion]=n;break;case pb.BloodExplosion:const s=new db("assets/vfx/BloodExplosion.json");s.initEffect(e[0],this.game),this.effects[pb.BloodExplosion]=s;break;case pb.PointTrail:const r=new gb(e[0],this.game);this.effects[pb.PointTrail]=r;break;case pb.Trail:const a=new fb;a.initTrailEffect(e[0],this.game),this.effects[pb.Trail]=a;break;case pb.Damage:const o=new iv(e[0],e[1],e[2]);this.effects[pb.Damage]=o,o.Mesh.position.y+=2,this.meshs.add(o.Mesh);break;case pb.Test:const h=new vb(this.game);this.effects[pb.Test]=h}}StartEffector(t,...e){this.effects[t].Start(...e)}Update(t,...e){this.effects.forEach((i=>{i.Update(t,e)}))}}var xb,bb=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};!function(t){t[t.Idle=0]="Idle",t[t.Run=1]="Run",t[t.Jump=2]="Jump",t[t.Punch=3]="Punch",t[t.Sword=4]="Sword",t[t.Gun=5]="Gun",t[t.Bow=6]="Bow",t[t.Wand=7]="Wand",t[t.Fight=8]="Fight",t[t.Dance=9]="Dance",t[t.MagicH1=10]="MagicH1",t[t.MagicH2=11]="MagicH2",t[t.Dying=12]="Dying",t[t.Clim=13]="Clim",t[t.Swim=14]="Swim",t[t.Downfall=15]="Downfall",t[t.PickFruit=16]="PickFruit",t[t.PickFruitTree=17]="PickFruitTree",t[t.PlantAPlant=18]="PlantAPlant",t[t.Hammering=19]="Hammering",t[t.Watering=20]="Watering",t[t.Building=21]="Building"}(xb||(xb={}));class _b extends $u{get BoxPos(){return this.asset.GetBoxPos(this.meshs)}set Model(t){this.playerModel=t}get Model(){return this.playerModel}get ActionType(){return this.currentActionType}constructor(t,e,i,n,s){super(t.MaleAsset),this.loader=t,this.eventCtrl=e,this.portal=i,this.store=n,this.game=s,this.currentActionType=xb.Idle,this.playerModel=Cu.Male,this.bindMesh=[],this.txtStatus=new ev("0","#ff0000"),this.clipMap=new Map,this.effector=new yb(this.game),this.clock=new qc,this.meshs=new Da,this.store.RegisterPlayer(this,this),this.eventCtrl.RegisterAppModeEvent(((t,e)=>{if(t!=DP.Play&&t!=DP.EditPlay&&t!=DP.Weapon)this.Visible=!1;else switch(e){case Lu.Start:this.eventCtrl.OnChangeCtrlObjEvent(this),this.Init(t),this.Visible=!0;break;case Lu.End:this.Uninit(),this.Visible=!1}})),this.eventCtrl.RegisterChangeEquipmentEvent((t=>{this.ReloadBindingItem(t,Tu.Head),this.ReloadBindingItem(t,Tu.Hands_L),this.ReloadBindingItem(t,Tu.Hands_R)}))}GetItemPosition(t){const e=this.asset.GetBodyMeshId(Tu.Hands_R);if(null==e)return;const i=this.meshs.getObjectByName(e);i&&i.getWorldPosition(t)}ReloadBindingItem(t,e){const i=this.asset.GetBodyMeshId(e);if(null==i)return;const n=this.meshs.getObjectByName(i);if(!n)return;const s=this.bindMesh[e];s&&(s.visible=!1,this.bindMesh.splice(this.bindMesh.indexOf(s),1));const r=t.GetBindItem(e);if(r&&null!=r.Mesh){const t=n.getObjectById(r.Mesh.id);t?t.visible=!0:n.add(r.Mesh),this.bindMesh[e]=r.Mesh}}Uninit(){this.store.Owner=this.CannonPos}Init(t){var e;let i=(new Le).copy(this.portal.CannonPos);i.x-=4,i.z+=4,t==DP.EditPlay?i=null!==(e=this.store.Owner)&&void 0!==e?e:i:t==DP.Weapon&&(i=this.meshs.position),i.y=this.meshs.position.y,this.meshs.position.copy(i)}Viliageload(){return bb(this,void 0,void 0,(function*(){yield this.Reload()}))}Reload(){return bb(this,void 0,void 0,(function*(){const t=this.store.PlayerModel;if(this.playerModel==t)return;const e=Du.StartPosition;this.game.remove(this.Meshs),yield this.Loader(this.loader.GetAssets(t),e,"player"),this.game.add(this.Meshs)}))}Loader(t,e,i){return bb(this,void 0,void 0,(function*(){this.playerModel=t.Id,this.asset=t;const[n,s]=yield t.UniqModel(i);this.meshs=n,this.meshs.position.copy(e),this.mixer=this.asset.GetMixer(i),this.clipMap.set(xb.Idle,this.asset.GetAnimationClip(Au.Idle)),this.clipMap.set(xb.Run,this.asset.GetAnimationClip(Au.Run)),this.clipMap.set(xb.Jump,this.asset.GetAnimationClip(Au.Jump)),this.clipMap.set(xb.Punch,this.asset.GetAnimationClip(Au.Punch)),this.clipMap.set(xb.Sword,this.asset.GetAnimationClip(Au.Sword)),this.clipMap.set(xb.Gun,this.asset.GetAnimationClip(Au.Shooting)),this.clipMap.set(xb.Fight,this.asset.GetAnimationClip(Au.FightIdle)),this.clipMap.set(xb.Dance,this.asset.GetAnimationClip(Au.Dance0)),this.clipMap.set(xb.MagicH1,this.asset.GetAnimationClip(Au.MagicH1)),this.clipMap.set(xb.MagicH2,this.asset.GetAnimationClip(Au.MagicH2)),this.clipMap.set(xb.Dying,this.asset.GetAnimationClip(Au.Dying)),this.clipMap.set(xb.PickFruit,this.asset.GetAnimationClip(Au.PickFruit)),this.clipMap.set(xb.PickFruitTree,this.asset.GetAnimationClip(Au.PickFruitTree)),this.clipMap.set(xb.PlantAPlant,this.asset.GetAnimationClip(Au.PlantAPlant)),this.clipMap.set(xb.Watering,this.asset.GetAnimationClip(Au.Wartering)),this.clipMap.set(xb.Hammering,this.asset.GetAnimationClip(Au.Hammering)),this.clipMap.set(xb.Building,this.asset.GetAnimationClip(Au.Hammering)),this.changeAnimate(this.clipMap.get(this.currentActionType)),this.effector.Enable(pb.BloodExplosion,this.CenterPos),this.meshs.add(this.txtStatus),this.txtStatus.visible=!1,this.Visible=!1}))}changeAnimate(t,e){var i,n;if(null==t||this.currentClip==t)return;let s=.2;null===(i=this.currentAni)||void 0===i||i.fadeOut(.2);const r=null===(n=this.mixer)||void 0===n?void 0:n.clipAction(t);null!=r&&(t==this.clipMap.get(xb.Jump)||t==this.clipMap.get(xb.Dying)?(s=0,r.clampWhenFinished=!0,r.setLoop(yt,1)):r.setLoop(xt,1e4),null!=e&&(r.timeScale=t.duration/e),r.reset().fadeIn(s).play(),this.currentAni=r,this.currentClip=t)}ChangeAction(t,e){this.currentActionType=t,this.changeAnimate(this.clipMap.get(t),e)}DamageEffect(t){this.effector.StartEffector(pb.BloodExplosion),this.txtStatus.Start(t.toString(),"#fff")}HealEffect(t){this.txtStatus.Start("+"+t,"#00ff00")}Update(){var t;const e=this.clock.getDelta();this.effector.Update(e),this.txtStatus.Update(e),null===(t=this.mixer)||void 0===t||t.update(e)}}function wb(t,e){if(0===e)return t;if(2===e||1===e){let i=t.getIndex();if(null===i){const e=[],n=t.getAttribute("position");if(void 0===n)return t;for(let t=0;t<n.count;t++)e.push(t);t.setIndex(e),i=t.getIndex()}const n=i.count-2,s=[];if(2===e)for(let t=1;t<=n;t++)s.push(i.getX(0)),s.push(i.getX(t)),s.push(i.getX(t+1));else for(let t=0;t<n;t++)t%2==0?(s.push(i.getX(t)),s.push(i.getX(t+1)),s.push(i.getX(t+2))):(s.push(i.getX(t+2)),s.push(i.getX(t+1)),s.push(i.getX(t)));s.length;const r=t.clone();return r.setIndex(s),r.clearGroups(),r}return t}class Mb extends pc{constructor(t){super(t),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register((function(t){return new Ib(t)})),this.register((function(t){return new zb(t)})),this.register((function(t){return new Ub(t)})),this.register((function(t){return new Fb(t)})),this.register((function(t){return new kb(t)})),this.register((function(t){return new Pb(t)})),this.register((function(t){return new Db(t)})),this.register((function(t){return new Lb(t)})),this.register((function(t){return new Cb(t)})),this.register((function(t){return new Ob(t)})),this.register((function(t){return new Rb(t)})),this.register((function(t){return new Bb(t)})),this.register((function(t){return new Nb(t)})),this.register((function(t){return new Tb(t)})),this.register((function(t){return new Gb(t)})),this.register((function(t){return new Vb(t)}))}load(t,e,i,n){const s=this;let r;if(""!==this.resourcePath)r=this.resourcePath;else if(""!==this.path){const e=Uc.extractUrlBase(t);r=Uc.resolveURL(e,this.path)}else r=Uc.extractUrlBase(t);this.manager.itemStart(t);const a=function(e){n&&n(e),s.manager.itemError(t),s.manager.itemEnd(t)},o=new gc(this.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(t,(function(i){try{s.parse(i,r,(function(i){e(i),s.manager.itemEnd(t)}),a)}catch(t){a(t)}}),i,a)}setDRACOLoader(t){return this.dracoLoader=t,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(t){return this.ktx2Loader=t,this}setMeshoptDecoder(t){return this.meshoptDecoder=t,this}register(t){return-1===this.pluginCallbacks.indexOf(t)&&this.pluginCallbacks.push(t),this}unregister(t){return-1!==this.pluginCallbacks.indexOf(t)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(t),1),this}parse(t,e,i,n){let s;const r={},a={},o=new TextDecoder;if("string"==typeof t)s=JSON.parse(t);else if(t instanceof ArrayBuffer){if(o.decode(new Uint8Array(t,0,4))===Hb){try{r[Eb.KHR_BINARY_GLTF]=new Xb(t)}catch(t){return void(n&&n(t))}s=JSON.parse(r[Eb.KHR_BINARY_GLTF].content)}else s=JSON.parse(o.decode(t))}else s=t;if(void 0===s.asset||s.asset.version[0]<2)return void(n&&n(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const h=new v_(s,{path:e||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});h.fileLoader.setRequestHeader(this.requestHeader);for(let t=0;t<this.pluginCallbacks.length;t++){const e=this.pluginCallbacks[t](h);e.name,a[e.name]=e,r[e.name]=!0}if(s.extensionsUsed)for(let t=0;t<s.extensionsUsed.length;++t){const e=s.extensionsUsed[t],i=s.extensionsRequired||[];switch(e){case Eb.KHR_MATERIALS_UNLIT:r[e]=new Ab;break;case Eb.KHR_DRACO_MESH_COMPRESSION:r[e]=new qb(s,this.dracoLoader);break;case Eb.KHR_TEXTURE_TRANSFORM:r[e]=new Yb;break;case Eb.KHR_MESH_QUANTIZATION:r[e]=new Jb;break;default:i.indexOf(e)>=0&&a[e]}}h.setExtensions(r),h.setPlugins(a),h.parse(i,n)}parseAsync(t,e){const i=this;return new Promise((function(n,s){i.parse(t,e,n,s)}))}}function Sb(){let t={};return{get:function(e){return t[e]},add:function(e,i){t[e]=i},remove:function(e){delete t[e]},removeAll:function(){t={}}}}const Eb={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class Tb{constructor(t){this.parser=t,this.name=Eb.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const t=this.parser,e=this.parser.json.nodes||[];for(let i=0,n=e.length;i<n;i++){const n=e[i];n.extensions&&n.extensions[this.name]&&void 0!==n.extensions[this.name].light&&t._addNodeRef(this.cache,n.extensions[this.name].light)}}_loadLight(t){const e=this.parser,i="light:"+t;let n=e.cache.get(i);if(n)return n;const s=e.json,r=((s.extensions&&s.extensions[this.name]||{}).lights||[])[t];let a;const o=new Zi(16777215);void 0!==r.color&&o.setRGB(r.color[0],r.color[1],r.color[2],Rt);const h=void 0!==r.range?r.range:0;switch(r.type){case"directional":a=new Dc(o),a.target.position.set(0,0,-1),a.add(a.target);break;case"point":a=new kc(o),a.distance=h;break;case"spot":a=new Tc(o),a.distance=h,r.spot=r.spot||{},r.spot.innerConeAngle=void 0!==r.spot.innerConeAngle?r.spot.innerConeAngle:0,r.spot.outerConeAngle=void 0!==r.spot.outerConeAngle?r.spot.outerConeAngle:Math.PI/4,a.angle=r.spot.outerConeAngle,a.penumbra=1-r.spot.innerConeAngle/r.spot.outerConeAngle,a.target.position.set(0,0,-1),a.add(a.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+r.type)}return a.position.set(0,0,0),a.decay=2,u_(a,r),void 0!==r.intensity&&(a.intensity=r.intensity),a.name=e.createUniqueName(r.name||"light_"+t),n=Promise.resolve(a),e.cache.add(i,n),n}getDependency(t,e){if("light"===t)return this._loadLight(e)}createNodeAttachment(t){const e=this,i=this.parser,n=i.json.nodes[t],s=(n.extensions&&n.extensions[this.name]||{}).light;return void 0===s?null:this._loadLight(s).then((function(t){return i._getNodeRef(e.cache,s,t)}))}}class Ab{constructor(){this.name=Eb.KHR_MATERIALS_UNLIT}getMaterialType(){return nn}extendParams(t,e,i){const n=[];t.color=new Zi(1,1,1),t.opacity=1;const s=e.pbrMetallicRoughness;if(s){if(Array.isArray(s.baseColorFactor)){const e=s.baseColorFactor;t.color.setRGB(e[0],e[1],e[2],Rt),t.opacity=e[3]}void 0!==s.baseColorTexture&&n.push(i.assignTexture(t,"map",s.baseColorTexture,It))}return Promise.all(n)}}class Cb{constructor(t){this.parser=t,this.name=Eb.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(t,e){const i=this.parser.json.materials[t];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=i.extensions[this.name].emissiveStrength;return void 0!==n&&(e.emissiveIntensity=n),Promise.resolve()}}class Ib{constructor(t){this.parser=t,this.name=Eb.KHR_MATERIALS_CLEARCOAT}getMaterialType(t){const e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?zl:null}extendMaterialParams(t,e){const i=this.parser,n=i.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],r=n.extensions[this.name];if(void 0!==r.clearcoatFactor&&(e.clearcoat=r.clearcoatFactor),void 0!==r.clearcoatTexture&&s.push(i.assignTexture(e,"clearcoatMap",r.clearcoatTexture)),void 0!==r.clearcoatRoughnessFactor&&(e.clearcoatRoughness=r.clearcoatRoughnessFactor),void 0!==r.clearcoatRoughnessTexture&&s.push(i.assignTexture(e,"clearcoatRoughnessMap",r.clearcoatRoughnessTexture)),void 0!==r.clearcoatNormalTexture&&(s.push(i.assignTexture(e,"clearcoatNormalMap",r.clearcoatNormalTexture)),void 0!==r.clearcoatNormalTexture.scale)){const t=r.clearcoatNormalTexture.scale;e.clearcoatNormalScale=new se(t,t)}return Promise.all(s)}}class Rb{constructor(t){this.parser=t,this.name=Eb.KHR_MATERIALS_IRIDESCENCE}getMaterialType(t){const e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?zl:null}extendMaterialParams(t,e){const i=this.parser,n=i.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],r=n.extensions[this.name];return void 0!==r.iridescenceFactor&&(e.iridescence=r.iridescenceFactor),void 0!==r.iridescenceTexture&&s.push(i.assignTexture(e,"iridescenceMap",r.iridescenceTexture)),void 0!==r.iridescenceIor&&(e.iridescenceIOR=r.iridescenceIor),void 0===e.iridescenceThicknessRange&&(e.iridescenceThicknessRange=[100,400]),void 0!==r.iridescenceThicknessMinimum&&(e.iridescenceThicknessRange[0]=r.iridescenceThicknessMinimum),void 0!==r.iridescenceThicknessMaximum&&(e.iridescenceThicknessRange[1]=r.iridescenceThicknessMaximum),void 0!==r.iridescenceThicknessTexture&&s.push(i.assignTexture(e,"iridescenceThicknessMap",r.iridescenceThicknessTexture)),Promise.all(s)}}class kb{constructor(t){this.parser=t,this.name=Eb.KHR_MATERIALS_SHEEN}getMaterialType(t){const e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?zl:null}extendMaterialParams(t,e){const i=this.parser,n=i.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[];e.sheenColor=new Zi(0,0,0),e.sheenRoughness=0,e.sheen=1;const r=n.extensions[this.name];if(void 0!==r.sheenColorFactor){const t=r.sheenColorFactor;e.sheenColor.setRGB(t[0],t[1],t[2],Rt)}return void 0!==r.sheenRoughnessFactor&&(e.sheenRoughness=r.sheenRoughnessFactor),void 0!==r.sheenColorTexture&&s.push(i.assignTexture(e,"sheenColorMap",r.sheenColorTexture,It)),void 0!==r.sheenRoughnessTexture&&s.push(i.assignTexture(e,"sheenRoughnessMap",r.sheenRoughnessTexture)),Promise.all(s)}}class Pb{constructor(t){this.parser=t,this.name=Eb.KHR_MATERIALS_TRANSMISSION}getMaterialType(t){const e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?zl:null}extendMaterialParams(t,e){const i=this.parser,n=i.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],r=n.extensions[this.name];return void 0!==r.transmissionFactor&&(e.transmission=r.transmissionFactor),void 0!==r.transmissionTexture&&s.push(i.assignTexture(e,"transmissionMap",r.transmissionTexture)),Promise.all(s)}}class Db{constructor(t){this.parser=t,this.name=Eb.KHR_MATERIALS_VOLUME}getMaterialType(t){const e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?zl:null}extendMaterialParams(t,e){const i=this.parser,n=i.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],r=n.extensions[this.name];e.thickness=void 0!==r.thicknessFactor?r.thicknessFactor:0,void 0!==r.thicknessTexture&&s.push(i.assignTexture(e,"thicknessMap",r.thicknessTexture)),e.attenuationDistance=r.attenuationDistance||1/0;const a=r.attenuationColor||[1,1,1];return e.attenuationColor=(new Zi).setRGB(a[0],a[1],a[2],Rt),Promise.all(s)}}class Lb{constructor(t){this.parser=t,this.name=Eb.KHR_MATERIALS_IOR}getMaterialType(t){const e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?zl:null}extendMaterialParams(t,e){const i=this.parser.json.materials[t];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=i.extensions[this.name];return e.ior=void 0!==n.ior?n.ior:1.5,Promise.resolve()}}class Ob{constructor(t){this.parser=t,this.name=Eb.KHR_MATERIALS_SPECULAR}getMaterialType(t){const e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?zl:null}extendMaterialParams(t,e){const i=this.parser,n=i.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],r=n.extensions[this.name];e.specularIntensity=void 0!==r.specularFactor?r.specularFactor:1,void 0!==r.specularTexture&&s.push(i.assignTexture(e,"specularIntensityMap",r.specularTexture));const a=r.specularColorFactor||[1,1,1];return e.specularColor=(new Zi).setRGB(a[0],a[1],a[2],Rt),void 0!==r.specularColorTexture&&s.push(i.assignTexture(e,"specularColorMap",r.specularColorTexture,It)),Promise.all(s)}}class Nb{constructor(t){this.parser=t,this.name=Eb.EXT_MATERIALS_BUMP}getMaterialType(t){const e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?zl:null}extendMaterialParams(t,e){const i=this.parser,n=i.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],r=n.extensions[this.name];return e.bumpScale=void 0!==r.bumpFactor?r.bumpFactor:1,void 0!==r.bumpTexture&&s.push(i.assignTexture(e,"bumpMap",r.bumpTexture)),Promise.all(s)}}class Bb{constructor(t){this.parser=t,this.name=Eb.KHR_MATERIALS_ANISOTROPY}getMaterialType(t){const e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?zl:null}extendMaterialParams(t,e){const i=this.parser,n=i.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],r=n.extensions[this.name];return void 0!==r.anisotropyStrength&&(e.anisotropy=r.anisotropyStrength),void 0!==r.anisotropyRotation&&(e.anisotropyRotation=r.anisotropyRotation),void 0!==r.anisotropyTexture&&s.push(i.assignTexture(e,"anisotropyMap",r.anisotropyTexture)),Promise.all(s)}}class zb{constructor(t){this.parser=t,this.name=Eb.KHR_TEXTURE_BASISU}loadTexture(t){const e=this.parser,i=e.json,n=i.textures[t];if(!n.extensions||!n.extensions[this.name])return null;const s=n.extensions[this.name],r=e.options.ktx2Loader;if(!r){if(i.extensionsRequired&&i.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return e.loadTextureImage(t,s.source,r)}}class Ub{constructor(t){this.parser=t,this.name=Eb.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(t){const e=this.name,i=this.parser,n=i.json,s=n.textures[t];if(!s.extensions||!s.extensions[e])return null;const r=s.extensions[e],a=n.images[r.source];let o=i.textureLoader;if(a.uri){const t=i.options.manager.getHandler(a.uri);null!==t&&(o=t)}return this.detectSupport().then((function(s){if(s)return i.loadTextureImage(t,r.source,o);if(n.extensionsRequired&&n.extensionsRequired.indexOf(e)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return i.loadTexture(t)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(t){const e=new Image;e.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",e.onload=e.onerror=function(){t(1===e.height)}}))),this.isSupported}}class Fb{constructor(t){this.parser=t,this.name=Eb.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(t){const e=this.name,i=this.parser,n=i.json,s=n.textures[t];if(!s.extensions||!s.extensions[e])return null;const r=s.extensions[e],a=n.images[r.source];let o=i.textureLoader;if(a.uri){const t=i.options.manager.getHandler(a.uri);null!==t&&(o=t)}return this.detectSupport().then((function(s){if(s)return i.loadTextureImage(t,r.source,o);if(n.extensionsRequired&&n.extensionsRequired.indexOf(e)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return i.loadTexture(t)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(t){const e=new Image;e.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",e.onload=e.onerror=function(){t(1===e.height)}}))),this.isSupported}}class Gb{constructor(t){this.name=Eb.EXT_MESHOPT_COMPRESSION,this.parser=t}loadBufferView(t){const e=this.parser.json,i=e.bufferViews[t];if(i.extensions&&i.extensions[this.name]){const t=i.extensions[this.name],n=this.parser.getDependency("buffer",t.buffer),s=this.parser.options.meshoptDecoder;if(!s||!s.supported){if(e.extensionsRequired&&e.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return n.then((function(e){const i=t.byteOffset||0,n=t.byteLength||0,r=t.count,a=t.byteStride,o=new Uint8Array(e,i,n);return s.decodeGltfBufferAsync?s.decodeGltfBufferAsync(r,a,o,t.mode,t.filter).then((function(t){return t.buffer})):s.ready.then((function(){const e=new ArrayBuffer(r*a);return s.decodeGltfBuffer(new Uint8Array(e),r,a,o,t.mode,t.filter),e}))}))}return null}}class Vb{constructor(t){this.name=Eb.EXT_MESH_GPU_INSTANCING,this.parser=t}createNodeMesh(t){const e=this.parser.json,i=e.nodes[t];if(!i.extensions||!i.extensions[this.name]||void 0===i.mesh)return null;const n=e.meshes[i.mesh];for(const t of n.primitives)if(t.mode!==Qb.TRIANGLES&&t.mode!==Qb.TRIANGLE_STRIP&&t.mode!==Qb.TRIANGLE_FAN&&void 0!==t.mode)return null;const s=i.extensions[this.name].attributes,r=[],a={};for(const t in s)r.push(this.parser.getDependency("accessor",s[t]).then((e=>(a[t]=e,a[t]))));return r.length<1?null:(r.push(this.parser.createNodeMesh(t)),Promise.all(r).then((t=>{const e=t.pop(),i=e.isGroup?e.children:[e],n=t[0].count,s=[];for(const t of i){const e=new ci,i=new Le,r=new De,o=new Le(1,1,1),h=new Oo(t.geometry,t.material,n);for(let t=0;t<n;t++)a.TRANSLATION&&i.fromBufferAttribute(a.TRANSLATION,t),a.ROTATION&&r.fromBufferAttribute(a.ROTATION,t),a.SCALE&&o.fromBufferAttribute(a.SCALE,t),h.setMatrixAt(t,e.compose(i,r,o));for(const e in a)if("_COLOR_0"===e){const t=a[e];h.instanceColor=new Ao(t.array,t.itemSize,t.normalized)}else"TRANSLATION"!==e&&"ROTATION"!==e&&"SCALE"!==e&&t.geometry.setAttribute(e,a[e]);Oi.prototype.copy.call(h,t),this.parser.assignFinalMaterial(h),s.push(h)}return e.isGroup?(e.clear(),e.add(...s),e):s[0]})))}}const Hb="glTF",jb=1313821514,Wb=5130562;class Xb{constructor(t){this.name=Eb.KHR_BINARY_GLTF,this.content=null,this.body=null;const e=new DataView(t,0,12),i=new TextDecoder;if(this.header={magic:i.decode(new Uint8Array(t.slice(0,4))),version:e.getUint32(4,!0),length:e.getUint32(8,!0)},this.header.magic!==Hb)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const n=this.header.length-12,s=new DataView(t,12);let r=0;for(;r<n;){const e=s.getUint32(r,!0);r+=4;const n=s.getUint32(r,!0);if(r+=4,n===jb){const n=new Uint8Array(t,12+r,e);this.content=i.decode(n)}else if(n===Wb){const i=12+r;this.body=t.slice(i,i+e)}r+=e}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class qb{constructor(t,e){if(!e)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=Eb.KHR_DRACO_MESH_COMPRESSION,this.json=t,this.dracoLoader=e,this.dracoLoader.preload()}decodePrimitive(t,e){const i=this.json,n=this.dracoLoader,s=t.extensions[this.name].bufferView,r=t.extensions[this.name].attributes,a={},o={},h={};for(const t in r){const e=s_[t]||t.toLowerCase();a[e]=r[t]}for(const e in t.attributes){const n=s_[e]||e.toLowerCase();if(void 0!==r[e]){const s=i.accessors[t.attributes[e]],r=t_[s.componentType];h[n]=r.name,o[n]=!0===s.normalized}}return e.getDependency("bufferView",s).then((function(t){return new Promise((function(e,i){n.decodeDracoFile(t,(function(t){for(const e in t.attributes){const i=t.attributes[e],n=o[e];void 0!==n&&(i.normalized=n)}e(t)}),a,h,Rt,i)}))}))}}class Yb{constructor(){this.name=Eb.KHR_TEXTURE_TRANSFORM}extendTexture(t,e){return void 0!==e.texCoord&&e.texCoord!==t.channel||void 0!==e.offset||void 0!==e.rotation||void 0!==e.scale?(t=t.clone(),void 0!==e.texCoord&&(t.channel=e.texCoord),void 0!==e.offset&&t.offset.fromArray(e.offset),void 0!==e.rotation&&(t.rotation=e.rotation),void 0!==e.scale&&t.repeat.fromArray(e.scale),t.needsUpdate=!0,t):t}}class Jb{constructor(){this.name=Eb.KHR_MESH_QUANTIZATION}}class $b extends $l{constructor(t,e,i,n){super(t,e,i,n)}copySampleValue_(t){const e=this.resultBuffer,i=this.sampleValues,n=this.valueSize,s=t*n*3+n;for(let t=0;t!==n;t++)e[t]=i[s+t];return e}interpolate_(t,e,i,n){const s=this.resultBuffer,r=this.sampleValues,a=this.valueSize,o=2*a,h=3*a,l=n-e,c=(i-e)/l,u=c*c,d=u*c,p=t*h,m=p-h,f=-2*d+3*u,g=d-u,v=1-f,y=g-u+c;for(let t=0;t!==a;t++){const e=r[m+t+a],i=r[m+t+o]*l,n=r[p+t+a],h=r[p+t]*l;s[t]=v*e+y*i+f*n+g*h}return s}}const Kb=new De;class Zb extends $b{interpolate_(t,e,i,n){const s=super.interpolate_(t,e,i,n);return Kb.fromArray(s).normalize().toArray(s),s}}const Qb={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},t_={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},e_={9728:K,9729:tt,9984:Z,9985:et,9986:Q,9987:it},i_={33071:J,33648:$,10497:Y},n_={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},s_={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},r_={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},a_={CUBICSPLINE:void 0,LINEAR:_t,STEP:bt},o_="OPAQUE",h_="MASK",l_="BLEND";function c_(t,e,i){for(const n in i.extensions)void 0===t[n]&&(e.userData.gltfExtensions=e.userData.gltfExtensions||{},e.userData.gltfExtensions[n]=i.extensions[n])}function u_(t,e){void 0!==e.extras&&"object"==typeof e.extras&&Object.assign(t.userData,e.extras)}function d_(t,e){if(t.updateMorphTargets(),void 0!==e.weights)for(let i=0,n=e.weights.length;i<n;i++)t.morphTargetInfluences[i]=e.weights[i];if(e.extras&&Array.isArray(e.extras.targetNames)){const i=e.extras.targetNames;if(t.morphTargetInfluences.length===i.length){t.morphTargetDictionary={};for(let e=0,n=i.length;e<n;e++)t.morphTargetDictionary[i[e]]=e}}}function p_(t){let e;const i=t.extensions&&t.extensions[Eb.KHR_DRACO_MESH_COMPRESSION];if(e=i?"draco:"+i.bufferView+":"+i.indices+":"+m_(i.attributes):t.indices+":"+m_(t.attributes)+":"+t.mode,void 0!==t.targets)for(let i=0,n=t.targets.length;i<n;i++)e+=":"+m_(t.targets[i]);return e}function m_(t){let e="";const i=Object.keys(t).sort();for(let n=0,s=i.length;n<s;n++)e+=i[n]+":"+t[i[n]]+";";return e}function f_(t){switch(t){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}const g_=new ci;class v_{constructor(t={},e={}){this.json=t,this.extensions={},this.plugins={},this.options=e,this.cache=new Sb,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let i=!1,n=!1,s=-1;"undefined"!=typeof navigator&&(i=!0===/^((?!chrome|android).)*safari/i.test(navigator.userAgent),n=navigator.userAgent.indexOf("Firefox")>-1,s=n?navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]:-1),"undefined"==typeof createImageBitmap||i||n&&s<98?this.textureLoader=new yc(this.options.manager):this.textureLoader=new Xc(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new gc(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(t){this.extensions=t}setPlugins(t){this.plugins=t}parse(t,e){const i=this,n=this.json,s=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll((function(t){return t._markDefs&&t._markDefs()})),Promise.all(this._invokeAll((function(t){return t.beforeRoot&&t.beforeRoot()}))).then((function(){return Promise.all([i.getDependencies("scene"),i.getDependencies("animation"),i.getDependencies("camera")])})).then((function(e){const r={scene:e[0][n.scene||0],scenes:e[0],animations:e[1],cameras:e[2],asset:n.asset,parser:i,userData:{}};return c_(s,r,n),u_(r,n),Promise.all(i._invokeAll((function(t){return t.afterRoot&&t.afterRoot(r)}))).then((function(){t(r)}))})).catch(e)}_markDefs(){const t=this.json.nodes||[],e=this.json.skins||[],i=this.json.meshes||[];for(let i=0,n=e.length;i<n;i++){const n=e[i].joints;for(let e=0,i=n.length;e<i;e++)t[n[e]].isBone=!0}for(let e=0,n=t.length;e<n;e++){const n=t[e];void 0!==n.mesh&&(this._addNodeRef(this.meshCache,n.mesh),void 0!==n.skin&&(i[n.mesh].isSkinnedMesh=!0)),void 0!==n.camera&&this._addNodeRef(this.cameraCache,n.camera)}}_addNodeRef(t,e){void 0!==e&&(void 0===t.refs[e]&&(t.refs[e]=t.uses[e]=0),t.refs[e]++)}_getNodeRef(t,e,i){if(t.refs[e]<=1)return i;const n=i.clone(),s=(t,e)=>{const i=this.associations.get(t);null!=i&&this.associations.set(e,i);for(const[i,n]of t.children.entries())s(n,e.children[i])};return s(i,n),n.name+="_instance_"+t.uses[e]++,n}_invokeOne(t){const e=Object.values(this.plugins);e.push(this);for(let i=0;i<e.length;i++){const n=t(e[i]);if(n)return n}return null}_invokeAll(t){const e=Object.values(this.plugins);e.unshift(this);const i=[];for(let n=0;n<e.length;n++){const s=t(e[n]);s&&i.push(s)}return i}getDependency(t,e){const i=t+":"+e;let n=this.cache.get(i);if(!n){switch(t){case"scene":n=this.loadScene(e);break;case"node":n=this._invokeOne((function(t){return t.loadNode&&t.loadNode(e)}));break;case"mesh":n=this._invokeOne((function(t){return t.loadMesh&&t.loadMesh(e)}));break;case"accessor":n=this.loadAccessor(e);break;case"bufferView":n=this._invokeOne((function(t){return t.loadBufferView&&t.loadBufferView(e)}));break;case"buffer":n=this.loadBuffer(e);break;case"material":n=this._invokeOne((function(t){return t.loadMaterial&&t.loadMaterial(e)}));break;case"texture":n=this._invokeOne((function(t){return t.loadTexture&&t.loadTexture(e)}));break;case"skin":n=this.loadSkin(e);break;case"animation":n=this._invokeOne((function(t){return t.loadAnimation&&t.loadAnimation(e)}));break;case"camera":n=this.loadCamera(e);break;default:if(n=this._invokeOne((function(i){return i!=this&&i.getDependency&&i.getDependency(t,e)})),!n)throw new Error("Unknown type: "+t)}this.cache.add(i,n)}return n}getDependencies(t){let e=this.cache.get(t);if(!e){const i=this,n=this.json[t+("mesh"===t?"es":"s")]||[];e=Promise.all(n.map((function(e,n){return i.getDependency(t,n)}))),this.cache.add(t,e)}return e}loadBuffer(t){const e=this.json.buffers[t],i=this.fileLoader;if(e.type&&"arraybuffer"!==e.type)throw new Error("THREE.GLTFLoader: "+e.type+" buffer type is not supported.");if(void 0===e.uri&&0===t)return Promise.resolve(this.extensions[Eb.KHR_BINARY_GLTF].body);const n=this.options;return new Promise((function(t,s){i.load(Uc.resolveURL(e.uri,n.path),t,void 0,(function(){s(new Error('THREE.GLTFLoader: Failed to load buffer "'+e.uri+'".'))}))}))}loadBufferView(t){const e=this.json.bufferViews[t];return this.getDependency("buffer",e.buffer).then((function(t){const i=e.byteLength||0,n=e.byteOffset||0;return t.slice(n,n+i)}))}loadAccessor(t){const e=this,i=this.json,n=this.json.accessors[t];if(void 0===n.bufferView&&void 0===n.sparse){const t=n_[n.type],e=t_[n.componentType],i=!0===n.normalized,s=new e(n.count*t);return Promise.resolve(new an(s,t,i))}const s=[];return void 0!==n.bufferView?s.push(this.getDependency("bufferView",n.bufferView)):s.push(null),void 0!==n.sparse&&(s.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),s.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(s).then((function(t){const s=t[0],r=n_[n.type],a=t_[n.componentType],o=a.BYTES_PER_ELEMENT,h=o*r,l=n.byteOffset||0,c=void 0!==n.bufferView?i.bufferViews[n.bufferView].byteStride:void 0,u=!0===n.normalized;let d,p;if(c&&c!==h){const t=Math.floor(l/c),i="InterleavedBuffer:"+n.bufferView+":"+n.componentType+":"+t+":"+n.count;let h=e.cache.get(i);h||(d=new a(s,t*c,n.count*c/o),h=new Ha(d,c/o),e.cache.add(i,h)),p=new Wa(h,r,l%c/o,u)}else d=null===s?new a(n.count*r):new a(s,l,n.count*r),p=new an(d,r,u);if(void 0!==n.sparse){const e=n_.SCALAR,i=t_[n.sparse.indices.componentType],o=n.sparse.indices.byteOffset||0,h=n.sparse.values.byteOffset||0,l=new i(t[1],o,n.sparse.count*e),c=new a(t[2],h,n.sparse.count*r);null!==s&&(p=new an(p.array.slice(),p.itemSize,p.normalized));for(let t=0,e=l.length;t<e;t++){const e=l[t];if(p.setX(e,c[t*r]),r>=2&&p.setY(e,c[t*r+1]),r>=3&&p.setZ(e,c[t*r+2]),r>=4&&p.setW(e,c[t*r+3]),r>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return p}))}loadTexture(t){const e=this.json,i=this.options,n=e.textures[t].source,s=e.images[n];let r=this.textureLoader;if(s.uri){const t=i.manager.getHandler(s.uri);null!==t&&(r=t)}return this.loadTextureImage(t,n,r)}loadTextureImage(t,e,i){const n=this,s=this.json,r=s.textures[t],a=s.images[e],o=(a.uri||a.bufferView)+":"+r.sampler;if(this.textureCache[o])return this.textureCache[o];const h=this.loadImageSource(e,i).then((function(e){e.flipY=!1,e.name=r.name||a.name||"",""===e.name&&"string"==typeof a.uri&&!1===a.uri.startsWith("data:image/")&&(e.name=a.uri);const i=(s.samplers||{})[r.sampler]||{};return e.magFilter=e_[i.magFilter]||tt,e.minFilter=e_[i.minFilter]||it,e.wrapS=i_[i.wrapS]||Y,e.wrapT=i_[i.wrapT]||Y,n.associations.set(e,{textures:t}),e})).catch((function(){return null}));return this.textureCache[o]=h,h}loadImageSource(t,e){const i=this,n=this.json,s=this.options;if(void 0!==this.sourceCache[t])return this.sourceCache[t].then((t=>t.clone()));const r=n.images[t],a=self.URL||self.webkitURL;let o=r.uri||"",h=!1;if(void 0!==r.bufferView)o=i.getDependency("bufferView",r.bufferView).then((function(t){h=!0;const e=new Blob([t],{type:r.mimeType});return o=a.createObjectURL(e),o}));else if(void 0===r.uri)throw new Error("THREE.GLTFLoader: Image "+t+" is missing URI and bufferView");const l=Promise.resolve(o).then((function(t){return new Promise((function(i,n){let r=i;!0===e.isImageBitmapLoader&&(r=function(t){const e=new Ae(t);e.needsUpdate=!0,i(e)}),e.load(Uc.resolveURL(t,s.path),r,void 0,n)}))})).then((function(t){var e;return!0===h&&a.revokeObjectURL(o),t.userData.mimeType=r.mimeType||((e=r.uri).search(/\.jpe?g($|\?)/i)>0||0===e.search(/^data\:image\/jpeg/)?"image/jpeg":e.search(/\.webp($|\?)/i)>0||0===e.search(/^data\:image\/webp/)?"image/webp":"image/png"),t})).catch((function(t){throw t}));return this.sourceCache[t]=l,l}assignTexture(t,e,i,n){const s=this;return this.getDependency("texture",i.index).then((function(r){if(!r)return null;if(void 0!==i.texCoord&&i.texCoord>0&&((r=r.clone()).channel=i.texCoord),s.extensions[Eb.KHR_TEXTURE_TRANSFORM]){const t=void 0!==i.extensions?i.extensions[Eb.KHR_TEXTURE_TRANSFORM]:void 0;if(t){const e=s.associations.get(r);r=s.extensions[Eb.KHR_TEXTURE_TRANSFORM].extendTexture(r,t),s.associations.set(r,e)}}return void 0!==n&&(r.colorSpace=n),t[e]=r,r}))}assignFinalMaterial(t){const e=t.geometry;let i=t.material;const n=void 0===e.attributes.tangent,s=void 0!==e.attributes.color,r=void 0===e.attributes.normal;if(t.isPoints){const t="PointsMaterial:"+i.uuid;let e=this.cache.get(t);e||(e=new ch,en.prototype.copy.call(e,i),e.color.copy(i.color),e.map=i.map,e.sizeAttenuation=!1,this.cache.add(t,e)),i=e}else if(t.isLine){const t="LineBasicMaterial:"+i.uuid;let e=this.cache.get(t);e||(e=new Qo,en.prototype.copy.call(e,i),e.color.copy(i.color),e.map=i.map,this.cache.add(t,e)),i=e}if(n||s||r){let t="ClonedMaterial:"+i.uuid+":";n&&(t+="derivative-tangents:"),s&&(t+="vertex-colors:"),r&&(t+="flat-shading:");let e=this.cache.get(t);e||(e=i.clone(),s&&(e.vertexColors=!0),r&&(e.flatShading=!0),n&&(e.normalScale&&(e.normalScale.y*=-1),e.clearcoatNormalScale&&(e.clearcoatNormalScale.y*=-1)),this.cache.add(t,e),this.associations.set(e,this.associations.get(i))),i=e}t.material=i}getMaterialType(){return Bl}loadMaterial(t){const e=this,i=this.json,n=this.extensions,s=i.materials[t];let r;const a={},o=[];if((s.extensions||{})[Eb.KHR_MATERIALS_UNLIT]){const t=n[Eb.KHR_MATERIALS_UNLIT];r=t.getMaterialType(),o.push(t.extendParams(a,s,e))}else{const i=s.pbrMetallicRoughness||{};if(a.color=new Zi(1,1,1),a.opacity=1,Array.isArray(i.baseColorFactor)){const t=i.baseColorFactor;a.color.setRGB(t[0],t[1],t[2],Rt),a.opacity=t[3]}void 0!==i.baseColorTexture&&o.push(e.assignTexture(a,"map",i.baseColorTexture,It)),a.metalness=void 0!==i.metallicFactor?i.metallicFactor:1,a.roughness=void 0!==i.roughnessFactor?i.roughnessFactor:1,void 0!==i.metallicRoughnessTexture&&(o.push(e.assignTexture(a,"metalnessMap",i.metallicRoughnessTexture)),o.push(e.assignTexture(a,"roughnessMap",i.metallicRoughnessTexture))),r=this._invokeOne((function(e){return e.getMaterialType&&e.getMaterialType(t)})),o.push(Promise.all(this._invokeAll((function(e){return e.extendMaterialParams&&e.extendMaterialParams(t,a)}))))}!0===s.doubleSided&&(a.side=2);const h=s.alphaMode||o_;if(h===l_?(a.transparent=!0,a.depthWrite=!1):(a.transparent=!1,h===h_&&(a.alphaTest=void 0!==s.alphaCutoff?s.alphaCutoff:.5)),void 0!==s.normalTexture&&r!==nn&&(o.push(e.assignTexture(a,"normalMap",s.normalTexture)),a.normalScale=new se(1,1),void 0!==s.normalTexture.scale)){const t=s.normalTexture.scale;a.normalScale.set(t,t)}if(void 0!==s.occlusionTexture&&r!==nn&&(o.push(e.assignTexture(a,"aoMap",s.occlusionTexture)),void 0!==s.occlusionTexture.strength&&(a.aoMapIntensity=s.occlusionTexture.strength)),void 0!==s.emissiveFactor&&r!==nn){const t=s.emissiveFactor;a.emissive=(new Zi).setRGB(t[0],t[1],t[2],Rt)}return void 0!==s.emissiveTexture&&r!==nn&&o.push(e.assignTexture(a,"emissiveMap",s.emissiveTexture,It)),Promise.all(o).then((function(){const i=new r(a);return s.name&&(i.name=s.name),u_(i,s),e.associations.set(i,{materials:t}),s.extensions&&c_(n,i,s),i}))}createUniqueName(t){const e=iu.sanitizeNodeName(t||"");return e in this.nodeNamesUsed?e+"_"+ ++this.nodeNamesUsed[e]:(this.nodeNamesUsed[e]=0,e)}loadGeometries(t){const e=this,i=this.extensions,n=this.primitiveCache;function s(t){return i[Eb.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(t,e).then((function(i){return y_(i,t,e)}))}const r=[];for(let i=0,a=t.length;i<a;i++){const a=t[i],o=p_(a),h=n[o];if(h)r.push(h.promise);else{let t;t=a.extensions&&a.extensions[Eb.KHR_DRACO_MESH_COMPRESSION]?s(a):y_(new vn,a,e),n[o]={primitive:a,promise:t},r.push(t)}}return Promise.all(r)}loadMesh(t){const e=this,i=this.json,n=this.extensions,s=i.meshes[t],r=s.primitives,a=[];for(let t=0,e=r.length;t<e;t++){const e=void 0===r[t].material?(void 0===(o=this.cache).DefaultMaterial&&(o.DefaultMaterial=new Bl({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:I})),o.DefaultMaterial):this.getDependency("material",r[t].material);a.push(e)}var o;return a.push(e.loadGeometries(r)),Promise.all(a).then((function(i){const a=i.slice(0,i.length-1),o=i[i.length-1],h=[];for(let i=0,l=o.length;i<l;i++){const l=o[i],c=r[i];let u;const d=a[i];if(c.mode===Qb.TRIANGLES||c.mode===Qb.TRIANGLE_STRIP||c.mode===Qb.TRIANGLE_FAN||void 0===c.mode)u=!0===s.isSkinnedMesh?new _o(l,d):new On(l,d),!0===u.isSkinnedMesh&&u.normalizeSkinWeights(),c.mode===Qb.TRIANGLE_STRIP?u.geometry=wb(u.geometry,1):c.mode===Qb.TRIANGLE_FAN&&(u.geometry=wb(u.geometry,2));else if(c.mode===Qb.LINES)u=new hh(l,d);else if(c.mode===Qb.LINE_STRIP)u=new rh(l,d);else if(c.mode===Qb.LINE_LOOP)u=new lh(l,d);else{if(c.mode!==Qb.POINTS)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+c.mode);u=new fh(l,d)}Object.keys(u.geometry.morphAttributes).length>0&&d_(u,s),u.name=e.createUniqueName(s.name||"mesh_"+t),u_(u,s),c.extensions&&c_(n,u,c),e.assignFinalMaterial(u),h.push(u)}for(let i=0,n=h.length;i<n;i++)e.associations.set(h[i],{meshes:t,primitives:i});if(1===h.length)return s.extensions&&c_(n,h[0],s),h[0];const l=new Da;s.extensions&&c_(n,l,s),e.associations.set(l,{meshes:t});for(let t=0,e=h.length;t<e;t++)l.add(h[t]);return l}))}loadCamera(t){let e;const i=this.json.cameras[t],n=i[i.type];if(n)return"perspective"===i.type?e=new jn(ne.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):"orthographic"===i.type&&(e=new fs(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),i.name&&(e.name=this.createUniqueName(i.name)),u_(e,i),Promise.resolve(e)}loadSkin(t){const e=this.json.skins[t],i=[];for(let t=0,n=e.joints.length;t<n;t++)i.push(this._loadNodeShallow(e.joints[t]));return void 0!==e.inverseBindMatrices?i.push(this.getDependency("accessor",e.inverseBindMatrices)):i.push(null),Promise.all(i).then((function(t){const e=t.pop(),i=t,n=[],s=[];for(let t=0,r=i.length;t<r;t++){const r=i[t];if(r){n.push(r);const i=new ci;null!==e&&i.fromArray(e.array,16*t),s.push(i)}}return new To(n,s)}))}loadAnimation(t){const e=this.json,i=this,n=e.animations[t],s=n.name?n.name:"animation_"+t,r=[],a=[],o=[],h=[],l=[];for(let t=0,e=n.channels.length;t<e;t++){const e=n.channels[t],i=n.samplers[e.sampler],s=e.target,c=s.node,u=void 0!==n.parameters?n.parameters[i.input]:i.input,d=void 0!==n.parameters?n.parameters[i.output]:i.output;void 0!==s.node&&(r.push(this.getDependency("node",c)),a.push(this.getDependency("accessor",u)),o.push(this.getDependency("accessor",d)),h.push(i),l.push(s))}return Promise.all([Promise.all(r),Promise.all(a),Promise.all(o),Promise.all(h),Promise.all(l)]).then((function(t){const e=t[0],n=t[1],r=t[2],a=t[3],o=t[4],h=[];for(let t=0,s=e.length;t<s;t++){const s=e[t],l=n[t],c=r[t],u=a[t],d=o[t];if(void 0===s)continue;s.updateMatrix&&s.updateMatrix();const p=i._createAnimationTracks(s,l,c,u,d);if(p)for(let t=0;t<p.length;t++)h.push(p[t])}return new hc(s,void 0,h)}))}createNodeMesh(t){const e=this.json,i=this,n=e.nodes[t];return void 0===n.mesh?null:i.getDependency("mesh",n.mesh).then((function(t){const e=i._getNodeRef(i.meshCache,n.mesh,t);return void 0!==n.weights&&e.traverse((function(t){if(t.isMesh)for(let e=0,i=n.weights.length;e<i;e++)t.morphTargetInfluences[e]=n.weights[e]})),e}))}loadNode(t){const e=this,i=this.json.nodes[t],n=e._loadNodeShallow(t),s=[],r=i.children||[];for(let t=0,i=r.length;t<i;t++)s.push(e.getDependency("node",r[t]));const a=void 0===i.skin?Promise.resolve(null):e.getDependency("skin",i.skin);return Promise.all([n,Promise.all(s),a]).then((function(t){const e=t[0],i=t[1],n=t[2];null!==n&&e.traverse((function(t){t.isSkinnedMesh&&t.bind(n,g_)}));for(let t=0,n=i.length;t<n;t++)e.add(i[t]);return e}))}_loadNodeShallow(t){const e=this.json,i=this.extensions,n=this;if(void 0!==this.nodeCache[t])return this.nodeCache[t];const s=e.nodes[t],r=s.name?n.createUniqueName(s.name):"",a=[],o=n._invokeOne((function(e){return e.createNodeMesh&&e.createNodeMesh(t)}));return o&&a.push(o),void 0!==s.camera&&a.push(n.getDependency("camera",s.camera).then((function(t){return n._getNodeRef(n.cameraCache,s.camera,t)}))),n._invokeAll((function(e){return e.createNodeAttachment&&e.createNodeAttachment(t)})).forEach((function(t){a.push(t)})),this.nodeCache[t]=Promise.all(a).then((function(e){let a;if(a=!0===s.isBone?new wo:e.length>1?new Da:1===e.length?e[0]:new Oi,a!==e[0])for(let t=0,i=e.length;t<i;t++)a.add(e[t]);if(s.name&&(a.userData.name=s.name,a.name=r),u_(a,s),s.extensions&&c_(i,a,s),void 0!==s.matrix){const t=new ci;t.fromArray(s.matrix),a.applyMatrix4(t)}else void 0!==s.translation&&a.position.fromArray(s.translation),void 0!==s.rotation&&a.quaternion.fromArray(s.rotation),void 0!==s.scale&&a.scale.fromArray(s.scale);return n.associations.has(a)||n.associations.set(a,{}),n.associations.get(a).nodes=t,a})),this.nodeCache[t]}loadScene(t){const e=this.extensions,i=this.json.scenes[t],n=this,s=new Da;i.name&&(s.name=n.createUniqueName(i.name)),u_(s,i),i.extensions&&c_(e,s,i);const r=i.nodes||[],a=[];for(let t=0,e=r.length;t<e;t++)a.push(n.getDependency("node",r[t]));return Promise.all(a).then((function(t){for(let e=0,i=t.length;e<i;e++)s.add(t[e]);return n.associations=(t=>{const e=new Map;for(const[t,i]of n.associations)(t instanceof en||t instanceof Ae)&&e.set(t,i);return t.traverse((t=>{const i=n.associations.get(t);null!=i&&e.set(t,i)})),e})(s),s}))}_createAnimationTracks(t,e,i,n,s){const r=[],a=t.name?t.name:t.uuid,o=[];let h;switch(r_[s.path]===r_.weights?t.traverse((function(t){t.morphTargetInfluences&&o.push(t.name?t.name:t.uuid)})):o.push(a),r_[s.path]){case r_.weights:h=nc;break;case r_.rotation:h=rc;break;case r_.position:case r_.scale:h=oc;break;default:if(1===i.itemSize)h=nc;else h=oc}const l=void 0!==n.interpolation?a_[n.interpolation]:_t,c=this._getArrayFromAccessor(i);for(let t=0,i=o.length;t<i;t++){const i=new h(o[t]+"."+r_[s.path],e.array,c,l);"CUBICSPLINE"===n.interpolation&&this._createCubicSplineTrackInterpolant(i),r.push(i)}return r}_getArrayFromAccessor(t){let e=t.array;if(t.normalized){const t=f_(e.constructor),i=new Float32Array(e.length);for(let n=0,s=e.length;n<s;n++)i[n]=e[n]*t;e=i}return e}_createCubicSplineTrackInterpolant(t){t.createInterpolant=function(t){return new(this instanceof rc?Zb:$b)(this.times,this.values,this.getValueSize()/3,t)},t.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function y_(t,e,i){const n=e.attributes,s=[];function r(e,n){return i.getDependency("accessor",e).then((function(e){t.setAttribute(n,e)}))}for(const e in n){const i=s_[e]||e.toLowerCase();i in t.attributes||s.push(r(n[e],i))}if(void 0!==e.indices&&!t.index){const n=i.getDependency("accessor",e.indices).then((function(e){t.setIndex(e)}));s.push(n)}return ye.workingColorSpace,u_(t,e),function(t,e,i){const n=e.attributes,s=new Be;if(void 0===n.POSITION)return;{const t=i.json.accessors[n.POSITION],e=t.min,r=t.max;if(void 0===e||void 0===r)return;if(s.set(new Le(e[0],e[1],e[2]),new Le(r[0],r[1],r[2])),t.normalized){const e=f_(t_[t.componentType]);s.min.multiplyScalar(e),s.max.multiplyScalar(e)}}const r=e.targets;if(void 0!==r){const t=new Le,e=new Le;for(let n=0,s=r.length;n<s;n++){const s=r[n];if(void 0!==s.POSITION){const n=i.json.accessors[s.POSITION],r=n.min,a=n.max;if(void 0!==r&&void 0!==a){if(e.setX(Math.max(Math.abs(r[0]),Math.abs(a[0]))),e.setY(Math.max(Math.abs(r[1]),Math.abs(a[1]))),e.setZ(Math.max(Math.abs(r[2]),Math.abs(a[2]))),n.normalized){const t=f_(t_[n.componentType]);e.multiplyScalar(t)}t.max(e)}}}s.expandByVector(t)}t.boundingBox=s;const a=new ei;s.getCenter(a.center),a.radius=s.min.distanceTo(s.max)/2,t.boundingSphere=a}(t,e,i),Promise.all(s).then((function(){return void 0!==e.targets?function(t,e,i){let n=!1,s=!1,r=!1;for(let t=0,i=e.length;t<i;t++){const i=e[t];if(void 0!==i.POSITION&&(n=!0),void 0!==i.NORMAL&&(s=!0),void 0!==i.COLOR_0&&(r=!0),n&&s&&r)break}if(!n&&!s&&!r)return Promise.resolve(t);const a=[],o=[],h=[];for(let l=0,c=e.length;l<c;l++){const c=e[l];if(n){const e=void 0!==c.POSITION?i.getDependency("accessor",c.POSITION):t.attributes.position;a.push(e)}if(s){const e=void 0!==c.NORMAL?i.getDependency("accessor",c.NORMAL):t.attributes.normal;o.push(e)}if(r){const e=void 0!==c.COLOR_0?i.getDependency("accessor",c.COLOR_0):t.attributes.color;h.push(e)}}return Promise.all([Promise.all(a),Promise.all(o),Promise.all(h)]).then((function(e){const i=e[0],a=e[1],o=e[2];return n&&(t.morphAttributes.position=i),s&&(t.morphAttributes.normal=a),r&&(t.morphAttributes.color=o),t.morphTargetsRelative=!0,t}))}(t,e.targets,i):t}))}var x_=function(t){return URL.createObjectURL(new Blob([t],{type:"text/javascript"}))};try{URL.revokeObjectURL(x_(""))}catch(t){x_=function(t){return"data:application/javascript;charset=UTF-8,"+encodeURI(t)},function(t){return new Worker(t,{type:"module"})}}var b_=Uint8Array,__=Uint16Array,w_=Uint32Array,M_=new b_([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),S_=new b_([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),E_=new b_([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),T_=function(t,e){for(var i=new __(31),n=0;n<31;++n)i[n]=e+=1<<t[n-1];var s=new w_(i[30]);for(n=1;n<30;++n)for(var r=i[n];r<i[n+1];++r)s[r]=r-i[n]<<5|n;return[i,s]},A_=T_(M_,2),C_=A_[0],I_=A_[1];C_[28]=258,I_[258]=28;for(var R_=T_(S_,0),k_=R_[0],P_=(R_[1],new __(32768)),D_=0;D_<32768;++D_){var L_=(43690&D_)>>>1|(21845&D_)<<1;L_=(61680&(L_=(52428&L_)>>>2|(13107&L_)<<2))>>>4|(3855&L_)<<4,P_[D_]=((65280&L_)>>>8|(255&L_)<<8)>>>1}var O_=function(t,e,i){for(var n=t.length,s=0,r=new __(e);s<n;++s)++r[t[s]-1];var a,o=new __(e);for(s=0;s<e;++s)o[s]=o[s-1]+r[s-1]<<1;if(i){a=new __(1<<e);var h=15-e;for(s=0;s<n;++s)if(t[s])for(var l=s<<4|t[s],c=e-t[s],u=o[t[s]-1]++<<c,d=u|(1<<c)-1;u<=d;++u)a[P_[u]>>>h]=l}else for(a=new __(n),s=0;s<n;++s)t[s]&&(a[s]=P_[o[t[s]-1]++]>>>15-t[s]);return a},N_=new b_(288);for(D_=0;D_<144;++D_)N_[D_]=8;for(D_=144;D_<256;++D_)N_[D_]=9;for(D_=256;D_<280;++D_)N_[D_]=7;for(D_=280;D_<288;++D_)N_[D_]=8;var B_=new b_(32);for(D_=0;D_<32;++D_)B_[D_]=5;var z_=O_(N_,9,1),U_=O_(B_,5,1),F_=function(t){for(var e=t[0],i=1;i<t.length;++i)t[i]>e&&(e=t[i]);return e},G_=function(t,e,i){var n=e/8|0;return(t[n]|t[n+1]<<8)>>(7&e)&i},V_=function(t,e){var i=e/8|0;return(t[i]|t[i+1]<<8|t[i+2]<<16)>>(7&e)},H_=function(t){return(t/8|0)+(7&t&&1)},j_=function(t,e,i){(null==e||e<0)&&(e=0),(null==i||i>t.length)&&(i=t.length);var n=new(t instanceof __?__:t instanceof w_?w_:b_)(i-e);return n.set(t.subarray(e,i)),n},W_=function(t,e,i){var n=t.length;if(!n||i&&!i.l&&n<5)return e||new b_(0);var s=!e||i,r=!i||i.i;i||(i={}),e||(e=new b_(3*n));var a=function(t){var i=e.length;if(t>i){var n=new b_(Math.max(2*i,t));n.set(e),e=n}},o=i.f||0,h=i.p||0,l=i.b||0,c=i.l,u=i.d,d=i.m,p=i.n,m=8*n;do{if(!c){i.f=o=G_(t,h,1);var f=G_(t,h+1,3);if(h+=3,!f){var g=t[(A=H_(h)+4)-4]|t[A-3]<<8,v=A+g;if(v>n){if(r)throw"unexpected EOF";break}s&&a(l+g),e.set(t.subarray(A,v),l),i.b=l+=g,i.p=h=8*v;continue}if(1==f)c=z_,u=U_,d=9,p=5;else{if(2!=f)throw"invalid block type";var y=G_(t,h,31)+257,x=G_(t,h+10,15)+4,b=y+G_(t,h+5,31)+1;h+=14;for(var _=new b_(b),w=new b_(19),M=0;M<x;++M)w[E_[M]]=G_(t,h+3*M,7);h+=3*x;var S=F_(w),E=(1<<S)-1,T=O_(w,S,1);for(M=0;M<b;){var A,C=T[G_(t,h,E)];if(h+=15&C,(A=C>>>4)<16)_[M++]=A;else{var I=0,R=0;for(16==A?(R=3+G_(t,h,3),h+=2,I=_[M-1]):17==A?(R=3+G_(t,h,7),h+=3):18==A&&(R=11+G_(t,h,127),h+=7);R--;)_[M++]=I}}var k=_.subarray(0,y),P=_.subarray(y);d=F_(k),p=F_(P),c=O_(k,d,1),u=O_(P,p,1)}if(h>m){if(r)throw"unexpected EOF";break}}s&&a(l+131072);for(var D=(1<<d)-1,L=(1<<p)-1,O=h;;O=h){var N=(I=c[V_(t,h)&D])>>>4;if((h+=15&I)>m){if(r)throw"unexpected EOF";break}if(!I)throw"invalid length/literal";if(N<256)e[l++]=N;else{if(256==N){O=h,c=null;break}var B=N-254;if(N>264){var z=M_[M=N-257];B=G_(t,h,(1<<z)-1)+C_[M],h+=z}var U=u[V_(t,h)&L],F=U>>>4;if(!U)throw"invalid distance";h+=15&U;P=k_[F];if(F>3){z=S_[F];P+=V_(t,h)&(1<<z)-1,h+=z}if(h>m){if(r)throw"unexpected EOF";break}s&&a(l+131072);for(var G=l+B;l<G;l+=4)e[l]=e[l-P],e[l+1]=e[l+1-P],e[l+2]=e[l+2-P],e[l+3]=e[l+3-P];l=G}}i.l=c,i.p=O,i.b=l,c&&(o=1,i.m=d,i.d=u,i.n=p)}while(!o);return l==e.length?e:j_(e,0,l)},X_=new b_(0),q_=function(t){if(8!=(15&t[0])||t[0]>>>4>7||(t[0]<<8|t[1])%31)throw"invalid zlib data";if(32&t[1])throw"invalid zlib data: preset dictionaries not supported"};function Y_(t,e){return W_((q_(t),t.subarray(2,-4)),e)}var J_="undefined"!=typeof TextDecoder&&new TextDecoder;try{J_.decode(X_,{stream:!0}),1}catch(t){}function $_(t,e,i){const n=i.length-t-1;if(e>=i[n])return n-1;if(e<=i[t])return t;let s=t,r=n,a=Math.floor((s+r)/2);for(;e<i[a]||e>=i[a+1];)e<i[a]?r=a:s=a,a=Math.floor((s+r)/2);return a}function K_(t,e,i,n){const s=[],r=[],a=[];s[0]=1;for(let o=1;o<=i;++o){r[o]=e-n[t+1-o],a[o]=n[t+o]-e;let i=0;for(let t=0;t<o;++t){const e=a[t+1],n=r[o-t],h=s[t]/(e+n);s[t]=i+e*h,i=n*h}s[o]=i}return s}function Z_(t,e){let i=1;for(let e=2;e<=t;++e)i*=e;let n=1;for(let t=2;t<=e;++t)n*=t;for(let i=2;i<=t-e;++i)n*=i;return i/n}function Q_(t,e,i,n,s){const r=function(t,e,i,n,s){const r=s<t?s:t,a=[],o=$_(t,n,e),h=function(t,e,i,n,s){const r=[];for(let t=0;t<=i;++t)r[t]=0;const a=[];for(let t=0;t<=n;++t)a[t]=r.slice(0);const o=[];for(let t=0;t<=i;++t)o[t]=r.slice(0);o[0][0]=1;const h=r.slice(0),l=r.slice(0);for(let n=1;n<=i;++n){h[n]=e-s[t+1-n],l[n]=s[t+n]-e;let i=0;for(let t=0;t<n;++t){const e=l[t+1],s=h[n-t];o[n][t]=e+s;const r=o[t][n-1]/o[n][t];o[t][n]=i+e*r,i=s*r}o[n][n]=i}for(let t=0;t<=i;++t)a[0][t]=o[t][i];for(let t=0;t<=i;++t){let e=0,s=1;const h=[];for(let t=0;t<=i;++t)h[t]=r.slice(0);h[0][0]=1;for(let r=1;r<=n;++r){let n=0;const l=t-r,c=i-r;t>=r&&(h[s][0]=h[e][0]/o[c+1][l],n=h[s][0]*o[l][c]);const u=t-1<=c?r-1:i-t;for(let t=l>=-1?1:-l;t<=u;++t)h[s][t]=(h[e][t]-h[e][t-1])/o[c+1][l+t],n+=h[s][t]*o[l+t][c];t<=c&&(h[s][r]=-h[e][r-1]/o[c+1][t],n+=h[s][r]*o[t][c]),a[r][t]=n;const d=e;e=s,s=d}}let c=i;for(let t=1;t<=n;++t){for(let e=0;e<=i;++e)a[t][e]*=c;c*=i-t}return a}(o,n,t,r,e),l=[];for(let t=0;t<i.length;++t){const e=i[t].clone(),n=e.w;e.x*=n,e.y*=n,e.z*=n,l[t]=e}for(let e=0;e<=r;++e){const i=l[o-t].clone().multiplyScalar(h[e][0]);for(let n=1;n<=t;++n)i.add(l[o-t+n].clone().multiplyScalar(h[e][n]));a[e]=i}for(let t=r+1;t<=s+1;++t)a[t]=new Ce(0,0,0);return a}(t,e,i,n,s);return function(t){const e=t.length,i=[],n=[];for(let s=0;s<e;++s){const e=t[s];i[s]=new Le(e.x,e.y,e.z),n[s]=e.w}const s=[];for(let t=0;t<e;++t){const e=i[t].clone();for(let i=1;i<=t;++i)e.sub(s[t-i].clone().multiplyScalar(Z_(t,i)*n[i]));s[t]=e.divideScalar(n[0])}return s}(r)}class tw extends yh{constructor(t,e,i,n,s){super(),this.degree=t,this.knots=e,this.controlPoints=[],this.startKnot=n||0,this.endKnot=s||this.knots.length-1;for(let t=0;t<i.length;++t){const e=i[t];this.controlPoints[t]=new Ce(e.x,e.y,e.z,e.w)}}getPoint(t,e=new Le){const i=e,n=this.knots[this.startKnot]+t*(this.knots[this.endKnot]-this.knots[this.startKnot]),s=function(t,e,i,n){const s=$_(t,n,e),r=K_(s,n,t,e),a=new Ce(0,0,0,0);for(let e=0;e<=t;++e){const n=i[s-t+e],o=r[e],h=n.w*o;a.x+=n.x*h,a.y+=n.y*h,a.z+=n.z*h,a.w+=n.w*o}return a}(this.degree,this.knots,this.controlPoints,n);return 1!==s.w&&s.divideScalar(s.w),i.set(s.x,s.y,s.z)}getTangent(t,e=new Le){const i=e,n=this.knots[0]+t*(this.knots[this.knots.length-1]-this.knots[0]),s=Q_(this.degree,this.knots,this.controlPoints,n,1);return i.copy(s[1]).normalize(),i}}let ew,iw,nw;class sw extends pc{constructor(t){super(t)}load(t,e,i,n){const s=this,r=""===s.path?Uc.extractUrlBase(t):s.path,a=new gc(this.manager);a.setPath(s.path),a.setResponseType("arraybuffer"),a.setRequestHeader(s.requestHeader),a.setWithCredentials(s.withCredentials),a.load(t,(function(i){try{e(s.parse(i,r))}catch(e){n&&n(e),s.manager.itemError(t)}}),i,n)}parse(t,e){if(function(t){const e="Kaydara FBX Binary  \0";return t.byteLength>=e.length&&e===_w(t,0,e.length)}(t))ew=(new lw).parse(t);else{const e=_w(t);if(!function(t){const e=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"];let i=0;function n(e){const n=t[e-1];return t=t.slice(i+e),i++,n}for(let t=0;t<e.length;++t){if(n(1)===e[t])return!1}return!0}(e))throw new Error("THREE.FBXLoader: Unknown format.");if(dw(e)<7e3)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+dw(e));ew=(new hw).parse(e)}const i=new yc(this.manager).setPath(this.resourcePath||e).setCrossOrigin(this.crossOrigin);return new rw(i,this.manager).parse(ew)}}class rw{constructor(t,e){this.textureLoader=t,this.manager=e}parse(){iw=this.parseConnections();const t=this.parseImages(),e=this.parseTextures(t),i=this.parseMaterials(e),n=this.parseDeformers(),s=(new aw).parse(n);return this.parseScene(n,s,i),nw}parseConnections(){const t=new Map;if("Connections"in ew){ew.Connections.connections.forEach((function(e){const i=e[0],n=e[1],s=e[2];t.has(i)||t.set(i,{parents:[],children:[]});const r={ID:n,relationship:s};t.get(i).parents.push(r),t.has(n)||t.set(n,{parents:[],children:[]});const a={ID:i,relationship:s};t.get(n).children.push(a)}))}return t}parseImages(){const t={},e={};if("Video"in ew.Objects){const i=ew.Objects.Video;for(const n in i){const s=i[n];if(t[parseInt(n)]=s.RelativeFilename||s.Filename,"Content"in s){const t=s.Content instanceof ArrayBuffer&&s.Content.byteLength>0,r="string"==typeof s.Content&&""!==s.Content;if(t||r){const t=this.parseImage(i[n]);e[s.RelativeFilename||s.Filename]=t}}}}for(const i in t){const n=t[i];void 0!==e[n]?t[i]=e[n]:t[i]=t[i].split("\\").pop()}return t}parseImage(t){const e=t.Content,i=t.RelativeFilename||t.Filename;let n;switch(i.slice(i.lastIndexOf(".")+1).toLowerCase()){case"bmp":n="image/bmp";break;case"jpg":case"jpeg":n="image/jpeg";break;case"png":n="image/png";break;case"tif":n="image/tiff";break;case"tga":this.manager.getHandler(".tga"),n="image/tga";break;default:return}if("string"==typeof e)return"data:"+n+";base64,"+e;{const t=new Uint8Array(e);return window.URL.createObjectURL(new Blob([t],{type:n}))}}parseTextures(t){const e=new Map;if("Texture"in ew.Objects){const i=ew.Objects.Texture;for(const n in i){const s=this.parseTexture(i[n],t);e.set(parseInt(n),s)}}return e}parseTexture(t,e){const i=this.loadTexture(t,e);i.ID=t.id,i.name=t.attrName;const n=t.WrapModeU,s=t.WrapModeV,r=void 0!==n?n.value:0,a=void 0!==s?s.value:0;if(i.wrapS=0===r?Y:J,i.wrapT=0===a?Y:J,"Scaling"in t){const e=t.Scaling.value;i.repeat.x=e[0],i.repeat.y=e[1]}if("Translation"in t){const e=t.Translation.value;i.offset.x=e[0],i.offset.y=e[1]}return i}loadTexture(t,e){let i;const n=this.textureLoader.path,s=iw.get(t.id).children;let r;void 0!==s&&s.length>0&&void 0!==e[s[0].ID]&&(i=e[s[0].ID],0!==i.indexOf("blob:")&&0!==i.indexOf("data:")||this.textureLoader.setPath(void 0));const a=t.FileName.slice(-3).toLowerCase();if("tga"===a){const t=this.manager.getHandler(".tga");null===t?r=new Ae:(t.setPath(this.textureLoader.path),r=t.load(i))}else if("dds"===a){const t=this.manager.getHandler(".dds");null===t?r=new Ae:(t.setPath(this.textureLoader.path),r=t.load(i))}else r="psd"===a?new Ae:this.textureLoader.load(i);return this.textureLoader.setPath(n),r}parseMaterials(t){const e=new Map;if("Material"in ew.Objects){const i=ew.Objects.Material;for(const n in i){const s=this.parseMaterial(i[n],t);null!==s&&e.set(parseInt(n),s)}}return e}parseMaterial(t,e){const i=t.id,n=t.attrName;let s=t.ShadingModel;if("object"==typeof s&&(s=s.value),!iw.has(i))return null;const r=this.parseParameters(t,e,i);let a;switch(s.toLowerCase()){case"phong":default:a=new Ul;break;case"lambert":a=new Vl}return a.setValues(r),a.name=n,a}parseParameters(t,e,i){const n={};t.BumpFactor&&(n.bumpScale=t.BumpFactor.value),t.Diffuse?n.color=(new Zi).fromArray(t.Diffuse.value).convertSRGBToLinear():!t.DiffuseColor||"Color"!==t.DiffuseColor.type&&"ColorRGB"!==t.DiffuseColor.type||(n.color=(new Zi).fromArray(t.DiffuseColor.value).convertSRGBToLinear()),t.DisplacementFactor&&(n.displacementScale=t.DisplacementFactor.value),t.Emissive?n.emissive=(new Zi).fromArray(t.Emissive.value).convertSRGBToLinear():!t.EmissiveColor||"Color"!==t.EmissiveColor.type&&"ColorRGB"!==t.EmissiveColor.type||(n.emissive=(new Zi).fromArray(t.EmissiveColor.value).convertSRGBToLinear()),t.EmissiveFactor&&(n.emissiveIntensity=parseFloat(t.EmissiveFactor.value)),t.Opacity&&(n.opacity=parseFloat(t.Opacity.value)),n.opacity<1&&(n.transparent=!0),t.ReflectionFactor&&(n.reflectivity=t.ReflectionFactor.value),t.Shininess&&(n.shininess=t.Shininess.value),t.Specular?n.specular=(new Zi).fromArray(t.Specular.value).convertSRGBToLinear():t.SpecularColor&&"Color"===t.SpecularColor.type&&(n.specular=(new Zi).fromArray(t.SpecularColor.value).convertSRGBToLinear());const s=this;return iw.get(i).children.forEach((function(t){switch(t.relationship){case"Bump":n.bumpMap=s.getTexture(e,t.ID);break;case"Maya|TEX_ao_map":n.aoMap=s.getTexture(e,t.ID);break;case"DiffuseColor":case"Maya|TEX_color_map":n.map=s.getTexture(e,t.ID),void 0!==n.map&&(n.map.colorSpace=It);break;case"DisplacementColor":n.displacementMap=s.getTexture(e,t.ID);break;case"EmissiveColor":n.emissiveMap=s.getTexture(e,t.ID),void 0!==n.emissiveMap&&(n.emissiveMap.colorSpace=It);break;case"NormalMap":case"Maya|TEX_normal_map":n.normalMap=s.getTexture(e,t.ID);break;case"ReflectionColor":n.envMap=s.getTexture(e,t.ID),void 0!==n.envMap&&(n.envMap.mapping=W,n.envMap.colorSpace=It);break;case"SpecularColor":n.specularMap=s.getTexture(e,t.ID),void 0!==n.specularMap&&(n.specularMap.colorSpace=It);break;case"TransparentColor":case"TransparencyFactor":n.alphaMap=s.getTexture(e,t.ID),n.transparent=!0}})),n}getTexture(t,e){return"LayeredTexture"in ew.Objects&&e in ew.Objects.LayeredTexture&&(e=iw.get(e).children[0].ID),t.get(e)}parseDeformers(){const t={},e={};if("Deformer"in ew.Objects){const i=ew.Objects.Deformer;for(const n in i){const s=i[n],r=iw.get(parseInt(n));if("Skin"===s.attrType){const e=this.parseSkeleton(r,i);e.ID=n,r.parents.length,e.geometryID=r.parents[0].ID,t[n]=e}else if("BlendShape"===s.attrType){const t={id:n};t.rawTargets=this.parseMorphTargets(r,i),t.id=n,r.parents.length,e[n]=t}}}return{skeletons:t,morphTargets:e}}parseSkeleton(t,e){const i=[];return t.children.forEach((function(t){const n=e[t.ID];if("Cluster"!==n.attrType)return;const s={ID:t.ID,indices:[],weights:[],transformLink:(new ci).fromArray(n.TransformLink.a)};"Indexes"in n&&(s.indices=n.Indexes.a,s.weights=n.Weights.a),i.push(s)})),{rawBones:i,bones:[]}}parseMorphTargets(t,e){const i=[];for(let n=0;n<t.children.length;n++){const s=t.children[n],r=e[s.ID],a={name:r.attrName,initialWeight:r.DeformPercent,id:r.id,fullWeights:r.FullWeights.a};if("BlendShapeChannel"!==r.attrType)return;a.geoID=iw.get(parseInt(s.ID)).children.filter((function(t){return void 0===t.relationship}))[0].ID,i.push(a)}return i}parseScene(t,e,i){nw=new Da;const n=this.parseModels(t.skeletons,e,i),s=ew.Objects.Model,r=this;n.forEach((function(t){const e=s[t.ID];r.setLookAtProperties(t,e);iw.get(t.ID).parents.forEach((function(e){const i=n.get(e.ID);void 0!==i&&i.add(t)})),null===t.parent&&nw.add(t)})),this.bindSkeleton(t.skeletons,e,n),this.addGlobalSceneSettings(),nw.traverse((function(t){if(t.userData.transformData){t.parent&&(t.userData.transformData.parentMatrix=t.parent.matrix,t.userData.transformData.parentMatrixWorld=t.parent.matrixWorld);const e=yw(t.userData.transformData);t.applyMatrix4(e),t.updateWorldMatrix()}}));const a=(new ow).parse();1===nw.children.length&&nw.children[0].isGroup&&(nw.children[0].animations=a,nw=nw.children[0]),nw.animations=a}parseModels(t,e,i){const n=new Map,s=ew.Objects.Model;for(const r in s){const a=parseInt(r),o=s[r],h=iw.get(a);let l=this.buildSkeleton(h,t,a,o.attrName);if(!l){switch(o.attrType){case"Camera":l=this.createCamera(h);break;case"Light":l=this.createLight(h);break;case"Mesh":l=this.createMesh(h,e,i);break;case"NurbsCurve":l=this.createCurve(h,e);break;case"LimbNode":case"Root":l=new wo;break;default:l=new Da}l.name=o.attrName?iu.sanitizeNodeName(o.attrName):"",l.userData.originalName=o.attrName,l.ID=a}this.getTransformData(l,o),n.set(a,l)}return n}buildSkeleton(t,e,i,n){let s=null;return t.parents.forEach((function(t){for(const r in e){const a=e[r];a.rawBones.forEach((function(e,r){if(e.ID===t.ID){const t=s;s=new wo,s.matrixWorld.copy(e.transformLink),s.name=n?iu.sanitizeNodeName(n):"",s.userData.originalName=n,s.ID=i,a.bones[r]=s,null!==t&&s.add(t)}}))}})),s}createCamera(t){let e,i;if(t.children.forEach((function(t){const e=ew.Objects.NodeAttribute[t.ID];void 0!==e&&(i=e)})),void 0===i)e=new Oi;else{let t=0;void 0!==i.CameraProjectionType&&1===i.CameraProjectionType.value&&(t=1);let n=1;void 0!==i.NearPlane&&(n=i.NearPlane.value/1e3);let s=1e3;void 0!==i.FarPlane&&(s=i.FarPlane.value/1e3);let r=window.innerWidth,a=window.innerHeight;void 0!==i.AspectWidth&&void 0!==i.AspectHeight&&(r=i.AspectWidth.value,a=i.AspectHeight.value);const o=r/a;let h=45;void 0!==i.FieldOfView&&(h=i.FieldOfView.value);const l=i.FocalLength?i.FocalLength.value:null;switch(t){case 0:e=new jn(h,o,n,s),null!==l&&e.setFocalLength(l);break;case 1:e=new fs(-r/2,r/2,a/2,-a/2,n,s);break;default:e=new Oi}}return e}createLight(t){let e,i;if(t.children.forEach((function(t){const e=ew.Objects.NodeAttribute[t.ID];void 0!==e&&(i=e)})),void 0===i)e=new Oi;else{let t;t=void 0===i.LightType?0:i.LightType.value;let n=16777215;void 0!==i.Color&&(n=(new Zi).fromArray(i.Color.value).convertSRGBToLinear());let s=void 0===i.Intensity?1:i.Intensity.value/100;void 0!==i.CastLightOnObject&&0===i.CastLightOnObject.value&&(s=0);let r=0;void 0!==i.FarAttenuationEnd&&(r=void 0!==i.EnableFarAttenuation&&0===i.EnableFarAttenuation.value?0:i.FarAttenuationEnd.value);const a=1;switch(t){case 0:e=new kc(n,s,r,a);break;case 1:e=new Dc(n,s);break;case 2:let t=Math.PI/3;void 0!==i.InnerAngle&&(t=ne.degToRad(i.InnerAngle.value));let o=0;void 0!==i.OuterAngle&&(o=ne.degToRad(i.OuterAngle.value),o=Math.max(o,1)),e=new Tc(n,s,r,t,o,a);break;default:e=new kc(n,s)}void 0!==i.CastShadows&&1===i.CastShadows.value&&(e.castShadow=!0)}return e}createMesh(t,e,i){let n,s=null,r=null;const a=[];return t.children.forEach((function(t){e.has(t.ID)&&(s=e.get(t.ID)),i.has(t.ID)&&a.push(i.get(t.ID))})),a.length>1?r=a:a.length>0?r=a[0]:(r=new Ul({name:pc.DEFAULT_MATERIAL_NAME,color:13421772}),a.push(r)),"color"in s.attributes&&a.forEach((function(t){t.vertexColors=!0})),s.FBX_Deformer?(n=new _o(s,r),n.normalizeSkinWeights()):n=new On(s,r),n}createCurve(t,e){const i=t.children.reduce((function(t,i){return e.has(i.ID)&&(t=e.get(i.ID)),t}),null),n=new Qo({name:pc.DEFAULT_MATERIAL_NAME,color:3342591,linewidth:1});return new rh(i,n)}getTransformData(t,e){const i={};"InheritType"in e&&(i.inheritType=parseInt(e.InheritType.value)),i.eulerOrder="RotationOrder"in e?xw(e.RotationOrder.value):"ZYX","Lcl_Translation"in e&&(i.translation=e.Lcl_Translation.value),"PreRotation"in e&&(i.preRotation=e.PreRotation.value),"Lcl_Rotation"in e&&(i.rotation=e.Lcl_Rotation.value),"PostRotation"in e&&(i.postRotation=e.PostRotation.value),"Lcl_Scaling"in e&&(i.scale=e.Lcl_Scaling.value),"ScalingOffset"in e&&(i.scalingOffset=e.ScalingOffset.value),"ScalingPivot"in e&&(i.scalingPivot=e.ScalingPivot.value),"RotationOffset"in e&&(i.rotationOffset=e.RotationOffset.value),"RotationPivot"in e&&(i.rotationPivot=e.RotationPivot.value),t.userData.transformData=i}setLookAtProperties(t,e){if("LookAtProperty"in e){iw.get(t.ID).children.forEach((function(e){if("LookAtProperty"===e.relationship){const i=ew.Objects.Model[e.ID];if("Lcl_Translation"in i){const e=i.Lcl_Translation.value;void 0!==t.target?(t.target.position.fromArray(e),nw.add(t.target)):t.lookAt((new Le).fromArray(e))}}}))}}bindSkeleton(t,e,i){const n=this.parsePoseNodes();for(const s in t){const r=t[s];iw.get(parseInt(r.ID)).parents.forEach((function(t){if(e.has(t.ID)){const e=t.ID;iw.get(e).parents.forEach((function(t){if(i.has(t.ID)){i.get(t.ID).bind(new To(r.bones),n[t.ID])}}))}}))}}parsePoseNodes(){const t={};if("Pose"in ew.Objects){const e=ew.Objects.Pose;for(const i in e)if("BindPose"===e[i].attrType&&e[i].NbPoseNodes>0){const n=e[i].PoseNode;Array.isArray(n)?n.forEach((function(e){t[e.Node]=(new ci).fromArray(e.Matrix.a)})):t[n.Node]=(new ci).fromArray(n.Matrix.a)}}return t}addGlobalSceneSettings(){if("GlobalSettings"in ew){if("AmbientColor"in ew.GlobalSettings){const t=ew.GlobalSettings.AmbientColor.value,e=t[0],i=t[1],n=t[2];if(0!==e||0!==i||0!==n){const t=new Zi(e,i,n).convertSRGBToLinear();nw.add(new Lc(t,1))}}"UnitScaleFactor"in ew.GlobalSettings&&(nw.userData.unitScaleFactor=ew.GlobalSettings.UnitScaleFactor.value)}}}class aw{constructor(){this.negativeMaterialIndices=!1}parse(t){const e=new Map;if("Geometry"in ew.Objects){const i=ew.Objects.Geometry;for(const n in i){const s=iw.get(parseInt(n)),r=this.parseGeometry(s,i[n],t);e.set(parseInt(n),r)}}return this.negativeMaterialIndices,e}parseGeometry(t,e,i){switch(e.attrType){case"Mesh":return this.parseMeshGeometry(t,e,i);case"NurbsCurve":return this.parseNurbsGeometry(e)}}parseMeshGeometry(t,e,i){const n=i.skeletons,s=[],r=t.parents.map((function(t){return ew.Objects.Model[t.ID]}));if(0===r.length)return;const a=t.children.reduce((function(t,e){return void 0!==n[e.ID]&&(t=n[e.ID]),t}),null);t.children.forEach((function(t){void 0!==i.morphTargets[t.ID]&&s.push(i.morphTargets[t.ID])}));const o=r[0],h={};"RotationOrder"in o&&(h.eulerOrder=xw(o.RotationOrder.value)),"InheritType"in o&&(h.inheritType=parseInt(o.InheritType.value)),"GeometricTranslation"in o&&(h.translation=o.GeometricTranslation.value),"GeometricRotation"in o&&(h.rotation=o.GeometricRotation.value),"GeometricScaling"in o&&(h.scale=o.GeometricScaling.value);const l=yw(h);return this.genGeometry(e,a,s,l)}genGeometry(t,e,i,n){const s=new vn;t.attrName&&(s.name=t.attrName);const r=this.parseGeoNode(t,e),a=this.genBuffers(r),o=new ln(a.vertex,3);if(o.applyMatrix4(n),s.setAttribute("position",o),a.colors.length>0&&s.setAttribute("color",new ln(a.colors,3)),e&&(s.setAttribute("skinIndex",new on(a.weightsIndices,4)),s.setAttribute("skinWeight",new ln(a.vertexWeights,4)),s.FBX_Deformer=e),a.normal.length>0){const t=(new re).getNormalMatrix(n),e=new ln(a.normal,3);e.applyNormalMatrix(t),s.setAttribute("normal",e)}if(a.uvs.forEach((function(t,e){const i=0===e?"uv":`uv${e}`;s.setAttribute(i,new ln(a.uvs[e],2))})),r.material&&"AllSame"!==r.material.mappingType){let t=a.materialIndex[0],e=0;if(a.materialIndex.forEach((function(i,n){i!==t&&(s.addGroup(e,n-e,t),t=i,e=n)})),s.groups.length>0){const e=s.groups[s.groups.length-1],i=e.start+e.count;i!==a.materialIndex.length&&s.addGroup(i,a.materialIndex.length-i,t)}0===s.groups.length&&s.addGroup(0,a.materialIndex.length,a.materialIndex[0])}return this.addMorphTargets(s,t,i,n),s}parseGeoNode(t,e){const i={};if(i.vertexPositions=void 0!==t.Vertices?t.Vertices.a:[],i.vertexIndices=void 0!==t.PolygonVertexIndex?t.PolygonVertexIndex.a:[],t.LayerElementColor&&(i.color=this.parseVertexColors(t.LayerElementColor[0])),t.LayerElementMaterial&&(i.material=this.parseMaterialIndices(t.LayerElementMaterial[0])),t.LayerElementNormal&&(i.normal=this.parseNormals(t.LayerElementNormal[0])),t.LayerElementUV){i.uv=[];let e=0;for(;t.LayerElementUV[e];)t.LayerElementUV[e].UV&&i.uv.push(this.parseUVs(t.LayerElementUV[e])),e++}return i.weightTable={},null!==e&&(i.skeleton=e,e.rawBones.forEach((function(t,e){t.indices.forEach((function(n,s){void 0===i.weightTable[n]&&(i.weightTable[n]=[]),i.weightTable[n].push({id:e,weight:t.weights[s]})}))}))),i}genBuffers(t){const e={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]};let i=0,n=0,s=!1,r=[],a=[],o=[],h=[],l=[],c=[];const u=this;return t.vertexIndices.forEach((function(d,p){let m,f=!1;d<0&&(d^=-1,f=!0);let g=[],v=[];if(r.push(3*d,3*d+1,3*d+2),t.color){const e=fw(p,i,d,t.color);o.push(e[0],e[1],e[2])}if(t.skeleton){if(void 0!==t.weightTable[d]&&t.weightTable[d].forEach((function(t){v.push(t.weight),g.push(t.id)})),v.length>4){s||(s=!0);const t=[0,0,0,0],e=[0,0,0,0];v.forEach((function(i,n){let s=i,r=g[n];e.forEach((function(e,i,n){if(s>e){n[i]=s,s=e;const a=t[i];t[i]=r,r=a}}))})),g=t,v=e}for(;v.length<4;)v.push(0),g.push(0);for(let t=0;t<4;++t)l.push(v[t]),c.push(g[t])}if(t.normal){const e=fw(p,i,d,t.normal);a.push(e[0],e[1],e[2])}t.material&&"AllSame"!==t.material.mappingType&&(m=fw(p,i,d,t.material)[0],m<0&&(u.negativeMaterialIndices=!0,m=0)),t.uv&&t.uv.forEach((function(t,e){const n=fw(p,i,d,t);void 0===h[e]&&(h[e]=[]),h[e].push(n[0]),h[e].push(n[1])})),n++,f&&(u.genFace(e,t,r,m,a,o,h,l,c,n),i++,n=0,r=[],a=[],o=[],h=[],l=[],c=[])})),e}getNormalNewell(t){const e=new Le(0,0,0);for(let i=0;i<t.length;i++){const n=t[i],s=t[(i+1)%t.length];e.x+=(n.y-s.y)*(n.z+s.z),e.y+=(n.z-s.z)*(n.x+s.x),e.z+=(n.x-s.x)*(n.y+s.y)}return e.normalize(),e}getNormalTangentAndBitangent(t){const e=this.getNormalNewell(t),i=(Math.abs(e.z)>.5?new Le(0,1,0):new Le(0,0,1)).cross(e).normalize(),n=e.clone().cross(i).normalize();return{normal:e,tangent:i,bitangent:n}}flattenVertex(t,e,i){return new se(t.dot(e),t.dot(i))}genFace(t,e,i,n,s,r,a,o,h,l){let c;if(l>3){const t=[];for(let n=0;n<i.length;n+=3)t.push(new Le(e.vertexPositions[i[n]],e.vertexPositions[i[n+1]],e.vertexPositions[i[n+2]]));const{tangent:n,bitangent:s}=this.getNormalTangentAndBitangent(t),r=[];for(const e of t)r.push(this.flattenVertex(e,n,s));c=xl.triangulateShape(r,[])}else c=[[0,1,2]];for(const[l,u,d]of c)t.vertex.push(e.vertexPositions[i[3*l]]),t.vertex.push(e.vertexPositions[i[3*l+1]]),t.vertex.push(e.vertexPositions[i[3*l+2]]),t.vertex.push(e.vertexPositions[i[3*u]]),t.vertex.push(e.vertexPositions[i[3*u+1]]),t.vertex.push(e.vertexPositions[i[3*u+2]]),t.vertex.push(e.vertexPositions[i[3*d]]),t.vertex.push(e.vertexPositions[i[3*d+1]]),t.vertex.push(e.vertexPositions[i[3*d+2]]),e.skeleton&&(t.vertexWeights.push(o[4*l]),t.vertexWeights.push(o[4*l+1]),t.vertexWeights.push(o[4*l+2]),t.vertexWeights.push(o[4*l+3]),t.vertexWeights.push(o[4*u]),t.vertexWeights.push(o[4*u+1]),t.vertexWeights.push(o[4*u+2]),t.vertexWeights.push(o[4*u+3]),t.vertexWeights.push(o[4*d]),t.vertexWeights.push(o[4*d+1]),t.vertexWeights.push(o[4*d+2]),t.vertexWeights.push(o[4*d+3]),t.weightsIndices.push(h[4*l]),t.weightsIndices.push(h[4*l+1]),t.weightsIndices.push(h[4*l+2]),t.weightsIndices.push(h[4*l+3]),t.weightsIndices.push(h[4*u]),t.weightsIndices.push(h[4*u+1]),t.weightsIndices.push(h[4*u+2]),t.weightsIndices.push(h[4*u+3]),t.weightsIndices.push(h[4*d]),t.weightsIndices.push(h[4*d+1]),t.weightsIndices.push(h[4*d+2]),t.weightsIndices.push(h[4*d+3])),e.color&&(t.colors.push(r[3*l]),t.colors.push(r[3*l+1]),t.colors.push(r[3*l+2]),t.colors.push(r[3*u]),t.colors.push(r[3*u+1]),t.colors.push(r[3*u+2]),t.colors.push(r[3*d]),t.colors.push(r[3*d+1]),t.colors.push(r[3*d+2])),e.material&&"AllSame"!==e.material.mappingType&&(t.materialIndex.push(n),t.materialIndex.push(n),t.materialIndex.push(n)),e.normal&&(t.normal.push(s[3*l]),t.normal.push(s[3*l+1]),t.normal.push(s[3*l+2]),t.normal.push(s[3*u]),t.normal.push(s[3*u+1]),t.normal.push(s[3*u+2]),t.normal.push(s[3*d]),t.normal.push(s[3*d+1]),t.normal.push(s[3*d+2])),e.uv&&e.uv.forEach((function(e,i){void 0===t.uvs[i]&&(t.uvs[i]=[]),t.uvs[i].push(a[i][2*l]),t.uvs[i].push(a[i][2*l+1]),t.uvs[i].push(a[i][2*u]),t.uvs[i].push(a[i][2*u+1]),t.uvs[i].push(a[i][2*d]),t.uvs[i].push(a[i][2*d+1])}))}addMorphTargets(t,e,i,n){if(0===i.length)return;t.morphTargetsRelative=!0,t.morphAttributes.position=[];const s=this;i.forEach((function(i){i.rawTargets.forEach((function(i){const r=ew.Objects.Geometry[i.geoID];void 0!==r&&s.genMorphGeometry(t,e,r,n,i.name)}))}))}genMorphGeometry(t,e,i,n,s){const r=void 0!==e.PolygonVertexIndex?e.PolygonVertexIndex.a:[],a=void 0!==i.Vertices?i.Vertices.a:[],o=void 0!==i.Indexes?i.Indexes.a:[],h=3*t.attributes.position.count,l=new Float32Array(h);for(let t=0;t<o.length;t++){const e=3*o[t];l[e]=a[3*t],l[e+1]=a[3*t+1],l[e+2]=a[3*t+2]}const c={vertexIndices:r,vertexPositions:l},u=this.genBuffers(c),d=new ln(u.vertex,3);d.name=s||i.attrName,d.applyMatrix4(n),t.morphAttributes.position.push(d)}parseNormals(t){const e=t.MappingInformationType,i=t.ReferenceInformationType,n=t.Normals.a;let s=[];return"IndexToDirect"===i&&("NormalIndex"in t?s=t.NormalIndex.a:"NormalsIndex"in t&&(s=t.NormalsIndex.a)),{dataSize:3,buffer:n,indices:s,mappingType:e,referenceType:i}}parseUVs(t){const e=t.MappingInformationType,i=t.ReferenceInformationType,n=t.UV.a;let s=[];return"IndexToDirect"===i&&(s=t.UVIndex.a),{dataSize:2,buffer:n,indices:s,mappingType:e,referenceType:i}}parseVertexColors(t){const e=t.MappingInformationType,i=t.ReferenceInformationType,n=t.Colors.a;let s=[];"IndexToDirect"===i&&(s=t.ColorIndex.a);for(let t=0,e=new Zi;t<n.length;t+=4)e.fromArray(n,t).convertSRGBToLinear().toArray(n,t);return{dataSize:4,buffer:n,indices:s,mappingType:e,referenceType:i}}parseMaterialIndices(t){const e=t.MappingInformationType,i=t.ReferenceInformationType;if("NoMappingInformation"===e)return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:i};const n=t.Materials.a,s=[];for(let t=0;t<n.length;++t)s.push(t);return{dataSize:1,buffer:n,indices:s,mappingType:e,referenceType:i}}parseNurbsGeometry(t){const e=parseInt(t.Order);if(isNaN(e))return new vn;const i=e-1,n=t.KnotVector.a,s=[],r=t.Points.a;for(let t=0,e=r.length;t<e;t+=4)s.push((new Ce).fromArray(r,t));let a,o;if("Closed"===t.Form)s.push(s[0]);else if("Periodic"===t.Form){a=i,o=n.length-1-a;for(let t=0;t<i;++t)s.push(s[t])}const h=new tw(i,n,s,a,o).getPoints(12*s.length);return(new vn).setFromPoints(h)}}class ow{parse(){const t=[],e=this.parseClips();if(void 0!==e)for(const i in e){const n=e[i],s=this.addClip(n);t.push(s)}return t}parseClips(){if(void 0===ew.Objects.AnimationCurve)return;const t=this.parseAnimationCurveNodes();this.parseAnimationCurves(t);const e=this.parseAnimationLayers(t);return this.parseAnimStacks(e)}parseAnimationCurveNodes(){const t=ew.Objects.AnimationCurveNode,e=new Map;for(const i in t){const n=t[i];if(null!==n.attrName.match(/S|R|T|DeformPercent/)){const t={id:n.id,attr:n.attrName,curves:{}};e.set(t.id,t)}}return e}parseAnimationCurves(t){const e=ew.Objects.AnimationCurve;for(const i in e){const n={id:e[i].id,times:e[i].KeyTime.a.map(pw),values:e[i].KeyValueFloat.a},s=iw.get(n.id);if(void 0!==s){const e=s.parents[0].ID,i=s.parents[0].relationship;i.match(/X/)?t.get(e).curves.x=n:i.match(/Y/)?t.get(e).curves.y=n:i.match(/Z/)?t.get(e).curves.z=n:i.match(/DeformPercent/)&&t.has(e)&&(t.get(e).curves.morph=n)}}}parseAnimationLayers(t){const e=ew.Objects.AnimationLayer,i=new Map;for(const n in e){const e=[],s=iw.get(parseInt(n));if(void 0!==s){s.children.forEach((function(i,n){if(t.has(i.ID)){const s=t.get(i.ID);if(void 0!==s.curves.x||void 0!==s.curves.y||void 0!==s.curves.z){if(void 0===e[n]){const t=iw.get(i.ID).parents.filter((function(t){return void 0!==t.relationship}))[0].ID;if(void 0!==t){const i=ew.Objects.Model[t.toString()];if(void 0===i)return;const s={modelName:i.attrName?iu.sanitizeNodeName(i.attrName):"",ID:i.id,initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1]};nw.traverse((function(t){t.ID===i.id&&(s.transform=t.matrix,t.userData.transformData&&(s.eulerOrder=t.userData.transformData.eulerOrder))})),s.transform||(s.transform=new ci),"PreRotation"in i&&(s.preRotation=i.PreRotation.value),"PostRotation"in i&&(s.postRotation=i.PostRotation.value),e[n]=s}}e[n]&&(e[n][s.attr]=s)}else if(void 0!==s.curves.morph){if(void 0===e[n]){const t=iw.get(i.ID).parents.filter((function(t){return void 0!==t.relationship}))[0].ID,s=iw.get(t).parents[0].ID,r=iw.get(s).parents[0].ID,a=iw.get(r).parents[0].ID,o=ew.Objects.Model[a],h={modelName:o.attrName?iu.sanitizeNodeName(o.attrName):"",morphName:ew.Objects.Deformer[t].attrName};e[n]=h}e[n][s.attr]=s}}})),i.set(parseInt(n),e)}}return i}parseAnimStacks(t){const e=ew.Objects.AnimationStack,i={};for(const n in e){const s=iw.get(parseInt(n)).children;s.length;const r=t.get(s[0].ID);i[n]={name:e[n].attrName,layer:r}}return i}addClip(t){let e=[];const i=this;return t.layer.forEach((function(t){e=e.concat(i.generateTracks(t))})),new hc(t.name,-1,e)}generateTracks(t){const e=[];let i=new Le,n=new Le;if(t.transform&&t.transform.decompose(i,new De,n),i=i.toArray(),n=n.toArray(),void 0!==t.T&&Object.keys(t.T.curves).length>0){const n=this.generateVectorTrack(t.modelName,t.T.curves,i,"position");void 0!==n&&e.push(n)}if(void 0!==t.R&&Object.keys(t.R.curves).length>0){const i=this.generateRotationTrack(t.modelName,t.R.curves,t.preRotation,t.postRotation,t.eulerOrder);void 0!==i&&e.push(i)}if(void 0!==t.S&&Object.keys(t.S.curves).length>0){const i=this.generateVectorTrack(t.modelName,t.S.curves,n,"scale");void 0!==i&&e.push(i)}if(void 0!==t.DeformPercent){const i=this.generateMorphTrack(t);void 0!==i&&e.push(i)}return e}generateVectorTrack(t,e,i,n){const s=this.getTimesForAllAxes(e),r=this.getKeyframeTrackValues(s,e,i);return new oc(t+"."+n,s,r)}generateRotationTrack(t,e,i,n,s){let r,a;if(void 0!==e.x&&void 0!==e.y&&void 0!==e.z){const t=this.interpolateRotations(e.x,e.y,e.z,s);r=t[0],a=t[1]}void 0!==i&&((i=i.map(ne.degToRad)).push(s),i=(new bi).fromArray(i),i=(new De).setFromEuler(i)),void 0!==n&&((n=n.map(ne.degToRad)).push(s),n=(new bi).fromArray(n),n=(new De).setFromEuler(n).invert());const o=new De,h=new bi,l=[];if(!a||!r)return new rc(t+".quaternion",[],[]);for(let t=0;t<a.length;t+=3){if(h.set(a[t],a[t+1],a[t+2],s),o.setFromEuler(h),void 0!==i&&o.premultiply(i),void 0!==n&&o.multiply(n),t>2){(new De).fromArray(l,(t-3)/3*4).dot(o)<0&&o.set(-o.x,-o.y,-o.z,-o.w)}o.toArray(l,t/3*4)}return new rc(t+".quaternion",r,l)}generateMorphTrack(t){const e=t.DeformPercent.curves.morph,i=e.values.map((function(t){return t/100})),n=nw.getObjectByName(t.modelName).morphTargetDictionary[t.morphName];return new nc(t.modelName+".morphTargetInfluences["+n+"]",e.times,i)}getTimesForAllAxes(t){let e=[];if(void 0!==t.x&&(e=e.concat(t.x.times)),void 0!==t.y&&(e=e.concat(t.y.times)),void 0!==t.z&&(e=e.concat(t.z.times)),e=e.sort((function(t,e){return t-e})),e.length>1){let t=1,i=e[0];for(let n=1;n<e.length;n++){const s=e[n];s!==i&&(e[t]=s,i=s,t++)}e=e.slice(0,t)}return e}getKeyframeTrackValues(t,e,i){const n=i,s=[];let r=-1,a=-1,o=-1;return t.forEach((function(t){if(e.x&&(r=e.x.times.indexOf(t)),e.y&&(a=e.y.times.indexOf(t)),e.z&&(o=e.z.times.indexOf(t)),-1!==r){const t=e.x.values[r];s.push(t),n[0]=t}else s.push(n[0]);if(-1!==a){const t=e.y.values[a];s.push(t),n[1]=t}else s.push(n[1]);if(-1!==o){const t=e.z.values[o];s.push(t),n[2]=t}else s.push(n[2])})),s}interpolateRotations(t,e,i,n){const s=[],r=[];s.push(t.times[0]),r.push(ne.degToRad(t.values[0])),r.push(ne.degToRad(e.values[0])),r.push(ne.degToRad(i.values[0]));for(let a=1;a<t.values.length;a++){const o=[t.values[a-1],e.values[a-1],i.values[a-1]];if(isNaN(o[0])||isNaN(o[1])||isNaN(o[2]))continue;const h=o.map(ne.degToRad),l=[t.values[a],e.values[a],i.values[a]];if(isNaN(l[0])||isNaN(l[1])||isNaN(l[2]))continue;const c=l.map(ne.degToRad),u=[l[0]-o[0],l[1]-o[1],l[2]-o[2]],d=[Math.abs(u[0]),Math.abs(u[1]),Math.abs(u[2])];if(d[0]>=180||d[1]>=180||d[2]>=180){const e=Math.max(...d)/180,i=new bi(...h,n),o=new bi(...c,n),l=(new De).setFromEuler(i),u=(new De).setFromEuler(o);l.dot(u)&&u.set(-u.x,-u.y,-u.z,-u.w);const p=t.times[a-1],m=t.times[a]-p,f=new De,g=new bi;for(let t=0;t<1;t+=1/e)f.copy(l.clone().slerp(u.clone(),t)),s.push(p+t*m),g.setFromQuaternion(f,n),r.push(g.x),r.push(g.y),r.push(g.z)}else s.push(t.times[a]),r.push(ne.degToRad(t.values[a])),r.push(ne.degToRad(e.values[a])),r.push(ne.degToRad(i.values[a]))}return[s,r]}}class hw{getPrevNode(){return this.nodeStack[this.currentIndent-2]}getCurrentNode(){return this.nodeStack[this.currentIndent-1]}getCurrentProp(){return this.currentProp}pushStack(t){this.nodeStack.push(t),this.currentIndent+=1}popStack(){this.nodeStack.pop(),this.currentIndent-=1}setCurrentProp(t,e){this.currentProp=t,this.currentPropName=e}parse(t){this.currentIndent=0,this.allNodes=new uw,this.nodeStack=[],this.currentProp=[],this.currentPropName="";const e=this,i=t.split(/[\r\n]+/);return i.forEach((function(t,n){const s=t.match(/^[\s\t]*;/),r=t.match(/^[\s\t]*$/);if(s||r)return;const a=t.match("^\\t{"+e.currentIndent+"}(\\w+):(.*){",""),o=t.match("^\\t{"+e.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),h=t.match("^\\t{"+(e.currentIndent-1)+"}}");a?e.parseNodeBegin(t,a):o?e.parseNodeProperty(t,o,i[++n]):h?e.popStack():t.match(/^[^\s\t}]/)&&e.parseNodePropertyContinued(t)})),this.allNodes}parseNodeBegin(t,e){const i=e[1].trim().replace(/^"/,"").replace(/"$/,""),n=e[2].split(",").map((function(t){return t.trim().replace(/^"/,"").replace(/"$/,"")})),s={name:i},r=this.parseNodeAttr(n),a=this.getCurrentNode();0===this.currentIndent?this.allNodes.add(i,s):i in a?("PoseNode"===i?a.PoseNode.push(s):void 0!==a[i].id&&(a[i]={},a[i][a[i].id]=a[i]),""!==r.id&&(a[i][r.id]=s)):"number"==typeof r.id?(a[i]={},a[i][r.id]=s):"Properties70"!==i&&(a[i]="PoseNode"===i?[s]:s),"number"==typeof r.id&&(s.id=r.id),""!==r.name&&(s.attrName=r.name),""!==r.type&&(s.attrType=r.type),this.pushStack(s)}parseNodeAttr(t){let e=t[0];""!==t[0]&&(e=parseInt(t[0]),isNaN(e)&&(e=t[0]));let i="",n="";return t.length>1&&(i=t[1].replace(/^(\w+)::/,""),n=t[2]),{id:e,name:i,type:n}}parseNodeProperty(t,e,i){let n=e[1].replace(/^"/,"").replace(/"$/,"").trim(),s=e[2].replace(/^"/,"").replace(/"$/,"").trim();"Content"===n&&","===s&&(s=i.replace(/"/g,"").replace(/,$/,"").trim());const r=this.getCurrentNode();if("Properties70"!==r.name){if("C"===n){const t=s.split(",").slice(1),e=parseInt(t[0]),i=parseInt(t[1]);let a=s.split(",").slice(3);a=a.map((function(t){return t.trim().replace(/^"/,"")})),n="connections",s=[e,i],function(t,e){for(let i=0,n=t.length,s=e.length;i<s;i++,n++)t[n]=e[i]}(s,a),void 0===r[n]&&(r[n]=[])}"Node"===n&&(r.id=s),n in r&&Array.isArray(r[n])?r[n].push(s):"a"!==n?r[n]=s:r.a=s,this.setCurrentProp(r,n),"a"===n&&","!==s.slice(-1)&&(r.a=bw(s))}else this.parseNodeSpecialProperty(t,n,s)}parseNodePropertyContinued(t){const e=this.getCurrentNode();e.a+=t,","!==t.slice(-1)&&(e.a=bw(e.a))}parseNodeSpecialProperty(t,e,i){const n=i.split('",').map((function(t){return t.trim().replace(/^\"/,"").replace(/\s/,"_")})),s=n[0],r=n[1],a=n[2],o=n[3];let h=n[4];switch(r){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":h=parseFloat(h);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":h=bw(h)}this.getPrevNode()[s]={type:r,type2:a,flag:o,value:h},this.setCurrentProp(this.getPrevNode(),s)}}class lw{parse(t){const e=new cw(t);e.skip(23);const i=e.getUint32();if(i<6400)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+i);const n=new uw;for(;!this.endOfContent(e);){const t=this.parseNode(e,i);null!==t&&n.add(t.name,t)}return n}endOfContent(t){return t.size()%16==0?(t.getOffset()+160+16&-16)>=t.size():t.getOffset()+160+16>=t.size()}parseNode(t,e){const i={},n=e>=7500?t.getUint64():t.getUint32(),s=e>=7500?t.getUint64():t.getUint32();e>=7500?t.getUint64():t.getUint32();const r=t.getUint8(),a=t.getString(r);if(0===n)return null;const o=[];for(let e=0;e<s;e++)o.push(this.parseProperty(t));const h=o.length>0?o[0]:"",l=o.length>1?o[1]:"",c=o.length>2?o[2]:"";for(i.singleProperty=1===s&&t.getOffset()===n;n>t.getOffset();){const n=this.parseNode(t,e);null!==n&&this.parseSubNode(a,i,n)}return i.propertyList=o,"number"==typeof h&&(i.id=h),""!==l&&(i.attrName=l),""!==c&&(i.attrType=c),""!==a&&(i.name=a),i}parseSubNode(t,e,i){if(!0===i.singleProperty){const t=i.propertyList[0];Array.isArray(t)?(e[i.name]=i,i.a=t):e[i.name]=t}else if("Connections"===t&&"C"===i.name){const t=[];i.propertyList.forEach((function(e,i){0!==i&&t.push(e)})),void 0===e.connections&&(e.connections=[]),e.connections.push(t)}else if("Properties70"===i.name){Object.keys(i).forEach((function(t){e[t]=i[t]}))}else if("Properties70"===t&&"P"===i.name){let t=i.propertyList[0],n=i.propertyList[1];const s=i.propertyList[2],r=i.propertyList[3];let a;0===t.indexOf("Lcl ")&&(t=t.replace("Lcl ","Lcl_")),0===n.indexOf("Lcl ")&&(n=n.replace("Lcl ","Lcl_")),a="Color"===n||"ColorRGB"===n||"Vector"===n||"Vector3D"===n||0===n.indexOf("Lcl_")?[i.propertyList[4],i.propertyList[5],i.propertyList[6]]:i.propertyList[4],e[t]={type:n,type2:s,flag:r,value:a}}else void 0===e[i.name]?"number"==typeof i.id?(e[i.name]={},e[i.name][i.id]=i):e[i.name]=i:"PoseNode"===i.name?(Array.isArray(e[i.name])||(e[i.name]=[e[i.name]]),e[i.name].push(i)):void 0===e[i.name][i.id]&&(e[i.name][i.id]=i)}parseProperty(t){const e=t.getString(1);let i;switch(e){case"C":return t.getBoolean();case"D":return t.getFloat64();case"F":return t.getFloat32();case"I":return t.getInt32();case"L":return t.getInt64();case"R":return i=t.getUint32(),t.getArrayBuffer(i);case"S":return i=t.getUint32(),t.getString(i);case"Y":return t.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":const n=t.getUint32(),s=t.getUint32(),r=t.getUint32();if(0===s)switch(e){case"b":case"c":return t.getBooleanArray(n);case"d":return t.getFloat64Array(n);case"f":return t.getFloat32Array(n);case"i":return t.getInt32Array(n);case"l":return t.getInt64Array(n)}const a=Y_(new Uint8Array(t.getArrayBuffer(r))),o=new cw(a.buffer);switch(e){case"b":case"c":return o.getBooleanArray(n);case"d":return o.getFloat64Array(n);case"f":return o.getFloat32Array(n);case"i":return o.getInt32Array(n);case"l":return o.getInt64Array(n)}break;default:throw new Error("THREE.FBXLoader: Unknown property type "+e)}}}class cw{constructor(t,e){this.dv=new DataView(t),this.offset=0,this.littleEndian=void 0===e||e,this._textDecoder=new TextDecoder}getOffset(){return this.offset}size(){return this.dv.buffer.byteLength}skip(t){this.offset+=t}getBoolean(){return 1==(1&this.getUint8())}getBooleanArray(t){const e=[];for(let i=0;i<t;i++)e.push(this.getBoolean());return e}getUint8(){const t=this.dv.getUint8(this.offset);return this.offset+=1,t}getInt16(){const t=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,t}getInt32(){const t=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,t}getInt32Array(t){const e=[];for(let i=0;i<t;i++)e.push(this.getInt32());return e}getUint32(){const t=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,t}getInt64(){let t,e;return this.littleEndian?(t=this.getUint32(),e=this.getUint32()):(e=this.getUint32(),t=this.getUint32()),2147483648&e?(e=4294967295&~e,t=4294967295&~t,4294967295===t&&(e=e+1&4294967295),t=t+1&4294967295,-(4294967296*e+t)):4294967296*e+t}getInt64Array(t){const e=[];for(let i=0;i<t;i++)e.push(this.getInt64());return e}getUint64(){let t,e;return this.littleEndian?(t=this.getUint32(),e=this.getUint32()):(e=this.getUint32(),t=this.getUint32()),4294967296*e+t}getFloat32(){const t=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,t}getFloat32Array(t){const e=[];for(let i=0;i<t;i++)e.push(this.getFloat32());return e}getFloat64(){const t=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,t}getFloat64Array(t){const e=[];for(let i=0;i<t;i++)e.push(this.getFloat64());return e}getArrayBuffer(t){const e=this.dv.buffer.slice(this.offset,this.offset+t);return this.offset+=t,e}getString(t){const e=this.offset;let i=new Uint8Array(this.dv.buffer,e,t);this.skip(t);const n=i.indexOf(0);return n>=0&&(i=new Uint8Array(this.dv.buffer,e,n)),this._textDecoder.decode(i)}}class uw{add(t,e){this[t]=e}}function dw(t){const e=t.match(/FBXVersion: (\d+)/);if(e){return parseInt(e[1])}throw new Error("THREE.FBXLoader: Cannot find the version number for the file given.")}function pw(t){return t/46186158e3}const mw=[];function fw(t,e,i,n){let s;switch(n.mappingType){case"ByPolygonVertex":s=t;break;case"ByPolygon":s=e;break;case"ByVertice":s=i;break;case"AllSame":s=n.indices[0]}"IndexToDirect"===n.referenceType&&(s=n.indices[s]);const r=s*n.dataSize,a=r+n.dataSize;return function(t,e,i,n){for(let s=i,r=0;s<n;s++,r++)t[r]=e[s];return t}(mw,n.buffer,r,a)}const gw=new bi,vw=new Le;function yw(t){const e=new ci,i=new ci,n=new ci,s=new ci,r=new ci,a=new ci,o=new ci,h=new ci,l=new ci,c=new ci,u=new ci,d=new ci,p=t.inheritType?t.inheritType:0;if(t.translation&&e.setPosition(vw.fromArray(t.translation)),t.preRotation){const e=t.preRotation.map(ne.degToRad);e.push(t.eulerOrder||bi.DEFAULT_ORDER),i.makeRotationFromEuler(gw.fromArray(e))}if(t.rotation){const e=t.rotation.map(ne.degToRad);e.push(t.eulerOrder||bi.DEFAULT_ORDER),n.makeRotationFromEuler(gw.fromArray(e))}if(t.postRotation){const e=t.postRotation.map(ne.degToRad);e.push(t.eulerOrder||bi.DEFAULT_ORDER),s.makeRotationFromEuler(gw.fromArray(e)),s.invert()}t.scale&&r.scale(vw.fromArray(t.scale)),t.scalingOffset&&o.setPosition(vw.fromArray(t.scalingOffset)),t.scalingPivot&&a.setPosition(vw.fromArray(t.scalingPivot)),t.rotationOffset&&h.setPosition(vw.fromArray(t.rotationOffset)),t.rotationPivot&&l.setPosition(vw.fromArray(t.rotationPivot)),t.parentMatrixWorld&&(u.copy(t.parentMatrix),c.copy(t.parentMatrixWorld));const m=i.clone().multiply(n).multiply(s),f=new ci;f.extractRotation(c);const g=new ci;g.copyPosition(c);const v=g.clone().invert().multiply(c),y=f.clone().invert().multiply(v),x=r,b=new ci;if(0===p)b.copy(f).multiply(m).multiply(y).multiply(x);else if(1===p)b.copy(f).multiply(y).multiply(m).multiply(x);else{const t=(new ci).scale((new Le).setFromMatrixScale(u)).clone().invert(),e=y.clone().multiply(t);b.copy(f).multiply(m).multiply(e).multiply(x)}const _=l.clone().invert(),w=a.clone().invert();let M=e.clone().multiply(h).multiply(l).multiply(i).multiply(n).multiply(s).multiply(_).multiply(o).multiply(a).multiply(r).multiply(w);const S=(new ci).copyPosition(M),E=c.clone().multiply(S);return d.copyPosition(E),M=d.clone().multiply(b),M.premultiply(c.invert()),M}function xw(t){const e=["ZYX","YZX","XZY","ZXY","YXZ","XYZ"];return 6===(t=t||0)?e[0]:e[t]}function bw(t){return t.split(",").map((function(t){return parseFloat(t)}))}function _w(t,e,i){return void 0===e&&(e=0),void 0===i&&(i=t.byteLength),(new TextDecoder).decode(new Uint8Array(t,e,i))}class ww extends ku{get Id(){return Cu.DeadTree}constructor(t){super(t,Iu.Gltf,"assets/custom_island/tree2.glb",(t=>{this.meshs=t.scene,this.meshs.castShadow=!1,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!1,t.receiveShadow=!0}))}))}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),this.size)return this.size;const e=(new Be).setFromObject(t);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.z=Math.ceil(this.size.z),this.size}GetBodyMeshId(){return"mixamorigRightHand"}}var Mw=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class Sw extends ku{get Id(){return Cu.Male}constructor(t){super(t,Iu.Gltf,"assets/male/male.gltf",(t=>Mw(this,void 0,void 0,(function*(){this.gltf=t,this.meshs=t.scene,this.meshs.castShadow=!0,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!1,t.isMesh&&(t.material=new Fl({map:t.material.map}))})),this.meshs.children[0].position.y=0,this.clips.set(Au.Idle,t.animations[0]),this.clips.set(Au.Run,t.animations[1]),this.clips.set(Au.Jump,t.animations[2]),this.clips.set(Au.Punch,t.animations[3]),this.clips.set(Au.FightIdle,t.animations[4]),this.clips.set(Au.Dance0,t.animations[5]),yield this.LoadAnimation("assets/male/Shooting.fbx",Au.Shooting),yield this.LoadAnimation("assets/male/Standing 1H Magic Attack 01.fbx",Au.MagicH1),yield this.LoadAnimation("assets/male/Standing 2H Magic Attack 01.fbx",Au.MagicH2),yield this.LoadAnimation("assets/male/Standing 2H Magic Attack 01_.fbx",Au.MagicH2),yield this.LoadAnimation("assets/male/Sword And Shield Slash.fbx",Au.Sword),yield this.LoadAnimation("assets/male/Gunplay.fbx",Au.Shooting),yield this.LoadAnimation("assets/male/Dying Backwards.fbx",Au.Dying),yield this.LoadAnimation("assets/male/Bouncing Fight Idle.fbx",Au.FightIdle),yield this.LoadAnimation("assets/female/PlantAPlant.fbx",Au.PlantAPlant),yield this.LoadAnimation("assets/female/PickFruit.fbx",Au.PickFruit),yield this.LoadAnimation("assets/female/PickFruit_tree.fbx",Au.PickFruitTree),yield this.LoadAnimation("assets/female/StandingMeleeAttackDownward.fbx",Au.Hammering),yield this.LoadAnimation("assets/female/Watering.fbx",Au.Wartering)}))))}CreateVectorGui(t,e,i,n){t.add(e,"x",-100,100,n).listen().name(i+"X"),t.add(e,"y",-100,100,n).listen().name(i+"Y"),t.add(e,"z",-100,100,n).listen().name(i+"Z")}GetBodyMeshId(t){switch(t){case Tu.Hands_R:return"mixamorigRightHand";case Tu.Hands_L:return"mixamorigLeftHand"}}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),null!=this.size)return this.size;const e=(new Be).setFromObject(this.meshs.children[0]);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.z=Math.ceil(this.size.z),this.size.y*=4,this.size}}var Ew=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class Tw extends ku{get Id(){return Cu.Female}constructor(t){super(t,Iu.Gltf,"assets/female/female2.gltf",(t=>Ew(this,void 0,void 0,(function*(){this.Gltf=t,this.meshs=t.scene,this.meshs.castShadow=!0,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!1,t.isMesh&&(t.material=new Fl({map:t.material.map}))})),this.mixer=new ru(t.scene),this.clips.set(Au.Idle,t.animations.find((t=>"Idle"==t.name))),this.clips.set(Au.Run,t.animations.find((t=>"Running"==t.name))),this.clips.set(Au.Jump,t.animations.find((t=>"JumpingUp"==t.name))),this.clips.set(Au.Punch,t.animations.find((t=>"PunchCombo"==t.name))),this.clips.set(Au.FightIdle,t.animations.find((t=>"BouncingFightIdle"==t.name))),this.clips.set(Au.Dying,t.animations.find((t=>"Dying"==t.name))),this.clips.set(Au.Sword,t.animations.find((t=>"Sword"==t.name))),this.clips.set(Au.Shooting,t.animations.find((t=>"Gunplay"==t.name))),this.clips.set(Au.MagicH1,t.animations.find((t=>"1HMagic"==t.name))),this.clips.set(Au.MagicH2,t.animations.find((t=>"2HMagic_1"==t.name))),this.clips.set(Au.PickFruit,t.animations.find((t=>"PickFruit"==t.name))),this.clips.set(Au.PickFruitTree,t.animations.find((t=>"PickFruit_tree"==t.name))),this.clips.set(Au.PlantAPlant,t.animations.find((t=>"PlantAPlant"==t.name))),this.clips.set(Au.Hammering,t.animations.find((t=>"StandingMeleeAttackDownward"==t.name))),this.clips.set(Au.Wartering,t.animations.find((t=>"Watering"==t.name))),this.meshs.children[0].children[0].position.y=0}))))}CreateVectorGui(t,e,i,n){t.add(e,"x",-100,100,n).listen().name(i+"X"),t.add(e,"y",-100,100,n).listen().name(i+"Y"),t.add(e,"z",-100,100,n).listen().name(i+"Z")}GetBodyMeshId(t){switch(t){case Tu.Hands_R:return"mixamorigRightHand";case Tu.Hands_L:return"mixamorigLeftHand"}}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),this.size)return this.size;const e=(new Be).setFromObject(this.meshs.children[0]);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.z=Math.ceil(this.size.z),this.size.x/=3,this.size.z/=3,this.size}}class Aw extends ku{get Id(){return this.id}constructor(t,e){super(t,Iu.Gltf,"assets/custom_island/mushroom"+e+".glb",(t=>{this.meshs=t.scene,this.meshs.castShadow=!0,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!0}))})),this.id=Cu.Mushroom1,this.id=1==e?Cu.Mushroom1:Cu.Mushroom2}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),this.size)return this.size;const e=(new Be).setFromObject(t);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.z=Math.ceil(this.size.z),this.size}GetBodyMeshId(){return"mixamorigRightHand"}}class Cw extends ku{get Id(){return Cu.Tree}constructor(t){super(t,Iu.Gltf,"assets/custom_island/tree.glb",(t=>{this.meshs=t.scene,this.meshs.castShadow=!0,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!0}))}))}GetBodyMeshId(){return""}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),this.size)return this.size;const e=(new Be).setFromObject(t);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.z=Math.ceil(this.size.z),this.size}GetBoxPos(t){const e=t.position,i=this.GetSize(t);return new Le(e.x,e.y+i.y/2,e.z)}}class Iw extends ku{get Id(){return Cu.Tree}constructor(t){super(t,Iu.Gltf,"assets/plant/dead_tree.glb",(t=>{this.meshs=t.scene,this.meshs.castShadow=!0,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!0}));const e=.005;this.meshs.scale.set(e,e,e)}))}GetBodyMeshId(){return""}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),this.size)return this.size;const e=(new Be).setFromObject(t);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.z=Math.ceil(this.size.z),this.size}GetBoxPos(t){const e=t.position,i=this.GetSize(t);return new Le(e.x,e.y+i.y/2,e.z)}}class Rw extends ku{get Id(){return Cu.Portal}constructor(t){super(t,Iu.Gltf,"assets/custom_island/sand_portal.glb",(t=>{this.meshs=t.scene,this.meshs.scale.set(2.5,2.5,2.5),this.meshs.castShadow=!0,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!0})),this.meshs.children[0].position.y+=.8}))}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),this.size)return this.size;const e=(new Be).setFromObject(t);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.z=Math.ceil(this.size.z),this.size}GetBodyMeshId(){return"mixamorigRightHand"}}var kw=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class Pw extends ku{get Id(){return Cu.Female}constructor(t){super(t,Iu.Fbx,"assets/test/Animated.fbx",(t=>kw(this,void 0,void 0,(function*(){this.meshs=t,this.meshs.castShadow=!0,this.meshs.receiveShadow=!0;const e=new yc,i=yield e.loadAsync("assets/test/textures/F00_000_00_EyeIris_00.png"),n=yield e.loadAsync("assets/test/textures/F00_000_00_EyeWhite_00.png"),s=yield e.loadAsync("assets/test/textures/F00_000_00_Face_00-1.png"),r=yield e.loadAsync("assets/test/textures/F00_000_00_FaceMouth_00.png"),a=yield e.loadAsync("assets/test/textures/F00_000_Hair_00.png"),o=yield e.loadAsync("assets/test/textures/F00_000_HairBack_00.png"),h=yield e.loadAsync("assets/test/textures/F00_001_01_Accessory_Tie_01.png"),l=yield e.loadAsync("assets/test/textures/F00_001_01_Body_00.png"),c=yield e.loadAsync("assets/test/textures/F00_001_01_Bottoms_01.png"),u=yield e.loadAsync("assets/test/textures/F00_001_01_Shoes_01.png"),d=yield e.loadAsync("assets/test/textures/F00_001_01_Tops_01.png");this.meshs.traverse((t=>{if(t.castShadow=!0,t.receiveShadow=!0,t instanceof On){(Array.isArray(t.material)?t.material:[t.material]).forEach((t=>{switch(t.name){case"F00_000_00_FaceMouth_00_FACE":t.map=r,t.needsupdate=!0;break;case"F00_000_00_EyeWhite_00_EYE":case"F00_000_00_EyeExtra_01_EYE":case"F00_000_00_EyeHighlight_00_EYE":t.map=n,t.needsupdate=!0;break;case"F00_000_00_FaceEyeline_00_FACE":case"F00_000_00_Face_00_SKIN":case"F00_000_00_FaceEyelash_00_FACE":case"F00_000_00_FaceBrow_00_FACE":t.map=s,t.needsupdate=!0;break;case"F00_000_00_EyeIris_00_EYE":t.map=i,t.needsupdate=!0;break;case"F00_001_01_Body_00_SKIN":t.map=l,t.needsupdate=!0;break;case"F00_001_01_Tops_01_CLOTH":t.map=d,t.needsupdate=!0;break;case"F00_001_01_Bottoms_01_CLOTH":t.map=c,t.needsupdate=!0;break;case"F00_001_01_Accessory_Tie_01_CLOTH":t.map=h,t.needsupdate=!0;break;case"F00_001_01_Shoes_01_CLOTH":t.map=u,t.needsupdate=!0;break;case"F00_000_HairBack_00_HAIR":t.map=o,t.needsupdate=!0;break;case"F00_000_Hair_00_HAIR":t.map=a,t.needsupdate=!0}}))}}));this.meshs.scale.set(2.7,2.7,2.7),this.mixer=new ru(t),yield this.LoadAnimation("assets/test/Idle.fbx",Au.Idle),yield this.LoadAnimation("assets/highgirl/Running.fbx",Au.Run),yield this.LoadAnimation("assets/highgirl/Jumping Up.fbx",Au.Jump),yield this.LoadAnimation("assets/highgirl/Punch Combo.fbx",Au.Punch),yield this.LoadAnimation("assets/highgirl/Fighting Idle.fbx",Au.FightIdle),yield this.LoadAnimation("assets/highgirl/Shooting.fbx",Au.Shooting),yield this.LoadAnimation("assets/highgirl/Sword And Shield Slash.fbx",Au.Sword)}))))}GetBodyMeshId(t){return""}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),null!=this.size)return this.size;const e=(new Be).setFromObject(this.meshs.children[0]);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.z=Math.ceil(this.size.z),this.size.y*=4,this.size}}var Dw=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class Lw extends ku{get Id(){return Cu.Zombie}constructor(t){super(t,Iu.Gltf,"assets/monster/zombie.gltf",(t=>Dw(this,void 0,void 0,(function*(){this.Gltf=t,this.meshs=t.scene,this.meshs.name="zombie",this.meshs.castShadow=!0,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!1,t.isMesh&&(t.material=new Fl({map:t.material.map}))}));const e=.024;this.meshs.children[0].scale.set(e,e,e),this.meshs.children[0].position.set(0,0,0),this.mixer=new ru(t.scene),this.clips.set(Au.Idle,t.animations.find((t=>"ZombieIdle"==t.name))),this.clips.set(Au.Run,t.animations.find((t=>"Walking"==t.name))),this.clips.set(Au.Punch,t.animations.find((t=>"ZombieAttack"==t.name))),this.clips.set(Au.MonBiting,t.animations.find((t=>"ZombieBiting"==t.name))),this.clips.set(Au.Dying,t.animations.find((t=>"ZombieDying"==t.name))),this.clips.set(Au.MonScream,t.animations.find((t=>"ZombieScream"==t.name)))}))))}GetBodyMeshId(){return"mixamorigRightHand"}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.set(e.x,e.y,e.z),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),this.size)return this.size;const e=(new Be).setFromObject(this.meshs.children[0]);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.y*=1.1,this.size.z=Math.ceil(this.size.z),this.size}}var Ow=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class Nw extends ku{get Id(){return Cu.Bat}constructor(t){super(t,Iu.Gltf,"assets/weapon/bat.glb",(t=>Ow(this,void 0,void 0,(function*(){this.gltf=t,this.meshs=t.scene,this.meshs.castShadow=!0;this.meshs.scale.set(.3,.3,.3),this.meshs.position.set(.1,.2,-.1),this.meshs.rotation.set(3,-.5,-1.8)}))))}GetBodyMeshId(){return"mixamorigRightHand"}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),null!=this.size)return this.size;const e=(new Be).setFromObject(this.meshs);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.z=Math.ceil(this.size.z),this.size}}var Bw=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class zw extends ku{get Id(){return Cu.Male}constructor(t){super(t,Iu.Gltf,"assets/weapon/gun.glb",(t=>Bw(this,void 0,void 0,(function*(){this.gltf=t,this.meshs=t.scene,this.meshs.castShadow=!0;const e=.05;this.meshs.scale.set(e,e,e),this.meshs.position.set(.2,.8,.2),this.meshs.rotation.set(3.5,-.1,-1.6)}))))}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),null!=this.size)return this.size;const e=(new Be).setFromObject(this.meshs);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.z=Math.ceil(this.size.z),this.size}GetBodyMeshId(){return"mixamorigRightHand"}}var Uw=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class Fw extends ku{get Id(){return Cu.Minataur}constructor(t){super(t,Iu.Gltf,"assets/monster/minataur_low_poly.glb",(t=>Uw(this,void 0,void 0,(function*(){this.Gltf=t,this.meshs=t.scene,this.meshs.castShadow=!0,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!0}));const e=.02;this.meshs.children[0].scale.set(e,e,e),this.meshs.children[0].position.z-=1.5,this.mixer=new ru(t.scene),this.clips.set(Au.Idle,t.animations.find((t=>"Armature|idle"==t.name))),this.clips.set(Au.Run,t.animations.find((t=>"Armature|Walk"==t.name))),this.clips.set(Au.Punch,t.animations.find((t=>"Armature|Attack"==t.name))),this.clips.set(Au.MonBiting,t.animations.find((t=>"Armature|Attack Double"==t.name))),this.clips.set(Au.Dying,t.animations.find((t=>"Armature|Death"==t.name))),this.clips.set(Au.MonScream,t.animations.find((t=>"Armature|Jump"==t.name)))}))))}GetBodyMeshId(){return"mixamorigRightHand"}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.set(e.x,e.y,e.z),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),this.size)return this.size;const e=(new Be).setFromObject(this.meshs.children[0]);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x)/2,this.size.y=Math.ceil(this.size.y)/2,this.size.z=Math.ceil(this.size.z)/2,this.size}}var Gw=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class Vw extends ku{get Id(){return Cu.CrabMon}constructor(t){super(t,Iu.Gltf,"assets/monster/crab_monster_animated.glb",(t=>Gw(this,void 0,void 0,(function*(){this.Gltf=t,this.meshs=t.scene,this.meshs.castShadow=!0,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!0}));this.meshs.scale.set(1,1,1),this.mixer=new ru(t.scene),this.clips.set(Au.Idle,t.animations.find((t=>"idle"==t.name))),this.clips.set(Au.Run,t.animations.find((t=>"walk"==t.name))),this.clips.set(Au.Punch,t.animations.find((t=>"attack"==t.name))),this.clips.set(Au.Dying,t.animations.find((t=>"death"==t.name))),this.clips.set(Au.MonHurt,t.animations.find((t=>"hurt"==t.name)))}))))}GetBodyMeshId(){return"mixamorigRightHand"}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.set(e.x,e.y,e.z),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),this.size)return this.size;const e=(new Be).setFromObject(this.meshs.children[0]);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.y=3.5,this.size.z=Math.ceil(this.size.z),this.size}}class Hw extends ku{get Id(){return this.id}constructor(t){super(t,Iu.Gltf,"assets/rocks/stylized_lowpoly_rock.glb",(t=>{this.meshs=t.scene,this.meshs.castShadow=!0,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!0}))})),this.id=Cu.Stone}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),this.size)return this.size;const e=(new Be).setFromObject(t);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x-2),this.size.y=Math.ceil(this.size.y-3),this.size.z=Math.ceil(this.size.z-1),this.size}GetBodyMeshId(){return"mixamorigRightHand"}}var jw=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class Ww extends ku{get Id(){return Cu.WarteringCan}constructor(t){super(t,Iu.Gltf,"assets/stub/watering_can.glb",(t=>jw(this,void 0,void 0,(function*(){this.gltf=t,this.meshs=t.scene,this.meshs.castShadow=!0;this.meshs.scale.set(35,35,35),this.meshs.position.set(-.1,1.3,-.1),this.meshs.rotation.set(0,5.1,3.1)}))))}GetBodyMeshId(){return"mixamorigRightHand"}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),null!=this.size)return this.size;const e=(new Be).setFromObject(this.meshs);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.z=Math.ceil(this.size.z),this.size}}class Xw extends ku{get Id(){return Cu.Hammer}constructor(t){super(t,Iu.Gltf,"assets/weapon/hammer.glb",(t=>jw(this,void 0,void 0,(function*(){this.gltf=t,this.meshs=t.scene,this.meshs.castShadow=!0;this.meshs.scale.set(1,1,1),this.meshs.position.set(0,0,0),this.meshs.rotation.set(0,0,0)}))))}GetBodyMeshId(){return"mixamorigRightHand"}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),new Bl)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),null!=this.size)return this.size;const e=(new Be).setFromObject(this.meshs);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.z=Math.ceil(this.size.z),this.size}}class qw extends ku{get Id(){return this.id}constructor(t){super(t,Iu.Gltf,"assets/furniture/closet.glb",(t=>{this.meshs=new Da,this.meshs.add(t.scene),this.meshs.castShadow=!0,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!0}));this.meshs.children[0].rotateY(Math.PI),this.meshs.children[0].scale.set(.8-.1,.8-.1,.8)})),this.id=Cu.Closet}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),this.size)return this.size;const e=(new Be).setFromObject(t);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.y=Math.ceil(this.size.y)-.5,this.size.z=Math.ceil(this.size.z)-1,this.size}GetBodyMeshId(){return"mixamorigRightHand"}}class Yw extends ku{get Id(){return this.id}constructor(t){super(t,Iu.Gltf,"assets/furniture/desk.glb",(t=>{this.meshs=new Da,this.meshs.add(t.scene),this.meshs.castShadow=!0,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!0}));this.meshs.children[0].rotateY(Math.PI),this.meshs.children[0].scale.set(.8,.8,.8)})),this.id=Cu.Desk}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),this.size)return this.size;const e=(new Be).setFromObject(t);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x)-1.5,this.size.y=Math.ceil(this.size.y),this.size.z=Math.ceil(this.size.z),this.size}GetBodyMeshId(){return"mixamorigRightHand"}}class Jw extends ku{get Id(){return this.id}constructor(t){super(t,Iu.Gltf,"assets/furniture/bed.glb",(t=>{this.meshs=new Da,this.meshs.add(t.scene),this.meshs.castShadow=!0,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!0}));this.meshs.children[0].rotateY(Math.PI),this.meshs.children[0].scale.set(.96,.8,.8)})),this.id=Cu.Bed}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),this.size)return this.size;const e=(new Be).setFromObject(t);return this.size=e.getSize(new Le),this.size.x=4,this.size.y=Math.ceil(this.size.y),this.size.z=Math.ceil(this.size.z),this.size}GetBodyMeshId(){return"mixamorigRightHand"}}var $w=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class Kw extends ku{get Id(){return Cu.AppleTree}constructor(t){super(t,Iu.Gltf,"assets/plant/low-ploy_tree.glb",(t=>$w(this,void 0,void 0,(function*(){this.gltf=t,this.meshs=t.scene,this.meshs.castShadow=!0;this.meshs.scale.set(1,1,1),this.meshs.position.set(0,0,0),this.meshs.rotateY(-Math.PI/2)}))))}GetBodyMeshId(){return"mixamorigRightHand"}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),null!=this.size)return this.size;const e=(new Be).setFromObject(this.meshs.children[0]);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.z=Math.ceil(this.size.z),this.size}}class Zw extends ku{get Id(){return Cu.CoconutTree}constructor(t){super(t,Iu.Gltf,"assets/plant/coconut_tree.glb",(t=>$w(this,void 0,void 0,(function*(){this.gltf=t,this.meshs=t.scene,this.meshs.castShadow=!0;this.meshs.scale.set(1.2,1.2,1.2),this.meshs.position.set(0,0,0),this.meshs.rotation.set(0,0,0)}))))}GetBodyMeshId(){return"mixamorigRightHand"}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),null!=this.size)return this.size;const e=(new Be).setFromObject(this.meshs.children[0]);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.z=Math.ceil(this.size.z),this.size}}var Qw=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class tM extends ku{get Id(){return Cu.BatPig}constructor(t){super(t,Iu.Gltf,"assets/monster/bat_pig.glb",(t=>Qw(this,void 0,void 0,(function*(){this.Gltf=t,this.meshs=t.scene,this.meshs.castShadow=!0,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!0}));const e=.01;this.meshs.children[0].scale.set(e,e,e),this.mixer=new ru(t.scene),this.clips.set(Au.Idle,t.animations.find((t=>"Armature|Idle"==t.name))),this.clips.set(Au.Run,t.animations.find((t=>"Armature|Walk"==t.name))),this.clips.set(Au.Punch,t.animations.find((t=>"Armature|Desh"==t.name))),this.clips.set(Au.MonBiting,t.animations.find((t=>"Armature|Shoot"==t.name))),this.clips.set(Au.MonScream,t.animations.find((t=>"Pig Enemy|Desh"==t.name))),this.meshs.children[0].position.y=1}))))}GetBodyMeshId(){return"mixamorigRightHand"}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.set(e.x,e.y,e.z),(new Be).setFromObject(this.box)}GetSize(t){return null==this.meshs&&(this.meshs=t),this.size||(this.size=new Le(4,3,2)),this.size}}var eM=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class iM extends ku{get Id(){return Cu.BirdMon}constructor(t){super(t,Iu.Gltf,"assets/monster/bird_monster_animated.glb",(t=>eM(this,void 0,void 0,(function*(){this.Gltf=t,this.meshs=t.scene,this.meshs.castShadow=!0,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!0}));this.meshs.scale.set(1,1,1),this.meshs.children[0].rotateZ(Math.PI),this.mixer=new ru(t.scene),this.clips.set(Au.Idle,t.animations.find((t=>"idle"==t.name))),this.clips.set(Au.Run,t.animations.find((t=>"run"==t.name))),this.clips.set(Au.Punch,t.animations.find((t=>"attack"==t.name))),this.clips.set(Au.Dying,t.animations.find((t=>"death"==t.name)))}))))}GetBodyMeshId(){return"mixamorigRightHand"}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.set(e.x,e.y,e.z),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),this.size)return this.size;const e=(new Be).setFromObject(this.meshs.children[0]);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.y=2.5*Math.ceil(this.size.y),this.size.z=Math.ceil(this.size.z),this.size}}var nM=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class sM extends ku{get Id(){return Cu.Bilby}constructor(t){super(t,Iu.Gltf,"assets/monster/bilby_animated.glb",(t=>nM(this,void 0,void 0,(function*(){this.Gltf=t,this.meshs=t.scene,this.meshs.castShadow=!0,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!0}));this.meshs.scale.set(2,2,2),this.mixer=new ru(t.scene),this.clips.set(Au.Idle,t.animations.find((t=>"Bilby_idleSit"==t.name))),this.clips.set(Au.Run,t.animations.find((t=>"Bilby_run"==t.name))),this.clips.set(Au.Punch,t.animations.find((t=>"Bilby_atk1_bite"==t.name))),this.clips.set(Au.MonBiting,t.animations.find((t=>"Bilby_atk2_tail"==t.name))),this.clips.set(Au.Jump,t.animations.find((t=>"Bilby_jump"==t.name))),this.clips.set(Au.MonScream,t.animations.find((t=>"Bilby_smell"==t.name)))}))))}GetBodyMeshId(){return"mixamorigRightHand"}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.set(e.x,e.y,e.z),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),this.size)return this.size;const e=(new Be).setFromObject(this.meshs.children[0]);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.y=1,this.size.z=Math.ceil(this.size.z),this.size}}var rM=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class aM extends ku{get Id(){return Cu.WereWolf}constructor(t){super(t,Iu.Gltf,"assets/monster/werewolf.glb",(t=>rM(this,void 0,void 0,(function*(){this.Gltf=t,this.meshs=t.scene,this.meshs.castShadow=!0,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!0}));this.meshs.scale.set(1,1,1),this.mixer=new ru(t.scene),this.clips.set(Au.Idle,t.animations.find((t=>"Idle"==t.name))),this.clips.set(Au.Run,t.animations.find((t=>"Run"==t.name))),this.clips.set(Au.Punch,t.animations.find((t=>"Attack"==t.name)))}))))}GetBodyMeshId(){return"mixamorigRightHand"}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.set(e.x,e.y,e.z),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),this.size)return this.size;const e=(new Be).setFromObject(this.meshs.children[0]);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.z=Math.ceil(this.size.z),this.size}}var oM=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class hM extends ku{get Id(){return Cu.Golem}constructor(t){super(t,Iu.Gltf,"assets/monster/golem.glb",(t=>oM(this,void 0,void 0,(function*(){this.Gltf=t,this.meshs=t.scene,this.meshs.castShadow=!0,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!0}));this.meshs.children[0].scale.set(.4,.4,.4),this.mixer=new ru(t.scene),this.clips.set(Au.Idle,t.animations.find((t=>"root|Idle"==t.name))),this.clips.set(Au.Run,t.animations.find((t=>"root|Walk"==t.name))),this.clips.set(Au.Punch,t.animations.find((t=>"root|Attack"==t.name))),this.clips.set(Au.Dying,t.animations.find((t=>"root|Death_2"==t.name))),this.clips.set(Au.MonHurt,t.animations.find((t=>"root|Damage"==t.name)))}))))}GetBodyMeshId(){return"mixamorigRightHand"}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.set(e.x,e.y,e.z),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),this.size)return this.size;const e=(new Be).setFromObject(this.meshs.children[0]);return this.size=e.getSize(new Le),this.size.x=3*Math.ceil(this.size.x),this.size.y=5*Math.ceil(this.size.y),this.size.z=2*Math.ceil(this.size.z),this.size}}class lM extends ku{get Id(){return Cu.BigGolem}constructor(t){super(t,Iu.Gltf,"assets/monster/big_golem.glb",(t=>oM(this,void 0,void 0,(function*(){this.Gltf=t,this.meshs=t.scene,this.meshs.castShadow=!0,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!0})),this.meshs.children[0].scale.set(this.scale,this.scale,this.scale),this.meshs.children[0].position.y=3.7,this.mixer=new ru(t.scene),this.clips.set(Au.Idle,t.animations.find((t=>"metarig|0_Idle"==t.name))),this.clips.set(Au.Run,t.animations.find((t=>"metarig|1_Walk"==t.name))),this.clips.set(Au.Punch,t.animations.find((t=>"metarig|3_Attack"==t.name))),this.clips.set(Au.Dying,t.animations.find((t=>"metarig|5_Die"==t.name))),this.GetSize(this.meshs)})))),this.scale=.02}GetBodyMeshId(){return"mixamorigRightHand"}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.set(e.x,e.y,e.z),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),this.size)return this.size;const e=(new Be).setFromObject(this.meshs);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x)/6,this.size.y=Math.ceil(this.size.y)/2.5,this.size.z=Math.ceil(this.size.z)/6,this.size}}var cM=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class uM extends ku{get Id(){return Cu.Snake}constructor(t){super(t,Iu.Gltf,"assets/monster/snake.glb",(t=>cM(this,void 0,void 0,(function*(){this.Gltf=t,this.meshs=t.scene,this.meshs.castShadow=!0,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!0}));this.meshs.scale.set(1,1,1),this.mixer=new ru(t.scene),this.clips.set(Au.Idle,t.animations.find((t=>"idle"==t.name))),this.clips.set(Au.Walk,t.animations.find((t=>"Walk"==t.name))),this.clips.set(Au.Run,t.animations.find((t=>"Run"==t.name))),this.clips.set(Au.Punch,t.animations.find((t=>"Angry"==t.name)))}))))}GetBodyMeshId(){return"mixamorigRightHand"}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.set(e.x,e.y,e.z),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),this.size)return this.size;const e=(new Be).setFromObject(this.meshs.children[0]);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.z=Math.ceil(this.size.z),this.size}}var dM=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class pM extends ku{get Id(){return Cu.Viking}constructor(t){super(t,Iu.Gltf,"assets/monster/viking.glb",(t=>dM(this,void 0,void 0,(function*(){this.Gltf=t,this.meshs=t.scene,this.meshs.castShadow=!0,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!0}));this.meshs.children[0].scale.set(1,1,1),this.mixer=new ru(t.scene),this.clips.set(Au.Idle,t.animations.find((t=>"Idle1"==t.name))),this.clips.set(Au.Run,t.animations.find((t=>"Run"==t.name))),this.clips.set(Au.Punch,t.animations.find((t=>"Attak"==t.name)))}))))}GetBodyMeshId(){return"mixamorigRightHand"}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.set(e.x,e.y,e.z),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),this.size)return this.size;const e=(new Be).setFromObject(this.meshs.children[0]);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.y=Math.ceil(this.size.y),this.size.z=Math.ceil(this.size.z)-2,this.size}}var mM=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class fM extends ku{get Id(){return Cu.Viking}constructor(t){super(t,Iu.Gltf,"assets/monster/casual_builder.glb",(t=>mM(this,void 0,void 0,(function*(){this.Gltf=t,this.meshs=t.scene,this.meshs.castShadow=!0,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!0}));this.meshs.scale.set(1,1,1),this.mixer=new ru(t.scene),this.clips.set(Au.Idle,t.animations.find((t=>"idle"==t.name))),this.clips.set(Au.Run,t.animations.find((t=>"run"==t.name))),this.clips.set(Au.Punch,t.animations.find((t=>"joy1"==t.name))),this.clips.set(Au.Dying,t.animations.find((t=>"sit_idle"==t.name)))}))))}GetBodyMeshId(){return"mixamorigRightHand"}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.set(e.x,e.y,e.z),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),this.size)return this.size;const e=(new Be).setFromObject(this.meshs.children[0]);return this.size=e.getSize(new Le),this.size.x=.8*Math.ceil(this.size.x),this.size.y=2*Math.ceil(this.size.y),this.size.z=Math.ceil(this.size.z),this.size}}class gM{constructor(){this._listeners={}}addEventListener(t,e){const i=this._listeners;return void 0===i[t]&&(i[t]=[]),-1===i[t].indexOf(e)&&i[t].push(e),this}removeEventListener(t,e){if(void 0===this._listeners)return this;const i=this._listeners[t];if(void 0!==i){const t=i.indexOf(e);-1!==t&&i.splice(t,1)}return this}dispatchEvent(t){if(void 0===this._listeners)return this;const e=this._listeners[t.type];if(void 0!==e){const i=e.slice(0);for(let e=0,n=i.length;e<n;e++)i[e].call(this,t)}return this}dispose(){for(const t in this._listeners)delete this._listeners[t]}}class vM extends gM{constructor(t,e,i,n={}){if(super(),this._name=void 0,this._parent=void 0,this._child=void 0,this._attributes=void 0,this._disposed=!1,this._name=t,this._parent=e,this._child=i,this._attributes=n,!e.isOnGraph(i))throw new Error("Cannot connect disconnected graphs.")}getName(){return this._name}getParent(){return this._parent}getChild(){return this._child}setChild(t){return this._child=t,this}getAttributes(){return this._attributes}dispose(){this._disposed||(this._disposed=!0,this.dispatchEvent({type:"dispose",target:this}),super.dispose())}isDisposed(){return this._disposed}}class yM extends gM{constructor(...t){super(...t),this._emptySet=new Set,this._edges=new Set,this._parentEdges=new Map,this._childEdges=new Map}listEdges(){return Array.from(this._edges)}listParentEdges(t){return Array.from(this._childEdges.get(t)||this._emptySet)}listParents(t){return this.listParentEdges(t).map((t=>t.getParent()))}listChildEdges(t){return Array.from(this._parentEdges.get(t)||this._emptySet)}listChildren(t){return this.listChildEdges(t).map((t=>t.getChild()))}disconnectParents(t,e){let i=this.listParentEdges(t);return e&&(i=i.filter((t=>e(t.getParent())))),i.forEach((t=>t.dispose())),this}createEdge(t,e,i,n){return this._registerEdge(new vM(t,e,i,n))}_registerEdge(t){this._edges.add(t);const e=t.getParent();this._parentEdges.has(e)||this._parentEdges.set(e,new Set),this._parentEdges.get(e).add(t);const i=t.getChild();return this._childEdges.has(i)||this._childEdges.set(i,new Set),this._childEdges.get(i).add(t),t.addEventListener("dispose",(()=>this._removeEdge(t))),t}_removeEdge(t){return this._edges.delete(t),this._parentEdges.get(t.getParent()).delete(t),this._childEdges.get(t.getChild()).delete(t),this}}function xM(){return xM=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var i=arguments[e];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(t[n]=i[n])}return t},xM.apply(this,arguments)}function bM(t){return t instanceof vM}function _M(t){return Array.isArray(t)&&t[0]instanceof vM}function wM(t){return!!(function(t){return Boolean(t)&&Object.getPrototypeOf(t)===Object.prototype}(t)&&function(t){for(const e in t)return t[e]}(t)instanceof vM)}const MM=Symbol("attributes"),SM=Symbol("immutableKeys");class EM extends gM{constructor(t){super(),this._disposed=!1,this.graph=void 0,this[MM]=void 0,this[SM]=void 0,this.graph=t,this[SM]=new Set,this[MM]=this._createAttributes()}getDefaults(){return{}}_createAttributes(){const t=this.getDefaults(),e={};for(const i in t){const n=t[i];if(n instanceof EM){const t=this.graph.createEdge(i,this,n);t.addEventListener("dispose",(()=>n.dispose())),this[SM].add(i),e[i]=t}else e[i]=n}return e}isOnGraph(t){return this.graph===t.graph}isDisposed(){return this._disposed}dispose(){this._disposed||(this.graph.listChildEdges(this).forEach((t=>t.dispose())),this.graph.disconnectParents(this),this._disposed=!0,this.dispatchEvent({type:"dispose"}))}detach(){return this.graph.disconnectParents(this),this}swap(t,e){for(const i in this[MM]){const n=this[MM][i];if(bM(n)){const s=n;s.getChild()===t&&this.setRef(i,e,s.getAttributes())}else if(_M(n)){const s=n.find((e=>e.getChild()===t));if(s){const n=s.getAttributes();this.removeRef(i,t).addRef(i,e,n)}}else if(wM(n)){const s=n;for(const n in s){const r=s[n];r.getChild()===t&&this.setRefMap(i,n,e,r.getAttributes())}}}return this}get(t){return this[MM][t]}set(t,e){return this[MM][t]=e,this.dispatchEvent({type:"change",attribute:t})}getRef(t){const e=this[MM][t];return e?e.getChild():null}setRef(t,e,i){if(this[SM].has(t))throw new Error(`Cannot overwrite immutable attribute, "${t}".`);const n=this[MM][t];if(n&&n.dispose(),!e)return this;const s=this.graph.createEdge(t,this,e,i);return s.addEventListener("dispose",(()=>{delete this[MM][t],this.dispatchEvent({type:"change",attribute:t})})),this[MM][t]=s,this.dispatchEvent({type:"change",attribute:t})}listRefs(t){return this[MM][t].map((t=>t.getChild()))}addRef(t,e,i){const n=this.graph.createEdge(t,this,e,i),s=this[MM][t];return s.push(n),n.addEventListener("dispose",(()=>{let e;for(;-1!==(e=s.indexOf(n));)s.splice(e,1);this.dispatchEvent({type:"change",attribute:t})})),this.dispatchEvent({type:"change",attribute:t})}removeRef(t,e){return this[MM][t].filter((t=>t.getChild()===e)).forEach((t=>t.dispose())),this}listRefMapKeys(t){return Object.keys(this[MM][t])}listRefMapValues(t){return Object.values(this[MM][t]).map((t=>t.getChild()))}getRefMap(t,e){const i=this[MM][t];return i[e]?i[e].getChild():null}setRefMap(t,e,i,n){const s=this[MM][t],r=s[e];if(r&&r.dispose(),!i)return this;n=Object.assign(n||{},{key:e});const a=this.graph.createEdge(t,this,i,xM({},n,{key:e}));return a.addEventListener("dispose",(()=>{delete s[e],this.dispatchEvent({type:"change",attribute:t,key:e})})),s[e]=a,this.dispatchEvent({type:"change",attribute:t,key:e})}dispatchEvent(t){return super.dispatchEvent(xM({},t,{target:this})),this.graph.dispatchEvent(xM({},t,{target:this,type:`node:${t.type}`})),this}}const TM="v3.10.1",AM="@glb.bin";var CM,IM,RM,kM,PM;!function(t){t.ACCESSOR="Accessor",t.ANIMATION="Animation",t.ANIMATION_CHANNEL="AnimationChannel",t.ANIMATION_SAMPLER="AnimationSampler",t.BUFFER="Buffer",t.CAMERA="Camera",t.MATERIAL="Material",t.MESH="Mesh",t.PRIMITIVE="Primitive",t.PRIMITIVE_TARGET="PrimitiveTarget",t.NODE="Node",t.ROOT="Root",t.SCENE="Scene",t.SKIN="Skin",t.TEXTURE="Texture",t.TEXTURE_INFO="TextureInfo"}(CM||(CM={})),function(t){t.INTERLEAVED="interleaved",t.SEPARATE="separate"}(IM||(IM={})),function(t){t.ARRAY_BUFFER="ARRAY_BUFFER",t.ELEMENT_ARRAY_BUFFER="ELEMENT_ARRAY_BUFFER",t.INVERSE_BIND_MATRICES="INVERSE_BIND_MATRICES",t.OTHER="OTHER",t.SPARSE="SPARSE"}(RM||(RM={})),function(t){t[t.R=4096]="R",t[t.G=256]="G",t[t.B=16]="B",t[t.A=1]="A"}(kM||(kM={})),function(t){t.GLTF="GLTF",t.GLB="GLB"}(PM||(PM={}));const DM={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array};var LM,OM="undefined"!=typeof Float32Array?Float32Array:Array;function NM(t){return Math.hypot(t[0],t[1],t[2])}function BM(t,e,i){var n=e[0],s=e[1],r=e[2],a=i[3]*n+i[7]*s+i[11]*r+i[15];return t[0]=(i[0]*n+i[4]*s+i[8]*r+i[12])/(a=a||1),t[1]=(i[1]*n+i[5]*s+i[9]*r+i[13])/a,t[2]=(i[2]*n+i[6]*s+i[10]*r+i[14])/a,t}function zM(t){const e={min:[1/0,1/0,1/0],max:[-1/0,-1/0,-1/0]},i=t.propertyType===CM.NODE?[t]:t.listChildren();for(const t of i)t.traverse((t=>{const i=t.getMesh();if(!i)return;const n=UM(i,t.getWorldMatrix());FM(n.min,e),FM(n.max,e)}));return e}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)}),LM=new OM(3),OM!=Float32Array&&(LM[0]=0,LM[1]=0,LM[2]=0);function UM(t,e){const i={min:[1/0,1/0,1/0],max:[-1/0,-1/0,-1/0]};for(const n of t.listPrimitives()){const t=n.getAttribute("POSITION");if(!t)continue;let s=[0,0,0],r=[0,0,0];for(let n=0;n<t.getCount();n++)s=t.getElement(n,s),r=BM(r,s,e),FM(r,i)}return i}function FM(t,e){for(let i=0;i<3;i++)e.min[i]=Math.min(t[i],e.min[i]),e.max[i]=Math.max(t[i],e.max[i])}class GM{static createBufferFromDataURI(t){if("undefined"==typeof Buffer){const e=atob(t.split(",")[1]),i=new Uint8Array(e.length);for(let t=0;t<e.length;t++)i[t]=e.charCodeAt(t);return i}{const e=t.split(",")[1],i=t.indexOf("base64")>=0;return Buffer.from(e,i?"base64":"utf8")}}static encodeText(t){return"undefined"!=typeof TextEncoder?(new TextEncoder).encode(t):Buffer.from(t)}static decodeText(t){return"undefined"!=typeof TextDecoder?(new TextDecoder).decode(t):Buffer.from(t).toString("utf8")}static concat(t){let e=0;for(const i of t)e+=i.byteLength;const i=new Uint8Array(e);let n=0;for(const e of t)i.set(e,n),n+=e.byteLength;return i}static pad(t,e=0){const i=this.padNumber(t.byteLength);if(i===t.byteLength)return t;const n=new Uint8Array(i);if(n.set(t),0!==e)for(let s=t.byteLength;s<i;s++)n[s]=e;return n}static padNumber(t){return 4*Math.ceil(t/4)}static equals(t,e){if(t===e)return!0;if(t.byteLength!==e.byteLength)return!1;let i=t.byteLength;for(;i--;)if(t[i]!==e[i])return!1;return!0}static toView(t,e=0,i=1/0){return new Uint8Array(t.buffer,t.byteOffset+e,Math.min(t.byteLength,i))}static assertView(t){if(t&&!ArrayBuffer.isView(t))throw new Error(`Method requires Uint8Array parameter; received "${typeof t}".`);return t}}class VM{static hexToFactor(t,e){t=Math.floor(t);const i=e;return i[0]=(t>>16&255)/255,i[1]=(t>>8&255)/255,i[2]=(255&t)/255,this.convertSRGBToLinear(e,e)}static factorToHex(t){const e=[...t],[i,n,s]=this.convertLinearToSRGB(t,e);return 255*i<<16^255*n<<8^255*s<<0}static convertSRGBToLinear(t,e){const i=t,n=e;for(let t=0;t<3;t++)n[t]=i[t]<.04045?.0773993808*i[t]:Math.pow(.9478672986*i[t]+.0521327014,2.4);return e}static convertLinearToSRGB(t,e){const i=t,n=e;for(let t=0;t<3;t++)n[t]=i[t]<.0031308?12.92*i[t]:1.055*Math.pow(i[t],.41666)-.055;return e}}class HM{match(t){return t.length>=8&&137===t[0]&&80===t[1]&&78===t[2]&&71===t[3]&&13===t[4]&&10===t[5]&&26===t[6]&&10===t[7]}getSize(t){const e=new DataView(t.buffer,t.byteOffset);return GM.decodeText(t.slice(12,16))===HM.PNG_FRIED_CHUNK_NAME?[e.getUint32(32,!1),e.getUint32(36,!1)]:[e.getUint32(16,!1),e.getUint32(20,!1)]}getChannels(t){return 4}}HM.PNG_FRIED_CHUNK_NAME="CgBI";class jM{static registerFormat(t,e){this.impls[t]=e}static getMimeType(t){for(const e in this.impls)if(this.impls[e].match(t))return e;return null}static getSize(t,e){return this.impls[e]?this.impls[e].getSize(t):null}static getChannels(t,e){return this.impls[e]?this.impls[e].getChannels(t):null}static getVRAMByteLength(t,e){if(!this.impls[e])return null;if(this.impls[e].getVRAMByteLength)return this.impls[e].getVRAMByteLength(t);let i=0;const n=this.getSize(t,e);if(!n)return null;for(;n[0]>1||n[1]>1;)i+=n[0]*n[1]*4,n[0]=Math.max(Math.floor(n[0]/2),1),n[1]=Math.max(Math.floor(n[1]/2),1);return i+=4,i}static mimeTypeToExtension(t){return"image/jpeg"===t?"jpg":t.split("/").pop()}static extensionToMimeType(t){return"jpg"===t?"image/jpeg":t?`image/${t}`:""}}function WM(t,e){if(e>t.byteLength)throw new TypeError("Corrupt JPG, exceeded buffer limits");if(255!==t.getUint8(e))throw new TypeError("Invalid JPG, marker table corrupted");return t}jM.impls={"image/jpeg":new class{match(t){return t.length>=3&&255===t[0]&&216===t[1]&&255===t[2]}getSize(t){let e,i,n=new DataView(t.buffer,t.byteOffset+4);for(;n.byteLength;){if(e=n.getUint16(0,!1),WM(n,e),i=n.getUint8(e+1),192===i||193===i||194===i)return[n.getUint16(e+7,!1),n.getUint16(e+5,!1)];n=new DataView(t.buffer,n.byteOffset+e+2)}throw new TypeError("Invalid JPG, no size found")}getChannels(t){return 3}},"image/png":new HM};class XM{static basename(t){const e=t.split(/[\\/]/).pop();return e.substring(0,e.lastIndexOf("."))}static extension(t){if(t.startsWith("data:image/")){const e=t.match(/data:(image\/\w+)/)[1];return jM.mimeTypeToExtension(e)}return t.startsWith("data:model/gltf+json")?"gltf":t.startsWith("data:model/gltf-binary")?"glb":t.startsWith("data:application/")?"bin":t.split(/[\\/]/).pop().split(/[.]/).pop()}}function qM(t){return"[object Object]"===Object.prototype.toString.call(t)}function YM(t){if(!1===qM(t))return!1;const e=t.constructor;if(void 0===e)return!0;const i=e.prototype;return!1!==qM(i)&&!1!==Object.prototype.hasOwnProperty.call(i,"isPrototypeOf")}var JM,$M;!function(t){t[t.SILENT=4]="SILENT",t[t.ERROR=3]="ERROR",t[t.WARN=2]="WARN",t[t.INFO=1]="INFO",t[t.DEBUG=0]="DEBUG"}($M||($M={}));class KM{constructor(t){this.verbosity=void 0,this.verbosity=t}debug(t){this.verbosity,KM.Verbosity.DEBUG}info(t){this.verbosity,KM.Verbosity.INFO}warn(t){this.verbosity,KM.Verbosity.WARN}error(t){this.verbosity,KM.Verbosity.ERROR}}function ZM(t,e,i){var n=e[0],s=e[1],r=e[2],a=e[3],o=e[4],h=e[5],l=e[6],c=e[7],u=e[8],d=e[9],p=e[10],m=e[11],f=e[12],g=e[13],v=e[14],y=e[15],x=i[0],b=i[1],_=i[2],w=i[3];return t[0]=x*n+b*o+_*u+w*f,t[1]=x*s+b*h+_*d+w*g,t[2]=x*r+b*l+_*p+w*v,t[3]=x*a+b*c+_*m+w*y,t[4]=(x=i[4])*n+(b=i[5])*o+(_=i[6])*u+(w=i[7])*f,t[5]=x*s+b*h+_*d+w*g,t[6]=x*r+b*l+_*p+w*v,t[7]=x*a+b*c+_*m+w*y,t[8]=(x=i[8])*n+(b=i[9])*o+(_=i[10])*u+(w=i[11])*f,t[9]=x*s+b*h+_*d+w*g,t[10]=x*r+b*l+_*p+w*v,t[11]=x*a+b*c+_*m+w*y,t[12]=(x=i[12])*n+(b=i[13])*o+(_=i[14])*u+(w=i[15])*f,t[13]=x*s+b*h+_*d+w*g,t[14]=x*r+b*l+_*p+w*v,t[15]=x*a+b*c+_*m+w*y,t}JM=KM,KM.Verbosity=$M,KM.DEFAULT_INSTANCE=new JM(JM.Verbosity.INFO);class QM{static identity(t){return t}static eq(t,e,i=1e-5){if(t.length!==e.length)return!1;for(let n=0;n<t.length;n++)if(Math.abs(t[n]-e[n])>i)return!1;return!0}static decodeNormalizedInt(t,e){switch(e){case 5126:return t;case 5123:return t/65535;case 5121:return t/255;case 5122:return Math.max(t/32767,-1);case 5120:return Math.max(t/127,-1);default:throw new Error("Invalid component type.")}}static denormalize(t,e){return QM.decodeNormalizedInt(t,e)}static encodeNormalizedInt(t,e){switch(e){case 5126:return t;case 5123:return Math.round(65535*t);case 5121:return Math.round(255*t);case 5122:return Math.round(32767*t);case 5120:return Math.round(127*t);default:throw new Error("Invalid component type.")}}static normalize(t,e){return QM.encodeNormalizedInt(t,e)}static decompose(t,e,i,n){let s=NM([t[0],t[1],t[2]]);const r=NM([t[4],t[5],t[6]]),a=NM([t[8],t[9],t[10]]);var o,h,l,c,u,d,p,m,f,g,v,y,x,b,_,w,M;((h=(o=t)[0])*(p=o[5])-(l=o[1])*(d=o[4]))*((y=o[10])*(M=o[15])-(x=o[11])*(w=o[14]))-(h*(m=o[6])-(c=o[2])*d)*((v=o[9])*M-x*(_=o[13]))+(h*(f=o[7])-(u=o[3])*d)*(v*w-y*_)+(l*m-c*p)*((g=o[8])*M-x*(b=o[12]))-(l*f-u*p)*(g*w-y*b)+(c*f-u*m)*(g*_-v*b)<0&&(s=-s),e[0]=t[12],e[1]=t[13],e[2]=t[14];const S=t.slice(),E=1/s,T=1/r,A=1/a;S[0]*=E,S[1]*=E,S[2]*=E,S[4]*=T,S[5]*=T,S[6]*=T,S[8]*=A,S[9]*=A,S[10]*=A,function(t,e){var i=new OM(3);!function(t,e){var i=e[4],n=e[5],s=e[6],r=e[8],a=e[9],o=e[10];t[0]=Math.hypot(e[0],e[1],e[2]),t[1]=Math.hypot(i,n,s),t[2]=Math.hypot(r,a,o)}(i,e);var n=1/i[0],s=1/i[1],r=1/i[2],a=e[0]*n,o=e[1]*s,h=e[2]*r,l=e[4]*n,c=e[5]*s,u=e[6]*r,d=e[8]*n,p=e[9]*s,m=e[10]*r,f=a+c+m,g=0;f>0?(g=2*Math.sqrt(f+1),t[3]=.25*g,t[0]=(u-p)/g,t[1]=(d-h)/g,t[2]=(o-l)/g):a>c&&a>m?(g=2*Math.sqrt(1+a-c-m),t[3]=(u-p)/g,t[0]=.25*g,t[1]=(o+l)/g,t[2]=(d+h)/g):c>m?(g=2*Math.sqrt(1+c-a-m),t[3]=(d-h)/g,t[0]=(o+l)/g,t[1]=.25*g,t[2]=(u+p)/g):(g=2*Math.sqrt(1+m-a-c),t[3]=(o-l)/g,t[0]=(d+h)/g,t[1]=(u+p)/g,t[2]=.25*g)}(i,S),n[0]=s,n[1]=r,n[2]=a}static compose(t,e,i,n){const s=n,r=e[0],a=e[1],o=e[2],h=e[3],l=r+r,c=a+a,u=o+o,d=r*l,p=r*c,m=r*u,f=a*c,g=a*u,v=o*u,y=h*l,x=h*c,b=h*u,_=i[0],w=i[1],M=i[2];return s[0]=(1-(f+v))*_,s[1]=(p+b)*_,s[2]=(m-x)*_,s[3]=0,s[4]=(p-b)*w,s[5]=(1-(d+v))*w,s[6]=(g+y)*w,s[7]=0,s[8]=(m+x)*M,s[9]=(g-y)*M,s[10]=(1-(d+f))*M,s[11]=0,s[12]=t[0],s[13]=t[1],s[14]=t[2],s[15]=1,s}}function tS(t,e){if(!!t!=!!e)return!1;const i=t.getChild(),n=e.getChild();return i===n||i.equals(n)}function eS(t,e){if(!!t!=!!e)return!1;if(t.length!==e.length)return!1;for(let i=0;i<t.length;i++){const n=t[i],s=e[i];if(n.getChild()!==s.getChild()&&!n.getChild().equals(s.getChild()))return!1}return!0}function iS(t,e){if(!!t!=!!e)return!1;const i=Object.keys(t),n=Object.keys(e);if(i.length!==n.length)return!1;for(const i in t){const n=t[i],s=e[i];if(!!n!=!!s)return!1;const r=n.getChild(),a=s.getChild();if(r!==a&&!r.equals(a))return!1}return!0}function nS(t,e){if(t===e)return!0;if(!!t!=!!e||!t||!e)return!1;if(t.length!==e.length)return!1;for(let i=0;i<t.length;i++)if(t[i]!==e[i])return!1;return!0}function sS(t,e){if(t===e)return!0;if(!!t!=!!e)return!1;if(!YM(t)||!YM(e))return t===e;const i=t,n=e;let s,r=0,a=0;for(s in i)r++;for(s in n)a++;if(r!==a)return!1;for(s in i){const t=i[s],e=n[s];if(rS(t)&&rS(e)){if(!nS(t,e))return!1}else if(YM(t)&&YM(e)){if(!sS(t,e))return!1}else if(t!==e)return!1}return!0}function rS(t){return Array.isArray(t)||ArrayBuffer.isView(t)}const aS=new Set,oS=function(){let t="";for(let e=0;e<6;e++)t+="23456789abdegjkmnpqrvwxyzABDEGJKMNPQRVWXYZ".charAt(Math.floor(42*Math.random()));return t},hS="https://null.example";class lS{static dirname(t){const e=t.lastIndexOf("/");return-1===e?"./":t.substring(0,e+1)}static basename(t){return XM.basename(new URL(t,hS).pathname)}static extension(t){return XM.extension(new URL(t,hS).pathname)}static resolve(t,e){if(!this.isRelativePath(e))return e;const i=t.split("/"),n=e.split("/");i.pop();for(let t=0;t<n.length;t++)"."!==n[t]&&(".."===n[t]?i.pop():i.push(n[t]));return i.join("/")}static isAbsoluteURL(t){return this.PROTOCOL_REGEXP.test(t)}static isRelativePath(t){return!/^(?:[a-zA-Z]+:)?\//.test(t)}}lS.DEFAULT_INIT={},lS.PROTOCOL_REGEXP=/^[a-zA-Z]+:\/\//;const cS=t=>t,uS=new Set;class dS extends EM{constructor(t,e=""){super(t),this[MM].name=e,this.init(),this.dispatchEvent({type:"create"})}getGraph(){return this.graph}getDefaults(){return Object.assign(super.getDefaults(),{name:"",extras:{}})}set(t,e){return Array.isArray(e)&&(e=e.slice()),super.set(t,e)}getName(){return this.get("name")}setName(t){return this.set("name",t)}getExtras(){return this.get("extras")}setExtras(t){return this.set("extras",t)}clone(){return new(0,this.constructor)(this.graph).copy(this,cS)}copy(t,e=cS){for(const t in this[MM]){const e=this[MM][t];if(e instanceof vM)this[SM].has(t)||e.dispose();else if(_M(e))for(const t of e)t.dispose();else if(wM(e))for(const t in e)e[t].dispose()}for(const i in t[MM]){const n=this[MM][i],s=t[MM][i];if(s instanceof vM)this[SM].has(i)?n.getChild().copy(e(s.getChild()),e):this.setRef(i,e(s.getChild()),s.getAttributes());else if(_M(s))for(const t of s)this.addRef(i,e(t.getChild()),t.getAttributes());else if(wM(s))for(const t in s){const n=s[t];this.setRefMap(i,t,e(n.getChild()),n.getAttributes())}else this[MM][i]=YM(s)?JSON.parse(JSON.stringify(s)):Array.isArray(s)||s instanceof ArrayBuffer||ArrayBuffer.isView(s)?s.slice():s}return this}equals(t,e=uS){if(this===t)return!0;if(this.propertyType!==t.propertyType)return!1;for(const i in this[MM]){if(e.has(i))continue;const n=this[MM][i],s=t[MM][i];if(bM(n)||bM(s)){if(!tS(n,s))return!1}else if(_M(n)||_M(s)){if(!eS(n,s))return!1}else if(wM(n)||wM(s)){if(!iS(n,s))return!1}else if(YM(n)||YM(s)){if(!sS(n,s))return!1}else if(rS(n)||rS(s)){if(!nS(n,s))return!1}else if(n!==s)return!1}return!0}detach(){return this.graph.disconnectParents(this,(t=>"Root"!==t.propertyType)),this}listParents(){return this.graph.listParents(this)}}class pS extends dS{getDefaults(){return Object.assign(super.getDefaults(),{extensions:{}})}getExtension(t){return this.getRefMap("extensions",t)}setExtension(t,e){return e&&e.t(this),this.setRefMap("extensions",t,e)}listExtensions(){return this.listRefMapValues("extensions")}}class mS extends pS{constructor(...t){super(...t),this.i=QM.identity,this.o=QM.identity}init(){this.propertyType=CM.ACCESSOR}getDefaults(){return Object.assign(super.getDefaults(),{array:null,type:mS.Type.SCALAR,componentType:mS.ComponentType.FLOAT,normalized:!1,sparse:!1,buffer:null})}copy(t,e=cS){return super.copy(t,e),this.i=t.i,this.o=t.o,this}static getElementSize(t){switch(t){case mS.Type.SCALAR:return 1;case mS.Type.VEC2:return 2;case mS.Type.VEC3:return 3;case mS.Type.VEC4:case mS.Type.MAT2:return 4;case mS.Type.MAT3:return 9;case mS.Type.MAT4:return 16;default:throw new Error("Unexpected type: "+t)}}static getComponentSize(t){switch(t){case mS.ComponentType.BYTE:case mS.ComponentType.UNSIGNED_BYTE:return 1;case mS.ComponentType.SHORT:case mS.ComponentType.UNSIGNED_SHORT:return 2;case mS.ComponentType.UNSIGNED_INT:case mS.ComponentType.FLOAT:return 4;default:throw new Error("Unexpected component type: "+t)}}getMinNormalized(t){const e=this.getElementSize();this.getMin(t);for(let i=0;i<e;i++)t[i]=this.o(t[i]);return t}getMin(t){const e=this.get("array"),i=this.getCount(),n=this.getElementSize();for(let e=0;e<n;e++)t[e]=1/0;for(let s=0;s<i*n;s+=n)for(let i=0;i<n;i++){const n=e[s+i];Number.isFinite(n)&&(t[i]=Math.min(t[i],n))}return t}getMaxNormalized(t){const e=this.getElementSize();this.getMax(t);for(let i=0;i<e;i++)t[i]=this.o(t[i]);return t}getMax(t){const e=this.get("array"),i=this.getCount(),n=this.getElementSize();for(let e=0;e<n;e++)t[e]=-1/0;for(let s=0;s<i*n;s+=n)for(let i=0;i<n;i++){const n=e[s+i];Number.isFinite(n)&&(t[i]=Math.max(t[i],n))}return t}getCount(){const t=this.get("array");return t?t.length/this.getElementSize():0}getType(){return this.get("type")}setType(t){return this.set("type",t)}getElementSize(){return mS.getElementSize(this.get("type"))}getComponentSize(){return this.get("array").BYTES_PER_ELEMENT}getComponentType(){return this.get("componentType")}getNormalized(){return this.get("normalized")}setNormalized(t){return this.set("normalized",t),t?(this.o=t=>QM.decodeNormalizedInt(t,this.get("componentType")),this.i=t=>QM.encodeNormalizedInt(t,this.get("componentType"))):(this.o=QM.identity,this.i=QM.identity),this}getScalar(t){const e=this.getElementSize();return this.o(this.get("array")[t*e])}setScalar(t,e){return this.get("array")[t*this.getElementSize()]=this.i(e),this}getElement(t,e){const i=this.getElementSize(),n=this.get("array");for(let s=0;s<i;s++)e[s]=this.o(n[t*i+s]);return e}setElement(t,e){const i=this.getElementSize(),n=this.get("array");for(let s=0;s<i;s++)n[t*i+s]=this.i(e[s]);return this}getSparse(){return this.get("sparse")}setSparse(t){return this.set("sparse",t)}getBuffer(){return this.getRef("buffer")}setBuffer(t){return this.setRef("buffer",t)}getArray(){return this.get("array")}setArray(t){return this.set("componentType",t?function(t){switch(t.constructor){case Float32Array:return mS.ComponentType.FLOAT;case Uint32Array:return mS.ComponentType.UNSIGNED_INT;case Uint16Array:return mS.ComponentType.UNSIGNED_SHORT;case Uint8Array:return mS.ComponentType.UNSIGNED_BYTE;case Int16Array:return mS.ComponentType.SHORT;case Int8Array:return mS.ComponentType.BYTE;default:throw new Error("Unknown accessor componentType.")}}(t):mS.ComponentType.FLOAT),this.set("array",t),this}getByteLength(){const t=this.get("array");return t?t.byteLength:0}}mS.Type={SCALAR:"SCALAR",VEC2:"VEC2",VEC3:"VEC3",VEC4:"VEC4",MAT2:"MAT2",MAT3:"MAT3",MAT4:"MAT4"},mS.ComponentType={BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,UNSIGNED_INT:5125,FLOAT:5126};class fS extends pS{init(){this.propertyType=CM.ANIMATION}getDefaults(){return Object.assign(super.getDefaults(),{channels:[],samplers:[]})}addChannel(t){return this.addRef("channels",t)}removeChannel(t){return this.removeRef("channels",t)}listChannels(){return this.listRefs("channels")}addSampler(t){return this.addRef("samplers",t)}removeSampler(t){return this.removeRef("samplers",t)}listSamplers(){return this.listRefs("samplers")}}class gS extends pS{init(){this.propertyType=CM.ANIMATION_CHANNEL}getDefaults(){return Object.assign(super.getDefaults(),{targetPath:null,targetNode:null,sampler:null})}getTargetPath(){return this.get("targetPath")}setTargetPath(t){return this.set("targetPath",t)}getTargetNode(){return this.getRef("targetNode")}setTargetNode(t){return this.setRef("targetNode",t)}getSampler(){return this.getRef("sampler")}setSampler(t){return this.setRef("sampler",t)}}gS.TargetPath={TRANSLATION:"translation",ROTATION:"rotation",SCALE:"scale",WEIGHTS:"weights"};class vS extends pS{init(){this.propertyType=CM.ANIMATION_SAMPLER}getDefaultAttributes(){return Object.assign(super.getDefaults(),{interpolation:vS.Interpolation.LINEAR,input:null,output:null})}getInterpolation(){return this.get("interpolation")}setInterpolation(t){return this.set("interpolation",t)}getInput(){return this.getRef("input")}setInput(t){return this.setRef("input",t,{usage:RM.OTHER})}getOutput(){return this.getRef("output")}setOutput(t){return this.setRef("output",t,{usage:RM.OTHER})}}vS.Interpolation={LINEAR:"LINEAR",STEP:"STEP",CUBICSPLINE:"CUBICSPLINE"};class yS extends pS{init(){this.propertyType=CM.BUFFER}getDefaults(){return Object.assign(super.getDefaults(),{uri:""})}getURI(){return this.get("uri")}setURI(t){return this.set("uri",t)}}class xS extends pS{init(){this.propertyType=CM.CAMERA}getDefaults(){return Object.assign(super.getDefaults(),{type:xS.Type.PERSPECTIVE,znear:.1,zfar:100,aspectRatio:null,yfov:2*Math.PI*50/360,xmag:1,ymag:1})}getType(){return this.get("type")}setType(t){return this.set("type",t)}getZNear(){return this.get("znear")}setZNear(t){return this.set("znear",t)}getZFar(){return this.get("zfar")}setZFar(t){return this.set("zfar",t)}getAspectRatio(){return this.get("aspectRatio")}setAspectRatio(t){return this.set("aspectRatio",t)}getYFov(){return this.get("yfov")}setYFov(t){return this.set("yfov",t)}getXMag(){return this.get("xmag")}setXMag(t){return this.set("xmag",t)}getYMag(){return this.get("ymag")}setYMag(t){return this.set("ymag",t)}}xS.Type={PERSPECTIVE:"perspective",ORTHOGRAPHIC:"orthographic"};class bS extends dS{t(t){if(!this.parentTypes.includes(t.propertyType))throw new Error(`Parent "${t.propertyType}" invalid for child "${this.propertyType}".`)}}bS.EXTENSION_NAME=void 0;class _S extends pS{init(){this.propertyType=CM.TEXTURE_INFO}getDefaults(){return Object.assign(super.getDefaults(),{texCoord:0,magFilter:null,minFilter:null,wrapS:_S.WrapMode.REPEAT,wrapT:_S.WrapMode.REPEAT})}getTexCoord(){return this.get("texCoord")}setTexCoord(t){return this.set("texCoord",t)}getMagFilter(){return this.get("magFilter")}setMagFilter(t){return this.set("magFilter",t)}getMinFilter(){return this.get("minFilter")}setMinFilter(t){return this.set("minFilter",t)}getWrapS(){return this.get("wrapS")}setWrapS(t){return this.set("wrapS",t)}getWrapT(){return this.get("wrapT")}setWrapT(t){return this.set("wrapT",t)}}_S.WrapMode={CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,REPEAT:10497},_S.MagFilter={NEAREST:9728,LINEAR:9729},_S.MinFilter={NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987};const{R:wS,G:MS,B:SS,A:ES}=kM;class TS extends pS{init(){this.propertyType=CM.MATERIAL}getDefaults(){return Object.assign(super.getDefaults(),{alphaMode:TS.AlphaMode.OPAQUE,alphaCutoff:.5,doubleSided:!1,baseColorFactor:[1,1,1,1],baseColorTexture:null,baseColorTextureInfo:new _S(this.graph,"baseColorTextureInfo"),emissiveFactor:[0,0,0],emissiveTexture:null,emissiveTextureInfo:new _S(this.graph,"emissiveTextureInfo"),normalScale:1,normalTexture:null,normalTextureInfo:new _S(this.graph,"normalTextureInfo"),occlusionStrength:1,occlusionTexture:null,occlusionTextureInfo:new _S(this.graph,"occlusionTextureInfo"),roughnessFactor:1,metallicFactor:1,metallicRoughnessTexture:null,metallicRoughnessTextureInfo:new _S(this.graph,"metallicRoughnessTextureInfo")})}getDoubleSided(){return this.get("doubleSided")}setDoubleSided(t){return this.set("doubleSided",t)}getAlpha(){return this.get("baseColorFactor")[3]}setAlpha(t){const e=this.get("baseColorFactor").slice();return e[3]=t,this.set("baseColorFactor",e)}getAlphaMode(){return this.get("alphaMode")}setAlphaMode(t){return this.set("alphaMode",t)}getAlphaCutoff(){return this.get("alphaCutoff")}setAlphaCutoff(t){return this.set("alphaCutoff",t)}getBaseColorFactor(){return this.get("baseColorFactor")}setBaseColorFactor(t){return this.set("baseColorFactor",t)}getBaseColorHex(){return VM.factorToHex(this.get("baseColorFactor"))}setBaseColorHex(t){const e=this.get("baseColorFactor").slice();return this.set("baseColorFactor",VM.hexToFactor(t,e))}getBaseColorTexture(){return this.getRef("baseColorTexture")}getBaseColorTextureInfo(){return this.getRef("baseColorTexture")?this.getRef("baseColorTextureInfo"):null}setBaseColorTexture(t){return this.setRef("baseColorTexture",t,{channels:wS|MS|SS|ES,isColor:!0})}getEmissiveFactor(){return this.get("emissiveFactor")}setEmissiveFactor(t){return this.set("emissiveFactor",t)}getEmissiveHex(){return VM.factorToHex(this.get("emissiveFactor"))}setEmissiveHex(t){const e=this.get("emissiveFactor").slice();return this.set("emissiveFactor",VM.hexToFactor(t,e))}getEmissiveTexture(){return this.getRef("emissiveTexture")}getEmissiveTextureInfo(){return this.getRef("emissiveTexture")?this.getRef("emissiveTextureInfo"):null}setEmissiveTexture(t){return this.setRef("emissiveTexture",t,{channels:wS|MS|SS,isColor:!0})}getNormalScale(){return this.get("normalScale")}setNormalScale(t){return this.set("normalScale",t)}getNormalTexture(){return this.getRef("normalTexture")}getNormalTextureInfo(){return this.getRef("normalTexture")?this.getRef("normalTextureInfo"):null}setNormalTexture(t){return this.setRef("normalTexture",t,{channels:wS|MS|SS})}getOcclusionStrength(){return this.get("occlusionStrength")}setOcclusionStrength(t){return this.set("occlusionStrength",t)}getOcclusionTexture(){return this.getRef("occlusionTexture")}getOcclusionTextureInfo(){return this.getRef("occlusionTexture")?this.getRef("occlusionTextureInfo"):null}setOcclusionTexture(t){return this.setRef("occlusionTexture",t,{channels:wS})}getRoughnessFactor(){return this.get("roughnessFactor")}setRoughnessFactor(t){return this.set("roughnessFactor",t)}getMetallicFactor(){return this.get("metallicFactor")}setMetallicFactor(t){return this.set("metallicFactor",t)}getMetallicRoughnessTexture(){return this.getRef("metallicRoughnessTexture")}getMetallicRoughnessTextureInfo(){return this.getRef("metallicRoughnessTexture")?this.getRef("metallicRoughnessTextureInfo"):null}setMetallicRoughnessTexture(t){return this.setRef("metallicRoughnessTexture",t,{channels:MS|SS})}}TS.AlphaMode={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};class AS extends pS{init(){this.propertyType=CM.MESH}getDefaults(){return Object.assign(super.getDefaults(),{weights:[],primitives:[]})}addPrimitive(t){return this.addRef("primitives",t)}removePrimitive(t){return this.removeRef("primitives",t)}listPrimitives(){return this.listRefs("primitives")}getWeights(){return this.get("weights")}setWeights(t){return this.set("weights",t)}}class CS extends pS{constructor(...t){super(...t),this.u=null,this.h=new Set}init(){this.propertyType=CM.NODE}getDefaults(){return Object.assign(super.getDefaults(),{translation:[0,0,0],rotation:[0,0,0,1],scale:[1,1,1],weights:[],camera:null,mesh:null,skin:null,children:[]})}copy(t,e=cS){if(e===cS)throw new Error("Node cannot be copied.");return super.copy(t,e)}getTranslation(){return this.get("translation")}getRotation(){return this.get("rotation")}getScale(){return this.get("scale")}setTranslation(t){return this.set("translation",t)}setRotation(t){return this.set("rotation",t)}setScale(t){return this.set("scale",t)}getMatrix(){return QM.compose(this.get("translation"),this.get("rotation"),this.get("scale"),[])}setMatrix(t){const e=this.get("translation").slice(),i=this.get("rotation").slice(),n=this.get("scale").slice();return QM.decompose(t,e,i,n),this.set("translation",e).set("rotation",i).set("scale",n)}getWorldTranslation(){const t=[0,0,0];return QM.decompose(this.getWorldMatrix(),t,[0,0,0,1],[1,1,1]),t}getWorldRotation(){const t=[0,0,0,1];return QM.decompose(this.getWorldMatrix(),[0,0,0],t,[1,1,1]),t}getWorldScale(){const t=[1,1,1];return QM.decompose(this.getWorldMatrix(),[0,0,0],[0,0,0,1],t),t}getWorldMatrix(){const t=[];for(let e=this;null!=e;e=e.u)t.push(e);let e;const i=t.pop().getMatrix();for(;e=t.pop();)ZM(i,i,e.getMatrix());return i}addChild(t){if(t.u&&t.u.removeChild(t),t.h.size)for(const e of t.h)e.removeChild(t);this.addRef("children",t),t.u=this;const e=this[MM].children;return e[e.length-1].addEventListener("dispose",(()=>t.u=null)),this}removeChild(t){return this.removeRef("children",t)}listChildren(){return this.listRefs("children")}getParent(){return this.u?this.u:this.listParents().find((t=>t.propertyType===CM.SCENE))||null}getParentNode(){return this.u}getMesh(){return this.getRef("mesh")}setMesh(t){return this.setRef("mesh",t)}getCamera(){return this.getRef("camera")}setCamera(t){return this.setRef("camera",t)}getSkin(){return this.getRef("skin")}setSkin(t){return this.setRef("skin",t)}getWeights(){return this.get("weights")}setWeights(t){return this.set("weights",t)}traverse(t){t(this);for(const e of this.listChildren())e.traverse(t);return this}}class IS extends pS{init(){this.propertyType=CM.PRIMITIVE}getDefaults(){return Object.assign(super.getDefaults(),{mode:IS.Mode.TRIANGLES,material:null,indices:null,attributes:{},targets:[]})}getIndices(){return this.getRef("indices")}setIndices(t){return this.setRef("indices",t,{usage:RM.ELEMENT_ARRAY_BUFFER})}getAttribute(t){return this.getRefMap("attributes",t)}setAttribute(t,e){return this.setRefMap("attributes",t,e,{usage:RM.ARRAY_BUFFER})}listAttributes(){return this.listRefMapValues("attributes")}listSemantics(){return this.listRefMapKeys("attributes")}getMaterial(){return this.getRef("material")}setMaterial(t){return this.setRef("material",t)}getMode(){return this.get("mode")}setMode(t){return this.set("mode",t)}listTargets(){return this.listRefs("targets")}addTarget(t){return this.addRef("targets",t)}removeTarget(t){return this.removeRef("targets",t)}}IS.Mode={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6};class RS extends dS{init(){this.propertyType=CM.PRIMITIVE_TARGET}getDefaults(){return Object.assign(super.getDefaults(),{attributes:{}})}getAttribute(t){return this.getRefMap("attributes",t)}setAttribute(t,e){return this.setRefMap("attributes",t,e,{usage:RM.ARRAY_BUFFER})}listAttributes(){return this.listRefMapValues("attributes")}listSemantics(){return this.listRefMapKeys("attributes")}}function kS(){return kS=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var i=arguments[e];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(t[n]=i[n])}return t},kS.apply(this,arguments)}class PS extends pS{init(){this.propertyType=CM.SCENE}getDefaults(){return Object.assign(super.getDefaults(),{children:[]})}copy(t,e=cS){if(e===cS)throw new Error("Scene cannot be copied.");return super.copy(t,e)}addChild(t){t.u&&t.u.removeChild(t),this.addRef("children",t),t.h.add(this);const e=this[MM].children;return e[e.length-1].addEventListener("dispose",(()=>t.h.delete(this))),this}removeChild(t){return this.removeRef("children",t)}listChildren(){return this.listRefs("children")}traverse(t){for(const e of this.listChildren())e.traverse(t);return this}}class DS extends pS{init(){this.propertyType=CM.SKIN}getDefaults(){return Object.assign(super.getDefaults(),{skeleton:null,inverseBindMatrices:null,joints:[]})}getSkeleton(){return this.getRef("skeleton")}setSkeleton(t){return this.setRef("skeleton",t)}getInverseBindMatrices(){return this.getRef("inverseBindMatrices")}setInverseBindMatrices(t){return this.setRef("inverseBindMatrices",t,{usage:RM.INVERSE_BIND_MATRICES})}addJoint(t){return this.addRef("joints",t)}removeJoint(t){return this.removeRef("joints",t)}listJoints(){return this.listRefs("joints")}}class LS extends pS{init(){this.propertyType=CM.TEXTURE}getDefaults(){return Object.assign(super.getDefaults(),{image:null,mimeType:"",uri:""})}getMimeType(){return this.get("mimeType")||jM.extensionToMimeType(XM.extension(this.get("uri")))}setMimeType(t){return this.set("mimeType",t)}getURI(){return this.get("uri")}setURI(t){this.set("uri",t);const e=jM.extensionToMimeType(XM.extension(t));return e&&this.set("mimeType",e),this}getImage(){return this.get("image")}setImage(t){return this.set("image",GM.assertView(t))}getSize(){const t=this.get("image");return t?jM.getSize(t,this.getMimeType()):null}}class OS extends pS{init(){this.propertyType=CM.ROOT}getDefaults(){return Object.assign(super.getDefaults(),{asset:{generator:`glTF-Transform ${TM}`,version:"2.0"},defaultScene:null,accessors:[],animations:[],buffers:[],cameras:[],materials:[],meshes:[],nodes:[],scenes:[],skins:[],textures:[]})}constructor(t){super(t),this.l=new Set,t.addEventListener("node:create",(t=>{this.g(t.target)}))}clone(){throw new Error("Root cannot be cloned.")}copy(t,e=cS){if(e===cS)throw new Error("Root cannot be copied.");this.set("asset",kS({},t.get("asset"))),this.setName(t.getName()),this.setExtras(kS({},t.getExtras())),this.setDefaultScene(t.getDefaultScene()?e(t.getDefaultScene()):null);for(const i of t.listRefMapKeys("extensions")){const n=t.getExtension(i);this.setExtension(i,e(n))}return this}g(t){return t instanceof PS?this.addRef("scenes",t):t instanceof CS?this.addRef("nodes",t):t instanceof xS?this.addRef("cameras",t):t instanceof DS?this.addRef("skins",t):t instanceof AS?this.addRef("meshes",t):t instanceof TS?this.addRef("materials",t):t instanceof LS?this.addRef("textures",t):t instanceof fS?this.addRef("animations",t):t instanceof mS?this.addRef("accessors",t):t instanceof yS&&this.addRef("buffers",t),this}getAsset(){return this.get("asset")}listExtensionsUsed(){return Array.from(this.l)}listExtensionsRequired(){return this.listExtensionsUsed().filter((t=>t.isRequired()))}p(t){return this.l.add(t),this}m(t){return this.l.delete(t),this}listScenes(){return this.listRefs("scenes")}setDefaultScene(t){return this.setRef("defaultScene",t)}getDefaultScene(){return this.getRef("defaultScene")}listNodes(){return this.listRefs("nodes")}listCameras(){return this.listRefs("cameras")}listSkins(){return this.listRefs("skins")}listMeshes(){return this.listRefs("meshes")}listMaterials(){return this.listRefs("materials")}listTextures(){return this.listRefs("textures")}listAnimations(){return this.listRefs("animations")}listAccessors(){return this.listRefs("accessors")}listBuffers(){return this.listRefs("buffers")}}class NS{static fromGraph(t){return NS.v.get(t)||null}constructor(){this.T=new yM,this.S=new OS(this.T),this.M=KM.DEFAULT_INSTANCE,NS.v.set(this.T,this)}getRoot(){return this.S}getGraph(){return this.T}getLogger(){return this.M}setLogger(t){return this.M=t,this}clone(){return(new NS).setLogger(this.M).merge(this)}merge(t){for(const e of t.getRoot().listExtensionsUsed()){const t=this.createExtension(e.constructor);e.isRequired()&&t.setRequired(!0)}const e=new Set,i=new Map;e.add(t.S),i.set(t.S,this.S);for(const n of t.T.listEdges())for(const t of[n.getParent(),n.getChild()]){if(e.has(t))continue;let n;n=t.propertyType===CM.TEXTURE_INFO?t:new(0,t.constructor)(this.T),i.set(t,n),e.add(t)}const n=t=>{const e=i.get(t);if(!e)throw new Error("Could resolve property.");return e};for(const t of e){const e=i.get(t);if(!e)throw new Error("Could resolve property.");e.propertyType!==CM.TEXTURE_INFO&&e.copy(t,n)}return this}async transform(...t){const e=t.map((t=>t.name));for(const i of t)await i(this,{stack:e});return this}createExtension(t){const e=t.EXTENSION_NAME;return this.getRoot().listExtensionsUsed().find((t=>t.extensionName===e))||new t(this)}createScene(t=""){return new PS(this.T,t)}createNode(t=""){return new CS(this.T,t)}createCamera(t=""){return new xS(this.T,t)}createSkin(t=""){return new DS(this.T,t)}createMesh(t=""){return new AS(this.T,t)}createPrimitive(){return new IS(this.T)}createPrimitiveTarget(t=""){return new RS(this.T,t)}createMaterial(t=""){return new TS(this.T,t)}createTexture(t=""){return new LS(this.T,t)}createAnimation(t=""){return new fS(this.T,t)}createAnimationChannel(t=""){return new gS(this.T,t)}createAnimationSampler(t=""){return new vS(this.T,t)}createAccessor(t="",e=null){return e||(e=this.getRoot().listBuffers()[0]),new mS(this.T,t).setBuffer(e)}createBuffer(t=""){return new yS(this.T,t)}}NS.v=new WeakMap;class BS{constructor(t){this.extensionName="",this.prereadTypes=[],this.prewriteTypes=[],this.readDependencies=[],this.writeDependencies=[],this.document=void 0,this.required=!1,this.properties=new Set,this.I=void 0,this.document=t,t.getRoot().p(this),this.I=t=>{const e=t,i=e.target;i instanceof bS&&i.extensionName===this.extensionName&&("node:create"===e.type&&this.N(i),"node:dispose"===e.type&&this.O(i))};const e=t.getGraph();e.addEventListener("node:create",this.I),e.addEventListener("node:dispose",this.I)}dispose(){this.document.getRoot().m(this);const t=this.document.getGraph();t.removeEventListener("node:create",this.I),t.removeEventListener("node:dispose",this.I);for(const t of this.properties)t.dispose()}static register(){}isRequired(){return this.required}setRequired(t){return this.required=t,this}listProperties(){return Array.from(this.properties)}N(t){return this.properties.add(t),this}O(t){return this.properties.delete(t),this}install(t,e){return this}preread(t,e){return this}prewrite(t,e){return this}}BS.EXTENSION_NAME=void 0;class zS{constructor(t){this.jsonDoc=void 0,this.buffers=[],this.bufferViews=[],this.bufferViewBuffers=[],this.accessors=[],this.textures=[],this.textureInfos=new Map,this.materials=[],this.meshes=[],this.cameras=[],this.nodes=[],this.skins=[],this.animations=[],this.scenes=[],this.jsonDoc=t}setTextureInfo(t,e){this.textureInfos.set(t,e),void 0!==e.texCoord&&t.setTexCoord(e.texCoord),void 0!==e.extras&&t.setExtras(e.extras);const i=this.jsonDoc.json.textures[e.index];if(void 0===i.sampler)return;const n=this.jsonDoc.json.samplers[i.sampler];void 0!==n.magFilter&&t.setMagFilter(n.magFilter),void 0!==n.minFilter&&t.setMinFilter(n.minFilter),void 0!==n.wrapS&&t.setWrapS(n.wrapS),void 0!==n.wrapT&&t.setWrapT(n.wrapT)}}const US={logger:KM.DEFAULT_INSTANCE,extensions:[],dependencies:{}};class FS{static read(t,e=US){const i=kS({},US,e),{json:n}=t,s=(new NS).setLogger(i.logger);this.validate(t,i);const r=new zS(t),a=n.asset,o=s.getRoot().getAsset();a.copyright&&(o.copyright=a.copyright),a.extras&&(o.extras=a.extras),void 0!==n.extras&&s.getRoot().setExtras(kS({},n.extras));const h=n.extensionsUsed||[],l=n.extensionsRequired||[];for(const t of i.extensions)if(h.includes(t.EXTENSION_NAME)){const e=s.createExtension(t).setRequired(l.includes(t.EXTENSION_NAME));for(const t of e.readDependencies)e.install(t,i.dependencies[t])}const c=n.buffers||[];s.getRoot().listExtensionsUsed().filter((t=>t.prereadTypes.includes(CM.BUFFER))).forEach((t=>t.preread(r,CM.BUFFER))),r.buffers=c.map((t=>{const e=s.createBuffer(t.name);return t.extras&&e.setExtras(t.extras),t.uri&&0!==t.uri.indexOf("__")&&e.setURI(t.uri),e})),r.bufferViewBuffers=(n.bufferViews||[]).map(((e,i)=>{if(!r.bufferViews[i]){const n=t.json.buffers[e.buffer];r.bufferViews[i]=GM.toView(n.uri?t.resources[n.uri]:t.resources[AM],e.byteOffset||0,e.byteLength)}return r.buffers[e.buffer]}));const u=n.accessors||[];r.accessors=u.map((t=>{const e=s.createAccessor(t.name,r.bufferViewBuffers[t.bufferView]).setType(t.type);return t.extras&&e.setExtras(t.extras),void 0!==t.normalized&&e.setNormalized(t.normalized),void 0===t.bufferView||e.setArray(GS(t,r)),e}));const d=n.images||[],p=n.textures||[];s.getRoot().listExtensionsUsed().filter((t=>t.prereadTypes.includes(CM.TEXTURE))).forEach((t=>t.preread(r,CM.TEXTURE))),r.textures=d.map((e=>{const i=s.createTexture(e.name);if(e.extras&&i.setExtras(e.extras),void 0!==e.bufferView){const s=n.bufferViews[e.bufferView],r=t.json.buffers[s.buffer],a=s.byteOffset||0,o=(r.uri?t.resources[r.uri]:t.resources[AM]).slice(a,a+s.byteLength);i.setImage(o)}else void 0!==e.uri&&(i.setImage(t.resources[e.uri]),0!==e.uri.indexOf("__")&&i.setURI(e.uri));if(void 0!==e.mimeType)i.setMimeType(e.mimeType);else if(e.uri){const t=XM.extension(e.uri);i.setMimeType(jM.extensionToMimeType(t))}return i})),r.materials=(n.materials||[]).map((t=>{const e=s.createMaterial(t.name);t.extras&&e.setExtras(t.extras),void 0!==t.alphaMode&&e.setAlphaMode(t.alphaMode),void 0!==t.alphaCutoff&&e.setAlphaCutoff(t.alphaCutoff),void 0!==t.doubleSided&&e.setDoubleSided(t.doubleSided);const i=t.pbrMetallicRoughness||{};if(void 0!==i.baseColorFactor&&e.setBaseColorFactor(i.baseColorFactor),void 0!==t.emissiveFactor&&e.setEmissiveFactor(t.emissiveFactor),void 0!==i.metallicFactor&&e.setMetallicFactor(i.metallicFactor),void 0!==i.roughnessFactor&&e.setRoughnessFactor(i.roughnessFactor),void 0!==i.baseColorTexture){const t=i.baseColorTexture;e.setBaseColorTexture(r.textures[p[t.index].source]),r.setTextureInfo(e.getBaseColorTextureInfo(),t)}if(void 0!==t.emissiveTexture){const i=t.emissiveTexture;e.setEmissiveTexture(r.textures[p[i.index].source]),r.setTextureInfo(e.getEmissiveTextureInfo(),i)}if(void 0!==t.normalTexture){const i=t.normalTexture;e.setNormalTexture(r.textures[p[i.index].source]),r.setTextureInfo(e.getNormalTextureInfo(),i),void 0!==t.normalTexture.scale&&e.setNormalScale(t.normalTexture.scale)}if(void 0!==t.occlusionTexture){const i=t.occlusionTexture;e.setOcclusionTexture(r.textures[p[i.index].source]),r.setTextureInfo(e.getOcclusionTextureInfo(),i),void 0!==t.occlusionTexture.strength&&e.setOcclusionStrength(t.occlusionTexture.strength)}if(void 0!==i.metallicRoughnessTexture){const t=i.metallicRoughnessTexture;e.setMetallicRoughnessTexture(r.textures[p[t.index].source]),r.setTextureInfo(e.getMetallicRoughnessTextureInfo(),t)}return e}));const m=n.meshes||[];s.getRoot().listExtensionsUsed().filter((t=>t.prereadTypes.includes(CM.PRIMITIVE))).forEach((t=>t.preread(r,CM.PRIMITIVE))),r.meshes=m.map((t=>{const e=s.createMesh(t.name);return t.extras&&e.setExtras(t.extras),void 0!==t.weights&&e.setWeights(t.weights),(t.primitives||[]).forEach((i=>{const n=s.createPrimitive();i.extras&&n.setExtras(i.extras),void 0!==i.material&&n.setMaterial(r.materials[i.material]),void 0!==i.mode&&n.setMode(i.mode);for(const[t,e]of Object.entries(i.attributes||{}))n.setAttribute(t,r.accessors[e]);void 0!==i.indices&&n.setIndices(r.accessors[i.indices]);const a=t.extras&&t.extras.targetNames||[];(i.targets||[]).forEach(((t,e)=>{const i=a[e]||e.toString(),o=s.createPrimitiveTarget(i);for(const[e,i]of Object.entries(t))o.setAttribute(e,r.accessors[i]);n.addTarget(o)})),e.addPrimitive(n)})),e})),r.cameras=(n.cameras||[]).map((t=>{const e=s.createCamera(t.name).setType(t.type);if(t.extras&&e.setExtras(t.extras),t.type===xS.Type.PERSPECTIVE){const i=t.perspective;e.setYFov(i.yfov),e.setZNear(i.znear),void 0!==i.zfar&&e.setZFar(i.zfar),void 0!==i.aspectRatio&&e.setAspectRatio(i.aspectRatio)}else{const i=t.orthographic;e.setZNear(i.znear).setZFar(i.zfar).setXMag(i.xmag).setYMag(i.ymag)}return e}));const f=n.nodes||[];s.getRoot().listExtensionsUsed().filter((t=>t.prereadTypes.includes(CM.NODE))).forEach((t=>t.preread(r,CM.NODE))),r.nodes=f.map((t=>{const e=s.createNode(t.name);if(t.extras&&e.setExtras(t.extras),void 0!==t.translation&&e.setTranslation(t.translation),void 0!==t.rotation&&e.setRotation(t.rotation),void 0!==t.scale&&e.setScale(t.scale),void 0!==t.matrix){const i=[0,0,0],n=[0,0,0,1],s=[1,1,1];QM.decompose(t.matrix,i,n,s),e.setTranslation(i),e.setRotation(n),e.setScale(s)}return void 0!==t.weights&&e.setWeights(t.weights),e})),r.skins=(n.skins||[]).map((t=>{const e=s.createSkin(t.name);t.extras&&e.setExtras(t.extras),void 0!==t.inverseBindMatrices&&e.setInverseBindMatrices(r.accessors[t.inverseBindMatrices]),void 0!==t.skeleton&&e.setSkeleton(r.nodes[t.skeleton]);for(const i of t.joints)e.addJoint(r.nodes[i]);return e})),f.map(((t,e)=>{const i=r.nodes[e];(t.children||[]).forEach((t=>i.addChild(r.nodes[t]))),void 0!==t.mesh&&i.setMesh(r.meshes[t.mesh]),void 0!==t.camera&&i.setCamera(r.cameras[t.camera]),void 0!==t.skin&&i.setSkin(r.skins[t.skin])})),r.animations=(n.animations||[]).map((t=>{const e=s.createAnimation(t.name);t.extras&&e.setExtras(t.extras);const i=(t.samplers||[]).map((t=>{const i=s.createAnimationSampler().setInput(r.accessors[t.input]).setOutput(r.accessors[t.output]).setInterpolation(t.interpolation||vS.Interpolation.LINEAR);return t.extras&&i.setExtras(t.extras),e.addSampler(i),i}));return(t.channels||[]).forEach((t=>{const n=s.createAnimationChannel().setSampler(i[t.sampler]).setTargetPath(t.target.path);void 0!==t.target.node&&n.setTargetNode(r.nodes[t.target.node]),t.extras&&n.setExtras(t.extras),e.addChannel(n)})),e}));const g=n.scenes||[];return s.getRoot().listExtensionsUsed().filter((t=>t.prereadTypes.includes(CM.SCENE))).forEach((t=>t.preread(r,CM.SCENE))),r.scenes=g.map((t=>{const e=s.createScene(t.name);return t.extras&&e.setExtras(t.extras),(t.nodes||[]).map((t=>r.nodes[t])).forEach((t=>e.addChild(t))),e})),void 0!==n.scene&&s.getRoot().setDefaultScene(r.scenes[n.scene]),s.getRoot().listExtensionsUsed().forEach((t=>t.read(r))),u.forEach(((t,e)=>{const i=r.accessors[e],n=!!t.sparse,s=!t.bufferView&&!i.getArray();(n||s)&&i.setSparse(!0).setArray(function(t,e){const i=DM[t.componentType],n=mS.getElementSize(t.type);let s;s=void 0!==t.bufferView?GS(t,e):new i(t.count*n);const r=t.sparse;if(!r)return s;const a=r.count,o=kS({},t,r.indices,{count:a,type:"SCALAR"}),h=kS({},t,r.values,{count:a}),l=GS(o,e),c=GS(h,e);for(let t=0;t<o.count;t++)for(let e=0;e<n;e++)s[l[t]*n+e]=c[t*n+e];return s}(t,r))})),s}static validate(t,e){const i=t.json;if("2.0"!==i.asset.version)throw new Error(`Unsupported glTF version, "${i.asset.version}".`);if(i.extensionsRequired)for(const t of i.extensionsRequired)if(!e.extensions.find((e=>e.EXTENSION_NAME===t)))throw new Error(`Missing required extension, "${t}".`);if(i.extensionsUsed)for(const t of i.extensionsUsed)e.extensions.find((e=>e.EXTENSION_NAME===t))||e.logger.warn(`Missing optional extension, "${t}".`)}}function GS(t,e){const i=e.bufferViews[t.bufferView],n=e.jsonDoc.json.bufferViews[t.bufferView],s=DM[t.componentType],r=mS.getElementSize(t.type),a=s.BYTES_PER_ELEMENT;if(void 0!==n.byteStride&&n.byteStride!==r*a)return function(t,e){const i=e.bufferViews[t.bufferView],n=e.jsonDoc.json.bufferViews[t.bufferView],s=DM[t.componentType],r=mS.getElementSize(t.type),a=s.BYTES_PER_ELEMENT,o=t.byteOffset||0,h=new s(t.count*r),l=new DataView(i.buffer,i.byteOffset,i.byteLength),c=n.byteStride;for(let e=0;e<t.count;e++)for(let i=0;i<r;i++){const n=o+e*c+i*a;let s;switch(t.componentType){case mS.ComponentType.FLOAT:s=l.getFloat32(n,!0);break;case mS.ComponentType.UNSIGNED_INT:s=l.getUint32(n,!0);break;case mS.ComponentType.UNSIGNED_SHORT:s=l.getUint16(n,!0);break;case mS.ComponentType.UNSIGNED_BYTE:s=l.getUint8(n);break;case mS.ComponentType.SHORT:s=l.getInt16(n,!0);break;case mS.ComponentType.BYTE:s=l.getInt8(n);break;default:throw new Error(`Unexpected componentType "${t.componentType}".`)}h[e*r+i]=s}return h}(t,e);const o=i.byteOffset+(t.byteOffset||0);return new s(i.buffer.slice(o,o+t.count*r*a))}var VS;!function(t){t[t.ARRAY_BUFFER=34962]="ARRAY_BUFFER",t[t.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER"}(VS||(VS={}));class HS{constructor(t,e,i){this.C=void 0,this.jsonDoc=void 0,this.options=void 0,this.accessorIndexMap=new Map,this.animationIndexMap=new Map,this.bufferIndexMap=new Map,this.cameraIndexMap=new Map,this.skinIndexMap=new Map,this.materialIndexMap=new Map,this.meshIndexMap=new Map,this.nodeIndexMap=new Map,this.imageIndexMap=new Map,this.textureDefIndexMap=new Map,this.textureInfoDefMap=new Map,this.samplerDefIndexMap=new Map,this.sceneIndexMap=new Map,this.imageBufferViews=[],this.otherBufferViews=new Map,this.otherBufferViewsIndexMap=new Map,this.extensionData={},this.bufferURIGenerator=void 0,this.imageURIGenerator=void 0,this.logger=void 0,this.F=new Map,this.accessorUsageGroupedByParent=new Set(["ARRAY_BUFFER"]),this.accessorParents=new Map,this.C=t,this.jsonDoc=e,this.options=i;const n=t.getRoot(),s=n.listBuffers().length,r=n.listTextures().length;this.bufferURIGenerator=new jS(s>1,(()=>i.basename||"buffer")),this.imageURIGenerator=new jS(r>1,(e=>function(t,e){const i=t.getGraph().listParentEdges(e).find((e=>e.getParent()!==t.getRoot()));return i?i.getName().replace(/texture$/i,""):""}(t,e)||i.basename||"texture")),this.logger=t.getLogger()}createTextureInfoDef(t,e){const i={magFilter:e.getMagFilter()||void 0,minFilter:e.getMinFilter()||void 0,wrapS:e.getWrapS(),wrapT:e.getWrapT()},n=JSON.stringify(i);this.samplerDefIndexMap.has(n)||(this.samplerDefIndexMap.set(n,this.jsonDoc.json.samplers.length),this.jsonDoc.json.samplers.push(i));const s={source:this.imageIndexMap.get(t),sampler:this.samplerDefIndexMap.get(n)},r=JSON.stringify(s);this.textureDefIndexMap.has(r)||(this.textureDefIndexMap.set(r,this.jsonDoc.json.textures.length),this.jsonDoc.json.textures.push(s));const a={index:this.textureDefIndexMap.get(r)};return 0!==e.getTexCoord()&&(a.texCoord=e.getTexCoord()),Object.keys(e.getExtras()).length>0&&(a.extras=e.getExtras()),this.textureInfoDefMap.set(e,a),a}createPropertyDef(t){const e={};return t.getName()&&(e.name=t.getName()),Object.keys(t.getExtras()).length>0&&(e.extras=t.getExtras()),e}createAccessorDef(t){const e=this.createPropertyDef(t);return e.type=t.getType(),e.componentType=t.getComponentType(),e.count=t.getCount(),this.C.getGraph().listParentEdges(t).some((t=>"attributes"===t.getName()&&"POSITION"===t.getAttributes().key||"input"===t.getName()))&&(e.max=t.getMax([]).map(Math.fround),e.min=t.getMin([]).map(Math.fround)),t.getNormalized()&&(e.normalized=t.getNormalized()),e}createImageData(t,e,i){if(this.options.format===PM.GLB)this.imageBufferViews.push(e),t.bufferView=this.jsonDoc.json.bufferViews.length,this.jsonDoc.json.bufferViews.push({buffer:0,byteOffset:-1,byteLength:e.byteLength});else{const n=jM.mimeTypeToExtension(i.getMimeType());t.uri=this.imageURIGenerator.createURI(i,n),this.jsonDoc.resources[t.uri]=e}}getAccessorUsage(t){const e=this.F.get(t);if(e)return e;if(t.getSparse())return RM.SPARSE;for(const e of this.C.getGraph().listParentEdges(t)){const{usage:t}=e.getAttributes();if(t)return t;e.getParent().propertyType!==CM.ROOT&&this.logger.warn(`Missing attribute ".usage" on edge, "${e.getName()}".`)}return RM.OTHER}addAccessorToUsageGroup(t,e){const i=this.F.get(t);if(i&&i!==e)throw new Error(`Accessor with usage "${i}" cannot be reused as "${e}".`);return this.F.set(t,e),this}listAccessorUsageGroups(){const t={};for(const[e,i]of Array.from(this.F.entries()))t[i]=t[i]||[],t[i].push(e);return t}}HS.BufferViewTarget=VS,HS.BufferViewUsage=RM,HS.USAGE_TO_TARGET={[RM.ARRAY_BUFFER]:VS.ARRAY_BUFFER,[RM.ELEMENT_ARRAY_BUFFER]:VS.ELEMENT_ARRAY_BUFFER};class jS{constructor(t,e){this.multiple=void 0,this.basename=void 0,this.counter={},this.multiple=t,this.basename=e}createURI(t,e){if(t.getURI())return t.getURI();if(this.multiple){const i=this.basename(t);return this.counter[i]=this.counter[i]||1,`${i}_${this.counter[i]++}.${e}`}return`${this.basename(t)}.${e}`}}const{BufferViewUsage:WS}=HS,{UNSIGNED_INT:XS,UNSIGNED_SHORT:qS,UNSIGNED_BYTE:YS}=mS.ComponentType;class JS{static write(t,e){const i=t.getRoot(),n={asset:kS({generator:`glTF-Transform ${TM}`},i.getAsset()),extras:kS({},i.getExtras())},s={json:n,resources:{}},r=new HS(t,s,e),a=e.logger||KM.DEFAULT_INSTANCE,o=new Set(e.extensions.map((t=>t.EXTENSION_NAME))),h=t.getRoot().listExtensionsUsed().filter((t=>o.has(t.extensionName))),l=t.getRoot().listExtensionsRequired().filter((t=>o.has(t.extensionName)));h.length<t.getRoot().listExtensionsUsed().length&&a.warn("Some extensions were not registered for I/O, and will not be written.");for(const t of h)for(const i of t.writeDependencies)t.install(i,e.dependencies[i]);function c(t,e,i,s){const a=[];let o=0;for(const e of t){const t=r.createAccessorDef(e);t.bufferView=n.bufferViews.length;const i=e.getArray(),s=GM.pad(GM.toView(i));t.byteOffset=o,o+=s.byteLength,a.push(s),r.accessorIndexMap.set(e,n.accessors.length),n.accessors.push(t)}const h={buffer:e,byteOffset:i,byteLength:GM.concat(a).byteLength};return s&&(h.target=s),n.bufferViews.push(h),{buffers:a,byteLength:o}}function u(t,e,i){const s=t[0].getCount();let a=0;for(const e of t){const t=r.createAccessorDef(e);t.bufferView=n.bufferViews.length,t.byteOffset=a;const i=e.getElementSize(),s=e.getComponentSize();a+=GM.padNumber(i*s),r.accessorIndexMap.set(e,n.accessors.length),n.accessors.push(t)}const o=s*a,h=new ArrayBuffer(o),l=new DataView(h);for(let e=0;e<s;e++){let i=0;for(const n of t){const t=n.getElementSize(),s=n.getComponentSize(),r=n.getComponentType(),o=n.getArray();for(let n=0;n<t;n++){const h=e*a+i+n*s,c=o[e*t+n];switch(r){case mS.ComponentType.FLOAT:l.setFloat32(h,c,!0);break;case mS.ComponentType.BYTE:l.setInt8(h,c);break;case mS.ComponentType.SHORT:l.setInt16(h,c,!0);break;case mS.ComponentType.UNSIGNED_BYTE:l.setUint8(h,c);break;case mS.ComponentType.UNSIGNED_SHORT:l.setUint16(h,c,!0);break;case mS.ComponentType.UNSIGNED_INT:l.setUint32(h,c,!0);break;default:throw new Error("Unexpected component type: "+r)}}i+=GM.padNumber(t*s)}}return n.bufferViews.push({buffer:e,byteOffset:i,byteLength:o,byteStride:a,target:HS.BufferViewTarget.ARRAY_BUFFER}),{byteLength:o,buffers:[new Uint8Array(h)]}}function d(t,e,i){const s=[];let o=0;const h=new Map;let l=-1/0;for(const e of t){const t=r.createAccessorDef(e);n.accessors.push(t),r.accessorIndexMap.set(e,n.accessors.length-1);const i=[],s=[],o=[],c=new Array(e.getElementSize()).fill(0);for(let t=0,n=e.getCount();t<n;t++)if(e.getElement(t,o),!QM.eq(o,c,0)){l=Math.max(t,l),i.push(t);for(let t=0;t<o.length;t++)s.push(o[t])}const u=i.length,d={accessorDef:t,count:u};if(h.set(e,d),0===u)continue;if(u>e.getCount()/3){const t=(100*i.length/e.getCount()).toFixed(1);a.warn(`Sparse accessor with many non-zero elements (${t}%) may increase file size.`)}const p=DM[e.getComponentType()];d.indices=i,d.values=new p(s)}if(!Number.isFinite(l))return{buffers:s,byteLength:o};const c=l<255?Uint8Array:l<65535?Uint16Array:Uint32Array,u=l<255?YS:l<65535?qS:XS,d={buffer:e,byteOffset:i+o,byteLength:0};for(const e of t){const t=h.get(e);if(0===t.count)continue;t.indicesByteOffset=d.byteLength;const i=GM.pad(GM.toView(new c(t.indices)));s.push(i),o+=i.byteLength,d.byteLength+=i.byteLength}n.bufferViews.push(d);const p=n.bufferViews.length-1,m={buffer:e,byteOffset:i+o,byteLength:0};for(const e of t){const t=h.get(e);if(0===t.count)continue;t.valuesByteOffset=m.byteLength;const i=GM.pad(GM.toView(t.values));s.push(i),o+=i.byteLength,m.byteLength+=i.byteLength}n.bufferViews.push(m);const f=n.bufferViews.length-1;for(const e of t){const t=h.get(e);0!==t.count&&(t.accessorDef.sparse={count:t.count,indices:{bufferView:p,byteOffset:t.indicesByteOffset,componentType:u},values:{bufferView:f,byteOffset:t.valuesByteOffset}})}return{buffers:s,byteLength:o}}const p=new Map;for(const e of t.getGraph().listEdges()){if(e.getParent()===i)continue;const t=e.getChild();if(t instanceof mS){const i=p.get(t)||[];i.push(e),p.set(t,i)}}if(n.accessors=[],n.bufferViews=[],n.samplers=[],n.textures=[],n.images=i.listTextures().map(((t,e)=>{const i=r.createPropertyDef(t);t.getMimeType()&&(i.mimeType=t.getMimeType());const n=t.getImage();return n&&r.createImageData(i,n,t),r.imageIndexMap.set(t,e),i})),h.filter((t=>t.prewriteTypes.includes(CM.ACCESSOR))).forEach((t=>t.prewrite(r,CM.ACCESSOR))),i.listAccessors().forEach((t=>{const e=r.accessorUsageGroupedByParent,i=r.accessorParents;if(r.accessorIndexMap.has(t))return;const n=p.get(t)||[],s=r.getAccessorUsage(t);if(r.addAccessorToUsageGroup(t,s),e.has(s)){const e=n[0].getParent(),s=i.get(e)||new Set;s.add(t),i.set(e,s)}})),h.filter((t=>t.prewriteTypes.includes(CM.BUFFER))).forEach((t=>t.prewrite(r,CM.BUFFER))),(i.listAccessors().length>0||i.listTextures().length>0||r.otherBufferViews.size>0)&&0===i.listBuffers().length)throw new Error("Buffer required for Document resources, but none was found.");n.buffers=[],i.listBuffers().forEach(((t,i)=>{const a=r.createPropertyDef(t),o=r.accessorUsageGroupedByParent,h=r.accessorParents,l=t.listParents().filter((t=>t instanceof mS)),p=new Set(l),m=[],f=n.buffers.length;let g=0;const v=r.listAccessorUsageGroups();for(const t in v)if(o.has(t))for(const i of Array.from(h.values())){const n=Array.from(i).filter((t=>p.has(t))).filter((e=>r.getAccessorUsage(e)===t));if(n.length)if(t!==WS.ARRAY_BUFFER||e.vertexLayout===IM.INTERLEAVED){const e=t===WS.ARRAY_BUFFER?u(n,f,g):c(n,f,g);g+=e.byteLength,m.push(...e.buffers)}else for(const t of n){const e=u([t],f,g);g+=e.byteLength,m.push(...e.buffers)}}else{const e=v[t].filter((t=>p.has(t)));if(!e.length)continue;const i=t===WS.ELEMENT_ARRAY_BUFFER?HS.BufferViewTarget.ELEMENT_ARRAY_BUFFER:void 0,n=t===WS.SPARSE?d(e,f,g):c(e,f,g,i);g+=n.byteLength,m.push(...n.buffers)}if(r.imageBufferViews.length&&0===i)for(let t=0;t<r.imageBufferViews.length;t++)if(n.bufferViews[n.images[t].bufferView].byteOffset=g,g+=r.imageBufferViews[t].byteLength,m.push(r.imageBufferViews[t]),g%8){const t=8-g%8;g+=t,m.push(new Uint8Array(t))}if(r.otherBufferViews.has(t))for(const e of r.otherBufferViews.get(t))n.bufferViews.push({buffer:f,byteOffset:g,byteLength:e.byteLength}),r.otherBufferViewsIndexMap.set(e,n.bufferViews.length-1),g+=e.byteLength,m.push(e);if(g){let i;e.format===PM.GLB?i=AM:(i=r.bufferURIGenerator.createURI(t,"bin"),a.uri=i),a.byteLength=g,s.resources[i]=GM.concat(m)}n.buffers.push(a),r.bufferIndexMap.set(t,i)})),i.listAccessors().find((t=>!t.getBuffer()))&&a.warn("Skipped writing one or more Accessors: no Buffer assigned."),n.materials=i.listMaterials().map(((t,e)=>{const i=r.createPropertyDef(t);if(t.getAlphaMode()!==TS.AlphaMode.OPAQUE&&(i.alphaMode=t.getAlphaMode()),t.getAlphaMode()===TS.AlphaMode.MASK&&(i.alphaCutoff=t.getAlphaCutoff()),t.getDoubleSided()&&(i.doubleSided=!0),i.pbrMetallicRoughness={},QM.eq(t.getBaseColorFactor(),[1,1,1,1])||(i.pbrMetallicRoughness.baseColorFactor=t.getBaseColorFactor()),QM.eq(t.getEmissiveFactor(),[0,0,0])||(i.emissiveFactor=t.getEmissiveFactor()),1!==t.getRoughnessFactor()&&(i.pbrMetallicRoughness.roughnessFactor=t.getRoughnessFactor()),1!==t.getMetallicFactor()&&(i.pbrMetallicRoughness.metallicFactor=t.getMetallicFactor()),t.getBaseColorTexture()){const e=t.getBaseColorTexture(),n=t.getBaseColorTextureInfo();i.pbrMetallicRoughness.baseColorTexture=r.createTextureInfoDef(e,n)}if(t.getEmissiveTexture()){const e=t.getEmissiveTexture(),n=t.getEmissiveTextureInfo();i.emissiveTexture=r.createTextureInfoDef(e,n)}if(t.getNormalTexture()){const e=t.getNormalTexture(),n=t.getNormalTextureInfo(),s=r.createTextureInfoDef(e,n);1!==t.getNormalScale()&&(s.scale=t.getNormalScale()),i.normalTexture=s}if(t.getOcclusionTexture()){const e=t.getOcclusionTexture(),n=t.getOcclusionTextureInfo(),s=r.createTextureInfoDef(e,n);1!==t.getOcclusionStrength()&&(s.strength=t.getOcclusionStrength()),i.occlusionTexture=s}if(t.getMetallicRoughnessTexture()){const e=t.getMetallicRoughnessTexture(),n=t.getMetallicRoughnessTextureInfo();i.pbrMetallicRoughness.metallicRoughnessTexture=r.createTextureInfoDef(e,n)}return r.materialIndexMap.set(t,e),i})),n.meshes=i.listMeshes().map(((t,e)=>{const i=r.createPropertyDef(t);let n=null;return i.primitives=t.listPrimitives().map((t=>{const e={attributes:{}};e.mode=t.getMode();const i=t.getMaterial();i&&(e.material=r.materialIndexMap.get(i)),Object.keys(t.getExtras()).length&&(e.extras=t.getExtras());const s=t.getIndices();s&&(e.indices=r.accessorIndexMap.get(s));for(const i of t.listSemantics())e.attributes[i]=r.accessorIndexMap.get(t.getAttribute(i));for(const i of t.listTargets()){const t={};for(const e of i.listSemantics())t[e]=r.accessorIndexMap.get(i.getAttribute(e));e.targets=e.targets||[],e.targets.push(t)}return t.listTargets().length&&!n&&(n=t.listTargets().map((t=>t.getName()))),e})),t.getWeights().length&&(i.weights=t.getWeights()),n&&(i.extras=i.extras||{},i.extras.targetNames=n),r.meshIndexMap.set(t,e),i})),n.cameras=i.listCameras().map(((t,e)=>{const i=r.createPropertyDef(t);if(i.type=t.getType(),i.type===xS.Type.PERSPECTIVE){i.perspective={znear:t.getZNear(),zfar:t.getZFar(),yfov:t.getYFov()};const e=t.getAspectRatio();null!==e&&(i.perspective.aspectRatio=e)}else i.orthographic={znear:t.getZNear(),zfar:t.getZFar(),xmag:t.getXMag(),ymag:t.getYMag()};return r.cameraIndexMap.set(t,e),i})),n.nodes=i.listNodes().map(((t,e)=>{const i=r.createPropertyDef(t);return QM.eq(t.getTranslation(),[0,0,0])||(i.translation=t.getTranslation()),QM.eq(t.getRotation(),[0,0,0,1])||(i.rotation=t.getRotation()),QM.eq(t.getScale(),[1,1,1])||(i.scale=t.getScale()),t.getWeights().length&&(i.weights=t.getWeights()),r.nodeIndexMap.set(t,e),i})),n.skins=i.listSkins().map(((t,e)=>{const i=r.createPropertyDef(t),n=t.getInverseBindMatrices();n&&(i.inverseBindMatrices=r.accessorIndexMap.get(n));const s=t.getSkeleton();return s&&(i.skeleton=r.nodeIndexMap.get(s)),i.joints=t.listJoints().map((t=>r.nodeIndexMap.get(t))),r.skinIndexMap.set(t,e),i})),i.listNodes().forEach(((t,e)=>{const i=n.nodes[e],s=t.getMesh();s&&(i.mesh=r.meshIndexMap.get(s));const a=t.getCamera();a&&(i.camera=r.cameraIndexMap.get(a));const o=t.getSkin();o&&(i.skin=r.skinIndexMap.get(o)),t.listChildren().length>0&&(i.children=t.listChildren().map((t=>r.nodeIndexMap.get(t))))})),n.animations=i.listAnimations().map(((t,e)=>{const i=r.createPropertyDef(t),n=new Map;return i.samplers=t.listSamplers().map(((t,e)=>{const i=r.createPropertyDef(t);return i.input=r.accessorIndexMap.get(t.getInput()),i.output=r.accessorIndexMap.get(t.getOutput()),i.interpolation=t.getInterpolation(),n.set(t,e),i})),i.channels=t.listChannels().map((t=>{const e=r.createPropertyDef(t);return e.sampler=n.get(t.getSampler()),e.target={node:r.nodeIndexMap.get(t.getTargetNode()),path:t.getTargetPath()},e})),r.animationIndexMap.set(t,e),i})),n.scenes=i.listScenes().map(((t,e)=>{const i=r.createPropertyDef(t);return i.nodes=t.listChildren().map((t=>r.nodeIndexMap.get(t))),r.sceneIndexMap.set(t,e),i}));const m=i.getDefaultScene();return m&&(n.scene=i.listScenes().indexOf(m)),n.extensionsUsed=h.map((t=>t.extensionName)),n.extensionsRequired=l.map((t=>t.extensionName)),h.forEach((t=>t.write(r))),function(t){const e=[];for(const i in t){const n=t[i];(Array.isArray(n)&&0===n.length||null===n||""===n||n&&"object"==typeof n&&0===Object.keys(n).length)&&e.push(i)}for(const i of e)delete t[i]}(n),s}}var $S;!function(t){t[t.JSON=1313821514]="JSON",t[t.BIN=5130562]="BIN"}($S||($S={}));class KS{constructor(){this.M=KM.DEFAULT_INSTANCE,this.l=new Set,this.U={},this.P=IM.INTERLEAVED,this.lastReadBytes=0,this.lastWriteBytes=0}setLogger(t){return this.M=t,this}registerExtensions(t){for(const e of t)this.l.add(e),e.register();return this}registerDependencies(t){return Object.assign(this.U,t),this}setVertexLayout(t){return this.P=t,this}async read(t){return await this.readJSON(await this.readAsJSON(t))}async readAsJSON(t){const e=await this.readURI(t,"view");this.lastReadBytes=e.byteLength;const i=ZS(e)?this.L(e):{json:JSON.parse(GM.decodeText(e)),resources:{}};return await this.j(i,this.dirname(t)),this.D(i),i}async readJSON(t){return t=this._(t),this.D(t),FS.read(t,{extensions:Array.from(this.l),dependencies:this.U,logger:this.M})}async binaryToJSON(t){const e=this.L(GM.assertView(t));this.D(e);const i=e.json;if(i.buffers&&i.buffers.some((t=>function(t,e){return void 0!==e.uri&&!(e.uri in t.resources)}(e,t))))throw new Error("Cannot resolve external buffers with binaryToJSON().");if(i.images&&i.images.some((t=>function(t,e){return void 0!==e.uri&&!(e.uri in t.resources)&&void 0===e.bufferView}(e,t))))throw new Error("Cannot resolve external images with binaryToJSON().");return e}async readBinary(t){return this.readJSON(await this.binaryToJSON(GM.assertView(t)))}async writeJSON(t,e={}){if(e.format===PM.GLB&&t.getRoot().listBuffers().length>1)throw new Error("GLB must have 01 buffers.");return JS.write(t,{format:e.format||PM.GLTF,basename:e.basename||"",logger:this.M,vertexLayout:this.P,dependencies:kS({},this.U),extensions:Array.from(this.l)})}async writeBinary(t){const{json:e,resources:i}=await this.writeJSON(t,{format:PM.GLB}),n=new Uint32Array([1179937895,2,12]),s=JSON.stringify(e),r=GM.pad(GM.encodeText(s),32),a=GM.toView(new Uint32Array([r.byteLength,1313821514])),o=GM.concat([a,r]);n[n.length-1]+=o.byteLength;const h=Object.values(i)[0];if(!h||!h.byteLength)return GM.concat([GM.toView(n),o]);const l=GM.pad(h,0),c=GM.toView(new Uint32Array([l.byteLength,5130562])),u=GM.concat([c,l]);return n[n.length-1]+=u.byteLength,GM.concat([GM.toView(n),o,u])}async j(t,e){var i=this;const n=[...t.json.images||[],...t.json.buffers||[]].map((async function(n){const s=n.uri;if(!s||s.match(/data:/))return Promise.resolve();t.resources[s]=await i.readURI(i.resolve(e,s),"view"),i.lastReadBytes+=t.resources[s].byteLength}));await Promise.all(n)}D(t){function e(e){if(e.uri)if(e.uri in t.resources)GM.assertView(t.resources[e.uri]);else if(e.uri.match(/data:/)){const i=`__${function(){for(let t=0;t<999;t++){const t=oS();if(!aS.has(t))return aS.add(t),t}return""}()}.${XM.extension(e.uri)}`;t.resources[i]=GM.createBufferFromDataURI(e.uri),e.uri=i}}(t.json.images||[]).forEach((t=>{if(void 0===t.bufferView&&void 0===t.uri)throw new Error("Missing resource URI or buffer view.");e(t)})),(t.json.buffers||[]).forEach(e)}_(t){const{images:e,buffers:i}=t.json;return t={json:kS({},t.json),resources:kS({},t.resources)},e&&(t.json.images=e.map((t=>kS({},t)))),i&&(t.json.buffers=i.map((t=>kS({},t)))),t}L(t){if(!ZS(t))throw new Error("Invalid glTF 2.0 binary.");const e=new Uint32Array(t.buffer,t.byteOffset+12,2);if(e[1]!==$S.JSON)throw new Error("Missing required GLB JSON chunk.");const i=e[0],n=GM.decodeText(GM.toView(t,20,i)),s=JSON.parse(n),r=20+i;if(t.byteLength<=r)return{json:s,resources:{}};const a=new Uint32Array(t.buffer,t.byteOffset+r,2);if(a[1]!==$S.BIN)throw new Error("Expected GLB BIN in second chunk.");const o=GM.toView(t,r+8,a[0]);return{json:s,resources:{[AM]:o}}}}function ZS(t){if(t.byteLength<3*Uint32Array.BYTES_PER_ELEMENT)return!1;const e=new Uint32Array(t.buffer,t.byteOffset,3);return 1179937895===e[0]&&2===e[1]}class QS extends KS{constructor(t=lS.DEFAULT_INIT){super(),this.J=void 0,this.J=t}async readURI(t,e){const i=await fetch(t,this.J);switch(e){case"view":return new Uint8Array(await i.arrayBuffer());case"text":return i.text()}}resolve(t,e){return lS.resolve(t,e)}dirname(t){return lS.dirname(t)}}class tE{constructor(){this.vkFormat=0,this.typeSize=1,this.pixelWidth=0,this.pixelHeight=0,this.pixelDepth=0,this.layerCount=0,this.faceCount=1,this.supercompressionScheme=0,this.levels=[],this.dataFormatDescriptor=[{vendorId:0,descriptorType:0,descriptorBlockSize:0,versionNumber:2,colorModel:0,colorPrimaries:1,transferFunction:2,flags:0,texelBlockDimension:[0,0,0,0],bytesPlane:[0,0,0,0,0,0,0,0],samples:[]}],this.keyValue={},this.globalData=null}}class eE{constructor(t,e,i,n){this._dataView=void 0,this._littleEndian=void 0,this._offset=void 0,this._dataView=new DataView(t.buffer,t.byteOffset+e,i),this._littleEndian=n,this._offset=0}_nextUint8(){const t=this._dataView.getUint8(this._offset);return this._offset+=1,t}_nextUint16(){const t=this._dataView.getUint16(this._offset,this._littleEndian);return this._offset+=2,t}_nextUint32(){const t=this._dataView.getUint32(this._offset,this._littleEndian);return this._offset+=4,t}_nextUint64(){const t=this._dataView.getUint32(this._offset,this._littleEndian)+2**32*this._dataView.getUint32(this._offset+4,this._littleEndian);return this._offset+=8,t}_nextInt32(){const t=this._dataView.getInt32(this._offset,this._littleEndian);return this._offset+=4,t}_nextUint8Array(t){const e=new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+this._offset,t);return this._offset+=t,e}_skip(t){return this._offset+=t,this}_scan(t,e=0){const i=this._offset;let n=0;for(;this._dataView.getUint8(this._offset)!==e&&n<t;)n++,this._offset++;return n<t&&this._offset++,new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+i,n)}}new Uint8Array([0]);const iE=[171,75,84,88,32,50,48,187,13,10,26,10];function nE(t){return"undefined"!=typeof TextDecoder?(new TextDecoder).decode(t):Buffer.from(t).toString("utf8")}function sE(t){const e=new Uint8Array(t.buffer,t.byteOffset,iE.length);if(e[0]!==iE[0]||e[1]!==iE[1]||e[2]!==iE[2]||e[3]!==iE[3]||e[4]!==iE[4]||e[5]!==iE[5]||e[6]!==iE[6]||e[7]!==iE[7]||e[8]!==iE[8]||e[9]!==iE[9]||e[10]!==iE[10]||e[11]!==iE[11])throw new Error("Missing KTX 2.0 identifier.");const i=new tE,n=17*Uint32Array.BYTES_PER_ELEMENT,s=new eE(t,iE.length,n,!0);i.vkFormat=s._nextUint32(),i.typeSize=s._nextUint32(),i.pixelWidth=s._nextUint32(),i.pixelHeight=s._nextUint32(),i.pixelDepth=s._nextUint32(),i.layerCount=s._nextUint32(),i.faceCount=s._nextUint32();const r=s._nextUint32();i.supercompressionScheme=s._nextUint32();const a=s._nextUint32(),o=s._nextUint32(),h=s._nextUint32(),l=s._nextUint32(),c=s._nextUint64(),u=s._nextUint64(),d=new eE(t,iE.length+n,3*r*8,!0);for(let e=0;e<r;e++)i.levels.push({levelData:new Uint8Array(t.buffer,t.byteOffset+d._nextUint64(),d._nextUint64()),uncompressedByteLength:d._nextUint64()});const p=new eE(t,a,o,!0),m={vendorId:p._skip(4)._nextUint16(),descriptorType:p._nextUint16(),versionNumber:p._nextUint16(),descriptorBlockSize:p._nextUint16(),colorModel:p._nextUint8(),colorPrimaries:p._nextUint8(),transferFunction:p._nextUint8(),flags:p._nextUint8(),texelBlockDimension:[p._nextUint8(),p._nextUint8(),p._nextUint8(),p._nextUint8()],bytesPlane:[p._nextUint8(),p._nextUint8(),p._nextUint8(),p._nextUint8(),p._nextUint8(),p._nextUint8(),p._nextUint8(),p._nextUint8()],samples:[]},f=(m.descriptorBlockSize/4-6)/4;for(let t=0;t<f;t++){const e={bitOffset:p._nextUint16(),bitLength:p._nextUint8(),channelType:p._nextUint8(),samplePosition:[p._nextUint8(),p._nextUint8(),p._nextUint8(),p._nextUint8()],sampleLower:-1/0,sampleUpper:1/0};64&e.channelType?(e.sampleLower=p._nextInt32(),e.sampleUpper=p._nextInt32()):(e.sampleLower=p._nextUint32(),e.sampleUpper=p._nextUint32()),m.samples[t]=e}i.dataFormatDescriptor.length=0,i.dataFormatDescriptor.push(m);const g=new eE(t,h,l,!0);for(;g._offset<l;){const t=g._nextUint32(),e=g._scan(t),n=nE(e);if(i.keyValue[n]=g._nextUint8Array(t-e.byteLength-1),n.match(/^ktx/i)){const t=nE(i.keyValue[n]);i.keyValue[n]=t.substring(0,t.lastIndexOf("\0"))}const s=t%4?4-t%4:0;g._skip(s)}if(u<=0)return i;const v=new eE(t,c,u,!0),y=v._nextUint16(),x=v._nextUint16(),b=v._nextUint32(),_=v._nextUint32(),w=v._nextUint32(),M=v._nextUint32(),S=[];for(let t=0;t<r;t++)S.push({imageFlags:v._nextUint32(),rgbSliceByteOffset:v._nextUint32(),rgbSliceByteLength:v._nextUint32(),alphaSliceByteOffset:v._nextUint32(),alphaSliceByteLength:v._nextUint32()});const E=c+v._offset,T=E+b,A=T+_,C=A+w,I=new Uint8Array(t.buffer,t.byteOffset+E,b),R=new Uint8Array(t.buffer,t.byteOffset+T,_),k=new Uint8Array(t.buffer,t.byteOffset+A,w),P=new Uint8Array(t.buffer,t.byteOffset+C,M);return i.globalData={endpointCount:y,selectorCount:x,imageDescs:S,endpointsData:I,selectorsData:R,tablesData:k,extendedData:P},i}const rE="EXT_mesh_gpu_instancing",aE="EXT_meshopt_compression",oE="KHR_draco_mesh_compression",hE="KHR_lights_punctual",lE="KHR_materials_anisotropy",cE="KHR_materials_clearcoat",uE="KHR_materials_emissive_strength",dE="KHR_materials_ior",pE="KHR_materials_iridescence",mE="KHR_materials_pbrSpecularGlossiness",fE="KHR_materials_sheen",gE="KHR_materials_specular",vE="KHR_materials_transmission",yE="KHR_materials_unlit",xE="KHR_materials_volume",bE="KHR_materials_variants",_E="KHR_texture_transform",wE="KHR_xmp_json_ld",ME="INSTANCE_ATTRIBUTE";class SE extends bS{init(){this.extensionName=rE,this.propertyType="InstancedMesh",this.parentTypes=[CM.NODE]}getDefaults(){return Object.assign(super.getDefaults(),{attributes:{}})}getAttribute(t){return this.getRefMap("attributes",t)}setAttribute(t,e){return this.setRefMap("attributes",t,e,{usage:ME})}listAttributes(){return this.listRefMapValues("attributes")}listSemantics(){return this.listRefMapKeys("attributes")}}SE.EXTENSION_NAME=rE;const EE=rE;class TE extends BS{constructor(...t){super(...t),this.extensionName=EE,this.provideTypes=[CM.NODE],this.prewriteTypes=[CM.ACCESSOR]}createInstancedMesh(){return new SE(this.document.getGraph())}read(t){return(t.jsonDoc.json.nodes||[]).forEach(((e,i)=>{if(!e.extensions||!e.extensions[EE])return;const n=e.extensions[EE],s=this.createInstancedMesh();for(const e in n.attributes)s.setAttribute(e,t.accessors[n.attributes[e]]);t.nodes[i].setExtension(EE,s)})),this}prewrite(t){t.accessorUsageGroupedByParent.add(ME);for(const e of this.properties)for(const i of e.listAttributes())t.addAccessorToUsageGroup(i,ME);return this}write(t){const e=t.jsonDoc;return this.document.getRoot().listNodes().forEach((i=>{const n=i.getExtension(EE);if(n){const s=t.nodeIndexMap.get(i),r=e.json.nodes[s],a={attributes:{}};n.listSemantics().forEach((e=>{const i=n.getAttribute(e);a.attributes[e]=t.accessorIndexMap.get(i)})),r.extensions=r.extensions||{},r.extensions[EE]=a}})),this}}function AE(){return AE=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var i=arguments[e];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(t[n]=i[n])}return t},AE.apply(this,arguments)}var CE,IE,RE;TE.EXTENSION_NAME=EE,function(t){t.QUANTIZE="quantize",t.FILTER="filter"}(CE||(CE={})),function(t){t.ATTRIBUTES="ATTRIBUTES",t.TRIANGLES="TRIANGLES",t.INDICES="INDICES"}(IE||(IE={})),function(t){t.NONE="NONE",t.OCTAHEDRAL="OCTAHEDRAL",t.QUATERNION="QUATERNION",t.EXPONENTIAL="EXPONENTIAL"}(RE||(RE={}));const{BYTE:kE,SHORT:PE,FLOAT:DE}=mS.ComponentType,{encodeNormalizedInt:LE,decodeNormalizedInt:OE}=QM;function NE(t,e,i,n){const{filter:s,bits:r}=n,a={array:t.getArray(),byteStride:t.getElementSize()*t.getComponentSize(),componentType:t.getComponentType(),normalized:t.getNormalized()};if(i!==IE.ATTRIBUTES)return a;if(s!==RE.NONE){let i=t.getNormalized()?function(t){const e=t.getComponentType(),i=t.getArray(),n=new Float32Array(i.length);for(let t=0;t<i.length;t++)n[t]=OE(i[t],e);return n}(t):new Float32Array(a.array);switch(s){case RE.EXPONENTIAL:a.byteStride=4*t.getElementSize(),a.componentType=DE,a.normalized=!1,a.array=e.encodeFilterExp(i,t.getCount(),a.byteStride,r);break;case RE.OCTAHEDRAL:a.byteStride=r>8?8:4,a.componentType=r>8?PE:kE,a.normalized=!0,i=3===t.getElementSize()?function(t){const e=new Float32Array(4*t.length/3);for(let i=0,n=t.length/3;i<n;i++)e[4*i]=t[3*i],e[4*i+1]=t[3*i+1],e[4*i+2]=t[3*i+2];return e}(i):i,a.array=e.encodeFilterOct(i,t.getCount(),a.byteStride,r);break;case RE.QUATERNION:a.byteStride=8,a.componentType=PE,a.normalized=!0,a.array=e.encodeFilterQuat(i,t.getCount(),a.byteStride,r);break;default:throw new Error("Invalid filter.")}a.min=t.getMin([]),a.max=t.getMax([]),t.getNormalized()&&(a.min=a.min.map((e=>OE(e,t.getComponentType()))),a.max=a.max.map((e=>OE(e,t.getComponentType())))),a.normalized&&(a.min=a.min.map((t=>LE(t,a.componentType))),a.max=a.max.map((t=>LE(t,a.componentType))))}else a.byteStride%4&&(a.array=function(t,e){const i=GM.padNumber(t.BYTES_PER_ELEMENT*e)/t.BYTES_PER_ELEMENT,n=new t.constructor(t.length/e*i);for(let s=0;s*e<t.length;s++)for(let r=0;r<e;r++)n[s*i+r]=t[s*e+r];return n}(a.array,t.getElementSize()),a.byteStride=a.array.byteLength/t.getCount());return a}function BE(t,e){return e===HS.BufferViewUsage.ELEMENT_ARRAY_BUFFER?t.listParents().some((t=>t instanceof IS&&t.getMode()===IS.Mode.TRIANGLES))?IE.TRIANGLES:IE.INDICES:IE.ATTRIBUTES}function zE(t,e){const i=e.getGraph().listParentEdges(t).filter((t=>!(t.getParent()instanceof OS)));for(const e of i){const i=e.getName(),n=e.getAttributes().key||"",s=e.getParent().propertyType===CM.PRIMITIVE_TARGET;if("indices"===i)return{filter:RE.NONE};if("attributes"===i){if("POSITION"===n)return{filter:RE.NONE};if("TEXCOORD_0"===n)return{filter:RE.NONE};if(n.startsWith("JOINTS_"))return{filter:RE.NONE};if(n.startsWith("WEIGHTS_"))return{filter:RE.NONE};if("NORMAL"===n||"TANGENT"===n)return s?{filter:RE.NONE}:{filter:RE.OCTAHEDRAL,bits:8}}if("output"===i){const e=UE(t);return"rotation"===e?{filter:RE.QUATERNION,bits:16}:"translation"===e||"scale"===e?{filter:RE.EXPONENTIAL,bits:12}:{filter:RE.NONE}}if("input"===i)return{filter:RE.NONE};if("inverseBindMatrices"===i)return{filter:RE.NONE}}return{filter:RE.NONE}}function UE(t){for(const e of t.listParents())if(e instanceof vS)for(const t of e.listParents())if(t instanceof gS)return t.getTargetPath();return null}const FE=aE,GE={method:CE.QUANTIZE};class VE extends BS{constructor(...t){super(...t),this.extensionName=FE,this.prereadTypes=[CM.BUFFER,CM.PRIMITIVE],this.prewriteTypes=[CM.BUFFER,CM.ACCESSOR],this.readDependencies=["meshopt.decoder"],this.writeDependencies=["meshopt.encoder"],this._decoder=null,this._decoderFallbackBufferMap=new Map,this._encoder=null,this._encoderOptions=GE,this._encoderFallbackBuffer=null,this._encoderBufferViews={},this._encoderBufferViewData={},this._encoderBufferViewAccessors={}}install(t,e){return"meshopt.decoder"===t&&(this._decoder=e),"meshopt.encoder"===t&&(this._encoder=e),this}setEncoderOptions(t){return this._encoderOptions=AE({},GE,t),this}preread(t,e){if(!this._decoder){if(!this.isRequired())return this;throw new Error(`[${FE}] Please install extension dependency, "meshopt.decoder".`)}if(!this._decoder.supported){if(!this.isRequired())return this;throw new Error(`[${FE}]: Missing WASM support.`)}return e===CM.BUFFER?this._prereadBuffers(t):e===CM.PRIMITIVE&&this._prereadPrimitives(t),this}_prereadBuffers(t){const e=t.jsonDoc;(e.json.bufferViews||[]).forEach(((i,n)=>{if(!i.extensions||!i.extensions[FE])return;const s=i.extensions[FE],r=s.byteOffset||0,a=s.byteLength||0,o=s.count,h=s.byteStride,l=new Uint8Array(o*h),c=e.json.buffers[s.buffer],u=GM.toView(c.uri?e.resources[c.uri]:e.resources[AM],r,a);this._decoder.decodeGltfBuffer(l,o,h,u,s.mode,s.filter),t.bufferViews[n]=l}))}_prereadPrimitives(t){const e=t.jsonDoc;(e.json.bufferViews||[]).forEach((i=>{var n;i.extensions&&i.extensions[FE]&&(n=e.json.buffers[i.buffer]).extensions&&n.extensions[aE]&&n.extensions[aE].fallback&&this._decoderFallbackBufferMap.set(t.buffers[i.buffer],t.buffers[i.extensions[FE].buffer])}))}read(t){if(!this.isRequired())return this;for(const[t,e]of this._decoderFallbackBufferMap){for(const i of t.listParents())i instanceof mS&&i.swap(t,e);t.dispose()}return this}prewrite(t,e){return e===CM.ACCESSOR?this._prewriteAccessors(t):e===CM.BUFFER&&this._prewriteBuffers(t),this}_prewriteAccessors(t){const e=t.jsonDoc.json,i=this._encoder,n=this._encoderOptions,s=this.document.createBuffer(),r=this.document.getRoot().listBuffers().indexOf(s);this._encoderFallbackBuffer=s,this._encoderBufferViews={},this._encoderBufferViewData={},this._encoderBufferViewAccessors={};for(const s of this.document.getRoot().listAccessors()){if("weights"===UE(s))continue;if(s.getSparse())continue;const a=t.getAccessorUsage(s),o=BE(s,a),h=n.method===CE.FILTER?zE(s,this.document):{filter:RE.NONE},l=NE(s,i,o,h),{array:c,byteStride:u}=l,d=s.getBuffer();if(!d)throw new Error(`${FE}: Missing buffer for accessor.`);const p=this.document.getRoot().listBuffers().indexOf(d),m=[a,o,h.filter,u,p].join(":");let f=this._encoderBufferViews[m],g=this._encoderBufferViewData[m],v=this._encoderBufferViewAccessors[m];f&&g||(v=this._encoderBufferViewAccessors[m]=[],g=this._encoderBufferViewData[m]=[],f=this._encoderBufferViews[m]={buffer:r,target:HS.USAGE_TO_TARGET[a],byteOffset:0,byteLength:0,byteStride:a===HS.BufferViewUsage.ARRAY_BUFFER?u:void 0,extensions:{[FE]:{buffer:p,byteOffset:0,byteLength:0,mode:o,filter:h.filter!==RE.NONE?h.filter:void 0,byteStride:u,count:0}}});const y=t.createAccessorDef(s);y.componentType=l.componentType,y.normalized=l.normalized,y.byteOffset=f.byteLength,y.min&&l.min&&(y.min=l.min),y.max&&l.max&&(y.max=l.max),t.accessorIndexMap.set(s,e.accessors.length),e.accessors.push(y),v.push(y),g.push(new Uint8Array(c.buffer,c.byteOffset,c.byteLength)),f.byteLength+=c.byteLength,f.extensions.EXT_meshopt_compression.count+=s.getCount()}}_prewriteBuffers(t){const e=this._encoder;for(const i in this._encoderBufferViews){const n=this._encoderBufferViews[i],s=this._encoderBufferViewData[i],r=this.document.getRoot().listBuffers()[n.extensions[FE].buffer],a=t.otherBufferViews.get(r)||[],{count:o,byteStride:h,mode:l}=n.extensions[FE],c=GM.concat(s),u=e.encodeGltfBuffer(c,o,h,l),d=GM.pad(u);n.extensions[FE].byteLength=u.byteLength,s.length=0,s.push(d),a.push(d),t.otherBufferViews.set(r,a)}}write(t){let e=0;for(const i in this._encoderBufferViews){const n=this._encoderBufferViews[i],s=t.otherBufferViewsIndexMap.get(this._encoderBufferViewData[i][0]),r=this._encoderBufferViewAccessors[i];for(const t of r)t.bufferView=s;const a=t.jsonDoc.json.bufferViews[s],o=a.byteOffset||0;Object.assign(a,n),a.byteOffset=e,a.extensions[FE].byteOffset=o,e+=GM.padNumber(n.byteLength)}const i=this._encoderFallbackBuffer,n=t.bufferIndexMap.get(i),s=t.jsonDoc.json.buffers[n];return s.byteLength=e,s.extensions={[FE]:{fallback:!0}},i.dispose(),this}}VE.EXTENSION_NAME=FE,VE.EncoderMethod=CE;const HE="EXT_texture_avif";class jE{match(t){return t.length>=12&&"ftypavif"===GM.decodeText(t.slice(4,12))}getSize(t){if(!this.match(t))return null;const e=new DataView(t.buffer,t.byteOffset,t.byteLength);let i=XE(e,0);if(!i)return null;let n=i.end;for(;i=XE(e,n);)if("meta"===i.type)n=i.start+4;else if("iprp"===i.type||"ipco"===i.type)n=i.start;else{if("ispe"===i.type)return[e.getUint32(i.start+4),e.getUint32(i.start+8)];if("mdat"===i.type)break;n=i.end}return null}getChannels(t){return 4}}class WE extends BS{constructor(...t){super(...t),this.extensionName=HE,this.prereadTypes=[CM.TEXTURE]}static register(){jM.registerFormat("image/avif",new jE)}preread(t){return(t.jsonDoc.json.textures||[]).forEach((t=>{t.extensions&&t.extensions[HE]&&(t.source=t.extensions[HE].source)})),this}read(t){return this}write(t){const e=t.jsonDoc;return this.document.getRoot().listTextures().forEach((i=>{if("image/avif"===i.getMimeType()){const n=t.imageIndexMap.get(i);(e.json.textures||[]).forEach((t=>{t.source===n&&(t.extensions=t.extensions||{},t.extensions[HE]={source:t.source},delete t.source)}))}})),this}}function XE(t,e){if(t.byteLength<4+e)return null;const i=t.getUint32(e);return t.byteLength<i+e||i<8?null:{type:GM.decodeText(new Uint8Array(t.buffer,t.byteOffset+e+4,4)),start:e+8,end:e+i}}WE.EXTENSION_NAME=HE;const qE="EXT_texture_webp";class YE{match(t){return t.length>=12&&87===t[8]&&69===t[9]&&66===t[10]&&80===t[11]}getSize(t){const e=GM.decodeText(t.slice(0,4)),i=GM.decodeText(t.slice(8,12));if("RIFF"!==e||"WEBP"!==i)return null;const n=new DataView(t.buffer,t.byteOffset);let s=12;for(;s<n.byteLength;){const t=GM.decodeText(new Uint8Array([n.getUint8(s),n.getUint8(s+1),n.getUint8(s+2),n.getUint8(s+3)])),e=n.getUint32(s+4,!0);if("VP8 "===t)return[16383&n.getInt16(s+14,!0),16383&n.getInt16(s+16,!0)];if("VP8L"===t){const t=n.getUint8(s+9),e=n.getUint8(s+10),i=n.getUint8(s+11);return[1+((63&e)<<8|t),1+((15&n.getUint8(s+12))<<10|i<<2|(192&e)>>6)]}s+=8+e+e%2}return null}getChannels(t){return 4}}class JE extends BS{constructor(...t){super(...t),this.extensionName=qE,this.prereadTypes=[CM.TEXTURE]}static register(){jM.registerFormat("image/webp",new YE)}preread(t){return(t.jsonDoc.json.textures||[]).forEach((t=>{t.extensions&&t.extensions[qE]&&(t.source=t.extensions[qE].source)})),this}read(t){return this}write(t){const e=t.jsonDoc;return this.document.getRoot().listTextures().forEach((i=>{if("image/webp"===i.getMimeType()){const n=t.imageIndexMap.get(i);(e.json.textures||[]).forEach((t=>{t.source===n&&(t.extensions=t.extensions||{},t.extensions[qE]={source:t.source},delete t.source)}))}})),this}}JE.EXTENSION_NAME=qE;const $E=oE;let KE,ZE,QE,tT;function eT(t,e){const i=new KE.DecoderBuffer;try{if(i.Init(e,e.length),t.GetEncodedGeometryType(i)!==KE.TRIANGULAR_MESH)throw new Error(`[${$E}] Unknown geometry type.`);const n=new KE.Mesh;if(!t.DecodeBufferToMesh(i,n).ok()||0===n.ptr)throw new Error(`[${$E}] Decoding failure.`);return n}finally{KE.destroy(i)}}function iT(t,e){const i=3*e.num_faces();let n,s;if(e.num_points()<=65534){const r=i*Uint16Array.BYTES_PER_ELEMENT;n=KE._malloc(r),t.GetTrianglesUInt16Array(e,r,n),s=new Uint16Array(KE.HEAPU16.buffer,n,i).slice()}else{const r=i*Uint32Array.BYTES_PER_ELEMENT;n=KE._malloc(r),t.GetTrianglesUInt32Array(e,r,n),s=new Uint32Array(KE.HEAPU32.buffer,n,i).slice()}return KE._free(n),s}function nT(t,e,i,n){const s=QE[n.componentType],r=ZE[n.componentType],a=i.num_components(),o=e.num_points()*a,h=o*r.BYTES_PER_ELEMENT,l=KE._malloc(h);t.GetAttributeDataArrayForAllPoints(e,i,s,h,l);const c=new r(KE.HEAPF32.buffer,l,o).slice();return KE._free(l),c}var sT,rT;!function(t){t[t.EDGEBREAKER=1]="EDGEBREAKER",t[t.SEQUENTIAL=0]="SEQUENTIAL"}(sT||(sT={})),function(t){t.POSITION="POSITION",t.NORMAL="NORMAL",t.COLOR="COLOR",t.TEX_COORD="TEX_COORD",t.GENERIC="GENERIC"}(rT||(rT={}));const aT={[rT.POSITION]:14,[rT.NORMAL]:10,[rT.COLOR]:8,[rT.TEX_COORD]:12,[rT.GENERIC]:12},oT={decodeSpeed:5,encodeSpeed:5,method:sT.EDGEBREAKER,quantizationBits:aT,quantizationVolume:"mesh"};function hT(t,e=oT){const i=AE({},oT,e);i.quantizationBits=AE({},aT,e.quantizationBits);const n=new tT.MeshBuilder,s=new tT.Mesh,r=new tT.ExpertEncoder(s),a={},o=new tT.DracoInt8Array,h=t.listTargets().length>0;let l=!1;for(const e of t.listSemantics()){const o=t.getAttribute(e);if(o.getSparse()){l=!0;continue}const h=lT(e),c=cT(n,o.getComponentType(),s,tT[h],o.getCount(),o.getElementSize(),o.getArray());if(-1===c)throw new Error(`Error compressing "${e}" attribute.`);if(a[e]=c,"mesh"===i.quantizationVolume||"POSITION"!==e)r.SetAttributeQuantization(c,i.quantizationBits[h]);else{if("object"!=typeof i.quantizationVolume)throw new Error("Invalid quantization volume state.");{const{quantizationVolume:t}=i,e=Math.max(t.max[0]-t.min[0],t.max[1]-t.min[1],t.max[2]-t.min[2]);r.SetAttributeExplicitQuantization(c,i.quantizationBits[h],o.getElementSize(),t.min,e)}}}const c=t.getIndices();if(!c)throw new uT("Primitive must have indices.");n.AddFacesToMesh(s,c.getCount()/3,c.getArray()),r.SetSpeedOptions(i.encodeSpeed,i.decodeSpeed),r.SetTrackEncodedProperties(!0),r.SetEncodingMethod(i.method===sT.SEQUENTIAL||h||l?tT.MESH_SEQUENTIAL_ENCODING:tT.MESH_EDGEBREAKER_ENCODING);const u=r.EncodeToDracoBuffer(!(h||l),o);if(u<=0)throw new uT("Error applying Draco compression.");const d=new Uint8Array(u);for(let t=0;t<u;++t)d[t]=o.GetValue(t);const p=r.GetNumberOfEncodedPoints(),m=3*r.GetNumberOfEncodedFaces();return tT.destroy(o),tT.destroy(s),tT.destroy(n),tT.destroy(r),{numVertices:p,numIndices:m,data:d,attributeIDs:a}}function lT(t){return"POSITION"===t?rT.POSITION:"NORMAL"===t?rT.NORMAL:t.startsWith("COLOR_")?rT.COLOR:t.startsWith("TEXCOORD_")?rT.TEX_COORD:rT.GENERIC}function cT(t,e,i,n,s,r,a){switch(e){case mS.ComponentType.UNSIGNED_BYTE:return t.AddUInt8Attribute(i,n,s,r,a);case mS.ComponentType.BYTE:return t.AddInt8Attribute(i,n,s,r,a);case mS.ComponentType.UNSIGNED_SHORT:return t.AddUInt16Attribute(i,n,s,r,a);case mS.ComponentType.SHORT:return t.AddInt16Attribute(i,n,s,r,a);case mS.ComponentType.UNSIGNED_INT:return t.AddUInt32Attribute(i,n,s,r,a);case mS.ComponentType.FLOAT:return t.AddFloatAttribute(i,n,s,r,a);default:throw new Error(`Unexpected component type, "${e}".`)}}class uT extends Error{}const dT=oE;class pT extends BS{constructor(...t){super(...t),this.extensionName=dT,this.prereadTypes=[CM.PRIMITIVE],this.prewriteTypes=[CM.ACCESSOR],this.readDependencies=["draco3d.decoder"],this.writeDependencies=["draco3d.encoder"],this._decoderModule=null,this._encoderModule=null,this._encoderOptions={}}install(t,e){return"draco3d.decoder"===t&&(this._decoderModule=e,KE=this._decoderModule,ZE={[mS.ComponentType.FLOAT]:Float32Array,[mS.ComponentType.UNSIGNED_INT]:Uint32Array,[mS.ComponentType.UNSIGNED_SHORT]:Uint16Array,[mS.ComponentType.UNSIGNED_BYTE]:Uint8Array,[mS.ComponentType.SHORT]:Int16Array,[mS.ComponentType.BYTE]:Int8Array},QE={[mS.ComponentType.FLOAT]:KE.DT_FLOAT32,[mS.ComponentType.UNSIGNED_INT]:KE.DT_UINT32,[mS.ComponentType.UNSIGNED_SHORT]:KE.DT_UINT16,[mS.ComponentType.UNSIGNED_BYTE]:KE.DT_UINT8,[mS.ComponentType.SHORT]:KE.DT_INT16,[mS.ComponentType.BYTE]:KE.DT_INT8}),"draco3d.encoder"===t&&(this._encoderModule=e,tT=this._encoderModule),this}setEncoderOptions(t){return this._encoderOptions=t,this}preread(t){if(!this._decoderModule)throw new Error(`[${dT}] Please install extension dependency, "draco3d.decoder".`);const e=this.document.getLogger(),i=t.jsonDoc,n=new Map;try{const s=i.json.meshes||[];for(const r of s)for(const s of r.primitives){if(!s.extensions||!s.extensions[dT])continue;const r=s.extensions[dT];let[a,o]=n.get(r.bufferView)||[];if(!o||!a){const t=i.json.bufferViews[r.bufferView],s=i.json.buffers[t.buffer],h=GM.toView(s.uri?i.resources[s.uri]:i.resources[AM],t.byteOffset||0,t.byteLength);a=new this._decoderModule.Decoder,o=eT(a,h),n.set(r.bufferView,[a,o]),e.debug(`[${dT}] Decompressed ${h.byteLength} bytes.`)}for(const e in s.attributes){const i=t.jsonDoc.json.accessors[s.attributes[e]],n=a.GetAttributeByUniqueId(o,r.attributes[e]),h=nT(a,o,n,i);t.accessors[s.attributes[e]].setArray(h)}void 0!==s.indices&&t.accessors[s.indices].setArray(iT(a,o))}}finally{for(const[t,e]of Array.from(n.values()))this._decoderModule.destroy(t),this._decoderModule.destroy(e)}return this}read(t){return this}prewrite(t,e){if(!this._encoderModule)throw new Error(`[${dT}] Please install extension dependency, "draco3d.encoder".`);const i=this.document.getLogger();i.debug(`[${dT}] Compression options: ${JSON.stringify(this._encoderOptions)}`);const n=function(t){const e=t.getLogger(),i=new Set,n=new Set;for(const s of t.getRoot().listMeshes())for(const t of s.listPrimitives())t.getIndices()?t.getMode()!==IS.Mode.TRIANGLES?(n.add(t),e.warn(`[${dT}] Skipping Draco compression on non-TRIANGLES primitive.`)):i.add(t):(n.add(t),e.warn(`[${dT}] Skipping Draco compression on non-indexed primitive.`));const s=t.getRoot().listAccessors(),r=new Map;for(let t=0;t<s.length;t++)r.set(s[t],t);const a=new Map,o=new Set,h=new Map;for(const e of Array.from(i)){let i=mT(e,r);if(o.has(i))h.set(e,i);else{if(a.has(e.getIndices())){const i=e.getIndices(),n=i.clone();r.set(n,t.getRoot().listAccessors().length-1),e.swap(i,n)}for(const i of e.listAttributes())if(a.has(i)){const n=i.clone();r.set(n,t.getRoot().listAccessors().length-1),e.swap(i,n)}i=mT(e,r),o.add(i),h.set(e,i),a.set(e.getIndices(),i);for(const t of e.listAttributes())a.set(t,i)}}for(const t of Array.from(a.keys())){const e=new Set(t.listParents().map((t=>t.propertyType)));if(2!==e.size||!e.has(CM.PRIMITIVE)||!e.has(CM.ROOT))throw new Error(`[${dT}] Compressed accessors must only be used as indices or vertex attributes.`)}for(const t of Array.from(i)){const e=h.get(t),i=t.getIndices();if(a.get(i)!==e||t.listAttributes().some((t=>a.get(t)!==e)))throw new Error(`[${dT}] Draco primitives must share all, or no, accessors.`)}for(const t of Array.from(n)){const e=t.getIndices();if(a.has(e)||t.listAttributes().some((t=>a.has(t))))throw new Error(`[${dT}] Accessor cannot be shared by compressed and uncompressed primitives.`)}return h}(this.document),s=new Map;let r="mesh";"scene"===this._encoderOptions.quantizationVolume&&(1!==this.document.getRoot().listScenes().length?i.warn(`[${dT}]: quantizationVolume=scene requires exactly 1 scene.`):r=zM(this.document.getRoot().listScenes().pop()));for(const e of Array.from(n.keys())){const a=n.get(e);if(!a)throw new Error("Unexpected primitive.");if(s.has(a)){s.set(a,s.get(a));continue}const o=e.getIndices(),h=t.jsonDoc.json.accessors;let l;try{l=hT(e,AE({},this._encoderOptions,{quantizationVolume:r}))}catch(t){if(t instanceof uT){i.warn(`[${dT}]: ${t.message} Skipping primitive compression.`);continue}throw t}s.set(a,l);const c=t.createAccessorDef(o);c.count=l.numIndices,t.accessorIndexMap.set(o,h.length),h.push(c);for(const i of e.listSemantics()){const n=e.getAttribute(i);if(void 0===l.attributeIDs[i])continue;const s=t.createAccessorDef(n);s.count=l.numVertices,t.accessorIndexMap.set(n,h.length),h.push(s)}const u=e.getAttribute("POSITION").getBuffer()||this.document.getRoot().listBuffers()[0];t.otherBufferViews.has(u)||t.otherBufferViews.set(u,[]),t.otherBufferViews.get(u).push(l.data)}return i.debug(`[${dT}] Compressed ${n.size} primitives.`),t.extensionData[dT]={primitiveHashMap:n,primitiveEncodingMap:s},this}write(t){const e=t.extensionData[dT];for(const i of this.document.getRoot().listMeshes()){const n=t.jsonDoc.json.meshes[t.meshIndexMap.get(i)];for(let s=0;s<i.listPrimitives().length;s++){const r=i.listPrimitives()[s],a=n.primitives[s],o=e.primitiveHashMap.get(r);if(!o)continue;const h=e.primitiveEncodingMap.get(o);h&&(a.extensions=a.extensions||{},a.extensions[dT]={bufferView:t.otherBufferViewsIndexMap.get(h.data),attributes:h.attributeIDs})}}if(!e.primitiveHashMap.size){const e=t.jsonDoc.json;e.extensionsUsed=(e.extensionsUsed||[]).filter((t=>t!==dT)),e.extensionsRequired=(e.extensionsRequired||[]).filter((t=>t!==dT))}return this}}function mT(t,e){const i=[],n=t.getIndices();i.push(e.get(n));for(const n of t.listAttributes())i.push(e.get(n));return i.sort().join("|")}pT.EXTENSION_NAME=dT,pT.EncoderMethod=sT;class fT extends bS{init(){this.extensionName=hE,this.propertyType="Light",this.parentTypes=[CM.NODE]}getDefaults(){return Object.assign(super.getDefaults(),{color:[1,1,1],intensity:1,type:fT.Type.POINT,range:null,innerConeAngle:0,outerConeAngle:Math.PI/4})}getColor(){return this.get("color")}setColor(t){return this.set("color",t)}getColorHex(){return VM.factorToHex(this.getColor())}setColorHex(t){const e=this.getColor().slice();return VM.hexToFactor(t,e),this.setColor(e)}getIntensity(){return this.get("intensity")}setIntensity(t){return this.set("intensity",t)}getType(){return this.get("type")}setType(t){return this.set("type",t)}getRange(){return this.get("range")}setRange(t){return this.set("range",t)}getInnerConeAngle(){return this.get("innerConeAngle")}setInnerConeAngle(t){return this.set("innerConeAngle",t)}getOuterConeAngle(){return this.get("outerConeAngle")}setOuterConeAngle(t){return this.set("outerConeAngle",t)}}fT.EXTENSION_NAME=hE,fT.Type={POINT:"point",SPOT:"spot",DIRECTIONAL:"directional"};const gT=hE;class vT extends BS{constructor(...t){super(...t),this.extensionName=gT}createLight(t=""){return new fT(this.document.getGraph(),t)}read(t){const e=t.jsonDoc;if(!e.json.extensions||!e.json.extensions[gT])return this;const i=(e.json.extensions[gT].lights||[]).map((t=>{var e,i;const n=this.createLight().setName(t.name||"").setType(t.type);return void 0!==t.color&&n.setColor(t.color),void 0!==t.intensity&&n.setIntensity(t.intensity),void 0!==t.range&&n.setRange(t.range),void 0!==(null==(e=t.spot)?void 0:e.innerConeAngle)&&n.setInnerConeAngle(t.spot.innerConeAngle),void 0!==(null==(i=t.spot)?void 0:i.outerConeAngle)&&n.setOuterConeAngle(t.spot.outerConeAngle),n}));return e.json.nodes.forEach(((e,n)=>{e.extensions&&e.extensions[gT]&&t.nodes[n].setExtension(gT,i[e.extensions[gT].light])})),this}write(t){const e=t.jsonDoc;if(0===this.properties.size)return this;const i=[],n=new Map;for(const t of this.properties){const e=t,s={type:e.getType()};QM.eq(e.getColor(),[1,1,1])||(s.color=e.getColor()),1!==e.getIntensity()&&(s.intensity=e.getIntensity()),null!=e.getRange()&&(s.range=e.getRange()),e.getName()&&(s.name=e.getName()),e.getType()===fT.Type.SPOT&&(s.spot={innerConeAngle:e.getInnerConeAngle(),outerConeAngle:e.getOuterConeAngle()}),i.push(s),n.set(e,i.length-1)}return this.document.getRoot().listNodes().forEach((i=>{const s=i.getExtension(gT);if(s){const r=t.nodeIndexMap.get(i),a=e.json.nodes[r];a.extensions=a.extensions||{},a.extensions[gT]={light:n.get(s)}}})),e.json.extensions=e.json.extensions||{},e.json.extensions[gT]={lights:i},this}}vT.EXTENSION_NAME=gT;const{R:yT,G:xT,B:bT}=kM;class _T extends bS{init(){this.extensionName=lE,this.propertyType="Anisotropy",this.parentTypes=[CM.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{anisotropyStrength:0,anisotropyRotation:0,anisotropyTexture:null,anisotropyTextureInfo:new _S(this.graph,"anisotropyTextureInfo")})}getAnisotropyStrength(){return this.get("anisotropyStrength")}setAnisotropyStrength(t){return this.set("anisotropyStrength",t)}getAnisotropyRotation(){return this.get("anisotropyRotation")}setAnisotropyRotation(t){return this.set("anisotropyRotation",t)}getAnisotropyTexture(){return this.getRef("anisotropyTexture")}getAnisotropyTextureInfo(){return this.getRef("anisotropyTexture")?this.getRef("anisotropyTextureInfo"):null}setAnisotropyTexture(t){return this.setRef("anisotropyTexture",t,{channels:yT|xT|bT})}}_T.EXTENSION_NAME=lE;const wT=lE;class MT extends BS{constructor(...t){super(...t),this.extensionName=wT}createAnisotropy(){return new _T(this.document.getGraph())}read(t){const e=t.jsonDoc,i=e.json.textures||[];return(e.json.materials||[]).forEach(((e,n)=>{if(e.extensions&&e.extensions[wT]){const s=this.createAnisotropy();t.materials[n].setExtension(wT,s);const r=e.extensions[wT];if(void 0!==r.anisotropyStrength&&s.setAnisotropyStrength(r.anisotropyStrength),void 0!==r.anisotropyRotation&&s.setAnisotropyRotation(r.anisotropyRotation),void 0!==r.anisotropyTexture){const e=r.anisotropyTexture;s.setAnisotropyTexture(t.textures[i[e.index].source]),t.setTextureInfo(s.getAnisotropyTextureInfo(),e)}}})),this}write(t){const e=t.jsonDoc;return this.document.getRoot().listMaterials().forEach((i=>{const n=i.getExtension(wT);if(n){const s=t.materialIndexMap.get(i),r=e.json.materials[s];r.extensions=r.extensions||{};const a=r.extensions[wT]={};if(n.getAnisotropyStrength()>0&&(a.anisotropyStrength=n.getAnisotropyStrength()),0!==n.getAnisotropyRotation()&&(a.anisotropyRotation=n.getAnisotropyRotation()),n.getAnisotropyTexture()){const e=n.getAnisotropyTexture(),i=n.getAnisotropyTextureInfo();a.anisotropyTexture=t.createTextureInfoDef(e,i)}}})),this}}MT.EXTENSION_NAME=wT;const{R:ST,G:ET,B:TT}=kM;class AT extends bS{init(){this.extensionName=cE,this.propertyType="Clearcoat",this.parentTypes=[CM.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{clearcoatFactor:0,clearcoatTexture:null,clearcoatTextureInfo:new _S(this.graph,"clearcoatTextureInfo"),clearcoatRoughnessFactor:0,clearcoatRoughnessTexture:null,clearcoatRoughnessTextureInfo:new _S(this.graph,"clearcoatRoughnessTextureInfo"),clearcoatNormalScale:1,clearcoatNormalTexture:null,clearcoatNormalTextureInfo:new _S(this.graph,"clearcoatNormalTextureInfo")})}getClearcoatFactor(){return this.get("clearcoatFactor")}setClearcoatFactor(t){return this.set("clearcoatFactor",t)}getClearcoatTexture(){return this.getRef("clearcoatTexture")}getClearcoatTextureInfo(){return this.getRef("clearcoatTexture")?this.getRef("clearcoatTextureInfo"):null}setClearcoatTexture(t){return this.setRef("clearcoatTexture",t,{channels:ST})}getClearcoatRoughnessFactor(){return this.get("clearcoatRoughnessFactor")}setClearcoatRoughnessFactor(t){return this.set("clearcoatRoughnessFactor",t)}getClearcoatRoughnessTexture(){return this.getRef("clearcoatRoughnessTexture")}getClearcoatRoughnessTextureInfo(){return this.getRef("clearcoatRoughnessTexture")?this.getRef("clearcoatRoughnessTextureInfo"):null}setClearcoatRoughnessTexture(t){return this.setRef("clearcoatRoughnessTexture",t,{channels:ET})}getClearcoatNormalScale(){return this.get("clearcoatNormalScale")}setClearcoatNormalScale(t){return this.set("clearcoatNormalScale",t)}getClearcoatNormalTexture(){return this.getRef("clearcoatNormalTexture")}getClearcoatNormalTextureInfo(){return this.getRef("clearcoatNormalTexture")?this.getRef("clearcoatNormalTextureInfo"):null}setClearcoatNormalTexture(t){return this.setRef("clearcoatNormalTexture",t,{channels:ST|ET|TT})}}AT.EXTENSION_NAME=cE;const CT=cE;class IT extends BS{constructor(...t){super(...t),this.extensionName=CT}createClearcoat(){return new AT(this.document.getGraph())}read(t){const e=t.jsonDoc,i=e.json.textures||[];return(e.json.materials||[]).forEach(((e,n)=>{if(e.extensions&&e.extensions[CT]){const s=this.createClearcoat();t.materials[n].setExtension(CT,s);const r=e.extensions[CT];if(void 0!==r.clearcoatFactor&&s.setClearcoatFactor(r.clearcoatFactor),void 0!==r.clearcoatRoughnessFactor&&s.setClearcoatRoughnessFactor(r.clearcoatRoughnessFactor),void 0!==r.clearcoatTexture){const e=r.clearcoatTexture;s.setClearcoatTexture(t.textures[i[e.index].source]),t.setTextureInfo(s.getClearcoatTextureInfo(),e)}if(void 0!==r.clearcoatRoughnessTexture){const e=r.clearcoatRoughnessTexture;s.setClearcoatRoughnessTexture(t.textures[i[e.index].source]),t.setTextureInfo(s.getClearcoatRoughnessTextureInfo(),e)}if(void 0!==r.clearcoatNormalTexture){const e=r.clearcoatNormalTexture;s.setClearcoatNormalTexture(t.textures[i[e.index].source]),t.setTextureInfo(s.getClearcoatNormalTextureInfo(),e),void 0!==e.scale&&s.setClearcoatNormalScale(e.scale)}}})),this}write(t){const e=t.jsonDoc;return this.document.getRoot().listMaterials().forEach((i=>{const n=i.getExtension(CT);if(n){const s=t.materialIndexMap.get(i),r=e.json.materials[s];r.extensions=r.extensions||{};const a=r.extensions[CT]={clearcoatFactor:n.getClearcoatFactor(),clearcoatRoughnessFactor:n.getClearcoatRoughnessFactor()};if(n.getClearcoatTexture()){const e=n.getClearcoatTexture(),i=n.getClearcoatTextureInfo();a.clearcoatTexture=t.createTextureInfoDef(e,i)}if(n.getClearcoatRoughnessTexture()){const e=n.getClearcoatRoughnessTexture(),i=n.getClearcoatRoughnessTextureInfo();a.clearcoatRoughnessTexture=t.createTextureInfoDef(e,i)}if(n.getClearcoatNormalTexture()){const e=n.getClearcoatNormalTexture(),i=n.getClearcoatNormalTextureInfo();a.clearcoatNormalTexture=t.createTextureInfoDef(e,i),1!==n.getClearcoatNormalScale()&&(a.clearcoatNormalTexture.scale=n.getClearcoatNormalScale())}}})),this}}IT.EXTENSION_NAME=CT;class RT extends bS{init(){this.extensionName=uE,this.propertyType="EmissiveStrength",this.parentTypes=[CM.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{emissiveStrength:1})}getEmissiveStrength(){return this.get("emissiveStrength")}setEmissiveStrength(t){return this.set("emissiveStrength",t)}}RT.EXTENSION_NAME=uE;const kT=uE;class PT extends BS{constructor(...t){super(...t),this.extensionName=kT}createEmissiveStrength(){return new RT(this.document.getGraph())}read(t){return(t.jsonDoc.json.materials||[]).forEach(((e,i)=>{if(e.extensions&&e.extensions[kT]){const n=this.createEmissiveStrength();t.materials[i].setExtension(kT,n);const s=e.extensions[kT];void 0!==s.emissiveStrength&&n.setEmissiveStrength(s.emissiveStrength)}})),this}write(t){const e=t.jsonDoc;return this.document.getRoot().listMaterials().forEach((i=>{const n=i.getExtension(kT);if(n){const s=t.materialIndexMap.get(i),r=e.json.materials[s];r.extensions=r.extensions||{},r.extensions[kT]={emissiveStrength:n.getEmissiveStrength()}}})),this}}PT.EXTENSION_NAME=kT;class DT extends bS{init(){this.extensionName=dE,this.propertyType="IOR",this.parentTypes=[CM.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{ior:1.5})}getIOR(){return this.get("ior")}setIOR(t){return this.set("ior",t)}}DT.EXTENSION_NAME=dE;const LT=dE;class OT extends BS{constructor(...t){super(...t),this.extensionName=LT}createIOR(){return new DT(this.document.getGraph())}read(t){return(t.jsonDoc.json.materials||[]).forEach(((e,i)=>{if(e.extensions&&e.extensions[LT]){const n=this.createIOR();t.materials[i].setExtension(LT,n);const s=e.extensions[LT];void 0!==s.ior&&n.setIOR(s.ior)}})),this}write(t){const e=t.jsonDoc;return this.document.getRoot().listMaterials().forEach((i=>{const n=i.getExtension(LT);if(n){const s=t.materialIndexMap.get(i),r=e.json.materials[s];r.extensions=r.extensions||{},r.extensions[LT]={ior:n.getIOR()}}})),this}}OT.EXTENSION_NAME=LT;const{R:NT,G:BT}=kM;class zT extends bS{init(){this.extensionName=pE,this.propertyType="Iridescence",this.parentTypes=[CM.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{iridescenceFactor:0,iridescenceTexture:null,iridescenceTextureInfo:new _S(this.graph,"iridescenceTextureInfo"),iridescenceIOR:1.3,iridescenceThicknessMinimum:100,iridescenceThicknessMaximum:400,iridescenceThicknessTexture:null,iridescenceThicknessTextureInfo:new _S(this.graph,"iridescenceThicknessTextureInfo")})}getIridescenceFactor(){return this.get("iridescenceFactor")}setIridescenceFactor(t){return this.set("iridescenceFactor",t)}getIridescenceTexture(){return this.getRef("iridescenceTexture")}getIridescenceTextureInfo(){return this.getRef("iridescenceTexture")?this.getRef("iridescenceTextureInfo"):null}setIridescenceTexture(t){return this.setRef("iridescenceTexture",t,{channels:NT})}getIridescenceIOR(){return this.get("iridescenceIOR")}setIridescenceIOR(t){return this.set("iridescenceIOR",t)}getIridescenceThicknessMinimum(){return this.get("iridescenceThicknessMinimum")}setIridescenceThicknessMinimum(t){return this.set("iridescenceThicknessMinimum",t)}getIridescenceThicknessMaximum(){return this.get("iridescenceThicknessMaximum")}setIridescenceThicknessMaximum(t){return this.set("iridescenceThicknessMaximum",t)}getIridescenceThicknessTexture(){return this.getRef("iridescenceThicknessTexture")}getIridescenceThicknessTextureInfo(){return this.getRef("iridescenceThicknessTexture")?this.getRef("iridescenceThicknessTextureInfo"):null}setIridescenceThicknessTexture(t){return this.setRef("iridescenceThicknessTexture",t,{channels:BT})}}zT.EXTENSION_NAME=pE;const UT=pE;class FT extends BS{constructor(...t){super(...t),this.extensionName=UT}createIridescence(){return new zT(this.document.getGraph())}read(t){const e=t.jsonDoc,i=e.json.textures||[];return(e.json.materials||[]).forEach(((e,n)=>{if(e.extensions&&e.extensions[UT]){const s=this.createIridescence();t.materials[n].setExtension(UT,s);const r=e.extensions[UT];if(void 0!==r.iridescenceFactor&&s.setIridescenceFactor(r.iridescenceFactor),void 0!==r.iridescenceIor&&s.setIridescenceIOR(r.iridescenceIor),void 0!==r.iridescenceThicknessMinimum&&s.setIridescenceThicknessMinimum(r.iridescenceThicknessMinimum),void 0!==r.iridescenceThicknessMaximum&&s.setIridescenceThicknessMaximum(r.iridescenceThicknessMaximum),void 0!==r.iridescenceTexture){const e=r.iridescenceTexture;s.setIridescenceTexture(t.textures[i[e.index].source]),t.setTextureInfo(s.getIridescenceTextureInfo(),e)}if(void 0!==r.iridescenceThicknessTexture){const e=r.iridescenceThicknessTexture;s.setIridescenceThicknessTexture(t.textures[i[e.index].source]),t.setTextureInfo(s.getIridescenceThicknessTextureInfo(),e)}}})),this}write(t){const e=t.jsonDoc;return this.document.getRoot().listMaterials().forEach((i=>{const n=i.getExtension(UT);if(n){const s=t.materialIndexMap.get(i),r=e.json.materials[s];r.extensions=r.extensions||{};const a=r.extensions[UT]={};if(n.getIridescenceFactor()>0&&(a.iridescenceFactor=n.getIridescenceFactor()),1.3!==n.getIridescenceIOR()&&(a.iridescenceIor=n.getIridescenceIOR()),100!==n.getIridescenceThicknessMinimum()&&(a.iridescenceThicknessMinimum=n.getIridescenceThicknessMinimum()),400!==n.getIridescenceThicknessMaximum()&&(a.iridescenceThicknessMaximum=n.getIridescenceThicknessMaximum()),n.getIridescenceTexture()){const e=n.getIridescenceTexture(),i=n.getIridescenceTextureInfo();a.iridescenceTexture=t.createTextureInfoDef(e,i)}if(n.getIridescenceThicknessTexture()){const e=n.getIridescenceThicknessTexture(),i=n.getIridescenceThicknessTextureInfo();a.iridescenceThicknessTexture=t.createTextureInfoDef(e,i)}}})),this}}FT.EXTENSION_NAME=UT;const{R:GT,G:VT,B:HT,A:jT}=kM;class WT extends bS{init(){this.extensionName=mE,this.propertyType="PBRSpecularGlossiness",this.parentTypes=[CM.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{diffuseFactor:[1,1,1,1],diffuseTexture:null,diffuseTextureInfo:new _S(this.graph,"diffuseTextureInfo"),specularFactor:[1,1,1],glossinessFactor:1,specularGlossinessTexture:null,specularGlossinessTextureInfo:new _S(this.graph,"specularGlossinessTextureInfo")})}getDiffuseFactor(){return this.get("diffuseFactor")}setDiffuseFactor(t){return this.set("diffuseFactor",t)}getDiffuseHex(){return VM.factorToHex(this.getDiffuseFactor())}setDiffuseHex(t){const e=this.getDiffuseFactor().slice();return this.setDiffuseFactor(VM.hexToFactor(t,e))}getDiffuseTexture(){return this.getRef("diffuseTexture")}getDiffuseTextureInfo(){return this.getRef("diffuseTexture")?this.getRef("diffuseTextureInfo"):null}setDiffuseTexture(t){return this.setRef("diffuseTexture",t,{channels:GT|VT|HT|jT,isColor:!0})}getSpecularFactor(){return this.get("specularFactor")}setSpecularFactor(t){return this.set("specularFactor",t)}getGlossinessFactor(){return this.get("glossinessFactor")}setGlossinessFactor(t){return this.set("glossinessFactor",t)}getSpecularGlossinessTexture(){return this.getRef("specularGlossinessTexture")}getSpecularGlossinessTextureInfo(){return this.getRef("specularGlossinessTexture")?this.getRef("specularGlossinessTextureInfo"):null}setSpecularGlossinessTexture(t){return this.setRef("specularGlossinessTexture",t,{channels:GT|VT|HT|jT})}}WT.EXTENSION_NAME=mE;const XT=mE;class qT extends BS{constructor(...t){super(...t),this.extensionName=XT}createPBRSpecularGlossiness(){return new WT(this.document.getGraph())}read(t){const e=t.jsonDoc,i=e.json.textures||[];return(e.json.materials||[]).forEach(((e,n)=>{if(e.extensions&&e.extensions[XT]){const s=this.createPBRSpecularGlossiness();t.materials[n].setExtension(XT,s);const r=e.extensions[XT];if(void 0!==r.diffuseFactor&&s.setDiffuseFactor(r.diffuseFactor),void 0!==r.specularFactor&&s.setSpecularFactor(r.specularFactor),void 0!==r.glossinessFactor&&s.setGlossinessFactor(r.glossinessFactor),void 0!==r.diffuseTexture){const e=r.diffuseTexture;s.setDiffuseTexture(t.textures[i[e.index].source]),t.setTextureInfo(s.getDiffuseTextureInfo(),e)}if(void 0!==r.specularGlossinessTexture){const e=r.specularGlossinessTexture;s.setSpecularGlossinessTexture(t.textures[i[e.index].source]),t.setTextureInfo(s.getSpecularGlossinessTextureInfo(),e)}}})),this}write(t){const e=t.jsonDoc;return this.document.getRoot().listMaterials().forEach((i=>{const n=i.getExtension(XT);if(n){const s=t.materialIndexMap.get(i),r=e.json.materials[s];r.extensions=r.extensions||{};const a=r.extensions[XT]={diffuseFactor:n.getDiffuseFactor(),specularFactor:n.getSpecularFactor(),glossinessFactor:n.getGlossinessFactor()};if(n.getDiffuseTexture()){const e=n.getDiffuseTexture(),i=n.getDiffuseTextureInfo();a.diffuseTexture=t.createTextureInfoDef(e,i)}if(n.getSpecularGlossinessTexture()){const e=n.getSpecularGlossinessTexture(),i=n.getSpecularGlossinessTextureInfo();a.specularGlossinessTexture=t.createTextureInfoDef(e,i)}}})),this}}qT.EXTENSION_NAME=XT;const{R:YT,G:JT,B:$T,A:KT}=kM;class ZT extends bS{init(){this.extensionName=fE,this.propertyType="Sheen",this.parentTypes=[CM.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{sheenColorFactor:[0,0,0],sheenColorTexture:null,sheenColorTextureInfo:new _S(this.graph,"sheenColorTextureInfo"),sheenRoughnessFactor:0,sheenRoughnessTexture:null,sheenRoughnessTextureInfo:new _S(this.graph,"sheenRoughnessTextureInfo")})}getSheenColorFactor(){return this.get("sheenColorFactor")}getSheenColorHex(){return VM.factorToHex(this.getSheenColorFactor())}setSheenColorFactor(t){return this.set("sheenColorFactor",t)}setSheenColorHex(t){const e=this.getSheenColorFactor().slice();return this.set("sheenColorFactor",VM.hexToFactor(t,e))}getSheenColorTexture(){return this.getRef("sheenColorTexture")}getSheenColorTextureInfo(){return this.getRef("sheenColorTexture")?this.getRef("sheenColorTextureInfo"):null}setSheenColorTexture(t){return this.setRef("sheenColorTexture",t,{channels:YT|JT|$T,isColor:!0})}getSheenRoughnessFactor(){return this.get("sheenRoughnessFactor")}setSheenRoughnessFactor(t){return this.set("sheenRoughnessFactor",t)}getSheenRoughnessTexture(){return this.getRef("sheenRoughnessTexture")}getSheenRoughnessTextureInfo(){return this.getRef("sheenRoughnessTexture")?this.getRef("sheenRoughnessTextureInfo"):null}setSheenRoughnessTexture(t){return this.setRef("sheenRoughnessTexture",t,{channels:KT})}}ZT.EXTENSION_NAME=fE;const QT=fE;class tA extends BS{constructor(...t){super(...t),this.extensionName=QT}createSheen(){return new ZT(this.document.getGraph())}read(t){const e=t.jsonDoc,i=e.json.textures||[];return(e.json.materials||[]).forEach(((e,n)=>{if(e.extensions&&e.extensions[QT]){const s=this.createSheen();t.materials[n].setExtension(QT,s);const r=e.extensions[QT];if(void 0!==r.sheenColorFactor&&s.setSheenColorFactor(r.sheenColorFactor),void 0!==r.sheenRoughnessFactor&&s.setSheenRoughnessFactor(r.sheenRoughnessFactor),void 0!==r.sheenColorTexture){const e=r.sheenColorTexture;s.setSheenColorTexture(t.textures[i[e.index].source]),t.setTextureInfo(s.getSheenColorTextureInfo(),e)}if(void 0!==r.sheenRoughnessTexture){const e=r.sheenRoughnessTexture;s.setSheenRoughnessTexture(t.textures[i[e.index].source]),t.setTextureInfo(s.getSheenRoughnessTextureInfo(),e)}}})),this}write(t){const e=t.jsonDoc;return this.document.getRoot().listMaterials().forEach((i=>{const n=i.getExtension(QT);if(n){const s=t.materialIndexMap.get(i),r=e.json.materials[s];r.extensions=r.extensions||{};const a=r.extensions[QT]={sheenColorFactor:n.getSheenColorFactor(),sheenRoughnessFactor:n.getSheenRoughnessFactor()};if(n.getSheenColorTexture()){const e=n.getSheenColorTexture(),i=n.getSheenColorTextureInfo();a.sheenColorTexture=t.createTextureInfoDef(e,i)}if(n.getSheenRoughnessTexture()){const e=n.getSheenRoughnessTexture(),i=n.getSheenRoughnessTextureInfo();a.sheenRoughnessTexture=t.createTextureInfoDef(e,i)}}})),this}}tA.EXTENSION_NAME=QT;const{R:eA,G:iA,B:nA,A:sA}=kM;class rA extends bS{init(){this.extensionName=gE,this.propertyType="Specular",this.parentTypes=[CM.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{specularFactor:1,specularTexture:null,specularTextureInfo:new _S(this.graph,"specularTextureInfo"),specularColorFactor:[1,1,1],specularColorTexture:null,specularColorTextureInfo:new _S(this.graph,"specularColorTextureInfo")})}getSpecularFactor(){return this.get("specularFactor")}setSpecularFactor(t){return this.set("specularFactor",t)}getSpecularColorFactor(){return this.get("specularColorFactor")}setSpecularColorFactor(t){return this.set("specularColorFactor",t)}getSpecularColorHex(){return VM.factorToHex(this.getSpecularColorFactor())}setSpecularColorHex(t){const e=this.getSpecularColorFactor().slice();return this.set("specularColorFactor",VM.hexToFactor(t,e))}getSpecularTexture(){return this.getRef("specularTexture")}getSpecularTextureInfo(){return this.getRef("specularTexture")?this.getRef("specularTextureInfo"):null}setSpecularTexture(t){return this.setRef("specularTexture",t,{channels:sA})}getSpecularColorTexture(){return this.getRef("specularColorTexture")}getSpecularColorTextureInfo(){return this.getRef("specularColorTexture")?this.getRef("specularColorTextureInfo"):null}setSpecularColorTexture(t){return this.setRef("specularColorTexture",t,{channels:eA|iA|nA,isColor:!0})}}rA.EXTENSION_NAME=gE;const aA=gE;class oA extends BS{constructor(...t){super(...t),this.extensionName=aA}createSpecular(){return new rA(this.document.getGraph())}read(t){const e=t.jsonDoc,i=e.json.textures||[];return(e.json.materials||[]).forEach(((e,n)=>{if(e.extensions&&e.extensions[aA]){const s=this.createSpecular();t.materials[n].setExtension(aA,s);const r=e.extensions[aA];if(void 0!==r.specularFactor&&s.setSpecularFactor(r.specularFactor),void 0!==r.specularColorFactor&&s.setSpecularColorFactor(r.specularColorFactor),void 0!==r.specularTexture){const e=r.specularTexture;s.setSpecularTexture(t.textures[i[e.index].source]),t.setTextureInfo(s.getSpecularTextureInfo(),e)}if(void 0!==r.specularColorTexture){const e=r.specularColorTexture;s.setSpecularColorTexture(t.textures[i[e.index].source]),t.setTextureInfo(s.getSpecularColorTextureInfo(),e)}}})),this}write(t){const e=t.jsonDoc;return this.document.getRoot().listMaterials().forEach((i=>{const n=i.getExtension(aA);if(n){const s=t.materialIndexMap.get(i),r=e.json.materials[s];r.extensions=r.extensions||{};const a=r.extensions[aA]={};if(1!==n.getSpecularFactor()&&(a.specularFactor=n.getSpecularFactor()),QM.eq(n.getSpecularColorFactor(),[1,1,1])||(a.specularColorFactor=n.getSpecularColorFactor()),n.getSpecularTexture()){const e=n.getSpecularTexture(),i=n.getSpecularTextureInfo();a.specularTexture=t.createTextureInfoDef(e,i)}if(n.getSpecularColorTexture()){const e=n.getSpecularColorTexture(),i=n.getSpecularColorTextureInfo();a.specularColorTexture=t.createTextureInfoDef(e,i)}}})),this}}oA.EXTENSION_NAME=aA;const{R:hA}=kM;class lA extends bS{init(){this.extensionName=vE,this.propertyType="Transmission",this.parentTypes=[CM.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{transmissionFactor:0,transmissionTexture:null,transmissionTextureInfo:new _S(this.graph,"transmissionTextureInfo")})}getTransmissionFactor(){return this.get("transmissionFactor")}setTransmissionFactor(t){return this.set("transmissionFactor",t)}getTransmissionTexture(){return this.getRef("transmissionTexture")}getTransmissionTextureInfo(){return this.getRef("transmissionTexture")?this.getRef("transmissionTextureInfo"):null}setTransmissionTexture(t){return this.setRef("transmissionTexture",t,{channels:hA})}}lA.EXTENSION_NAME=vE;const cA=vE;class uA extends BS{constructor(...t){super(...t),this.extensionName=cA}createTransmission(){return new lA(this.document.getGraph())}read(t){const e=t.jsonDoc,i=e.json.textures||[];return(e.json.materials||[]).forEach(((e,n)=>{if(e.extensions&&e.extensions[cA]){const s=this.createTransmission();t.materials[n].setExtension(cA,s);const r=e.extensions[cA];if(void 0!==r.transmissionFactor&&s.setTransmissionFactor(r.transmissionFactor),void 0!==r.transmissionTexture){const e=r.transmissionTexture;s.setTransmissionTexture(t.textures[i[e.index].source]),t.setTextureInfo(s.getTransmissionTextureInfo(),e)}}})),this}write(t){const e=t.jsonDoc;return this.document.getRoot().listMaterials().forEach((i=>{const n=i.getExtension(cA);if(n){const s=t.materialIndexMap.get(i),r=e.json.materials[s];r.extensions=r.extensions||{};const a=r.extensions[cA]={transmissionFactor:n.getTransmissionFactor()};if(n.getTransmissionTexture()){const e=n.getTransmissionTexture(),i=n.getTransmissionTextureInfo();a.transmissionTexture=t.createTextureInfoDef(e,i)}}})),this}}uA.EXTENSION_NAME=cA;class dA extends bS{init(){this.extensionName=yE,this.propertyType="Unlit",this.parentTypes=[CM.MATERIAL]}}dA.EXTENSION_NAME=yE;const pA=yE;class mA extends BS{constructor(...t){super(...t),this.extensionName=pA}createUnlit(){return new dA(this.document.getGraph())}read(t){return(t.jsonDoc.json.materials||[]).forEach(((e,i)=>{e.extensions&&e.extensions[pA]&&t.materials[i].setExtension(pA,this.createUnlit())})),this}write(t){const e=t.jsonDoc;return this.document.getRoot().listMaterials().forEach((i=>{if(i.getExtension(pA)){const n=t.materialIndexMap.get(i),s=e.json.materials[n];s.extensions=s.extensions||{},s.extensions[pA]={}}})),this}}mA.EXTENSION_NAME=pA;class fA extends bS{init(){this.extensionName=bE,this.propertyType="Mapping",this.parentTypes=["MappingList"]}getDefaults(){return Object.assign(super.getDefaults(),{material:null,variants:[]})}getMaterial(){return this.getRef("material")}setMaterial(t){return this.setRef("material",t)}addVariant(t){return this.addRef("variants",t)}removeVariant(t){return this.removeRef("variants",t)}listVariants(){return this.listRefs("variants")}}fA.EXTENSION_NAME=bE;class gA extends bS{init(){this.extensionName=bE,this.propertyType="MappingList",this.parentTypes=[CM.PRIMITIVE]}getDefaults(){return Object.assign(super.getDefaults(),{mappings:[]})}addMapping(t){return this.addRef("mappings",t)}removeMapping(t){return this.removeRef("mappings",t)}listMappings(){return this.listRefs("mappings")}}gA.EXTENSION_NAME=bE;class vA extends bS{init(){this.extensionName=bE,this.propertyType="Variant",this.parentTypes=["MappingList"]}}vA.EXTENSION_NAME=bE;const yA=bE;class xA extends BS{constructor(...t){super(...t),this.extensionName=yA}createMappingList(){return new gA(this.document.getGraph())}createVariant(t=""){return new vA(this.document.getGraph(),t)}createMapping(){return new fA(this.document.getGraph())}listVariants(){return Array.from(this.properties).filter((t=>t instanceof vA))}read(t){const e=t.jsonDoc;if(!e.json.extensions||!e.json.extensions[yA])return this;const i=(e.json.extensions[yA].variants||[]).map((t=>this.createVariant().setName(t.name||"")));return(e.json.meshes||[]).forEach(((e,n)=>{const s=t.meshes[n];(e.primitives||[]).forEach(((e,n)=>{if(!e.extensions||!e.extensions[yA])return;const r=this.createMappingList(),a=e.extensions[yA];for(const e of a.mappings){const n=this.createMapping();void 0!==e.material&&n.setMaterial(t.materials[e.material]);for(const t of e.variants||[])n.addVariant(i[t]);r.addMapping(n)}s.listPrimitives()[n].setExtension(yA,r)}))})),this}write(t){const e=t.jsonDoc,i=this.listVariants();if(!i.length)return this;const n=[],s=new Map;for(const e of i)s.set(e,n.length),n.push(t.createPropertyDef(e));for(const e of this.document.getRoot().listMeshes()){const i=t.meshIndexMap.get(e);e.listPrimitives().forEach(((e,n)=>{const r=e.getExtension(yA);if(!r)return;const a=t.jsonDoc.json.meshes[i].primitives[n],o=r.listMappings().map((e=>{const i=t.createPropertyDef(e),n=e.getMaterial();return n&&(i.material=t.materialIndexMap.get(n)),i.variants=e.listVariants().map((t=>s.get(t))),i}));a.extensions=a.extensions||{},a.extensions[yA]={mappings:o}}))}return e.json.extensions=e.json.extensions||{},e.json.extensions[yA]={variants:n},this}}xA.EXTENSION_NAME=yA;const{G:bA}=kM;class _A extends bS{init(){this.extensionName=xE,this.propertyType="Volume",this.parentTypes=[CM.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{thicknessFactor:0,thicknessTexture:null,thicknessTextureInfo:new _S(this.graph,"thicknessTexture"),attenuationDistance:1/0,attenuationColor:[1,1,1]})}getThicknessFactor(){return this.get("thicknessFactor")}setThicknessFactor(t){return this.set("thicknessFactor",t)}getThicknessTexture(){return this.getRef("thicknessTexture")}getThicknessTextureInfo(){return this.getRef("thicknessTexture")?this.getRef("thicknessTextureInfo"):null}setThicknessTexture(t){return this.setRef("thicknessTexture",t,{channels:bA})}getAttenuationDistance(){return this.get("attenuationDistance")}setAttenuationDistance(t){return this.set("attenuationDistance",t)}getAttenuationColor(){return this.get("attenuationColor")}setAttenuationColor(t){return this.set("attenuationColor",t)}getAttenuationColorHex(){return VM.factorToHex(this.getAttenuationColor())}setAttenuationColorHex(t){const e=this.getAttenuationColor().slice();return this.set("attenuationColor",VM.hexToFactor(t,e))}}_A.EXTENSION_NAME=xE;const wA=xE;class MA extends BS{constructor(...t){super(...t),this.extensionName=wA}createVolume(){return new _A(this.document.getGraph())}read(t){const e=t.jsonDoc,i=e.json.textures||[];return(e.json.materials||[]).forEach(((e,n)=>{if(e.extensions&&e.extensions[wA]){const s=this.createVolume();t.materials[n].setExtension(wA,s);const r=e.extensions[wA];if(void 0!==r.thicknessFactor&&s.setThicknessFactor(r.thicknessFactor),void 0!==r.attenuationDistance&&s.setAttenuationDistance(r.attenuationDistance),void 0!==r.attenuationColor&&s.setAttenuationColor(r.attenuationColor),void 0!==r.thicknessTexture){const e=r.thicknessTexture;s.setThicknessTexture(t.textures[i[e.index].source]),t.setTextureInfo(s.getThicknessTextureInfo(),e)}}})),this}write(t){const e=t.jsonDoc;return this.document.getRoot().listMaterials().forEach((i=>{const n=i.getExtension(wA);if(n){const s=t.materialIndexMap.get(i),r=e.json.materials[s];r.extensions=r.extensions||{};const a=r.extensions[wA]={};if(n.getThicknessFactor()>0&&(a.thicknessFactor=n.getThicknessFactor()),Number.isFinite(n.getAttenuationDistance())&&(a.attenuationDistance=n.getAttenuationDistance()),QM.eq(n.getAttenuationColor(),[1,1,1])||(a.attenuationColor=n.getAttenuationColor()),n.getThicknessTexture()){const e=n.getThicknessTexture(),i=n.getThicknessTextureInfo();a.thicknessTexture=t.createTextureInfoDef(e,i)}}})),this}}MA.EXTENSION_NAME=wA;const SA="KHR_mesh_quantization";class EA extends BS{constructor(...t){super(...t),this.extensionName=SA}read(t){return this}write(t){return this}}EA.EXTENSION_NAME=SA;const TA="KHR_texture_basisu";class AA{match(t){return 171===t[0]&&75===t[1]&&84===t[2]&&88===t[3]&&32===t[4]&&50===t[5]&&48===t[6]&&187===t[7]&&13===t[8]&&10===t[9]&&26===t[10]&&10===t[11]}getSize(t){const e=sE(t);return[e.pixelWidth,e.pixelHeight]}getChannels(t){const e=sE(t).dataFormatDescriptor[0];if(163===e.colorModel)return 2===e.samples.length&&15==(15&e.samples[1].channelType)?4:3;if(166===e.colorModel)return 3==(15&e.samples[0].channelType)?4:3;throw new Error(`Unexpected KTX2 colorModel, "${e.colorModel}".`)}getVRAMByteLength(t){const e=sE(t),i=this.getChannels(t)>3;let n=0;for(let t=0;t<e.levels.length;t++){const s=e.levels[t];n+=s.uncompressedByteLength?s.uncompressedByteLength:Math.max(1,Math.floor(e.pixelWidth/Math.pow(2,t)))/4*(Math.max(1,Math.floor(e.pixelHeight/Math.pow(2,t)))/4)*(i?16:8)}return n}}class CA extends BS{constructor(...t){super(...t),this.extensionName=TA,this.prereadTypes=[CM.TEXTURE]}static register(){jM.registerFormat("image/ktx2",new AA)}preread(t){return t.jsonDoc.json.textures.forEach((t=>{t.extensions&&t.extensions[TA]&&(t.source=t.extensions[TA].source)})),this}read(t){return this}write(t){const e=t.jsonDoc;return this.document.getRoot().listTextures().forEach((i=>{if("image/ktx2"===i.getMimeType()){const n=t.imageIndexMap.get(i);e.json.textures.forEach((t=>{t.source===n&&(t.extensions=t.extensions||{},t.extensions[TA]={source:t.source},delete t.source)}))}})),this}}CA.EXTENSION_NAME=TA;class IA extends bS{init(){this.extensionName=_E,this.propertyType="Transform",this.parentTypes=[CM.TEXTURE_INFO]}getDefaults(){return Object.assign(super.getDefaults(),{offset:[0,0],rotation:0,scale:[1,1],texCoord:null})}getOffset(){return this.get("offset")}setOffset(t){return this.set("offset",t)}getRotation(){return this.get("rotation")}setRotation(t){return this.set("rotation",t)}getScale(){return this.get("scale")}setScale(t){return this.set("scale",t)}getTexCoord(){return this.get("texCoord")}setTexCoord(t){return this.set("texCoord",t)}}IA.EXTENSION_NAME=_E;const RA=_E;class kA extends BS{constructor(...t){super(...t),this.extensionName=RA}createTransform(){return new IA(this.document.getGraph())}read(t){for(const[e,i]of Array.from(t.textureInfos.entries())){if(!i.extensions||!i.extensions[RA])continue;const t=this.createTransform(),n=i.extensions[RA];void 0!==n.offset&&t.setOffset(n.offset),void 0!==n.rotation&&t.setRotation(n.rotation),void 0!==n.scale&&t.setScale(n.scale),void 0!==n.texCoord&&t.setTexCoord(n.texCoord),e.setExtension(RA,t)}return this}write(t){const e=Array.from(t.textureInfoDefMap.entries());for(const[t,i]of e){const e=t.getExtension(RA);if(!e)continue;i.extensions=i.extensions||{};const n={},s=QM.eq;s(e.getOffset(),[0,0])||(n.offset=e.getOffset()),0!==e.getRotation()&&(n.rotation=e.getRotation()),s(e.getScale(),[1,1])||(n.scale=e.getScale()),null!=e.getTexCoord()&&(n.texCoord=e.getTexCoord()),i.extensions[RA]=n}return this}}kA.EXTENSION_NAME=RA;const PA=[CM.ROOT,CM.SCENE,CM.NODE,CM.MESH,CM.MATERIAL,CM.TEXTURE,CM.ANIMATION];class DA extends bS{init(){this.extensionName=wE,this.propertyType="Packet",this.parentTypes=PA}getDefaults(){return Object.assign(super.getDefaults(),{context:{},properties:{}})}getContext(){return this.get("context")}setContext(t){return this.set("context",AE({},t))}listProperties(){return Object.keys(this.get("properties"))}getProperty(t){const e=this.get("properties");return t in e?e[t]:null}setProperty(t,e){this._assertContext(t);const i=AE({},this.get("properties"));return e?i[t]=e:delete i[t],this.set("properties",i)}toJSONLD(){return AE({"@context":LA(this.get("context"))},LA(this.get("properties")))}fromJSONLD(t){const e=(t=LA(t))["@context"];return e&&this.set("context",e),delete t["@context"],this.set("properties",t)}_assertContext(t){if(!(t.split(":")[0]in this.get("context")))throw new Error(`${wE}: Missing context for term, "${t}".`)}}function LA(t){return JSON.parse(JSON.stringify(t))}DA.EXTENSION_NAME=wE;const OA=wE;class NA extends BS{constructor(...t){super(...t),this.extensionName=OA}createPacket(){return new DA(this.document.getGraph())}listPackets(){return Array.from(this.properties)}read(t){var e;const i=null==(e=t.jsonDoc.json.extensions)?void 0:e[OA];if(!i||!i.packets)return this;const n=t.jsonDoc.json,s=this.document.getRoot(),r=i.packets.map((t=>this.createPacket().fromJSONLD(t))),a=[[n.asset],n.scenes,n.nodes,n.meshes,n.materials,n.images,n.animations],o=[[s],s.listScenes(),s.listNodes(),s.listMeshes(),s.listMaterials(),s.listTextures(),s.listAnimations()];for(let t=0;t<a.length;t++){const e=a[t]||[];for(let i=0;i<e.length;i++){const n=e[i];n.extensions&&n.extensions[OA]&&o[t][i].setExtension(OA,r[n.extensions[OA].packet])}}return this}write(t){const{json:e}=t.jsonDoc,i=[];for(const n of this.properties){i.push(n.toJSONLD());for(const s of n.listParents()){let n;switch(s.propertyType){case CM.ROOT:n=e.asset;break;case CM.SCENE:n=e.scenes[t.sceneIndexMap.get(s)];break;case CM.NODE:n=e.nodes[t.nodeIndexMap.get(s)];break;case CM.MESH:n=e.meshes[t.meshIndexMap.get(s)];break;case CM.MATERIAL:n=e.materials[t.materialIndexMap.get(s)];break;case CM.TEXTURE:n=e.images[t.imageIndexMap.get(s)];break;case CM.ANIMATION:n=e.animations[t.animationIndexMap.get(s)];break;default:n=null,this.document.getLogger().warn(`[${OA}]: Unsupported parent property, "${s.propertyType}"`)}n&&(n.extensions=n.extensions||{},n.extensions[OA]={packet:i.length-1})}}return i.length>0&&(e.extensions=e.extensions||{},e.extensions[OA]={packets:i}),this}}NA.EXTENSION_NAME=OA;const BA=[pT,vT,MT,IT,PT,OT,FT,qT,oA,tA,uA,mA,xA,MA,EA,CA,kA,NA];var zA=a(448),UA=a(367);function FA(t,e,i=-1){if(4===t.shape.length)return FA(t.pick(i),e,0);if(3===t.shape.length)if(3===t.shape[2])UA.assign(zA(e,[t.shape[0],t.shape[1],3],[4,4*t.shape[0],1]),t),UA.assigns(zA(e,[t.shape[0]*t.shape[1]],[4],3),255);else if(4===t.shape[2])UA.assign(zA(e,[t.shape[0],t.shape[1],4],[4,4*t.shape[0],1]),t);else{if(1!==t.shape[2])throw new Error("[ndarray-pixels] Incompatible array shape.");UA.assign(zA(e,[t.shape[0],t.shape[1],3],[4,4*t.shape[0],1]),zA(t.data,[t.shape[0],t.shape[1],3],[t.stride[0],t.stride[1],0],t.offset)),UA.assigns(zA(e,[t.shape[0]*t.shape[1]],[4],3),255)}else{if(2!==t.shape.length)throw new Error("[ndarray-pixels] Incompatible array shape.");UA.assign(zA(e,[t.shape[0],t.shape[1],3],[4,4*t.shape[0],1]),zA(t.data,[t.shape[0],t.shape[1],3],[t.stride[0],t.stride[1],0],t.offset)),UA.assigns(zA(e,[t.shape[0]*t.shape[1]],[4],3),255)}return e}async function GA(t,e,i={}){const n=document.createElement("canvas");n.width=t.shape[0],n.height=t.shape[1];const s=n.getContext("2d"),r=s.getImageData(0,0,n.width,n.height);FA(t,r.data),s.putImageData(r,0,0);const a=i.quality?i.quality/100:void 0;return"image/jpeg"===e?VA(n,"image/jpeg",a):VA(n,e)}function VA(t,e,i){return new Promise(((n,s)=>{t.toBlob((async t=>{t?n(new Uint8Array(await t.arrayBuffer())):s(new Error("[ndarray-pixels] Failed to canvas.toBlob()."))}),e,i)}))}async function HA(t,e){return function(t,e){if(!(t instanceof Uint8Array))throw new Error("[ndarray-pixels] Input must be Uint8Array or Buffer.");const i=new Blob([t],{type:e}),n=URL.createObjectURL(i);return new Promise(((t,e)=>{const i=new Image;i.crossOrigin="anonymous",i.onload=function(){URL.revokeObjectURL(n);const e=document.createElement("canvas");e.width=i.width,e.height=i.height;const s=e.getContext("2d");s.drawImage(i,0,0);const r=s.getImageData(0,0,i.width,i.height);t(zA(new Uint8Array(r.data),[i.width,i.height,4],[4,4*i.width,1],0))},i.onerror=t=>{URL.revokeObjectURL(n),e(t)},i.src=n}))}(t,e)}function jA(){return jA=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var i=arguments[e];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(t[n]=i[n])}return t},jA.apply(this,arguments)}function WA(t,e){return Object.defineProperty(e,"name",{value:t}),e}async function XA(t,e,i){if(!t)return null;const n=t.getImage();if(!n)return null;const s=await HA(n,t.getMimeType());for(let t=0;t<s.shape[0];++t)for(let e=0;e<s.shape[1];++e)i(s,t,e);const r=await async function(t,e){return GA(t,e)}(s,"image/png");return e.setImage(r).setMimeType("image/png")}var qA="undefined"!=typeof Float32Array?Float32Array:Array;function YA(){var t=new qA(3);return qA!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});function JA(){var t=new qA(4);return qA!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t}YA();JA();CM.ACCESSOR,CM.MESH,CM.TEXTURE,CM.MATERIAL,CM.SKIN;CM.NODE,CM.SKIN,CM.MESH,CM.CAMERA,CM.PRIMITIVE,CM.PRIMITIVE_TARGET,CM.ANIMATION,CM.MATERIAL,CM.TEXTURE,CM.ACCESSOR,CM.BUFFER;const $A={DEFAULT:1e-4,TEXCOORD:1e-4,COLOR:.01,NORMAL:.05,JOINTS:0,WEIGHTS:.01};$A.DEFAULT,$A.NORMAL;const{ROOT:KA,NODE:ZA,MESH:QA,PRIMITIVE:tC,ACCESSOR:eC}=CM;Int8Array,Int16Array,Int32Array;const{TRANSLATION:iC,ROTATION:nC,SCALE:sC,WEIGHTS:rC}=gS.TargetPath,aC={pattern:/.*/,quantizationVolume:"mesh",quantizePosition:14,quantizeNormal:10,quantizeTexcoord:12,quantizeColor:8,quantizeWeight:8,quantizeGeneric:12,normalizeWeights:!0};jA({level:"high"},aC);const oC="metalRough",hC={};function lC(t=hC){return jA({},hC,t),WA(oC,(async t=>{const e=t.getLogger();if(!t.getRoot().listExtensionsUsed().map((t=>t.extensionName)).includes("KHR_materials_pbrSpecularGlossiness"))return void e.warn(`${oC}: KHR_materials_pbrSpecularGlossiness not found on document.`);const i=t.createExtension(OT),n=t.createExtension(oA),s=t.createExtension(qT),r=new Set;for(const e of t.getRoot().listMaterials()){const s=e.getExtension("KHR_materials_pbrSpecularGlossiness");if(!s)continue;const a=n.createSpecular().setSpecularFactor(1).setSpecularColorFactor(s.getSpecularFactor());r.add(s.getSpecularGlossinessTexture()),r.add(e.getBaseColorTexture()),r.add(e.getMetallicRoughnessTexture()),e.setBaseColorFactor(s.getDiffuseFactor()).setMetallicFactor(0).setRoughnessFactor(1).setExtension("KHR_materials_ior",i.createIOR().setIOR(1e3)).setExtension("KHR_materials_specular",a);const o=s.getDiffuseTexture();o&&(e.setBaseColorTexture(o),e.getBaseColorTextureInfo().copy(s.getDiffuseTextureInfo()));const h=s.getSpecularGlossinessTexture();if(h){const i=s.getSpecularGlossinessTextureInfo(),n=t.createTexture();await XA(h,n,((t,e,i)=>{t.set(e,i,3,255)})),a.setSpecularTexture(n),a.setSpecularColorTexture(n),a.getSpecularTextureInfo().copy(i),a.getSpecularColorTextureInfo().copy(i);const r=s.getGlossinessFactor(),o=t.createTexture();await XA(h,o,((t,e,i)=>{const n=255-Math.round(t.get(e,i,3)*r);t.set(e,i,0,0),t.set(e,i,1,n),t.set(e,i,2,0),t.set(e,i,3,255)})),e.setMetallicRoughnessTexture(o),e.getMetallicRoughnessTextureInfo().copy(i)}else a.setSpecularColorFactor(s.getSpecularFactor()),e.setRoughnessFactor(1-s.getGlossinessFactor());e.setExtension("KHR_materials_pbrSpecularGlossiness",null)}s.dispose();for(const t of r)t&&1===t.listParents().length&&t.dispose();e.debug(`${oC}: Complete.`)}))}var cC;function uC(t,e,i){for(let n=0,s=i.length;n<s;n++)i[n]=t[e*s+n];return i}function dC(t,e,i){for(let n=0,s=i.length;n<s;n++)t[e*s+n]=i[n]}function pC(t,e,i=0){if(t.length!==e.length)return!1;for(let n=0;n<t.length;n++)if(Math.abs(t[n]-e[n])>i)return!1;return!0}function mC(t,e,i){return t*(1-i)+e*i}function fC(t,e,i,n){for(let s=0;s<e.length;s++)t[s]=mC(e[s],i[s],n);return t}function gC(t,e,i,n){let s,r,a,o,h,l=e[0],c=e[1],u=e[2],d=e[3],p=i[0],m=i[1],f=i[2],g=i[3];return l*p+c*m+u*f+d*g,r<0&&(-r,-p,-m,-f,-g),1-r>1e-6?(Math.acos(r),Math.sin(s),Math.sin((1-n)*s)/a,Math.sin(n*s)/a):(1-n,n),t[0]=o*l+h*p,t[1]=o*c+h*m,t[2]=o*u+h*f,t[3]=o*d+h*g,t}function vC(t,e){const i=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]}(t,e);return Math.acos(2*i*i-1)}!function(t){t[t.STEP=0]="STEP",t[t.LERP=1]="LERP",t[t.SLERP=2]="SLERP"}(cC||(cC={}));new Float32Array(0),Promise.resolve();var yC;!function(t){t.LANCZOS3="lanczos3",t.LANCZOS2="lanczos2"}(yC||(yC={}));yC.LANCZOS3;yC.LANCZOS3;var xC=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class bC extends ku{get Id(){return Cu.Viking}constructor(t){super(t,Iu.GltfParser,"",(e=>xC(this,void 0,void 0,(function*(){const i=(new QS).registerExtensions(BA),n=yield i.read("assets/monster/toad_mage.glb");yield n.transform(lC());const s=yield i.writeBinary(n);t.Load.parse(s.buffer,"",(t=>{this.Gltf=t,this.meshs=t.scene,this.meshs.castShadow=!0,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!0}));this.meshs.children[0].scale.set(2,2,2),this.mixer=new ru(t.scene),this.clips.set(Au.Idle,t.animations.find((t=>"idle"==t.name))),this.clips.set(Au.Run,t.animations.find((t=>"run"==t.name))),this.clips.set(Au.Punch,t.animations.find((t=>"attack"==t.name))),this.clips.set(Au.MagicH1,t.animations.find((t=>"cast"==t.name))),e(this.meshs)}))}))))}GetBodyMeshId(){return"mixamorigRightHand"}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.set(e.x,e.y,e.z),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),this.size)return this.size;const e=(new Be).setFromObject(this.meshs.children[0]);return this.size=e.getSize(new Le),this.size.x=2*Math.ceil(this.size.x),this.size.y=4,this.size.z=2*Math.ceil(this.size.z),this.size}}var _C=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class wC extends ku{get Id(){return Cu.Viking}constructor(t){super(t,Iu.GltfParser,"",(e=>_C(this,void 0,void 0,(function*(){const i=(new QS).registerExtensions(BA),n=yield i.read("assets/monster/kitten_monk.glb");yield n.transform(lC());const s=yield i.writeBinary(n);t.Load.parse(s.buffer,"",(t=>{this.Gltf=t,this.meshs=t.scene,this.meshs.castShadow=!0,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!0}));this.meshs.scale.set(1,1,1),this.mixer=new ru(t.scene),this.clips.set(Au.Idle,t.animations.find((t=>"idle"==t.name))),this.clips.set(Au.Run,t.animations.find((t=>"run"==t.name))),this.clips.set(Au.Punch,t.animations.find((t=>"kick-1"==t.name))),this.clips.set(Au.MagicH1,t.animations.find((t=>"kick-2"==t.name))),e(this.meshs)}))}))))}GetBodyMeshId(){return"mixamorigRightHand"}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.set(e.x,e.y,e.z),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),this.size)return this.size;const e=(new Be).setFromObject(this.meshs.children[0]);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.y=2.3,this.size.z=Math.ceil(this.size.z),this.size}}var MC=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class SC extends ku{get Id(){return Cu.Skeleton}constructor(t){super(t,Iu.Gltf,"assets/monster/skeleton.glb",(t=>MC(this,void 0,void 0,(function*(){this.Gltf=t,this.meshs=t.scene,this.meshs.castShadow=!0,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!0}));const e=.008;this.meshs.children[0].scale.set(e,e,e),this.mixer=new ru(t.scene),this.clips.set(Au.Idle,t.animations.find((t=>"metarig|0_Idle"==t.name))),this.clips.set(Au.Run,t.animations.find((t=>"metarig|1_Walk"==t.name))),this.clips.set(Au.Punch,t.animations.find((t=>"metarig|3_Attack"==t.name))),this.clips.set(Au.Dying,t.animations.find((t=>"metarig|4_GetHit"==t.name))),this.meshs.children[0].position.y=2.8}))))}GetBodyMeshId(){return"mixamorigRightHand"}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.set(e.x,e.y,e.z),(new Be).setFromObject(this.box)}GetSize(t){return null==this.meshs&&(this.meshs=t),this.size||(this.size=new Le(2,4,2)),this.size}}var EC=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class TC extends ku{get Id(){return Cu.Tomato0}constructor(t){super(t,Iu.Gltf,"assets/plant/tomato_0.glb",(t=>EC(this,void 0,void 0,(function*(){this.gltf=t,this.meshs=t.scene,this.meshs.castShadow=!0;this.meshs.scale.set(2,2,2),this.meshs.position.set(0,0,0),this.meshs.rotation.set(0,0,0)}))))}GetBodyMeshId(){return"mixamorigRightHand"}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),null!=this.size)return this.size;const e=(new Be).setFromObject(this.meshs.children[0]);return this.size=e.getSize(new Le),this.size.x=2*Math.ceil(this.size.x),this.size.y=3,this.size.z=2*Math.ceil(this.size.z),this.size}}class AC extends ku{get Id(){return Cu.Tomato1}constructor(t){super(t,Iu.Gltf,"assets/plant/tomato_1.glb",(t=>EC(this,void 0,void 0,(function*(){this.gltf=t,this.meshs=t.scene,this.meshs.castShadow=!0;this.meshs.scale.set(2,2,2),this.meshs.position.set(0,0,0),this.meshs.rotation.set(0,0,0)}))))}GetBodyMeshId(){return"mixamorigRightHand"}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),null!=this.size)return this.size;const e=(new Be).setFromObject(this.meshs.children[0]);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.y=3,this.size.z=Math.ceil(this.size.z),this.size}}class CC extends ku{get Id(){return Cu.Tomato2}constructor(t){super(t,Iu.Gltf,"assets/plant/tomato_2.glb",(t=>EC(this,void 0,void 0,(function*(){this.gltf=t,this.meshs=t.scene,this.meshs.castShadow=!0;this.meshs.scale.set(2,2,2),this.meshs.position.set(0,0,0),this.meshs.rotation.set(0,0,0)}))))}GetBodyMeshId(){return"mixamorigRightHand"}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),null!=this.size)return this.size;const e=(new Be).setFromObject(this.meshs.children[0]);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.y=3,this.size.z=Math.ceil(this.size.z),this.size}}var IC=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class RC extends ku{get Id(){return Cu.Carrot0}constructor(t){super(t,Iu.Gltf,"assets/plant/carrot_0.glb",(t=>IC(this,void 0,void 0,(function*(){this.gltf=t,this.meshs=t.scene,this.meshs.castShadow=!0;this.meshs.scale.set(2,2,2),this.meshs.position.set(0,0,0),this.meshs.rotation.set(0,0,0)}))))}GetBodyMeshId(){return"mixamorigRightHand"}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),null!=this.size)return this.size;const e=(new Be).setFromObject(this.meshs.children[0]);return this.size=e.getSize(new Le),this.size.x=2*Math.ceil(this.size.x),this.size.y=3,this.size.z=2*Math.ceil(this.size.z),this.size}}class kC extends ku{get Id(){return Cu.Carrot1}constructor(t){super(t,Iu.Gltf,"assets/plant/carrot_1.glb",(t=>IC(this,void 0,void 0,(function*(){this.gltf=t,this.meshs=t.scene,this.meshs.castShadow=!0;this.meshs.scale.set(2,2,2),this.meshs.position.set(0,0,0),this.meshs.rotation.set(0,0,0)}))))}GetBodyMeshId(){return"mixamorigRightHand"}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),null!=this.size)return this.size;const e=(new Be).setFromObject(this.meshs.children[0]);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.y=3,this.size.z=Math.ceil(this.size.z),this.size}}class PC extends ku{get Id(){return Cu.Carrot2}constructor(t){super(t,Iu.Gltf,"assets/plant/carrot_2.glb",(t=>IC(this,void 0,void 0,(function*(){this.gltf=t,this.meshs=t.scene,this.meshs.castShadow=!0;this.meshs.scale.set(2,2,2),this.meshs.position.set(0,0,0),this.meshs.rotation.set(0,0,0)}))))}GetBodyMeshId(){return"mixamorigRightHand"}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),null!=this.size)return this.size;const e=(new Be).setFromObject(this.meshs.children[0]);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.y=3,this.size.z=Math.ceil(this.size.z),this.size}}var DC=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class LC extends ku{get Id(){return Cu.Potato0}constructor(t){super(t,Iu.Gltf,"assets/plant/potato_0.glb",(t=>DC(this,void 0,void 0,(function*(){this.gltf=t,this.meshs=t.scene,this.meshs.castShadow=!0;this.meshs.scale.set(2,2,2),this.meshs.position.set(0,0,0),this.meshs.rotation.set(0,0,0)}))))}GetBodyMeshId(){return"mixamorigRightHand"}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),null!=this.size)return this.size;const e=(new Be).setFromObject(this.meshs.children[0]);return this.size=e.getSize(new Le),this.size.x=2*Math.ceil(this.size.x),this.size.y=3,this.size.z=2*Math.ceil(this.size.z),this.size}}class OC extends ku{get Id(){return Cu.Potato1}constructor(t){super(t,Iu.Gltf,"assets/plant/potato_1.glb",(t=>DC(this,void 0,void 0,(function*(){this.gltf=t,this.meshs=t.scene,this.meshs.castShadow=!0;this.meshs.scale.set(2,2,2),this.meshs.position.set(0,0,0),this.meshs.rotation.set(0,0,0)}))))}GetBodyMeshId(){return"mixamorigRightHand"}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),null!=this.size)return this.size;const e=(new Be).setFromObject(this.meshs.children[0]);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.y=3,this.size.z=Math.ceil(this.size.z),this.size}}class NC extends ku{get Id(){return Cu.Potato2}constructor(t){super(t,Iu.Gltf,"assets/plant/potato_2.glb",(t=>DC(this,void 0,void 0,(function*(){this.gltf=t,this.meshs=t.scene,this.meshs.castShadow=!0;this.meshs.scale.set(2,2,2),this.meshs.position.set(0,0,0),this.meshs.rotation.set(0,0,0)}))))}GetBodyMeshId(){return"mixamorigRightHand"}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),null!=this.size)return this.size;const e=(new Be).setFromObject(this.meshs.children[0]);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.y=3,this.size.z=Math.ceil(this.size.z),this.size}}class BC extends ku{get Id(){return this.id}constructor(t){super(t,Iu.Gltf,"assets/furniture/toilet.glb",(t=>{this.meshs=new Da,this.meshs.add(t.scene),this.meshs.castShadow=!0,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!0}));this.meshs.children[0].rotateY(Math.PI),this.meshs.children[0].scale.set(.8,.8,.8)})),this.id=Cu.Toilet}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(this.meshs.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),this.size)return this.size;const e=(new Be).setFromObject(t);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.y=Math.ceil(this.size.y),this.size.z=Math.ceil(this.size.z),this.size}GetBodyMeshId(){return"mixamorigRightHand"}}class zC extends ku{get Id(){return this.id}constructor(t){super(t,Iu.Gltf,"assets/furniture/sink.glb",(t=>{this.meshs=new Da,this.meshs.add(t.scene),this.meshs.castShadow=!0,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!0}));this.meshs.children[0].rotateY(Math.PI),this.meshs.children[0].scale.set(.8,.8,.8)})),this.id=Cu.Sink}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),this.size)return this.size;const e=(new Be).setFromObject(t);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.y=Math.ceil(this.size.y),this.size.z=Math.ceil(this.size.z),this.size}GetBodyMeshId(){return"mixamorigRightHand"}}class UC extends ku{get Id(){return this.id}constructor(t){super(t,Iu.Gltf,"assets/furniture/bath.glb",(t=>{this.meshs=new Da,this.meshs.add(t.scene),this.meshs.castShadow=!0,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!0}));this.meshs.children[0].rotateY(Math.PI),this.meshs.children[0].scale.set(1,.8,1)})),this.id=Cu.Bath}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),this.size)return this.size;const e=(new Be).setFromObject(t);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.y=Math.ceil(this.size.y),this.size.z=Math.ceil(this.size.z),this.size}GetBodyMeshId(){return"mixamorigRightHand"}}class FC extends ku{get Id(){return this.id}constructor(t){super(t,Iu.Gltf,"assets/furniture/tv.glb",(t=>{this.meshs=new Da,this.meshs.add(t.scene),this.meshs.castShadow=!0,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!0}));this.meshs.children[0].rotateY(Math.PI),this.meshs.children[0].scale.set(1,1,1)})),this.id=Cu.TV}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),this.size)return this.size;const e=(new Be).setFromObject(t);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.y=Math.ceil(this.size.y),this.size.z=Math.ceil(this.size.z),this.size}GetBodyMeshId(){return"mixamorigRightHand"}}class GC extends ku{get Id(){return this.id}constructor(t){super(t,Iu.Gltf,"assets/furniture/table.glb",(t=>{this.meshs=new Da,this.meshs.add(t.scene),this.meshs.castShadow=!0,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!0}));this.meshs.children[0].rotateY(Math.PI),this.meshs.children[0].scale.set(.8,.8,.8)})),this.id=Cu.Table}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),this.size)return this.size;const e=(new Be).setFromObject(t);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.y=Math.ceil(this.size.y),this.size.z=Math.ceil(this.size.z),this.size}GetBodyMeshId(){return"mixamorigRightHand"}}class VC extends ku{get Id(){return this.id}constructor(t){super(t,Iu.Gltf,"assets/furniture/bookshelf.glb",(t=>{this.meshs=new Da,this.meshs.add(t.scene),this.meshs.castShadow=!0,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!0}));this.meshs.children[0].rotateY(Math.PI),this.meshs.children[0].scale.set(.8,.8,.8),this.meshs.children[0].position.z=-.5})),this.id=Cu.Bookshelf}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),this.size)return this.size;const e=(new Be).setFromObject(t);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.y=Math.ceil(this.size.y)-.5,this.size.z=Math.ceil(this.size.z)-1,this.size}GetBodyMeshId(){return"mixamorigRightHand"}}class HC extends ku{get Id(){return this.id}constructor(t){super(t,Iu.Gltf,"assets/furniture/kitchen.glb",(t=>{this.meshs=new Da,this.meshs.add(t.scene),this.meshs.castShadow=!0,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!0}));this.meshs.children[0].rotateY(Math.PI),this.meshs.children[0].scale.set(.8,.8,.8)})),this.id=Cu.Kitchen}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),this.size)return this.size;const e=(new Be).setFromObject(t);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.y=Math.ceil(this.size.y),this.size.z=Math.ceil(this.size.z),this.size}GetBodyMeshId(){return"mixamorigRightHand"}}class jC extends ku{get Id(){return this.id}constructor(t){super(t,Iu.Gltf,"assets/furniture/refrigerator.glb",(t=>{this.meshs=new Da,this.meshs.add(t.scene),this.meshs.castShadow=!0,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!0}));this.meshs.children[0].rotateY(Math.PI),this.meshs.children[0].scale.set(.8,.8,.8)})),this.id=Cu.Refrigerator}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),this.size)return this.size;const e=(new Be).setFromObject(t);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.y=Math.ceil(this.size.y),this.size.z=Math.ceil(this.size.z),this.size}GetBodyMeshId(){return"mixamorigRightHand"}}class WC extends ku{get Id(){return this.id}constructor(t){super(t,Iu.Gltf,"assets/furniture/kit_table.glb",(t=>{this.meshs=new Da,this.meshs.add(t.scene),this.meshs.castShadow=!0,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!0}));this.meshs.children[0].rotateY(Math.PI),this.meshs.children[0].scale.set(.8,.8,.8)})),this.id=Cu.KitTable}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),this.size)return this.size;const e=(new Be).setFromObject(t);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.y=Math.ceil(this.size.y),this.size.z=Math.ceil(this.size.z),this.size}GetBodyMeshId(){return"mixamorigRightHand"}}class XC extends ku{get Id(){return this.id}constructor(t){super(t,Iu.Gltf,"assets/furniture/oven.glb",(t=>{this.meshs=new Da,this.meshs.add(t.scene),this.meshs.castShadow=!0,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!0}));this.meshs.children[0].rotateY(Math.PI),this.meshs.children[0].scale.set(.8,.8,.8)})),this.id=Cu.Oven}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),this.size)return this.size;const e=(new Be).setFromObject(t);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.y=Math.ceil(this.size.y),this.size.z=Math.ceil(this.size.z),this.size}GetBodyMeshId(){return"mixamorigRightHand"}}var qC=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class YC extends ku{get Id(){return Cu.Apple}constructor(t){super(t,Iu.Gltf,"assets/plant/apple.glb",(t=>qC(this,void 0,void 0,(function*(){this.gltf=t,this.meshs=t.scene,this.meshs.castShadow=!0;this.meshs.scale.set(.5,.5,.5),this.meshs.position.set(0,0,0),this.meshs.rotation.set(0,0,0)}))))}GetBodyMeshId(){return"mixamorigRightHand"}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),null!=this.size)return this.size;const e=(new Be).setFromObject(this.meshs);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.z=Math.ceil(this.size.z),this.size}}class JC extends ku{get Id(){return Cu.Coconut}constructor(t){super(t,Iu.Gltf,"assets/plant/coconut.glb",(t=>qC(this,void 0,void 0,(function*(){this.gltf=t,this.meshs=t.scene,this.meshs.castShadow=!0;this.meshs.scale.set(.5,.5,.5),this.meshs.position.set(0,0,0),this.meshs.rotation.set(0,0,0)}))))}GetBodyMeshId(){return"mixamorigRightHand"}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),null!=this.size)return this.size;const e=(new Be).setFromObject(this.meshs.children[0]);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.z=Math.ceil(this.size.z),this.size}}var $C=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class KC extends ku{get Id(){return Cu.Dog}constructor(t){super(t,Iu.Gltf,"assets/animals/dog.glb",(t=>$C(this,void 0,void 0,(function*(){this.Gltf=t,this.meshs=t.scene,this.meshs.castShadow=!0,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!0,t.receiveShadow=!1,t.isMesh&&(t.material=new Fl({map:t.material.map}))}));this.meshs.scale.set(2,2,2),this.mixer=new ru(t.scene),this.clips.set(Au.Idle,t.animations.find((t=>"idle"==t.name))),this.clips.set(Au.Run,t.animations.find((t=>"walk"==t.name))),this.clips.set(Au.Punch,t.animations.find((t=>"bark"==t.name))),this.clips.set(Au.Dying,t.animations.find((t=>"dead"==t.name)))}))))}GetBodyMeshId(){return"mixamorigRightHand"}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.set(e.x,e.y,e.z),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),this.size)return this.size;const e=(new Be).setFromObject(this.meshs.children[0]);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.y=3,this.size.z=Math.ceil(this.size.z),this.size}}var ZC=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class QC extends ku{get Id(){return Cu.PetSnake}constructor(t){super(t,Iu.Gltf,"assets/animals/animalpack.glb",(t=>ZC(this,void 0,void 0,(function*(){this.Gltf=t,this.meshs=t.scene,this.meshs.castShadow=!0,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!0}));this.meshs.scale.set(2,2,2),this.mixer=new ru(t.scene),this.clips.set(Au.Idle,t.animations.find((t=>"Bilby_idleSit"==t.name))),this.clips.set(Au.Run,t.animations.find((t=>"Bilby_run"==t.name))),this.clips.set(Au.Punch,t.animations.find((t=>"Bilby_atk1_bite"==t.name))),this.clips.set(Au.MonBiting,t.animations.find((t=>"Bilby_atk2_tail"==t.name))),this.clips.set(Au.Jump,t.animations.find((t=>"Bilby_jump"==t.name))),this.clips.set(Au.MonScream,t.animations.find((t=>"Bilby_smell"==t.name)))}))))}GetBodyMeshId(){return"mixamorigRightHand"}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.set(e.x,e.y,e.z),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),this.size)return this.size;const e=(new Be).setFromObject(this.meshs.children[0]);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.y=1,this.size.z=Math.ceil(this.size.z),this.size}}var tI=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class eI extends ku{get Id(){return Cu.Dog}constructor(t){super(t,Iu.Gltf,"assets/animals/smiley_bee.glb",(t=>tI(this,void 0,void 0,(function*(){this.Gltf=t,this.meshs=t.scene,this.meshs.castShadow=!0,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!0,t.receiveShadow=!1,t.isMesh&&(t.material=new Fl({map:t.material.map}))}));const e=.1;this.info={scale:e},this.meshs.children[0].scale.set(e,e,e),this.meshs.children[0].position.x=1.68,this.meshs.children[0].position.y=this.info.calY=5,this.meshs.children[0].rotateZ(Math.PI),this.mixer=new ru(t.scene),this.clips.set(Au.Idle,t.animations.find((t=>"Scene"==t.name)))}))))}GetBodyMeshId(){return"mixamorigRightHand"}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.set(e.x,e.y,e.z),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),this.size)return this.size;const e=(new Be).setFromObject(this.meshs.children[0]);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.y=3,this.size.z=Math.ceil(this.size.z),this.size}}class iI extends ku{get Id(){return this.id}constructor(t){super(t,Iu.Gltf,"assets/custom_island/empty.glb",(t=>{this.meshs=t.scene})),this.id=Cu.Empty}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),this.size)return this.size;const e=(new Be).setFromObject(t);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x-2),this.size.y=Math.ceil(this.size.y-3),this.size.z=Math.ceil(this.size.z-1),this.size}GetBodyMeshId(){return"mixamorigRightHand"}}var nI=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class sI extends ku{get Id(){return Cu.Hellboy}constructor(t){super(t,Iu.Fbx,"assets/cutemonster/monster.fbx",(t=>nI(this,void 0,void 0,(function*(){this.meshs=t,this.meshs.castShadow=!0,this.meshs.receiveShadow=!0;const e=new yc;this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!0,t instanceof On&&e.load("assets/cutemonster/monster_Standardmaterial_BaseMap.png",(e=>{t.material.map=e,t.material.needsupdate=!0,t.material=new Fl({map:t.material.map})}))}));const i=.08;this.meshs.scale.set(i,i,i),yield this.LoadAnimation("assets/cutemonster/Idle.fbx",Au.Idle),yield this.LoadAnimation("assets/cutemonster/Running.fbx",Au.Run),yield this.LoadAnimation("assets/cutemonster/Jumping Up.fbx",Au.Jump),yield this.LoadAnimation("assets/cutemonster/Punch Combo.fbx",Au.Punch),yield this.LoadAnimation("assets/cutemonster/Fight Idle.fbx",Au.FightIdle),yield this.LoadAnimation("assets/cutemonster/Hip Hop Dancing.fbx",Au.Dance0),yield this.LoadAnimation("assets/cutemonster/Shooting.fbx",Au.Shooting),yield this.LoadAnimation("assets/cutemonster/Standing 1H Magic Attack 01.fbx",Au.MagicH1),yield this.LoadAnimation("assets/cutemonster/Standing 2H Magic Attack 01.fbx",Au.MagicH2),yield this.LoadAnimation("assets/cutemonster/Sword And Shield Slash.fbx",Au.Sword),yield this.LoadAnimation("assets/cutemonster/Mutant Dying.fbx",Au.Dying),yield this.LoadAnimation("assets/cutemonster/Plant A Plant.fbx",Au.PlantAPlant),yield this.LoadAnimation("assets/cutemonster/Pick Fruit.fbx",Au.PickFruit),yield this.LoadAnimation("assets/cutemonster/Pick Fruit Tree.fbx",Au.PickFruitTree),yield this.LoadAnimation("assets/cutemonster/Standing Melee Attack Downward.fbx",Au.Hammering),yield this.LoadAnimation("assets/cutemonster/Watering.fbx",Au.Wartering)}))))}CreateVectorGui(t,e,i,n){t.add(e,"x",-100,100,n).listen().name(i+"X"),t.add(e,"y",-100,100,n).listen().name(i+"Y"),t.add(e,"z",-100,100,n).listen().name(i+"Z")}GetBodyMeshId(t){switch(t){case Tu.Hands_R:return"mixamorigRightHand";case Tu.Hands_L:return"mixamorigLeftHand"}}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),null!=this.size)return this.size;const e=(new Be).setFromObject(this.meshs);return this.size=e.getSize(new Le),this.size.x=1,this.size.z=1,this.size.y=4,this.size}}var rI=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class aI extends ku{get Id(){return Cu.CuteGirl}constructor(t){super(t,Iu.Fbx,"assets/hellboy/10girl.fbx",(t=>rI(this,void 0,void 0,(function*(){this.meshs=t,this.meshs.castShadow=!0,this.meshs.receiveShadow=!0;const e=new yc;this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!0,t instanceof On&&e.load("assets/hellboy/texture.png",(e=>{t.material.map=e,t.material.needsupdate=!0,t.material=new Fl({map:t.material.map})}))}));const i=.022;this.meshs.scale.set(i,i,i),yield this.LoadAnimation("assets/hellboy/Idle.fbx",Au.Idle),yield this.LoadAnimation("assets/hellboy/Running.fbx",Au.Run),yield this.LoadAnimation("assets/hellboy/Jumping Up.fbx",Au.Jump),yield this.LoadAnimation("assets/hellboy/Punch Combo.fbx",Au.Punch),yield this.LoadAnimation("assets/hellboy/Fight Idle.fbx",Au.FightIdle),yield this.LoadAnimation("assets/hellboy/Belly Dance.fbx",Au.Dance0),yield this.LoadAnimation("assets/hellboy/Shooting.fbx",Au.Shooting),yield this.LoadAnimation("assets/hellboy/Standing 1H Magic Attack 01.fbx",Au.MagicH1),yield this.LoadAnimation("assets/hellboy/Standing 2H Magic Attack 01.fbx",Au.MagicH2),yield this.LoadAnimation("assets/hellboy/Sword And Shield Slash.fbx",Au.Sword),yield this.LoadAnimation("assets/hellboy/Gunplay.fbx",Au.Shooting),yield this.LoadAnimation("assets/hellboy/Dying.fbx",Au.Dying),yield this.LoadAnimation("assets/hellboy/Bouncing Fight Idle.fbx",Au.FightIdle),yield this.LoadAnimation("assets/hellboy/Plant A Plant.fbx",Au.PlantAPlant),yield this.LoadAnimation("assets/hellboy/Pick Fruit.fbx",Au.PickFruit),yield this.LoadAnimation("assets/hellboy/Pick Fruit Tree.fbx",Au.PickFruitTree),yield this.LoadAnimation("assets/hellboy/Standing Melee Attack Downward.fbx",Au.Hammering),yield this.LoadAnimation("assets/hellboy/Watering.fbx",Au.Wartering)}))))}CreateVectorGui(t,e,i,n){t.add(e,"x",-100,100,n).listen().name(i+"X"),t.add(e,"y",-100,100,n).listen().name(i+"Y"),t.add(e,"z",-100,100,n).listen().name(i+"Z")}GetBodyMeshId(t){switch(t){case Tu.Hands_R:return"mixamorigRightHand";case Tu.Hands_L:return"mixamorigLeftHand"}}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),null!=this.size)return this.size;const e=(new Be).setFromObject(this.meshs);return this.size=e.getSize(new Le),this.size.x=1,this.size.z=1,this.size.y=4,this.size}}var oI=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class hI extends ku{get Id(){return Cu.Female}constructor(t){super(t,Iu.Fbx,"assets/officegirl/officegirl.fbx",(t=>oI(this,void 0,void 0,(function*(){this.meshs=t,this.meshs.castShadow=!0,this.meshs.receiveShadow=!0;const e=new yc,i=yield e.loadAsync("assets/officegirl/Cloth.png"),n=yield e.loadAsync("assets/officegirl/acessories.png"),s=yield e.loadAsync("assets/officegirl/Hair.png"),r=yield e.loadAsync("assets/officegirl/Skin.png");this.meshs.traverse((t=>{if(t.castShadow=!0,t.receiveShadow=!0,t instanceof On){(Array.isArray(t.material)?t.material:[t.material]).forEach((e=>{switch(e.name){case"Cloth":e.map=i,(e=new Fl({map:t.material.map})).needsupdate=!0;break;case"Acessories":e.map=n,(e=new Fl({map:t.material.map})).needsupdate=!0;break;case"Hair":e.map=s,(e=new Fl({map:t.material.map})).needsupdate=!0;break;case"Skin":e.map=r,(e=new Fl({map:t.material.map})).needsupdate=!0}}))}}));const a=.022;this.meshs.scale.set(a,a,a),this.mixer=new ru(t),yield this.LoadAnimation("assets/officegirl/Idle.fbx",Au.Idle)}))))}GetBodyMeshId(t){return""}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),null!=this.size)return this.size;const e=(new Be).setFromObject(this.meshs.children[0]);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.z=Math.ceil(this.size.z),this.size.y*=4,this.size}}var lI=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class cI extends ku{get Id(){return Cu.Wizard}constructor(t){super(t,Iu.Fbx,"assets/wizard/lowpolywizard.fbx",(t=>lI(this,void 0,void 0,(function*(){this.meshs=t,this.meshs.castShadow=!0,this.meshs.receiveShadow=!0;const e=new yc;this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!0,t instanceof On&&e.load("assets/wizard/AtlasColorV2.png",(e=>{t.material.map=e,t.material.needsupdate=!0,t.material=new Fl({map:t.material.map})}))}));const i=.0025;this.meshs.scale.set(i,i,i),yield this.LoadAnimation("assets/wizard/Old Man Idle.fbx",Au.Idle)}))))}CreateVectorGui(t,e,i,n){t.add(e,"x",-100,100,n).listen().name(i+"X"),t.add(e,"y",-100,100,n).listen().name(i+"Y"),t.add(e,"z",-100,100,n).listen().name(i+"Z")}GetBodyMeshId(t){switch(t){case Tu.Hands_R:return"mixamorigRightHand";case Tu.Hands_L:return"mixamorigLeftHand"}}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),null!=this.size)return this.size;const e=(new Be).setFromObject(this.meshs);return this.size=e.getSize(new Le),this.size.x=1,this.size.z=1,this.size.y=4,this.size}}var uI=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class dI extends ku{get Id(){return Cu.TwoB}constructor(t){super(t,Iu.Fbx,"assets/2b/2b01.fbx",(t=>uI(this,void 0,void 0,(function*(){this.meshs=t,this.meshs.castShadow=!0,this.meshs.receiveShadow=!0;const e=new yc,i=yield e.loadAsync("assets/2b/cloths.jpeg"),n=yield e.loadAsync("assets/2b/Face.jpeg"),s=yield e.loadAsync("assets/2b/hair.jpeg");this.meshs.traverse((t=>{if(t.castShadow=!0,t.receiveShadow=!0,t instanceof On){(Array.isArray(t.material)?t.material:[t.material]).forEach((e=>{switch(e.name){case"Clorh":e.map=i,(e=new Fl({map:t.material.map})).needsupdate=!0;break;case"Face":e.map=n,(e=new Fl({map:t.material.map})).needsupdate=!0;break;case"Hair":e.map=s,(e=new Fl({map:t.material.map})).needsupdate=!0}}))}}));const r=.022;this.meshs.scale.set(r,r,r),this.mixer=new ru(t),yield this.LoadAnimation("assets/2b/Idle.fbx",Au.Idle),yield this.LoadAnimation("assets/2b/Running.fbx",Au.Run),yield this.LoadAnimation("assets/2b/Jumping Up.fbx",Au.Jump),yield this.LoadAnimation("assets/2b/Punch Combo.fbx",Au.Punch),yield this.LoadAnimation("assets/2b/Fight Idle.fbx",Au.FightIdle),yield this.LoadAnimation("assets/2b/Shooting.fbx",Au.Shooting),yield this.LoadAnimation("assets/2b/Sword And Shield Slash.fbx",Au.Sword)}))))}GetBodyMeshId(t){return""}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),null!=this.size)return this.size;const e=(new Be).setFromObject(this.meshs.children[0]);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.z=Math.ceil(this.size.z),this.size.y*=4,this.size}}var pI=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class mI extends ku{get Id(){return Cu.Arrow}constructor(t){super(t,Iu.Gltf,"assets/etc/directional_arrow.glb",(t=>pI(this,void 0,void 0,(function*(){this.gltf=t,this.meshs=t.scene,this.meshs.castShadow=!0;this.meshs.scale.set(.3,.3,.3),this.clips.set(Au.Idle,t.animations.find((t=>"CINEMA_4D_Main"==t.name)))}))))}GetBodyMeshId(){return"mixamorigRightHand"}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),null!=this.size)return this.size;const e=(new Be).setFromObject(this.meshs);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.z=Math.ceil(this.size.z),this.size}}var fI=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class gI extends ku{get Id(){return Cu.Grass}constructor(t){super(t,Iu.Gltf,"assets/plant/anime_grass_2.glb",(t=>fI(this,void 0,void 0,(function*(){this.gltf=t,this.meshs=t.scene,this.meshs.castShadow=!0;this.meshs.scale.set(1,1,1),this.meshs.position.set(0,0,0)}))))}GetBodyMeshId(){return"mixamorigRightHand"}GetBox(t){if(null==this.meshs&&(this.meshs=t),null==this.box){const e=this.GetSize(t);this.box=new On(new Bn(e.x,e.y,e.z),this.boxMat)}const e=this.GetBoxPos(t);return this.box.position.copy(e),this.box.rotation.copy(t.rotation),(new Be).setFromObject(this.box)}GetSize(t){if(null==this.meshs&&(this.meshs=t),null!=this.size)return this.size;const e=(new Be).setFromObject(this.meshs.children[0]);return this.size=e.getSize(new Le),this.size.x=Math.ceil(this.size.x),this.size.z=Math.ceil(this.size.z),this.size}}class vI{get MaleAsset(){return this.male}get FemaleAsset(){return this.female}get CuteGirlAsset(){return this.cutegirl}get OfficeGirlAsset(){return this.officegirl}get WizardAsset(){return this.wizard}get TwoBAsset(){return this.twoB}get ArrowAsset(){return this.arrow}get HellboyAsset(){return this.hellboy}get Mushroom1Asset(){return this.mushroom1}get Mushroom2Asset(){return this.mushroom2}get TreeAsset(){return this.tree}get DeadTreeAsset(){return this.deadtree}get DeadTree2Asset(){return this.deadTree2}get PortalAsset(){return this.portal}get ZombieAsset(){return this.zombie}get MinatuarAsset(){return this.minatuar}get CrabAsset(){return this.crab}get BatPigAsset(){return this.batpig}get BirdMonAsset(){return this.birdmon}get WereWolfAsset(){return this.werewolf}get BilbyAsset(){return this.bilby}get DogAsset(){return this.dog}get BeeAsset(){return this.bee}get PetSnakeAsset(){return this.petSnake}get GunAsset(){return this.gun}get BatAsset(){return this.bat}get BedAsset(){return this.bed}get BathAsset(){return this.bath}get BookShelfAsset(){return this.bookshelf}get ClosetAsset(){return this.closet}get DeskAsset(){return this.desk}get KitchenAsset(){return this.kitchen}get KitTableAsset(){return this.kitTable}get OvenAsset(){return this.oven}get RefrigeratorAsset(){return this.refrigerator}get SinkAsset(){return this.sink}get TableAsset(){return this.table}get ToiletAsset(){return this.toilet}get TvAsset(){return this.tv}get WarteringCanAsset(){return this.wartercan}get HammerAsset(){return this.hammer}get AppleTreeAsset(){return this.appleTree}get AppleAsset(){return this.apple}get CoconutTreeAsset(){return this.coconutTree}get CoconutAsset(){return this.coconut}get Tomato0Asset(){return this.tomato0}get Tomato1Asset(){return this.tomato1}get Tomato2Asset(){return this.tomato2}get Potato0Asset(){return this.potato0}get Potato1Asset(){return this.potato1}get Potato2Asset(){return this.potato2}get Carrot0Asset(){return this.carrot0}get Carrot1Asset(){return this.carrot1}get Carrot2Asset(){return this.carrot2}get GrassAsset(){return this.grass}get EmptyAsset(){return this.empty}get Load(){return this.loader}get LoadingManager(){return this.loadingManager}get FBXLoader(){return this.fbxLoader}get StoneAsset(){return this.stone}constructor(){this.fbxLoader=new sw,this.loadingManager=new uc,this.loader=new Mb(this.loadingManager),this.male=new Sw(this),this.female=new Tw(this),this.hellboy=new sI(this),this.cutegirl=new aI(this),this.officegirl=new hI(this),this.wizard=new cI(this),this.twoB=new dI(this),this.arrow=new mI(this),this.mushroom1=new Aw(this,1),this.mushroom2=new Aw(this,2),this.tree=new Cw(this),this.deadtree=new ww(this),this.portal=new Rw(this),this.test=new Pw(this),this.zombie=new Lw(this),this.minatuar=new Fw(this),this.crab=new Vw(this),this.batpig=new tM(this),this.birdmon=new iM(this),this.werewolf=new aM(this),this.golem=new hM(this),this.biggolem=new lM(this),this.snake=new uM(this),this.viking=new pM(this),this.builder=new fM(this),this.toadmage=new bC(this),this.kittenmonk=new wC(this),this.skeleton=new SC(this),this.bilby=new sM(this),this.dog=new KC(this),this.bee=new eI(this),this.petSnake=new QC(this),this.bat=new Nw(this),this.gun=new zw(this),this.stone=new Hw(this),this.bed=new Jw(this),this.bath=new UC(this),this.bookshelf=new VC(this),this.closet=new qw(this),this.desk=new Yw(this),this.kitchen=new HC(this),this.kitTable=new WC(this),this.oven=new XC(this),this.refrigerator=new jC(this),this.sink=new zC(this),this.table=new GC(this),this.toilet=new BC(this),this.tv=new FC(this),this.appleTree=new Kw(this),this.apple=new YC(this),this.coconutTree=new Zw(this),this.coconut=new JC(this),this.deadTree2=new Iw(this),this.tomato0=new TC(this),this.tomato1=new AC(this),this.tomato2=new CC(this),this.potato0=new LC(this),this.potato1=new OC(this),this.potato2=new NC(this),this.carrot0=new RC(this),this.carrot1=new kC(this),this.carrot2=new PC(this),this.grass=new gI(this),this.wartercan=new Ww(this),this.hammer=new Xw(this),this.empty=new iI(this),this.assets=new Map,cc.enabled=!0,this.assets.set(Cu.Male,this.male),this.assets.set(Cu.Female,this.female),this.assets.set(Cu.Hellboy,this.hellboy),this.assets.set(Cu.CuteGirl,this.cutegirl),this.assets.set(Cu.OfficeGirl,this.officegirl),this.assets.set(Cu.Wizard,this.wizard),this.assets.set(Cu.TwoB,this.twoB),this.assets.set(Cu.Arrow,this.arrow),this.assets.set(Cu.Tree,this.tree),this.assets.set(Cu.DeadTree,this.deadtree),this.assets.set(Cu.Mushroom1,this.mushroom1),this.assets.set(Cu.Mushroom2,this.mushroom2),this.assets.set(Cu.Portal,this.portal),this.assets.set(Cu.Test,this.test),this.assets.set(Cu.Zombie,this.zombie),this.assets.set(Cu.Minataur,this.minatuar),this.assets.set(Cu.CrabMon,this.crab),this.assets.set(Cu.BatPig,this.batpig),this.assets.set(Cu.BirdMon,this.birdmon),this.assets.set(Cu.WereWolf,this.werewolf),this.assets.set(Cu.Golem,this.golem),this.assets.set(Cu.BigGolem,this.biggolem),this.assets.set(Cu.Snake,this.snake),this.assets.set(Cu.Viking,this.viking),this.assets.set(Cu.Builder,this.builder),this.assets.set(Cu.ToadMage,this.toadmage),this.assets.set(Cu.KittenMonk,this.kittenmonk),this.assets.set(Cu.Skeleton,this.skeleton),this.assets.set(Cu.Bilby,this.bilby),this.assets.set(Cu.Dog,this.dog),this.assets.set(Cu.Bee,this.bee),this.assets.set(Cu.PetSnake,this.petSnake),this.assets.set(Cu.Bat,this.bat),this.assets.set(Cu.Gun,this.gun),this.assets.set(Cu.WarteringCan,this.wartercan),this.assets.set(Cu.Hammer,this.hammer),this.assets.set(Cu.AppleTree,this.appleTree),this.assets.set(Cu.Apple,this.apple),this.assets.set(Cu.CoconutTree,this.coconutTree),this.assets.set(Cu.Coconut,this.coconut),this.assets.set(Cu.DeadTree2,this.deadTree2),this.assets.set(Cu.Tomato0,this.tomato0),this.assets.set(Cu.Tomato1,this.tomato1),this.assets.set(Cu.Tomato2,this.tomato2),this.assets.set(Cu.Potato0,this.potato0),this.assets.set(Cu.Potato1,this.potato1),this.assets.set(Cu.Potato2,this.potato2),this.assets.set(Cu.Carrot0,this.carrot0),this.assets.set(Cu.Carrot1,this.carrot1),this.assets.set(Cu.Carrot2,this.carrot2),this.assets.set(Cu.Grass,this.grass),this.assets.set(Cu.Stone,this.stone),this.assets.set(Cu.Bed,this.bed),this.assets.set(Cu.Bath,this.bath),this.assets.set(Cu.Bookshelf,this.bookshelf),this.assets.set(Cu.Closet,this.closet),this.assets.set(Cu.Desk,this.desk),this.assets.set(Cu.Kitchen,this.kitchen),this.assets.set(Cu.KitTable,this.kitTable),this.assets.set(Cu.Oven,this.oven),this.assets.set(Cu.Refrigerator,this.refrigerator),this.assets.set(Cu.Sink,this.sink),this.assets.set(Cu.Table,this.table),this.assets.set(Cu.Toilet,this.toilet),this.assets.set(Cu.TV,this.tv),this.assets.set(Cu.Empty,this.empty)}GetAssets(t){const e=this.assets.get(t);return null==e?this.MaleAsset:e}}const yI={rand_range:function(t,e){return Math.random()*(e-t)+t},rand_normalish:function(){return(Math.random()+Math.random()+Math.random()+Math.random())/4*2-1},rand_int:function(t,e){return Math.round(Math.random()*(e-t)+t)},lerp:function(t,e,i){return t*(i-e)+e},smoothstep:function(t,e,i){return(t=t*t*(3-2*t))*(i-e)+e},smootherstep:function(t,e,i){return(t=t*t*t*(t*(6*t-15)+10))*(i-e)+e},clamp:function(t,e,i){return Math.min(Math.max(t,e),i)},sat:function(t){return Math.min(Math.max(t,0),1)},in_range:(t,e,i)=>t>=e&&t<=i};var xI=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class bI extends $u{constructor(t){super(t)}Init(){return xI(this,void 0,void 0,(function*(){}))}MassLoader(t,e,i){return xI(this,void 0,void 0,(function*(){this.meshs=t.clone(),this.meshs.scale.set(e,e,e),this.meshs.position.set(i.x,i.y,i.z),this.meshs.castShadow=!0,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!0}))}))}}var _I=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class wI extends $u{constructor(t){super(t),this.meshs=new Da}Init(){return _I(this,void 0,void 0,(function*(){}))}MassLoader(t,e,i){return _I(this,void 0,void 0,(function*(){this.meshs=yield this.asset.CloneModel(),this.meshs.scale.set(t,t,t),this.meshs.position.set(e.x,e.y,e.z),this.meshs.castShadow=!1,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!1,t.receiveShadow=!0})),this.meshs.rotateY(i)}))}}var MI=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class SI extends $u{constructor(t){super(t)}Init(){return MI(this,void 0,void 0,(function*(){}))}MassLoader(t,e,i){return MI(this,void 0,void 0,(function*(){this.meshs=yield this.asset.CloneModel(),this.meshs.scale.set(t,t,t),this.meshs.position.set(e.x,e.y,e.z),this.meshs.castShadow=!0,this.meshs.receiveShadow=!1,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!1})),this.meshs.rotateY(i)}))}}var EI=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class TI extends $u{get BoxPos(){return this.asset.GetBoxPos(this.meshs)}constructor(t,e,i,n){super(t),this.store=e,this.gphysic=n,this.controllerEnable=!1,this.movePos=new Le,e.RegisterStore(this),i.RegisterInputEvent(((t,e,i)=>{this.controllerEnable&&("move"==t.type?this.movePos.copy(i):"end"==t.type&&this.moveEvent(this.movePos))})),i.RegisterKeyDownEvent((t=>{if(!this.controllerEnable)return;const e=t.ExecuteKeyDown();this.moveEvent(e)})),i.RegisterAppModeEvent(((t,e)=>{if(t==DP.Portal)switch(e){case Lu.Start:this.controllerEnable=!0;break;case Lu.End:this.controllerEnable=!1}}))}moveEvent(t){const e=t.x*this.Size.x/2,i=t.z*this.Size.z/2;if(this.meshs.position.x+=e,this.meshs.position.y=0,this.meshs.position.z+=i,this.gphysic.Check(this))do{this.meshs.position.y+=.2}while(this.gphysic.Check(this));else{do{this.meshs.position.y-=.2}while(!this.gphysic.Check(this)&&this.meshs.position.y>=4.7);this.meshs.position.y+=.2}this.store.Portal=this.meshs.position,this.store.CityPortal=this.meshs.position}Viliageload(){return EI(this,void 0,void 0,(function*(){this.meshs.position.copy(Du.DefaultPortalPosition)}))}Reload(){return EI(this,void 0,void 0,(function*(){this.meshs.position.copy(Du.DefaultPortalPosition);const t=this.store.Portal;null!=t&&this.meshs.position.copy(t)}))}Cityload(){return EI(this,void 0,void 0,(function*(){this.meshs.position.copy(Du.DefaultPortalPosition);const t=this.store.CityPortal;null!=t&&this.meshs.position.copy(t)}))}Loader(t){return EI(this,void 0,void 0,(function*(){this.meshs=yield this.asset.CloneModel(),this.meshs.position.copy(t),this.meshs.castShadow=!0,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!0}))}))}}class AI extends Ku{get BoxPos(){return this.position}set Key(t){this.key=t}get Key(){return this.key}constructor(t,e,i){const n=new Bn(1,1,1),s=new Bl({transparent:!0,color:i,emissiveIntensity:0});super(n,s),this.key=[],this.castShadow=!0,this.receiveShadow=!0,this.size=e,this.scale.copy(e),this._geometry=n,this._material=s,this.Init(t)}Init(t){this.position.copy(t)}Dispose(){this._geometry.dispose(),this._material.dispose()}}class CI{get Size(){return this.size}get BoxPos(){return this.position}set Key(t){this.key=t}get Key(){return this.key}constructor(t,e){this.size=t,this.position=e,this.key=[]}Dispose(){this.brick&&this.brick.Dispose()}}class II{set LegoStore(t){this.save=t}constructor(t,e,i,n,s,r,a){this.scene=t,this.eventCtrl=e,this.store=i,this.physics=n,this.player=s,this.mode=r,this.save=a,this.bricks2=[],this.eventbricks=[],this.deleteMode=!1,this.brickType=kI.Event,this.brickSize=new Le(1,1,1),this.brickColor=new Zi(16777215),this.subV=new Le(.1,.1,.1),this.movePos=new Le,this.fieldWidth=Du.LegoFieldW,this.fieldHeight=Du.LegoFieldH,this.dom=document.createElement("div"),this.drawHtml(this.dom),e.RegisterInputEvent(((t,e,i)=>{null!=this.brickGuide&&this.brickGuide.ControllerEnable&&(this.currentMode!=DP.LegoDelete&&this.mode!=this.currentMode||("move"==t.type?(this.movePos.copy(i),this.moveEvent(this.movePos)):"end"==t.type&&this.moveEvent(this.movePos)))})),e.RegisterKeyDownEvent((t=>{if(null==this.brickGuide||!this.brickGuide.ControllerEnable)return;if(this.currentMode!=DP.LegoDelete&&this.mode!=this.currentMode)return;const e=t.ExecuteKeyDown();this.moveEvent(e)})),this.brickfield=new On(new ss(this.fieldWidth,this.fieldHeight),new nn({color:255,side:2,opacity:.3,transparent:!0})),this.brickfield.position.z+=this.fieldHeight/2,this.brickfield.position.y=.01,this.brickfield.rotation.x=Math.PI/2,this.brickfield.visible=!1,this.scene.add(this.brickfield)}moveEvent(t){if(null==this.brickGuide)return;const e=t.x>0?1:t.x<0?-1:0,i=t.z>0?1:t.z<0?-1:0;t.y>0?this.deleteMode?this.DeleteBrick():this.CreateBrickEvent():(this.brickGuide.position.x+=e,this.brickGuide.position.y=Math.ceil(this.brickGuide.position.y),this.brickGuide.position.z+=i),this.CheckCollision()}GetCollisionBox(){if(null==this.brickGuide)return[void 0,[""]];this.brickGuide.position.y-=1;const t=this.brickGuide.Box;let[e,i]=this.physics.GetCollisionBox(this.brickGuide.position,t);if(this.brickGuide.position.y+=1,e){const[t,n]=this.physics.GetCollisionBox(e.pos,e.box);i=n}return[null==e?void 0:e.model,i]}DeleteBrick(){const[t,e]=this.GetCollisionBox();if(null==t)return;this.physics.DeleteBox(e,t);const i=t instanceof AI?t:t.brick;if(null==i)throw"error";this.bricks2.splice(this.bricks2.indexOf(i),1),this.scene.remove(i),i.Dispose(),this.DeleteLegos(i)}DeleteLegos(t){const e=this.save;for(let i=0;i<e.length;i++)this.VEqual(e[i].position,t.position)&&(e.splice(i,1),i--)}VEqual(t,e){return t.x==e.x&&t.y==e.y&&t.z==e.z}CreateBrickEvent(){if(null==this.brickGuide||!this.brickGuide.Creation)return;const t=new AI(this.brickGuide.position,this.brickSize,this.brickColor);t.rotation.copy(this.brickGuide.Meshs.rotation),this.save.push({position:t.position,size:(new Le).copy(this.brickSize),rotation:t.rotation,color:t.Meshs.material.color,type:this.brickGuide.ShapeType}),this.scene.add(t),this.bricks2.push(t);const e=new Le(.1,.1,.1),i=(new Le).copy(this.brickSize).sub(e),n=new CI(this.brickSize,t.position);n.brick=t,this.eventbricks.push(n),this.physics.addBuilding(n,t.position,i,t.rotation),t.Visible=!0}ClearBlock(){this.bricks2.forEach((t=>{this.scene.remove(t),t.Dispose()})),this.bricks2.length=0,null!=this.instancedBlock&&(this.scene.remove(this.instancedBlock),this.instancedBlock.geometry.dispose(),this.instancedBlock.material.dispose(),this.instancedBlock.dispose(),this.instancedBlock=void 0)}GetBrickGuide(t){return null==t&&(t=(new Le).copy(this.brickfield.position)),t.x=Math.ceil(t.x),t.y=Math.ceil(t.y),t.z=Math.ceil(t.z),t.y<2&&(t.y=2),null==this.brickGuide?(this.brickGuide=new LI(t,this.brickSize,this.brickType),this.scene.add(this.brickGuide),this.brickfield.visible=!0):(this.brickGuide.Init(t),this.brickGuide.Visible=!0,this.brickfield.visible=!0),this.eventCtrl.OnChangeCtrlObjEvent(this.brickGuide),this.CheckCollision(),this.brickGuide}CheckCollision(){if(null==this.brickGuide)return;const t=this.brickGuide.Size.y/2;if(this.brickGuide.CannonPos.y=this.brickGuide.CannonPos.y<t?t:this.brickGuide.CannonPos.y,this.physics.CheckBox(this.brickGuide.position,this.brickGuide.Box))do{this.brickGuide.CannonPos.y+=.5}while(this.physics.CheckBox(this.brickGuide.position,this.brickGuide.Box));else{do{this.brickGuide.CannonPos.y-=.5}while(!this.physics.CheckBox(this.brickGuide.position,this.brickGuide.Box)&&this.brickGuide.CannonPos.y>=t);this.brickGuide.CannonPos.y+=.5}this.checkEx&&this.checkEx()}ChangeEvent(t){switch(null==this.brickGuide&&(this.brickGuide=this.GetBrickGuide(this.player.CenterPos)),t){case Lu.Start:this.brickGuide.ControllerEnable=!0,this.brickGuide.Visible=!0,this.brickGuide.position.copy(this.player.CannonPos),this.brickfield.visible=!0,this.deleteMode&&(this.dom.style.display="block",this.brickGuide.DeleteMode(!0),this.brickSize.set(1,1,1)),this.eventCtrl.OnChangeCtrlObjEvent(this.brickGuide),this.CheckCollision();break;case Lu.End:this.deleteMode&&(this.dom.style.display="none",this.brickGuide.DeleteMode(!1)),this.brickGuide.ControllerEnable=!1,this.brickGuide.Visible=!1,this.brickfield.visible=!1}}ChangeOption(t){if(t.clear){const t=this.store.Legos;t&&(t.length=0);const e=this.store.NonLegos;e&&(e.length=0);const i=this.store.Bricks;i&&(i.length=0)}if(null!=this.brickGuide){if(t.v){this.brickSize.copy(t.v),this.brickGuide.Meshs.scale.copy(t.v);const e=this.brickGuide.Meshs.position;this.brickGuide.Meshs.position.set(Math.floor(e.x)+t.v.x%2*.5,Math.floor(e.y)+t.v.y%2*.5,Math.floor(e.z)+t.v.z%2*.5)}t.r&&(this.brickGuide.Meshs.rotateX(ne.degToRad(t.r.x)),this.brickGuide.Meshs.rotateY(ne.degToRad(t.r.y)),this.brickGuide.Meshs.rotateZ(ne.degToRad(t.r.z))),t.color&&this.brickColor.set(t.color),this.CheckCollision()}}ClearEventBrick(){this.eventbricks.length=0}CreateBricks(t){if(!t||0==t.length)return;const e=new Le;t.forEach((t=>{const i=new AI(t.position,t.size,t.color);i.rotation.copy(t.rotation),this.scene.add(i),this.bricks2.push(i),e.copy(t.size).sub(this.subV),this.physics.addBuilding(i,t.position,e,i.rotation)}))}CreateInstacedMesh(t){if(!(null==t?void 0:t.length))return;const e=new Bn(1,1,1),i=new Fl({color:16777215,transparent:!0}),n=new Oo(e,i,t.length);n.castShadow=!0,n.receiveShadow=!0;const s=new ci,r=new Le,a=new De;return t.forEach(((t,e)=>{a.setFromEuler(t.rotation),s.compose(t.position,a,t.size),null==n||n.setColorAt(e,new Zi(t.color)),null==n||n.setMatrixAt(e,s),r.copy(t.size).sub(this.subV);const i=new CI(this.brickSize,t.position);this.eventbricks.push(i),this.physics.addBuilding(i,t.position,r,t.rotation)})),n}drawHtml(t){t.className="brickctrl border rounded p-2 m-1",t.innerHTML='\n        <div class="row">\n            <div class="col text-white">\n                <div class="border rounded bg-secondary p-2 d-inline-block">space</div> or\n                <span class="material-symbols-outlined align-middle">\n                close\n                </span> = \n            </div>\n            <div class="col p-2 text-center handcursor">\n                <span class="material-symbols-outlined" id="lego_exit">\n                    disabled_by_default\n                </span>\n            </div>\n        </div>\n        ',t.style.display="none",document.body.appendChild(t);const e=document.getElementById("lego_exit");e&&(e.onclick=()=>{this.eventCtrl.OnAppModeEvent(DP.EditPlay),e.style.display="none"})}}var RI,kI,PI=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};!function(t){t[t.Rectangle=0]="Rectangle",t[t.RoundCorner=1]="RoundCorner"}(RI||(RI={}));class DI extends II{get Size(){return this.brickGuide?this.brickGuide.Size:this.brickSize}constructor(t,e,i,n,s){super(t,e,i,n,s,DP.Lego,i.Legos),i.RegisterStore(this),this.brickType=kI.Lego,e.RegisterBrickInfo((t=>{this.ChangeOption(t)})),this.eventCtrl.RegisterAppModeEvent(((t,e)=>{this.currentMode=t,this.deleteMode=t==DP.LegoDelete,t!=DP.Lego&&t!=DP.LegoDelete||this.ChangeEvent(e)})),this.checkEx=()=>{if(!this.brickGuide)return;const t=(new Le).copy(this.brickfield.position);t.x-=this.fieldWidth/2,t.z-=this.fieldHeight/2;const e=(new Le).copy(this.brickGuide.position),i=this.brickGuide.Size;e.x-=i.x/2,e.z-=i.z/2,e.x>=t.x&&e.x+i.x<=t.x+this.fieldWidth&&e.z>=t.z&&e.z+i.z<=t.z+this.fieldHeight?this.brickGuide.Creation=!0:this.brickGuide.Creation=!1},e.RegisterSceneClearEvent((()=>{this.ClearBlock(),this.ClearEventBrick(),this.DeleteViliage()}))}EditMode(){this.ClearBlock(),this.CreateBricks(this.store.Legos)}Viliageload(){return PI(this,void 0,void 0,(function*(){this.LegoStore=this.store.Legos,this.viliage=this.CreateInstacedMesh(this.store.Legos),this.viliage&&this.scene.add(this.viliage)}))}Reload(){return PI(this,void 0,void 0,(function*(){this.LegoStore=this.store.Legos,this.CreateBricks(this.store.Legos)}))}DeleteViliage(){this.viliage&&(this.scene.remove(this.viliage),this.viliage.dispose())}}!function(t){t[t.Lego=0]="Lego",t[t.NonLego=1]="NonLego",t[t.Delete=2]="Delete",t[t.Event=3]="Event"}(kI||(kI={}));class LI extends Ku{get Creation(){return this.creationFlag}set Creation(t){t?this.material.color.setHex(65280):this.material.color.setHex(16711680),this.deleteMode&&(this.Visible=t),this.creationFlag=t}get BoxPos(){return this.position}set ControllerEnable(t){this.contollerEnable=t}get ControllerEnable(){return this.contollerEnable}constructor(t,e,i){super(new Bn(1,1,1),new Bl({color:new Zi(0,255,0),transparent:!0,opacity:.5})),this.ShapeType=RI.Rectangle,this.deleteMode=!1,this.contollerEnable=!0,this.creationFlag=!1,this.castShadow=!0,this.size=e,this.scale.copy(e),this.Init(t)}Init(t){const e=t.x-t.x%this.Size.x,i=t.z-t.z%this.Size.z;this.position.set(e,t.y,i),this.position.y=this.CenterPos.y}DeleteMode(t){t&&this.scale.set(1,1,1),this.deleteMode=t}}var OI=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class NI extends II{get Size(){return this.brickSize}constructor(t,e,i,n,s){super(t,e,i,n,s,DP.Brick,i.Legos),this.bricks=[],this.brickType=kI.Event,this.brickSize.set(3,3,3),i.RegisterStore(this),this.eventCtrl.RegisterAppModeEvent(((t,e)=>{if(this.currentMode=t,this.deleteMode=t==DP.LegoDelete,t==DP.Brick&&null!=this.brickGuide)switch(e){case Lu.Start:this.brickGuide.ControllerEnable=!0,this.brickGuide.Visible=!0,this.brickfield.visible=!0,this.eventCtrl.OnChangeCtrlObjEvent(this.brickGuide),this.CheckCollision();break;case Lu.End:this.brickGuide.ControllerEnable=!1,this.brickGuide.Visible=!1,this.brickfield.visible=!1}})),this.checkEx=()=>{if(!this.brickGuide)return;const t=(new Le).copy(this.brickfield.position);t.x-=this.fieldWidth/2,t.z-=this.fieldHeight/2;const e=(new Le).copy(this.brickGuide.position),i=this.brickGuide.Size;e.x-=i.x/2,e.z-=i.z/2,e.x>=t.x&&e.x+i.x<=t.x+this.fieldWidth&&e.z>=t.z&&e.z+i.z<=t.z+this.fieldHeight?this.brickGuide.Creation=!1:this.brickGuide.Creation=!0}}Init(){return OI(this,void 0,void 0,(function*(){}))}EditMode(){this.ClearBlock(),this.ClearEventBrick();const t=this.store.Bricks,e=new Le;t.forEach((t=>{const i=new AI(t.position,this.brickSize,t.color);this.scene.add(i),this.bricks2.push(i),e.copy(this.brickSize).sub(this.subV),this.physics.addBuilding(i,t.position,e,i.rotation)}))}CreateInstacedMeshEventBrick2(t){const e=new Bn(1,1,1),i=new Bl({color:16777215,transparent:!0});return this.instancedBlock=new Oo(e,i,t),this.instancedBlock.castShadow=!0,this.instancedBlock.receiveShadow=!0,this.instancedBlock}Viliageload(){return OI(this,void 0,void 0,(function*(){this.ClearBlock(),this.ClearEventBrick()}))}Reload(){return OI(this,void 0,void 0,(function*(){if(this.ClearBlock(),this.ClearEventBrick(),!this.store.Bricks)return;const t=this.store.Bricks;if(0==t.length)return;if(this.deleteMode)return void this.EditMode();this.instancedBlock=this.CreateInstacedMeshEventBrick2(t.length);const e=new ci,i=new De,n=(new Le).copy(this.brickSize).sub(this.subV);t.forEach(((t,s)=>{var r;e.compose(t.position,i,this.brickSize),null===(r=this.instancedBlock)||void 0===r||r.setMatrixAt(s,e);const a=new CI(this.brickSize,t.position);this.eventbricks.push(a),this.physics.addBuilding(a,t.position,n)})),this.scene.add(this.instancedBlock)}))}}class BI extends ao{constructor(t){const e=document.createElement("canvas"),i=e.getContext("2d");if(null==i)super();else{i.canvas.width=256,i.canvas.height=128,i.fillStyle="#FFF",i.font="18pt Helvetica",i.shadowOffsetX=3,i.shadowOffsetY=3,i.shadowColor="rgba(0,255,0,0.3)",i.shadowBlur=2,i.textAlign="center",i.fillText(t,128,64);const e=new vh(i.canvas);super(new Xa({map:e,color:16777215,fog:!1,depthTest:!1})),this.scale.set(2,1,1),this.position.y=2}this.params_=t,this.visible_=!0,this.element_=e,this.context2d_=i}Destroy(){this.traverse((t=>{if(t instanceof On){if(t.material){let e=t.material;t.material instanceof Array||(e=[t.material]);for(let t of e)t.dispose()}t.geometry&&t.geometry.dispose()}})),this.parent&&this.parent.remove(this)}InitComponent(){}OnDeath_(){this.Destroy()}SetText(t){if(!this.visible_||null==this.context2d_)return;this.params_=t,this.context2d_.canvas.width=256,this.context2d_.canvas.height=128,this.context2d_.fillStyle="#FFF",this.context2d_.font="18pt Helvetica",this.context2d_.shadowOffsetX=3,this.context2d_.shadowOffsetY=3,this.context2d_.shadowColor="rgba(0,0,0,0.5)",this.context2d_.shadowBlur=4,this.context2d_.textAlign="center",this.context2d_.fillText(this.params_,128,64);const e=new vh(this.context2d_.canvas);this.material=new Xa({map:e,color:16777215,fog:!1,depthTest:!1}),this.scale.set(4,2,1),this.position.y=2}}var zI=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class UI extends $u{get BoxPos(){return this.asset.GetBoxPos(this.meshs)}get Model(){return this.asset.Id}set ControllerEnable(t){this.controllerEnable=t}get ControllerEnable(){return this.controllerEnable}constructor(t,e,i){super(i),this.gphysic=e,this.currentActionType=xb.Idle,this.clipMap=new Map,this.controllerEnable=!1,this.movePos=new Le,this.vFlag=!0,this.clock=new qc,this.text=new BI("Welcome"),t.RegisterInputEvent(((t,e,i)=>{this.controllerEnable&&("move"==t.type?this.movePos.copy(i):"end"==t.type&&this.moveEvent(this.movePos))})),t.RegisterKeyDownEvent((t=>{if(!this.controllerEnable)return;const e=t.ExecuteKeyDown();this.moveEvent(e)}))}moveEvent(t){const e=t.x>0?1:t.x<0?-1:0,i=t.z>0?1:t.z<0?-1:0;if(this.meshs.position.x+=e,this.meshs.position.z+=i,this.gphysic.Check(this))do{this.meshs.position.y+=.2}while(this.gphysic.Check(this));else{do{this.meshs.position.y-=.2}while(!this.gphysic.Check(this)&&this.meshs.position.y>=0);this.meshs.position.y+=.2}}Init(t){return zI(this,void 0,void 0,(function*(){null!=this.text&&(this.text.SetText(t),this.text.position.y+=3)}))}Loader(t,e,i){return zI(this,void 0,void 0,(function*(){this.asset=t;const[n,s]=yield t.UniqModel(i);if(this.meshs=n,this.meshs.position.set(e.x,e.y,e.z),s&&null!=this.text&&this.meshs.remove(this.text),null!=this.text&&(this.text.SetText(i),this.text.position.y+=3,this.meshs.add(this.text)),this.mixer=this.asset.GetMixer(i),null==this.mixer)throw new Error("mixer is undefined");this.clipMap.set(xb.Idle,this.asset.GetAnimationClip(Au.Idle)),this.clipMap.set(xb.Run,this.asset.GetAnimationClip(Au.Run)),this.clipMap.set(xb.Jump,this.asset.GetAnimationClip(Au.Jump)),this.clipMap.set(xb.Punch,this.asset.GetAnimationClip(Au.Punch)),this.clipMap.set(xb.Fight,this.asset.GetAnimationClip(Au.FightIdle)),this.clipMap.set(xb.Dance,this.asset.GetAnimationClip(Au.Dance0)),this.clipMap.set(xb.PickFruit,this.asset.GetAnimationClip(Au.PickFruit)),this.clipMap.set(xb.PickFruitTree,this.asset.GetAnimationClip(Au.PickFruitTree)),this.clipMap.set(xb.PlantAPlant,this.asset.GetAnimationClip(Au.PlantAPlant)),this.clipMap.set(xb.Watering,this.asset.GetAnimationClip(Au.Wartering)),this.clipMap.set(xb.Hammering,this.asset.GetAnimationClip(Au.Hammering)),this.clipMap.set(xb.Building,this.asset.GetAnimationClip(Au.Hammering)),this.changeAnimate(this.clipMap.get(this.currentActionType)),this.Visible=!1}))}ChangeAction(t,e){this.currentActionType=t,this.changeAnimate(this.clipMap.get(t),e)}changeAnimate(t,e){var i,n;if(null==t)return;const s=null===(i=this.mixer)||void 0===i?void 0:i.clipAction(t);if(null==s)return;null===(n=this.currentAni)||void 0===n||n.fadeOut(.2),null!=e&&(s.timeScale=t.duration/e),s.setLoop(xt,1e4),s.reset().fadeIn(.2).play(),this.currentAni=s,this.currentClip=t}resize(){}update(){var t;const e=this.clock.getDelta();null===(t=this.mixer)||void 0===t||t.update(e)}UpdatePhysics(){}}var FI=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class GI{get Helper(){return this.helper}get Helper2(){return this.helper2}get Owner(){return this.owner}constructor(t,e,i,n,s,r){this.loader=t,this.eventCtrl=e,this.game=i,this.canvas=n,this.store=s,this.ownerModel=Cu.Male,this.helper=new UI(e,r,t.MaleAsset),this.helper2=new UI(e,r,t.FemaleAsset),this.owner=new UI(e,r,t.MaleAsset),this.store.RegisterStore(this),this.canvas.RegisterViewer(this.helper),this.canvas.RegisterViewer(this.helper2),this.canvas.RegisterViewer(this.owner),this.eventCtrl.RegisterAppModeEvent(((t,e)=>{switch(t){case DP.Weapon:case DP.Farmer:case DP.Furniture:case DP.EditPlay:case DP.Brick:case DP.Lego:case DP.LegoDelete:case DP.EditCity:switch(e){case Lu.Start:this.owner.Visible=!1,this.owner.ControllerEnable=!1;break;case Lu.End:this.eventCtrl.OnChangeCtrlObjEvent(),this.owner.Visible=!0}break;case DP.Close:case DP.Face:this.eventCtrl.OnChangeCtrlObjEvent(this.owner);case DP.Play:switch(e){case Lu.Start:this.owner.Visible=!0,this.owner.ControllerEnable=!1;break;case Lu.End:this.eventCtrl.OnChangeCtrlObjEvent(),this.owner.Visible=!1}break;case DP.Long:switch(e){case Lu.Start:this.eventCtrl.OnChangeCtrlObjEvent(this.helper),this.owner.Visible=!1,this.helper.Visible=!0,this.helper2.Visible=!0;break;case Lu.End:this.helper.Visible=!1,this.helper2.Visible=!1}}})),e.RegisterSceneClearEvent((()=>{this.game.remove(this.owner.Meshs)}))}CreateOwner(t){return FI(this,void 0,void 0,(function*(){t.model!=this.ownerModel?(this.game.remove(this.owner.Meshs),this.ownerModel=t.model,yield this.owner.Loader(this.loader.GetAssets(this.ownerModel),t.position,t.name),this.game.add(this.owner.Meshs)):(this.owner.Init(t.name),this.owner.CannonPos=t.position),this.owner.ChangeAction(t.actionType),this.owner.Visible=!0}))}NpcLoader(){return FI(this,void 0,void 0,(function*(){const t=Du.DefaultPortalPosition;return yield Promise.all([this.helper.Loader(this.loader.MaleAsset,new Le(t.x-6,0,t.z+10)," "),this.helper2.Loader(this.loader.FemaleAsset,new Le(t.x-4,0,t.z+10),"Eve"),this.owner.Loader(this.loader.GetAssets(this.ownerModel),new Le(10,0,15),"unknown")])}))}Reload(){return FI(this,void 0,void 0,(function*(){this.game.add(this.owner.Meshs);const t=this.store.Owner,e={name:this.store.Name,position:null==t?new Le(10,0,15):(new Le).copy(t),model:null==this.store.OwnerModel?Cu.Male:this.store.OwnerModel,actionType:this.store.OwnerAction};yield this.CreateOwner(e)}))}InitScene(){this.game.add(this.helper.Meshs,this.helper2.Meshs,this.owner.Meshs)}}var VI=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class HI{get UserHouseData(){return this.userdata}get CityNonlego(){return this.cityData.nonlegos}get CityHouses(){return this.cityData.house}get CityPortal(){return this.cityData.portal}set CityPortal(t){this.cityData.portal=null==this.cityData.portal?(new Le).copy(t):this.cityData.portal.copy(t)}set Portal(t){this.data.portal=null==this.data.portal?(new Le).copy(t):this.data.portal.copy(t)}get Portal(){return this.data.portal}get Plants(){return this.data.plants?this.data.plants:this.data.plants=[]}get Deck(){return this.data.monDeck?this.data.monDeck:this.data.monDeck=[]}get Furn(){return this.data.furn?this.data.furn:this.data.furn=[]}get Legos(){return this.data.legos?this.data.legos:this.data.legos=[]}get NonLegos(){return this.data.nonlegos?this.data.nonlegos:this.data.nonlegos=[]}get Bricks(){return this.data.bricks}get Owner(){return this.data.owner}set Owner(t){t&&null!=this.data.owner&&(this.data.owner.x=t.x,this.data.owner.y=t.y,this.data.owner.z=t.z)}get OwnerModel(){return this.data.ownerModel}get OwnerAction(){return this.data.ownerAction}get PlayerModel(){return this.playerModel}get Name(){return this.name}constructor(t,e){this.eventCtrl=t,this.invenFab=e,this.mgrs=[],this.playerModel=Cu.Male,this.data={furn:[],plants:[],monDeck:[],bricks:[],legos:[],nonlegos:[],owner:void 0,ownerModel:Cu.Male,ownerAction:xb.Idle,portal:void 0},this.cityData={house:[],nonlegos:[],portal:void 0},this.owners=new Array,this.ownerModels=new Array,this.name="unknown",this.eventCtrl.RegisterReloadEvent((()=>VI(this,void 0,void 0,(function*(){const t=this.mgrs.map((t=>VI(this,void 0,void 0,(function*(){yield t.Reload()}))));yield Promise.all(t)}))))}RegisterStore(t){this.mgrs.push(t)}RegisterPlayer(t,e){this.player=t,this.mgrs.push(e)}ChangeCharactor(t){this.data.ownerModel=t,this.mgrs.forEach((t=>VI(this,void 0,void 0,(function*(){yield t.Reload()}))))}StoreInventory(){return this.invenFab.invenHouse.data}LoadInventory(t){return null!=t&&(this.invenFab.invenHouse.Copy(t),this.eventCtrl.OnChangeEquipmentEvent(this.invenFab.invenHouse)),this.invenFab.invenHouse}ChangeInventory(t){return null!=t&&(this.invenFab.inven.Copy(t),this.eventCtrl.OnChangeEquipmentEvent(this.invenFab.inven)),this.invenFab.inven}GetEmptyInventory(){return this.invenFab.inven}StoreModels(){var t,e;this.data.owner=null===(t=this.player)||void 0===t?void 0:t.Meshs.position,this.data.ownerModel=null===(e=this.player)||void 0===e?void 0:e.Model,this.data.ownerAction=this.player?this.player.ActionType:xb.Idle;return JSON.stringify(this.data)}SaveCity(){return JSON.stringify(this.cityData)}LoadModelsEmpty(t,e){return VI(this,void 0,void 0,(function*(){if(null!=e){const t=JSON.parse(e);this.playerModel=t.ownerModel}this.name=t,this.data.legos.length=0,this.data.bricks&&(this.data.bricks.length=0),this.data.plants.length=0,this.data.owner=void 0,this.data.ownerModel=Cu.Male,this.data.portal=Du.DefaultPortalPosition,this.data.furn.length=0;const i=this.mgrs.map((t=>VI(this,void 0,void 0,(function*(){yield t.Reload()}))));yield Promise.all(i)}))}CheckStoreInstance(){this.cityData.house||(this.cityData.house=[]),this.cityData.nonlegos||(this.cityData.nonlegos=[])}LoadModels(t,e,i){var n,s,r;return VI(this,void 0,void 0,(function*(){if(null!=i){const t=JSON.parse(i);this.playerModel=t.ownerModel}this.name=e,this.data=JSON.parse(t),this.data.portal=new Le(null===(n=this.data.portal)||void 0===n?void 0:n.x,null===(s=this.data.portal)||void 0===s?void 0:s.y,null===(r=this.data.portal)||void 0===r?void 0:r.z);const a=this.mgrs.map((t=>VI(this,void 0,void 0,(function*(){yield t.Reload()}))));yield Promise.all(a)}))}LoadCity(t,e,i){return VI(this,void 0,void 0,(function*(){if(i){const t=JSON.parse(i);this.playerModel=t.ownerModel}e&&(this.cityData=JSON.parse(e)),this.userdata=t,this.CheckStoreInstance();const n=this.mgrs.map((t=>VI(this,void 0,void 0,(function*(){var e;yield null===(e=t.Cityload)||void 0===e?void 0:e.call(t)}))));yield Promise.all(n)}))}LoadVillage(t,e){return VI(this,void 0,void 0,(function*(){if(null!=e){const t=JSON.parse(e);this.playerModel=t.ownerModel}this.data.legos.length=0,this.owners.length=0,this.ownerModels.length=0;let i=-1;t.forEach((t=>{var e,n,s;if(0==t.length)return;i++;const r=JSON.parse(t);0!=i?(r.legos.forEach((t=>{t.position.x-=Du.LegoFieldW*i})),this.data.legos.push(...r.legos),this.data.portal=new Le(null===(e=r.portal)||void 0===e?void 0:e.x,null===(n=r.portal)||void 0===n?void 0:n.y,null===(s=r.portal)||void 0===s?void 0:s.z),this.owners.push(r.owner),this.ownerModels.push(r.ownerModel)):this.data.legos.push(...r.legos)}));const n=this.mgrs.map((t=>VI(this,void 0,void 0,(function*(){var e;yield null===(e=t.Viliageload)||void 0===e?void 0:e.call(t)}))));yield Promise.all(n)}))}}class jI{get LandY(){return this.landPos.y}constructor(t,e){this.scene=t,this.movingBoxs=[],this.landPos=new Le,this.objs=[],this.pboxs=new Map,this.debugBoxMat=new nn({color:16777215,wireframe:!0}),this.debugBox=[],this.optx=10,this.opty=10,this.optz=10,this.clock=new qc,e.RegisterSceneClearEvent((()=>{this.PBoxDispose()}))}Register(t){this.objs.push(t)}Deregister(t){this.objs.splice(this.objs.indexOf(t),1)}DebugMode(t){t?(this.movingBoxs.forEach((t=>{t.box&&this.scene.remove(t.box)})),this.debugBox.forEach((t=>{this.scene.remove(t)}))):(this.movingBoxs.forEach((t=>{t.box&&this.scene.add(t.box)})),this.debugBox.forEach((t=>{this.scene.add(t)})))}PBoxDispose(){this.pboxs.clear(),this.debugBox.forEach((t=>{this.scene.remove(t)})),this.debugBox.length=0}addPlayer(t){const e=new On(new Bn(t.Size.x,t.Size.y,t.Size.z),this.debugBoxMat);this.player=t,this.movingBoxs.push({model:t,box:e})}add(...t){t.forEach((t=>{const e=new On(new Bn(t.Size.x,t.Size.y,t.Size.z),this.debugBoxMat);this.movingBoxs.push({model:t,box:e})}))}addMeshBuilding(...t){t.forEach((t=>{const e=new On(new Bn(t.Size.x,t.Size.y,t.Size.z),this.debugBoxMat),i=t.BoxPos;e.position.set(i.x,i.y,i.z),this.debugBox.push(e),this.addBoxs({pos:i,box:(new Be).setFromObject(e),model:t})}))}addBuilding(t,e,i,n){const s=new On(new Bn(1,1,1),this.debugBoxMat);s.position.copy(e),s.scale.copy(i),n&&s.rotation.copy(n),this.debugBox.push(s),this.addBoxs({pos:e,box:(new Be).setFromObject(s),model:t})}addLand(t){this.landPos.y=0}makeHash(t,e){const i=Math.floor(Math.floor(t.x)/this.optx),n=Math.floor(Math.floor(t.y)/this.opty),s=Math.floor(Math.floor(t.z)/this.optz),r=Math.ceil(Math.ceil(t.x+e.x)/this.optx),a=Math.ceil(Math.ceil(t.y+e.y)/this.opty),o=Math.ceil(Math.ceil(t.z+e.z)/this.optz),h=[];for(let t=i;t<=r;t++)for(let e=n;e<=a;e++)for(let i=s;i<=o;i++)h.push(t+"."+e+"."+i);return h}addBoxs(t){const e=t.pos,i=this.makeHash(e,t.box.getSize(new Le));i.forEach((e=>{const i=this.pboxs.get(e);null==i?this.pboxs.set(e,[t]):i.push(t)})),t.model.Key=i}Check(t){const e=t.BoxPos;if(e.y-t.Size.y/2<this.landPos.y)return!0;return this.makeHash(e,t.Size).some((e=>{const i=this.pboxs.get(e);if(null==i)return!1;const n=t.Box;return i.some((t=>!!n.intersectsBox(t.box)))}))}CheckBox(t,e){return this.makeHash(t,e.getSize(new Le)).some((t=>{const i=this.pboxs.get(t);if(null==i)return!1;const n=e;return i.some((t=>!!n.intersectsBox(t.box)))}))}DeleteBox(t,e){t.forEach((t=>{const i=this.pboxs.get(t);if(null==i)return!1;for(let t=i.length-1;t>=0;t--)i[t].model==e&&i.splice(t,1)}))}GetCollisionBox(t,e){const i=this.makeHash(t,e.getSize(new Le));let n;const s=[];return i.some((t=>{const i=this.pboxs.get(t);if(null==i)return!1;const r=e;i.some((e=>{r.intersectsBox(e.box)&&(n=e,s.push(t))}))})),[n,s]}checkGravity(t){if(null!=this.player&&0!=this.player.Velocity){const e=this.player.Velocity*t;this.player.Meshs.position.y-=e,this.Check(this.player)&&(this.player.Meshs.position.y+=e,this.player.Velocity=0),this.player.Velocity-=19.6*t}}update(){const t=this.clock.getDelta();this.objs.forEach((e=>{e.update(t)})),this.movingBoxs.forEach((t=>{const e=t.model.BoxPos;null!=t.box&&t.box.position.copy(e)}))}}class WI{constructor(t,e,i){this.playerCtrl=t,this.player=e,this.gphysic=i}DefaultCheck(){const t=this.CheckRun();if(null!=t)return t;const e=this.CheckAttack();if(null!=e)return e;const i=this.CheckJump();if(null!=i)return i;const n=this.CheckMagic();if(null!=n)return n;const s=this.CheckMagic2();return null!=s?s:void 0}CheckRun(){if(this.playerCtrl.moveDirection.x||this.playerCtrl.moveDirection.z)return this.playerCtrl.RunSt.Init(),this.playerCtrl.RunSt}CheckAttack(){if(this.playerCtrl.KeyState[Ou.Action1])return this.playerCtrl.mode==DP.Play?(this.playerCtrl.AttackSt.Init(),this.playerCtrl.AttackSt):this.playerCtrl.mode==DP.Weapon?(this.playerCtrl.DeckSt.Init(),this.playerCtrl.DeckSt):(this.playerCtrl.PlantASt.Init(),this.playerCtrl.PlantASt)}CheckMagic(){if(this.playerCtrl.KeyState[Ou.Action2])return this.playerCtrl.mode==DP.Play?(this.playerCtrl.MagicH1St.Init(),this.playerCtrl.MagicH1St):(this.playerCtrl.WarteringSt.Init(),this.playerCtrl.WarteringSt)}CheckMagic2(){if(this.playerCtrl.KeyState[Ou.Action3])return this.playerCtrl.mode==DP.Play?(this.playerCtrl.MagicH2St.Init(),this.playerCtrl.MagicH2St):(this.playerCtrl.PickFruitTreeSt.Init(),this.playerCtrl.PickFruitTreeSt)}CheckJump(){if(this.playerCtrl.KeyState[Ou.Action0])return this.playerCtrl.JumpSt.Init(),this.playerCtrl.JumpSt}CheckGravity(){if(this.player.Meshs.position.y-=.3,!this.gphysic.Check(this.player))return this.player.Meshs.position.y+=.3,this.playerCtrl.JumpSt.Init(),this.playerCtrl.JumpSt.velocity_y=0,this.playerCtrl.JumpSt;this.player.Meshs.position.y+=.3}}class XI extends WI{constructor(t,e,i){super(t,e,i),this.next=this}Init(){var t;const e=null!==(t=this.player.ChangeAction(xb.MagicH2))&&void 0!==t?t:2;this.next=this,this.keytimeout=setTimeout((()=>{this.Uninit(),this.playerCtrl.AttackIdleSt.Init(),this.next=this.playerCtrl.AttackIdleSt}),1e3*e),this.playerCtrl.RunSt.PreviousState(this.playerCtrl.AttackIdleSt)}Uninit(){null!=this.keytimeout&&clearTimeout(this.keytimeout)}Update(){const t=this.DefaultCheck();return null!=t?(this.Uninit(),t):this.next}}class qI extends WI{constructor(t,e,i){super(t,e,i),this.next=this}Init(){var t;const e=null!==(t=this.player.ChangeAction(xb.MagicH1))&&void 0!==t?t:2;this.next=this,this.keytimeout=setTimeout((()=>{this.Uninit(),this.playerCtrl.AttackIdleSt.Init(),this.next=this.playerCtrl.AttackIdleSt}),1e3*e),this.playerCtrl.RunSt.PreviousState(this.playerCtrl.AttackIdleSt)}Uninit(){null!=this.keytimeout&&clearTimeout(this.keytimeout)}Update(){const t=this.DefaultCheck();return null!=t?(this.Uninit(),t):this.next}}class YI extends WI{constructor(t,e,i){super(t,e,i)}Init(){this.player.ChangeAction(xb.Dying)}Uninit(){}Update(){return this}}class JI extends WI{constructor(t,e,i){super(t,e,i),this.Init()}Init(){this.player.ChangeAction(xb.Idle),this.playerCtrl.RunSt.PreviousState(this)}Uninit(){}Update(){const t=this.DefaultCheck();if(null!=t)return t;const e=this.CheckGravity();return null!=e?e:this}}class $I extends WI{constructor(t,e,i){super(t,e,i),this.speed=10,this.previous=this.playerCtrl.IdleSt,this.ZeroV=new Le(0,0,0),this.YV=new Le(0,1,0),this.MX=new ci,this.QT=new De}Init(){this.player.ChangeAction(xb.Run)}Uninit(){}PreviousState(t){this.previous=t}Update(t,e){const i=this.CheckAttack();if(null!=i)return i;const n=this.CheckJump();if(null!=n)return n;const s=this.CheckGravity();if(null!=s)return s;if(0==e.x&&0==e.z)return this.previous.Init(),this.previous;e.y=0;const r=e.x*t*this.speed,a=e.z*t*this.speed;this.player.Meshs.position.x+=r,this.player.Meshs.position.z+=a;const o=this.MX.lookAt(e,this.ZeroV,this.YV),h=this.QT.setFromRotationMatrix(o);return this.player.Meshs.quaternion.copy(h),this.gphysic.Check(this.player)&&(this.player.Meshs.position.y+=1,this.gphysic.Check(this.player)&&(this.player.Meshs.position.x-=r,this.player.Meshs.position.z-=a,this.player.Meshs.position.y-=1)),this}}class KI{constructor(t,e,i){this.playerCtrl=t,this.player=e,this.gphysic=i,this.speed=10,this.velocity_y=16,this.dirV=new Le(0,0,0),this.ZeroV=new Le(0,0,0),this.YV=new Le(0,1,0),this.MX=new ci,this.QT=new De}Init(){this.player.ChangeAction(xb.Jump),this.velocity_y=16,this.playerCtrl.RunSt.PreviousState(this.playerCtrl.IdleSt)}Uninit(){this.velocity_y=16}Update(t,e){const i=e.x*t*this.speed,n=e.z*t*this.speed,s=this.velocity_y*t;if(this.player.Meshs.position.x+=i,this.player.Meshs.position.z+=n,i||n){this.dirV.copy(e),this.dirV.y=0;const t=this.MX.lookAt(this.dirV,this.ZeroV,this.YV),i=this.QT.setFromRotationMatrix(t);this.player.Meshs.quaternion.copy(i)}return this.gphysic.Check(this.player)&&(this.player.Meshs.position.x-=i,this.player.Meshs.position.z-=n),this.player.Meshs.position.y+=s,this.gphysic.Check(this.player)?(this.player.Meshs.position.y-=s,this.Uninit(),this.playerCtrl.IdleSt.Init(),this.playerCtrl.IdleSt):(this.velocity_y-=9.8*3*t,this)}}var ZI,QI,tR,eR,iR,nR=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};!function(t){t[t.Attack=0]="Attack",t[t.Shield=1]="Shield",t[t.Armor=2]="Armor",t[t.Potion=3]="Potion",t[t.Material=4]="Material",t[t.Farm=5]="Farm",t[t.Deck=6]="Deck"}(ZI||(ZI={})),function(t){t[t.Blunt=0]="Blunt",t[t.Axe=1]="Axe",t[t.Knife=2]="Knife",t[t.Sword=3]="Sword",t[t.Bow=4]="Bow",t[t.Gun=5]="Gun",t[t.Wand=6]="Wand"}(QI||(QI={})),function(t){t[t.Common=0]="Common",t[t.Uncommon=1]="Uncommon",t[t.Rare=2]="Rare",t[t.Unique=3]="Unique",t[t.Legendary=4]="Legendary",t[t.Mythic=5]="Mythic"}(tR||(tR={}));class sR{get Id(){return this.property.id}get DamageMin(){return null==this.property.damageMin?0:this.property.damageMin}get DamageMax(){return null==this.property.damageMax?0:this.property.damageMax}get ItemType(){return this.property.type}get Speed(){return null==this.property.speed?0:this.property.speed}get IconPath(){return this.property.icon}get Bindable(){return this.property.binding}get Bind(){return this.property.bind}get Mesh(){return this.property.meshs}get Name(){return this.property.name}get AttackType(){return this.property.weapon}get Stackable(){return this.property.stackable}get Deck(){return this.property.deck}constructor(t){this.property=t}MakeInformation(){const t=new Array,e=this.property;switch(t.push({v:e.name}),e.type){case ZI.Attack:switch(e.weapon){case QI.Blunt:t.push({k:"Weapon",v:"Blunt"});break;case QI.Axe:t.push({k:"Weapon",v:"Axe"});break;case QI.Bow:t.push({k:"Weapon",v:"Bow"});break;case QI.Gun:t.push({k:"Weapon",v:"Gun"});break;case QI.Knife:t.push({k:"Weapon",v:"Knife"});break;case QI.Sword:t.push({k:"Weapon",v:"Sword"});break;case QI.Wand:t.push({k:"Weapon",v:"Wand"})}break;case ZI.Shield:t.push({v:"Shield"});break;case ZI.Armor:t.push({v:"Armor"});break;case ZI.Potion:t.push({v:"Potion"});break;case ZI.Material:t.push({v:"Material"})}return null!=e.damageMax&&t.push({k:"",v:e.damageMin+" ~ "+e.damageMax}),null!=e.speed&&t.push({k:"",v:e.speed.toString()}),t}Loader(){return nR(this,void 0,void 0,(function*(){const t=this.property.asset;if(null==t)return;const[e,i]=yield t.UniqModel(this.property.name);this.property.meshs=e}))}}class rR{}eR=rR,rR.Zombie="Zombie",rR.Minotaur="Minataur",rR.Batpig="Batpig",rR.Bilby="Bilby",rR.Birdmon="Birdmon",rR.Crab="Crab",rR.Builder="Builder",rR.Golem="Golem",rR.BigGolem="Biggolem",rR.KittenMonk="Kittenmonk",rR.Skeleton="Skeleton",rR.Snake="Snake",rR.ToadMage="Toadmage",rR.Viking="Viking",rR.WereWolf="Werewolf",rR.Stone="stone",rR.Tree="tree",rR.Bee="Bee",rR.DefaultBall="DefaultBall",rR.DefaultBullet="DefaultBullet",rR.List=[eR.Zombie,eR.Minotaur,eR.Batpig,eR.Bilby,eR.Birdmon,eR.Crab,eR.Builder,eR.Golem,eR.BigGolem,eR.KittenMonk,eR.Skeleton,eR.Snake,eR.ToadMage,eR.Viking,eR.WereWolf],function(t){t[t.Undead=0]="Undead",t[t.Dragon=1]="Dragon",t[t.Machine=2]="Machine",t[t.Warrior=3]="Warrior",t[t.Angel=4]="Angel",t[t.Element=5]="Element",t[t.Fish=6]="Fish",t[t.Plant=7]="Plant",t[t.Insect=8]="Insect",t[t.Reptile=9]="Reptile",t[t.Wizard=10]="Wizard",t[t.Alien=11]="Alien",t[t.Beast=12]="Beast",t[t.Dinosaur=13]="Dinosaur",t[t.Lightning=14]="Lightning",t[t.Flame=15]="Flame",t[t.Rock=16]="Rock"}(iR||(iR={}));class aR extends WI{constructor(t,e,i,n,s){super(t,e,i),this.eventCtrl=n,this.spec=s,this.raycast=new ou,this.attackDist=5,this.attackDir=new Le,this.attackTime=0,this.attackSpeed=2,this.attackDamageMax=1,this.attackDamageMin=1,this.attackProcess=!1,this.meleeAttackMode=!0,this.raycast.params.Points.threshold=20}Init(){this.attackProcess=!1,this.attackSpeed=this.spec.attackSpeed,this.attackDamageMax=this.spec.AttackDamageMax,this.attackDamageMin=this.spec.AttackDamageMin;const t=this.playerCtrl.inventory.GetBindItem(Tu.Hands_R);if(null==t)this.player.ChangeAction(xb.Punch,this.attackSpeed);else switch(t.AttackType){case QI.Blunt:case QI.Axe:case QI.Sword:this.player.ChangeAction(xb.Sword,this.attackSpeed),this.attackDist=5,this.meleeAttackMode=!0;break;case QI.Knife:this.player.ChangeAction(xb.Sword,this.attackSpeed),this.attackDist=2,this.meleeAttackMode=!0;break;case QI.Gun:this.player.ChangeAction(xb.Gun,this.attackSpeed),this.attackDist=20,this.meleeAttackMode=!1;break;case QI.Bow:this.player.ChangeAction(xb.Bow,this.attackSpeed),this.meleeAttackMode=!1;break;case QI.Wand:this.player.ChangeAction(xb.Wand,this.attackSpeed),this.meleeAttackMode=!1}this.playerCtrl.RunSt.PreviousState(this),this.attackTime=this.attackSpeed,this.clock=new qc}Uninit(){null!=this.keytimeout&&clearTimeout(this.keytimeout)}rangedAttack(){const t=new Le;this.player.Meshs.getWorldDirection(this.attackDir),this.player.GetItemPosition(t),this.eventCtrl.OnProjectileEvent({id:rR.DefaultBullet,damage:ne.randInt(this.attackDamageMin,this.attackDamageMax),src:t,dir:this.attackDir}),this.attackProcess=!1}meleeAttack(){this.player.Meshs.getWorldDirection(this.attackDir),this.raycast.set(this.player.CenterPos,this.attackDir.normalize());const t=this.raycast.intersectObjects(this.playerCtrl.targets);if(t.length>0&&t[0].distance<this.attackDist){const e=new Map;t.forEach((t=>{if(t.distance>this.attackDist)return!1;const i=e.get(t.object.name),n={type:HR.NormalSwing,damage:ne.randInt(this.attackDamageMin,this.attackDamageMax),obj:t.object};null==i?e.set(t.object.name,[n]):i.push(n)})),e.forEach(((t,e)=>{this.eventCtrl.OnAttackEvent(e,t)}))}this.attackProcess=!1}Update(t){var e;const i=this.DefaultCheck();return null!=i?(this.Uninit(),i):null==this.clock?this:(t=null===(e=this.clock)||void 0===e?void 0:e.getDelta(),this.attackTime+=t,this.attackProcess||this.attackTime/this.attackSpeed<1||(this.attackTime-=this.attackSpeed,this.attackProcess=!0,this.keytimeout=setTimeout((()=>{this.meleeAttackMode?this.meleeAttack():this.rangedAttack()}),1e3*this.attackSpeed*.6)),this)}}class oR extends WI{constructor(t,e,i){super(t,e,i)}Init(){this.player.ChangeAction(xb.Fight)}Uninit(){}Update(){const t=this.DefaultCheck();return null!=t?t:this}}const hR={level:1,maxHealth:100,health:100,maxMana:100,mana:100,maxExp:100,exp:0};class lR{get AttackSpeed(){let t=this.attackSpeed;return null!=this.buff&&this.buff.forEach((e=>{t*=e.GetAttackSpeed()})),t}get AttackDamageMax(){let t=this.attackDamageMax;return null!=this.buff&&this.buff.forEach((e=>{t*=e.GetDamageMax()})),t}get AttackDamageMin(){return this.attackDamageMin}get Status(){return this.status}get Health(){return this.status.health}constructor(t){this.inven=t,this.attackSpeed=2,this.attackDamageMax=1,this.attackDamageMin=1,this.defence=1,this.status=Object.assign({},hR)}SetBuff(t){this.buff=t}ResetStatus(){this.status=Object.assign({},hR)}NextLevelUp(){this.status.level++,this.ItemUpdate(),this.HealthLevelUp()}DefaultLevelSpec(){this.attackSpeed=2,this.attackDamageMax=1*this.status.level,this.attackDamageMin=1*this.status.level,this.defence=1*this.status.level*10}HealthLevelUp(){this.status.maxExp+=50*this.status.level,this.status.exp=0}ItemUpdate(){this.DefaultLevelSpec();const t=this.inven.GetBindItem(Tu.Hands_R);null!=t&&(this.attackSpeed=t.Speed,this.attackDamageMax+=t.DamageMax,this.attackDamageMin+=t.DamageMin)}ReceiveExp(t){this.status.exp+=t,this.status.exp>this.status.maxExp&&this.NextLevelUp()}ReceiveCalcDamage(t){this.status.health-=Math.round(5500/(5500+this.defence)*t)}ReceiveCalcHeal(t){this.status.health>=this.status.maxHealth?this.status.health=this.status.maxHealth:this.status.health+=t}CheckDie(){return this.status.health<=0}Update(t){var e;null===(e=this.buff)||void 0===e||e.forEach((e=>{e.Update(t,this.status)}))}}var cR,uR;class dR{}cR=dR,dR.Zombie="ZombieDeck",dR.Minotaur="MinataurDeck",dR.Batpig="BatpigDeck",dR.Bilby="BilbyDeck",dR.Birdmon="BirdmonDeck",dR.Crab="CrabDeck",dR.Builder="BuilderDeck",dR.Golem="GolemDeck",dR.BigGolem="BiggolemDeck",dR.KittenMonk="KittenmonkDeck",dR.Skeleton="SkeletonDeck",dR.Snake="SnakeDeck",dR.ToadMage="ToadmageDeck",dR.Viking="VikingDeck",dR.WereWolf="WerewolfDeck",dR.List=[cR.Zombie,cR.Minotaur,cR.Batpig,cR.Bilby,cR.Birdmon,cR.Crab,cR.Builder,cR.Golem,cR.BigGolem,cR.KittenMonk,cR.Skeleton,cR.Snake,cR.ToadMage,cR.Viking,cR.WereWolf];class pR{constructor(){pR.DeckDb.set(pR.Zombie.id,pR.Zombie),pR.DeckDb.set(pR.Minotaur.id,pR.Minotaur),pR.DeckDb.set(pR.BatPig.id,pR.BatPig),pR.DeckDb.set(pR.BirdMon.id,pR.BirdMon),pR.DeckDb.set(pR.Crap.id,pR.Crap),pR.DeckDb.set(pR.Builder.id,pR.Builder),pR.DeckDb.set(pR.Golem.id,pR.Golem),pR.DeckDb.set(pR.BigGolem.id,pR.BigGolem),pR.DeckDb.set(pR.KittenMonk.id,pR.KittenMonk),pR.DeckDb.set(pR.Skeleton.id,pR.Skeleton),pR.DeckDb.set(pR.Snake.id,pR.Snake),pR.DeckDb.set(pR.ToadMage.id,pR.ToadMage),pR.DeckDb.set(pR.Viking.id,pR.Viking),pR.DeckDb.set(pR.WereWolf.id,pR.WereWolf)}}pR.DeckDb=new Map,pR.Zombie={id:dR.Zombie,title:" ",contents:"    30    .",maxLv:5,minTime:0,maxTime:10,maxSpawn:30,uniq:!1,monId:rR.Zombie},pR.Minotaur={id:dR.Minotaur,title:" ",contents:"   10     .",maxLv:5,minTime:0,maxTime:15,maxSpawn:5,uniq:!1,monId:rR.Minotaur},pR.BatPig={id:dR.Batpig,title:" ",contents:"    .\n           30   .",maxLv:5,minTime:0,maxTime:15,maxSpawn:30,uniq:!1,monId:rR.Batpig},pR.BirdMon={id:dR.Birdmon,title:" ",contents:" 5  . 5  .\n           3   .",maxLv:5,minTime:5,maxTime:15,maxSpawn:3,uniq:!1,monId:rR.Birdmon},pR.Crap={id:dR.Crab,title:" ",contents:"      .\n           10   .",maxLv:5,minTime:5,maxTime:15,maxSpawn:10,uniq:!1,monId:rR.Crab},pR.Builder={id:dR.Builder,title:"",contents:"\n             .",maxLv:5,minTime:5,maxTime:15,maxSpawn:1,uniq:!0,monId:rR.Builder},pR.Golem={id:dR.Golem,title:"",contents:"    .\n        ",maxLv:5,minTime:5,maxTime:15,maxSpawn:20,uniq:!1,monId:rR.Golem},pR.BigGolem={id:dR.BigGolem,title:"",contents:"     .\n        ",maxLv:5,minTime:10,maxTime:15,maxSpawn:1,uniq:!0,monId:rR.BigGolem},pR.KittenMonk={id:dR.KittenMonk,title:"",contents:"    .\n        ",maxLv:10,minTime:5,maxTime:15,maxSpawn:1,uniq:!0,monId:rR.KittenMonk},pR.Skeleton={id:dR.Skeleton,title:" ",contents:"   .\n        ",maxLv:5,minTime:0,maxTime:15,maxSpawn:30,uniq:!1,monId:rR.Skeleton},pR.Snake={id:dR.Snake,title:" ",contents:"    .\n        ",maxLv:5,minTime:10,maxTime:15,maxSpawn:1,uniq:!0,monId:rR.Snake},pR.ToadMage={id:dR.ToadMage,title:"",contents:"\n        ",maxLv:5,minTime:0,maxTime:15,maxSpawn:15,uniq:!1,monId:rR.ToadMage},pR.Viking={id:dR.Viking,title:"",contents:"\n        ",maxLv:5,minTime:0,maxTime:15,maxSpawn:15,uniq:!1,monId:rR.Viking},pR.WereWolf={id:dR.WereWolf,title:"",contents:" .\n        ",maxLv:5,minTime:5,maxTime:15,maxSpawn:3,uniq:!1,monId:rR.WereWolf};class mR{}uR=mR,mR.Hanhwasbat="Hanhwasbat",mR.WarterCan="WarterCan",mR.Hammer="Hammer",mR.DefaultGun="DefaultGun",mR.Leather="Leather",mR.Logs="Logs",mR.Rocks="Rocks",mR.ZombieDeck="ZombieDeck",mR.MinataurDeck="MinataurDeck",mR.BatPigDeck="BatPigDeck",mR.BilbyDeck="BilbyDeck",mR.BirdmonDeck="BirdmonDeck",mR.CrabDeck="CrabDeck",mR.BuilderDeck="BuilderDeck",mR.GolemDeck="GolemDeck",mR.BigGolemDeck="BigGolemDeck",mR.KittenMonkDeck="KittenMonkDeck",mR.SkeletonDeck="SkeletonDeck",mR.SnakeDeck="SnakeDeck",mR.ToadMageDeck="GolemDeck",mR.VikingDeck="VikingDeck",mR.WereWolfDeck="WerewolfDeck",mR.Apple="Apple",mR.Coconut="Coconut",mR.Tomato="Tomato",mR.Potato="Potato",mR.Carrot="Carrot",mR.DeckList=[uR.ZombieDeck,uR.MinataurDeck,uR.BatPigDeck,uR.BilbyDeck,uR.BirdmonDeck,uR.CrabDeck,uR.SkeletonDeck,uR.GolemDeck,uR.BigGolemDeck,uR.KittenMonkDeck,uR.SnakeDeck,uR.BuilderDeck,uR.ToadMageDeck,uR.VikingDeck,uR.WereWolfDeck],mR.DropList=[uR.Leather,uR.Logs,uR.Rocks],mR.HavestList=[uR.Apple,uR.Coconut,uR.Tomato,uR.Potato,uR.Carrot],mR.ItemCategory=[uR.DeckList,uR.DropList,uR.HavestList];class fR{constructor(t){this.loader=t,this.itemDb=new Map,this.itemDb.set(mR.Hanhwasbat,{id:mR.Hanhwasbat,type:ZI.Attack,weapon:QI.Blunt,bind:Tu.Hands_R,asset:this.loader.BatAsset,level:tR.Common,name:"Hanhwa's Bat",icon:"WeaponTool/TopazStaff.png",stackable:!1,binding:!0,damageMax:5,damageMin:3,speed:1}),this.itemDb.set(mR.DefaultGun,{id:mR.DefaultGun,type:ZI.Attack,weapon:QI.Gun,bind:Tu.Hands_R,asset:this.loader.GunAsset,level:tR.Common,name:"Legacy Gun",icon:"WeaponTool/Bow.png",stackable:!1,binding:!0,damageMax:9,damageMin:3,speed:1}),this.itemDb.set(mR.WarterCan,{id:mR.WarterCan,type:ZI.Farm,bind:Tu.Hands_R,asset:this.loader.WarteringCanAsset,level:tR.Common,name:"Wartering Can",icon:"Misc/Lantern.png",stackable:!1,binding:!0,damageMax:5,damageMin:3,speed:1}),this.itemDb.set(mR.Hammer,{id:mR.Hammer,type:ZI.Attack,bind:Tu.Hands_R,asset:this.loader.HammerAsset,level:tR.Common,name:"Hammer H3",icon:"WeaponTool/Hammer.png",stackable:!1,binding:!0,damageMax:5,damageMin:3,speed:1.5}),this.itemDb.set(mR.Leather,{id:mR.Leather,type:ZI.Material,name:"Leather",namekr:"",icon:"Material/Leather.png",stackable:!0,binding:!1,price:1}),this.itemDb.set(mR.Logs,{id:mR.Logs,type:ZI.Material,name:"WoodLog",namekr:"",icon:"Material/WoodLog.png",stackable:!0,binding:!1,price:1}),this.itemDb.set(mR.Rocks,{id:mR.Rocks,type:ZI.Material,name:"Rocks",namekr:"",icon:"OreGem/SilverNugget.png",stackable:!0,binding:!1,price:1}),this.itemDb.set(mR.ZombieDeck,{id:mR.ZombieDeck,type:ZI.Deck,name:"Zombie Deck",icon:"Misc/Book.png",stackable:!1,binding:!1,price:1,deck:pR.Zombie}),this.itemDb.set(mR.MinataurDeck,{id:mR.MinataurDeck,type:ZI.Deck,name:"Minataur Deck",icon:"Misc/Book.png",stackable:!1,binding:!1,price:1,deck:pR.Minotaur}),this.itemDb.set(mR.BatPigDeck,{id:mR.BatPigDeck,type:ZI.Deck,name:"BatPig Deck",icon:"Misc/Book.png",stackable:!1,binding:!1,price:1,deck:pR.BatPig}),this.itemDb.set(mR.CrabDeck,{id:mR.CrabDeck,type:ZI.Deck,name:"Crab Deck",icon:"Misc/Book.png",stackable:!1,binding:!1,price:1,deck:pR.Crap}),this.itemDb.set(mR.BuilderDeck,{id:mR.BuilderDeck,type:ZI.Deck,name:"Builder Deck",icon:"Misc/Book.png",stackable:!1,binding:!1,price:1,deck:pR.Builder}),this.itemDb.set(mR.GolemDeck,{id:mR.GolemDeck,type:ZI.Deck,name:"Golem Deck",icon:"Misc/Book.png",stackable:!1,binding:!1,price:1,deck:pR.Golem}),this.itemDb.set(mR.BigGolemDeck,{id:mR.BigGolemDeck,type:ZI.Deck,name:"BigGolem Deck",icon:"Misc/Book.png",stackable:!1,binding:!1,price:1,deck:pR.BigGolem}),this.itemDb.set(mR.KittenMonkDeck,{id:mR.KittenMonkDeck,type:ZI.Deck,name:"KittenMonk Deck",icon:"Misc/Book.png",stackable:!1,binding:!1,price:1,deck:pR.KittenMonk}),this.itemDb.set(mR.SkeletonDeck,{id:mR.SkeletonDeck,type:ZI.Deck,name:"Skeleton Deck",icon:"Misc/Book.png",stackable:!1,binding:!1,price:1,deck:pR.Skeleton}),this.itemDb.set(mR.SnakeDeck,{id:mR.SnakeDeck,type:ZI.Deck,name:"Snake Deck",icon:"Misc/Book.png",stackable:!1,binding:!1,price:1,deck:pR.Snake}),this.itemDb.set(mR.ToadMageDeck,{id:mR.ToadMageDeck,type:ZI.Deck,name:"ToadMage Deck",icon:"Misc/Book.png",stackable:!1,binding:!1,price:1,deck:pR.ToadMage}),this.itemDb.set(mR.VikingDeck,{id:mR.VikingDeck,type:ZI.Deck,name:"Viking Deck",icon:"Misc/Book.png",stackable:!1,binding:!1,price:1,deck:pR.Viking}),this.itemDb.set(mR.WereWolfDeck,{id:mR.WereWolfDeck,type:ZI.Deck,name:"WereWolf Deck",icon:"Misc/Book.png",stackable:!1,binding:!1,price:1,deck:pR.WereWolf}),this.itemDb.set(mR.Apple,{id:mR.Apple,type:ZI.Farm,name:"Apple",icon:"Food/Apple.png",stackable:!0,binding:!1,price:1}),this.itemDb.set(mR.Coconut,{id:mR.Coconut,type:ZI.Farm,name:"Coconut",icon:"Food/GreenApple.png",stackable:!0,binding:!1,price:1}),this.itemDb.set(mR.Tomato,{id:mR.Tomato,type:ZI.Farm,name:"Tomato",icon:"Food/Wine2.png",stackable:!0,binding:!1,price:1}),this.itemDb.set(mR.Potato,{id:mR.Potato,type:ZI.Farm,name:"Potato",icon:"Food/GreenApple.png",stackable:!0,binding:!1,price:1}),this.itemDb.set(mR.Carrot,{id:mR.Carrot,type:ZI.Farm,name:"Carrot",icon:"Food/GreenApple.png",stackable:!0,binding:!1,price:1})}GetItem(t){const e=this.itemDb.get(t);if(null==e)throw new Error("unkown key");return e}}class gR extends Ku{get BoxPos(){const t=this.CannonPos;return new Le(t.x,t.y,t.z)}constructor(t,e,i){super(new Uh(t,e,i,5),new Bl({color:36314,transparent:!0,opacity:.5})),this.depth=i;const n=new Uh(t,e,i,5),s=new Bl({color:36314});this.gauge=new On(n,s),this.gauge.scale.set(.9,.01,.9),this.gauge.position.y=i/2,this.add(this.gauge),this.rotation.x=Math.PI/2,this.rotation.y=Math.PI/2,this.rotation.z=Math.PI/2}SetProgress(t){t>1?t=1:t<0&&(t=0),this.gauge.scale.y=t,this.gauge.position.y=this.depth/2*(1-t)}}var vR,yR,xR,bR=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class _R extends $u{get BoxPos(){return this.asset.GetBoxPos(this.meshs)}constructor(t,e,i,n){super(t),this.fruitAsset=e,this.deadtree=i,this.meshName=n,this.gauge=new gR(.1,.1,2),this.gaugeEnable=!1,this.lv=1,this.text=new BI(" "),this.text.position.y=7}Init(){return bR(this,void 0,void 0,(function*(){}))}SetLevel(t){this.lv=t}SetProgress(t){this.gaugeEnable||(this.CreateGauge(),this.gauge.visible=!0),this.gauge.SetProgress(t)}Enough(){null!=this.text&&(this.text.visible=!1),this.SetOpacity(1),this.gauge.Meshs.traverse((t=>{if("material"in t){t.material.color=new Zi("#008DDA")}}))}NeedHavest(){this.fruit&&(this.fruit.traverse((t=>{if("material"in t){const e=t.material;e.transparent=!1,e.depthWrite=!0,e.opacity=1}})),this.fruit.visible=!0)}Havest(){this.fruit&&(this.fruit.visible=!1)}NeedWarter(){null!=this.text&&(this.text.visible=!0,this.text.SetText(" ")),this.SetOpacity(1),this.gauge.Meshs.traverse((t=>{if("material"in t){t.material.color=new Zi("#008DDA")}}))}Death(){return bR(this,void 0,void 0,(function*(){null!=this.text&&(this.text.visible=!0,this.text.SetText(" .")),this.fruit&&(this.fruit.visible=!1),this.meshs.children[0].visible=!1,this.deadTree=yield this.CreateDeadTree(),this.meshs.add(this.deadTree)}))}Damage(){}Delete(){this.meshs.children[0].traverse((t=>{if("material"in t){const e=t.material;e.transparent=!0,e.depthWrite=!0,e.opacity=.3}}))}SetOpacity(t){this.meshs.children[0].traverse((e=>{if("material"in e){const i=e.material;i.transparent=!0,i.depthWrite=!0,i.opacity=t}}))}Plant(){this.meshs.children[0].traverse((t=>{if("material"in t){const e=t.material;e.transparent=!1,e.depthWrite=!0,e.opacity=1}})),this.fruit&&this.fruit.traverse((t=>{if("material"in t){const e=t.material;e.transparent=!1,e.depthWrite=!0,e.opacity=1}})),null!=this.text&&this.text.SetText(" "),this.CreateGauge(),this.gauge.SetProgress(.01)}CreateGauge(){this.gaugeEnable=!0,this.gauge.position.x+=1,this.gauge.position.y=this.gauge.CenterPos.y,this.gauge.position.z+=2,this.gauge.Meshs.traverse((t=>{if("material"in t){t.material.color=new Zi("#008DDA")}})),this.meshs.add(this.gauge)}SetText(t){var e;null===(e=this.text)||void 0===e||e.SetText(t)}Create(){null!=this.text&&(this.text.position.y=7,this.meshs.add(this.text))}MassLoader(t,e){return bR(this,void 0,void 0,(function*(){if(this.meshs=new Da,e){const[t,i]=yield this.asset.UniqModel(this.meshName+e);this.meshs.add(t)}else this.meshs.add(yield this.asset.CloneModel());this.fruit=yield this.fruitAsset.CloneModel(),this.fruit.name="fruit",this.fruit.visible=!1,this.fruit.position.set(0,4,2),this.meshs.add(this.fruit),this.meshs.position.set(t.x,t.y,t.z),this.meshs.castShadow=!0,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!0,"material"in t&&(t.material.transparent=!0,t.material.depthWrite=!1,t.material.opacity=.3)})),this.meshs.visible=!1}))}CreateDeadTree(){return bR(this,void 0,void 0,(function*(){return yield this.deadtree.CloneModel()}))}}class wR{}vR=wR,wR.AppleTree="appletree",wR.CoconutTree="coconutree",wR.Tomato="tomato",wR.Potato="potato",wR.Carrot="carrot",wR.List=[vR.AppleTree,vR.CoconutTree,vR.Tomato,vR.Potato,vR.Carrot],function(t){t[t.Tree=0]="Tree",t[t.Vegetable=1]="Vegetable",t[t.Fruit=2]="Fruit"}(yR||(yR={}));class MR{get Items(){return this.plantDb}constructor(){this.plantDb=new Map,this.plantDb.set(wR.AppleTree,{plantId:wR.AppleTree,type:yR.Tree,assetId:Cu.AppleTree,name:"Apple Tree",namekr:"",maxLevel:2,levelUpTime:1e4,warteringTime:36e5,drop:[{itemId:mR.Apple,ratio:1}]}),this.plantDb.set(wR.CoconutTree,{plantId:wR.CoconutTree,type:yR.Tree,assetId:Cu.CoconutTree,name:"Coconut Tree",namekr:"",maxLevel:2,levelUpTime:1e4,warteringTime:36e5,drop:[{itemId:mR.Coconut,ratio:1}]}),this.plantDb.set(wR.Tomato,{plantId:wR.Tomato,type:yR.Vegetable,assetId:Cu.Tomato0,name:"Tomato",namekr:"",maxLevel:3,levelUpTime:1e4,warteringTime:36e5,drop:[{itemId:mR.Tomato,ratio:1}]}),this.plantDb.set(wR.Potato,{plantId:wR.Potato,type:yR.Vegetable,assetId:Cu.Potato0,name:"Potato",namekr:"",maxLevel:3,levelUpTime:864e5,warteringTime:36e5,drop:[{itemId:mR.Potato,ratio:1}]}),this.plantDb.set(wR.Carrot,{plantId:wR.Carrot,type:yR.Vegetable,assetId:Cu.Carrot0,name:"Carrot",namekr:"",maxLevel:3,levelUpTime:864e5,warteringTime:36e5,drop:[{itemId:mR.Carrot,ratio:1}]})}get(t){return this.plantDb.get(t)}}class SR{get State(){return this.save.state}get PlantType(){return this.property.type}get NeedHavest(){return this.needHavest}get Drop(){return this.property.drop}constructor(t,e,i,n,s){this.tree=e,this.treeMotion=i,this.property=n,this.save=s,this.lv=1,this.timer=0,this.checktime=0,this.health=3,this.havest=3,this.needHavest=!1,this.position=e.CannonPos;const r=e.Size,a=new Bn(r.x/2,r.y,r.z/2),o=new nn({color:16711680,wireframe:!0});this.phybox=new PR(t,"farmtree",a,o,this),"hons.ghostwebservice.com"==window.location.hostname&&(this.phybox.visible=!1),this.phybox.position.copy(this.tree.BoxPos),this.CheckWartering(),this.dom=document.getElementById("edit-progress-bar-container"),this.progress=document.getElementById("edit-progress-bar"),this.msg=document.getElementById("job_label")}ReAlloc(t){this.tree.CannonPos.copy(t),this.phybox.position.copy(this.tree.BoxPos)}Release(){this.lv=1,this.timer=0,this.checktime=0,this.health=3,this.havest=3,this.needHavest=!1,this.save.state=CR.NeedSeed,this.treeMotion.Delete(),this.progress.value=0}AfterHavest(){this.lv=1,this.timer=0,this.checktime=0,this.health=3,this.havest=3,this.needHavest=!1}SeedStart(){this.save.state==CR.NeedSeed&&(this.timer=0,this.save.state=CR.Seeding,this.msg.innerText=" .",this.dom.style.display="block")}SeedCancel(){this.save.state==CR.Seeding&&(this.save.state=CR.NeedSeed),this.dom.style.display="none",this.progress.value=0}WarteringStart(){this.save.state!=CR.Death&&(this.save.state!=CR.Enough&&this.save.state!=CR.NeedWartering||(this.timer=0,this.save.state=CR.Wartering))}WarteringCancel(){this.save.state==CR.Wartering&&this.CheckWartering()}WaterDone(){this.save.state=CR.Enough,this.timer=0,this.save.lastWarteringTime=(new Date).getTime()}StartGrow(){if(this.save.state==CR.Death)return;this.save.state=CR.NeedWartering;const t=(new Date).getTime();this.save.lastWarteringTime=t-this.property.warteringTime,this.save.lastHarvestTime=t,this.treeMotion.Plant(),this.dom.style.display="none"}Delete(t){return t?(this.msg.innerText=" .",this.dom.style.display="block",this.health-=t,this.progress.value=1-this.health/3,this.treeMotion.Damage(this.health/3)):this.dom.style.display="none",this.health<=0?(this.Release(),0):this.health}HavestStart(t){return t?(this.msg.innerText=".",this.dom.style.display="block",this.havest-=t,this.progress.value=1-this.havest/3):this.dom.style.display="none",this.havest<=0?(this.Havest(),0):this.havest}Havest(){this.AfterHavest(),this.save.lastHarvestTime=(new Date).getTime(),this.treeMotion.Havest()}CheckWartering(){if(this.save.state==CR.NeedSeed)return;const t=1-((new Date).getTime()-this.save.lastWarteringTime)/this.property.warteringTime;this.treeMotion.SetProgress(t),t<-1?(this.save.state=CR.Death,this.treeMotion.Death()):t>.5?(this.save.state=CR.Enough,this.treeMotion.Enough()):(this.save.state=CR.NeedWartering,this.treeMotion.NeedWarter())}CheckLevelUp(){if(this.save.state==CR.NeedSeed)return;const t=(new Date).getTime()-this.save.lastHarvestTime,e=Math.floor(t/this.property.levelUpTime)+1;this.lv!=e&&(this.lv=e>this.property.maxLevel?this.property.maxLevel:this.lv+1,this.treeMotion.SetLevel(this.lv),this.lv==this.property.maxLevel&&(this.treeMotion.NeedHavest(),this.needHavest=!0)),this.save.lv=this.lv}update(t){if(this.checktime+=t,!(Math.floor(this.checktime)<1)){switch(this.checktime=0,this.save.state){case CR.NeedSeed:case CR.Death:return;case CR.Wartering:{this.timer+=10*t;const e=this.timer/5;this.treeMotion.SetProgress(e),e>1&&this.WaterDone()}return;case CR.Seeding:this.timer+=10*t;const e=this.timer/2;return this.progress.value=e,void(e>1&&this.StartGrow());case CR.Enough:this.treeMotion.Enough()}this.CheckWartering(),this.CheckLevelUp()}}}!function(t){t[t.Normal=0]="Normal",t[t.Warning=1]="Warning",t[t.Deck=2]="Deck"}(xR||(xR={}));class ER{constructor(){this.dom=document.createElement("div"),this.bigDom=document.createElement("div"),this.dom.className="playalarm",document.body.appendChild(this.dom),this.bigDom.className="bigplayalarm",document.body.appendChild(this.bigDom)}NotifyInfo(t,e){switch(e){case xR.Normal:this.dom.style.display="block",this.dom.insertAdjacentHTML("beforeend",t+"<br>"),Vg.fromTo(".playalarm",2,{opacity:1},{opacity:0,ease:"power1.inOut",onComplete:()=>{this.dom.style.display="none",this.dom.innerText=""}});break;case xR.Deck:this.bigDom.style.display="block",this.bigDom.insertAdjacentHTML("beforeend",t+"<br>"),Vg.to(".bigplayalarm",3,{scale:2,ease:"elastic.out",onComplete:()=>{this.bigDom.style.display="none",this.bigDom.innerText=""}})}}}var TR=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class AR extends $u{get BoxPos(){return this.asset.GetBoxPos(this.meshs)}constructor(t,e){super(t[0]),this.assets=t,this.meshName=e,this.gauge=new gR(.1,.1,2),this.gaugeEnable=!1,this.lv=1,this.text=new BI(""),this.text.SetText(this.meshName+" "),this.text.position.y=7}Init(){return TR(this,void 0,void 0,(function*(){}))}SetLevel(t){this.lv=t;const e=t-1;for(let t=0;t<this.assets.length;t++)this.meshs.children[t].visible=t==e}SetProgress(t){this.gaugeEnable||(this.CreateGauge(),this.gauge.visible=!0),this.gauge.SetProgress(t)}Enough(){null!=this.text&&(this.text.visible=!1),this.SetOpacity(1),this.gauge.Meshs.traverse((t=>{if("material"in t){t.material.color=new Zi("#008DDA")}}))}NeedHavest(){}Havest(){this.SetLevel(1)}NeedWarter(){null!=this.text&&(this.text.visible=!0,this.text.SetText(" ")),this.SetOpacity(1),this.gauge.Meshs.traverse((t=>{if("material"in t){t.material.color=new Zi("#008DDA")}}))}Death(){return TR(this,void 0,void 0,(function*(){null!=this.text&&(this.text.visible=!0,this.text.SetText(" ."));const t=this.lv-1;this.meshs.children[t].traverse((t=>{if("material"in t){t.material.color=new Zi("#000000")}}))}))}Damage(){}Delete(){for(let t=0;t<this.assets.length;t++)this.meshs.children[t].traverse((t=>{if("material"in t){const e=t.material;e.transparent=!0,e.depthWrite=!1,e.opacity=.3}}))}SetOpacity(t){const e=this.lv-1;this.meshs.children[e].traverse((e=>{if("material"in e){const i=e.material;i.transparent=!0,i.depthWrite=!0,i.opacity=t}}))}Plant(){for(let t=0;t<this.assets.length;t++)this.meshs.children[t].traverse((t=>{if("material"in t){const e=t.material;e.transparent=!0,e.depthWrite=!0,e.opacity=1}}));null!=this.text&&this.text.SetText(" "),this.gaugeEnable||this.CreateGauge(),this.gauge.SetProgress(.01)}CreateGauge(){this.gaugeEnable=!0,this.gauge.position.x+=1,this.gauge.position.y=this.gauge.CenterPos.y,this.gauge.position.z+=2,this.gauge.Meshs.traverse((t=>{if("material"in t){t.material.color=new Zi("#008DDA")}})),this.meshs.add(this.gauge)}SetText(t){var e;null===(e=this.text)||void 0===e||e.SetText(t)}Create(){null!=this.text&&(this.text.position.y=7,this.meshs.add(this.text)),this.SetLevel(this.lv)}MassLoader(t,e){return TR(this,void 0,void 0,(function*(){if(this.meshs=new Da,e)for(let t=0;t<this.assets.length;t++){const i=this.assets[t],[n,s]=yield i.UniqModel(this.meshName+t+"_"+e);t&&(n.visible=!1),this.meshs.add(n)}else for(let t=0;t<this.assets.length;t++){const e=this.assets[t],i=yield e.CloneModel();t&&(i.visible=!1),this.meshs.add(i)}this.meshs.position.copy(t),this.meshs.castShadow=!0,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!0,"material"in t&&(t.material.transparent=!0,t.material.depthWrite=!1,t.material.opacity=.3)})),this.meshs.visible=!1}))}}var CR,IR,RR,kR=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};!function(t){t[t.NeedSeed=0]="NeedSeed",t[t.Seeding=1]="Seeding",t[t.Enough=2]="Enough",t[t.NeedWartering=3]="NeedWartering",t[t.Wartering=4]="Wartering",t[t.Death=5]="Death",t[t.Delete=6]="Delete"}(CR||(CR={}));class PR extends On{constructor(t,e,i,n,s){super(i,n),this.Id=t,this.ObjName=e,this.ctrl=s,this.name=e}}class DR{constructor(t,e,i,n,s,r,a,o,h,l,c){this.loader=t,this.player=e,this.playerCtrl=i,this.game=n,this.store=s,this.gphysic=r,this.eventCtrl=o,this.alarm=h,this.drop=l,this.plantDb=c,this.controllable=!1,this.plantsFab=new Map,this.plantset=[],this.recycle=[],this.saveData=this.store.Plants,this.allocPos=0,a.RegisterViewer(this),s.RegisterStore(this),o.RegisterAppModeEvent(((t,e,i)=>{if(t==DP.Farmer)switch(e){case Lu.Start:if(this.target=this.plantsFab.get(i),!this.target)return;this.targetId=i,this.controllable=!0,this.game.add(this.target.Meshs),this.target.Visible=!0,this.target.CannonPos.x=this.player.CannonPos.x,this.target.CannonPos.z=this.player.CannonPos.z,this.eventCtrl.OnChangeCtrlObjEvent(this.target),this.CheckCollision();break;case Lu.End:if(this.controllable=!1,!this.target)return;this.target.Visible=!1,this.game.remove(this.target.Meshs)}})),o.RegisterKeyDownEvent((t=>{if(this.controllable)if(t.Type===Ou.Action0){if(!this.target||!this.targetId||this.CheckPlantAPlant())return;const t={position:(new Le).copy(this.target.CannonPos),id:this.targetId,state:CR.NeedSeed,lastWarteringTime:0,lv:1,createTime:0,lastHarvestTime:0};this.saveData.push(t),this.CreatePlant(t),o.OnAppModeEvent(DP.EditPlay)}else{const e=t.ExecuteKeyDown();this.moveEvent(e)}})),o.RegisterAttackEvent("farmtree",(t=>{t.forEach((t=>{let e=t.obj;if(null==e)return;const i=this.plantset[e.Id];t.type==HR.PlantAPlant?t.damage?i.plantCtrl.SeedStart():i.plantCtrl.SeedCancel():t.type==HR.Wartering?t.damage?i.plantCtrl.WarteringStart():i.plantCtrl.WarteringCancel():t.type==HR.Havest?i.plantCtrl.HavestStart(t.damage)<=0&&this.HavestPlant(e.Id):t.type==HR.Delete&&i.plantCtrl.Delete(t.damage)<=0&&this.DeletePlant(e.Id)}))}))}update(t){for(let e=0;e<this.plantset.length;e++)this.plantset[e].plantCtrl.update(t)}Viliageload(){return kR(this,void 0,void 0,(function*(){this.ReleaseAllPlantPool()}))}Reload(){return kR(this,void 0,void 0,(function*(){this.ReleaseAllPlantPool(),this.saveData=this.store.Plants,this.saveData&&this.saveData.forEach((t=>{this.CreatePlant(t)}))}))}Cityload(){return kR(this,void 0,void 0,(function*(){this.ReleaseAllPlantPool()}))}CheckPlantAPlant(){const t=this.target;if(!t)return!0;return this.plantset.filter((t=>1==t.used)).some((e=>e.plant.Box.intersectsBox(t.Box)))?(this.alarm.NotifyInfo("  .",xR.Normal),!0):t.CannonPos.y>.1&&(this.alarm.NotifyInfo(" .",xR.Normal),!0)}HavestPlant(t){const e=this.plantset[t];this.drop.DirectItem(e.plantCtrl.Drop)}DeletePlant(t){const e=this.plantset[t];if(!e.used)return;e.used=!1;const i=this.saveData.findIndex((t=>t.position.x==e.plant.CannonPos.x&&t.position.z==e.plant.CannonPos.z));i>-1&&this.saveData.splice(i,1),this.playerCtrl.remove(e.plantCtrl.phybox),this.game.remove(e.plant.Meshs,e.plantCtrl.phybox)}CreatePlant(t){return kR(this,void 0,void 0,(function*(){const e=this.plantDb.get(t.id);if(!e)return;const i=yield this.NewPlantEntryPool(t,e);this.playerCtrl.add(i.plantCtrl.phybox),this.game.add(i.plant.Meshs,i.plantCtrl.phybox)}))}moveEvent(t){if(!this.target)return;const e=t.x>0?1:t.x<0?-1:0,i=t.z>0?1:t.z<0?-1:0;this.target.Meshs.position.x+=e,this.target.Meshs.position.z+=i,this.gphysic.Check(this.target)&&(this.target.Meshs.position.x-=e,this.target.Meshs.position.z-=i),this.CheckCollision()}CheckCollision(){if(this.target)if(this.gphysic.Check(this.target))do{this.target.CannonPos.y+=.5}while(this.gphysic.Check(this.target));else{do{this.target.CannonPos.y-=.5}while(!this.gphysic.Check(this.target)&&this.target.CannonPos.y>=0);this.target.CannonPos.y+=.5}}AllocatePlantPool(t,e){for(let i=0;i<this.plantset.length;i++,this.allocPos++){this.allocPos%=this.plantset.length;const i=this.plantset[this.allocPos];if(i.plantId==t.plantId&&0==i.used)return i.used=!0,i.plantCtrl.ReAlloc(e),i}}ReleaseAllPlantPool(){this.plantset.forEach((t=>{t.used=!1,this.playerCtrl.remove(t.plantCtrl.phybox),this.game.remove(t.plant.Meshs,t.plantCtrl.phybox)})),this.plantset.length=0}NewPlantEntryPool(t,e){return kR(this,void 0,void 0,(function*(){const i=yield this.allocModel(t.id,t);yield i.MassLoader(t.position,this.plantset.length.toString()),i.Create(),i.Visible=!0;const n=new SR(this.plantset.length,i,i,e,t),s={plantId:t.id,plant:i,plantCtrl:n,used:!0};return this.plantset.push(s),s}))}FarmLoader(){return kR(this,void 0,void 0,(function*(){wR.List.map((t=>kR(this,void 0,void 0,(function*(){yield this.allocModel(t)}))))}))}allocModel(t,e){return kR(this,void 0,void 0,(function*(){const i=Du.DefaultPortalPosition;let n;switch(t){default:case wR.AppleTree:n=new _R(this.loader.AppleTreeAsset,this.loader.AppleAsset,this.loader.DeadTree2Asset,"appletree");break;case wR.CoconutTree:n=new _R(this.loader.CoconutTreeAsset,this.loader.CoconutAsset,this.loader.DeadTree2Asset,"coconuttree");break;case wR.Tomato:n=new AR([this.loader.Tomato0Asset,this.loader.Tomato1Asset,this.loader.Tomato2Asset],"tomato");break;case wR.Potato:n=new AR([this.loader.Potato0Asset,this.loader.Potato1Asset,this.loader.Potato2Asset],"potato");break;case wR.Carrot:n=new AR([this.loader.Carrot0Asset,this.loader.Carrot1Asset,this.loader.Carrot2Asset],"carrot")}return e?(yield n.MassLoader(e.position,this.plantset.length.toString()),n):(this.plantsFab.set(t,n),yield n.MassLoader(i),n)}))}}class LR{get State(){return this.saveEntry.state}get Entry(){return this.saveEntry}constructor(t,e,i,n,s,r,a){this.funi=e,this.treeMotion=i,this.property=n,this.gphysic=s,this.save=r,this.saveEntry=a,this.lv=1,this.timer=0,this.lastBuildingTime=0,this.checktime=0,this.health=3,this.position=e.CannonPos;const o=e.Size,h=new Bn(o.x,o.y,o.z),l=new nn({color:16711680,wireframe:!0});this.phybox=new GR(t,"furniture",h,l,this),"hons.ghostwebservice.com"==window.location.hostname&&(this.phybox.visible=!1);this.phybox.scale.set(1.2,1,1.2),this.phybox.position.copy(this.funi.BoxPos),this.phybox.rotation.copy(this.funi.Meshs.rotation),a.state==UR.Done&&this.treeMotion.Done(),this.dom=document.getElementById("edit-progress-bar-container"),this.progress=document.getElementById("edit-progress-bar"),this.msg=document.getElementById("job_label")}BuildingStart(){if(this.saveEntry.state==UR.Done)return;this.timer=0,this.saveEntry.state=UR.Building;const t=(new Date).getTime();this.lastBuildingTime=t-this.property.buildingTime,this.msg.innerText=" .",this.dom.style.display="block"}BuildingCancel(){this.saveEntry.state==UR.Building&&(this.saveEntry.state=UR.Suspend),this.dom.style.display="none"}BuildingDone(){this.saveEntry.state=UR.Done,this.timer=0,this.lastBuildingTime=(new Date).getTime(),this.treeMotion.Done(),this.save.push({id:this.property.id,createTime:this.lastBuildingTime,state:this.saveEntry.state,position:this.funi.CannonPos,rotation:this.funi.Meshs.rotation}),this.dom.style.display="none"}Delete(t){return t?(this.msg.innerText=" .",this.dom.style.display="block",this.health-=t,this.progress.value=1-this.health/3):this.dom.style.display="none",this.health}update(t){if(this.checktime+=t,!(Math.floor(this.checktime)<1)){if(this.checktime=0,this.gphysic.Check(this.funi))do{this.funi.CannonPos.y+=.2}while(this.gphysic.Check(this.funi));else{do{this.funi.CannonPos.y-=.2}while(!this.gphysic.Check(this.funi)&&this.funi.CannonPos.y>=0);this.funi.CannonPos.y+=.2}switch(this.saveEntry.position.x=this.funi.CannonPos.x,this.saveEntry.position.y=this.funi.CannonPos.y,this.saveEntry.position.z=this.funi.CannonPos.z,this.phybox.position.copy(this.funi.BoxPos),this.saveEntry.state){case UR.NeedBuilding:return;case UR.Building:{this.timer+=10*t;const e=this.timer/5;this.progress.value=e,e>1&&this.BuildingDone()}return}}}}class OR{}IR=OR,OR.DefaultBed="defaultbed",OR.DefaultBath="defaultbath",OR.DefaultBookShelf="defaultbookshelf",OR.DefaultCloset="defaultcloset",OR.DefaultDesk="defaultdesk",OR.DefaultKitchen="defaultkitchen",OR.DefaultKitTable="defaultkittable",OR.DefaultOven="defaultoven",OR.DefaultRefrigerator="defaultrefrigerator",OR.DefaultSink="defaultsink",OR.DefaultTable="defaulttable",OR.DefaultToilet="defaulttoilet",OR.DefaultTv="defaulttv",OR.List=[IR.DefaultBed,IR.DefaultBath,IR.DefaultBookShelf,IR.DefaultCloset,IR.DefaultDesk,IR.DefaultKitTable,IR.DefaultKitchen,IR.DefaultOven,IR.DefaultRefrigerator,IR.DefaultSink,IR.DefaultTable,IR.DefaultToilet,IR.DefaultTv],function(t){t[t.Bed=0]="Bed",t[t.Bath=1]="Bath",t[t.BookShelf=2]="BookShelf",t[t.Closet=3]="Closet",t[t.Desk=4]="Desk",t[t.Kitchen=5]="Kitchen",t[t.Table=6]="Table",t[t.Oven=7]="Oven",t[t.Refrigerator=8]="Refrigerator",t[t.Sink=9]="Sink",t[t.Toilet=10]="Toilet",t[t.Tv=11]="Tv"}(RR||(RR={}));class NR{get Items(){return this.furnDb}constructor(){this.furnDb=new Map,this.furnDb.set(OR.DefaultBed,{id:OR.DefaultBed,type:RR.Bed,assetId:Cu.Bed,name:"Bed",namekr:"",buildingTime:6e4,madeby:[{itemId:mR.Rocks,count:2},{itemId:mR.Logs,count:5},{itemId:mR.Leather,count:5}]}),this.furnDb.set(OR.DefaultBath,{id:OR.DefaultBath,type:RR.Bath,assetId:Cu.Bath,name:"Bath",namekr:"",buildingTime:6e4,madeby:[{itemId:mR.Rocks,count:10}]}),this.furnDb.set(OR.DefaultBookShelf,{id:OR.DefaultBookShelf,type:RR.BookShelf,assetId:Cu.Bookshelf,name:"BookShelf",namekr:"",buildingTime:6e4,madeby:[{itemId:mR.Logs,count:5}]}),this.furnDb.set(OR.DefaultCloset,{id:OR.DefaultCloset,type:RR.Closet,assetId:Cu.Closet,name:"Closet",namekr:"",buildingTime:6e4,madeby:[{itemId:mR.Logs,count:10}]}),this.furnDb.set(OR.DefaultDesk,{id:OR.DefaultDesk,type:RR.Desk,assetId:Cu.Desk,name:"Desk",namekr:"",buildingTime:6e4,madeby:[{itemId:mR.Logs,count:10}]}),this.furnDb.set(OR.DefaultKitchen,{id:OR.DefaultKitchen,type:RR.Kitchen,assetId:Cu.Kitchen,name:"Kitchen",namekr:"",buildingTime:6e4,madeby:[{itemId:mR.Rocks,count:5},{itemId:mR.Logs,count:20}]}),this.furnDb.set(OR.DefaultKitTable,{id:OR.DefaultKitTable,type:RR.Table,assetId:Cu.KitTable,name:"Kitchen Table",namekr:"",buildingTime:6e4,madeby:[{itemId:mR.Logs,count:5}]}),this.furnDb.set(OR.DefaultOven,{id:OR.DefaultOven,type:RR.Oven,assetId:Cu.Oven,name:"Oven",namekr:"",buildingTime:6e4,madeby:[{itemId:mR.Rocks,count:10},{itemId:mR.Logs,count:2}]}),this.furnDb.set(OR.DefaultRefrigerator,{id:OR.DefaultRefrigerator,type:RR.Refrigerator,assetId:Cu.Refrigerator,name:"Refrigerator",namekr:"",buildingTime:6e4}),this.furnDb.set(OR.DefaultSink,{id:OR.DefaultSink,type:RR.Sink,assetId:Cu.Sink,name:"Sink",namekr:"",buildingTime:6e4,madeby:[{itemId:mR.Rocks,count:20}]}),this.furnDb.set(OR.DefaultTable,{id:OR.DefaultTable,type:RR.Table,assetId:Cu.Table,name:"Table",namekr:"",buildingTime:6e4}),this.furnDb.set(OR.DefaultToilet,{id:OR.DefaultToilet,type:RR.Toilet,assetId:Cu.Toilet,name:"Toilet",namekr:"",buildingTime:6e4,madeby:[{itemId:mR.Rocks,count:10}]}),this.furnDb.set(OR.DefaultTv,{id:OR.DefaultTv,type:RR.Tv,assetId:Cu.TV,name:"TV",namekr:"",buildingTime:6e4})}get(t){return this.furnDb.get(t)}}var BR=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class zR extends $u{get BoxPos(){return this.asset.GetBoxPos(this.meshs)}constructor(t,e){super(t),this.name=e,this.text=new BI(" ")}Init(){return BR(this,void 0,void 0,(function*(){}))}Building(){}Done(){this.meshs.traverse((t=>{if("material"in t){const e=t.material;e.transparent=!1,e.depthWrite=!0,e.opacity=1}})),null!=this.text&&(this.text.visible=!1)}SetText(t){var e;null===(e=this.text)||void 0===e||e.SetText(t)}Create(){null!=this.text&&(this.text.position.y=4,this.meshs.add(this.text))}MassLoader(t,e,i){return BR(this,void 0,void 0,(function*(){if(i){const[t,e]=yield this.asset.UniqModel(this.name+i);this.meshs=t}else this.meshs=yield this.asset.CloneModel();this.meshs.position.set(t.x,t.y,t.z),e&&this.meshs.rotation.copy(e),this.meshs.castShadow=!0,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!0,"material"in t&&(t.material.transparent=!0,t.material.depthWrite=!1,t.material.opacity=.3)}))}))}}var UR,FR=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};!function(t){t[t.NeedBuilding=0]="NeedBuilding",t[t.Building=1]="Building",t[t.Suspend=2]="Suspend",t[t.Done=3]="Done"}(UR||(UR={}));class GR extends On{constructor(t,e,i,n,s){super(i,n),this.Id=t,this.ObjName=e,this.ctrl=s,this.name=e}}class VR{constructor(t,e,i,n,s,r,a,o,h,l,c){this.loader=t,this.player=e,this.playerCtrl=i,this.game=n,this.store=s,this.gphysic=r,this.eventCtrl=o,this.furnDb=h,this.alarm=l,this.inven=c,this.controllable=!1,this.furnFab=new Map,this.furnitures=[],this.saveData=this.store.Furn,this.allocPos=0,a.RegisterViewer(this),s.RegisterStore(this),o.RegisterAppModeEvent(((t,e,i)=>{if(t==DP.Furniture)switch(e){case Lu.Start:if(this.target=this.furnFab.get(i),!this.target)return;this.targetId=i,this.controllable=!0,this.game.add(this.target.Meshs),this.target.Visible=!0,this.CopyPosition(this.target.CannonPos,this.player.CannonPos),this.eventCtrl.OnChangeCtrlObjEvent(this.target),this.CheckCollision();break;case Lu.End:if(this.controllable=!1,!this.target)return;this.target.Visible=!1,this.game.remove(this.target.Meshs)}})),o.RegisterKeyDownEvent((t=>{if(this.controllable)switch(t.Type){case Ou.Action0:if(!this.target||!this.targetId||!this.CheckMaterial(this.targetId))return;const e={id:this.targetId,position:(new Le).copy(this.target.CannonPos),rotation:(new bi).copy(this.target.Meshs.rotation),state:UR.NeedBuilding,createTime:0};this.CreateFurn(e),o.OnAppModeEvent(DP.EditPlay);break;case Ou.Action1:if(!this.target||!this.targetId)return;this.target.Meshs.rotation.y+=Math.PI/2;break;default:const i=t.ExecuteKeyDown();this.moveEvent(i)}})),o.RegisterAttackEvent("furniture",(t=>{t.forEach((t=>{let e=t.obj;if(null==e)return;const i=this.furnitures[e.Id];t.type==HR.Building?t.damage?i.furnCtrl.BuildingStart():i.furnCtrl.BuildingCancel():t.type==HR.Delete&&i.furnCtrl.Delete(t.damage)<=0&&this.DeleteFurn(e.Id)}))}))}CopyPosition(t,e){t.x=Math.ceil(e.x),t.y=e.y,t.z=Math.ceil(e.z)}update(t){for(let e=0;e<this.furnitures.length;e++)this.furnitures[e].furnCtrl.update(t)}CheckCollision(){if(this.target)if(this.gphysic.Check(this.target))do{this.target.CannonPos.y+=.5}while(this.gphysic.Check(this.target));else{do{this.target.CannonPos.y-=.5}while(!this.gphysic.Check(this.target)&&this.target.CannonPos.y>=0);this.target.CannonPos.y+=.5}}Viliageload(){return FR(this,void 0,void 0,(function*(){this.ReleaseAllFurnPool()}))}Reload(){return FR(this,void 0,void 0,(function*(){this.ReleaseAllFurnPool(),this.saveData=this.store.Furn,this.saveData&&this.saveData.forEach((t=>{this.CreateFurn(t)}))}))}Cityload(){return FR(this,void 0,void 0,(function*(){this.ReleaseAllFurnPool()}))}CheckMaterial(t){const e=this.furnDb.get(t),i=null==e?void 0:e.madeby;if(!i)return!0;const n=[],s=i.some((t=>{var e;const i=this.inven.GetItem(t.itemId);if(!(i&&i.count>=t.count)){const i=this.inven.GetItemInfo(t.itemId),n=null!==(e=i.namekr)&&void 0!==e?e:i.name;return this.alarm.NotifyInfo(n+" .",xR.Normal),!0}n.push(i)}));return 0==s&&(i.forEach((t=>{const e=n.find((e=>e.item.Id==t.itemId));if(!e)throw new Error("unexpected undefined value");e.count-=t.count})),!0)}CreateFurn(t){return FR(this,void 0,void 0,(function*(){const e=this.furnDb.get(t.id);if(!e)return;const i=yield this.NewFurnEntryPool(t,e);this.playerCtrl.add(i.furnCtrl.phybox),this.game.add(i.furn.Meshs,i.furnCtrl.phybox)}))}DeleteFurn(t){const e=this.furnitures[t];if(!e.used)return;e.used=!1;const i=this.saveData.findIndex((t=>t.position.x==e.furn.CannonPos.x&&t.position.z==e.furn.CannonPos.z));i>-1&&this.saveData.splice(i,1),this.playerCtrl.remove(e.furnCtrl.phybox),this.game.remove(e.furn.Meshs,e.furnCtrl.phybox)}moveEvent(t){if(!this.target)return;const e=t.x>0?1:t.x<0?-1:0,i=t.z>0?1:t.z<0?-1:0;this.target.Meshs.position.x+=e,this.target.Meshs.position.z+=i,this.gphysic.Check(this.target)&&(this.target.Meshs.position.x-=e,this.target.Meshs.position.z-=i);do{this.target.CannonPos.y-=.2}while(!this.gphysic.Check(this.target)&&this.target.CannonPos.y>=0);this.target.CannonPos.y+=.2}AllocateFurnPool(t,e){for(let i=0;i<this.furnitures.length;i++,this.allocPos++){this.allocPos%=this.furnitures.length;const i=this.furnitures[this.allocPos];if(i.id==t.id&&0==i.used)return i.used=!0,i.furn.CannonPos.copy(e.position),i.furn.Meshs.rotation.copy(e.rotation),i.furnCtrl.phybox.position.copy(i.furn.BoxPos),i}}ReleaseAllFurnPool(){this.furnitures.forEach((t=>{t.used=!1,this.playerCtrl.remove(t.furnCtrl.phybox),this.game.remove(t.furn.Meshs,t.furnCtrl.phybox)})),this.furnitures.length=0}NewFurnEntryPool(t,e){return FR(this,void 0,void 0,(function*(){const i=this.getModel(t.id);if(!i)throw new Error("unexpected allocation fail");yield i.MassLoader(t.position,t.rotation,this.furnitures.length.toString()),i.Create(),i.Visible=!0;const n=new LR(this.furnitures.length,i,i,e,this.gphysic,this.saveData,t),s={id:t.id,furn:i,furnCtrl:n,used:!0};return this.furnitures.push(s),s}))}FurnLoader(){return FR(this,void 0,void 0,(function*(){OR.List.map((t=>FR(this,void 0,void 0,(function*(){yield this.allocModel(t,this.getModel(t))}))))}))}allocModel(t,e){return FR(this,void 0,void 0,(function*(){const i=Du.DefaultPortalPosition;this.furnFab.set(t,e),yield e.MassLoader(i)}))}getModel(t){let e;switch(t){default:case OR.DefaultBed:e=new zR(this.loader.BedAsset,"bed");break;case OR.DefaultBath:e=new zR(this.loader.BathAsset,"bath");break;case OR.DefaultBookShelf:e=new zR(this.loader.BookShelfAsset,"bookshelf");break;case OR.DefaultCloset:e=new zR(this.loader.ClosetAsset,"closet");break;case OR.DefaultDesk:e=new zR(this.loader.DeskAsset,"desk");break;case OR.DefaultKitchen:e=new zR(this.loader.KitchenAsset,"kitchen");break;case OR.DefaultKitTable:e=new zR(this.loader.KitTableAsset,"kittable");break;case OR.DefaultOven:e=new zR(this.loader.OvenAsset,"oven");break;case OR.DefaultRefrigerator:e=new zR(this.loader.RefrigeratorAsset,"refrigerator");break;case OR.DefaultSink:e=new zR(this.loader.SinkAsset,"sink");break;case OR.DefaultTable:e=new zR(this.loader.TableAsset,"table");break;case OR.DefaultToilet:e=new zR(this.loader.ToiletAsset,"toilet");break;case OR.DefaultTv:e=new zR(this.loader.TableAsset,"tv")}return e}}var HR,jR=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class WR extends WI{constructor(t,e,i,n){super(t,e,i),this.eventCtrl=n,this.next=this,this.attackDist=3,this.attackDir=new Le,this.raycast=new ou,this.attackTime=0,this.attackSpeed=2}Init(){this.next=this,this.player.ChangeAction(xb.PickFruit),this.playerCtrl.RunSt.PreviousState(this.playerCtrl.IdleSt);const t=this.havest();null!=t&&(this.Uninit(),this.next=t)}Uninit(){this.target&&this.targetMsg&&(this.targetMsg.damage=0,this.eventCtrl.OnAttackEvent(this.target,[this.targetMsg]))}havest(){this.player.Meshs.getWorldDirection(this.attackDir),this.raycast.set(this.player.CenterPos,this.attackDir.normalize());const t=this.raycast.intersectObjects(this.playerCtrl.targets);if(!(t.length>0&&t[0].distance<this.attackDist))return this.playerCtrl.IdleSt.Init(),this.playerCtrl.IdleSt;for(let e=0;e<t.length;e++){const i=t[e];if(i.distance>this.attackDist)return;const n=i.object.name;if("farmtree"==n){const t=i.object.ctrl;if(t.PlantType==yR.Tree)return this.playerCtrl.PickFruitTreeSt.Init(),this.playerCtrl.PickFruitTreeSt;if(!t.NeedHavest)return this.playerCtrl.IdleSt.Init(),this.playerCtrl.IdleSt}const s={type:HR.Havest,damage:1,obj:i.object};this.eventCtrl.OnAttackEvent(n,[s]),this.target=n,this.targetMsg=s}}Update(t){const e=this.DefaultCheck();if(null!=e)return this.Uninit(),e;if(this.attackTime+=t,this.attackTime/this.attackSpeed<1)return this;this.attackTime-=this.attackSpeed;const i=this.havest();return null!=i?(this.Uninit(),i):this.next}}class XR extends WI{constructor(t,e,i,n){super(t,e,i),this.eventCtrl=n,this.next=this,this.attackDist=3,this.attackDir=new Le,this.raycast=new ou,this.attackTime=0,this.attackSpeed=2}Init(){this.next=this,this.player.ChangeAction(xb.PickFruitTree),this.playerCtrl.RunSt.PreviousState(this.playerCtrl.IdleSt);const t=this.havest();null!=t&&(this.Uninit(),this.next=t)}Uninit(){this.target&&this.targetMsg&&(this.targetMsg.damage=0,this.eventCtrl.OnAttackEvent(this.target,[this.targetMsg]))}havest(){this.player.Meshs.getWorldDirection(this.attackDir),this.raycast.set(this.player.CenterPos,this.attackDir.normalize());const t=this.raycast.intersectObjects(this.playerCtrl.targets);if(!(t.length>0&&t[0].distance<this.attackDist))return this.playerCtrl.IdleSt.Init(),this.playerCtrl.IdleSt;for(let e=0;e<t.length;e++){const i=t[e];if(i.distance>this.attackDist)return;const n=i.object.name;if("farmtree"==n){const t=i.object.ctrl;if(t.PlantType==yR.Vegetable)return this.playerCtrl.PickFruitSt.Init(),this.playerCtrl.PickFruitSt;if(!t.NeedHavest)return this.playerCtrl.IdleSt.Init(),this.playerCtrl.IdleSt}const s={type:HR.Havest,damage:1,obj:i.object};this.eventCtrl.OnAttackEvent(n,[s]),this.target=n,this.targetMsg=s}}Update(t){const e=this.DefaultCheck();if(null!=e)return this.Uninit(),e;if(this.attackTime+=t,this.attackTime/this.attackSpeed<1)return this;this.attackTime-=this.attackSpeed;const i=this.havest();return null!=i?(this.Uninit(),i):this.next}}class qR extends WI{constructor(t,e,i,n){super(t,e,i),this.eventCtrl=n,this.next=this,this.attackDist=3,this.attackDir=new Le,this.raycast=new ou,this.trigger=!1}Init(){this.player.ChangeAction(xb.PlantAPlant),this.playerCtrl.RunSt.PreviousState(this.playerCtrl.IdleSt),this.trigger=!0}plant(){if(!this.trigger)return;this.trigger=!1,this.player.Meshs.getWorldDirection(this.attackDir),this.raycast.set(this.player.CenterPos,this.attackDir.normalize());const t=this.raycast.intersectObjects(this.playerCtrl.targets);if(!(t.length>0&&t[0].distance<this.attackDist))return this.playerCtrl.IdleSt.Init(),this.playerCtrl.IdleSt;for(let e=0;e<t.length;e++){const i=t[e];if(i.distance>this.attackDist)return;const n=i.object.name;if("furniture"==n)return this.playerCtrl.BuildingSt.Init(),this.playerCtrl.BuildingSt;if("farmtree"==n){const t=i.object.ctrl;if(t.State!=CR.NeedSeed&&t.State!=CR.Seeding)return this.playerCtrl.DeleteSt.InitWithObj(i),this.playerCtrl.DeleteSt}if("deck"==n)return this.playerCtrl.DeckSt.Init(),this.playerCtrl.DeckSt;const s={type:HR.PlantAPlant,damage:1,obj:i.object};this.eventCtrl.OnAttackEvent(n,[s]),this.target=n,this.targetMsg=s}}Uninit(){this.target&&this.targetMsg&&(this.targetMsg.damage=0,this.eventCtrl.OnAttackEvent(this.target,[this.targetMsg]))}Update(){const t=this.DefaultCheck();if(null!=t)return this.Uninit(),t;const e=this.plant();return null!=e?(this.Uninit(),e):this.next}}class YR extends WI{constructor(t,e,i,n,s){super(t,e,i),this.invenFab=n,this.eventCtrl=s,this.attackDist=3,this.attackDir=new Le,this.raycast=new ou,this.trigger=!1}Init(){return jR(this,void 0,void 0,(function*(){this.player.ChangeAction(xb.Watering),this.playerCtrl.RunSt.PreviousState(this.playerCtrl.IdleSt);const t=this.player.Asset.GetBodyMeshId(Tu.Hands_R);if(null==t)return;const e=this.player.Meshs.getObjectByName(t);if(!e)return;const i=yield this.invenFab.GetNewItem(mR.WarterCan);if(i&&null!=i.Mesh){const t=e.getObjectById(i.Mesh.id);t?t.visible=!0:e.add(i.Mesh)}this.warteringCan=i,this.trigger=!0}))}Uninit(){this.warteringCan&&this.warteringCan.Mesh&&(this.warteringCan.Mesh.visible=!1),this.target&&this.targetMsg&&(this.targetMsg.damage=0,this.eventCtrl.OnAttackEvent(this.target,[this.targetMsg]))}wartering(){if(!this.trigger)return;this.trigger=!1,this.player.Meshs.getWorldDirection(this.attackDir),this.raycast.set(this.player.CenterPos,this.attackDir.normalize());const t=this.raycast.intersectObjects(this.playerCtrl.targets);if(!(t.length>0&&t[0].distance<this.attackDist))return this.playerCtrl.IdleSt.Init(),this.playerCtrl.IdleSt;t.forEach((t=>{if(t.distance>this.attackDist)return!1;const e=t.object.name,i={type:HR.Wartering,damage:1,obj:t.object};this.eventCtrl.OnAttackEvent(e,[i]),this.target=e,this.targetMsg=i}))}Update(){const t=this.DefaultCheck();if(null!=t)return this.Uninit(),t;const e=this.wartering();return null!=e?(this.Uninit(),e):this}}class JR extends WI{constructor(t,e,i,n){super(t,e,i),this.eventCtrl=n,this.next=this,this.attackDist=3,this.attackDir=new Le,this.raycast=new ou,this.attackTime=0,this.attackSpeed=2}InitWithObj(t){const e=t.object.name,i={type:HR.Delete,damage:1,obj:t.object};this.eventCtrl.OnAttackEvent(e,[i]),this.target=e,this.targetMsg=i,this.Init()}Init(){this.player.ChangeAction(xb.Hammering,this.attackSpeed),this.playerCtrl.RunSt.PreviousState(this.playerCtrl.IdleSt)}delete(){this.player.Meshs.getWorldDirection(this.attackDir),this.raycast.set(this.player.CenterPos,this.attackDir.normalize());const t=this.raycast.intersectObjects(this.playerCtrl.targets);if(!(t.length>0&&t[0].distance<this.attackDist))return this.Uninit(),this.playerCtrl.IdleSt.Init(),this.playerCtrl.IdleSt;for(let e=0;e<t.length;e++){const i=t[e];if(i.distance>this.attackDist)return;const n=i.object.name,s={type:HR.Delete,damage:1,obj:i.object};this.eventCtrl.OnAttackEvent(n,[s]),this.target=n,this.targetMsg=s}return this}Uninit(){this.target&&this.targetMsg&&(this.targetMsg.damage=0,this.eventCtrl.OnAttackEvent(this.target,[this.targetMsg]))}Update(t){const e=this.DefaultCheck();return null!=e?(this.Uninit(),e):(this.attackTime+=t,this.attackTime/this.attackSpeed<1||(this.attackTime-=this.attackSpeed,this.delete()),this)}}class $R extends WI{constructor(t,e,i,n,s){super(t,e,i),this.invenFab=n,this.eventCtrl=s,this.attackDist=3,this.attackDir=new Le,this.raycast=new ou,this.trigger=!1}Init(){return jR(this,void 0,void 0,(function*(){this.player.ChangeAction(xb.Building),this.playerCtrl.RunSt.PreviousState(this.playerCtrl.IdleSt);const t=this.player.Asset.GetBodyMeshId(Tu.Hands_R);if(null==t)return;const e=this.player.Meshs.getObjectByName(t);if(!e)return;const i=yield this.invenFab.GetNewItem(mR.Hammer);if(i&&null!=i.Mesh){const t=e.getObjectById(i.Mesh.id);t?t.visible=!0:e.add(i.Mesh)}this.hammer=i,this.trigger=!0}))}Uninit(){this.hammer&&this.hammer.Mesh&&(this.hammer.Mesh.visible=!1),this.target&&this.targetMsg&&(this.targetMsg.damage=0,this.eventCtrl.OnAttackEvent(this.target,[this.targetMsg]))}building(){if(!this.trigger)return;this.trigger=!1,this.player.Meshs.getWorldDirection(this.attackDir),this.raycast.set(this.player.CenterPos,this.attackDir.normalize());const t=this.raycast.intersectObjects(this.playerCtrl.targets);if(!(t.length>0&&t[0].distance<this.attackDist))return this.Uninit(),this.playerCtrl.IdleSt.Init(),this.playerCtrl.IdleSt;for(let e=0;e<t.length;e++){const i=t[e];if(i.distance>this.attackDist)break;const n=i.object.name;if(i.object.ctrl.State==UR.Done)return this.playerCtrl.DeleteSt.InitWithObj(i),this.playerCtrl.DeleteSt;const s={type:HR.Building,damage:1,obj:i.object};this.eventCtrl.OnAttackEvent(n,[s]),this.target=n,this.targetMsg=s}}Update(){const t=this.DefaultCheck();if(null!=t)return this.Uninit(),t;const e=this.building();return null!=e?(this.Uninit(),e):this}}class KR extends WI{constructor(t,e,i,n){super(t,e,i),this.eventCtrl=n,this.next=this,this.attackDist=3,this.attackDir=new Le,this.raycast=new ou}Init(){this.player.ChangeAction(xb.MagicH1),this.playerCtrl.RunSt.PreviousState(this.playerCtrl.IdleSt)}deckBuilding(){this.player.Meshs.getWorldDirection(this.attackDir),this.raycast.set(this.player.CenterPos,this.attackDir.normalize());const t=this.raycast.intersectObjects(this.playerCtrl.targets);if(!(t.length>0&&t[0].distance<this.attackDist))return this.playerCtrl.IdleSt.Init(),this.playerCtrl.IdleSt;for(let e=0;e<t.length;e++){const i=t[e];if(i.distance>this.attackDist)return;const n=i.object.name,s={type:HR.Delete,damage:1,obj:i.object};this.eventCtrl.OnAttackEvent(n,[s])}}Uninit(){}Update(){const t=this.DefaultCheck();if(null!=t)return this.Uninit(),t;const e=this.deckBuilding();return null!=e?(this.Uninit(),e):this.next}}!function(t){t[t.NormalSwing=0]="NormalSwing",t[t.Magic0=1]="Magic0",t[t.Exp=2]="Exp",t[t.Heal=3]="Heal",t[t.AOE=4]="AOE",t[t.Buff=5]="Buff",t[t.PlantAPlant=6]="PlantAPlant",t[t.Wartering=7]="Wartering",t[t.Havest=8]="Havest",t[t.Building=9]="Building",t[t.Delete=10]="Delete"}(HR||(HR={}));class ZR{get Health(){return this.spec.Health}set Enable(t){this.playEnable=t,this.currentState.Uninit(),this.currentState=this.IdleSt,this.currentState.Init()}constructor(t,e,i,n,s){this.player=t,this.inventory=e,this.invenFab=i,this.gphysic=n,this.eventCtrl=s,this.mode=DP.Play,this.keyDownQueue=[],this.keyUpQueue=[],this.inputVQueue=[],this.targets=[],this.contollerEnable=!0,this.inputMode=!1,this.moveDirection=new Le,this.playEnable=!1,this.spec=new lR(this.inventory),this.keyType=Ou.None,this.AttackSt=new aR(this,this.player,this.gphysic,this.eventCtrl,this.spec),this.MagicH1St=new qI(this,this.player,this.gphysic),this.MagicH2St=new XI(this,this.player,this.gphysic),this.AttackIdleSt=new oR(this,this.player,this.gphysic),this.RunSt=new $I(this,this.player,this.gphysic),this.JumpSt=new KI(this,this.player,this.gphysic),this.IdleSt=new JI(this,this.player,this.gphysic),this.DyingSt=new YI(this,this.player,this.gphysic),this.PickFruitSt=new WR(this,this.player,this.gphysic,this.eventCtrl),this.PickFruitTreeSt=new XR(this,this.player,this.gphysic,this.eventCtrl),this.PlantASt=new qR(this,this.player,this.gphysic,this.eventCtrl),this.DeckSt=new KR(this,this.player,this.gphysic,this.eventCtrl),this.WarteringSt=new YR(this,this.player,this.gphysic,this.invenFab,this.eventCtrl),this.BuildingSt=new $R(this,this.player,this.gphysic,this.invenFab,this.eventCtrl),this.DeleteSt=new JR(this,this.player,this.gphysic,this.eventCtrl),this.currentState=this.IdleSt,this.KeyState=new Array(Ou.Count),this.none=new Bu,n.Register(this),s.RegisterAppModeEvent(((e,i)=>{if(this.mode=e,e==DP.EditPlay||e==DP.Weapon)switch(i){case Lu.Start:for(this.playEnable=!0;this.gphysic.Check(t);)t.CannonPos.y+=.2;this.currentState=this.IdleSt,this.currentState.Init();break;case Lu.End:this.playEnable=!1,this.currentState.Uninit()}if(e==DP.Play)switch(i){case Lu.Start:this.playEnable=!0,this.spec.ResetStatus(),s.OnChangePlayerStatusEvent(this.spec.Status),this.currentState=this.IdleSt,this.currentState.Init();break;case Lu.End:this.playEnable=!1,this.currentState.Uninit()}})),s.RegisterKeyDownEvent((t=>{this.contollerEnable&&this.playEnable&&this.keyDownQueue.push(t)})),s.RegisterKeyUpEvent((t=>{this.contollerEnable&&this.playEnable&&this.keyUpQueue.push(t)})),s.RegisterInputEvent(((t,e)=>{this.contollerEnable&&this.playEnable&&("move"==t.type?(this.inputVQueue.push((new Le).copy(e)),this.inputMode=!0):(this.inputMode=!1,this.reset()))})),s.RegisterChangeEquipmentEvent((()=>{this.spec.ItemUpdate(),this.currentState==this.AttackSt&&this.currentState.Init()})),s.RegisterAttackEvent("player",(t=>{this.currentState!=this.DyingSt&&this.spec.CheckDie()&&(this.currentState=this.DyingSt,this.currentState.Init()),this.playEnable&&(t.forEach((t=>{switch(t.type){case HR.NormalSwing:case HR.Magic0:this.spec.ReceiveCalcDamage(t.damage),this.player.DamageEffect(t.damage);break;case HR.Exp:this.spec.ReceiveExp(t.damage);break;case HR.Heal:this.player.HealEffect(t.damage),this.spec.ReceiveCalcHeal(t.damage)}})),s.OnChangePlayerStatusEvent(this.spec.Status))}))}add(...t){this.targets.push(...t)}remove(t){const e=this.targets.indexOf(t);e<0||this.targets.splice(e,1)}updateInputVector(){const t=this.inputVQueue.shift();null!=t&&(this.moveDirection.x=t.x,this.moveDirection.z=t.z)}reset(){this.moveDirection.x=0,this.moveDirection.z=0,this.inputVQueue.length=0}update(t){this.updateInputVector(),this.updateDownKey(),this.updateUpKey(),this.player.Visible&&(this.currentState=this.currentState.Update(t,this.moveDirection),this.player.Update(),this.spec.Update(t),this.actionReset())}actionReset(){for(let t=Ou.Action0;t<Ou.Count;t++)this.KeyState[t]=!1}updateDownKey(){let t=this.keyDownQueue.shift();if(null==t)return this.keyType=Ou.None,void(t=this.none);this.KeyState[t.Type]=!0,this.keyType=t.Type;const e=t.ExecuteKeyDown();0!=e.x&&(this.moveDirection.x=e.x),0!=e.y&&(this.moveDirection.y=e.y),0!=e.z&&(this.moveDirection.z=e.z)}updateUpKey(){let t=this.keyUpQueue.shift();if(null==t)return this.keyType=Ou.None,void(t=this.none);this.KeyState[t.Type]=!1,this.keyType=t.Type;const e=t.ExecuteKeyUp();e.x==this.moveDirection.x&&(this.moveDirection.x=0),e.y==this.moveDirection.y&&(this.moveDirection.y=0),e.z==this.moveDirection.z&&(this.moveDirection.z=0)}UpdateBuff(t){this.spec.SetBuff(t)}}class QR{constructor(t,e,i,n,s="div"){this.parent=t,this.object=e,this.property=i,this._disabled=!1,this._hidden=!1,this.initialValue=this.getValue(),this.domElement=document.createElement(s),this.domElement.classList.add("controller"),this.domElement.classList.add(n),this.$name=document.createElement("div"),this.$name.classList.add("name"),QR.nextNameID=QR.nextNameID||0,this.$name.id="lil-gui-name-"+ ++QR.nextNameID,this.$widget=document.createElement("div"),this.$widget.classList.add("widget"),this.$disable=this.$widget,this.domElement.appendChild(this.$name),this.domElement.appendChild(this.$widget),this.domElement.addEventListener("keydown",(t=>t.stopPropagation())),this.domElement.addEventListener("keyup",(t=>t.stopPropagation())),this.parent.children.push(this),this.parent.controllers.push(this),this.parent.$children.appendChild(this.domElement),this._listenCallback=this._listenCallback.bind(this),this.name(i)}name(t){return this._name=t,this.$name.innerHTML=t,this}onChange(t){return this._onChange=t,this}_callOnChange(){this.parent._callOnChange(this),void 0!==this._onChange&&this._onChange.call(this,this.getValue()),this._changed=!0}onFinishChange(t){return this._onFinishChange=t,this}_callOnFinishChange(){this._changed&&(this.parent._callOnFinishChange(this),void 0!==this._onFinishChange&&this._onFinishChange.call(this,this.getValue())),this._changed=!1}reset(){return this.setValue(this.initialValue),this._callOnFinishChange(),this}enable(t=!0){return this.disable(!t)}disable(t=!0){return t===this._disabled||(this._disabled=t,this.domElement.classList.toggle("disabled",t),this.$disable.toggleAttribute("disabled",t)),this}show(t=!0){return this._hidden=!t,this.domElement.style.display=this._hidden?"none":"",this}hide(){return this.show(!1)}options(t){const e=this.parent.add(this.object,this.property,t);return e.name(this._name),this.destroy(),e}min(t){return this}max(t){return this}step(t){return this}decimals(t){return this}listen(t=!0){return this._listening=t,void 0!==this._listenCallbackID&&(cancelAnimationFrame(this._listenCallbackID),this._listenCallbackID=void 0),this._listening&&this._listenCallback(),this}_listenCallback(){this._listenCallbackID=requestAnimationFrame(this._listenCallback);const t=this.save();t!==this._listenPrevValue&&this.updateDisplay(),this._listenPrevValue=t}getValue(){return this.object[this.property]}setValue(t){return this.object[this.property]=t,this._callOnChange(),this.updateDisplay(),this}updateDisplay(){return this}load(t){return this.setValue(t),this._callOnFinishChange(),this}save(){return this.getValue()}destroy(){this.listen(!1),this.parent.children.splice(this.parent.children.indexOf(this),1),this.parent.controllers.splice(this.parent.controllers.indexOf(this),1),this.parent.$children.removeChild(this.domElement)}}class tk extends QR{constructor(t,e,i){super(t,e,i,"boolean","label"),this.$input=document.createElement("input"),this.$input.setAttribute("type","checkbox"),this.$input.setAttribute("aria-labelledby",this.$name.id),this.$widget.appendChild(this.$input),this.$input.addEventListener("change",(()=>{this.setValue(this.$input.checked),this._callOnFinishChange()})),this.$disable=this.$input,this.updateDisplay()}updateDisplay(){return this.$input.checked=this.getValue(),this}}function ek(t){let e,i;return(e=t.match(/(#|0x)?([a-f0-9]{6})/i))?i=e[2]:(e=t.match(/rgb\(\s*(\d*)\s*,\s*(\d*)\s*,\s*(\d*)\s*\)/))?i=parseInt(e[1]).toString(16).padStart(2,0)+parseInt(e[2]).toString(16).padStart(2,0)+parseInt(e[3]).toString(16).padStart(2,0):(e=t.match(/^#?([a-f0-9])([a-f0-9])([a-f0-9])$/i))&&(i=e[1]+e[1]+e[2]+e[2]+e[3]+e[3]),!!i&&"#"+i}const ik={isPrimitive:!0,match:t=>"number"==typeof t,fromHexString:t=>parseInt(t.substring(1),16),toHexString:t=>"#"+t.toString(16).padStart(6,0)},nk={isPrimitive:!1,match:t=>Array.isArray(t),fromHexString(t,e,i=1){const n=ik.fromHexString(t);e[0]=(n>>16&255)/255*i,e[1]=(n>>8&255)/255*i,e[2]=(255&n)/255*i},toHexString:([t,e,i],n=1)=>ik.toHexString(t*(n=255/n)<<16^e*n<<8^i*n<<0)},sk={isPrimitive:!1,match:t=>Object(t)===t,fromHexString(t,e,i=1){const n=ik.fromHexString(t);e.r=(n>>16&255)/255*i,e.g=(n>>8&255)/255*i,e.b=(255&n)/255*i},toHexString:({r:t,g:e,b:i},n=1)=>ik.toHexString(t*(n=255/n)<<16^e*n<<8^i*n<<0)},rk=[{isPrimitive:!0,match:t=>"string"==typeof t,fromHexString:ek,toHexString:ek},ik,nk,sk];class ak extends QR{constructor(t,e,i,n){var s;super(t,e,i,"color"),this.$input=document.createElement("input"),this.$input.setAttribute("type","color"),this.$input.setAttribute("tabindex",-1),this.$input.setAttribute("aria-labelledby",this.$name.id),this.$text=document.createElement("input"),this.$text.setAttribute("type","text"),this.$text.setAttribute("spellcheck","false"),this.$text.setAttribute("aria-labelledby",this.$name.id),this.$display=document.createElement("div"),this.$display.classList.add("display"),this.$display.appendChild(this.$input),this.$widget.appendChild(this.$display),this.$widget.appendChild(this.$text),this._format=(s=this.initialValue,rk.find((t=>t.match(s)))),this._rgbScale=n,this._initialValueHexString=this.save(),this._textFocused=!1,this.$input.addEventListener("input",(()=>{this._setValueFromHexString(this.$input.value)})),this.$input.addEventListener("blur",(()=>{this._callOnFinishChange()})),this.$text.addEventListener("input",(()=>{const t=ek(this.$text.value);t&&this._setValueFromHexString(t)})),this.$text.addEventListener("focus",(()=>{this._textFocused=!0,this.$text.select()})),this.$text.addEventListener("blur",(()=>{this._textFocused=!1,this.updateDisplay(),this._callOnFinishChange()})),this.$disable=this.$text,this.updateDisplay()}reset(){return this._setValueFromHexString(this._initialValueHexString),this}_setValueFromHexString(t){if(this._format.isPrimitive){const e=this._format.fromHexString(t);this.setValue(e)}else this._format.fromHexString(t,this.getValue(),this._rgbScale),this._callOnChange(),this.updateDisplay()}save(){return this._format.toHexString(this.getValue(),this._rgbScale)}load(t){return this._setValueFromHexString(t),this._callOnFinishChange(),this}updateDisplay(){return this.$input.value=this._format.toHexString(this.getValue(),this._rgbScale),this._textFocused||(this.$text.value=this.$input.value.substring(1)),this.$display.style.backgroundColor=this.$input.value,this}}class ok extends QR{constructor(t,e,i){super(t,e,i,"function"),this.$button=document.createElement("button"),this.$button.appendChild(this.$name),this.$widget.appendChild(this.$button),this.$button.addEventListener("click",(t=>{t.preventDefault(),this.getValue().call(this.object),this._callOnChange()})),this.$button.addEventListener("touchstart",(()=>{}),{passive:!0}),this.$disable=this.$button}}class hk extends QR{constructor(t,e,i,n,s,r){super(t,e,i,"number"),this._initInput(),this.min(n),this.max(s);const a=void 0!==r;this.step(a?r:this._getImplicitStep(),a),this.updateDisplay()}decimals(t){return this._decimals=t,this.updateDisplay(),this}min(t){return this._min=t,this._onUpdateMinMax(),this}max(t){return this._max=t,this._onUpdateMinMax(),this}step(t,e=!0){return this._step=t,this._stepExplicit=e,this}updateDisplay(){const t=this.getValue();if(this._hasSlider){let e=(t-this._min)/(this._max-this._min);e=Math.max(0,Math.min(e,1)),this.$fill.style.width=100*e+"%"}return this._inputFocused||(this.$input.value=void 0===this._decimals?t:t.toFixed(this._decimals)),this}_initInput(){this.$input=document.createElement("input"),this.$input.setAttribute("type","text"),this.$input.setAttribute("aria-labelledby",this.$name.id);window.matchMedia("(pointer: coarse)").matches&&(this.$input.setAttribute("type","number"),this.$input.setAttribute("step","any")),this.$widget.appendChild(this.$input),this.$disable=this.$input;const t=t=>{const e=parseFloat(this.$input.value);isNaN(e)||(this._snapClampSetValue(e+t),this.$input.value=this.getValue())};let e,i,n,s,r,a=!1;const o=t=>{if(a){const n=t.clientX-e,s=t.clientY-i;Math.abs(s)>5?(t.preventDefault(),this.$input.blur(),a=!1,this._setDraggingStyle(!0,"vertical")):Math.abs(n)>5&&h()}if(!a){const e=t.clientY-n;r-=e*this._step*this._arrowKeyMultiplier(t),s+r>this._max?r=this._max-s:s+r<this._min&&(r=this._min-s),this._snapClampSetValue(s+r)}n=t.clientY},h=()=>{this._setDraggingStyle(!1,"vertical"),this._callOnFinishChange(),window.removeEventListener("mousemove",o),window.removeEventListener("mouseup",h)};this.$input.addEventListener("input",(()=>{let t=parseFloat(this.$input.value);isNaN(t)||(this._stepExplicit&&(t=this._snap(t)),this.setValue(this._clamp(t)))})),this.$input.addEventListener("keydown",(e=>{"Enter"===e.key&&this.$input.blur(),"ArrowUp"===e.code&&(e.preventDefault(),t(this._step*this._arrowKeyMultiplier(e))),"ArrowDown"===e.code&&(e.preventDefault(),t(this._step*this._arrowKeyMultiplier(e)*-1))})),this.$input.addEventListener("wheel",(e=>{this._inputFocused&&(e.preventDefault(),t(this._step*this._normalizeMouseWheel(e)))}),{passive:!1}),this.$input.addEventListener("mousedown",(t=>{e=t.clientX,i=n=t.clientY,a=!0,s=this.getValue(),r=0,window.addEventListener("mousemove",o),window.addEventListener("mouseup",h)})),this.$input.addEventListener("focus",(()=>{this._inputFocused=!0})),this.$input.addEventListener("blur",(()=>{this._inputFocused=!1,this.updateDisplay(),this._callOnFinishChange()}))}_initSlider(){this._hasSlider=!0,this.$slider=document.createElement("div"),this.$slider.classList.add("slider"),this.$fill=document.createElement("div"),this.$fill.classList.add("fill"),this.$slider.appendChild(this.$fill),this.$widget.insertBefore(this.$slider,this.$input),this.domElement.classList.add("hasSlider");const t=t=>{const e=this.$slider.getBoundingClientRect();let i=((t,e,i,n,s)=>(t-e)/(i-e)*(s-n)+n)(t,e.left,e.right,this._min,this._max);this._snapClampSetValue(i)},e=e=>{t(e.clientX)},i=()=>{this._callOnFinishChange(),this._setDraggingStyle(!1),window.removeEventListener("mousemove",e),window.removeEventListener("mouseup",i)};let n,s,r=!1;const a=e=>{e.preventDefault(),this._setDraggingStyle(!0),t(e.touches[0].clientX),r=!1},o=e=>{if(r){const t=e.touches[0].clientX-n,i=e.touches[0].clientY-s;Math.abs(t)>Math.abs(i)?a(e):(window.removeEventListener("touchmove",o),window.removeEventListener("touchend",h))}else e.preventDefault(),t(e.touches[0].clientX)},h=()=>{this._callOnFinishChange(),this._setDraggingStyle(!1),window.removeEventListener("touchmove",o),window.removeEventListener("touchend",h)},l=this._callOnFinishChange.bind(this);let c;this.$slider.addEventListener("mousedown",(n=>{this._setDraggingStyle(!0),t(n.clientX),window.addEventListener("mousemove",e),window.addEventListener("mouseup",i)})),this.$slider.addEventListener("touchstart",(t=>{t.touches.length>1||(this._hasScrollBar?(n=t.touches[0].clientX,s=t.touches[0].clientY,r=!0):a(t),window.addEventListener("touchmove",o,{passive:!1}),window.addEventListener("touchend",h))}),{passive:!1}),this.$slider.addEventListener("wheel",(t=>{if(Math.abs(t.deltaX)<Math.abs(t.deltaY)&&this._hasScrollBar)return;t.preventDefault();const e=this._normalizeMouseWheel(t)*this._step;this._snapClampSetValue(this.getValue()+e),this.$input.value=this.getValue(),clearTimeout(c),c=setTimeout(l,400)}),{passive:!1})}_setDraggingStyle(t,e="horizontal"){this.$slider&&this.$slider.classList.toggle("active",t),document.body.classList.toggle("lil-gui-dragging",t),document.body.classList.toggle(`lil-gui-${e}`,t)}_getImplicitStep(){return this._hasMin&&this._hasMax?(this._max-this._min)/1e3:.1}_onUpdateMinMax(){!this._hasSlider&&this._hasMin&&this._hasMax&&(this._stepExplicit||this.step(this._getImplicitStep(),!1),this._initSlider(),this.updateDisplay())}_normalizeMouseWheel(t){let{deltaX:e,deltaY:i}=t;Math.floor(t.deltaY)!==t.deltaY&&t.wheelDelta&&(e=0,i=-t.wheelDelta/120,i*=this._stepExplicit?1:10);return e+-i}_arrowKeyMultiplier(t){let e=this._stepExplicit?1:10;return t.shiftKey?e*=10:t.altKey&&(e/=10),e}_snap(t){const e=Math.round(t/this._step)*this._step;return parseFloat(e.toPrecision(15))}_clamp(t){return t<this._min&&(t=this._min),t>this._max&&(t=this._max),t}_snapClampSetValue(t){this.setValue(this._clamp(this._snap(t)))}get _hasScrollBar(){const t=this.parent.root.$children;return t.scrollHeight>t.clientHeight}get _hasMin(){return void 0!==this._min}get _hasMax(){return void 0!==this._max}}class lk extends QR{constructor(t,e,i,n){super(t,e,i,"option"),this.$select=document.createElement("select"),this.$select.setAttribute("aria-labelledby",this.$name.id),this.$display=document.createElement("div"),this.$display.classList.add("display"),this.$select.addEventListener("change",(()=>{this.setValue(this._values[this.$select.selectedIndex]),this._callOnFinishChange()})),this.$select.addEventListener("focus",(()=>{this.$display.classList.add("focus")})),this.$select.addEventListener("blur",(()=>{this.$display.classList.remove("focus")})),this.$widget.appendChild(this.$select),this.$widget.appendChild(this.$display),this.$disable=this.$select,this.options(n)}options(t){return this._values=Array.isArray(t)?t:Object.values(t),this._names=Array.isArray(t)?t:Object.keys(t),this.$select.replaceChildren(),this._names.forEach((t=>{const e=document.createElement("option");e.innerHTML=t,this.$select.appendChild(e)})),this.updateDisplay(),this}updateDisplay(){const t=this.getValue(),e=this._values.indexOf(t);return this.$select.selectedIndex=e,this.$display.innerHTML=-1===e?t:this._names[e],this}}class ck extends QR{constructor(t,e,i){super(t,e,i,"string"),this.$input=document.createElement("input"),this.$input.setAttribute("type","text"),this.$input.setAttribute("aria-labelledby",this.$name.id),this.$input.addEventListener("input",(()=>{this.setValue(this.$input.value)})),this.$input.addEventListener("keydown",(t=>{"Enter"===t.code&&this.$input.blur()})),this.$input.addEventListener("blur",(()=>{this._callOnFinishChange()})),this.$widget.appendChild(this.$input),this.$disable=this.$input,this.updateDisplay()}updateDisplay(){return this.$input.value=this.getValue(),this}}let uk=!1;class dk{constructor({parent:t,autoPlace:e=void 0===t,container:i,width:n,title:s="Controls",closeFolders:r=!1,injectStyles:a=!0,touchStyles:o=!0}={}){if(this.parent=t,this.root=t?t.root:this,this.children=[],this.controllers=[],this.folders=[],this._closed=!1,this._hidden=!1,this.domElement=document.createElement("div"),this.domElement.classList.add("lil-gui"),this.$title=document.createElement("div"),this.$title.classList.add("title"),this.$title.setAttribute("role","button"),this.$title.setAttribute("aria-expanded",!0),this.$title.setAttribute("tabindex",0),this.$title.addEventListener("click",(()=>this.openAnimated(this._closed))),this.$title.addEventListener("keydown",(t=>{"Enter"!==t.code&&"Space"!==t.code||(t.preventDefault(),this.$title.click())})),this.$title.addEventListener("touchstart",(()=>{}),{passive:!0}),this.$children=document.createElement("div"),this.$children.classList.add("children"),this.domElement.appendChild(this.$title),this.domElement.appendChild(this.$children),this.title(s),this.parent)return this.parent.children.push(this),this.parent.folders.push(this),void this.parent.$children.appendChild(this.domElement);this.domElement.classList.add("root"),o&&this.domElement.classList.add("allow-touch-styles"),!uk&&a&&(!function(t){const e=document.createElement("style");e.innerHTML=t;const i=document.querySelector("head link[rel=stylesheet], head style");i?document.head.insertBefore(e,i):document.head.appendChild(e)}('.lil-gui {\n  font-family: var(--font-family);\n  font-size: var(--font-size);\n  line-height: 1;\n  font-weight: normal;\n  font-style: normal;\n  text-align: left;\n  color: var(--text-color);\n  user-select: none;\n  -webkit-user-select: none;\n  touch-action: manipulation;\n  --background-color: #1f1f1f;\n  --text-color: #ebebeb;\n  --title-background-color: #111111;\n  --title-text-color: #ebebeb;\n  --widget-color: #424242;\n  --hover-color: #4f4f4f;\n  --focus-color: #595959;\n  --number-color: #2cc9ff;\n  --string-color: #a2db3c;\n  --font-size: 11px;\n  --input-font-size: 11px;\n  --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;\n  --font-family-mono: Menlo, Monaco, Consolas, "Droid Sans Mono", monospace;\n  --padding: 4px;\n  --spacing: 4px;\n  --widget-height: 20px;\n  --title-height: calc(var(--widget-height) + var(--spacing) * 1.25);\n  --name-width: 45%;\n  --slider-knob-width: 2px;\n  --slider-input-width: 27%;\n  --color-input-width: 27%;\n  --slider-input-min-width: 45px;\n  --color-input-min-width: 45px;\n  --folder-indent: 7px;\n  --widget-padding: 0 0 0 3px;\n  --widget-border-radius: 2px;\n  --checkbox-size: calc(0.75 * var(--widget-height));\n  --scrollbar-width: 5px;\n}\n.lil-gui, .lil-gui * {\n  box-sizing: border-box;\n  margin: 0;\n  padding: 0;\n}\n.lil-gui.root {\n  width: var(--width, 245px);\n  display: flex;\n  flex-direction: column;\n  background: var(--background-color);\n}\n.lil-gui.root > .title {\n  background: var(--title-background-color);\n  color: var(--title-text-color);\n}\n.lil-gui.root > .children {\n  overflow-x: hidden;\n  overflow-y: auto;\n}\n.lil-gui.root > .children::-webkit-scrollbar {\n  width: var(--scrollbar-width);\n  height: var(--scrollbar-width);\n  background: var(--background-color);\n}\n.lil-gui.root > .children::-webkit-scrollbar-thumb {\n  border-radius: var(--scrollbar-width);\n  background: var(--focus-color);\n}\n@media (pointer: coarse) {\n  .lil-gui.allow-touch-styles, .lil-gui.allow-touch-styles .lil-gui {\n    --widget-height: 28px;\n    --padding: 6px;\n    --spacing: 6px;\n    --font-size: 13px;\n    --input-font-size: 16px;\n    --folder-indent: 10px;\n    --scrollbar-width: 7px;\n    --slider-input-min-width: 50px;\n    --color-input-min-width: 65px;\n  }\n}\n.lil-gui.force-touch-styles, .lil-gui.force-touch-styles .lil-gui {\n  --widget-height: 28px;\n  --padding: 6px;\n  --spacing: 6px;\n  --font-size: 13px;\n  --input-font-size: 16px;\n  --folder-indent: 10px;\n  --scrollbar-width: 7px;\n  --slider-input-min-width: 50px;\n  --color-input-min-width: 65px;\n}\n.lil-gui.autoPlace {\n  max-height: 100%;\n  position: fixed;\n  top: 0;\n  right: 15px;\n  z-index: 1001;\n}\n\n.lil-gui .controller {\n  display: flex;\n  align-items: center;\n  padding: 0 var(--padding);\n  margin: var(--spacing) 0;\n}\n.lil-gui .controller.disabled {\n  opacity: 0.5;\n}\n.lil-gui .controller.disabled, .lil-gui .controller.disabled * {\n  pointer-events: none !important;\n}\n.lil-gui .controller > .name {\n  min-width: var(--name-width);\n  flex-shrink: 0;\n  white-space: pre;\n  padding-right: var(--spacing);\n  line-height: var(--widget-height);\n}\n.lil-gui .controller .widget {\n  position: relative;\n  display: flex;\n  align-items: center;\n  width: 100%;\n  min-height: var(--widget-height);\n}\n.lil-gui .controller.string input {\n  color: var(--string-color);\n}\n.lil-gui .controller.boolean {\n  cursor: pointer;\n}\n.lil-gui .controller.color .display {\n  width: 100%;\n  height: var(--widget-height);\n  border-radius: var(--widget-border-radius);\n  position: relative;\n}\n@media (hover: hover) {\n  .lil-gui .controller.color .display:hover:before {\n    content: " ";\n    display: block;\n    position: absolute;\n    border-radius: var(--widget-border-radius);\n    border: 1px solid #fff9;\n    top: 0;\n    right: 0;\n    bottom: 0;\n    left: 0;\n  }\n}\n.lil-gui .controller.color input[type=color] {\n  opacity: 0;\n  width: 100%;\n  height: 100%;\n  cursor: pointer;\n}\n.lil-gui .controller.color input[type=text] {\n  margin-left: var(--spacing);\n  font-family: var(--font-family-mono);\n  min-width: var(--color-input-min-width);\n  width: var(--color-input-width);\n  flex-shrink: 0;\n}\n.lil-gui .controller.option select {\n  opacity: 0;\n  position: absolute;\n  width: 100%;\n  max-width: 100%;\n}\n.lil-gui .controller.option .display {\n  position: relative;\n  pointer-events: none;\n  border-radius: var(--widget-border-radius);\n  height: var(--widget-height);\n  line-height: var(--widget-height);\n  max-width: 100%;\n  overflow: hidden;\n  word-break: break-all;\n  padding-left: 0.55em;\n  padding-right: 1.75em;\n  background: var(--widget-color);\n}\n@media (hover: hover) {\n  .lil-gui .controller.option .display.focus {\n    background: var(--focus-color);\n  }\n}\n.lil-gui .controller.option .display.active {\n  background: var(--focus-color);\n}\n.lil-gui .controller.option .display:after {\n  font-family: "lil-gui";\n  content: "";\n  position: absolute;\n  top: 0;\n  right: 0;\n  bottom: 0;\n  padding-right: 0.375em;\n}\n.lil-gui .controller.option .widget,\n.lil-gui .controller.option select {\n  cursor: pointer;\n}\n@media (hover: hover) {\n  .lil-gui .controller.option .widget:hover .display {\n    background: var(--hover-color);\n  }\n}\n.lil-gui .controller.number input {\n  color: var(--number-color);\n}\n.lil-gui .controller.number.hasSlider input {\n  margin-left: var(--spacing);\n  width: var(--slider-input-width);\n  min-width: var(--slider-input-min-width);\n  flex-shrink: 0;\n}\n.lil-gui .controller.number .slider {\n  width: 100%;\n  height: var(--widget-height);\n  background: var(--widget-color);\n  border-radius: var(--widget-border-radius);\n  padding-right: var(--slider-knob-width);\n  overflow: hidden;\n  cursor: ew-resize;\n  touch-action: pan-y;\n}\n@media (hover: hover) {\n  .lil-gui .controller.number .slider:hover {\n    background: var(--hover-color);\n  }\n}\n.lil-gui .controller.number .slider.active {\n  background: var(--focus-color);\n}\n.lil-gui .controller.number .slider.active .fill {\n  opacity: 0.95;\n}\n.lil-gui .controller.number .fill {\n  height: 100%;\n  border-right: var(--slider-knob-width) solid var(--number-color);\n  box-sizing: content-box;\n}\n\n.lil-gui-dragging .lil-gui {\n  --hover-color: var(--widget-color);\n}\n.lil-gui-dragging * {\n  cursor: ew-resize !important;\n}\n\n.lil-gui-dragging.lil-gui-vertical * {\n  cursor: ns-resize !important;\n}\n\n.lil-gui .title {\n  height: var(--title-height);\n  line-height: calc(var(--title-height) - 4px);\n  font-weight: 600;\n  padding: 0 var(--padding);\n  -webkit-tap-highlight-color: transparent;\n  cursor: pointer;\n  outline: none;\n  text-decoration-skip: objects;\n}\n.lil-gui .title:before {\n  font-family: "lil-gui";\n  content: "";\n  padding-right: 2px;\n  display: inline-block;\n}\n.lil-gui .title:active {\n  background: var(--title-background-color);\n  opacity: 0.75;\n}\n@media (hover: hover) {\n  body:not(.lil-gui-dragging) .lil-gui .title:hover {\n    background: var(--title-background-color);\n    opacity: 0.85;\n  }\n  .lil-gui .title:focus {\n    text-decoration: underline var(--focus-color);\n  }\n}\n.lil-gui.root > .title:focus {\n  text-decoration: none !important;\n}\n.lil-gui.closed > .title:before {\n  content: "";\n}\n.lil-gui.closed > .children {\n  transform: translateY(-7px);\n  opacity: 0;\n}\n.lil-gui.closed:not(.transition) > .children {\n  display: none;\n}\n.lil-gui.transition > .children {\n  transition-duration: 300ms;\n  transition-property: height, opacity, transform;\n  transition-timing-function: cubic-bezier(0.2, 0.6, 0.35, 1);\n  overflow: hidden;\n  pointer-events: none;\n}\n.lil-gui .children:empty:before {\n  content: "Empty";\n  padding: 0 var(--padding);\n  margin: var(--spacing) 0;\n  display: block;\n  height: var(--widget-height);\n  font-style: italic;\n  line-height: var(--widget-height);\n  opacity: 0.5;\n}\n.lil-gui.root > .children > .lil-gui > .title {\n  border: 0 solid var(--widget-color);\n  border-width: 1px 0;\n  transition: border-color 300ms;\n}\n.lil-gui.root > .children > .lil-gui.closed > .title {\n  border-bottom-color: transparent;\n}\n.lil-gui + .controller {\n  border-top: 1px solid var(--widget-color);\n  margin-top: 0;\n  padding-top: var(--spacing);\n}\n.lil-gui .lil-gui .lil-gui > .title {\n  border: none;\n}\n.lil-gui .lil-gui .lil-gui > .children {\n  border: none;\n  margin-left: var(--folder-indent);\n  border-left: 2px solid var(--widget-color);\n}\n.lil-gui .lil-gui .controller {\n  border: none;\n}\n\n.lil-gui label, .lil-gui input, .lil-gui button {\n  -webkit-tap-highlight-color: transparent;\n}\n.lil-gui input {\n  border: 0;\n  outline: none;\n  font-family: var(--font-family);\n  font-size: var(--input-font-size);\n  border-radius: var(--widget-border-radius);\n  height: var(--widget-height);\n  background: var(--widget-color);\n  color: var(--text-color);\n  width: 100%;\n}\n@media (hover: hover) {\n  .lil-gui input:hover {\n    background: var(--hover-color);\n  }\n  .lil-gui input:active {\n    background: var(--focus-color);\n  }\n}\n.lil-gui input:disabled {\n  opacity: 1;\n}\n.lil-gui input[type=text],\n.lil-gui input[type=number] {\n  padding: var(--widget-padding);\n  -moz-appearance: textfield;\n}\n.lil-gui input[type=text]:focus,\n.lil-gui input[type=number]:focus {\n  background: var(--focus-color);\n}\n.lil-gui input[type=checkbox] {\n  appearance: none;\n  width: var(--checkbox-size);\n  height: var(--checkbox-size);\n  border-radius: var(--widget-border-radius);\n  text-align: center;\n  cursor: pointer;\n}\n.lil-gui input[type=checkbox]:checked:before {\n  font-family: "lil-gui";\n  content: "";\n  font-size: var(--checkbox-size);\n  line-height: var(--checkbox-size);\n}\n@media (hover: hover) {\n  .lil-gui input[type=checkbox]:focus {\n    box-shadow: inset 0 0 0 1px var(--focus-color);\n  }\n}\n.lil-gui button {\n  outline: none;\n  cursor: pointer;\n  font-family: var(--font-family);\n  font-size: var(--font-size);\n  color: var(--text-color);\n  width: 100%;\n  height: var(--widget-height);\n  text-transform: none;\n  background: var(--widget-color);\n  border-radius: var(--widget-border-radius);\n  border: none;\n}\n@media (hover: hover) {\n  .lil-gui button:hover {\n    background: var(--hover-color);\n  }\n  .lil-gui button:focus {\n    box-shadow: inset 0 0 0 1px var(--focus-color);\n  }\n}\n.lil-gui button:active {\n  background: var(--focus-color);\n}\n\n@font-face {\n  font-family: "lil-gui";\n  src: url("data:application/font-woff;charset=utf-8;base64,d09GRgABAAAAAAUsAAsAAAAACJwAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAABHU1VCAAABCAAAAH4AAADAImwmYE9TLzIAAAGIAAAAPwAAAGBKqH5SY21hcAAAAcgAAAD0AAACrukyyJBnbHlmAAACvAAAAF8AAACEIZpWH2hlYWQAAAMcAAAAJwAAADZfcj2zaGhlYQAAA0QAAAAYAAAAJAC5AHhobXR4AAADXAAAABAAAABMAZAAAGxvY2EAAANsAAAAFAAAACgCEgIybWF4cAAAA4AAAAAeAAAAIAEfABJuYW1lAAADoAAAASIAAAIK9SUU/XBvc3QAAATEAAAAZgAAAJCTcMc2eJxVjbEOgjAURU+hFRBK1dGRL+ALnAiToyMLEzFpnPz/eAshwSa97517c/MwwJmeB9kwPl+0cf5+uGPZXsqPu4nvZabcSZldZ6kfyWnomFY/eScKqZNWupKJO6kXN3K9uCVoL7iInPr1X5baXs3tjuMqCtzEuagm/AAlzQgPAAB4nGNgYRBlnMDAysDAYM/gBiT5oLQBAwuDJAMDEwMrMwNWEJDmmsJwgCFeXZghBcjlZMgFCzOiKOIFAB71Bb8AeJy1kjFuwkAQRZ+DwRAwBtNQRUGKQ8OdKCAWUhAgKLhIuAsVSpWz5Bbkj3dEgYiUIszqWdpZe+Z7/wB1oCYmIoboiwiLT2WjKl/jscrHfGg/pKdMkyklC5Zs2LEfHYpjcRoPzme9MWWmk3dWbK9ObkWkikOetJ554fWyoEsmdSlt+uR0pCJR34b6t/TVg1SY3sYvdf8vuiKrpyaDXDISiegp17p7579Gp3p++y7HPAiY9pmTibljrr85qSidtlg4+l25GLCaS8e6rRxNBmsnERunKbaOObRz7N72ju5vdAjYpBXHgJylOAVsMseDAPEP8LYoUHicY2BiAAEfhiAGJgZWBgZ7RnFRdnVJELCQlBSRlATJMoLV2DK4glSYs6ubq5vbKrJLSbGrgEmovDuDJVhe3VzcXFwNLCOILB/C4IuQ1xTn5FPilBTj5FPmBAB4WwoqAHicY2BkYGAA4sk1sR/j+W2+MnAzpDBgAyEMQUCSg4EJxAEAwUgFHgB4nGNgZGBgSGFggJMhDIwMqEAYAByHATJ4nGNgAIIUNEwmAABl3AGReJxjYAACIQYlBiMGJ3wQAEcQBEV4nGNgZGBgEGZgY2BiAAEQyQWEDAz/wXwGAAsPATIAAHicXdBNSsNAHAXwl35iA0UQXYnMShfS9GPZA7T7LgIu03SSpkwzYTIt1BN4Ak/gKTyAeCxfw39jZkjymzcvAwmAW/wgwHUEGDb36+jQQ3GXGot79L24jxCP4gHzF/EIr4jEIe7wxhOC3g2TMYy4Q7+Lu/SHuEd/ivt4wJd4wPxbPEKMX3GI5+DJFGaSn4qNzk8mcbKSR6xdXdhSzaOZJGtdapd4vVPbi6rP+cL7TGXOHtXKll4bY1Xl7EGnPtp7Xy2n00zyKLVHfkHBa4IcJ2oD3cgggWvt/V/FbDrUlEUJhTn/0azVWbNTNr0Ens8de1tceK9xZmfB1CPjOmPH4kitmvOubcNpmVTN3oFJyjzCvnmrwhJTzqzVj9jiSX911FjeAAB4nG3HMRKCMBBA0f0giiKi4DU8k0V2GWbIZDOh4PoWWvq6J5V8If9NVNQcaDhyouXMhY4rPTcG7jwYmXhKq8Wz+p762aNaeYXom2n3m2dLTVgsrCgFJ7OTmIkYbwIbC6vIB7WmFfAAAA==") format("woff");\n}'),uk=!0),i?i.appendChild(this.domElement):e&&(this.domElement.classList.add("autoPlace"),document.body.appendChild(this.domElement)),n&&this.domElement.style.setProperty("--width",n+"px"),this._closeFolders=r}add(t,e,i,n,s){if(Object(i)===i)return new lk(this,t,e,i);switch(typeof t[e]){case"number":return new hk(this,t,e,i,n,s);case"boolean":return new tk(this,t,e);case"string":return new ck(this,t,e);case"function":return new ok(this,t,e)}}addColor(t,e,i=1){return new ak(this,t,e,i)}addFolder(t){const e=new dk({parent:this,title:t});return this.root._closeFolders&&e.close(),e}load(t,e=!0){return t.controllers&&this.controllers.forEach((e=>{e instanceof ok||e._name in t.controllers&&e.load(t.controllers[e._name])})),e&&t.folders&&this.folders.forEach((e=>{e._title in t.folders&&e.load(t.folders[e._title])})),this}save(t=!0){const e={controllers:{},folders:{}};return this.controllers.forEach((t=>{if(!(t instanceof ok)){if(t._name in e.controllers)throw new Error(`Cannot save GUI with duplicate property "${t._name}"`);e.controllers[t._name]=t.save()}})),t&&this.folders.forEach((t=>{if(t._title in e.folders)throw new Error(`Cannot save GUI with duplicate folder "${t._title}"`);e.folders[t._title]=t.save()})),e}open(t=!0){return this._setClosed(!t),this.$title.setAttribute("aria-expanded",!this._closed),this.domElement.classList.toggle("closed",this._closed),this}close(){return this.open(!1)}_setClosed(t){this._closed!==t&&(this._closed=t,this._callOnOpenClose(this))}show(t=!0){return this._hidden=!t,this.domElement.style.display=this._hidden?"none":"",this}hide(){return this.show(!1)}openAnimated(t=!0){return this._setClosed(!t),this.$title.setAttribute("aria-expanded",!this._closed),requestAnimationFrame((()=>{const e=this.$children.clientHeight;this.$children.style.height=e+"px",this.domElement.classList.add("transition");const i=t=>{t.target===this.$children&&(this.$children.style.height="",this.domElement.classList.remove("transition"),this.$children.removeEventListener("transitionend",i))};this.$children.addEventListener("transitionend",i);const n=t?this.$children.scrollHeight:0;this.domElement.classList.toggle("closed",!t),requestAnimationFrame((()=>{this.$children.style.height=n+"px"}))})),this}title(t){return this._title=t,this.$title.innerHTML=t,this}reset(t=!0){return(t?this.controllersRecursive():this.controllers).forEach((t=>t.reset())),this}onChange(t){return this._onChange=t,this}_callOnChange(t){this.parent&&this.parent._callOnChange(t),void 0!==this._onChange&&this._onChange.call(this,{object:t.object,property:t.property,value:t.getValue(),controller:t})}onFinishChange(t){return this._onFinishChange=t,this}_callOnFinishChange(t){this.parent&&this.parent._callOnFinishChange(t),void 0!==this._onFinishChange&&this._onFinishChange.call(this,{object:t.object,property:t.property,value:t.getValue(),controller:t})}onOpenClose(t){return this._onOpenClose=t,this}_callOnOpenClose(t){this.parent&&this.parent._callOnOpenClose(t),void 0!==this._onOpenClose&&this._onOpenClose.call(this,t)}destroy(){this.parent&&(this.parent.children.splice(this.parent.children.indexOf(this),1),this.parent.folders.splice(this.parent.folders.indexOf(this),1)),this.domElement.parentElement&&this.domElement.parentElement.removeChild(this.domElement),Array.from(this.children).forEach((t=>t.destroy()))}controllersRecursive(){let t=Array.from(this.controllers);return this.folders.forEach((e=>{t=t.concat(e.controllersRecursive())})),t}foldersRecursive(){let t=Array.from(this.folders);return this.folders.forEach((e=>{t=t.concat(e.foldersRecursive())})),t}}var pk=a(49),mk=a.n(pk);const fk=new dk;fk.hide();class gk{constructor(t,e,i,n,s,r,a,o,h,l,c,u,d,p){this.scene=t,this.light=e,this.playerCtrl=n,this.rayViewer=l,this.physics=c,this.gui=fk,this.debugMode=!1,this.axesHelper=new Eu(300),this.gridHelper=new mu(300),this.lightHelper=new yu(this.light),this.stats=new(mk()),this.gui.hide(),this.gui.close(),this.CreateMeshGui(i.meshs,"Player"),this.CreateMeshGui(s.Owner.Meshs,"Owner"),this.CreateMeshGui(s.Helper.Meshs,"Helper1"),this.CreateMeshGui(s.Helper2.Meshs,"Helper2"),this.CreateMeshGui(r.Meshs,"Portal"),this.CreateMeshGui(p.points,"drop"),this.CreateMeshGui(this.light,"light");this.CreateMeshGui(h,"Camera").add(h,"debugMode").listen();this.CreateMeshGui(o.brickfield,"Brick Field").add(o.brickfield,"visible").listen().name("visible");this.CreateMeshGui(a,"floor").add(a,"visible").listen().name("visible"),this.arrowHelper=new Su(l.ray.direction,l.ray.origin,300,65280),this.arrowAttackHelper=new Su(this.playerCtrl.AttackSt.raycast.ray.direction,this.playerCtrl.AttackSt.raycast.ray.origin,300,16711680),d.RegisterKeyDownEvent((t=>{t.Type==Ou.System0&&this.On()})),u.RegisterViewer(this)}resize(){}update(){this.arrowHelper.position.copy(this.rayViewer.ray.origin),this.arrowHelper.setDirection(this.rayViewer.ray.direction),this.arrowAttackHelper.position.copy(this.playerCtrl.AttackSt.raycast.ray.origin),this.arrowAttackHelper.setDirection(this.playerCtrl.AttackSt.raycast.ray.direction)}On(){this.debugMode?(this.scene.remove(this.axesHelper,this.gridHelper,this.arrowHelper,this.arrowAttackHelper,this.lightHelper),document.body.removeChild(this.stats.dom),this.gui.hide(),this.debugMode=!1,this.physics.DebugMode(!0)):(this.scene.add(this.axesHelper,this.gridHelper,this.arrowHelper,this.arrowAttackHelper,this.lightHelper),document.body.appendChild(this.stats.dom),this.stats.showPanel(0),this.gui.show(),this.debugMode=!0,this.physics.DebugMode(!1))}CheckStateBegin(){this.debugMode}CheckStateEnd(){this.debugMode&&this.stats.update()}CreateVectorGui(t,e,i){t.add(e,"x",-100,100,.1).listen().name(i+"X"),t.add(e,"y",-100,100,.1).listen().name(i+"Y"),t.add(e,"z",-100,100,.1).listen().name(i+"Z")}CreateMeshGui(t,e){const i=this.gui.addFolder(e);return this.CreateVectorGui(i,t.position,"Pos"),this.CreateVectorGui(i,t.rotation,"Rot"),this.CreateVectorGui(i,t.scale,"Scale"),i.add(t,"visible").listen().name("Visible"),i.close(),i}}class vk{constructor(t){this.options=t,this.joy=document.createElement("canvas"),this.ctx=this.joy.getContext("2d"),this.joyPos=this.joy.getBoundingClientRect(),this.startX=0,this.startY=0,this.moveX=0,this.moveY=0,this.onTouch=!1,this.moveMax=40,this.msgPrev="s",this.msg="s",this.color="rgb(255, 255, 255)",this.joy.setAttribute("id","zone_joystick"),document.body.appendChild(this.joy),this.joy.width=200,this.joy.height=200,this.joy.ontouchstart=t=>{this.start(t.touches[0].clientX,t.touches[0].clientY),this.options.ontouchstart&&this.options.ontouchstart(t.touches[1])},this.joy.ontouchmove=t=>{this.move(t.touches[0].clientX,t.touches[0].clientY),this.options.ontouchmove&&this.options.ontouchmove(t.touches[1])},this.joy.ontouchend=t=>{this.end(),this.options.ontouchend&&this.options.ontouchend(t.touches[1])},this.joy.onmousedown=t=>{this.start(t.clientX,t.clientY)},this.joy.onmousemove=t=>{this.onTouch&&this.move(t.clientX,t.clientY)},this.joy.onmouseup=()=>{this.end()},null!=this.ctx&&(this.ctx.lineWidth=10,this.ctx.globalAlpha=.5,this.clearBackground(),this.drawCircle(100,100,50,this.color))}MultiEvent(){}Hide(){this.joy.style.display="none"}Show(){this.joy.style.display="block"}send(t){}clearBackground(){null!=this.ctx&&(this.ctx.clearRect(0,0,this.joy.width,this.joy.height),this.ctx.beginPath(),this.ctx.strokeStyle=this.color,this.ctx.arc(100,100,90,0,2*Math.PI),this.ctx.stroke())}drawCircle(t,e,i,n){null!=this.ctx&&(this.ctx.beginPath(),this.ctx.fillStyle=n,this.ctx.arc(t,e,i,0,2*Math.PI),this.ctx.fill())}start(t,e){this.startX=Math.round(t-this.joyPos.left),this.startY=Math.round(e-this.joyPos.top),this.onTouch=!0}move(t,e){this.onTouch&&(this.moveX=Math.round(t-this.joyPos.left)-this.startX,this.moveY=Math.round(e-this.joyPos.top)-this.startY,this.moveX>this.moveMax?this.moveX=this.moveMax:this.moveX<-this.moveMax&&(this.moveX=-this.moveMax),this.moveY>this.moveMax?this.moveY=this.moveMax:this.moveY<-this.moveMax&&(this.moveY=-this.moveMax),this.clearBackground(),this.drawCircle(100+this.moveX,100+this.moveY,50,this.color),this.moveX>=40?this.msg="d":this.moveX<=-40?this.msg="a":this.moveY<=-40?this.msg="w":this.moveY>=40&&(this.msg="x"),this.options.event("move",this.msg,this.moveX/this.moveMax,this.moveY/this.moveMax),this.msg!=this.msgPrev&&(this.send(this.msg),this.msgPrev=this.msg))}end(){this.clearBackground(),this.drawCircle(100,100,50,this.color),this.msg="s",this.msgPrev="s",this.onTouch=!1,this.send(this.msg),this.options.event("end",this.msg,this.moveX,this.moveY)}}class yk{constructor(t){this.eventCtrl=t,this.realV=new Le,this.virtualV=new Le,this.zeroV=new Le,this.left=document.getElementById("goleft"),this.right=document.getElementById("goright"),this.up=document.getElementById("goup"),this.down=document.getElementById("godown"),this.jump=document.getElementById("joypad_button1"),this.action1=document.getElementById("joypad_button2"),this.action2=document.getElementById("joypad_button3"),this.action3=document.getElementById("joypad_button4"),this.clock=new qc,this.startTime=this.clock.getElapsedTime().toFixed(2),this.joystick=new vk({event:(t,e,i,n)=>{if("move"==t){const t=this.clock.getElapsedTime().toFixed(2);if(this.startTime==t)return;this.startTime=t}const s=this.virtualV.copy(this.zeroV);switch(e){case"w":s.z=-1;break;case"x":s.z=1;break;case"d":s.x=1;break;case"a":s.x=-1}this.realV.set(i,0,n),this.eventCtrl.OnInputEvent({type:t},this.realV,this.virtualV)}}),this.eventCtrl.RegisterAppModeEvent(((t,e)=>{switch(t){case DP.Brick:case DP.NonLego:case DP.LegoDelete:case DP.Lego:case DP.Portal:case DP.Farmer:case DP.Furniture:case DP.EditCity:e==Lu.Start?(this.LegacyButtonShow(),this.ButtonShow()):e==Lu.End&&(this.LegacyButtonHide(),this.ButtonHide());break;case DP.Weapon:case DP.EditPlay:case DP.Play:e==Lu.Start?(this.joystick.Show(),this.ButtonShow()):e==Lu.End&&(this.joystick.Hide(),this.ButtonHide())}})),this.up.ontouchstart=()=>{this.eventCtrl.OnKeyDownEvent(new ju)},this.down.ontouchstart=()=>{this.eventCtrl.OnKeyDownEvent(new Wu)},this.left.ontouchstart=()=>{this.eventCtrl.OnKeyDownEvent(new Xu)},this.right.ontouchstart=()=>{this.eventCtrl.OnKeyDownEvent(new qu)},this.up.ontouchend=()=>{this.eventCtrl.OnKeyUpEvent(new ju)},this.down.ontouchend=()=>{this.eventCtrl.OnKeyUpEvent(new Wu)},this.left.ontouchend=()=>{this.eventCtrl.OnKeyUpEvent(new Xu)},this.right.ontouchend=()=>{this.eventCtrl.OnKeyUpEvent(new qu)},this.jump.ontouchstart=()=>{this.eventCtrl.OnKeyDownEvent(new Hu)},this.jump.ontouchend=()=>{this.eventCtrl.OnKeyUpEvent(new Hu)},this.action1.ontouchstart=()=>{this.eventCtrl.OnKeyDownEvent(new zu)},this.action1.ontouchend=()=>{this.eventCtrl.OnKeyUpEvent(new zu)},this.action2.ontouchstart=()=>{this.eventCtrl.OnKeyDownEvent(new Uu)},this.action2.ontouchend=()=>{this.eventCtrl.OnKeyUpEvent(new Uu)},this.action3.ontouchstart=()=>{this.eventCtrl.OnKeyDownEvent(new Fu)},this.action3.ontouchend=()=>{this.eventCtrl.OnKeyUpEvent(new Fu)}}LegacyButtonShow(){document.getElementById("joypad").style.display="block"}LegacyButtonHide(){document.getElementById("joypad").style.display="none"}ButtonShow(){document.getElementById("joypad_buttons").style.display="block"}ButtonHide(){document.getElementById("joypad_buttons").style.display="none"}MultiTouchEvent(t){if(null==this.currentEvent){if(null!=t){switch(t.target.id){case"joypad_button1":this.eventCtrl.OnKeyDownEvent(new Hu);break;case"joypad_button2":this.eventCtrl.OnKeyDownEvent(new zu);break;case"joypad_button3":this.eventCtrl.OnKeyDownEvent(new Uu);break;case"joypad_button4":this.eventCtrl.OnKeyDownEvent(new Fu);break;case"zone_joystick":this.joystick.start(t.clientX,t.clientY)}}this.currentEvent=t}if(null!=this.currentEvent)if(null!=t){if("zone_joystick"===t.target.id)this.joystick.move(t.clientX,t.clientY)}else{switch(this.currentEvent.target.id){case"joypad_button1":this.eventCtrl.OnKeyUpEvent(new Hu);break;case"joypad_button2":this.eventCtrl.OnKeyUpEvent(new zu);break;case"joypad_button3":this.eventCtrl.OnKeyUpEvent(new Uu);break;case"joypad_button4":this.eventCtrl.OnKeyUpEvent(new Fu);break;case"zone_joystick":this.joystick.end()}}this.currentEvent=t}}class xk extends ou{constructor(t,e,i,n,s,r,a){super(),this.target=t,this._camera=e,this.legos=i,this.nonlegos=n,this.terrain=s,this.dir=new Le(0,0,0),this.pos=new Le(0,0,0),this.objs=[],this.color=new Zi,this.opacityMode=!1,this.opacityBox=[[],[],[]],r.RegisterViewer(this),a.RegisterChangeCtrlObjEvent((t=>{this.target=t})),a.RegisterAppModeEvent(((t,e)=>{t==DP.EditCity&&(e==Lu.Start?this.opacityMode=!0:e==Lu.End&&(this.opacityMode=!1))}))}resize(){}update(){null!=this.target?(this.dir.subVectors(this._camera.position,this.target.CenterPos),this.set(this.target.CenterPos,this.dir.normalize()),this.terrain.InstancedMeshs.length>0&&this.terrain.InstancedMeshs.forEach((t=>{this.CheckVisible(t)})),null!=this.legos.instancedBlock&&this.CheckVisible(this.legos.instancedBlock),this.legos.bricks2.length>0&&this.CheckVisibleMeshs(this.legos.bricks2,this.opacityBox[0]),null!=this.nonlegos.instancedBlock&&this.CheckVisible(this.nonlegos.instancedBlock),this.nonlegos.bricks2.length>0&&this.CheckVisibleMeshs(this.nonlegos.bricks2,this.opacityBox[1])):this.opacityMode&&this.opacityBox.forEach((t=>{t.length&&this.ResetBox(t)}))}CheckVisible(t){const e=this.intersectObject(t,!1),i=this.target.CenterPos.distanceTo(this._camera.position);e.length>0&&e[0].distance<i?this.opacityMode?t.material.opacity=.5:this._camera.position.copy(e[0].point):this.opacityMode&&(t.material.opacity=1)}CheckVisibleMeshs(t,e){const i=this.intersectObjects(t,!1),n=this.target.CenterPos.distanceTo(this._camera.position);i.length>0&&i[0].distance<n?this.opacityMode?i.forEach((t=>{if(t.distance>n)return!1;const i=t.object;.1!=i.material.opacity&&(e.push(i),i.castShadow=!1,i.material.opacity=.1)})):this._camera.position.copy(i[0].point):this.opacityMode&&this.ResetBox(e)}ResetBox(t){t.forEach((t=>{t.castShadow=!0,t.material.opacity=1})),t.length=0}}var bk=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class _k extends $u{get BoxPos(){return this.asset.GetBoxPos(this.meshs)}get Model(){return this.asset.Id}set ControllerEnable(t){this.controllerEnable=t}get ControllerEnable(){return this.controllerEnable}constructor(t,e,i){super(t),this.monId=e,this.effector=i,this.controllerEnable=!1,this.movePos=new Le,this.vFlag=!0,this.clock=new qc,this.flag=!1,this.text=new BI(this.monId.toString()),this.effector.Enable(pb.Damage,0,1,0),this.effector.Enable(pb.Status)}Init(t){return bk(this,void 0,void 0,(function*(){null!=this.text&&(this.text.SetText(t),this.text.position.y=3.5)}))}SetOpacity(t){this.meshs.traverse((e=>{if("material"in e){const i=e.material;i.transparent=!0,i.depthWrite=!0,i.opacity=t}e.castShadow=0!=t})),this.Visible=t>0}Loader(t,e,i){return bk(this,void 0,void 0,(function*(){const[n,s]=yield this.asset.UniqModel(e+i);if(this.meshs=n,this.meshs.position.copy(t),null!=this.text&&this.meshs.remove(this.text),null!=this.text&&(this.text.SetText(e),this.text.position.y=3.5,this.meshs.add(this.text)),this.meshs.add(this.effector.meshs),this.effector.Enable(pb.BloodExplosion,this.CenterPos),this.mixer=this.asset.GetMixer(e+i),null==this.mixer)throw new Error("mixer is undefined");this.idleClip=this.asset.GetAnimationClip(Au.Idle),this.runClip=this.asset.GetAnimationClip(Au.Run),this.punchingClip=this.asset.GetAnimationClip(Au.Punch),this.dyingClip=this.asset.GetAnimationClip(Au.Dying),this.changeAnimate(this.idleClip),this.Visible=!1}))}changeAnimate(t){var e,i;if(null==t)return;const n=null===(e=this.mixer)||void 0===e?void 0:e.clipAction(t);if(null==n)return;let s=.2;null===(i=this.currentAni)||void 0===i||i.fadeOut(.2),t==this.dyingClip?(s=0,n.clampWhenFinished=!0,n.setLoop(yt,1)):n.setLoop(xt,1e4),n.reset().fadeIn(s).play(),this.currentAni=n,this.currentClip=t}StopAnimation(){var t;null===(t=this.currentAni)||void 0===t||t.stop()}ChangeAction(t){let e;switch(t){case xb.Idle:e=this.idleClip;break;case xb.Run:e=this.runClip;break;case xb.Punch:e=this.punchingClip;break;case xb.Dying:e=this.dyingClip}return this.changeAnimate(e),null==e?void 0:e.duration}DamageEffect(t,e){switch(e){case pb.Damage:default:this.effector.StartEffector(pb.BloodExplosion);break;case pb.Lightning:this.effector.StartEffector(pb.Damage)}this.effector.StartEffector(pb.Status,t.toString(),"#fff")}update(){var t;const e=this.clock.getDelta();this.effector.Update(e),null===(t=this.mixer)||void 0===t||t.update(e)}UpdatePhysics(){}}class wk{constructor(t,e,i){this.zCtrl=t,this.zombie=e,this.gphysic=i,this.attackDist=3}CheckRun(t){if(t.x||t.z)return this.zCtrl.RunSt.Init(),this.zCtrl.RunSt}CheckGravity(){if(this.zombie.Meshs.position.y-=.5,!this.gphysic.Check(this.zombie))return this.zombie.Meshs.position.y+=.5,this.zCtrl.JumpSt.Init(),this.zCtrl.JumpSt.velocity_y=0,this.zCtrl.JumpSt;this.zombie.Meshs.position.y+=.5}}class Mk{constructor(t,e,i){this.ctrl=t,this.zombie=e,this.gphysic=i,this.speed=10,this.velocity_y=16,this.dirV=new Le(0,0,0),this.ZeroV=new Le(0,0,0),this.YV=new Le(0,1,0),this.MX=new ci,this.QT=new De}Init(){this.velocity_y=16}Uninit(){this.velocity_y=16}Update(t,e){const i=e.x*t*this.speed,n=e.z*t*this.speed,s=this.velocity_y*t;if(this.zombie.Meshs.position.x+=i,this.zombie.Meshs.position.z+=n,i||n){this.dirV.copy(e),this.dirV.y=0;const t=this.MX.lookAt(this.dirV,this.ZeroV,this.YV),i=this.QT.setFromRotationMatrix(t);this.zombie.Meshs.quaternion.copy(i)}return this.gphysic.Check(this.zombie)&&(this.zombie.Meshs.position.x-=i,this.zombie.Meshs.position.z-=n),this.zombie.Meshs.position.y+=s,this.gphysic.Check(this.zombie)?(this.zombie.Meshs.position.y-=s,this.Uninit(),this.ctrl.IdleSt.Init(),this.ctrl.IdleSt):(this.velocity_y-=9.8*3*t,this)}}class Sk extends wk{constructor(t,e,i,n,s){super(t,e,i),this.eventCtrl=n,this.property=s,this.attackSpeed=this.property.attackSpeed,this.attackProcess=!1,this.attackTime=0,this.attackDamageMax=this.property.damageMax,this.attackDamageMin=this.property.damageMin}Init(){const t=this.zombie.ChangeAction(xb.Punch);null!=t&&(this.attackSpeed=.8*t),this.attackTime=this.attackSpeed}Uninit(){null!=this.keytimeout&&clearTimeout(this.keytimeout)}Update(t,e,i){if(i>this.attackDist){const t=this.CheckRun(e);if(null!=t)return t}return this.attackProcess?this:(this.attackTime+=t,this.attackTime/this.attackSpeed<1||(this.attackTime-=this.attackSpeed,this.attackProcess=!0,this.keytimeout=setTimeout((()=>{this.attack()}),1e3*this.attackSpeed*.4)),this)}attack(){this.eventCtrl.OnAttackEvent("player",[{type:HR.NormalSwing,damage:ne.randInt(this.attackDamageMin,this.attackDamageMax)}]),this.attackProcess=!1}}class Ek extends wk{constructor(t,e,i){super(t,e,i),this.Init()}Init(){this.zombie.ChangeAction(xb.Idle)}Uninit(){}Update(t,e){const i=this.CheckRun(e);return null!=i?i:this}}class Tk extends wk{constructor(t,e,i,n){super(t,e,i),this.eventCtrl=n,this.fadeMode=!1,this.fade=1}Init(){this.fadeMode=null==this.zombie.dyingClip,this.fade=1,this.fadeMode?this.zombie.StopAnimation():this.zombie.ChangeAction(xb.Dying),this.eventCtrl.OnAttackEvent("player",[{type:HR.Exp,damage:20}])}Uninit(){}Update(t){return this.fadeMode&&(this.fade-=t,this.fade<0&&(this.fade=0),this.zombie.SetOpacity(this.fade)),this}}class Ak extends wk{constructor(t,e,i,n){super(t,e,i),this.property=n,this.speed=this.property.speed,this.ZeroV=new Le(0,0,0),this.YV=new Le(0,1,0),this.MX=new ci,this.QT=new De}Init(){this.zombie.ChangeAction(xb.Run)}Uninit(){}Update(t,e,i){const n=this.CheckGravity();if(null!=n)return n;if(i<this.attackDist)return this.zCtrl.AttackSt.Init(),this.zCtrl.AttackSt;if(0==e.x&&0==e.z)return this.zCtrl.IdleSt.Init(),this.zCtrl.IdleSt;e.y=0;const s=e.x*t*this.speed,r=e.z*t*this.speed;this.zombie.Meshs.position.x+=s,this.zombie.Meshs.position.z+=r;const a=this.MX.lookAt(e,this.ZeroV,this.YV),o=this.QT.setFromRotationMatrix(a);return this.zombie.Meshs.quaternion.copy(o),this.gphysic.Check(this.zombie)&&(this.zombie.Meshs.position.x-=s,this.zombie.Meshs.position.z-=r),this}}class Ck{get Drop(){return this.property.drop}get MonsterBox(){return this.phybox}constructor(t,e,i,n,s,r,a,o,h){this.player=e,this.zombie=i,this.legos=n,this.nonlegos=s,this.terrain=r,this.gphysic=a,this.eventCtrl=o,this.property=h,this.IdleSt=new Ek(this,this.zombie,this.gphysic),this.AttackSt=new Sk(this,this.zombie,this.gphysic,this.eventCtrl,this.property),this.RunSt=new Ak(this,this.zombie,this.gphysic,this.property),this.DyingSt=new Tk(this,this.zombie,this.gphysic,this.eventCtrl),this.JumpSt=new Mk(this,this.zombie,this.gphysic),this.currentState=this.IdleSt,this.raycast=new ou,this.dir=new Le(0,0,0),this.moveDirection=new Le,this.health=this.property.health,a.Register(this);const l=i.Size,c=new Bn(2*l.x,l.y,l.z),u=new nn({color:16711680,wireframe:!0});this.phybox=new Pk(t,"mon",h.id,c,u),"hons.ghostwebservice.com"==window.location.hostname&&(this.phybox.visible=!1),this.phybox.position.copy(this.zombie.CannonPos)}Respawning(){this.health=10,this.zombie.SetOpacity(1),this.currentState=this.IdleSt,this.currentState.Init()}update(t){if(!this.zombie.Visible)return;const e=this.zombie.CannonPos.distanceTo(this.player.CannonPos);if(this.health>0){this.dir.subVectors(this.player.CenterPos,this.zombie.CenterPos),this.raycast.set(this.zombie.CenterPos,this.dir.normalize());let t=!1;this.terrain.InstancedMeshs.length>0&&this.terrain.InstancedMeshs.forEach((t=>{this.CheckVisible(t,e)})),null!=this.legos.instancedBlock&&(t=this.CheckVisible(this.legos.instancedBlock,e)),this.legos.bricks2.length>0&&!t&&(t=this.CheckVisibleMeshs(this.legos.bricks2,e)),null!=this.nonlegos.instancedBlock&&(t=this.CheckVisible(this.nonlegos.instancedBlock,e)),this.nonlegos.bricks2.length>0&&!t&&(t=this.CheckVisibleMeshs(this.nonlegos.bricks2,e)),t?this.moveDirection.set(0,0,0):this.moveDirection.copy(this.dir)}this.currentState=this.currentState.Update(t,this.moveDirection,e),this.zombie.update(),this.phybox.position.copy(this.zombie.CannonPos),this.phybox.rotation.copy(this.zombie.Meshs.rotation),this.phybox.position.y+=this.zombie.Size.y/2}ReceiveDemage(t,e){return!(this.health<=0)&&(this.zombie.DamageEffect(t,e),this.health-=t,!(this.health<=0)||(this.DyingSt.Init(),this.currentState=this.DyingSt,!1))}CheckVisible(t,e){const i=this.raycast.intersectObject(t,!1);return i.length>0&&i[0].distance<e}CheckVisibleMeshs(t,e){const i=this.raycast.intersectObjects(t,!1);return i.length>0&&i[0].distance<e}}var Ik=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class Rk{constructor(t,e,i,n,s,r,a,o,h){this.loader=t,this.eventCtrl=e,this.player=i,this.legos=n,this.nonlegos=s,this.terrain=r,this.gphysic=a,this.game=o,this.monDb=h}Call(t,e,i){return Ik(this,void 0,void 0,(function*(){i||(i=new Le(10,0,15));const n=this.monDb.GetItem(t),s=this.loader.GetAssets(n.model),r=new _k(s,t,new yb(this.game));yield r.Loader(i,t,e);return{monModel:r,monCtrl:new Ck(e,this.player,r,this.legos,this.nonlegos,this.terrain,this.gphysic,this.eventCtrl,n),live:!0,respawn:!1,deadtime:(new Date).getTime()}}))}}var kk=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class Pk extends On{constructor(t,e,i,n,s){super(n,s),this.Id=t,this.ObjName=e,this.MonId=i,this.name=e}}class Dk{constructor(t,e,i,n,s,r,a,o,h,l,c){this.loader=t,this.eventCtrl=e,this.game=i,this.player=n,this.playerCtrl=s,this.legos=r,this.nonlegos=a,this.terrain=o,this.gphysic=h,this.drop=l,this.monDb=c,this.monsters=new Map,this.mode=DP.Close,this.createMon=new Rk(this.loader,this.eventCtrl,this.player,this.legos,this.nonlegos,this.terrain,this.gphysic,this.game,this.monDb),e.RegisterAppModeEvent(((t,e)=>{if(this.mode=t,t==DP.Play)switch(e){case Lu.Start:break;case Lu.End:this.ReleaseMonster()}})),e.RegisterAttackEvent("mon",(t=>{this.mode==DP.Play&&t.forEach((t=>{let e=t.obj;if(null==e)return;const i=this.monsters.get(e.MonId);if(!i)throw new Error("unexpected value");const n=i[e.Id];n.live&&this.ReceiveDemage(n,t.damage,t.effect)}))})),e.RegisterAttackEvent("monster",(t=>{if(this.mode!=DP.Play)return;const e=this.player.CannonPos,i=t[0].distance,n=t[0].damage,s=t[0].effect;null!=i&&this.monsters.forEach((t=>{for(let r=0;r<t.length;r++){const a=t[r];if(!a.live)continue;a.monModel.CannonPos.distanceTo(e)<i&&this.ReceiveDemage(a,n,s)}}))}))}ReceiveDemage(t,e,i){t&&!t.monCtrl.ReceiveDemage(e,i)&&(t.live=!1,t.deadtime=(new Date).getTime(),this.drop.DropItem(new Le(t.monModel.CannonPos.x,this.player.CenterPos.y,t.monModel.CannonPos.z),t.monCtrl.Drop),this.playerCtrl.remove(t.monCtrl.MonsterBox),this.respawntimeout=setTimeout((()=>{t.respawn&&this.Spawning(t.monCtrl.MonsterBox.MonId,t.respawn,t,t.initPos)}),ne.randInt(8e3,15e3)))}RandomDeckMonsters(t){return kk(this,void 0,void 0,(function*(){this.RandomSpawning(t)}))}RandomSpawning(t){let e=this.monsters.get(t.monId);e||(e=[],this.monsters.set(t.monId,e)),e.length<t.maxSpawn&&(this.Spawning(t.monId,!0),this.keytimeout=setTimeout((()=>{this.RandomSpawning(t)}),5e3))}Resurrection(t){return kk(this,void 0,void 0,(function*(){let e=this.monsters.get(t);e||(e=[],this.monsters.set(t,e));const i=(new Date).getTime();return e.find((t=>0==t.live&&i-t.deadtime>5e3))}))}CreateMonster(t,e,i){return kk(this,void 0,void 0,(function*(){let n;e||(n=yield this.Resurrection(t)),this.Spawning(t,e,n,i)}))}ReleaseMonster(){this.monsters.forEach((t=>{t.forEach((t=>{t.monModel.Visible=!1,t.live=!1,this.playerCtrl.remove(t.monCtrl.MonsterBox),this.game.remove(t.monModel.Meshs,t.monCtrl.MonsterBox)}))})),null!=this.keytimeout&&clearTimeout(this.keytimeout),null!=this.respawntimeout&&clearTimeout(this.respawntimeout)}Spawning(t,e,i,n){return kk(this,void 0,void 0,(function*(){if(this.mode!=DP.Play)return;let s=this.monsters.get(t);for(s||(s=[],this.monsters.set(t,s)),i||(i=yield this.createMon.Call(t,s.length)),s.push(i),n?(i.monModel.CannonPos.copy(n),i.initPos=n):(i.monModel.CannonPos.x=this.player.CannonPos.x+yI.rand_int(-20,20),i.monModel.CannonPos.z=this.player.CannonPos.z+yI.rand_int(-20,20));this.gphysic.Check(i.monModel);)i.monModel.CannonPos.y+=.5;i.respawn=e,i.live=!0,i.monCtrl.Respawning(),i.monModel.Visible=!0,this.playerCtrl.add(i.monCtrl.MonsterBox),this.game.add(i.monModel.Meshs,i.monCtrl.MonsterBox)}))}}var Lk=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class Ok{constructor(t,e){this.itemDb=t,this.alarm=e,this.data={bodySlot:[],inventroySlot:[]}}InsertInventory(t){const e=this.data.inventroySlot.find((e=>e.item.Id==t.Id));e&&t.Stackable?e.count++:this.data.inventroySlot.push({item:t,count:1})}GetItem(t){return this.data.inventroySlot.find((e=>e.item.Id==t))}NewItem(t){return Lk(this,void 0,void 0,(function*(){if(15==this.data.inventroySlot.length)return void this.alarm.NotifyInfo(" .",xR.Warning);const e=new sR(this.itemDb.GetItem(t));yield e.Loader();const i=this.data.inventroySlot.find((t=>t.item.Id==e.Id));return i&&i.item.Stackable?(i.count++,e):(this.data.inventroySlot.push({item:e,count:1}),e)}))}MoveToInvenFromBindItem(t){const e=this.data.bodySlot[t],i=this.data.bodySlot.indexOf(e);if(i<0)throw new Error("there is no item");this.data.bodySlot.splice(i,1),this.data.inventroySlot.push({item:e,count:1})}MoveToBindFromInvenItem(t,e){const i=this.data.inventroySlot.find((t=>t.item.Id==e.Id));if(null==i)throw new Error("there is no item");const n=this.data.inventroySlot.indexOf(i);this.data.inventroySlot.splice(n,1),this.data.bodySlot[t]=e}GetInventory(t){return this.data.inventroySlot[t]}GetBindItem(t){return this.data.bodySlot[t]}GetItemInfo(t){return this.itemDb.GetItem(t)}Copy(t){const e={bodySlot:[],inventroySlot:[]};let i=t.inventroySlot.length-1;for(;i>=0;){const n=t.inventroySlot[i],s=n.item.property.id;if(s){const r=e.inventroySlot.find((t=>t.item.Id==s));r?(r.count+=n.count,t.inventroySlot.splice(i,1)):e.inventroySlot.push({item:new sR(this.itemDb.GetItem(s)),count:n.count})}else t.inventroySlot.splice(i,1);i--}t.inventroySlot.length=0,t.inventroySlot.push(...e.inventroySlot),this.data=t}Clear(){this.data.bodySlot.length=0,this.data.inventroySlot.length=0}}var Nk=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class Bk{get ItemDb(){return this.itemDb}constructor(t,e){this.loader=t,this.alarm=e,this.itemDb=new fR(this.loader),this.inven=new Ok(this.itemDb,this.alarm),this.invenHouse=new Ok(this.itemDb,this.alarm)}LoadItems(t){this.invenHouse=t}Merge(){const t=this.inven.data,e=this.invenHouse.data;for(let i=0;i<t.inventroySlot.length;i++){const n=t.inventroySlot[i],s=e.inventroySlot.find((t=>t.item.Id==n.item.Id));s?s.count+=n.count:e.inventroySlot.push(n)}}GetNewItem(t){return Nk(this,void 0,void 0,(function*(){const e=new sR(this.itemDb.GetItem(t));return yield e.Loader(),e}))}}class zk{constructor(){this.name="",this.icon="skill2/UI_Skill_Icon_Buff.png",this.lv=0,this.attack=.05}get explain(){return` ${Math.round(100*(.01*(this.lv+1)+this.attack))}% .`}IncreaseLv(){return++this.lv}GetAttackSpeed(){return 1}GetMoveSpeed(){return 1}GetDamageMax(){return 1+this.attack+.01*this.lv}Update(){}}class Uk{get explain(){return`${this.time}  ${this.area+(this.lv+1)}  ${this.damage*(this.lv+1)}  . `}constructor(t){this.eventCtrl=t,this.name="",this.icon="skill2/UI_Skill_Icon_PsycicAttack.png",this.lv=0,this.time=4,this.area=3,this.damage=2,this.accTime=0}IncreaseLv(){return++this.lv}GetAttackSpeed(){return 1}GetMoveSpeed(){return 1}GetDamageMax(){return 1}Update(t,e){e.health<=0||(this.accTime+=t,this.accTime/this.time<1||(this.accTime-=this.time,this.eventCtrl.OnAttackEvent("monster",[{type:HR.AOE,effect:pb.Lightning,damage:this.damage*this.lv,distance:this.area+this.lv}])))}}class Fk{get explain(){return`${this.time} ${this.heal*(this.lv+1)*100}%  .`}constructor(t){this.eventCtrl=t,this.name="",this.icon="skill2/UI_Skill_Icon_Heal.png",this.lv=0,this.time=4,this.heal=.01,this.accTime=0}IncreaseLv(){return++this.lv}GetAttackSpeed(){return 1}GetMoveSpeed(){return 1}GetDamageMax(){return 1}Update(t,e){e.health<=0||(this.accTime+=t,this.accTime/this.time<1||(this.accTime-=this.time,this.eventCtrl.OnAttackEvent("player",[{type:HR.Heal,damage:e.maxHealth*(this.heal*this.lv)}])))}}class Gk{constructor(t,e){this.eventCtrl=t,this.playCtrl=e,this.buffItem=[new zk,new Uk(this.eventCtrl),new Fk(this.eventCtrl)],this.userBuff=[],t.RegisterAttackEvent("player",(t=>{t.forEach((t=>{t.type,HR.Buff}))})),t.RegisterAppModeEvent(((t,e)=>{if(t==DP.Play)switch(e){case Lu.Start:case Lu.End:this.buffItem.forEach((t=>{t.lv=0})),this.userBuff.length=0}}))}GetRandomBuff(){const t=[],e=[...Array(this.buffItem.length).keys()];for(let i=0;i<3;i++){const i=e[ne.randInt(0,e.length-1)];e.splice(e.indexOf(i),1),t.push(this.buffItem[i])}return t}SelectBuff(t){this.userBuff.indexOf(t)<0&&this.userBuff.push(t),t.IncreaseLv(),this.playCtrl.UpdateBuff(this.userBuff)}GetBuff(){return this.userBuff}}class Vk{constructor(t,e,i,n,s,r){this.alarm=t,this.inventory=e,this.player=i,this.scene=s,this.dropBox=[],this.activeDropBox=[],this.resetPos=new Le(Du.StartPosition.x,-10,Du.StartPosition.z),this.head=0,this.maxCount=300,this.moveDist=6,this.dummy=new Oi,this.createPos=new Le,this.moveDirection=new Le,this.speed=4,r.RegisterAppModeEvent(((t,e)=>{if(t==DP.Play)switch(e){case Lu.Start:break;case Lu.End:this.Uninit()}})),n.RegisterViewer(this),this.points=this.CreatePoints(),this.points.frustumCulled=!1,this.points.renderOrder=1,this.scene.add(this.points)}Uninit(){if(null==this.pointsGeometry)return;const t=this.pointsGeometry.attributes.position;for(let e=0;e<this.dropBox.length;e++){const e=this.dropBox[this.head];e.droped&&(e.droped=!1,t.setX(e.id,this.resetPos.x),t.setY(e.id,this.resetPos.y),t.setZ(e.id,this.resetPos.z)),this.head++,this.head%=this.dropBox.length}this.head=0,this.activeDropBox.length=0,t.needsUpdate=!0}DropItem(t,e){this.dropPoint(t,e)}DirectItem(t){if(null!=t){const e=Math.random();t.forEach((t=>{if(t.ratio>e){const e=this.inventory.GetItemInfo(t.itemId);this.alarm.NotifyInfo(`${e.name} .`,xR.Normal),this.inventory.NewItem(t.itemId)}}))}}dropPoint(t,e){if(null==this.pointsGeometry)return;const i=[];if(null!=e){const t=Math.random();e.forEach((e=>{e.ratio>t&&i.push(e.itemId)}))}const n=this.pointsGeometry.attributes.position;for(let e=0;e<this.dropBox.length;e++){const e=this.dropBox[this.head];if(!e.droped){e.id=this.head,e.droped=!0,e.items=i,n.setX(e.id,t.x),n.setY(e.id,t.y),n.setZ(e.id,t.z),this.activeDropBox.push(e);break}this.head++,this.head%=this.dropBox.length}n.needsUpdate=!0}pointsUpdate(t){var e;if(!this.activeDropBox.length||null==this.pointsGeometry)return;this.createPos.copy(this.player.CenterPos);const i=this.pointsGeometry.attributes.position;for(let n=0;n<this.activeDropBox.length;n++){const s=this.activeDropBox[n],r=new Le(i.getX(s.id),i.getY(s.id),i.getZ(s.id)),a=r.distanceTo(this.createPos);a<1?(i.setX(s.id,this.resetPos.x),i.setY(s.id,this.resetPos.y),i.setZ(s.id,this.resetPos.z),s.droped=!1,this.activeDropBox.splice(n,1),null===(e=s.items)||void 0===e||e.forEach((t=>{const e=this.inventory.GetItemInfo(t);this.alarm.NotifyInfo(`${e.name} .`,xR.Normal),this.inventory.NewItem(t)}))):a<this.moveDist&&(this.moveDirection.subVectors(this.createPos,r).normalize(),r.addScaledVector(this.moveDirection,t*this.speed),i.setX(s.id,r.x),i.setY(s.id,r.y),i.setZ(s.id,r.z))}i.needsUpdate=!0}resize(){}update(t){this.pointsUpdate(t)}makeDropPoints(){const t=[];for(let e=0;e<this.maxCount;e++){const i=new Le;i.copy(this.resetPos),t.push(i),this.dropBox.push({id:e,droped:!1})}return t}GetGeometry(){const t=this.makeDropPoints();this.pointsGeometry=new vn,this.pointsGeometry.setFromPoints(t);const e=[];for(let i=0;i<t.length;i++){const t=ne.randInt(Math.random(),.1),i=ne.randInt(.6,1),n=ne.randInt(0,.8);e.push(t,i,n)}this.pointsGeometry.setAttribute("color",new ln(e,3))}CreatePoints(){this.GetGeometry();const t=document.createElement("CANVAS");t.width=128,t.height=128;const e=t.getContext("2d");if(null==e)throw new Error("fail get context");e.globalAlpha=.3,e.filter="blur(16px)",e.fillStyle="white",e.beginPath(),e.arc(64,64,40,0,2*Math.PI),e.fill(),e.globalAlpha=1,e.filter="blur(5px)",e.fillStyle="white",e.beginPath(),e.arc(64,64,16,0,2*Math.PI),e.fill();const i=new vh(t),n=new ch({color:"white",vertexColors:!0,size:2,sizeAttenuation:!0,map:i,transparent:!0,blending:2,depthWrite:!1});return new fh(this.pointsGeometry,n)}CreateShaderPoint(){this.GetGeometry();const t=os.points,e=Gn.clone(t.uniforms),i=new Image;e.map.value=new Ae(i),i.onload=()=>{e.map.value.needsUpdate=!0},i.src="assets/texture/particle.png";const n=ne.randInt(2,3);return e.size.value=n,e.scale.value=100,new fh(this.pointsGeometry,new Vn({uniforms:e,defines:{USE_COLOR:"",USE_MAP:"",USE_SIZEATTENUATION:""},depthWrite:!1,blending:2,vertexShader:t.vertexShader,fragmentShader:t.fragmentShader}))}CreateInstancedMesh(){const t=new Sl(1,0),e=new Bl({color:65280}),i=new Oo(t,e,this.maxCount);i.instanceMatrix.setUsage(Ut);const n=this.makeDropPoints();return n.forEach(((t,e)=>{this.dummy.position.copy(t),this.dummy.scale.set(.5,.5,.5),this.dummy.updateMatrix(),i.setMatrixAt(e,this.dummy.matrix);const n=ne.randInt(Math.random(),.1),s=ne.randInt(.6,1),r=ne.randInt(0,.8);i.setColorAt(e,new Zi(n,s,r))})),i}dropMesh(t){const e=this.points;for(let i=0;i<this.dropBox.length;i++){const i=this.dropBox[this.head];if(!i.droped){i.id=this.head,i.droped=!0,this.dummy.position.copy(t),this.dummy.updateMatrix(),e.setMatrixAt(i.id,this.dummy.matrix),e.instanceMatrix.needsUpdate=!0,this.activeDropBox.push(i);break}this.head++,this.head%=this.dropBox.length}}instanceUpdate(t){if(!this.activeDropBox.length)return;const e=this.player.CannonPos,i=this.points,n=new ci,s=new Le;for(let r=0;r<this.activeDropBox.length;r++){const a=this.activeDropBox[r];i.getMatrixAt(a.id,n),s.setFromMatrixPosition(n);const o=s.distanceTo(e);o<1?(n.setPosition(this.resetPos),a.droped=!1,this.activeDropBox.splice(r,1)):o<this.moveDist&&(e.x-s.x<0?s.x-=t*this.speed*this.moveDist:s.x+=t*this.speed*this.moveDist,e.z-s.z<0?s.z-=t*this.speed*this.moveDist:s.z+=t*this.speed*this.moveDist,n.setPosition(s)),i.setMatrixAt(a.id,n)}i.instanceMatrix.needsUpdate=!0}}class Hk{constructor(){this.monDb=new Map,this.monDb.set(rR.Bee,{id:rR.Bee,type:iR.Insect,model:Cu.Bee,health:10,speed:1,damageMin:1,damageMax:5,attackSpeed:2}),this.monDb.set(rR.Zombie,{id:rR.Zombie,type:iR.Undead,model:Cu.Zombie,health:10,speed:1,damageMin:1,damageMax:5,attackSpeed:2,drop:[{itemId:mR.Leather,ratio:.5},{itemId:mR.ZombieDeck,ratio:.1}]}),this.monDb.set(rR.Minotaur,{id:rR.Minotaur,type:iR.Beast,model:Cu.Minataur,health:10,speed:1,damageMin:1,damageMax:5,attackSpeed:2,drop:[{itemId:mR.Leather,ratio:.5},{itemId:mR.MinataurDeck,ratio:.05}]}),this.monDb.set(rR.Batpig,{id:rR.Batpig,type:iR.Beast,model:Cu.BatPig,health:5,speed:3,damageMin:1,damageMax:3,attackSpeed:1,drop:[{itemId:mR.Leather,ratio:.5},{itemId:mR.BatPigDeck,ratio:.05}]}),this.monDb.set(rR.Bilby,{id:rR.Bilby,type:iR.Beast,model:Cu.Bilby,health:10,speed:1,damageMin:1,damageMax:5,attackSpeed:2,drop:[{itemId:mR.Leather,ratio:.5},{itemId:mR.BilbyDeck,ratio:.05}]}),this.monDb.set(rR.Birdmon,{id:rR.Birdmon,type:iR.Beast,model:Cu.BirdMon,health:6,speed:5,damageMin:1,damageMax:3,attackSpeed:2,drop:[{itemId:mR.Leather,ratio:.5},{itemId:mR.BirdmonDeck,ratio:.05}]}),this.monDb.set(rR.Crab,{id:rR.Crab,type:iR.Beast,model:Cu.CrabMon,health:8,speed:1,damageMin:4,damageMax:6,attackSpeed:1,drop:[{itemId:mR.Leather,ratio:.5},{itemId:mR.CrabDeck,ratio:.05}]}),this.monDb.set(rR.Builder,{id:rR.Builder,type:iR.Warrior,model:Cu.Builder,health:10,speed:4,damageMin:1,damageMax:5,attackSpeed:2,drop:[{itemId:mR.Leather,ratio:.5},{itemId:mR.BuilderDeck,ratio:.05}]}),this.monDb.set(rR.Golem,{id:rR.Golem,type:iR.Element,model:Cu.Golem,health:10,speed:1,damageMin:1,damageMax:5,attackSpeed:2,drop:[{itemId:mR.Rocks,ratio:.5},{itemId:mR.GolemDeck,ratio:.05}]}),this.monDb.set(rR.BigGolem,{id:rR.BigGolem,type:iR.Element,model:Cu.BigGolem,health:10,speed:4,damageMin:1,damageMax:5,attackSpeed:2,drop:[{itemId:mR.Rocks,ratio:.5},{itemId:mR.BigGolemDeck,ratio:.05}]}),this.monDb.set(rR.KittenMonk,{id:rR.KittenMonk,type:iR.Beast,model:Cu.KittenMonk,health:10,speed:4,damageMin:4,damageMax:5,attackSpeed:1,drop:[{itemId:mR.Leather,ratio:.5},{itemId:mR.KittenMonkDeck,ratio:.05}]}),this.monDb.set(rR.Skeleton,{id:rR.Skeleton,type:iR.Undead,model:Cu.Skeleton,health:10,speed:3,damageMin:1,damageMax:5,attackSpeed:2,drop:[{itemId:mR.SkeletonDeck,ratio:.05}]}),this.monDb.set(rR.Snake,{id:rR.Snake,type:iR.Beast,model:Cu.Snake,health:10,speed:4,damageMin:1,damageMax:5,attackSpeed:2,drop:[{itemId:mR.SnakeDeck,ratio:.05}]}),this.monDb.set(rR.ToadMage,{id:rR.ToadMage,type:iR.Beast,model:Cu.ToadMage,health:10,speed:5,damageMin:1,damageMax:5,attackSpeed:2,drop:[{itemId:mR.Leather,ratio:.5},{itemId:mR.ToadMageDeck,ratio:.05}]}),this.monDb.set(rR.Viking,{id:rR.Viking,type:iR.Warrior,model:Cu.Viking,health:10,speed:4,damageMin:1,damageMax:5,attackSpeed:2,drop:[{itemId:mR.VikingDeck,ratio:.05}]}),this.monDb.set(rR.WereWolf,{id:rR.WereWolf,type:iR.Beast,model:Cu.WereWolf,health:10,speed:4,damageMin:8,damageMax:10,attackSpeed:2,drop:[{itemId:mR.Leather,ratio:.5},{itemId:mR.WereWolfDeck,ratio:.05}]}),this.monDb.set(rR.Stone,{id:rR.Stone,type:iR.Rock,model:Cu.Stone,health:1,speed:0,damageMin:0,damageMax:0,attackSpeed:0,drop:[{itemId:mR.Rocks,ratio:1}]}),this.monDb.set(rR.Tree,{id:rR.Tree,type:iR.Plant,model:Cu.Tree,health:1,speed:0,damageMin:0,damageMax:0,attackSpeed:0,drop:[{itemId:mR.Logs,ratio:1}]}),this.monDb.set(rR.DefaultBall,{id:rR.DefaultBall,type:iR.Rock,model:Cu.None,health:1,speed:8,damageMin:3,damageMax:4,attackSpeed:7}),this.monDb.set(rR.DefaultBullet,{id:rR.DefaultBullet,type:iR.Rock,model:Cu.None,health:1,speed:17,damageMin:3,damageMax:4,attackSpeed:7})}GetItem(t){const e=this.monDb.get(t);if(null==e)throw new Error("unkown key");return e}}var jk=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class Wk extends $u{constructor(t){super(t)}Init(){return jk(this,void 0,void 0,(function*(){}))}get BoxPos(){return this.asset.GetBoxPos(this.meshs)}MassLoad(t,e,i){return jk(this,void 0,void 0,(function*(){this.meshs=t.clone(),this.meshs.scale.set(e,e,e),this.meshs.position.copy(i),this.meshs.castShadow=!0,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!0}))}))}}var Xk=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class qk extends $u{constructor(t){super(t)}Init(){return Xk(this,void 0,void 0,(function*(){}))}MassLoader(t,e,i){return Xk(this,void 0,void 0,(function*(){const n=ne.randFloat(0,1);this.meshs=t.clone(),this.meshs.scale.set(e,e,e),this.meshs.position.set(i.x,i.y,i.z),this.meshs.rotateX(n),this.meshs.rotateZ(n),this.meshs.castShadow=!0,this.meshs.receiveShadow=!0,this.meshs.traverse((t=>{t.castShadow=!0,t.receiveShadow=!0}))}))}}var Yk=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class Jk{constructor(t,e,i,n,s,r,a,o,h){this.player=t,this.playerCtrl=e,this.worldSize=i,this.loader=n,this.game=r,this.canvas=a,this.drop=o,this.monDb=h,this.stones=[],this.trees=[],this.stoneBoxes=[],this.treeBoxes=[],this.dropPos=new Le,this.effector=new yb(this.game),this.material=new nn({transparent:!0,opacity:.5,color:16711680}),s.RegisterAppModeEvent(((t,e)=>{if(t==DP.Play)switch(e){case Lu.Start:case Lu.End:}})),s.RegisterAttackEvent("stone",(t=>{t.forEach((t=>{let e=t.obj;if(null==e)return;this.effector.meshs.position.copy(e.position),this.effector.StartEffector(pb.Damage);Math.random()<.7||(this.dropPos.copy(e.position),this.dropPos.z+=2,this.drop.DropItem(this.dropPos,this.monDb.GetItem(rR.Stone).drop))}))})),s.RegisterAttackEvent("tree",(t=>{t.forEach((t=>{let e=t.obj;if(null==e)return;this.effector.meshs.position.copy(e.position),this.effector.StartEffector(pb.Damage);Math.random()<.7||(this.dropPos.copy(e.position),this.dropPos.y=this.player.CenterPos.y,this.dropPos.z+=5,this.drop.DropItem(this.dropPos,this.monDb.GetItem(rR.Tree).drop))}))})),this.effector.Enable(pb.Damage,0,0,1),this.canvas.RegisterViewer(this),this.game.add(this.effector.meshs)}resize(){}update(t){this.effector.Update(t)}InitScene(){}MassLoader(){return Yk(this,void 0,void 0,(function*(){return yield Promise.all([this.StoneLoader(),this.MassTreeLoad()])}))}StoneLoader(){return Yk(this,void 0,void 0,(function*(){const t=yield this.loader.StoneAsset.CloneModel(),e=new Le,i=this.worldSize/2;for(let n=0;n<10;n++){const s=Math.random()*Math.PI*2,r=ne.randFloat(.3*i,.6*i);e.set(r*Math.cos(s),2,r*Math.sin(s));const a=new qk(this.loader.StoneAsset),o=yI.rand_int(9,15);yield a.MassLoader(t,o,e);const h=this.loader.StoneAsset.GetSize(a.Meshs),l=new Pk(n,"stone",rR.Stone,new Bn,this.material);l.scale.copy(h),l.position.copy(e),l.position.z+=2,l.visible=!1,this.stoneBoxes.push(l),this.playerCtrl.add(l),this.game.add(l,a.meshs)}}))}MassTreeLoad(){return Yk(this,void 0,void 0,(function*(){const t=yield this.loader.TreeAsset.CloneModel(),e=new Le,i=this.worldSize/2;for(let n=0;n<300;n++){const s=Math.random()*Math.PI*2,r=ne.randFloat(1*i,2.5*i);e.set(r*Math.cos(s),0,r*-Math.abs(Math.sin(s)));const a=yI.rand_int(10,20),o=new Wk(this.loader.TreeAsset);o.MassLoad(t,a,e),this.trees.push(o);const h=this.loader.TreeAsset.GetSize(o.Meshs),l=new Pk(n,"tree",rR.Tree,new Bn,this.material);l.scale.set(h.x/2,h.y,h.z/2),l.position.copy(e),l.visible=!1,this.treeBoxes.push(l),this.playerCtrl.add(l),this.game.add(l,o.meshs)}}))}}class $k extends Ku{get BoxPos(){const t=this.CannonPos;return new Le(t.x,t.y,t.z)}constructor(t){super(new Rl(t,.5,2,11),new nn({color:65280,transparent:!0,opacity:.5})),this.position.set(0,0,0),this.rotateX(-Math.PI/2),this.receiveShadow=!0}update(){this.rotateZ(.02*Math.PI*.5)}}var Kk,Zk=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};!function(t){t[t.VamSer=0]="VamSer"}(Kk||(Kk={}));class Qk{constructor(t,e,i,n,s,r,a,o,h,l,c){this.player=t,this.playerCtrl=e,this.portal=i,this.monster=n,this.friendly=s,this.invenFab=r,this.alarm=o,this.game=h,this.eventCtrl=l,this.store=c,this.timer=0,this.defaultGameTime=10,this.safe=!1,this.playing=!1,this.dom=document.createElement("div"),this.torus=new $k(10),this.saveData=this.store.Deck,this.deckInfo=[],this.currentSec=0,this.currentMin=-1,c.RegisterStore(this),l.RegisterAppModeEvent(((t,e)=>{var i;if(t==DP.Play)switch(e){case Lu.Start:this.safe=!0,this.invenFab.inven.Clear(),this.CallFriendly(rR.Bee),this.StartDeckParse(),this.startTimeout=setTimeout((()=>{this.createTimer(),this.timer=0,this.playing=!0}),3e3);break;case Lu.End:this.playing=!1,this.torus.visible=!1,this.invenFab.Merge(),this.invenFab.inven.Clear(),this.eventCtrl.OnChangeEquipmentEvent(this.invenFab.inven),this.safe&&(null===(i=this.opt)||void 0===i||i.OnSaveInven(r.invenHouse.data)),null!=this.keytimeout&&clearTimeout(this.keytimeout),null!=this.startTimeout&&clearTimeout(this.startTimeout)}})),a.RegisterViewer(this),this.game.add(this.torus),this.torus.visible=!1,this.torus.position.copy(this.portal.CannonPos),this.dom.className="timer h2"}createTimer(){document.getElementById("contents").appendChild(this.dom),this.dom.style.display="block",this.dom.style.top="20px",this.currentSec=0,this.currentMin=-1}updateTimer(t){if(this.timer+=t,this.currentSec==Math.floor(this.timer))return!1;this.currentSec=Math.floor(this.timer);const e=60*this.defaultGameTime-this.currentSec,i=Math.floor(e/60),n=e%60;return this.dom.innerText=(i<10?"0"+i:i)+":"+(n<10?"0"+n:n),!0}checkEndPlay(){return this.currentSec>=60*this.defaultGameTime?(this.EndOfGame(this.safe),!0):(this.playerCtrl.Health<=0&&this.EndOfGame(!1),!1)}Setup(t){this.opt=t}EndOfGame(t){var e;this.playing=!1,this.playerCtrl.Enable=!1,null===(e=this.opt)||void 0===e||e.OnEnd(t)}CallFriendly(t){this.friendly.CreateFriendly(t,this.player.CannonPos)}StartDeckParse(){this.saveData.forEach((t=>{if(!t.enable)return;const e=this.deckInfo.find((e=>e.id==t.id));if(e)e.position.push(t.position);else{const e=pR.DeckDb.get(t.id);if(!e)return;this.deckInfo.push({id:t.id,monId:e.monId,title:e.title,position:[t.position],time:t.time,rand:t.rand,uniq:null==e?void 0:e.uniq,execute:!1,max:e.maxSpawn,createCnt:0})}}))}ExecuteDeck(){const t=Math.floor(this.currentSec/60);if(this.currentMin!=t)if(this.currentMin=t,0!=this.deckInfo.length)this.deckInfo.forEach((t=>{if(!t.execute&&t.time<=this.currentMin){if(this.alarm.NotifyInfo(`"${t.title}" .`,xR.Deck),t.execute=!0,t.rand)this.monster.CreateMonster(t.monId,!0);else{const e=ne.randInt(0,t.position.length-1);this.monster.CreateMonster(t.monId,!0,t.position[e])}t.createCnt++,t.uniq||this.Respawning(t)}}));else{const t=ne.randInt(0,dR.List.length-1),e=pR.DeckDb.get(dR.List[t]);this.monster.RandomDeckMonsters(null!=e?e:pR.Zombie)}}Respawning(t){if(t.max==t.createCnt)return;const e=ne.randInt(4e3,8e3);this.keytimeout=setTimeout((()=>{const e=ne.randInt(0,t.position.length-1);this.monster.CreateMonster(t.monId,!0,t.position[e]),t.createCnt++,this.Respawning(t)}),e)}CheckPortal(t){const e=this.player.CannonPos,i=this.portal.CannonPos;if(e.distanceTo(i)<10){if(this.torus.position.copy(this.portal.CannonPos),this.torus.position.y+=2,this.torus.visible=!0,this.torus.rotateZ(Math.PI*t*.5),!this.safe){const t=document.getElementById("exitPlayCheck");t&&(t.innerHTML="  ."),this.alarm.NotifyInfo("   .",xR.Normal)}this.safe=!0}else{if(this.torus.visible=!1,this.safe){const t=document.getElementById("exitPlayCheck");t&&(t.innerHTML="  .<br>     ."),this.alarm.NotifyInfo("     .",xR.Normal)}this.safe=!1}}resize(){}update(t){this.playing&&(this.updateTimer(t)&&this.ExecuteDeck(),this.checkEndPlay(),this.CheckPortal(t))}Viliageload(){return Zk(this,void 0,void 0,(function*(){this.deckInfo.length=0,this.saveData.length=0}))}Reload(){return Zk(this,void 0,void 0,(function*(){this.deckInfo.length=0,this.saveData=this.store.Deck}))}}var tP=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class eP extends On{constructor(t,e,i,n){super(i,n),this.Id=t,this.ObjName=e,this.name=e}}class iP{constructor(t,e,i,n,s,r,a,o){this.loader=t,this.game=i,this.player=n,this.playerCtrl=s,this.monDb=a,this.store=o,this.controllable=!1,this.saveData=this.store.Deck,this.need2Reload=!1,this.deckSet=[],this.torus=new $k(2),this.material=new nn({transparent:!0,opacity:.5,color:16711680}),this.allocPos=0,r.RegisterViewer(this),o.RegisterStore(this),e.RegisterAppModeEvent(((t,e,i)=>{if(t==DP.Weapon)switch(e){case Lu.Start:this.LazyLoad(),this.VisibleOn();break;case Lu.End:this.VisibleOff(),this.controllable=!1;break;case Lu.Message:const t=i[0];this.controllable=t.locatOnOff,this.lastDeckMsg=t,this.UpdateSetup(t),t.locatOnOff&&(t.id&&(this.deck=pR.DeckDb.get(t.id)),t.enable&&this.DeckEnable(t.enable))}})),e.RegisterAttackEvent("deck",(t=>{t.forEach((t=>{let e=t.obj;null!=e&&this.DeleteDeck(e.Id)}))})),e.RegisterKeyDownEvent((t=>{var e,i,n,s,r,a;if(this.controllable&&this.deck&&t.Type===Ou.Action1){const t={id:this.deck.id,position:(new Le).copy(this.player.CannonPos),time:null!==(i=null===(e=this.lastDeckMsg)||void 0===e?void 0:e.time)&&void 0!==i?i:0,enable:null!==(s=null===(n=this.lastDeckMsg)||void 0===n?void 0:n.enable)&&void 0!==s&&s,rand:null===(a=null===(r=this.lastDeckMsg)||void 0===r?void 0:r.rand)||void 0===a||a};this.saveData.push(t),this.CreateDeck(t)}}))}UpdateSetup(t){this.saveData.forEach((e=>{e.id==t.id&&(e.enable=t.enable,e.rand=t.rand,e.time=t.time)}))}DeckEnable(t){this.saveData.forEach((e=>e.enable=t))}VisibleOn(){this.deckSet.forEach((t=>{t.used&&(this.playerCtrl.add(t.box),this.game.add(t.box,t.effect.Meshs,t.monModel.Meshs))}))}VisibleOff(){this.deckSet.forEach((t=>{t.used&&(this.playerCtrl.remove(t.box),this.game.remove(t.box,t.effect.Meshs,t.monModel.Meshs))}))}DeleteDeck(t){const e=this.deckSet[t];e.used=!1;const i=this.saveData.findIndex((t=>t.position.x==e.monModel.CannonPos.x&&t.position.z==e.monModel.CannonPos.z));i>-1&&this.saveData.splice(i,1),this.playerCtrl.remove(e.box),this.game.remove(e.box,e.effect.Meshs,e.monModel.Meshs)}CreateDeck(t){return tP(this,void 0,void 0,(function*(){const e=pR.DeckDb.get(t.id);if(!e)return;let i=this.AllocateDeckPool(e,t.position);i||(i=yield this.NewDeckEntryPool(e,t.position)),this.playerCtrl.add(i.box),this.game.add(i.monModel.Meshs,i.effect.Meshs,i.box)}))}LazyLoad(){return tP(this,void 0,void 0,(function*(){if(this.need2Reload&&(this.need2Reload=!1,this.saveData))for(let t=0;t<this.saveData.length;t++){const e=this.saveData[t];yield this.CreateDeck(e)}}))}Viliageload(){return tP(this,void 0,void 0,(function*(){}))}Reload(){return tP(this,void 0,void 0,(function*(){this.ReleaseAllDeckPool(),this.saveData=this.store.Deck,this.need2Reload=!0}))}resize(){}update(){this.deckSet.forEach((t=>{t.monModel.update&&t.monModel.update(),t.effect.update&&t.effect.update()}))}AllocateDeckPool(t,e){for(let i=0;i<this.deckSet.length;i++,this.allocPos++){const n=this.deckSet[i];if(n.monId==t.monId&&0==n.used)return n.used=!0,n.monModel.CannonPos.copy(e),n.effect.CannonPos.copy(e),n.box.position.copy(e),n;this.allocPos%=this.deckSet.length}}ReleaseAllDeckPool(){this.deckSet.forEach((t=>{t.used=!1,this.playerCtrl.remove(t.box),this.game.remove(t.box,t.effect.Meshs,t.monModel.Meshs)}))}NewDeckEntryPool(t,e){return tP(this,void 0,void 0,(function*(){const i=this.monDb.GetItem(t.monId),n=this.loader.GetAssets(i.model),s=new _k(n,i.id,new yb(this.game)),r=t.monId+"Deck";yield s.Loader(e,r,this.deckSet.length),s.Visible=!0;const a=new Bn(4*s.Size.x,s.Size.y,3*s.Size.z),o=new eP(this.deckSet.length,"deck",a,this.material),h=this.torus.clone();h.visible=!0,o.visible=!1,h.position.copy(s.CenterPos),o.position.copy(s.CenterPos);const l={monModel:s,effect:h,box:o,monId:t.monId,used:!0};return this.deckSet.push(l),l}))}}var nP,sP=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};!function(t){t[t.Rectangle=0]="Rectangle",t[t.RoundCorner=1]="RoundCorner"}(nP||(nP={}));class rP extends II{get Size(){return this.brickGuide?this.brickGuide.Size:this.brickSize}constructor(t,e,i,n,s){super(t,e,i,n,s,DP.NonLego,i.NonLegos),i.RegisterStore(this),this.brickType=kI.NonLego,e.RegisterBrickInfo((t=>{this.ChangeOption(t)})),this.eventCtrl.RegisterAppModeEvent(((t,e)=>{this.currentMode=t,this.deleteMode=t==DP.LegoDelete,t!=DP.NonLego&&t!=DP.LegoDelete||this.ChangeEvent(e)})),this.checkEx=()=>{if(!this.brickGuide)return;const t=(new Le).copy(this.brickfield.position);t.x-=this.fieldWidth/2,t.z-=this.fieldHeight/2;const e=(new Le).copy(this.brickGuide.position),i=this.brickGuide.Size;e.x-=i.x/2,e.z-=i.z/2,e.x>=t.x&&e.x<=t.x+this.fieldWidth&&e.z>=t.z&&e.z<=t.z+this.fieldHeight?this.brickGuide.Creation=!1:this.brickGuide.Creation=!0},e.RegisterSceneClearEvent((()=>{this.ClearBlock(),this.ClearEventBrick()}))}EditMode(){this.ClearBlock(),this.CreateBricks(this.store.NonLegos)}Viliageload(){return sP(this,void 0,void 0,(function*(){}))}Reload(){return sP(this,void 0,void 0,(function*(){this.LegoStore=this.store.NonLegos,this.CreateBricks(this.store.NonLegos)}))}Cityload(){return sP(this,void 0,void 0,(function*(){this.LegoStore=this.store.CityNonlego,this.CreateBricks(this.store.CityNonlego)}))}}var aP=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class oP extends $u{get BoxPos(){return this.asset.GetBoxPos(this.meshs)}constructor(t,e){super(t),this.name=e}Loader(t){return aP(this,void 0,void 0,(function*(){const[e,i]=yield this.asset.UniqModel(this.name);if(this.meshs=e,this.meshs.position.copy(t),null!=this.text&&this.meshs.remove(this.text),this.mixer=this.asset.GetMixer(this.name),null==this.mixer)throw new Error("mixer is undefined");this.idleClip=this.asset.GetAnimationClip(Au.Idle),this.runClip=this.asset.GetAnimationClip(Au.Run),this.punchingClip=this.asset.GetAnimationClip(Au.Punch),this.dyingClip=this.asset.GetAnimationClip(Au.Dying),this.changeAnimate(this.idleClip),this.Visible=!0}))}changeAnimate(t){var e,i;if(null==t)return;const n=null===(e=this.mixer)||void 0===e?void 0:e.clipAction(t);if(null==n)return;let s=.2;null===(i=this.currentAni)||void 0===i||i.fadeOut(.2),t==this.dyingClip?(s=0,n.clampWhenFinished=!0,n.setLoop(yt,1)):n.setLoop(xt,1e4),n.reset().fadeIn(s).play(),this.currentAni=n,this.currentClip=t}StopAnimation(){var t;null===(t=this.currentAni)||void 0===t||t.stop()}ChangeAction(t){let e;switch(t){case xb.Idle:e=this.idleClip;break;case xb.Run:e=this.runClip;break;case xb.Punch:e=this.punchingClip;break;case xb.Dying:e=this.dyingClip}return this.changeAnimate(e),null==e?void 0:e.duration}update(t){var e;null===(e=this.mixer)||void 0===e||e.update(t)}}class hP{constructor(t,e,i){this.fCtrl=t,this.fly=e,this.gphysic=i,this.protectDist=5}CheckRun(t){if(t.x||t.z)return this.fCtrl.RunSt.Init(),this.fCtrl.RunSt}}class lP extends hP{constructor(t,e,i,n){super(t,e,n),this.playerCtrl=i,this.raycast=new ou,this.attackDir=new Le,this.attackDist=5,this.ZeroV=new Le(0,0,0),this.YV=new Le(0,1,0),this.MX=new ci,this.QT=new De,this.dir=new Le(0,0,0),this.time=0,this.watching=2,this.speed=1,this.Init()}Init(){this.fly.ChangeAction(xb.Idle),this.time=0}Uninit(){}Update(t,e,i){if(i>this.protectDist){const t=this.CheckRun(e);if(null!=t)return t}const n=this.checkAttack();if(n)return n;this.time+=t,this.time>this.watching&&(this.time=0,this.dir.x=ne.randFloat(0,1),this.dir.y=e.y,this.dir.z=ne.randFloat(0,1)),i>this.protectDist-.3&&(this.time=0,this.dir.copy(e.multiplyScalar(1/i))),this.fly.Meshs.position.x+=this.dir.x*t*this.speed,this.fly.Meshs.position.y+=this.dir.y*t*this.speed,this.fly.Meshs.position.z+=this.dir.z*t*this.speed,this.dir.y=0;const s=this.MX.lookAt(this.dir,this.ZeroV,this.YV),r=this.QT.setFromRotationMatrix(s);return this.fly.Meshs.quaternion.copy(r),this}checkAttack(){this.fly.Meshs.getWorldDirection(this.attackDir),this.raycast.set(this.fly.CannonPos,this.attackDir.normalize());const t=this.raycast.intersectObjects(this.playerCtrl.targets);if(t.length>0&&t[0].distance<this.attackDist)return this.fCtrl.AttackSt.InitWithTarget(t[0].object),this.fCtrl.AttackSt}}class cP extends hP{constructor(t,e,i,n,s,r){super(t,e,i),this.fly=e,this.playerCtrl=n,this.eventCtrl=s,this.property=r,this.dirV=new Le(0,0,0),this.ZeroV=new Le(0,0,0),this.YV=new Le(0,1,0),this.MX=new ci,this.QT=new De,this.playDist=20,this.attackDist=5,this.attackDir=new Le,this.startPos=new Le,this.targetPos=new Le,this.attackSpeed=this.property.attackSpeed,this.attackProcess=!1,this.attackTime=0,this.speed=this.property.speed,this.attackDamageMax=this.property.damageMax,this.attackDamageMin=this.property.damageMin}Init(){const t=this.fly.ChangeAction(xb.Punch);null!=t&&(this.attackSpeed=.8*t),this.attackTime=this.attackSpeed,this.attackProcess=!1}InitWithTarget(t){this.target=t,this.Init()}Uninit(){null!=this.keytimeout&&clearTimeout(this.keytimeout)}Update(t,e,i){if(i>this.playDist){const t=this.CheckRun(e);if(null!=t)return t}return this.approach(t),this.attackProcess?this:(this.attackTime+=t,this.attackTime/this.attackSpeed<1?this:(this.attackTime-=this.attackSpeed,this.attackProcess=!0,this.playerCtrl.targets.find((t=>t==this.target))?(this.keytimeout=setTimeout((()=>{this.attack()}),1e3*this.attackSpeed*.4),this):(this.fCtrl.RunSt.Init(),this.fCtrl.RunSt)))}approach(t){if(!this.target)return;this.attackDir.subVectors(this.target.position,this.fly.CannonPos),this.attackDir=this.attackDir.normalize();this.target.position.distanceTo(this.fly.CannonPos)>this.attackDist&&(this.fly.Meshs.position.x+=this.attackDir.x*t*this.speed,this.fly.Meshs.position.z+=this.attackDir.z*t*this.speed),this.attackDir.y=0;const e=this.MX.lookAt(this.attackDir,this.ZeroV,this.YV),i=this.QT.setFromRotationMatrix(e);this.fly.Meshs.quaternion.copy(i)}attack(){var t,e;this.attackProcess=!1,this.target&&(this.startPos.copy(this.fly.CenterPos),this.startPos.y=null!==(e=null===(t=this.fly.Asset.Info)||void 0===t?void 0:t.calY)&&void 0!==e?e:this.fly.CenterPos.y,this.targetPos.copy(this.target.position),this.targetPos.y+=2,this.attackDir=this.attackDir.subVectors(this.targetPos,this.startPos).normalize(),this.eventCtrl.OnProjectileEvent({id:rR.DefaultBall,damage:ne.randInt(this.attackDamageMin,this.attackDamageMax),src:this.startPos,dir:this.attackDir}))}}class uP extends hP{constructor(t,e,i){super(t,e,i),this.fadeMode=!1,this.fade=1}Init(){this.fadeMode=null==this.fly.dyingClip,this.fade=1,this.fadeMode?this.fly.StopAnimation():this.fly.ChangeAction(xb.Dying)}Uninit(){}Update(){return this}}class dP extends hP{constructor(t,e,i,n){super(t,e,i),this.property=n,this.speed=this.property.speed,this.ZeroV=new Le(0,0,0),this.YV=new Le(0,1,0),this.MX=new ci,this.QT=new De}Init(){this.fly.ChangeAction(xb.Run)}Uninit(){}Update(t,e,i){if(i<this.protectDist)return this.fCtrl.IdleSt.Init(),this.fCtrl.IdleSt;const n=e.x*t*this.speed,s=e.y*t*this.speed,r=e.z*t*this.speed;this.fly.Meshs.position.x+=n,this.fly.Meshs.position.y+=s,this.fly.Meshs.position.z+=r,e.y=0;const a=this.MX.lookAt(e,this.ZeroV,this.YV),o=this.QT.setFromRotationMatrix(a);return this.fly.Meshs.quaternion.copy(o),this}}class pP{constructor(t,e,i,n,s,r){this.fly=t,this.player=e,this.playerCtrl=i,this.gphysic=n,this.eventCtrl=s,this.property=r,this.IdleSt=new lP(this,this.fly,this.playerCtrl,this.gphysic),this.AttackSt=new cP(this,this.fly,this.gphysic,this.playerCtrl,this.eventCtrl,this.property),this.RunSt=new dP(this,this.fly,this.gphysic,this.property),this.DyingSt=new uP(this,this.fly,this.gphysic),this.currentState=this.IdleSt,this.dir=new Le(0,0,0),this.moveDirection=new Le,this.Init()}Init(){this.gphysic.Register(this)}Release(){this.gphysic.Deregister(this)}update(t){if(!this.fly.Visible)return;const e=this.fly.CannonPos.distanceTo(this.player.CannonPos);this.dir.subVectors(this.player.CenterPos,this.fly.CenterPos),this.moveDirection.copy(this.dir),this.currentState=this.currentState.Update(t,this.moveDirection,e),this.fly.update(t)}Respawning(){}}var mP=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class fP{constructor(t,e,i,n,s,r,a){this.loader=t,this.eventCtrl=e,this.gphysic=i,this.game=n,this.player=s,this.playerCtrl=r,this.monDb=a,this.friendly=new Map,this.mode=DP.Close,e.RegisterAppModeEvent(((t,e)=>{if(this.mode=t,t==DP.Play)switch(e){case Lu.Start:break;case Lu.End:this.Release()}}))}Release(){this.friendly.forEach((t=>{t.friendlyModel.Meshs.visible=!1,t.friendlyCtrl.Release(),this.game.remove(t.friendlyModel.Meshs)}))}CreateFriendly(t,e){return mP(this,void 0,void 0,(function*(){e||(e=new Le(10,0,15));const i=this.monDb.GetItem(t),n=this.loader.GetAssets(i.model),s=new oP(n,t);yield s.Loader(e);const r={friendlyModel:s,friendlyCtrl:new pP(s,this.player,this.playerCtrl,this.gphysic,this.eventCtrl,i),live:!0,respawn:!1,deadtime:(new Date).getTime()};this.friendly.set(t,r),this.game.add(s.Meshs)}))}}class gP{get Meshs(){return this.mesh}constructor(){this.alive=!0,this.maxCount=20,this.trailPositions=new Float32Array(3*this.maxCount),this.pointsGeometry=new vn,this.mesh=this.CreatePoints(),this.mesh.frustumCulled=!1,this.mesh.renderOrder=1,this.mesh.visible=!1}create(t){for(let e=0;e<this.trailPositions.length;e+=3)this.trailPositions[e]=t.x,this.trailPositions[e+1]=t.y,this.trailPositions[e+2]=t.z;this.pointsGeometry.attributes.position.needsUpdate=!0,this.mesh.visible=!0,this.alive=!0}GetGeometry(){const t=[],e=[];for(let i=0;i<this.maxCount;i++){const n=ne.randInt(Math.random(),.1),s=ne.randInt(.6,1),r=ne.randInt(0,.8),a=1-1/this.maxCount*i;t.push(n,s,r,a),e.push(1)}this.pointsGeometry.setAttribute("position",new an(this.trailPositions,3)),this.pointsGeometry.setAttribute("color",new ln(t,4)),this.pointsGeometry.setAttribute("size",new ln(e,1))}CreatePoints(){this.GetGeometry();const t=document.createElement("CANVAS");t.width=128,t.height=128;const e=t.getContext("2d");if(null==e)throw new Error("fail get context");e.globalAlpha=.3,e.filter="blur(16px)",e.fillStyle="white",e.beginPath(),e.arc(64,64,40,0,2*Math.PI),e.fill(),e.globalAlpha=1,e.filter="blur(5px)",e.fillStyle="white",e.beginPath(),e.arc(64,64,16,0,2*Math.PI),e.fill();const i=new vh(t),n=new ch({color:"white",vertexColors:!0,size:.3,sizeAttenuation:!0,map:i,transparent:!0,blending:2,depthWrite:!1});return new fh(this.pointsGeometry,n)}update(t){if(this.alive){for(let t=this.trailPositions.length-3;t>0;t-=3)this.trailPositions[t]=this.trailPositions[t-3],this.trailPositions[t+1]=this.trailPositions[t-2],this.trailPositions[t+2]=this.trailPositions[t-1];this.trailPositions[0]=t.x,this.trailPositions[1]=t.y,this.trailPositions[2]=t.z,this.pointsGeometry.attributes.position.needsUpdate=!0}}release(){this.alive=!1,this.mesh.visible=!1}}class vP extends Ku{get BoxPos(){const t=this.CannonPos;return new Le(t.x,t.y,t.z)}constructor(t){super(new Cl(t,4,2),new Bl({color:65280}))}create(t){this.CannonPos.copy(t),this.Visible=!0}update(t){this.CannonPos.copy(t)}release(){this.Visible=!1}}class yP{get Live(){return this.live}constructor(t,e,i,n){this.projectile=t,this.playerCtrl=e,this.eventCtrl=i,this.property=n,this.raycast=new ou,this.moveDirection=new Le,this.position=new Le,this.attackDist=2,this.maxTarget=1,this.lifetime=5,this.currenttime=0,this.live=!1,this.damage=1}Release(){this.projectile.release(),this.live=!1}start(t,e,i){this.position.copy(t),this.moveDirection.copy(e),this.projectile.create(t),this.live=!0,this.currenttime=0,this.damage=i}checkLifeTime(){return this.currenttime<this.lifetime}update(t){this.live&&(this.currenttime+=t,this.position.addScaledVector(this.moveDirection,this.property.speed*t),this.projectile.update(this.position))}attack(){if(!this.live)return!1;const t=new Map;return this.playerCtrl.targets.forEach((e=>{const i=e.position.distanceTo(this.position);if(this.attackDist<i)return;const n=t.get(e.name),s={type:HR.NormalSwing,damage:this.damage,obj:e};null==n?t.set(e.name,[s]):n.push(s)})),t.size>0&&(t.forEach(((t,e)=>{this.eventCtrl.OnAttackEvent(e,t)})),!0)}}var xP=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class bP{constructor(t,e,i,n,s,r){this.eventCtrl=i,this.game=n,this.playerCtrl=s,this.monDb=r,this.projectiles=new Map,this.mode=DP.Close,this.processing=!1,e.RegisterViewer(this),i.RegisterAppModeEvent(((t,e)=>{if(this.mode=t,t==DP.Play)switch(e){case Lu.Start:this.processing=!0;break;case Lu.End:this.processing=!1,this.ReleaseAllProjPool()}})),i.RegisterProjectileEvent((t=>{this.AllocateProjPool(t.id,t.src,t.dir,t.damage)}))}GetModel(t){switch(t){case rR.DefaultBullet:return new gP;case rR.DefaultBall:default:return new vP(.1)}}CreateProjectile(t,e,i,n){const s=this.monDb.GetItem(t),r=this.GetModel(t),a=new yP(r,this.playerCtrl,this.eventCtrl,s);a.start(e,i,n);return{model:r,ctrl:a}}update(t){this.processing&&this.projectiles.forEach((e=>{e.forEach((e=>{e.ctrl.update(t),!e.ctrl.attack()&&e.ctrl.checkLifeTime()||this.Release(e)}))}))}resize(){}Release(t){t.ctrl.Release(),t.model.Meshs&&this.game.remove(t.model.Meshs)}AllocateProjPool(t,e,i,n){let s=this.projectiles.get(t);s||(s=[]);let r=s.find((t=>0==t.ctrl.Live));return r?r.ctrl.start(e,i,n):(r=this.CreateProjectile(t,e,i,n),s.push(r)),this.projectiles.set(t,s),r.model.Meshs&&this.game.add(r.model.Meshs),r}ReleaseAllProjPool(){this.projectiles.forEach((t=>{t.forEach((t=>{t.ctrl.Release(),t.model.Meshs&&this.game.remove(t.model.Meshs)}))}))}NewFurnEntryPool(){return xP(this,void 0,void 0,(function*(){}))}}class _P extends Ku{get BoxPos(){const t=this.CannonPos;return new Le(t.x,t.y,t.z)}constructor(){super(new ss(Du.LegoFieldW,Du.LegoFieldH),new nn({color:65280,transparent:!0,opacity:.8})),this.rotateX(-Math.PI/2),this.position.set(0,50,0);const t=new Le(0,0,0),e=new Le(0,1,0),i=Du.LegoFieldH/2+1,n=e.subVectors(t,e).normalize(),s=new Su(n,t,i,16711680);this.Meshs.add(s)}Copy(t){this.position.copy(t.position),this.rotation.copy(t.rotation)}Set(t,e){this.position.copy(t),this.rotation.copy(e)}}var wP=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class MP{constructor(t,e,i,n){this.terrain=t,this.store=n,n.RegisterStore(this),i.RegisterViewer(this),e.RegisterAppModeEvent(((t,e)=>{if(t==DP.CityView)switch(e){case Lu.Start:case Lu.End:}}))}Cityload(){return wP(this,void 0,void 0,(function*(){this.terrain.LoadHouse(this.store.CityHouses);const t=this.store.UserHouseData;t&&t.forEach((t=>{if(0==t.length)return;const e=JSON.parse(t);this.terrain.Build(e)}))}))}Reload(){return wP(this,void 0,void 0,(function*(){}))}update(t){this.terrain.update(t)}}var SP,EP,TP=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class AP extends $u{constructor(t){super(t),this.meshs=new Da}Init(){return TP(this,void 0,void 0,(function*(){}))}Loader(t){var e;return TP(this,void 0,void 0,(function*(){const[i,n]=yield this.asset.UniqModel("arrow");if(this.meshs=i,this.meshs.position.copy(t),this.meshs.castShadow=!1,this.meshs.receiveShadow=!1,this.mixer=this.asset.GetMixer("arrow"),this.idleClip=this.asset.GetAnimationClip(Au.Idle),!this.idleClip)return;const s=null===(e=this.mixer)||void 0===e?void 0:e.clipAction(this.idleClip);null!=s&&(s.setLoop(xt,1e4),s.reset().fadeIn(.1).play())}))}update(t){var e;null===(e=this.mixer)||void 0===e||e.update(t)}}!function(t){t[t.Rotate=0]="Rotate",t[t.Camera=1]="Camera"}(SP||(SP={}));class CP{constructor(t,e,i,n,s){this.terrainer=i,this.physics=n,this.mode=!1,this.checktime=0,t.RegisterAppModeEvent(((t,i)=>{if(t==DP.EditCity)switch(i){case Lu.Start:this.mode=!0,e.add(this.terrainer,this.arrow.Meshs);break;case Lu.End:this.mode=!1,e.remove(this.terrainer,this.arrow.Meshs)}})),t.RegisterTerrainInfo((t=>{t.to==SP.Rotate&&this.terrainer.rotateZ(Math.PI/2)})),t.RegisterKeyDownEvent((t=>{if(!this.mode)return;const e=t.ExecuteKeyDown();this.moveEvent(e),this.arrow.CannonPos.copy(i.position)})),this.arrow=new AP(s.ArrowAsset),this.arrow.Loader(i.position)}moveEvent(t){const e=t.x>0?1:t.x<0?-1:0,i=t.z>0?1:t.z<0?-1:0;this.terrainer.position.x+=e,this.terrainer.position.z+=i,this.CheckCollision()}CheckCollision(){if(this.physics.CheckBox(this.terrainer.position,this.terrainer.Box))do{this.terrainer.CannonPos.y+=.5}while(this.physics.CheckBox(this.terrainer.position,this.terrainer.Box));else{do{this.terrainer.CannonPos.y-=.5}while(!this.physics.CheckBox(this.terrainer.position,this.terrainer.Box)&&this.terrainer.CannonPos.y>0);this.terrainer.CannonPos.y+=.5}}update(t){this.arrow.update(t),this.checktime+=t,Math.floor(this.checktime)<1||(this.checktime=0,this.CheckCollision(),this.arrow.CannonPos.copy(this.terrainer.position))}}!function(t){t[t.ChangeLocationS=0]="ChangeLocationS",t[t.ChangeLocationE=1]="ChangeLocationE"}(EP||(EP={}));class IP{get InstancedMeshs(){return this.brick}constructor(t,e,i,n,s){this.terrainGuide=t,this.game=i,this.gphysic=n,this.mode=!1,this.terrainers=[],this.terrains=[],this.brick=[],this.raycaster=new ou,this.mouse=new se,this.locationMode=!1,this.brickSize=new Le(1,1,1),this.subV=new Le(.1,.1,.1),this.terrainCtrl=new CP(e,i,this.terrainGuide,n,s),e.RegisterAppModeEvent(((t,e,i)=>{if(t==DP.EditCity)switch(e){case Lu.Start:this.mode=!0,window.addEventListener("click",this.choiceTerrain.bind(this)),this.EditStart();break;case Lu.End:this.mode=!1,this.locationMode=!1,window.removeEventListener("click",this.choiceTerrain.bind(this));break;case Lu.Message:this.locationMode=i[0]==EP.ChangeLocationS}})),e.RegisterKeyDownEvent((t=>{this.mode&&t.Type==Ou.Action0&&this.CreateTerrainer(this.terrainGuide)})),e.RegisterSceneClearEvent((()=>{this.ReleaseAll()}))}SetCamera(t){this.camera=t}EditStart(){this.game.add(...this.terrains)}choiceTerrain(t){if(!this.camera||!this.locationMode)return;this.mouse.x=t.clientX/window.innerWidth*2-1,this.mouse.y=-t.clientY/window.innerHeight*2+1,this.raycaster.setFromCamera(this.mouse,this.camera);const e=this.raycaster.intersectObjects(this.terrains,!0);if(e.length>0){const t=e[0].object,i=this.terrainers.find((e=>e.terrainer==t));if(!i)return;this.terrainGuide.Copy(i.terrainer),this.DeleteStoreData(i.terrainer),this.Release(i)}}DeleteStoreData(t){var e,i;const n=null===(e=this.house)||void 0===e?void 0:e.find((e=>e.position.x==t.position.x&&e.position.y==t.position.y+.5&&e.position.z==t.position.z));n&&(null===(i=this.house)||void 0===i||i.splice(this.house.indexOf(n),1))}Release(t){var e;t.alloc=!1,this.game.remove(t.terrainer),t.brick&&(this.game.remove(t.brick),t.brick.dispose(),t.brick=void 0),null===(e=t.eventBrick)||void 0===e||e.forEach((t=>{this.gphysic.DeleteBox(t.Key,t)})),t.eventBrick=void 0}ReleaseAll(){this.terrainers.forEach((t=>{this.Release(t)})),this.brick.length=0,this.terrainers.length=0,this.terrains.length=0}Build(t){const e=this.CreateInstacedMesh(t.legos);if(!e)return!1;const i=this.terrainers.find((t=>0==t.alloc));if(!i)return!1;i.terrainer.position.y-=.5,e.position.copy(i.terrainer.position),e.rotation.copy(i.terrainer.rotation),e.rotateX(1.5*-Math.PI);const n=new Le;e.getWorldDirection(n),n.negate(),e.position.addScaledVector(n,Du.LegoFieldH/2);const s=this.MakePhysics(e,t.legos.length);return i.alloc=!0,i.brick=e,i.eventBrick=s,this.brick.push(e),this.game.add(e),!0}CreateTerrainer(t){var e;const i=new _P;i.Copy(t),this.game.add(i),this.terrainers.push({terrainer:i,alloc:!1}),this.terrains.push(i),null===(e=this.house)||void 0===e||e.push({position:i.position,rotation:i.rotation})}LoadHouse(t){t.forEach((t=>{const e=new _P;e.Set(t.position,t.rotation),this.terrainers.push({terrainer:e,alloc:!1}),this.terrains.push(e)})),this.house=t}GetHouse(){const t=[];return this.terrainers.forEach((e=>{const i=e.terrainer;t.push({position:i.position,rotation:i.rotation})})),t}update(t){this.terrainCtrl.update(t)}CreateInstacedMesh(t){if(!(null==t?void 0:t.length))return;const e=new Bn(1,1,1),i=new Fl({color:16777215,transparent:!0}),n=new Oo(e,i,t.length);n.castShadow=!0,n.receiveShadow=!0;const s=new ci,r=new De;return t.forEach(((t,e)=>{r.setFromEuler(t.rotation),s.compose(t.position,r,t.size),null==n||n.setColorAt(e,new Zi(t.color)),null==n||n.setMatrixAt(e,s)})),n}MakePhysics(t,e){const i=new ci,n=new ci,s=new ci,r=new De,a=new Le,o=[];t.updateMatrixWorld(),s.copy(t.matrixWorld);for(let h=0;h<e;h++){t.getMatrixAt(h,i),n.multiplyMatrices(s,i);const{position:e,scale:l,rotation:c}=this.getPosRotScaleFromMatrix(n,r),u=new CI(this.brickSize,e);a.copy(l).sub(this.subV),this.gphysic.addBuilding(u,e,a,c),o.push(u)}return o}getPosRotScaleFromMatrix(t,e){const i=new Le,n=new Le;t.decompose(i,e,n);return{position:i,scale:n,rotation:(new bi).setFromQuaternion(e)}}}class RP{constructor(t){this.eventCtrl=t,this.eventCtrl.RegisterAppModeEvent(((t,e)=>{if(t==DP.EditPlay)switch(e){case Lu.Start:this.Initialize();break;case Lu.End:this.Uninitialize()}}))}Initialize(){}Uninitialize(){const t=document.getElementById("edit-progress-bar-container");t&&(t.style.display="none")}}var kP=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class PP{get PhysicDebugger(){return this.PhysicDebugger}get Physics(){return this.gphysics}get Canvas(){return this.canvas}get Scene(){return this.currentScene}get EventCtrl(){return this.eventCtrl}get ModelStore(){return this.store}get Player(){return this.player}get Buff(){return this.buff}get GameCenter(){return this.gameCenter}get LoadingManager(){return this.loader.LoadingManager}get Furnitures(){return this.furnDb}get Plants(){return this.plantDb}get Monsters(){return this.monDb}get Items(){return this.invenFab.ItemDb}get Projectile(){return this.projectile}constructor(){this.alarm=new ER,this.eventCtrl=new Nu,this.canvas=new td,this.loader=new vI,this.deckDb=new pR,this.monDb=new Hk,this.furnDb=new NR,this.plantDb=new MR,this.skyBox=new Qu,this.grass=[],this.deadtrees=[],this.mushrooms=[],this.worldSize=300,this.floor=new Zu(this.worldSize),this.invenFab=new Bk(this.loader,this.alarm),this.store=new HI(this.eventCtrl,this.invenFab),this.input=new yk(this.eventCtrl),this.light=new Qg,this.game=new Ju(this.light),this.gphysics=new jI(this.game,this.eventCtrl),this.portal=new TI(this.loader.PortalAsset,this.store,this.eventCtrl,this.gphysics),this.player=new _b(this.loader,this.eventCtrl,this.portal,this.store,this.game),this.playerCtrl=new ZR(this.player,this.invenFab.inven,this.invenFab,this.gphysics,this.eventCtrl),this.drop=new Vk(this.alarm,this.invenFab.inven,this.player,this.canvas,this.game,this.eventCtrl),this.brick=new NI(this.game,this.eventCtrl,this.store,this.gphysics,this.player),this.legos=new DI(this.game,this.eventCtrl,this.store,this.Physics,this.player),this.nonLegos=new rP(this.game,this.eventCtrl,this.store,this.Physics,this.player),this.terrainer=new _P,this.terrain=new IP(this.terrainer,this.eventCtrl,this.game,this.gphysics,this.loader),this.npcs=new GI(this.loader,this.eventCtrl,this.game,this.canvas,this.store,this.gphysics),this.monsters=new Dk(this.loader,this.eventCtrl,this.game,this.player,this.playerCtrl,this.legos,this.nonLegos,this.terrain,this.gphysics,this.drop,this.monDb),this.friendly=new fP(this.loader,this.eventCtrl,this.gphysics,this.game,this.player,this.playerCtrl,this.monDb),this.projectile=new bP(this.loader,this.canvas,this.eventCtrl,this.game,this.playerCtrl,this.monDb),this.buff=new Gk(this.eventCtrl,this.playerCtrl),this.materials=new Jk(this.player,this.playerCtrl,this.worldSize,this.loader,this.eventCtrl,this.game,this.canvas,this.drop,this.monDb),this.farmer=new DR(this.loader,this.player,this.playerCtrl,this.game,this.store,this.gphysics,this.canvas,this.eventCtrl,this.alarm,this.drop,this.plantDb),this.carp=new VR(this.loader,this.player,this.playerCtrl,this.game,this.store,this.gphysics,this.canvas,this.eventCtrl,this.furnDb,this.alarm,this.invenFab.invenHouse),this.monDeck=new iP(this.loader,this.eventCtrl,this.game,this.player,this.playerCtrl,this.canvas,this.monDb,this.store),this.gameCenter=new Qk(this.player,this.playerCtrl,this.portal,this.monsters,this.friendly,this.invenFab,this.canvas,this.alarm,this.game,this.eventCtrl,this.store),this.cityCenter=new MP(this.terrain,this.eventCtrl,this.canvas,this.store),this.editCenter=new RP(this.eventCtrl),this.camera=new Kg(this.canvas,this.player,this.terrainer,this.npcs,this.brick,this.legos,this.nonLegos,this.portal,this.farmer,this.carp,this.eventCtrl),this.rayViewer=new xk(this.player,this.camera,this.legos,this.nonLegos,this.terrain,this.canvas,this.eventCtrl),this.renderer=new Zg(this.camera,this.game,this.canvas),this.currentScene=this.game,this.terrain.SetCamera(this.camera)}MassMushroomLoader(t){return kP(this,void 0,void 0,(function*(){const e=1==t?this.loader.Mushroom1Asset:this.loader.Mushroom2Asset,i=yield e.CloneModel(),n=new Le;for(let t=0;t<50;t++){n.set((2*Math.random()-1)*(this.worldSize/1.5),0,(2*Math.random()-1)*(this.worldSize/1.5));const t=yI.rand_int(5,9),s=new bI(e);s.MassLoader(i,t,n),this.mushrooms.push(s)}}))}MassDeadTreeLoader(){return kP(this,void 0,void 0,(function*(){const t=new Le,e=this.worldSize/2;for(let i=0;i<30;i++){const i=Math.random()*Math.PI*2,n=ne.randFloat(.4*e,1.5*e);t.set(n*Math.cos(i),yI.rand_int(0,1.5),n*Math.sin(i));const s=yI.rand_int(0,2),r=yI.rand_int(5,9),a=new wI(this.loader.DeadTreeAsset);yield a.MassLoader(r,t,s),this.deadtrees.push(a)}}))}MassGrassLoader(){return kP(this,void 0,void 0,(function*(){const t=new Le,e=this.worldSize/2;for(let i=0;i<1e3;i++){const i=Math.random()*Math.PI*2,n=ne.randFloat(.3*e,1.5*e);t.set(n*Math.cos(i),0,n*Math.sin(i));const s=yI.rand_int(0,2),r=yI.rand_int(4,5),a=new SI(this.loader.GrassAsset);yield a.MassLoader(r,t,s),this.grass.push(a)}}))}GltfLoad(){return kP(this,void 0,void 0,(function*(){return yield Promise.all([yield this.player.Loader(this.loader.MaleAsset,new Le(Du.StartPosition.x,Du.StartPosition.y,Du.StartPosition.z),"player"),yield this.portal.Loader(Du.DefaultPortalPosition),yield this.MassMushroomLoader(1),yield this.MassMushroomLoader(2),yield this.MassDeadTreeLoader(),yield this.materials.MassLoader(),yield this.npcs.NpcLoader(),yield this.farmer.FarmLoader(),yield this.carp.FurnLoader()]).then((()=>{this.gphysics.addPlayer(this.player),this.gphysics.add(this.npcs.Owner),this.gphysics.addLand(this.floor)}))}))}InitScene(){this.game.add(this.player.Meshs,this.floor.Meshs,this.portal.Meshs,this.skyBox.Meshs),this.deadtrees.forEach((t=>{this.game.add(t.Meshs)})),this.mushrooms.forEach((t=>{this.game.add(t.Meshs)})),this.npcs.InitScene(),this.Helper=new gk(this.game,this.light,this.player,this.playerCtrl,this.npcs,this.portal,this.floor,this.legos,this.camera,this.rayViewer,this.gphysics,this.canvas,this.eventCtrl,this.drop)}Despose(){this.game.dispose()}}var DP,LP=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};!function(t){t[t.Intro=0]="Intro",t[t.Long=1]="Long",t[t.Close=2]="Close",t[t.Play=3]="Play",t[t.EditPlay=4]="EditPlay",t[t.Brick=5]="Brick",t[t.Face=6]="Face",t[t.Weapon=7]="Weapon",t[t.Furniture=8]="Furniture",t[t.Farmer=9]="Farmer",t[t.Portal=10]="Portal",t[t.Lego=11]="Lego",t[t.NonLego=12]="NonLego",t[t.LegoDelete=13]="LegoDelete",t[t.CityView=14]="CityView",t[t.EditCity=15]="EditCity"}(DP||(DP={}));class OP{get Furnitures(){return this.factory.Furnitures}get Plants(){return this.factory.Plants}get Items(){return this.factory.Items}constructor(){this.factory=new PP,this.initFlag=!1,this.renderFlag=!1,this.loadingVisible=!0,this.canvas=this.factory.Canvas,this.currentScene=this.factory.Scene,this.eventCtrl=this.factory.EventCtrl,this.store=this.factory.ModelStore,this.physic=this.factory.Physics,this.loadingManager=this.factory.LoadingManager,this.eventCtrl.RegisterAppModeEvent(((t,e)=>{if(t==DP.Play)switch(e){case Lu.Start:this.loadingVisible=!1;break;case Lu.End:this.loadingVisible=!0}}))}init(){return LP(this,void 0,void 0,(function*(){if(this.initFlag)return!1;return document.querySelector("#progress-bar-container").style.display="flex",yield this.factory.GltfLoad(),this.factory.InitScene(),window.addEventListener("resize",(()=>this.resize())),window.addEventListener("keydown",(t=>{switch(t.code){case"ArrowUp":this.eventCtrl.OnKeyDownEvent(new ju);break;case"ArrowDown":this.eventCtrl.OnKeyDownEvent(new Wu);break;case"ArrowLeft":this.eventCtrl.OnKeyDownEvent(new Xu);break;case"ArrowRight":this.eventCtrl.OnKeyDownEvent(new qu)}switch(t.key){case"0":"hons.ghostwebservice.com"!=window.location.hostname&&this.eventCtrl.OnKeyDownEvent(new Yu);break;case"1":this.eventCtrl.OnKeyDownEvent(new zu);break;case"2":this.eventCtrl.OnKeyDownEvent(new Uu);break;case"3":this.eventCtrl.OnKeyDownEvent(new Fu);break;case"4":this.eventCtrl.OnKeyDownEvent(new Gu);break;case"5":this.eventCtrl.OnKeyDownEvent(new Vu);break;case" ":this.eventCtrl.OnKeyDownEvent(new Hu)}})),window.addEventListener("keyup",(t=>{switch(t.code){case"ArrowUp":this.eventCtrl.OnKeyUpEvent(new ju);break;case"ArrowDown":this.eventCtrl.OnKeyUpEvent(new Wu);break;case"ArrowLeft":this.eventCtrl.OnKeyUpEvent(new Xu);break;case"ArrowRight":this.eventCtrl.OnKeyUpEvent(new qu);break;case"Space":this.eventCtrl.OnKeyUpEvent(new Hu)}})),this.initFlag=!0,"hons.ghostwebservice.com"!=window.location.hostname&&this.eventCtrl.OnKeyDownEvent(new Yu),this.initCallbackFunc&&this.initCallbackFunc(!0),!0}))}RegisterInitEvent(t){this.initFlag?t(this.initFlag):this.initCallbackFunc=t}despose(){this.factory.Despose()}loop(){window.requestAnimationFrame((()=>{var t,e;null===(t=this.factory.Helper)||void 0===t||t.CheckStateBegin(),this.currentScene.play(),this.canvas.update(),this.physic.update(),null===(e=this.factory.Helper)||void 0===e||e.CheckStateEnd(),this.loop()}))}Setup(t){this.factory.GameCenter.Setup(t)}render(){if(this.renderFlag)return;this.renderFlag=!0,this.loop();document.querySelector("#progress-bar-container").style.display="none"}ChangeCharactor(t){this.factory.ModelStore.ChangeCharactor(t)}ChangeBrickInfo(t){this.eventCtrl.OnChangeBrickInfo(t)}ChangeTerrainInfo(t){this.eventCtrl.OnChangeTerrainInfo(t)}ModeChange(t,...e){this.eventCtrl.OnAppModeEvent(t,...e)}SendModeMessage(...t){this.eventCtrl.OnAppModeMessage(...t)}ModelStore(){return this.store.StoreModels()}SaveCity(){return this.store.SaveCity()}ModelClear(){this.eventCtrl.OnSceneClearEvent()}LoadModel(t,e,i){return LP(this,void 0,void 0,(function*(){this.eventCtrl.OnSceneClearEvent(),yield this.store.LoadModels(t,e,i)}))}LoadModelEmpty(t,e){return LP(this,void 0,void 0,(function*(){this.eventCtrl.OnSceneClearEvent(),yield this.store.LoadModelsEmpty(t,e)}))}LoadVillage(t,e){return LP(this,void 0,void 0,(function*(){this.eventCtrl.OnSceneClearEvent(),yield this.store.LoadVillage(t,e)}))}LoadCity(t,e,i){return LP(this,void 0,void 0,(function*(){yield this.store.LoadCity(t,e,i)}))}resize(){this.canvas.resize()}RegisterChangePlayerStatusEvent(t){this.eventCtrl.RegisterChangePlayerStatusEvent(t)}GetRandomBuff(){return this.factory.Buff.GetRandomBuff()}SelectRandomBuff(t){this.factory.Buff.SelectBuff(t)}GetDeckInfo(){return this.factory.ModelStore.Deck}}var NP=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class BP{constructor(t){this.url=t,this.active=!1,this.alarm=document.getElementById("alarm-msg"),this.alarmText=document.getElementById("alarm-msg-text"),this.confirm=document.getElementById("globalConfirm"),this.confirmText=document.getElementById("globalConfirmText"),this.confirmBtn=document.getElementById("globalConfirmBtn"),this.cancelBtn=document.getElementById("globalCancelBtn")}alarmOn(t){this.alarm.style.display="block",this.alarmText.innerHTML=t}alarmOff(){this.alarm.style.display="none"}confirmOn(t,e,i){this.confirm.style.display="block",this.confirmText.innerText=t,this.confirmBtn.innerText=e,this.confirmBtn.onclick=()=>{this.confirm.style.display="none",i()},this.cancelBtn.onclick=()=>{this.confirm.style.display="none"}}addHtml(t){document.querySelector("contents").insertAdjacentHTML("beforeend",t)}getParam(t){var e;const i=new URLSearchParams(window.location.search),n=encodeURIComponent(null!==(e=i.get(t))&&void 0!==e?e:"");return null==n||""==n?null:n}LoadHtml(...t){var e;return NP(this,void 0,void 0,(function*(){this.active=!0;const i=document.querySelector("contents");if(null==this.page)return yield fetch(this.url).then((t=>t.text())).then((e=>{var n;this.page=e,i.innerHTML=this.page+(null!==(n=t.join())&&void 0!==n?n:"")}));i.innerHTML=this.page+(null!==(e=t.join())&&void 0!==e?e:"")}))}ReleaseHtml(){this.active=!1;const t=document.querySelector("contents");t.hasChildNodes()&&t.replaceChildren()}}class zP{constructor(t,e){this.meta=t,this.from=e,this.profileVisible=!0}Init(){}UiOff(t){const e=document.getElementById("wrapper-profile"),i=document.getElementById("navibar"),n=document.getElementById("footer"),s=document.getElementById("health"),r=document.getElementById("invenBtn");r&&(r.style.display="block"),s&&(s.style.display="block"),e&&(e.style.display="none"),n.style.display="none",i.style.display="none",this.meta.ModeChange(t),this.profileVisible=!1;const a=document.getElementById("fullscreen");/iPone|iPad|iPod|Android/i.test(window.navigator.userAgent)&&a&&(a.innerText="fullscreen_exit",document.documentElement.requestFullscreen().catch((t=>{a.innerText="fullscreen"})))}UiOn(){const t=document.getElementById("wrapper-profile"),e=document.getElementById("navibar"),i=document.getElementById("footer"),n=document.getElementById("health"),s=document.getElementById("invenBtn");s&&(s.style.display="none"),n&&(n.style.display="none"),t&&(t.style.display="block",t.style.opacity="0",Vg.to(t,{duration:2,autoAlpha:1,delay:1}),i.style.display="block",i.style.opacity="0",Vg.to(i,{duration:2,autoAlpha:1,delay:1})),e.style.display="block",this.meta.ModeChange(this.from,!1),this.profileVisible=!0}VisibleUi(t,e){const i=document.getElementById("wrapper-profile"),n=document.getElementById("navibar"),s=document.getElementById("footer"),r=document.getElementById("health"),a=document.getElementById("invenBtn");this.profileVisible?(i.style.display="none",s.style.display="none",n.style.display="none",this.meta.ModeChange(e),r&&(r.style.display="block"),a&&(a.style.display="block"),this.profileVisible=!1):(i.style.display="block",s.style.display="block",n.style.display="block",this.meta.ModeChange(t,!1),r&&(r.style.display="none"),a&&(a.style.display="none"),this.profileVisible=!0)}}var UP=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class FP extends BP{constructor(t,e,i,n){super(n),this.blockStore=t,this.session=e,this.meta=i,this.m_masterAddr="",this.targetHonEmail="",this.profileVisible=!0,this.fullscreen=!1,this.honsData=[],this.ui=new zP(this.meta,DP.Close),this.popupVisible=!1}drawHtml(t){const e={Email:decodeURIComponent(t.email),Nickname:t.id,Password:""},i=document.getElementById("nickname");if(null==i)return;i.innerHTML=e.Nickname;const n=document.getElementById("email");null!=n&&(n.innerHTML=e.Email,this.blockStore.FetchProfile(window.MasterAddr,t.email).then((t=>{""!=t.file&&"file"in t&&fetch("data:image/jpg;base64,"+t.file).then((t=>t.blob())).then((t=>{const e=URL.createObjectURL(t),i=new Image;i.src=e,i.className="twPc-avatarImg";const n=document.getElementById("bg-profile");null!=n&&(n.innerHTML="",n.appendChild(i))}))})))}requestUserInfo(t){const e=this.m_masterAddr+"/glambda?txid="+encodeURIComponent(o);fetch(e+"&table=member&key="+encodeURIComponent(t)).then((t=>t.json())).then((t=>this.drawHtml(t))).catch((()=>{}))}drawHtmlHon(t,e){return UP(this,void 0,void 0,(function*(){if(!this.active)return;let i=this.blockStore.LoadHonView(e);null==i&&(i=yield f(this.blockStore,t,e),this.blockStore.SaveHonView(e,i)),this.honsData.push({id:e,email:t.email,html:i})}))}honsResult(t){const e=t.result;return 0==e.length?[]:e}RequestHon(t){return UP(this,void 0,void 0,(function*(){if(0==t.length)return;yield Promise.all(t.map((t=>UP(this,void 0,void 0,(function*(){yield this.blockStore.FetchHon(this.m_masterAddr,t).then((e=>this.drawHtmlHon(e,btoa(t)))).catch((t=>{}))})))));let e="";this.honsData.forEach((t=>{e+=t.html}));const i=document.getElementById("feeds");i&&(i.innerHTML=e),this.ViewLoadingSpinner(!1)}))}RequestHons(t){this.ViewLoadingSpinner(!0),this.m_masterAddr=window.MasterAddr;const e=`\n        ${this.m_masterAddr}/glambda?txid=${encodeURIComponent("nPyKGx9M0eetb8pDFFF/q9ebTl3bLG7hloYhEb2gH7U=")}&table=feedlink&key=${t}`;fetch(e).then((t=>t.json())).then((t=>this.honsResult(t))).then((t=>this.RequestHon(t)))}Follow(){document.getElementById("followBtn").onclick=()=>{const t=this.targetHonEmail,e=this.session.GetHonUser();if(!this.session.CheckLogin()||e.Email==t)return;const i=new FormData;i.append("key",e.Email),i.append("email",e.Email),i.append("password",e.Password),i.append("targetkey",t);const n=`\n                ${this.m_masterAddr}/glambda?txid=${encodeURIComponent("SIEMAHD4UoD6wDfQns3Xz5TPhlOTNyjCOVIgpQF7OIk=")}`;fetch(n,{method:"POST",cache:"no-cache",headers:{},body:i}).then((t=>t.json())).then((t=>{}))}}GetFollowerList(){const t=this.targetHonEmail,e=`\n                ${this.m_masterAddr}/glambda?txid=${encodeURIComponent(l)}&table=follower&key=${t}`;fetch(e).then((t=>t.json())).then((t=>{t.result.constructor==Array&&t.result.forEach((t=>{this.makeFollowerHtml(t)}))}))}makeFollowerHtml(t){this.active&&this.blockStore.FetchProfile(window.MasterAddr,t).then((t=>{const e=t.id+t.time.toString();document.getElementById("followerlist").insertAdjacentHTML("afterend",`\n                <div class="row p-1 border-top handcursor" onclick="ClickLoadPage('hondetail', false, '&email=${t.email}')">\n                    <div class="col-auto">\n                            <span id="${e}" class="m-1"></span>\n                    </div>\n                    <div class="col">\n                        <b>${t.id}</b> @${t.email}\n                    </div>\n                </div>\n                `),""!=t.file&&fetch("data:image/jpg;base64,"+t.file).then((t=>t.blob())).then((t=>{const i=URL.createObjectURL(t),n=new Image;n.src=i,n.className="profile-sm";const s=document.getElementById(e);s.innerHTML="",s.appendChild(n)}))}))}CanvasRenderer(t){document.getElementById("avatar-bg").style.display="block";document.getElementById("playBtn").onclick=()=>{window.ClickLoadPage("play",!1,`&email=${t}`)},this.meta.RegisterInitEvent((()=>{this.alarmOn("."),this.ui.UiOn();const e=this.blockStore.GetModel(this.session.UserId);this.blockStore.FetchModel(this.m_masterAddr,t).then((t=>UP(this,void 0,void 0,(function*(){yield this.meta.LoadModel(t.models,t.id,null==e?void 0:e.models),this.alarmOff()})))).then((()=>{this.meta.ModeChange(DP.Close)})).then((()=>{this.meta.render()})).catch((()=>UP(this,void 0,void 0,(function*(){this.alarmOff(),yield this.meta.LoadModelEmpty(t,null==e?void 0:e.models),this.meta.ModeChange(DP.Close)}))))}));document.getElementById("avatar-space").style.height=window.innerHeight-230+"px"}PopupMenu(t){const e=document.getElementById("menuBtn"),i=document.getElementById("popmenu");e.onclick=()=>{this.popupVisible?(i.style.display="none",this.popupVisible=!1):(i.style.display="block",this.popupVisible=!0)};document.getElementById("pop_logout").onclick=()=>{this.session.SignOut()};document.getElementById("edithome").onclick=()=>{window.ClickLoadPage("edithome",!1,"&email="+t)};document.getElementById("editcity").onclick=()=>{window.ClickLoadPage("newcity",!1,"&email="+t)}}ViewLoadingSpinner(t){const e=document.getElementById("loading");e&&(e.innerHTML=t?'\n            <div class="spinner-grow text-primary" role="status">\n                <span class="visually-hidden"></span>\n            </div>\n        ':"")}Run(t){return UP(this,void 0,void 0,(function*(){yield this.LoadHtml(),this.ui.Init(),this.m_masterAddr=t;const e=this.getParam("email");return null!=e&&(this.targetHonEmail=e,window.scrollTo({top:0,left:0,behavior:"auto"}),this.requestUserInfo(e),this.RequestHons(e),this.Follow(),this.GetFollowerList(),this.CanvasRenderer(e),this.PopupMenu(e),!0)}))}Release(){this.honsData.length=0;document.getElementById("footer").style.display="block",this.ReleaseHtml()}}var GP=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class VP extends BP{constructor(t,e,i,n){super(n),this.blockStore=t,this.session=e,this.meta=i,this.requestCount=5,this.ui=new zP(this.meta,DP.Long),this.m_masterAddr="",this.loadedCount=0,this.targetLoadCount=0}warningMsg(t){const e=document.getElementById("information");null!=e&&(e.innerHTML=t)}honsResult(t){if("json"in t){return JSON.parse(t.json)}return this.warningMsg("Loading "),[]}drawHtmlConnectMaster(){const t=document.getElementById("connect");null!=t&&(t.innerHTML=`Connected Master - \n        ${window.MasterNode.User.Nickname}`)}makeHtmlHon(t,e){return GP(this,void 0,void 0,(function*(){if(this.loadedCount++,"result"in t||!this.active)return;let i=this.blockStore.LoadHonView(e);null==i&&(i=yield f(this.blockStore,t,e),this.blockStore.SaveHonView(e,i));const n=document.getElementById("feeds");n&&n.insertAdjacentHTML("beforeend",i)}))}RequestHon(t){return GP(this,void 0,void 0,(function*(){yield Promise.all(t.map((t=>GP(this,void 0,void 0,(function*(){yield this.blockStore.FetchHon(this.m_masterAddr,atob(t)).then((e=>this.makeHtmlHon(e,t)))}))))),this.ViewLoadingSpinner(!1)}))}RequestHons(t,e){this.ViewLoadingSpinner(!0),this.m_masterAddr=window.MasterAddr;const i=this.m_masterAddr,n=this.getParam("tag"),r=null==n?"feeds":n,a=`\n        ${i}/glambda?txid=${encodeURIComponent(s)}&table=${r}&start=${t}&count=${e}`;fetch(a).then((t=>t.json())).then((t=>this.honsResult(t))).then((e=>{this.targetLoadCount=t+e.length,this.CheckReloading(e.length),this.RequestHon(e)})).catch((()=>{this.warningMsg("Server   ;;")}))}CheckReloading(t){const e=document.getElementById("reload");this.requestCount>t?e.style.display="none":e.style.display="block"}ViewLoadingSpinner(t){const e=document.getElementById("loading");e&&(e.innerHTML=t?'\n            <div class="spinner-grow text-primary" role="status">\n                <span class="visually-hidden"></span>\n            </div>\n        ':"")}CanvasRenderer(){document.getElementById("avatar-bg").style.display="block",this.alarmOn("  ."),this.meta.RegisterInitEvent((()=>{this.meta.render();document.getElementById("avatar-space").style.height=window.innerHeight-230+"px",this.ui.UiOn()}));const t=this.blockStore.GetModel(this.session.UserId);this.blockStore.FetchModels(this.m_masterAddr).then((e=>GP(this,void 0,void 0,(function*(){yield this.meta.LoadVillage(e,null==t?void 0:t.models),this.alarmOff()}))));document.getElementById("playBtn").onclick=()=>{window.ClickLoadPage("play",!1)}}Run(t){return GP(this,void 0,void 0,(function*(){yield this.LoadHtml(),this.ui.Init(),this.loadedCount=0,this.m_masterAddr=t,this.drawHtmlConnectMaster(),this.CanvasRenderer(),this.RequestHons(this.loadedCount,this.requestCount);const e=document.getElementById("tagtitle"),i=document.getElementById("newfeed"),n=this.getParam("tag");if(null==n)e.innerText="#";else{i.onclick=()=>{window.ClickLoadPage("newhon",!1,`&tag=${n}`)};try{e.innerText=decodeURIComponent(atob(n))}catch(t){e.innerText=decodeURIComponent(atob(decodeURIComponent(n)))}}return document.getElementById("reload").onclick=()=>{this.loadedCount==this.targetLoadCount&&this.RequestHons(this.loadedCount,this.requestCount)},!0}))}Release(){this.loadedCount=0,this.ReleaseHtml()}}var HP=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class jP extends BP{constructor(t,e,i){super(i),this.blockStore=t,this.session=e,this.m_masterAddr=""}drawHtmlUserReply(){this.blockStore.FetchProfile(window.MasterAddr,this.session.GetHonUser().Email).then((t=>{""!=t.file&&fetch("data:image/jpg;base64,"+t.file).then((t=>t.blob())).then((t=>{const e=URL.createObjectURL(t),i=new Image;i.src=e,i.className="profile-sm";const n=document.getElementById("userId");n.innerHTML="",n.appendChild(i)}))}))}drawHtmlReply(){this.blockStore.FetchProfile(window.MasterAddr,this.session.GetHonUser().Email).then((t=>{"file"in t&&fetch("data:image/jpg;base64,"+t.file).then((t=>t.blob())).then((t=>{const e=URL.createObjectURL(t),i=new Image;i.src=e,i.className="profile-sm";const n=document.getElementById("userId");n.innerHTML="",n.appendChild(i)}))}))}drawHtmlHon(t,e,i){return HP(this,void 0,void 0,(function*(){const n=document.getElementById(i);if(null==n)return;const s=yield f(this.blockStore,t,e);n.insertAdjacentHTML("afterend",s)}))}warningMsg(t){const e=document.getElementById("information");null!=e&&(e.innerHTML=t)}newHonResult(t){if("null"==t.result)this.warningMsg(" ");else{const t=this.getParam("key");window.ClickLoadPage("hon",!1,`&key=${t}`)}}RequestNewReplyHon(t){const e=this.m_masterAddr,i=this.session.GetHonUser(),n=document.getElementById("inputContent"),s=e+"/glambda?txid="+encodeURIComponent("bhIPesNmn1bFj007f+/gjNB8XxhWFvHc8zHvOCcgE+U="),r=new FormData;r.append("key",i.Email),r.append("email",i.Email),r.append("password",i.Password),r.append("id",i.Nickname),r.append("targetkey",decodeURIComponent(t)),r.append("time",(new Date).getTime().toString()),r.append("table","feeds"),r.append("content",null==n?void 0:n.value),fetch(s,{method:"POST",cache:"no-cache",headers:{},body:r}).then((t=>t.json())).then((t=>this.newHonResult(t))).catch((()=>{this.warningMsg("Server   ;;")}))}RequestHon(t){const e=atob(decodeURIComponent(t));return this.blockStore.FetchHon(this.m_masterAddr,e).then((e=>this.drawHtmlHon(e,t,"feed")))}RequestHonReply(t){const e=this.m_masterAddr+"/glambda?txid="+encodeURIComponent(r)+"&table=replyfeeds&key=";return fetch(e+t).then((t=>t.json())).then((e=>HP(this,void 0,void 0,(function*(){return yield this.drawHtmlHon(e,t,"reply")})))).then((()=>this.warningMsg("")))}RequestHonsReplys(t){this.m_masterAddr=window.MasterAddr;const e=`\n        ${this.m_masterAddr}/glambda?txid=${encodeURIComponent(h)}&table=replylink&key=${t}`;fetch(e).then((t=>t.json())).then((t=>{t.result.constructor==Array?t.result.forEach((t=>HP(this,void 0,void 0,(function*(){yield this.RequestHonReply(t)})))):this.warningMsg("")}))}CheckReplyForm(){if(!this.session.CheckLogin()){return document.getElementById("replyform").innerHTML="<b>login</b>     .",!1}return!0}canvasVisible(t){document.getElementById("avatar-bg").style.display=t?"block":"none"}Run(t){return HP(this,void 0,void 0,(function*(){yield this.LoadHtml(),this.m_masterAddr=t;const e=this.getParam("key");if(null==e)return!1;this.RequestHon(e).then((()=>{if(this.drawHtmlUserReply(),this.RequestHonsReplys(e),!this.CheckReplyForm())return!1}));const i=document.getElementById("replyBtn");return i.onclick=()=>{i.disabled=!0,this.RequestNewReplyHon(e)},!0}))}Release(){this.canvasVisible(!0),this.ReleaseHtml()}}var WP=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class XP extends BP{constructor(t,e,i,n){super(n),this.sdai=t,this.session=e,this.ipc=i,this.sdai.Print=this.printLog,this.m_masterAddr=""}MsgHandler(t,e){this.sdai.MsgHandler(t,e)}printLog(t){document.getElementById("log").innerHTML=`\n                ${t}\n            `}warningMsg(t){this.alarmOff();const e=document.getElementById("information");null!=e&&(e.innerHTML=t)}newHonResult(t){this.alarmOff(),"null"==t.result?this.warningMsg(" "):window.ClickLoadPage("hons",!1)}RequestNewHon(){const t=this.m_masterAddr,e=this.session.GetHonUser(),i=document.getElementById("inputContent"),n=t+"/glambda?txid="+encodeURIComponent("5ie8zKOfGRGkbEBo/N5wuL5jzIfxwWq9BgzoLqz19K8=");this.alarmOn(".");const s=document.getElementById("thread"),r="#"+(""==s.value?"daliy log":s.value.replace("#","")),a=new FormData;a.append("file",this.sdai.Image),a.append("key",encodeURIComponent(e.Email)),a.append("email",encodeURIComponent(e.Email)),a.append("password",e.Password),a.append("id",e.Nickname),a.append("time",(new Date).getTime().toString()),a.append("table","feeds"),a.append("tag",btoa(encodeURIComponent(r))),a.append("content",null==i?void 0:i.value),fetch(n,{method:"POST",cache:"no-cache",headers:{},body:a}).then((t=>t.json())).then((t=>this.newHonResult(t))).catch((()=>{this.warningMsg("Server   ;;")}))}RequestNewCityHon(){var t;const e=this.m_masterAddr,i=this.session.GetHonUser(),n=document.getElementById("inputContent"),s=e+"/glambda?txid="+encodeURIComponent("V09zf4GdJt96cvgscme8qG7yt2OQ/cSeqi3jCzJeqVA="),r=null!==(t=super.getParam("city"))&&void 0!==t?t:"ghost";this.alarmOn(".");const a=document.getElementById("thread"),o="#"+(""==a.value?"daliy log":a.value.replace("#","")),h=new FormData;h.append("file",this.sdai.Image),h.append("key",encodeURIComponent(i.Email)),h.append("email",encodeURIComponent(i.Email)),h.append("password",i.Password),h.append("id",i.Nickname),h.append("table","cityfeeds@"+r),h.append("time",(new Date).getTime().toString()),h.append("tag",btoa(encodeURIComponent(o))),h.append("content",null==n?void 0:n.value),fetch(s,{method:"POST",cache:"no-cache",headers:{},body:h}).then((t=>t.json())).then((t=>this.newHonResult(t))).catch((()=>{this.warningMsg("Server   ;;")}))}getParam(){var t;const e=new URLSearchParams(window.location.search),i=decodeURIComponent(atob(null!==(t=e.get("tag"))&&void 0!==t?t:"")).replace("#","");return""==i?null:i}Run(t){const e=Object.create(null,{getParam:{get:()=>super.getParam}});var i;return WP(this,void 0,void 0,(function*(){yield this.LoadHtml(),window.scrollTo(0,0);const n=document.getElementById("feedBtn");this.session.CheckLogin()?n.onclick=()=>{n.disabled=!0;const t=e.getParam.call(this,"from");t&&"hon"!=t?"city"==t&&this.RequestNewCityHon():this.RequestNewHon()}:(n.innerText="  (Login    .)",n.disabled=!0);const s=document.getElementById("inputContent");s.onfocus=()=>{"Enter text"==s.value&&(s.value="")},this.ipc.IsOpen()||this.ipc.OpenChannel(window.MasterWsAddr+"/ws"),this.m_masterAddr=t;return document.getElementById("thread").value=null!==(i=this.getParam())&&void 0!==i?i:"",this.sdai.drawhtml(),!0}))}Release(){this.ReleaseHtml(),this.sdai.release()}}function qP(t){function e(t,e){var i=(65535&t)+(65535&e);return(t>>16)+(e>>16)+(i>>16)<<16|65535&i}function i(t,e){return t>>>e|t<<32-e}function n(t,e){return t>>>e}function s(t,e,i){return t&e^~t&i}function r(t,e,i){return t&e^t&i^e&i}function a(t){return i(t,2)^i(t,13)^i(t,22)}function o(t){return i(t,6)^i(t,11)^i(t,25)}function h(t){return i(t,7)^i(t,18)^n(t,3)}function l(t){return i(t,17)^i(t,19)^n(t,10)}return function(t){for(var e="0123456789abcdef",i="",n=0;n<4*t.length;n++)i+=e.charAt(t[n>>2]>>8*(3-n%4)+4&15)+e.charAt(t[n>>2]>>8*(3-n%4)&15);return i}(function(t,i){var n,c,u,d,p,m,f,g,v,y,x=new Array(1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298),b=new Array(1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225),_=new Array(64);t[i>>5]|=128<<24-i%32,t[15+(i+64>>9<<4)]=i;for(var w=0;w<t.length;w+=16){n=b[0],c=b[1],u=b[2],d=b[3],p=b[4],m=b[5],f=b[6],g=b[7];for(var M=0;M<64;M++)_[M]=M<16?t[M+w]:e(e(e(l(_[M-2]),_[M-7]),h(_[M-15])),_[M-16]),v=e(e(e(e(g,o(p)),s(p,m,f)),x[M]),_[M]),y=e(a(n),r(n,c,u)),g=f,f=m,m=p,p=e(d,v),d=u,u=c,c=n,n=e(v,y);b[0]=e(n,b[0]),b[1]=e(c,b[1]),b[2]=e(u,b[2]),b[3]=e(d,b[3]),b[4]=e(p,b[4]),b[5]=e(m,b[5]),b[6]=e(f,b[6]),b[7]=e(g,b[7])}return b}(function(t){for(var e=Array(),i=0;i<8*t.length;i+=8)e[i>>5]|=(255&t.charCodeAt(i/8))<<24-i%32;return e}(t=function(t){t=t.replace(/\r\n/g,"\n");for(var e="",i=0;i<t.length;i++){var n=t.charCodeAt(i);n<128?e+=String.fromCharCode(n):n>127&&n<2048?(e+=String.fromCharCode(n>>6|192),e+=String.fromCharCode(63&n|128)):(e+=String.fromCharCode(n>>12|224),e+=String.fromCharCode(n>>6&63|128),e+=String.fromCharCode(63&n|128))}return e}(t)),8*t.length))}var YP=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class JP extends BP{constructor(t){super(t),this.m_masterAddr=""}warningMsg(t){this.alarmOff();const e=document.getElementById("information");null!=e&&(e.innerHTML=t)}signupResult(t){this.alarmOff(),"null"==t.result?this.warningMsg("Signup "):"result"in t?this.warningMsg(t.result):window.ClickLoadPage("signin",!1)}RequestSignup(){const t=this.m_masterAddr,i=document.getElementById("inputEmail"),n=null==i?void 0:i.value;""==n&&this.warningMsg("email is empty");const s=document.getElementById("inputPassword"),r=qP(null==s?void 0:s.value),a=document.getElementById("inputId"),o=null==a?void 0:a.value,h=t+"/glambda?txid="+encodeURIComponent(e);this.alarmOn(".");const l=new FormData;l.append("key",encodeURIComponent(n)),l.append("email",encodeURIComponent(n)),l.append("password",r),l.append("id",o),fetch(h,{method:"POST",cache:"no-cache",headers:{},body:l}).then((t=>t.json())).then((t=>this.signupResult(t))).catch((()=>{this.warningMsg("Server   ;;")}))}Run(t){return YP(this,void 0,void 0,(function*(){yield this.LoadHtml(),this.m_masterAddr=t;document.getElementById("txLink").innerHTML=`\n            <a class="handcursor" href="http://ghostwebservice.com/?pageid=txdetail&txid=${encodeURIComponent(e)}">\n                gLambda Code \n            </a> `;return document.getElementById("signupBtn").onclick=()=>this.RequestSignup(),!0}))}Release(){this.ReleaseHtml()}}var $P=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class KP extends BP{constructor(t,e){super(e),this.session=t,this.m_user={Email:"",Nickname:"",Password:""},this.m_masterAddr=""}warningMsg(t){this.alarmOff();const e=document.getElementById("information");null!=e&&(e.innerHTML=t)}loginResult(t){this.alarmOff(),"email"in t?(this.session.SignIn({Email:t.email,Nickname:t.id,Password:this.m_user.Password}),window.ClickLoadPage("hondetail",!1,`&email=${t.email}`)):this.warningMsg("ID Password  .")}RequestSignin(){const e=this.m_masterAddr,i=document.getElementById("inputEmail"),n=null==i?void 0:i.value;""==n&&this.warningMsg("email is empty");const s=document.getElementById("inputPassword"),r=qP(null==s?void 0:s.value),a=e+"/glambda?txid="+encodeURIComponent(t);this.m_user.Email=n,this.m_user.Password=r,this.alarmOn(".");const o=new FormData;o.append("key",encodeURIComponent(n)),o.append("email",encodeURIComponent(n)),o.append("password",r),fetch(a,{method:"POST",cache:"no-cache",headers:{},body:o}).then((t=>t.json())).then((t=>this.loginResult(t))).catch((()=>{this.warningMsg("Server   ;;")}))}Run(t){return $P(this,void 0,void 0,(function*(){yield this.LoadHtml(),this.m_masterAddr=t;return document.getElementById("signinBtn").onclick=()=>this.RequestSignin(),!0}))}Release(){this.ReleaseHtml()}}var ZP=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};const QP={Email:"",Nickname:"",Password:""},tD="HonUser";class eD{constructor(t){this.blockStore=t,this.m_user={Email:"",Nickname:"",Password:""},this.m_signinFlag=!1}get UserId(){return this.m_user.Email}GetHonUser(){return this.m_user}RequestSignIn(e,i,n){const s=window.MasterAddr+"/glambda?txid="+encodeURIComponent(t),r=new FormData;return r.append("key",e),r.append("email",e),r.append("password",i),fetch(s,{method:"POST",cache:"no-cache",headers:{},body:r}).then((t=>t.json())).then((t=>n(t)))}drawHtmlLoginUi(){if(this.m_signinFlag){document.getElementById("sessioninfo").innerHTML=`\n                <a href="javascript:void(0)" onclick="ClickLoadPage('hondetail', true, '&email=${this.m_user.Email}')"> ${this.m_user.Nickname} &nbsp; </a>  \n            `}}DrawHtmlSessionInfo(){return ZP(this,void 0,void 0,(function*(){const t=sessionStorage.getItem(tD);if(null==t||0!=this.m_signinFlag)this.drawHtmlLoginUi();else{const e=JSON.parse(t);yield this.RequestSignIn(e.Email,e.Password,(t=>ZP(this,void 0,void 0,(function*(){"email"in t&&(this.SignIn({Email:t.email,Nickname:t.id,Password:e.Password}),this.drawHtmlLoginUi(),yield this.blockStore.FetchModel(window.MasterAddr,t.email))}))))}}))}SignIn(t){this.m_user=t,this.m_signinFlag=!0,sessionStorage.setItem(tD,JSON.stringify(t))}SignOut(){this.m_user=QP,this.m_signinFlag=!1,sessionStorage.removeItem(tD),location.reload()}CheckLogin(){return this.m_signinFlag}}var iD=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class nD extends BP{constructor(t){super(t),this.m_masterAddr=""}warningMsg(t){const e=document.getElementById("information");null!=e&&(e.innerHTML=t)}RequestUpload(){const t=this.m_masterAddr,e=document.getElementById("inputFile");if(null==e.files)return;const i=new FormData;i.append("key",""),i.append("files",e.files[0]);const n=t+"/glambda?txid="+encodeURIComponent("");fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:i}).then((t=>t.json())).then((t=>{})).catch((()=>{this.warningMsg("Server   ;;")}))}Run(t){return iD(this,void 0,void 0,(function*(){yield this.LoadHtml(),this.m_masterAddr=t;document.getElementById("txLink").innerHTML=`\n            <a class="handcursor" onclick='ClickLoadPage("txdetail", false, "&txid=${encodeURIComponent("")}")'>\n                \n            </a> `;return document.getElementById("uploadBtn").onclick=()=>this.RequestUpload(),!0}))}Release(){this.ReleaseHtml()}}var sD=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class rD extends BP{constructor(t,e,i,n){super(n),this.sdai=t,this.session=e,this.ipc=i,this.sdai.Print=this.printLog,this.m_masterAddr=""}MsgHandler(t,e){this.sdai.MsgHandler(t,e)}printLog(t){document.getElementById("log").innerHTML=`\n                ${t}\n            `}requestResult(t){"result"in t?window.ClickLoadPage("hondetail",!1,`&email=${this.session.UserId}`):this.printLog(t)}uploadImage(){if(!this.session.CheckLogin())return void this.printLog("need to sign in");const t=this.session.GetHonUser(),e=new FormData;e.append("file",this.sdai.Image),e.append("key",t.Email),e.append("email",t.Email),e.append("password",t.Password),e.append("id",t.Nickname),e.append("time",(new Date).getTime().toString()),e.forEach((t=>{}));const i=window.MasterAddr+"/glambda?txid="+encodeURIComponent("zdER15Xm3UHCouCRy3W/pVpkqDV72BK04jPkLroP75U=");fetch(i,{method:"POST",cache:"no-cache",headers:{},body:e}).then((t=>t.json())).then((t=>this.requestResult(t)))}Run(){return sD(this,void 0,void 0,(function*(){yield this.LoadHtml(),this.ipc.IsOpen()||this.ipc.OpenChannel(window.MasterWsAddr+"/ws");return document.getElementById("uploadBtn").onclick=()=>this.uploadImage(),this.session.CheckLogin()||this.printLog("sign in   ."),this.sdai.drawhtml(),!0}))}Release(){this.ReleaseHtml(),this.sdai.release()}}class aD{constructor(t){this.curId="",this.objs={},t.RegisterMsgHandler("close",(t=>{this.objs[this.curId].MsgHandler("close",t)})),t.RegisterMsgHandler("generateLog",(t=>{this.objs[this.curId].MsgHandler("generateLog",t)})),t.RegisterMsgHandler("reply_generateImage",(t=>{this.objs[this.curId].MsgHandler("reply_generateImage",t)}))}RegisterClient(t,e){this.objs[t]=e}Activate(t){this.curId=t}}var oD=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class hD extends BP{constructor(t,e,i){super(i),this.blockStore=t,this.meta=e,this.targetloadCnt=0,this.currenloadCnt=0,this.userlist=[],this.ui=new zP(this.meta,DP.Intro),this.masterAddr="",this.firstLoading=!1}tagResult(t){if("json"in t){return JSON.parse(t.json)}return[]}drawHtmlTaglist(t){const e=document.getElementById("taglist");let i="\n        <span class='badge bg-primary handcursor select-disable' onclick=\"ClickLoadPage('hons', false)\">#</span>\n        <span class='badge bg-info handcursor select-disable' onclick=\"ClickLoadPage('newhon', false)\">#AI </span>\n        ";t.forEach((t=>{i+=`\n            <span class='badge bg-primary handcursor select-disable' onclick="ClickLoadPage('hons', false, '&tag=${atob(t)}')">\n            ${decodeURIComponent(atob(atob(t)))}\n            </span>\n            `})),e&&(e.innerHTML=i)}makeHtmlUserInfo(t){return oD(this,void 0,void 0,(function*(){if(this.currenloadCnt++,"file"in t){let e="";""!=t.file&&"file"in t?yield fetch("data:image/jpg;base64,"+t.file).then((t=>t.blob())).then((t=>{e=URL.createObjectURL(t)})):e="static/img/ghost_background_black.png";const i=`\n                <div class="container p-2">\n                <div class="row p-1 border rounded handcursor" onclick="ClickLoadPage('hondetail', false, '&email=${t.email}')">\n                    <div class="col-auto">\n                            <span class="m-1"><img class="profile-sm" src="${e}"></span>\n                    </div>\n                    <div class="col">\n                        <b>${t.id}</b> @${t.email} <img src="static/img/confirm.png">\n                    </div>\n                </div>\n                </div>\n                `;this.userlist.push(i)}if(this.targetloadCnt==this.currenloadCnt){const t=document.getElementById("loadspinner");t&&(t.style.display="none")}}))}drawHtmlUserInfo(){let t='<span style="font-size: 20px;"><b> Hon </b></span>';this.userlist.forEach((e=>{t+=e}));document.getElementById("userlist").innerHTML=t}RequestTaglist(t){const e=`\n        ${window.MasterAddr}/glambda?txid=${encodeURIComponent(i)}&table=taglist&start=0&count=${t}`;fetch(e).then((t=>t.json())).then((t=>this.tagResult(t))).then((t=>this.drawHtmlTaglist(t)))}RequestUserInfo(t){const e=window.MasterAddr;this.targetloadCnt=t.length,this.currenloadCnt=0;const i=t.map((t=>oD(this,void 0,void 0,(function*(){const i=t;yield this.blockStore.FetchProfile(e,i).then((t=>this.makeHtmlUserInfo(t)))}))));Promise.all(i).then((()=>this.drawHtmlUserInfo()))}RequestUserlist(){document.getElementById("userlist").innerHTML='<span style="font-size: 20px;"><b> Hon </b></span>',this.RequestUserInfo(["ghost"])}disableMeta(){document.getElementById("avatar-bg").style.display="none";document.getElementById("progress-bar-container").style.display="none";document.getElementById("joypad_buttons").style.display="none"}CanvasRenderer(){const t="ghost";document.getElementById("avatar-bg").style.display="block",this.alarmOn(".");const e=document.getElementById("playBtn");e&&(e.onclick=()=>{window.ClickLoadPage("play",!1,`&email=${t}`)}),this.meta.RegisterInitEvent((()=>{const e=this.blockStore.GetModel(t);this.blockStore.FetchModel(this.masterAddr,t).then((t=>oD(this,void 0,void 0,(function*(){yield this.meta.LoadModel(t.models,t.id,null==e?void 0:e.models)})))).then((()=>{this.meta.render(),this.alarmOff(),this.firstLoading?this.ui.UiOn():(this.DrawIntro(),this.firstLoading=!0)})).catch((()=>oD(this,void 0,void 0,(function*(){this.alarmOff(),yield this.meta.LoadModelEmpty(t,null==e?void 0:e.models),this.meta.ModeChange(DP.Close)}))))}));document.getElementById("view-space").style.height=window.innerHeight-250+"px"}DrawIntro(){const t=document.getElementById("footer");t&&(t.style.display="none"),this.meta.ModeChange(DP.Intro);const e=document.getElementById("citybigtitle");e&&(e.innerText="Hons.Multiverse",e.style.fontSize="xxx-large");const i=Vg.timeline();i.add(Vg.to(e,{duration:2,opacity:1})),i.add(Vg.to(e,{duration:2,opacity:0,delay:1,onComplete:()=>{e&&(e.innerText="  \n.",e.style.fontSize="x-large")}})),i.add(Vg.to(e,{duration:2,opacity:1})),i.add(Vg.to(e,{duration:2,opacity:0,delay:1,onComplete:()=>{this.ui.UiOn(),t&&(t.style.display="block")}}))}loadTutorial(){return oD(this,void 0,void 0,(function*(){yield fetch("views/tutorial/sns.html").then((t=>t.text())).then((t=>{document.getElementById("tutorial").insertAdjacentHTML("beforeend",t)})),yield fetch("views/tutorial/ai.html").then((t=>t.text())).then((t=>{document.getElementById("tutorial").insertAdjacentHTML("beforeend",t)})),yield fetch("views/tutorial/play.html").then((t=>t.text())).then((t=>{document.getElementById("tutorial").insertAdjacentHTML("beforeend",t)})),yield fetch("views/tutorial/interior.html").then((t=>t.text())).then((t=>{document.getElementById("tutorial").insertAdjacentHTML("beforeend",t)})),yield fetch("views/tutorial/farm.html").then((t=>t.text())).then((t=>{document.getElementById("tutorial").insertAdjacentHTML("beforeend",t)}))}))}Run(t){return oD(this,void 0,void 0,(function*(){return yield this.LoadHtml(),this.masterAddr=t,this.disableMeta(),this.RequestTaglist(20),this.RequestUserlist(),this.CanvasRenderer(),this.loadTutorial(),!0}))}Release(){this.ReleaseHtml(),this.userlist.length=0}}class lD{constructor(t,e){this.meta=t,this.editor=e,this.visible=!1,this.firstloading=!1,this.plantDb=this.meta.Plants}toggle(){this.visible?(this.unbinding(),this.visible=!1):(this.binding(),this.visible=!0)}binding(){const t=document.getElementById("plantctrl");if(t.style.display="block",this.firstloading)return;this.firstloading=!0;let e="",i=0;this.plantDb.Items.forEach((t=>{e+=`\n    <div class="row handcursor" id="plantslot${i++}">\n        <div class="col-auto ms-1 me-0 pb-1">\n            <div class="rounded inven_slot p-1">\n                <img src="assets/icons/Misc/Crate.png">\n            </div>\n        </div>\n        <div class="col p-1"> ${t.namekr} .</div>\n    </div>\n            `})),t.insertAdjacentHTML("beforeend",e),i=0,this.plantDb.Items.forEach((e=>{document.getElementById("plantslot"+i).onclick=()=>{this.visible=!1,t.style.display="none",this.editor.mode=this.editor.mode!=DP.Farmer?DP.Farmer:DP.EditPlay,this.meta.ModeChange(this.editor.mode,e.plantId),this.editor.UpdateMenu()},i++}));const n=document.getElementById("plantctrlexit");n&&(n.onclick=()=>{this.unbinding()})}unbinding(){document.getElementById("plantctrl").style.display="none",this.visible=!1}htmlRelease(){this.firstloading=!1}}class cD{constructor(t,e){this.meta=t,this.editor=e,this.visible=!1,this.furnDb=this.meta.Furnitures,this.itemDb=this.meta.Items,this.firstloading=!1}toggle(){this.visible?(this.unbinding(),this.visible=!1):(this.binding(),this.visible=!0)}makeMaterial(t){if(!t.madeby)return"";let e="";return t.madeby.forEach(((i,n)=>{var s,r;const a=this.itemDb.GetItem(i.itemId),o=null!==(s=a.namekr)&&void 0!==s?s:a.name;e+=o+": "+i.count,(null===(r=t.madeby)||void 0===r?void 0:r.length)!=n+1&&(e+=", ")})),e}binding(){const t=document.getElementById("furniturectrl");if(t.style.display="block",this.firstloading)return;this.firstloading=!0;let e="",i=0;this.furnDb.Items.forEach((t=>{e+=`\n    <div class="row handcursor" id="furnslot${i++}">\n        <div class="col-auto ms-1 me-0 pb-1">\n            <div class="rounded inven_slot p-1">\n                <img src="assets/icons/Misc/Crate.png">\n            </div>\n        </div>\n        <div class="col p-1 pe-3 text-start"> ${t.namekr} .<br>${this.makeMaterial(t)} (beta)</div>\n    </div>\n            `})),t.insertAdjacentHTML("beforeend",e),i=0,this.furnDb.Items.forEach((e=>{document.getElementById("furnslot"+i).onclick=()=>{this.visible=!1,t.style.display="none",this.editor.mode=DP.Furniture,this.meta.ModeChange(this.editor.mode,e.id),this.editor.UpdateMenu()},i++}));const n=document.getElementById("furniturectrlexit");n&&(n.onclick=()=>{this.unbinding()})}unbinding(){const t=document.getElementById("furniturectrl");this.visible=!1,t.style.display="none"}htmlRelease(){this.firstloading=!1}}class uD{constructor(t){this.meta=t,this.onoff=!1,this.deckItem=[]}LoadHtml(){return fetch("views/editmode/editgame.html").then((t=>t.text())).then((t=>{document.getElementById("extension").insertAdjacentHTML("beforeend",t);document.getElementById("cardlocation").style.display="none"})).then((()=>{}))}OnOff(t,e){if(!e)return;const i=document.getElementById("gamectrl");i&&(i.style.display=t?"block":"none"),this.inven=e,t&&this.loadDeck()}loadDeck(){if(!this.inven)return;this.deckItem.length=0,this.inven.data.inventroySlot.forEach((t=>{t.item.ItemType==ZI.Deck&&this.deckItem.push(t.item)}));let t="";this.deckItem.forEach(((e,i)=>{t+=`\n    <div class="row handcursor" id="deck-${i}">\n        <div class="col-auto ms-1 me-0 pb-1">\n            <div class="rounded inven_slot p-1">\n                <img src="assets/icons/${e.IconPath}">\n            </div>\n        </div>\n        <div class="col p-1 me-3 text-start"> ${e.Name}</div>\n        </div>\n    </div>\n            `})),""==t&&(t='\n    <div class="row">\n        <div class="col ms-1 me-0 pb-1 text-center">\n        Deck .\n        </div>\n    </div>\n        ');document.getElementById("decklist").innerHTML=t,this.deckItem.forEach(((t,e)=>{document.getElementById("deck-"+e).onclick=()=>{var e,i;if(this.viewDeck&&this.viewDeck==(null===(e=t.Deck)||void 0===e?void 0:e.id)){this.viewDeck=void 0;document.getElementById("deckprofile").replaceChildren()}else this.viewDeck=null===(i=t.Deck)||void 0===i?void 0:i.id,this.loadDeckProfile(t.Deck)}}))}loadDeckProfile(t){if(null==t)throw new Error("unexpected undeined value");const e=`\n        <div class="container rounded border" style="background-image: url('static/img/card_pattern.png');">\n        <div class="row">\n            <div class="col p-2"><b>${t.title}</b></div>\n        </div>\n        <div class="row">\n            <div class="col text-start rounded border bg-white p-1 m-2 w-100" style="all:initial">\n                <p class="text-start">${t.contents}</p>\n                <p class="text-start m-0">\n                    Level: ${t.maxLv} <br>\n                      : ${t.minTime} ~ ${t.maxTime}  <br>\n                      : ${t.maxSpawn}\n                </p>\n            </div>\n        </div>\n        </div>\n        `,i=document.getElementById("deckprofile");i.innerHTML=e,this.location(i,t)}location(t,e){const i=this.meta.GetDeckInfo().find((t=>t.id==e.id)),n=`\n        <div class="input-group mt-1 mb-1">\n        <button class="btn btn-light" type="button" id="locationbtn"></button>\n        <select id="decklocation" class="form-select" aria-label="Default select example">\n            <option value="0" ${(null==i?void 0:i.rand)?"selected":""}>Random</option>\n            <option value="1" ${(null==i?void 0:i.rand)?"":"selected"}></option>\n        </select>\n        </div>\n        <div class="input-group mb-1">\n            <button class="btn btn-light" id="basic-addon1"></button>\n            <input type="text" class="form-control" id="decktime" placeholder="0" \n            aria-label="decktime" aria-describedby="basic-addon1" value="${null==i?void 0:i.time}">\n        </div>\n        <div class="form-check form-switch text-start">\n            <input class="form-check-input" type="checkbox" role="switch" id="deckenable" ${(null==i?void 0:i.enable)?"checked":""}>\n            <label class="form-check-label"> </label>\n        </div>\n        <div class="input-group mb-1 text-end">\n            <button class="btn btn-light" type="button" id="decksubmit"></button>\n        </div>\n        `;t.insertAdjacentHTML("beforeend",n);const s=document.getElementById("decksubmit");s&&(s.onclick=()=>{this.changeSetup(e)});const r=document.getElementById("decklocation");if(r){r.onchange=()=>{this.deckLocationChangeEvent(r,e)};const t=document.getElementById("locationbtn");t&&(t.onclick=()=>{this.deckLocationChangeEvent(r,e)})}}deckLocationChangeEvent(t,e){if("1"===t.value)this.locator(e);else this.changeSetup(e)}changeSetup(t){const e=document.getElementById("decklocation"),i=document.getElementById("decktime"),n=document.getElementById("deckenable"),s="1"!=e.value,r=i.value,a={id:t.id,time:Number(r),locatOnOff:!1,rand:s,enable:n.checked};this.meta.SendModeMessage(a)}locator(t){const e=document.getElementById("gamectrl");e&&(e.style.display="none");const i=document.getElementById("cardlocation");i&&(i.style.display="block");const n=document.getElementById("decktime").value,s=document.getElementById("deckenable"),r={id:t.id,time:Number(n),locatOnOff:!0,rand:!1,enable:s.checked};this.meta.SendModeMessage(r);const a=document.getElementById("cardlocationexit");a&&(a.onclick=()=>{e.style.display="block",i.style.display="none";const r={id:t.id,time:Number(n),locatOnOff:!1,rand:!1,enable:s.checked};this.meta.SendModeMessage(r)})}}var dD=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class pD extends BP{constructor(t,e,i,n,s,r){super(r),this.blockStore=t,this.session=e,this.meta=i,this.inven=n,this.brick=s,this.m_masterAddr="",this.mode=DP.EditPlay,this.profileVisible=!0,this.brickSize=new Le(3,3,1),this.brickRotate=new Le,this.ui=new zP(this.meta,DP.EditPlay),this.plant=new lD(this.meta,this),this.furn=new cD(this.meta,this),this.game=new uD(this.meta),this.color="#fff"}UpdateMenu(){const t=document.getElementById("editplaymode");t&&(t.style.backgroundColor=this.mode==DP.EditPlay?"silver":"transparent");document.getElementById("avatarmode").style.backgroundColor=this.mode==DP.Face?"silver":"transparent";document.getElementById("avatar-second").style.display=this.mode==DP.Face?"block":"none";document.getElementById("brickmode").style.backgroundColor=this.mode==DP.NonLego?"silver":"transparent";document.getElementById("funituremode").style.backgroundColor=this.mode==DP.Furniture?"silver":"transparent";document.getElementById("funiture-second").style.display=this.mode==DP.Furniture?"block":"none";document.getElementById("weaponmode").style.backgroundColor=this.mode==DP.Weapon?"silver":"transparent";document.getElementById("brickctrl").style.display=this.mode==DP.Lego||this.mode==DP.NonLego?"block":"none",this.game.OnOff(this.mode==DP.Weapon,this.inven.inven)}RequestNewMeta(t){const e=this.m_masterAddr,i=this.session.GetHonUser(),n=e+"/glambda?txid="+encodeURIComponent("+bo01CLDwef63KG0t4Rc83KekF/U2tgr6BVwcxgmCVA="),s=new FormData;s.append("key",encodeURIComponent(i.Email)),s.append("email",encodeURIComponent(i.Email)),s.append("id",i.Nickname),s.append("password",i.Password),s.append("models",t);const r=(new Date).getTime();return s.append("time",r.toString()),s.append("table","meta"),fetch(n,{method:"POST",cache:"no-cache",headers:{},body:s}).then((t=>t.json())).then((()=>{this.blockStore.UpdateModels({email:i.Email,key:i.Email,id:i.Nickname,password:i.Password,models:t,time:r},i.Email)}))}MenuEvent(){document.getElementById("save").onclick=()=>dD(this,void 0,void 0,(function*(){document.getElementById("confirmsave").style.display="block"}));document.getElementById("saveConfirmBtn").onclick=()=>dD(this,void 0,void 0,(function*(){this.alarmOn(" .");const t=this.meta.ModelStore(),e=this.meta.store.StoreInventory();yield this.inven.SaveInventory(e,this.m_masterAddr),yield this.RequestNewMeta(t),this.alarmOff();document.getElementById("confirmsave").style.display="none"}));document.getElementById("saveCancelBtn").onclick=()=>{document.getElementById("confirmsave").style.display="none"};const t=document.getElementById("editplaymode");t&&(t.onclick=()=>{this.meta.ModeChange(DP.EditPlay),this.UpdateMenu()});document.getElementById("avatarmode").onclick=()=>{this.mode=this.mode!=DP.Face?DP.Face:DP.EditPlay,this.meta.ModeChange(this.mode),this.UpdateMenu()};document.getElementById("funituremode").onclick=()=>{this.mode=this.mode!=DP.Furniture?DP.Furniture:DP.EditPlay,this.mode==DP.EditPlay&&this.meta.ModeChange(this.mode),this.UpdateMenu()};document.getElementById("weaponmode").onclick=()=>{this.mode=this.mode!=DP.Weapon?DP.Weapon:DP.EditPlay,this.meta.ModeChange(this.mode),this.UpdateMenu()};document.getElementById("change-male").onclick=()=>{this.meta.ChangeCharactor(Cu.Male)};document.getElementById("change-female").onclick=()=>{this.meta.ChangeCharactor(Cu.Female)};document.getElementById("gate").onclick=()=>{this.mode=this.mode!=DP.Portal?DP.Portal:DP.EditPlay,this.meta.ModeChange(this.mode),this.UpdateMenu()};document.getElementById("brickmode").onclick=()=>{this.mode=this.mode!=DP.NonLego?DP.NonLego:DP.EditPlay,this.meta.ModeChange(this.mode),this.UpdateMenu();const t=document.getElementById("myPicker");this.meta.ChangeBrickInfo({v:this.brickSize,r:this.brickRotate,color:t.value})};document.getElementById("apart").onclick=()=>{this.mode=this.mode!=DP.Lego?DP.Lego:DP.EditPlay,this.meta.ModeChange(this.mode),this.UpdateMenu();const t=document.getElementById("myPicker");this.meta.ChangeBrickInfo({v:this.brickSize,r:this.brickRotate,color:t.value})};document.getElementById("eraser").onclick=()=>{this.mode=this.mode!=DP.LegoDelete?DP.LegoDelete:DP.EditPlay,this.meta.ModeChange(this.mode),this.UpdateMenu()};document.getElementById("tree").onclick=()=>{this.plant.toggle(),this.UpdateMenu()};document.getElementById("chair").onclick=()=>{this.furn.toggle(),this.UpdateMenu()};document.getElementById("reset-brick").onclick=()=>this.meta.ChangeBrickInfo({clear:!0});document.getElementById("exit").onclick=()=>{document.getElementById("confirmexit").style.display="block"};document.getElementById("exitBtn").onclick=()=>{document.fullscreenElement&&document.exitFullscreen(),this.mode=DP.EditPlay,this.UpdateMenu(),window.history.back()};document.getElementById("cancelBtn").onclick=()=>{document.getElementById("confirmexit").style.display="none"}}CanvasRenderer(t){const e=this.blockStore.GetModel(this.session.UserId);document.getElementById("avatar-bg").style.display="block",this.meta.RegisterInitEvent((i=>{if(this.blockStore.FetchInventory(this.m_masterAddr,this.session.UserId).then((t=>{this.inven.LoadInven(this.meta.store.LoadInventory(t)),this.inven.loadSlot(),this.inven.inven&&this.meta.store.ChangeInventory(this.inven.inven.data)})),this.meta.ModeChange(DP.EditPlay),null==t)this.alarmOn("Login ."),setTimeout((()=>{this.alarmOff()}),2e3);else{if(!i)return;this.alarmOn("."),this.blockStore.FetchModel(this.m_masterAddr,t).then((t=>dD(this,void 0,void 0,(function*(){yield this.meta.LoadModel(t.models,t.id,null==e?void 0:e.models),this.alarmOff()})))).then((()=>{this.meta.ModeChange(DP.EditPlay)})).catch((()=>dD(this,void 0,void 0,(function*(){yield this.meta.LoadModelEmpty(t,null==e?void 0:e.models),this.meta.ModeChange(DP.EditPlay),this.alarmOff()}))))}this.ui.UiOff(DP.EditPlay),this.meta.render()}))}loadHelper(){fetch("views/editmode/edithelp.html").then((t=>t.text())).then((t=>{document.getElementById("modalwindow").innerHTML=t})).then((()=>{}))}Run(t){return dD(this,void 0,void 0,(function*(){yield this.LoadHtml(this.inven.Html,this.brick.Html),yield this.game.LoadHtml(),this.brick.Initialize(DP.EditPlay,(()=>{this.mode=DP.EditPlay,this.UpdateMenu()})),this.brick.GetElement(),this.brick.UpdateBrickUI(),this.m_masterAddr=t;const e=this.getParam("email");return null!=e&&(this.loadHelper(),this.CanvasRenderer(e),this.MenuEvent(),this.inven.binding(),this.UpdateMenu(),!0)}))}Release(){this.ui.UiOn(),this.ReleaseHtml(),this.furn.htmlRelease(),this.plant.htmlRelease()}}var mD=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class fD extends BP{constructor(t,e,i,n,s){super(s),this.blockStore=t,this.session=e,this.meta=i,this.uiInven=n,this.m_masterAddr="",this.ui=new zP(this.meta,DP.Play),this.defaultLv=1,this.randomBoxOpend=!1,this.buffQ=[]}startPlay(){this.randomBoxOpend=!1;const t=document.getElementById("levelview");t.replaceChildren();t.innerHTML='\n        <div class="row pb-2">\n            <div class="col xxx-large text-white text-center h2">Game Tips</div>\n        </div>\n        <div class="row p-2">\n            <div class="col-auto text-white text-weight-bold"> </div>\n            <div class="col text-white text-start">Random</div>\n        </div>\n        <div class="row p-2">\n            <div class="col text-white text-start">   .       . \n               .</div>\n        </div>\n        <div class="row p-2">\n            <div class="col text-white">\n                <div class="border rounded bg-secondary p-2 d-inline-block">space</div> or\n                <span class="material-symbols-outlined align-middle">\n                close\n                </span> = \n            </div>\n            <div class="col text-white">\n                <div class="border rounded bg-secondary p-2 d-inline-block ps-3 pe-3">1</div> or\n                <span class="material-symbols-outlined align-middle">\n                circle\n                </span> =  1\n            </div>\n            <div class="col text-white">\n                <div class="border rounded bg-secondary p-2 d-inline-block ps-3 pe-3">2</div> or\n                <span class="material-symbols-outlined align-middle">\n                square\n                </span> =  2\n            </div>\n        </div>\n        <div class="row p-2">\n            <div class="col text-white text-center">\n            <button type="button" class="btn btn-primary" id="startBtn"></button>\n            </div>\n        </div>\n\n        ';const e=document.getElementById("levelup");e.style.display="block";document.getElementById("startBtn").onclick=()=>{this.meta.Setup({OnEnd:t=>{this.endPlay(t)},OnSaveInven:t=>{!this.session.CheckLogin()||t.inventroySlot.length<1||this.uiInven.SaveInventory(t,this.m_masterAddr).then((()=>{this.alarmOff()}))}}),e.style.display="none",this.ui.UiOff(DP.Play),this.LevelUp()}}endPlay(t){const e=document.getElementById("levelview");e.replaceChildren();let i=`\n        <div class="row pb-2">\n            <div class="col xxx-large text-white text-center h2">${t?"Game Complete":"Game Over"}</div>\n        </div>`;t&&(i+='\n        <div class="row p-2">\n            <div class="col-auto text-white text-weight-bold"> !</div>\n        </div>\n        <div class="row p-2">\n            <div class="col text-white text-center handcursor" id="randomBox1"><img src="assets/icons/Misc/Chest.png"></div>\n            <div class="col text-white text-center handcursor" id="randomBox2"><img src="assets/icons/Misc/Chest.png"></div>\n            <div class="col text-white text-center handcursor" id="randomBox3"><img src="assets/icons/Misc/Chest.png"></div>\n        </div>'),i+='\n        <div class="row p-2">\n            <div class="col text-white text-center">\n            <button type="button" class="btn btn-primary" id="endBtn"></button>\n            </div>\n        </div>\n        ',e.innerHTML=i;document.getElementById("levelup").style.display="block";if(document.getElementById("endBtn").onclick=()=>{document.fullscreenElement&&document.exitFullscreen(),history.back()},t){const t=document.getElementById("randomBox1"),e=document.getElementById("randomBox2"),i=document.getElementById("randomBox3");t.onclick=()=>this.openRandomBox(t),e.onclick=()=>this.openRandomBox(e),i.onclick=()=>this.openRandomBox(i)}}openRandomBox(t){var e;if(this.randomBoxOpend)return;this.randomBoxOpend=!0;const i=Math.floor(Math.random()*mR.ItemCategory.length),n=mR.ItemCategory[i],s=n[Math.floor(Math.random()*Math.random()*n.length)];this.uiInven.newItem(s);const r=this.uiInven.getItemInfo(s);t.innerHTML=`<img src="assets/icons/${null==r?void 0:r.icon}"><br>${null!==(e=null==r?void 0:r.namekr)&&void 0!==e?e:null==r?void 0:r.name}`}CanvasRenderer(){document.getElementById("avatar-bg").style.display="block",this.meta.RegisterInitEvent((()=>{this.blockStore.FetchInventory(this.m_masterAddr,this.session.UserId).then((t=>{this.meta.store.LoadInventory(t),this.uiInven.LoadInven(this.meta.store.GetEmptyInventory()),this.uiInven.loadSlot()})),this.startPlay(),this.meta.render()})),this.meta.RegisterChangePlayerStatusEvent((t=>{const e=document.getElementById("hp-bar"),i=document.getElementById("special-bar"),n=document.getElementById("exp-bar"),s=document.getElementById("level");e&&(e.value=t.health/t.maxHealth*100,i.value=t.mana/t.maxMana*100,n.value=t.exp/t.maxExp*100,s.innerText="Lv."+t.level,t.level>this.defaultLv&&(this.defaultLv=t.level,this.LevelUp()))}))}FirstLevelUp(){const t=document.getElementById("levelview");t.replaceChildren();let e='\n        <div class="row pb-2">\n            <div class="col xxx-large text-white text-center h2"> !</div>\n        </div>\n        ';const i=[mR.Hanhwasbat,mR.DefaultGun];i.forEach(((t,i)=>{var n;const s=null===(n=this.uiInven.inven)||void 0===n?void 0:n.GetItemInfo(t);e+=`\n        <div class="row p-2 handcursor" id="buff_${i}">\n            <div class="col-auto"><img src="assets/icons/${null==s?void 0:s.icon}" style="width: 45px;"></div>\n            <div class="col text-white">${null==s?void 0:s.name}</div>\n        </div>\n            `})),t.innerHTML=e;document.getElementById("levelup").style.display="block",i.forEach(((t,e)=>{document.getElementById("buff_"+e).onclick=()=>mD(this,void 0,void 0,(function*(){var e;if(null==this.uiInven.inven)return;const i=yield null===(e=this.uiInven.inven)||void 0===e?void 0:e.NewItem(t);if(null==i)throw new Error("inventory is full");this.uiInven.equipmentItem(i);document.getElementById("levelup").style.display="none"}))}))}LevelUp(){if(1==this.defaultLv)return void this.FirstLevelUp();const t=this.meta.GetRandomBuff();this.buffQ.push(t),this.buffQ.length>1||this.SelectBuff(t)}SelectBuff(t){const e=document.getElementById("levelview");e.replaceChildren();let i='\n        <div class="row pb-2">\n            <div class="col xxx-large text-white text-center h2">Level Up!!</div>\n        </div>\n        ';t.forEach(((t,e)=>{i+=`\n        <div class="row p-2 handcursor" id="buff_${e}">\n            <div class="col-auto"><img src="assets/icons/${t.icon}" style="width: 45px;"></div>\n            <div class="col text-white">${t.name}<br>${0==t.lv?"":"Lv."+(t.lv+1)}: ${t.explain}</div>\n        </div>\n            `})),e.innerHTML=i;document.getElementById("levelup").style.display="block",t.forEach(((t,e)=>{document.getElementById("buff_"+e).onclick=()=>{this.meta.SelectRandomBuff(t);if(document.getElementById("levelup").style.display="none",this.buffQ.shift(),this.buffQ.length){const t=this.buffQ[0];if(null==t)return;this.SelectBuff(t)}}}))}Run(t){return mD(this,void 0,void 0,(function*(){return yield this.LoadHtml(this.uiInven.Html),this.m_masterAddr=t,this.CanvasRenderer(),this.uiInven.binding(),!0}))}Release(){this.defaultLv=1,this.ReleaseHtml()}}var gD=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class vD{get Html(){return this.html}constructor(t,e,i){this.meta=t,this.session=e,this.blockStore=i,this.slots=[],this.colCont=5,this.alarm=document.getElementById("alarm-msg"),this.html="",this.LoadHtml()}LoadHtml(){return gD(this,void 0,void 0,(function*(){return yield fetch("views/common/inventory.html").then((t=>t.text())).then((t=>{this.html=t}))}))}Clear(){this.slots.length=0}LoadInven(t){this.inven=t}bindClickEvent(t){if(null==this.inven)throw new Error("inventory undefined");const e=document.getElementById("item_info");e.replaceChildren(),e.style.display="none";const i=this.inven.GetBindItem(t);if(null==i)return;const n=i.MakeInformation();let s="";if(n.forEach((t=>{t.k&&(s+=t.k+" "),s+=t.v+"<br>"})),e.insertAdjacentHTML("afterbegin",s),e.style.display="block",i.Bindable){const i=document.createElement("button");i.className="btn btn-outline-primary",i.style.width="100%",i.textContent="",i.onclick=()=>{this.toInvenItem(t),e.style.display="none",e.removeChild(i)},e.appendChild(i)}}newItem(t){var e;null===(e=this.inven)||void 0===e||e.NewItem(t)}getItemInfo(t){var e;return null===(e=this.inven)||void 0===e?void 0:e.GetItemInfo(t)}toInvenItem(t){if(null==this.inven)throw new Error("inventory undefined");this.inven.MoveToInvenFromBindItem(t),this.inven=this.meta.store.ChangeInventory(this.inven.data),this.reloadSlot()}equipmentItem(t){var e;if(null!=t.Bind){if(null==this.inven)throw new Error("inventory undefined");null===(e=this.inven)||void 0===e||e.MoveToBindFromInvenItem(t.Bind,t),this.inven=this.meta.store.ChangeInventory(this.inven.data),this.reloadSlot()}}slotClickEvent(t){if(null==this.inven)throw new Error("inventory undefined");const e=document.getElementById("item_info");e.replaceChildren(),e.style.display="none";const i=this.slots[t];if(null==i)return;const n=i.item,s=n.MakeInformation();let r="";if(s.forEach((t=>{t.k&&(r+=t.k+" "),r+=t.v+"<br>"})),e.insertAdjacentHTML("afterbegin",r),e.style.display="block",n.Bindable){const t=document.createElement("button");t.className="btn btn-outline-primary",t.style.width="100%",t.textContent="",t.onclick=()=>{this.equipmentItem(n),e.style.display="none",e.removeChild(t)},e.appendChild(t)}}reloadSlot(){var t;if(null==this.inven)throw new Error("inventory undefined");const e=document.getElementById("headslot");e.onclick=()=>{this.bindClickEvent(Tu.Head)};const i=this.inven.GetBindItem(Tu.Head);i?e.innerHTML=`<img src="assets/icons/${i.IconPath}">`:e.replaceChildren();const n=document.getElementById("l_handslot");n.onclick=()=>{this.bindClickEvent(Tu.Hands_L)};const s=this.inven.GetBindItem(Tu.Hands_L);s?n.innerHTML=`<img src="assets/icons/${s.IconPath}">`:n.replaceChildren();const r=document.getElementById("r_handslot");r.onclick=()=>{this.bindClickEvent(Tu.Hands_R)};const a=this.inven.GetBindItem(Tu.Hands_R);a?r.innerHTML=`<img src="assets/icons/${a.IconPath}">`:r.replaceChildren(),this.slots.length=0;for(let e=0;e<3;e++)for(let i=0;i<this.colCont;i++){const n=i+e*this.colCont,s=document.getElementById(`slot${n}`),r=this.inven.GetInventory(n);if(null==r){s.innerText="";continue}const a=r.item;let o=`<img src="assets/icons/${null!==(t=a.IconPath)&&void 0!==t?t:a.property.icon}">`;o+=r.count>1?`<span class="position-absolute top-100 start-100 translate-middle badge rounded-pill bg-secondary"\n                                    id="slot${n}count">\n                                        ${r.count}\n                                    </span>\n                `:"",s.innerHTML=o,s.onclick=()=>{this.slotClickEvent(n)},this.slots.push(r)}}loadSlot(){if(null==this.inven)throw new Error("inventory undefined");const t=document.getElementById("invenslots");let e="";for(let t=0;t<3;t++){e+='<div class="row">';for(let i=0;i<this.colCont;i++){e+=`\n                    <div class="col ps-1 pe-0 pb-1">\n                        <div class="popmenu-wrap rounded inven_slot p-1" id="slot${i+t*this.colCont}"></div>\n                    </div>\n                `}e+="</div>"}t.insertAdjacentHTML("beforeend",e),this.reloadSlot()}binding(){const t=document.getElementById("invenBtn"),e=document.getElementById("invenContent");t.onclick=()=>{if(null==this.inven)throw new Error("inventory undefined");if("none"==e.style.display||""==e.style.display)this.inven=this.meta.store.ChangeInventory(this.inven.data),this.reloadSlot(),e.style.display="block";else{document.getElementById("item_info").style.display="none",e.style.display="none"}};const i=document.getElementById("fullscreen");i.onclick=()=>{document.fullscreenElement?(document.exitFullscreen(),i.innerText="fullscreen"):(document.documentElement.requestFullscreen(),i.innerText="fullscreen_exit")};const n=document.getElementById("returnSns");n&&(n.onclick=()=>{document.getElementById("confirmexit").style.display="block"});document.getElementById("exitBtn").onclick=()=>{document.fullscreenElement&&(document.exitFullscreen(),i.innerText="fullscreen"),history.back()};document.getElementById("cancelBtn").onclick=()=>{document.getElementById("confirmexit").style.display="none"}}SaveInventory(t,e){const i=JSON.stringify(t),n=this.session.GetHonUser(),s=e+"/glambda?txid="+encodeURIComponent(c),r=new FormData;r.append("key",encodeURIComponent(n.Email)),r.append("email",encodeURIComponent(n.Email)),r.append("id",n.Nickname),r.append("password",n.Password),r.append("data",i);const a=(new Date).getTime();return r.append("date",a.toString()),r.append("table","inventory"),fetch(s,{method:"POST",cache:"no-cache",headers:{},body:r}).then((t=>t.json())).then((e=>{this.blockStore.UpdateInventory(t,n.Email)}))}}var yD=a(146),xD=a.n(yD);const bD="Filter",_D="Gen";class wD{get Image(){return this.m_img}set Print(t){this.print=t}constructor(t){this.ipc=t,this.m_model="toonyou_beta6-f16.gguf",this.m_img=new Blob,this.m_srcImg=new Blob,this.mode=bD,this.readyprocess=!1,this.alarm=document.getElementById("alarm-msg"),this.alarmText=document.getElementById("alarm-msg-text"),this.dropmenuVisible=!1}MsgHandler(t,e){switch(t){case"close":this.print&&this.print("server  . .");break;case"generateLog":if(this.mode==bD){const t=JSON.parse(e.replaceAll("'",'"')),i=parseInt(t.step,10),n=parseInt(t.steps,10),s=parseFloat(t.time);0==i?this.print&&this.print(" ."):i==n?this.print&&this.print("  ."):this.print&&this.print(` : \n                        ${((n-i)*s).toFixed(2)}s\n                        , : ${(i/n*100).toFixed(2)}%`)}else this.print&&this.print(e);break;case"reply_generateImage":const t=e;fetch(`${window.MasterAddr}/image?filename=${t}`).then((t=>t.blob())).then((t=>{const e=new Blob([t],{type:"image/bmp"}),i=URL.createObjectURL(e),n=new Image;n.src=i,n.className="img-fluid rounded";const s=document.getElementById("printImg");s.innerHTML="",s.appendChild(n),this.m_img=e,this.print&&this.print("")}))}}generateImage(){this.mode=_D;const t=document.getElementById("prompt").value.toLowerCase(),e=document.getElementById("nprompt").value.toLowerCase(),i=document.getElementById("step"),n=""==i.value?"20":i.value;document.getElementById("printImg").innerHTML='\n            <div class="spinner-grow text-primary" role="status">\n                <span class="visually-hidden"></span>\n            </div>\n        ';const s=""==e?"nude, naked, nsfw":", nude, naked, nsfw";this.ipc.SendMsg("generateImage",t,e+s,"512","512",n,"-1"),this.print&&this.print(".")}processImage(){this.mode=bD;const t=document.getElementById("fprompt").value.toLowerCase(),e=document.getElementById("fnprompt").value.toLowerCase(),i=document.getElementById("strength"),n=""==i.value?"0.5":i.value;document.getElementById("printImg").innerHTML='\n            <div class="spinner-grow text-primary" role="status">\n                <span class="visually-hidden"></span>\n            </div>\n        ';const s=""==e?"nude, naked, nsfw":", nude, naked, nsfw",r=new FileReader;r.readAsDataURL(this.m_srcImg),r.onloadend=()=>{this.ipc.SendMsg("processImage",t,e+s,"512","512","20","-1",this.m_model,"euler","7",n,"","","2","","",r.result)},this.print&&this.print("  .")}canvasVisible(t){document.getElementById("avatar-bg").style.display=t?"block":"none"}toggleMenu(){const t=document.getElementById("modellist");0==this.dropmenuVisible?(t.style.display="block",t.style.transform="translate(0px, 40px)"):(t.style.display="none",t.style.transform="translate(0px, 40px)"),this.dropmenuVisible=!this.dropmenuVisible}initFilterUi(){document.getElementById("dropdownMenuButton").onclick=()=>{this.toggleMenu()};const t=document.getElementById("strength"),e=document.getElementById("strength-text");t.onchange=()=>{e.value=t.value.toString()},e.value=t.value.toString();const i=document.getElementById("cropimg");let n=new(xD())(i);document.getElementById("origin-file").onchange=t=>{const e=new FileReader;e.onload=t=>{var e;const s=new Blob([new Uint8Array(null===(e=t.target)||void 0===e?void 0:e.result)],{type:"image/bmp"}),r=URL.createObjectURL(s);i.src=r;const a=i.width/window.innerWidth;i.height*=a,n.destroy(),n=new(xD())(i,{aspectRatio:1,viewMode:2})},e.readAsArrayBuffer(t.target.files[0])};document.getElementById("cropBtn").onclick=()=>{this.alarm.style.display="block",this.alarmText.innerText=" ",n.getCroppedCanvas().toBlob((t=>{if(null==t)return;const e=URL.createObjectURL(t),i=new Image;i.src=e,i.onload=()=>{const t=document.createElement("canvas");t.width=t.height=512;const e=t.getContext("2d",{alpha:!1});null!=e&&(e.drawImage(i,0,0,512,512),t.toBlob((t=>{if(null==t)return;this.m_srcImg=t;const e=URL.createObjectURL(t),i=new Image;i.src=e,i.className="img-fluid";const n=document.getElementById("result");n.innerHTML="",n.appendChild(i),this.readyprocess=!0,this.alarm.style.display="none"})))}}))};document.getElementById("processBtn").onclick=()=>{this.readyprocess&&this.processImage()},this.bindClickEvent("toonyou",1),this.bindClickEvent("disney",2),this.bindClickEvent("child",4)}selectModel(t){this.toggleMenu();const e=document.getElementById("dropdownMenuButton"),i=document.getElementById("result");switch(t){case 1:e.innerText="Animation Style",this.m_model="toonyou_beta6-f16.gguf",this.readyprocess||(i.innerHTML='<img src="static/img/comp1.jpg" class="img-fluid rounded">');break;case 2:e.innerText="Disney Style",this.m_model="disneyPixarCartoon_v10-f16.gguf",this.readyprocess||(i.innerHTML='<img src="static/img/comp2.jpg" class="img-fluid rounded">');break;case 3:e.innerText="Default Style",this.m_model="sd-v1-4-f16.gguf";break;case 4:e.innerText="Real-Picture Style",this.m_model="chilled_reversemix_v2-f16.gguf",this.readyprocess||(i.innerHTML='<img src="static/img/comp3.jpg" class="img-fluid rounded">')}}bindClickEvent(t,e){document.getElementById(t).onclick=()=>{this.selectModel(e)}}drawhtml(){fetch("views/sd1.html").then((t=>t.text())).then((t=>{document.getElementById("sd1").innerHTML=t})).then((()=>{document.getElementById("generateBtn").onclick=()=>{this.generateImage()}})),fetch("views/editimg.html").then((t=>t.text())).then((t=>{document.getElementById("modalwindow").innerHTML=t})).then((()=>{fetch("views/filter.html").then((t=>t.text())).then((t=>{document.getElementById("filter").innerHTML=t})).then((()=>{this.initFilterUi()}))}))}release(){this.readyprocess=!1}}var MD=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class SD extends BP{constructor(t,e){super(e),this.session=t,this.masterAddr=""}warningMsg(t){this.alarmOff();const e=document.getElementById("information");null!=e&&(e.innerHTML=t)}newHonResult(t){this.alarmOff(),"null"==t.result?this.warningMsg(" "):window.history.back()}RegisterCity(){const t=this.session.GetHonUser(),e=document.getElementById("name"),i=document.getElementById("explain"),n=document.querySelector('input[name="openFlag"]:checked').value,s=this.masterAddr+"/glambda?txid="+encodeURIComponent(c);this.alarmOn(".");const r=new FormData;r.append("key",encodeURIComponent(t.Email)),r.append("email",encodeURIComponent(t.Email)),r.append("password",t.Password),r.append("id",t.Nickname),r.append("time",(new Date).getTime().toString()),r.append("table","city"),r.append("citytitle",e.value),r.append("cityexplain",i.value),r.append("openflag",n),fetch(s,{method:"POST",cache:"no-cache",headers:{},body:r}).then((t=>t.json())).then((t=>this.newHonResult(t))).catch((()=>{this.warningMsg("Server   ;;")}))}bind(){document.getElementById("cityBtn").onclick=()=>{this.session.CheckLogin()?this.RegisterCity():this.warningMsg(" .")}}Run(t){return MD(this,void 0,void 0,(function*(){yield this.LoadHtml();return null!=this.getParam("email")&&(this.masterAddr=t,this.bind(),!0)}))}Release(){this.ReleaseHtml()}}var ED=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class TD extends BP{constructor(t,e,i,n){super(n),this.blockStore=t,this.session=e,this.meta=i,this.masterAddr="",this.ui=new zP(this.meta,DP.CityView),this.popupVisible=!1}Join(t){this.alarmOn(".");const e=this.session.GetHonUser(),i=this.masterAddr+"/glambda?txid="+encodeURIComponent(c),n=new FormData;n.append("key",encodeURIComponent(e.Email)),n.append("email",encodeURIComponent(e.Email)),n.append("password",e.Password),n.append("nickname",e.Nickname),n.append("id",e.Nickname),n.append("time",(new Date).getTime().toString()),n.append("table","citizen_"+t),fetch(i,{method:"POST",cache:"no-cache",headers:{},body:n}).then((t=>t.json())).then((()=>{this.alarmOff(),window.location.reload()}))}CanvasRenderer(t){return ED(this,void 0,void 0,(function*(){document.getElementById("avatar-bg").style.display="block",this.alarmOn(" <br> ."),this.meta.RegisterInitEvent((()=>{this.meta.render();document.getElementById("avatar-space").style.height=window.innerHeight-230+"px",this.ui.UiOn()}));const e=this.blockStore.GetModel(this.session.UserId),[i,n]=yield Promise.all([this.blockStore.FetchCity(this.masterAddr,t),this.blockStore.FetchCitizenList(this.masterAddr,t)]),s=new Map;yield Promise.all(n.map((t=>ED(this,void 0,void 0,(function*(){const e=yield this.blockStore.FetchModel(this.masterAddr,t);s.set(e.id,e.models),this.makeMemberHtml(t)}))))),this.meta.ModelClear(),yield this.meta.LoadCity(s,i.models,null==e?void 0:e.models),this.alarmOff();document.getElementById("playBtn").onclick=()=>{window.ClickLoadPage("play",!1)}}))}DrawCityTitle(t){const e=document.getElementById("citybigtitle");e&&(e.innerText=t);const i=Vg.to(e,{duration:2,opacity:1}),n=Vg.to(e,{duration:2,opacity:0,delay:1}),s=Vg.timeline();s.add(i),s.add(n)}RequestCityInfo(t){return ED(this,void 0,void 0,(function*(){const e=yield this.blockStore.FetchCity(this.masterAddr,t),i=document.getElementById("citytitle");i&&(i.innerText=e.citytitle);const n=document.getElementById("explain");n&&(n.innerText=e.cityexplain),this.DrawCityTitle(e.citytitle)}))}BindingMenu(t){const e=document.getElementById("menuBtn"),i=document.getElementById("popmenu");e.onclick=()=>{this.popupVisible?(i.style.display="none",this.popupVisible=!1):(i.style.display="block",this.popupVisible=!0)};document.getElementById("editcity").onclick=()=>{window.ClickLoadPage("editcity",!1,"&city="+t)};document.getElementById("setupcity").onclick=()=>{window.ClickLoadPage("setupcity",!1,"&city="+t)};document.getElementById("join").onclick=()=>{this.session.CheckLogin()?this.confirmOn("?","",(()=>{this.Join(t)})):this.confirmOn(" .","",(()=>{window.ClickLoadPage("signin",!1)}))};document.getElementById("exit").onclick=()=>{};document.getElementById("newfeed").onclick=()=>{window.ClickLoadPage("newhon",!1,"&from=city&city="+t)}}makeMemberHtml(t){this.active&&this.blockStore.FetchProfile(window.MasterAddr,t).then((t=>{const e=t.id+t.time.toString();document.getElementById("memberlist").insertAdjacentHTML("beforeend",`\n                <div class="row p-1 border-top handcursor" onclick="ClickLoadPage('hondetail', false, '&email=${t.email}')">\n                    <div class="col-auto">\n                            <span id="${e}" class="m-1"></span>\n                    </div>\n                    <div class="col">\n                        <b>${t.id}</b> @${t.email}\n                    </div>\n                </div>\n                `),""!=t.file&&fetch("data:image/jpg;base64,"+t.file).then((t=>t.blob())).then((t=>{const i=URL.createObjectURL(t),n=new Image;n.src=i,n.className="profile-sm";const s=document.getElementById(e);s.innerHTML="",s.appendChild(n)}))}))}Run(t){var e;return ED(this,void 0,void 0,(function*(){yield this.LoadHtml(),this.masterAddr=t;const i=null!==(e=this.getParam("city"))&&void 0!==e?e:"ghost";return this.CanvasRenderer(i),this.RequestCityInfo(i),this.BindingMenu(i),!0}))}Release(){this.ReleaseHtml()}}var AD=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class CD extends BP{constructor(t,e,i,n,s,r){super(r),this.blockStore=t,this.session=e,this.meta=i,this.inven=n,this.brick=s,this.masterAddr="",this.ui=new zP(this.meta,DP.EditCity),this.mode=DP.EditCity,this.locationMode=EP.ChangeLocationE,this.brickSize=new Le(3,3,1),this.brickRotate=new Le}UpdateMenu(){const t=document.getElementById("editcity");t&&(t.style.backgroundColor=this.mode==DP.EditCity?"silver":"transparent");document.getElementById("brickmode").style.backgroundColor=this.mode==DP.NonLego?"silver":"transparent";document.getElementById("brickctrl").style.display=this.mode==DP.Lego||this.mode==DP.NonLego?"block":"none";document.getElementById("explain").style.display=this.mode==DP.Lego||this.mode==DP.NonLego?"none":"block"}loadHelper(){fetch("views/citymode/edithelp.html").then((t=>t.text())).then((t=>{document.getElementById("modalwindow").innerHTML=t})).then((()=>{}))}MenuEvent(){const t=document.getElementById("explaintext");document.getElementById("save").onclick=()=>AD(this,void 0,void 0,(function*(){document.getElementById("confirmsave").style.display="block"}));document.getElementById("saveConfirmBtn").onclick=()=>AD(this,void 0,void 0,(function*(){this.alarmOn(" .");const t=this.meta.SaveCity();this.SaveData(t),this.alarmOff();document.getElementById("confirmsave").style.display="none"}));document.getElementById("saveCancelBtn").onclick=()=>{document.getElementById("confirmsave").style.display="none"};document.getElementById("camera").onclick=()=>{this.meta.ChangeTerrainInfo({to:SP.Camera})};document.getElementById("rotatehome").onclick=()=>{this.meta.ChangeTerrainInfo({to:SP.Rotate})};document.getElementById("modifyhome").onclick=()=>{this.locationMode==EP.ChangeLocationE?(this.meta.SendModeMessage(EP.ChangeLocationS),this.UpdateMenu(),t.innerText="    ."):(this.locationMode=EP.ChangeLocationE,this.meta.SendModeMessage(this.locationMode))};document.getElementById("editcity").onclick=()=>{this.meta.SendModeMessage(EP.ChangeLocationE),this.meta.ModeChange(DP.EditCity),this.UpdateMenu(),t.innerText="    ."};document.getElementById("gate").onclick=()=>{this.mode=this.mode!=DP.Portal?DP.Portal:DP.EditCity,this.meta.ModeChange(this.mode),this.UpdateMenu(),t.innerText="    ."};document.getElementById("brickmode").onclick=()=>{this.mode=this.mode!=DP.NonLego?DP.NonLego:DP.EditCity,this.meta.ModeChange(this.mode),this.UpdateMenu();const t=document.getElementById("myPicker");this.meta.ChangeBrickInfo({v:this.brickSize,r:this.brickRotate,color:t.value})};document.getElementById("exitBtn").onclick=()=>{document.fullscreenElement&&document.exitFullscreen(),window.history.back()};document.getElementById("cancelBtn").onclick=()=>{document.getElementById("confirmexit").style.display="none"}}SaveData(t){return AD(this,void 0,void 0,(function*(){if(!this.session.CheckLogin())return;const e=yield this.blockStore.FetchCity(this.masterAddr,this.session.UserId);e.models=t;const i=this.masterAddr+"/glambda?txid="+encodeURIComponent(c),n=new FormData;n.append("key",encodeURIComponent(e.email)),n.append("email",encodeURIComponent(e.email)),n.append("password",this.session.GetHonUser().Password),n.append("id",e.id),n.append("time",(new Date).getTime().toString()),n.append("table","city"),n.append("citytitle",e.citytitle),n.append("cityexplain",e.cityexplain),n.append("openflag",e.openflag),n.append("models",e.models),fetch(i,{method:"POST",cache:"no-cache",headers:{},body:n}).then((t=>t.json()))}))}CanvasRenderer(t){document.getElementById("avatar-bg").style.display="block",this.meta.RegisterInitEvent((e=>{if(this.blockStore.FetchInventory(this.masterAddr,this.session.UserId).then((t=>{this.inven.LoadInven(this.meta.store.LoadInventory(t)),this.inven.loadSlot(),this.inven.inven&&this.meta.store.ChangeInventory(this.inven.inven.data)})),this.meta.ModeChange(DP.EditCity),null==t)this.alarmOn("Login ."),setTimeout((()=>{this.alarmOff()}),2e3);else{if(!e)return;this.meta.ModeChange(DP.EditCity)}this.ui.UiOff(DP.EditCity),this.meta.render()}))}Run(t){return AD(this,void 0,void 0,(function*(){yield this.LoadHtml(this.inven.Html,this.brick.Html);const e=this.getParam("city");return null!=e&&(this.masterAddr=t,this.loadHelper(),this.brick.Initialize(DP.EditCity,(()=>{this.mode=DP.EditCity,this.UpdateMenu()})),this.brick.GetElement(),this.brick.UpdateBrickUI(),this.CanvasRenderer(e),this.MenuEvent(),this.inven.binding(),this.UpdateMenu(),!0)}))}Release(){this.ReleaseHtml()}}const ID="aria-description",RD="aria-expanded",kD="aria-selected",PD="aria-valuenow",DD="aria-valuetext",LD="keydown",OD="click",ND="pointermove",BD="touchmove",zD="ArrowDown",UD="ArrowUp",FD="ArrowLeft",GD="ArrowRight",VD="Enter",HD="Space",jD="tabindex",WD=navigator.userAgentData,{userAgent:XD}=navigator,qD=XD,YD=/iPhone|iPad|iPod|Android/i;WD?WD.brands.some((t=>YD.test(t.brand))):YD.test(qD);const JD=/(iPhone|iPod|iPad)/;WD?WD.brands.some((t=>JD.test(t.brand))):JD.test(qD),qD&&qD.includes("Firefox");const{head:$D}=document;["webkitPerspective","perspective"].some((t=>t in $D.style));const KD=(t,e,i,n)=>{const s=n||!1;t.addEventListener(e,i,s)},ZD=(t,e,i,n)=>{const s=n||!1;t.removeEventListener(e,i,s)},QD=()=>{};(()=>{let t=!1;try{const e=Object.defineProperty({},"passive",{get:()=>(t=!0,t)});((t,e,i,n)=>{const s=r=>{(r.target===t||r.currentTarget===t)&&(i.apply(t,[r]),ZD(t,e,s,n))};KD(t,e,s,n)})(document,"DOMContentLoaded",QD,e)}catch{}})(),["webkitTransform","transform"].some((t=>t in $D.style)),["webkitAnimation","animation"].some((t=>t in $D.style)),["webkitTransition","transition"].some((t=>t in $D.style));const tL=(t,e)=>t.getAttribute(e),eL=(t,e,i)=>t.setAttribute(e,i),iL=(t,e)=>t.removeAttribute(e),nL=(t,...e)=>{t.classList.add(...e)},sL=(t,...e)=>{t.classList.remove(...e)},rL=(t,e)=>t.classList.contains(e),aL=t=>null!=t&&"object"==typeof t||!1,oL=t=>aL(t)&&"number"==typeof t.nodeType&&[1,2,3,4,5,6,7,8,9,10,11].some((e=>t.nodeType===e))||!1,hL=t=>oL(t)&&1===t.nodeType||!1,lL=new Map,cL={data:lL,set:(t,e,i)=>{hL(t)&&(lL.has(e)||lL.set(e,new Map),lL.get(e).set(t,i))},getAllFor:t=>lL.get(t)||null,get:(t,e)=>{if(!hL(t)||!e)return null;const i=cL.getAllFor(e);return t&&i&&i.get(t)||null},remove:(t,e)=>{const i=cL.getAllFor(e);!i||!hL(t)||(i.delete(t),0===i.size&&lL.delete(e))}},uL=t=>"string"==typeof t||!1,dL=t=>oL(t)&&9===t.nodeType||!1,pL=t=>(t=>aL(t)&&"Window"===t.constructor.name||!1)(t)?t.document:dL(t)?t:oL(t)?t.ownerDocument:window.document,mL=(t,...e)=>Object.assign(t,...e),fL=t=>{if(!t)return;if(uL(t))return pL().createElement(t);const{tagName:e}=t,i=fL(e);if(!i)return;const n={...t};return delete n.tagName,mL(i,n)},gL=(t,e)=>{if(!t||!e)return;if(uL(e))return pL().createElementNS(t,e);const{tagName:i}=e,n=gL(t,i);if(!n)return;const s={...e};return delete s.tagName,mL(n,s)},vL=(t,e)=>{const i=getComputedStyle(t),n=e.replace("webkit","Webkit").replace(/([A-Z])/g,"-$1").toLowerCase();return i.getPropertyValue(n)},yL=(t,e)=>t.focus(e),xL=t=>!!["true",!0].includes(t)||!["false",!1].includes(t)&&(["null","",null,void 0].includes(t)?null:""===t||Number.isNaN(+t)?t:+t),bL=t=>Object.entries(t),_L=t=>Object.fromEntries(t),wL=(t,e)=>{bL(e).forEach((([e,i])=>{if(i&&uL(e)&&e.includes("--"))t.style.setProperty(e,i);else{const n={};n[e]=i,mL(t.style,n)}}))},ML=t=>t.toUpperCase(),SL=(t,e)=>{const{width:i,height:n,top:s,right:r,bottom:a,left:o}=t.getBoundingClientRect();let h=1,l=1;if(e&&hL(t)){const{offsetWidth:e,offsetHeight:s}=t;h=e>0?Math.round(i)/e:1,l=s>0?Math.round(n)/s:1}return{width:i/h,height:n/l,top:s/l,right:r/h,bottom:a/l,left:o/h,x:o/h,y:s/l}},EL=t=>pL(t).documentElement;let TL=0,AL=0;const CL=new Map,IL=(t,e)=>{let i=e?TL:AL;if(e){const n=IL(t),s=CL.get(n)||new Map;CL.has(n)||CL.set(n,s),(t=>aL(t)&&"Map"===t.constructor.name||!1)(s)&&!s.has(e)?(s.set(e,i),TL+=1):i=s.get(e)}else{const e=t.id||t;CL.has(e)?i=CL.get(e):(CL.set(e,i),AL+=1)}return i},RL=t=>Array.isArray(t)||!1,kL=(t,e)=>t?t.closest(e)||kL(t.getRootNode().host,e):null,PL=(t,e)=>hL(t)?t:(oL(e)?e:pL()).querySelector(t),DL=(t,e)=>(e&&oL(e)?e:pL()).getElementsByClassName(t),LL=["transparent","currentColor","inherit","revert","initial"],OL=t=>{const e=Math.floor(t);return t-e<.5?e:Math.round(t)},NL=[["aliceblue",{r:240,g:248,b:255}],["antiquewhite",{r:250,g:235,b:215}],["aqua",{r:0,g:255,b:255}],["aquamarine",{r:127,g:255,b:212}],["azure",{r:240,g:255,b:255}],["beige",{r:245,g:245,b:220}],["bisque",{r:255,g:228,b:196}],["black",{r:0,g:0,b:0}],["blanchedalmond",{r:255,g:235,b:205}],["blue",{r:0,g:0,b:255}],["blueviolet",{r:138,g:43,b:226}],["brown",{r:165,g:42,b:42}],["burlywood",{r:222,g:184,b:135}],["cadetblue",{r:95,g:158,b:160}],["chartreuse",{r:127,g:255,b:0}],["chocolate",{r:210,g:105,b:30}],["coral",{r:255,g:127,b:80}],["cornflowerblue",{r:100,g:149,b:237}],["cornsilk",{r:255,g:248,b:220}],["crimson",{r:220,g:20,b:60}],["cyan",{r:0,g:255,b:255}],["darkblue",{r:0,g:0,b:139}],["darkcyan",{r:0,g:139,b:139}],["darkgoldenrod",{r:184,g:134,b:11}],["darkgray",{r:169,g:169,b:169}],["darkgreen",{r:0,g:100,b:0}],["darkgrey",{r:169,g:169,b:169}],["darkkhaki",{r:189,g:183,b:107}],["darkmagenta",{r:139,g:0,b:139}],["darkolivegreen",{r:85,g:107,b:47}],["darkorange",{r:255,g:140,b:0}],["darkorchid",{r:153,g:50,b:204}],["darkred",{r:139,g:0,b:0}],["darksalmon",{r:233,g:150,b:122}],["darkseagreen",{r:143,g:188,b:143}],["darkslateblue",{r:72,g:61,b:139}],["darkslategray",{r:47,g:79,b:79}],["darkslategrey",{r:47,g:79,b:79}],["darkturquoise",{r:0,g:206,b:209}],["darkviolet",{r:148,g:0,b:211}],["deeppink",{r:255,g:20,b:147}],["deepskyblue",{r:0,g:191,b:255}],["dimgray",{r:105,g:105,b:105}],["dimgrey",{r:105,g:105,b:105}],["dodgerblue",{r:30,g:144,b:255}],["firebrick",{r:178,g:34,b:34}],["floralwhite",{r:255,g:250,b:240}],["forestgreen",{r:34,g:139,b:34}],["fuchsia",{r:255,g:0,b:255}],["gainsboro",{r:220,g:220,b:220}],["ghostwhite",{r:248,g:248,b:255}],["goldenrod",{r:218,g:165,b:32}],["gold",{r:255,g:215,b:0}],["gray",{r:128,g:128,b:128}],["green",{r:0,g:128,b:0}],["greenyellow",{r:173,g:255,b:47}],["grey",{r:128,g:128,b:128}],["honeydew",{r:240,g:255,b:240}],["hotpink",{r:255,g:105,b:180}],["indianred",{r:205,g:92,b:92}],["indigo",{r:75,g:0,b:130}],["ivory",{r:255,g:255,b:240}],["khaki",{r:240,g:230,b:140}],["lavenderblush",{r:255,g:240,b:245}],["lavender",{r:230,g:230,b:250}],["lawngreen",{r:124,g:252,b:0}],["lemonchiffon",{r:255,g:250,b:205}],["lightblue",{r:173,g:216,b:230}],["lightcoral",{r:240,g:128,b:128}],["lightcyan",{r:224,g:255,b:255}],["lightgoldenrodyellow",{r:250,g:250,b:210}],["lightgray",{r:211,g:211,b:211}],["lightgreen",{r:144,g:238,b:144}],["lightgrey",{r:211,g:211,b:211}],["lightpink",{r:255,g:182,b:193}],["lightsalmon",{r:255,g:160,b:122}],["lightseagreen",{r:32,g:178,b:170}],["lightskyblue",{r:135,g:206,b:250}],["lightslategray",{r:119,g:136,b:153}],["lightslategrey",{r:119,g:136,b:153}],["lightsteelblue",{r:176,g:196,b:222}],["lightyellow",{r:255,g:255,b:224}],["lime",{r:0,g:255,b:0}],["limegreen",{r:50,g:205,b:50}],["linen",{r:250,g:240,b:230}],["magenta",{r:255,g:0,b:255}],["maroon",{r:128,g:0,b:0}],["mediumaquamarine",{r:102,g:205,b:170}],["mediumblue",{r:0,g:0,b:205}],["mediumorchid",{r:186,g:85,b:211}],["mediumpurple",{r:147,g:112,b:219}],["mediumseagreen",{r:60,g:179,b:113}],["mediumslateblue",{r:123,g:104,b:238}],["mediumspringgreen",{r:0,g:250,b:154}],["mediumturquoise",{r:72,g:209,b:204}],["mediumvioletred",{r:199,g:21,b:133}],["midnightblue",{r:25,g:25,b:112}],["mintcream",{r:245,g:255,b:250}],["mistyrose",{r:255,g:228,b:225}],["moccasin",{r:255,g:228,b:181}],["navajowhite",{r:255,g:222,b:173}],["navy",{r:0,g:0,b:128}],["oldlace",{r:253,g:245,b:230}],["olive",{r:128,g:128,b:0}],["olivedrab",{r:107,g:142,b:35}],["orange",{r:255,g:165,b:0}],["orangered",{r:255,g:69,b:0}],["orchid",{r:218,g:112,b:214}],["palegoldenrod",{r:238,g:232,b:170}],["palegreen",{r:152,g:251,b:152}],["paleturquoise",{r:175,g:238,b:238}],["palevioletred",{r:219,g:112,b:147}],["papayawhip",{r:255,g:239,b:213}],["peachpuff",{r:255,g:218,b:185}],["peru",{r:205,g:133,b:63}],["pink",{r:255,g:192,b:203}],["plum",{r:221,g:160,b:221}],["powderblue",{r:176,g:224,b:230}],["purple",{r:128,g:0,b:128}],["rebeccapurple",{r:102,g:51,b:153}],["red",{r:255,g:0,b:0}],["rosybrown",{r:188,g:143,b:143}],["royalblue",{r:65,g:105,b:225}],["saddlebrown",{r:139,g:69,b:19}],["salmon",{r:250,g:128,b:114}],["sandybrown",{r:244,g:164,b:96}],["seagreen",{r:46,g:139,b:87}],["seashell",{r:255,g:245,b:238}],["sienna",{r:160,g:82,b:45}],["silver",{r:192,g:192,b:192}],["skyblue",{r:135,g:206,b:235}],["slateblue",{r:106,g:90,b:205}],["slategray",{r:112,g:128,b:144}],["slategrey",{r:112,g:128,b:144}],["snow",{r:255,g:250,b:250}],["springgreen",{r:0,g:255,b:127}],["steelblue",{r:70,g:130,b:180}],["tan",{r:210,g:180,b:140}],["teal",{r:0,g:128,b:128}],["thistle",{r:216,g:191,b:216}],["tomato",{r:255,g:99,b:71}],["turquoise",{r:64,g:224,b:208}],["violet",{r:238,g:130,b:238}],["wheat",{r:245,g:222,b:179}],["white",{r:255,g:255,b:255}],["whitesmoke",{r:245,g:245,b:245}],["yellow",{r:255,g:255,b:0}],["yellowgreen",{r:154,g:205,b:50}]],BL="deg|rad|grad|turn",zL="[-\\+]?\\d+%?",UL="[-\\+]?\\d*\\.\\d+%?",FL=`[-\\+]?\\d*\\.?\\d+(?:${BL})?`,GL=`(?:${UL})|(?:${zL})`,VL=`(?:${GL})|(?:${FL}?)`,HL="(?:[,|\\s]+)",jL=`(?:[\\s|\\(\\s|\\s\\(\\s]+)?(${VL})${HL}(${GL})${HL}(${GL})(?:[,|\\/\\s]*)?(${GL})?(?:[\\s|\\)\\s]+)?`,WL={CSS_UNIT:new RegExp(VL),ANGLES:BL,CSS_ANGLE:FL,CSS_INTEGER:zL,CSS_NUMBER:UL,CSS_UNIT2:VL,PERMISSIVE_MATCH:jL,hwb:new RegExp(`hwb${jL}`),rgb:new RegExp(`rgb(?:a)?${jL}`),hsl:new RegExp(`hsl(?:a)?${jL}`),hsv:new RegExp(`hsv(?:a)?${jL}`),hex3:/^#?([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})$/,hex6:/^#?([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})$/,hex4:/^#?([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})$/,hex8:/^#?([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})$/},XL=t=>LL.includes(t),qL=(t,e)=>null!==t&&"object"==typeof t&&Object.keys(e).every((e=>e in t)),YL=t=>`${t}`.includes(".")&&1===parseFloat(t),JL=t=>"string"==typeof t&&t.includes("%"),$L=t=>!!WL.CSS_UNIT.exec(`${t}`),KL=["rgb","hex","hsl","hsv","hwb"],ZL=t=>!LL.includes(t)&&!["#",...KL].some((e=>t.includes(e)))&&NL.some((([e])=>t===e)),QL=(t,e)=>{let i=t;if("number"==typeof t&&0===Math.min(t,0)&&1===Math.max(t,1))return t;YL(t)&&(i="100%");const n=JL(i);return i=360===e?parseFloat(i):Math.min(e,Math.max(0,parseFloat(i))),n&&(i=i*e/100),Math.abs(i-e)<1e-6?1:(i=360===e?(i<0?i%e+e:i%e)/e:i%e/e,i)},tO=t=>{let e=parseFloat(t);return(Number.isNaN(e)||e<0||e>1)&&(e=1),e},eO=t=>Math.min(1,Math.max(0,t)),iO=t=>1===t.length?`0${t}`:String(t),nO=t=>{const[[,e]]=NL.filter((([e])=>e===t.toLowerCase()));return e},sO=t=>parseInt(t,16),rO=t=>sO(t)/255,aO=t=>OL(255*t).toString(16),oO=(t,e,i)=>{const n=Math.max(t,e,i),s=Math.min(t,e,i);let r=0,a=0;const o=(n+s)/2;if(n===s)a=0,r=0;else{const h=n-s;a=o>.5?h/(2-n-s):h/(n+s),n===t&&(r=(e-i)/h+(e<i?6:0)),n===e&&(r=(i-t)/h+2),n===i&&(r=(t-e)/h+4),r/=6}return{h:r,s:a,l:o}},hO=(t,e,i)=>{let n=i;return n<0&&(n+=1),n>1&&(n-=1),n<1/6?t+6*n*(e-t):n<.5?e:n<2/3?t+(e-t)*(2/3-n)*6:t},lO=(t,e,i)=>{let n=0,s=0,r=0;if(0===e)s=i,r=i,n=i;else if(i){const a=i<.5?i*(1+e):i+e-i*e,o=2*i-a;n=hO(o,a,t+1/3),s=hO(o,a,t),r=hO(o,a,t-1/3)}return{r:n,g:s,b:r}},cO=(t,e,i)=>{let n=0,s=0;const r=Math.min(t,e,i),a=Math.max(t,e,i),o=1-a;if(a===r)return{h:0,w:r,b:o};t===r?(n=e-i,s=3):(n=e===r?i-t:t-e,s=e===r?5:1);const h=(s-n/(a-r))/6;return{h:1===h?0:h,w:r,b:o}},uO=(t,e,i)=>{if(e+i>=1){const t=e/(e+i);return{r:t,g:t,b:t}}let{r:n,g:s,b:r}=lO(t,1,.5);return[n,s,r]=[n,s,r].map((t=>t*(1-e-i)+e)),{r:n,g:s,b:r}},dO=(t,e,i)=>{const n=Math.max(t,e,i),s=Math.min(t,e,i);let r=0;const a=n-s;return n===s?r=0:(t===n&&(r=(e-i)/a+(e<i?6:0)),e===n&&(r=(i-t)/a+2),i===n&&(r=(t-e)/a+4),r/=6),{h:r,s:0===n?0:a/n,v:n}},pO=(t,e,i)=>{const n=6*t,s=e,r=i,a=Math.floor(n),o=n-a,h=r*(1-s),l=r*(1-o*s),c=r*(1-(1-o)*s),u=a%6;return{r:[r,l,h,h,c,r][u],g:[c,r,r,l,h,h][u],b:[h,h,c,r,r,l][u]}},mO=(t,e,i,n)=>{const s=[iO(OL(t).toString(16)),iO(OL(e).toString(16)),iO(OL(i).toString(16))];return n&&s[0].charAt(0)===s[0].charAt(1)&&s[1].charAt(0)===s[1].charAt(1)&&s[2].charAt(0)===s[2].charAt(1)?s[0].charAt(0)+s[1].charAt(0)+s[2].charAt(0):s.join("")},fO=(t,e,i,n,s)=>{const r=[iO(OL(t).toString(16)),iO(OL(e).toString(16)),iO(OL(i).toString(16)),iO(aO(n))];return s&&r[0].charAt(0)===r[0].charAt(1)&&r[1].charAt(0)===r[1].charAt(1)&&r[2].charAt(0)===r[2].charAt(1)&&r[3].charAt(0)===r[3].charAt(1)?r[0].charAt(0)+r[1].charAt(0)+r[2].charAt(0)+r[3].charAt(0):r.join("")},gO=t=>{const e=String(t).trim().toLowerCase();if(ZL(e))return Object.assign(nO(e),{a:1,format:"rgb",ok:!0});if(XL(e))return{r:0,g:0,b:0,a:"transparent"===e?0:1,format:"rgb",ok:!0};let[,i,n,s,r]=WL.rgb.exec(e)||[];return i&&n&&s?{r:i,g:n,b:s,a:void 0!==r?r:1,format:"rgb",ok:!0}:([,i,n,s,r]=WL.hsl.exec(e)||[],i&&n&&s?{h:i,s:n,l:s,a:void 0!==r?r:1,format:"hsl",ok:!0}:([,i,n,s,r]=WL.hsv.exec(e)||[],i&&n&&s?{h:i,s:n,v:s,a:void 0!==r?r:1,format:"hsv",ok:!0}:([,i,n,s,r]=WL.hwb.exec(e)||[],i&&n&&s?{h:i,w:n,b:s,a:void 0!==r?r:1,format:"hwb",ok:!0}:([,i,n,s,r]=WL.hex8.exec(e)||[],i&&n&&s&&r?{r:sO(i),g:sO(n),b:sO(s),a:rO(r),format:"hex",ok:!0}:([,i,n,s]=WL.hex6.exec(e)||[],i&&n&&s?{r:sO(i),g:sO(n),b:sO(s),a:1,format:"hex",ok:!0}:([,i,n,s,r]=WL.hex4.exec(e)||[],i&&n&&s&&r?{r:sO(i+i),g:sO(n+n),b:sO(s+s),a:rO(r+r),format:"hex",ok:!0}:([,i,n,s]=WL.hex3.exec(e)||[],i&&n&&s?{r:sO(i+i),g:sO(n+n),b:sO(s+s),a:1,format:"hex",ok:!0}:{r:0,g:0,b:0,a:1,format:"rgb",ok:!t})))))))},vO=t=>{let e,i,n,s,r,a,o,h,l={r:0,g:0,b:0},c=t,u=1,d="rgb",p=!1;return(!c||"string"==typeof c)&&(c=gO(c),p=c.ok),qL(c,l)&&$L(c.r)&&$L(c.g)&&$L(c.b)&&(({r:o,g:h,b:r}=c),[o,h,r]=[o,h,r].map((t=>QL(t,JL(t)?100:255))),l={r:o,g:h,b:r},d="format"in c?c.format:"rgb"),qL(c,{h:0,s:0,v:0})&&$L(c.h)&&$L(c.s)&&$L(c.v)&&(({h:a,s:e,v:i}=c),a=QL(a,360),e=QL(e,100),i=QL(i,100),l=pO(a,e,i),d="hsv"),qL(c,{h:0,s:0,l:0})&&$L(c.h)&&$L(c.s)&&$L(c.l)&&(({h:a,s:e,l:n}=c),a=QL(a,360),e=QL(e,100),n=QL(n,100),l=lO(a,e,n),d="hsl"),qL(c,{h:0,w:0,b:0})&&$L(c.h)&&$L(c.w)&&$L(c.b)&&(({h:a,w:s,b:r}=c),a=QL(a,360),s=QL(s,100),r=QL(r,100),l=uO(a,s,r),d="hwb"),$L(c.a)&&(u=c.a,u=JL(u)||parseFloat(`${u}`)>1?QL(u,100):u),{r:l.r,g:l.g,b:l.b,a:tO(u),format:d,ok:p}};class yO{static matchers=WL;static isOnePointZero=YL;static isPercentage=JL;static isValidCSSUnit=$L;static isNonColor=XL;static isColorName=ZL;static isColorType=qL;static pad2=iO;static clamp01=eO;static bound01=QL;static boundAlpha=tO;static getRGBFromName=nO;static convertHexToDecimal=rO;static convertDecimalToHex=aO;static rgbToHsl=oO;static rgbToHex=mO;static rgbToHsv=dO;static rgbToHwb=cO;static rgbaToHex=fO;static hslToRgb=pO;static hsvToRgb=pO;static hueToRgb=hO;static hwbToRgb=uO;static parseIntFromHex=sO;static stringInputToObject=gO;static inputToRGB=vO;static roundPart=OL;static webColors=NL;static nonColors=LL;static version="1.0.8";r;g;b;a;format;ok;originalInput;constructor(t,e){const i=e&&KL.includes(e)?e:"",{r:n,g:s,b:r,a,ok:o,format:h}=vO(t);this.originalInput=t,this.r=n,this.g=s,this.b=r,this.a=a,this.ok=o,this.format=i||h}get isValid(){return this.ok}get isDark(){return this.brightness<120}get luminance(){const{r:t,g:e,b:i}=this;let n=0,s=0,r=0;return n=t<=.03928?t/12.92:((t+.055)/1.055)**2.4,s=e<=.03928?e/12.92:((e+.055)/1.055)**2.4,r=i<=.03928?i/12.92:((i+.055)/1.055)**2.4,.2126*n+.7152*s+.0722*r}get brightness(){const{r:t,g:e,b:i}=this.toRgb();return(299*t+587*e+114*i)/1e3}get name(){const{r:t,g:e,b:i}=this.toRgb(),[n]=NL.map((([n,s])=>[n,((.3*(s.r-t))**2+(.6*(s.g-e))**2+(.1*(s.b-i))**2)**.5])).find((([,t],e,i)=>t===Math.min(...i.map((([,t])=>t)))));return n}toRgb(){let{r:t,g:e,b:i,a:n}=this;return[t,e,i]=[t,e,i].map((t=>OL(255*t*100)/100)),n=OL(100*n)/100,{r:t,g:e,b:i,a:n}}toRgbString(){const{r:t,g:e,b:i,a:n}=this.toRgb(),[s,r,a]=[t,e,i].map(OL);return 1===n?`rgb(${s}, ${r}, ${a})`:`rgba(${s}, ${r}, ${a}, ${n})`}toRgbCSS4String(){const{r:t,g:e,b:i,a:n}=this.toRgb(),[s,r,a]=[t,e,i].map(OL);return`rgb(${s} ${r} ${a}${1===n?"":` / ${OL(100*n)}%`})`}toHex(t){const{r:e,g:i,b:n,a:s}=this.toRgb();return 1===s?mO(e,i,n,t):fO(e,i,n,s,t)}toHexString(t){return`#${this.toHex(t)}`}toHex8(t){const{r:e,g:i,b:n,a:s}=this.toRgb();return fO(e,i,n,s,t)}toHex8String(t){return`#${this.toHex8(t)}`}toHsv(){const{r:t,g:e,b:i,a:n}=this,{h:s,s:r,v:a}=dO(t,e,i);return{h:s,s:r,v:a,a:n}}toHsl(){const{r:t,g:e,b:i,a:n}=this,{h:s,s:r,l:a}=oO(t,e,i);return{h:s,s:r,l:a,a:n}}toHslString(){let{h:t,s:e,l:i,a:n}=this.toHsl();return t=OL(360*t),e=OL(100*e),i=OL(100*i),n=OL(100*n)/100,1===n?`hsl(${t}, ${e}%, ${i}%)`:`hsla(${t}, ${e}%, ${i}%, ${n})`}toHslCSS4String(){let{h:t,s:e,l:i,a:n}=this.toHsl();t=OL(360*t),e=OL(100*e),i=OL(100*i),n=OL(100*n);return`hsl(${t}deg ${e}% ${i}%${n<100?` / ${OL(n)}%`:""})`}toHwb(){const{r:t,g:e,b:i,a:n}=this,{h:s,w:r,b:a}=cO(t,e,i);return{h:s,w:r,b:a,a:n}}toHwbString(){let{h:t,w:e,b:i,a:n}=this.toHwb();t=OL(360*t),e=OL(100*e),i=OL(100*i),n=OL(100*n);return`hwb(${t}deg ${e}% ${i}%${n<100?` / ${OL(n)}%`:""})`}setAlpha(t){return"number"!=typeof t||(this.a=tO(t)),this}saturate(t){if("number"!=typeof t)return this;const{h:e,s:i,l:n}=this.toHsl(),{r:s,g:r,b:a}=lO(e,eO(i+t/100),n);return Object.assign(this,{r:s,g:r,b:a}),this}desaturate(t){return"number"==typeof t?this.saturate(-t):this}greyscale(){return this.saturate(-100)}lighten(t){if("number"!=typeof t)return this;const{h:e,s:i,l:n}=this.toHsl(),{r:s,g:r,b:a}=lO(e,i,eO(n+t/100));return Object.assign(this,{r:s,g:r,b:a}),this}darken(t){return"number"==typeof t?this.lighten(-t):this}spin(t){if("number"!=typeof t)return this;const{h:e,s:i,l:n}=this.toHsl(),{r:s,g:r,b:a}=lO(eO((360*e+t)%360/360),i,n);return Object.assign(this,{r:s,g:r,b:a}),this}clone(){return new yO(this)}toString(t){const{format:e}=this;return"hex"===e?this.toHexString(t):"hsl"===e?this.toHslString():"hwb"===e?this.toHwbString():this.toRgbString()}}class xO{static Color=yO;hue;hueSteps;lightSteps;saturation;colors;constructor(...t){let e=0,i=12,n=10,s=[.5],r=100;if(4===t.length)[e,i,n,r]=t;else if(3===t.length)[e,i,n]=t;else if(2===t.length&&([i,n]=t,[i,n].some((t=>t<1))))throw TypeError("ColorPalette: the two minimum arguments must be numbers higher than 0.");const a=[],o=360/i,h=yO.roundPart((n-(n%2?1:0))/2),l=[[1,2,3],[4,5],[6,7],[8,9],[10,11],[12,13]],c=l.find((t=>t.includes(n))),u=c?[.25,.2,.15,.11,.09,.075][l.indexOf(c)]:100/(n+(n%2?0:1))/100;for(let t=1;t<h+1;t+=1)s=[...s,.5+u*t];for(let t=1;t<n-h;t+=1)s=[.5-u*t,...s];for(let t=0;t<i;t+=1){const i=(e+t*o)%360/360;s.forEach((t=>{const e=new yO({h:i,s:1,l:t});a.push(r<100?e.saturate(r-100):e)}))}this.hue=e,this.hueSteps=i,this.lightSteps=n,this.saturation=r,this.colors=a}}const bO={pickerLabel:"Colour Picker",appearanceLabel:"Colour Appearance",valueLabel:"Colour Value",toggleLabel:"Select Colour",presetsLabel:"Colour Presets",defaultsLabel:"Colour Defaults",formatLabel:"Format",alphaLabel:"Alpha",hexLabel:"Hexadecimal",hueLabel:"Hue",whitenessLabel:"Whiteness",blacknessLabel:"Blackness",saturationLabel:"Saturation",lightnessLabel:"Lightness",redLabel:"Red",greenLabel:"Green",blueLabel:"Blue"},_O=["white","black","grey","red","orange","brown","gold","olive","yellow","lime","green","teal","cyan","blue","violet","magenta","pink"],wO=t=>{if(!uL(t))return!1;try{JSON.parse(t)}catch{return!1}return!0},MO="v-hidden",SO=(t,e,i)=>{const{input:n,format:s,componentLabels:r}=t,{defaultsLabel:a,presetsLabel:o}=r,h="color-options"===i,l=e instanceof xO,c=h?o:a,u=l?e.colors:e,d=u.length,{lightSteps:p}=l?e:{lightSteps:null},m=p||[9,10].find((t=>d>=2*t&&!(d%t)))||5,f=h&&d>m;let g=2;g=f&&d>2*m?3:g,g=f&&d>3*m?4:g,g=f&&d>4*m?5:g;const v=g-(d<=3*m?1:2),y=f&&d>v*m;let x=i;x+=y?" scrollable":"",x+=f?" multiline":"";const b=f?"1px":"0.25rem";let _=f?1.75:2;_=m>5&&f?1.5:_;const w=v*_+"rem",M=`calc(${g} * ${_}rem + ${g-1} * ${b})`,S=fL({tagName:"ul",className:x,role:"listbox",ariaLabel:c});return y&&wL(S,{"--grid-item-size":`${_}rem`,"--grid-fit":`${m}`,"--grid-gap":b,"--grid-height":w,"--grid-hover-height":M}),u.forEach((t=>{let[e,i]="string"==typeof t?t.trim().split(":"):[];t instanceof yO&&(e=t.toHexString(),i=e);const r=new yO(t instanceof yO?t:e,s).toString()===tL(n,"value"),a=fL({tagName:"li",className:"color-option"+(r?" active":""),innerText:`${i||e}`,tabIndex:0,role:"option",ariaSelected:r?"true":"false"});eL(a,"data-value",`${e}`),h&&wL(a,{backgroundColor:e}),S.append(a)})),S},EO=t=>{const{input:e,parent:i,format:n,id:s,componentLabels:r,colorKeywords:a,colorPresets:o}=t,h=tL(e,"value")||"#fff",{nonColors:l}=yO,{toggleLabel:c,pickerLabel:u,formatLabel:d,hexLabel:p}=r,m=l.includes(h)?"#fff":h;t.color=new yO(m,n);const f="hex"===n?p:ML(n),g=fL({id:`picker-btn-${s}`,tagName:"button",type:"button",className:"picker-toggle btn-appearance",ariaExpanded:"false",ariaHasPopup:"true"});g.append(fL({tagName:"span",className:MO,innerText:`${u}. ${d}: ${f}`}));const v=fL({tagName:"div",className:"color-dropdown picker",role:"group",ariaLabelledBy:`picker-btn-${s}`}),y=(t=>{const{format:e,componentLabels:i}=t,{hueLabel:n,alphaLabel:s,lightnessLabel:r,saturationLabel:a,whitenessLabel:o,blacknessLabel:h}=i,l="hsl"===e?360:100,c="hsl"===e?100:360;let u="hsl"===e?`${n} & ${r}`:`${r} & ${a}`;u="hwb"===e?`${o} & ${h}`:u;const d="hsl"===e?`${a}`:`${n}`,p=fL({tagName:"div",className:`color-controls ${e}`}),m="color-slider";return[{i:1,c:"color-pointer",l:u,min:0,max:l},{i:2,c:m,l:d,min:0,max:c},{i:3,c:m,l:s,min:0,max:100}].forEach((t=>{const{i:e,c:i,l:n,min:s,max:r}=t,a=fL({tagName:"div",className:"color-control",role:"presentation"});a.append(fL({tagName:"div",className:`visual-control visual-control${e}`}));const o=fL({tagName:"div",className:`${i} knob`,ariaLive:"polite",ariaLabel:n,role:"slider",tabIndex:0,ariaValueMin:`${s}`,ariaValueMax:`${r}`});a.append(o),p.append(a)})),p})(t),x=(t=>{const{format:e,id:i,componentLabels:n}=t,s=fL({tagName:"div",className:`color-form ${e}`});let r=["hex"];return"rgb"===e?r=["red","green","blue","alpha"]:"hsl"===e?r=["hue","saturation","lightness","alpha"]:"hwb"===e&&(r=["hue","whiteness","blackness","alpha"]),r.forEach((t=>{const[r]="hex"===e?["#"]:ML(t).split(""),a=`color_${e}_${t}_${i}`,o=n[`${t}Label`],h=fL({tagName:"label"});eL(h,"for",a),h.append(fL({tagName:"span",ariaHidden:"true",innerText:`${r}:`}),fL({tagName:"span",className:MO,innerText:o}));const l=fL({tagName:"input",id:a,type:"hex"===e?"text":"number",value:"alpha"===t?"100":"0",className:`color-input ${t}`,autocomplete:"off",spellcheck:!1});let c="100",u="1";"alpha"!==t&&("rgb"===e?(c="255",u="1"):"hue"===t&&(c="360",u="1")),mL(l,{min:"0",max:c,step:u}),s.append(h,l)})),s})(t);if(v.append(y,x),e.before(g),i.append(v),a||o){const e=fL({tagName:"div",className:"color-dropdown scrollable menu"});o&&e.append(SO(t,o,"color-options")),a&&a.length&&e.append(SO(t,a,"color-defaults"));const n=fL({tagName:"button",type:"button",className:"menu-toggle btn-appearance",tabIndex:-1,ariaExpanded:"false",ariaHasPopup:"true"}),s=encodeURI("http://www.w3.org/2000/svg"),r=gL(s,{tagName:"svg"});eL(r,"xmlns",s),eL(r,"viewBox","0 0 512 512"),eL(r,"aria-hidden","true");const h=gL(s,{tagName:"path"});eL(h,"d","M98,158l157,156L411,158l27,27L255,368L71,185L98,158z"),eL(h,"fill","#fff"),r.append(h),n.append(fL({tagName:"span",className:MO,innerText:`${c}`}),r),i.append(n,e)}a&&l.includes(h)&&(t.value=h),eL(e,jD,"-1")},TO="color-picker",AO=`[data-function="${TO}"]`,CO=`.${TO}`,IO={componentLabels:bO,colorLabels:_O,format:"rgb",colorPresets:!1,colorKeywords:!1},{roundPart:RO,nonColors:kO}=yO,PO=t=>((t,e)=>cL.get(t,e))(t,TO),DO=t=>new UO(t),LO=(t,e)=>{const i=e?KD:ZD,{input:n,pickerToggle:s,menuToggle:r}=t;i(n,"focusin",t.showPicker),i(s,OD,t.togglePicker),r&&i(r,OD,t.toggleMenu)},OO=(t,e)=>{const i=e?KD:ZD,{input:n,colorMenu:s,parent:r}=t,a=pL(n),o=(t=>{var e;return t?dL(t)?t.defaultView:oL(t)?null==(e=t?.ownerDocument)?void 0:e.defaultView:t:window})(a);i(t.controls,"pointerdown",t.pointerDown),t.controlKnobs.forEach((e=>i(e,LD,t.handleKnobs))),i(o,"scroll",t.handleScroll),i(o,"resize",t.update),[n,...t.inputs].forEach((e=>i(e,"change",t.changeHandler))),s&&(i(s,OD,t.menuClickHandler),i(s,LD,t.menuKeyHandler)),i(a,ND,t.pointerMove),i(a,"pointerup",t.pointerUp),i(r,"focusout",t.handleFocusOut),i(a,"keyup",t.handleDismiss)},NO=t=>{((t,e)=>{t.dispatchEvent(e)})(t.input,new CustomEvent("colorpicker.change"))},BO=t=>{t&&["bottom","top"].forEach((e=>sL(t,e)))},zO=(t,e)=>{const{colorPicker:i,colorMenu:n,menuToggle:s,pickerToggle:r,parent:a}=t,o=e===i,h=o?n:i,l=o?s:r,c=o?r:s;rL(a,"open")||nL(a,"open"),h&&(sL(h,"show"),BO(h)),nL(e,"bottom"),(t=>{t.offsetHeight})(e),nL(e,"show"),o&&t.update(),t.isOpen||(OO(t,!0),t.updateDropdownPosition(),t.isOpen=!0,eL(t.input,jD,"0"),s&&eL(s,jD,"0")),eL(c,RD,"true"),l&&eL(l,RD,"false")};class UO{static Color=yO;static ColorPalette=xO;static getInstance=PO;static init=DO;static selector=AO;static roundPart=RO;static setElementStyle=wL;static setAttribute=eL;static getBoundingClientRect=SL;static version="2.0.0-alpha10";static colorNames=_O;static colorPickerLabels=bO;id;input;color;format="rgb";parent;dragElement;isOpen=!1;controlPositions;colorLabels=_L(_O.map((t=>[t,t])));colorKeywords;colorPresets;componentLabels;pickerToggle;menuToggle;colorPicker;colorMenu;controls;inputs;controlKnobs;visuals;constructor(t,e){const i=PL(t);if(typeof t>"u")throw new TypeError("ColorPicker target not specified.");if(uL(t)&&!i)throw new TypeError(`ColorPicker target "${t}" cannot be found.`);this.input=i;const n=kL(i,CO);if(!n)throw new TypeError("ColorPicker requires a specific markup to work.");this.parent=n,this.id=IL(i,TO),this.dragElement=void 0,this.isOpen=!1,this.controlPositions={c1x:0,c1y:0,c2y:0,c3y:0},this.colorKeywords=!1,this.colorPresets=!1;const{format:s,componentLabels:r,colorLabels:a,colorKeywords:o,colorPresets:h}=((t,e,i,n)=>{const s={...i},r={...t.dataset},a={...e},o={},h="title";return bL(r).forEach((([t,e])=>{const i=n&&"string"==typeof t&&t.includes(n)?t.replace(n,"").replace(/[A-Z]/g,(t=>(t=>t.toLowerCase())(t))):t;o[i]=xL(e)})),bL(s).forEach((([t,e])=>{s[t]=xL(e)})),bL(e).forEach((([e,i])=>{a[e]=e in s?s[e]:e in o?o[e]:e===h?tL(t,h):i})),a})(i,IO,e||{});let l=_O;RL(a)&&17===a.length?l=a:uL(a)&&17===a.split(",").length&&(l=a.split(",")),mL(this.colorLabels,_L(l.map(((t,e)=>[_O[e],t]))));const c=uL(r)&&wO(r)?JSON.parse(r):r;if(this.componentLabels=mL({...bO},c),this.color=new yO(i.value||"#fff",s),this.format=s,RL(o)&&o.length?this.colorKeywords=o:uL(o)&&o.length&&(this.colorKeywords=o.split(",").map((t=>t.trim()))),RL(h)&&h.length)this.colorPresets=h;else if(h&&wO(h)){const{hue:t,hueSteps:e,lightSteps:i,saturation:n}=JSON.parse(h);this.colorPresets=new xO(t,e,i,n)}else uL(h)&&(this.colorPresets=h.split(",").map((t=>t.trim())));EO(this);const[u,d]=DL("color-dropdown",n);this.pickerToggle=PL(".picker-toggle",n),this.menuToggle=PL(".menu-toggle",n),this.colorPicker=u,this.colorMenu=d,this.inputs=[...DL("color-input",n)];const[p]=DL("color-controls",n);this.controls=p,this.controlKnobs=[...DL("knob",p)],this.visuals=[...DL("visual-control",p)],this.update(),LO(this,!0),cL.set(i,TO,this)}get value(){return this.input.value}set value(t){this.input.value=t}get hasNonColor(){return this.colorKeywords instanceof Array&&this.colorKeywords.some((t=>kO.includes(t)))}get hex(){return this.color.toHex(!0)}get hsv(){return this.color.toHsv()}get hsl(){return this.color.toHsl()}get hwb(){return this.color.toHwb()}get rgb(){return this.color.toRgb()}get brightness(){return this.color.brightness}get luminance(){return this.color.luminance}get isDark(){const{color:t,brightness:e}=this;return e<120&&t.a>.33}get isValid(){const t=this.input.value;return""!==t&&new yO(t).isValid}get appearance(){const{colorLabels:t,hsl:e,hsv:i,format:n}=this,s=RO(360*e.h),r="hsl"===n?e.s:i.s,a=RO(100*r),o=RO(100*e.l),h=100*i.v;let l="black";if(100===o&&0===a)l=t.white;else if(0===o)l=t.black;else if(0===a)l=t.grey;else if(s<15||s>=345)l=t.red;else if(s>=15&&s<45)l=h>80&&a>80?t.orange:t.brown;else if(s>=45&&s<75){const e=s>=54&&s<75&&h<80;l=s>46&&s<54&&h<80&&a>90?t.gold:t.yellow,l=e?t.olive:l}else s>=75&&s<155?l=h<68?t.green:t.lime:s>=155&&s<175?l=t.teal:s>=175&&s<195?l=t.cyan:s>=195&&s<255?l=t.blue:s>=255&&s<270?l=t.violet:s>=270&&s<295?l=t.magenta:s>=295&&s<345&&(l=t.pink);return l}updateVisuals(){const{controlPositions:t,visuals:e}=this,[i,n,s]=e,{offsetHeight:r}=i,a=t.c2y/r,{r:o,g:h,b:l}=new yO({h:a,s:1,l:.5}).toRgb(),c=1-t.c3y/r,u=RO(100*c)/100,d=new yO({h:a,s:1,l:.5,a:c}).toRgbString();wL(i,{background:`linear-gradient(rgba(0,0,0,0) 0%, rgba(0,0,0,${u}) 100%),\n      linear-gradient(to right, rgba(255,255,255,${u}) 0%, ${d} 100%),\n      linear-gradient(rgb(255,255,255) 0%, rgb(255,255,255) 100%)`}),wL(n,{background:"linear-gradient(\n      rgb(255,0,0) 0%, rgb(255,255,0) 16.67%,\n      rgb(0,255,0) 33.33%, rgb(0,255,255) 50%,\n      rgb(0,0,255) 66.67%, rgb(255,0,255) 83.33%,\n      rgb(255,0,0) 100%)"}),wL(s,{background:`linear-gradient(rgba(${o},${h},${l},1) 0%,rgba(${o},${h},${l},0) 100%)`})}handleFocusOut=({relatedTarget:t})=>{t&&!this.parent.contains(t)&&this.hide(!0)};handleDismiss=({code:t})=>{this.isOpen&&"Escape"===t&&this.hide()};handleScroll=t=>{const{activeElement:e}=pL(this.input);this.updateDropdownPosition(),([ND,BD].includes(t.type)&&this.dragElement||e&&this.controlKnobs.includes(e))&&(t.stopPropagation(),t.preventDefault())};menuKeyHandler=t=>{const{target:e,code:i}=t,{previousElementSibling:n,nextElementSibling:s,parentElement:r}=e,a=r&&rL(r,"color-options"),o=r?[...r.children]:[],h=a&&vL(r,"grid-template-columns").split(" ").length,l=o.indexOf(e),c=l>-1&&h&&o[l-h],u=l>-1&&h&&o[l+h];[zD,UD,HD].includes(i)&&t.preventDefault(),a?c&&i===UD?yL(c):u&&i===zD?yL(u):n&&i===FD?yL(n):s&&i===GD&&yL(s):n&&[FD,UD].includes(i)?yL(n):s&&[GD,zD].includes(i)&&yL(s),[VD,HD].includes(i)&&this.menuClickHandler(t)};menuClickHandler=t=>{const{target:e}=t,{colorMenu:i}=this,n=(tL(e,"data-value")||"").trim();if(!n.length)return;const s=PL("li.active",i);let r=n;r=kO.includes(r)?"white":r,r="transparent"===r?"rgba(0,0,0,0)":r;const{r:a,g:o,b:h,a:l}=new yO(r);mL(this.color,{r:a,g:o,b:h,a:l}),this.update(),s!==e&&(s&&(sL(s,"active"),iL(s,kD)),nL(e,"active"),eL(e,kD,"true"),kO.includes(n)&&(this.value=n),NO(this))};pointerDown=t=>{if(0!==t.button)return;const{target:e,pageX:i,pageY:n}=t,{colorMenu:s,visuals:r,controlKnobs:a}=this,[o,h,l]=r,[c,u,d]=a,p=a.includes(e)?e.previousElementSibling:e,m=SL(p),f=EL(o),g=i-f.scrollLeft-m.left,v=n-f.scrollTop-m.top;if(e===o||e===c?(this.dragElement=p,this.changeControl1(g,v)):e===h||e===u?(this.dragElement=p,this.changeControl2(v)):(e===l||e===d)&&(this.dragElement=p,this.changeAlpha(v)),s){const t=PL("li.active",s);t&&(sL(t,"active"),iL(t,kD))}t.preventDefault()};pointerUp=({target:t})=>{const{parent:e}=this,i=pL(e),n=null!==PL(`${CO}.open`,i),s=i.getSelection();!this.dragElement&&(!s||!s.toString().length)&&!e.contains(t)&&this.hide(n),this.dragElement=void 0};pointerMove=t=>{const{dragElement:e,visuals:i}=this,[n,s,r]=i,{pageX:a,pageY:o}=t;if(!e)return;const h=SL(e),l=EL(n),c=a-l.scrollLeft-h.left,u=o-l.scrollTop-h.top;e===n&&this.changeControl1(c,u),e===s&&this.changeControl2(u),e===r&&this.changeAlpha(u)};handleKnobs=t=>{const{target:e,code:i}=t;if(![UD,zD,FD,GD].includes(i))return;t.preventDefault();const{controlKnobs:n,visuals:s}=this,{offsetWidth:r,offsetHeight:a}=s[0],[o,h,l]=n,{activeElement:c}=pL(o),u=a/360;if(n.find((t=>t===c))){let n=0,s=0;if(e===o){const t=r/100;[FD,GD].includes(i)?this.controlPositions.c1x+=i===GD?t:-t:[UD,zD].includes(i)&&(this.controlPositions.c1y+=i===zD?u:-u),n=this.controlPositions.c1x,s=this.controlPositions.c1y,this.changeControl1(n,s)}else e===h?(this.controlPositions.c2y+=[zD,GD].includes(i)?u:-u,s=this.controlPositions.c2y,this.changeControl2(s)):e===l&&(this.controlPositions.c3y+=[zD,GD].includes(i)?u:-u,s=this.controlPositions.c3y,this.changeAlpha(s));this.handleScroll(t)}};changeHandler=()=>{let t;const{inputs:e,format:i,value:n,input:s,controlPositions:r,visuals:a}=this,{activeElement:o}=pL(s),{offsetHeight:h}=a[0],[l,,,c]=e,[u,d,p,m]="rgb"===i?e.map((t=>parseFloat(t.value)/(t===c?100:1))):e.map((t=>parseFloat(t.value)/(t!==l?100:360))),f=this.hasNonColor&&kO.includes(n),g=c?m:1-r.c3y/h;if(o===s||o&&e.includes(o)){t=o===s?f?"transparent"===n?"rgba(0,0,0,0)":"rgb(0,0,0)":n:"hex"===i?l.value:"hsl"===i?{h:u,s:d,l:p,a:g}:"hwb"===i?{h:u,w:d,b:p,a:g}:{r:u,g:d,b:p,a:g};const{r:e,g:r,b:a,a:h}=new yO(t);mL(this.color,{r:e,g:r,b:a,a:h}),this.setControlPositions(),this.updateAppearance(),this.updateInputs(),this.updateControls(),this.updateVisuals(),o===s&&f&&(this.value=n)}};changeControl1(t,e){let[i,n]=[0,0];const{controlPositions:s,visuals:r}=this,{offsetHeight:a,offsetWidth:o}=r[0];t>o?i=o:t>=0&&(i=t),e>a?n=a:e>=0&&(n=e);const h=s.c2y/a,l=i/o,c=1-n/a,u=1-s.c3y/a,{r:d,g:p,b:m,a:f}=new yO({h,s:l,v:c,a:u});mL(this.color,{r:d,g:p,b:m,a:f}),this.controlPositions.c1x=i,this.controlPositions.c1y=n,this.updateAppearance(),this.updateInputs(),this.updateControls(),this.updateVisuals()}changeControl2(t){const{controlPositions:e,visuals:i}=this,{offsetHeight:n,offsetWidth:s}=i[0];let r=0;t>n?r=n:t>=0&&(r=t);const a=r/n,o=e.c1x/s,h=1-e.c1y/n,l=1-e.c3y/n,{r:c,g:u,b:d,a:p}=new yO({h:a,s:o,v:h,a:l});mL(this.color,{r:c,g:u,b:d,a:p}),this.controlPositions.c2y=r,this.updateAppearance(),this.updateInputs(),this.updateControls(),this.updateVisuals()}changeAlpha(t){const{visuals:e}=this,{offsetHeight:i}=e[0];let n=0;t>i?n=i:t>=0&&(n=t);const s=1-n/i;this.color.setAlpha(s),this.controlPositions.c3y=n,this.updateAppearance(),this.updateInputs(),this.updateControls(),this.updateVisuals()}update=()=>{this.updateDropdownPosition(),this.updateAppearance(),this.setControlPositions(),this.updateInputs(!0),this.updateControls(),this.updateVisuals()};updateDropdownPosition(){const{input:t,colorPicker:e,colorMenu:i}=this,n=SL(t),{top:s,bottom:r}=n,{offsetHeight:a}=t,o=EL(t).clientHeight,h=rL(e,"show")?e:i;if(!h)return;const{offsetHeight:l}=h,c=o-r,u=s,d=s+l+a>o,p=s-l<0;(rL(h,"bottom")||!p)&&c<u&&d?(sL(h,"bottom"),nL(h,"top")):(sL(h,"top"),nL(h,"bottom"))}setControlPositions(){const{visuals:t,color:e,hsv:i}=this,{offsetHeight:n,offsetWidth:s}=t[0],r=e.a,a=i.h,o=i.s,h=i.v;this.controlPositions.c1x=o*s,this.controlPositions.c1y=(1-h)*n,this.controlPositions.c2y=a*n,this.controlPositions.c3y=(1-r)*n}updateAppearance(){const{componentLabels:t,color:e,parent:i,hsv:n,hex:s,format:r,controlKnobs:a}=this,{appearanceLabel:o,hexLabel:h,valueLabel:l}=t;let{r:c,g:u,b:d}=e.toRgb();const[p,m,f]=a,g=RO(360*n.h),v=e.a,y=RO(100*n.s),x=RO(100*n.v),b=this.appearance;let _=`${h} ${s.split("").join(" ")}`;if("hwb"===r){const{hwb:t}=this,e=RO(100*t.w),i=RO(100*t.b);_=`HWB: ${g}, ${e}%, ${i}%`,eL(p,DD,`${e}% & ${i}%`),eL(p,PD,`${e}`),eL(m,ID,`${l}: ${_}. ${o}: ${b}.`),eL(m,DD,`${g}%`),eL(m,PD,`${g}`)}else[c,u,d]=[c,u,d].map(RO),_="hsl"===r?`HSL: ${g}, ${y}%, ${x}%`:_,_="rgb"===r?`RGB: ${c}, ${u}, ${d}`:_,eL(p,DD,`${x}% & ${y}%`),eL(p,PD,`${x}`),eL(m,ID,`${l}: ${_}. ${o}: ${b}.`),eL(m,DD,`${g}`),eL(m,PD,`${g}`);const w=RO(100*v);eL(f,DD,`${w}%`),eL(f,PD,`${w}`);const M=e.toString();wL(this.input,{backgroundColor:M}),this.isDark?(rL(i,"txt-light")&&sL(i,"txt-light"),rL(i,"txt-dark")||nL(i,"txt-dark")):(rL(i,"txt-dark")&&sL(i,"txt-dark"),rL(i,"txt-light")||nL(i,"txt-light"))}updateControls(){const{controlKnobs:t,controlPositions:e}=this;let{c1x:i,c1y:n,c2y:s,c3y:r}=e;const[a,o,h]=t;[i,n,s,r]=[i,n,s,r].map(RO),wL(a,{transform:`translate3d(${i-4}px,${n-4}px,0)`}),wL(o,{transform:`translate3d(0,${s-4}px,0)`}),wL(h,{transform:`translate3d(0,${r-4}px,0)`})}updateInputs(t){const{value:e,format:i,inputs:n,color:s,hsl:r}=this,[a,o,h,l]=n,c=RO(100*s.a),u=RO(360*r.h);let d=s.toString();if("hex"===i)d=this.color.toHexString(!0),a.value=this.hex;else if("hsl"===i){const t=RO(100*r.l),e=RO(100*r.s);d=this.color.toHslString(),a.value=`${u}`,o.value=`${e}`,h.value=`${t}`,l.value=`${c}`}else if("hwb"===i){const{w:t,b:e}=this.hwb,i=RO(100*t),n=RO(100*e);d=this.color.toHwbString(),a.value=`${u}`,o.value=`${i}`,h.value=`${n}`,l.value=`${c}`}else if("rgb"===i){let{r:t,g:e,b:i}=this.rgb;[t,e,i]=[t,e,i].map(RO),d=this.color.toRgbString(),a.value=`${t}`,o.value=`${e}`,h.value=`${i}`,l.value=`${c}`}this.value=d,!t&&d!==e&&NO(this)}togglePicker=t=>{t&&t.preventDefault();const{colorPicker:e}=this;this.isOpen&&rL(e,"show")?this.hide(!0):zO(this,e)};showPicker=()=>{const{colorPicker:t}=this;["top","bottom"].some((e=>rL(t,e)))||zO(this,t)};toggleMenu=t=>{t&&t.preventDefault();const{colorMenu:e}=this;this.isOpen&&rL(e,"show")?this.hide(!0):zO(this,e)};hide(t){if(this.isOpen){const{pickerToggle:e,menuToggle:i,colorPicker:n,colorMenu:s,parent:r,input:a}=this,o=rL(n,"show"),h=o?n:s,l=o?e:i,c=h&&(t=>{const e=vL(t,"transitionProperty"),i=vL(t,"transitionDuration"),n=i.includes("ms")?1:1e3,s=e&&"none"!==e?parseFloat(i)*n:0;return Number.isNaN(s)?0:s})(h);this.value=this.color.toString(!0),h&&(sL(h,"show"),eL(l,RD,"false"),setTimeout((()=>{BO(h),PL(".show",r)||(sL(r,"open"),OO(this),this.isOpen=!1)}),c)),t||yL(e),eL(a,jD,"-1"),l===i&&eL(i,jD,"-1")}}dispose(){const{input:t,parent:e}=this;this.hide(!0),LO(this),[...e.children].forEach((e=>{e!==t&&e.remove()})),iL(t,jD),wL(t,{backgroundColor:""}),["txt-light","txt-dark"].forEach((t=>sL(e,t))),cL.remove(t,TO)}}var FO=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class GO{get Html(){return this.html}constructor(t){this.meta=t,this.mode=DP.EditPlay,this.color="#fff",this.brickSize=new Le(3,3,1),this.brickRotate=new Le,this.html="",this.LoadHtml()}Initialize(t,e){this.mode=t,this.updateEvent=e}LoadHtml(){return FO(this,void 0,void 0,(function*(){return yield fetch("views/common/brick.html").then((t=>t.text())).then((t=>{this.html=t}))}))}GetElement(){const t=document.getElementById("x_up"),e=document.getElementById("x_down"),i=document.getElementById("y_up"),n=document.getElementById("y_down"),s=document.getElementById("z_up"),r=document.getElementById("z_down"),a=document.getElementById("y_rotation"),o=document.getElementById("x_rotation"),h=document.getElementById("brickmodeexit");t.onclick=()=>this.ChangeBrickSize("x",1),e.onclick=()=>this.ChangeBrickSize("x",-1),i.onclick=()=>this.ChangeBrickSize("y",1),n.onclick=()=>this.ChangeBrickSize("y",-1),s.onclick=()=>this.ChangeBrickSize("z",1),r.onclick=()=>this.ChangeBrickSize("z",-1),a.onclick=()=>this.ChangeRotation(0,90,0),o.onclick=()=>this.ChangeRotation(90,0,0),h.onclick=()=>{this.meta.ModeChange(this.mode),this.updateEvent&&this.updateEvent(this.mode)},this.myPicker=new UO("#myPicker"),this.myPicker.pointerMove=()=>{const t=document.getElementById("myPicker");t.value!=this.color&&(this.color=t.value,this.meta.ChangeBrickInfo({color:t.value}))}}ChangeBrickSize(t,e){if(!("x"==t&&this.brickSize.x+e<1||"y"==t&&this.brickSize.y+e<1||"z"==t&&this.brickSize.z+e<1)){switch(t){case"x":this.brickSize.x+=e;break;case"y":this.brickSize.y+=e;break;case"z":this.brickSize.z+=e}this.UpdateBrickUI(),this.meta.ChangeBrickInfo({v:this.brickSize})}}ChangeRotation(t,e,i){this.brickRotate.set(t,e,i),this.meta.ChangeBrickInfo({r:this.brickRotate})}UpdateBrickUI(){document.getElementById("x_value").innerText=this.brickSize.x.toString();document.getElementById("y_value").innerText=this.brickSize.y.toString();document.getElementById("z_value").innerText=this.brickSize.z.toString()}}var VO=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class HO extends BP{constructor(t,e){super(e),this.blockStore=t,this.masterAddr=""}DrawCitizenList(t,e){var i;return VO(this,void 0,void 0,(function*(){let n='<ul class="list-group-flush">';if(e.length){n+=(yield Promise.all(e.map((e=>this.blockStore.FetchCitizen(this.masterAddr,t,e).then((t=>`\n                <li class="list-group-item">\n                    <div class="container-fluid m-0 p-0>\n                        <div class="row">\n                            <div class="col">${t.nickname}</div>\n                            <div class="col-auto">\n                                <div class="form-check form-switch">\n                                    <input class="form-check-input" type="checkbox" role="switch" ${t.activate?"checked":""}>\n                                    <label class="form-check-label" for="flexSwitchCheckDefault"></label>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </li> `)))))).join()}else n+='\n                <li class="list-group-item"> ...</li>\n            ';n+="</ul>",null===(i=document.getElementById("setup"))||void 0===i||i.insertAdjacentHTML("afterend",n)}))}RequestCityInfo(t){return VO(this,void 0,void 0,(function*(){const e=yield this.blockStore.FetchCitizenList(this.masterAddr,t),i=document.getElementById("explain");i&&(i.innerText=""),this.DrawCitizenList(t,e)}))}Run(t){var e;return VO(this,void 0,void 0,(function*(){yield this.LoadHtml(),this.masterAddr=t;const i=null!==(e=this.getParam("city"))&&void 0!==e?e:"ghost";return this.RequestCityInfo(i),!0}))}Release(){this.ReleaseHtml()}}var jO=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};const WO=new class{constructor(){this.blockStore=new d,this.session=new eD(this.blockStore),this.meta=new OP,this.inven=new vD(this.meta,this.session,this.blockStore),this.brick=new GO(this.meta),this.ipc=new p,this.router=new aD(this.ipc),this.sdai=new wD(this.ipc),this.newHon=new XP(this.sdai,this.session,this.ipc,"views/newhon.html"),this.profile=new rD(this.sdai,this.session,this.ipc,"views/profile.html"),this.urlhtml={signin:"views/signin.html",signup:"views/signup.html",main:"views/main.html",hons:"views/hons.html",hon:"views/hon.html",hondetail:"views/hondetail.html",newhon:"views/newhon.html",uploadhon:"views/uploadhon.html",profile:"views/profile.html",edithome:"views/editmode/edithome.html",play:"views/play.html",newcity:"views/citymode/newcity.html",citymain:"views/citymode/citymain.html",editcity:"views/citymode/editcity.html",setupcity:"views/citymode/citysetup.html"},this.funcMap={signin:new KP(this.session,this.urlhtml.signin),signup:new JP(this.urlhtml.signup),hon:new jP(this.blockStore,this.session,this.urlhtml.hon),hons:new VP(this.blockStore,this.session,this.meta,this.urlhtml.hons),hondetail:new FP(this.blockStore,this.session,this.meta,this.urlhtml.hondetail),newhon:this.newHon,uploadhon:new nD(this.urlhtml.uploadhon),profile:this.profile,main:new hD(this.blockStore,this.meta,this.urlhtml.main),edithome:new pD(this.blockStore,this.session,this.meta,this.inven,this.brick,this.urlhtml.edithome),play:new fD(this.blockStore,this.session,this.meta,this.inven,this.urlhtml.play),newcity:new SD(this.session,this.urlhtml.newcity),citymain:new TD(this.blockStore,this.session,this.meta,this.urlhtml.citymain),editcity:new CD(this.blockStore,this.session,this.meta,this.inven,this.brick,this.urlhtml.editcity),setupcity:new HO(this.blockStore,this.urlhtml.setupcity)},this.beforPage="",this.router.RegisterClient("newhon",this.newHon),this.router.RegisterClient("profile",this.profile),window.ClickLoadPage=(t,e,...i)=>jO(this,void 0,void 0,(function*(){yield this.session.DrawHtmlSessionInfo();const n={url:window.location.href,key:t,fromEvent:e,args:i};this.beforPage=t,this.router.Activate(t),history.pushState(n,"login","./?pageid="+t+i);const s=this.CurrentPage;null!=s&&s.Release(),this.CurrentPage=this.funcMap[t],null!=this.CurrentPage&&(yield this.CurrentPage.Run(window.MasterAddr))})),window.onpopstate=()=>{this.includeContentHTML()}}includeContentHTML(){var t;return jO(this,void 0,void 0,(function*(){yield this.session.DrawHtmlSessionInfo();const e=this.getPageIdParam();this.beforPage=e,this.router.Activate(e);const i=this.CurrentPage;null==i||i.Release(),this.CurrentPage=this.funcMap[e],yield null===(t=this.CurrentPage)||void 0===t?void 0:t.Run(window.MasterAddr)}))}getPageIdParam(){var t;const e=new URLSearchParams(window.location.search).get("pageid"),i=null==e?"main":e;return null!==(t=this.beforPage)&&void 0!==t||(this.beforPage=i),i}parseResponse(t){t=t.filter((t=>"Adam"!==t.User.Nickname&&"Eve"!==t.User.Nickname));const e=Math.floor(Math.random()*t.length);return window.NodeCount=t.length,t[e]}loadNodesHtml(t){return window.MasterNode=t,window.MasterAddr=`http://${t.User.ip.Ip}:${t.User.ip.Port}`,window.MasterWsAddr=`ws://${t.User.ip.Ip}:${t.User.ip.Port}`,window.MasterAddr}includeHTML(t,e){window.addEventListener("load",(()=>fetch(e).then((t=>t.text())).then((e=>{document.querySelector(t).innerHTML=e}))))}errmsg(t,e){return`\n<div class="container my-3">\n    <div class="row division-line">\n        <div class="col">\n            <h4>Notics</h4>\n        </div>\n    </div>\n    <div class="row">\n        <div class="col text-center"> <br>\n            <div class="card">\n                <div class="card-header"> ${t} </div>\n                <div class="card-body"> ${e} </div>\n            </div>\n</div>\n    </div>\n</div>\n        `}Start(){const t=document.getElementById("contents");null!=t&&("http:"!=location.protocol?t.innerHTML=this.errmsg(" https   .",' . <a href="http://hons.ghostwebservice.com"> <strong class="me-auto">hons.ghostwebservice.com</strong> </a><br>\n                          http      .'):addEventListener("load",(()=>fetch("http://lb.ghostnetroot.com:58083/nodes").then((t=>t.json())).then(this.parseResponse).then(this.loadNodesHtml).then((()=>{this.meta.init()})).then((()=>this.includeContentHTML())).catch((e=>{t.innerHTML=this.errmsg(" Network Down","  Node  .")})))))}};WO.includeHTML("header","navbar.html"),WO.includeHTML("footer","foot.html"),WO.Start()})()})();